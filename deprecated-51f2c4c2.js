System.register(["./index-68ccac70.js","./skeleton-99c82a69.js","./find-222dc7da.js","./mesh-renderer-c40c4f87.js","./pipeline-state-manager-8f16c5a7.js","./buffer-barrier-d1733967.js","./director-56fe9b8d.js","./deprecated-0752a51c.js","./deprecated-37e42d8f.js","./node-event-40319828.js","./mesh-97b1b18c.js"],(function(t){"use strict";var e,i,n,r,o,s,a,u,l,f,h,d,c,p,_,m,v,T,g,y,x,b,M,w,A,I,k,B,N,E,S,R,P,j,D,O,C,F,U,J,z,H,G,L,W,V,K,X,Y,q,Z,Q,$,tt,et,it;return{setters:[function(t){e=t.l,i=t.t,n=t.Q,r=t.o,o=t.bz,s=t.bx,a=t.i,u=t.bA,l=t.d,f=t.bD,h=t.bF,d=t.bu,c=t.bE,p=t.b$,_=t.ct,m=t.be,v=t.V,T=t.bg,g=t.aw,y=t.cq},function(t){x=t.S},function(t){b=t.B,M=t.av,w=t.a2,A=t.a3,I=t.N,k=t.aw,B=t.as,N=t.a6,E=t.at,S=t.au},function(t){R=t.a,P=t.M},function(t){j=t.X,D=t.z,O=t.Y,C=t.Z,F=t._,U=t.$},function(t){J=t.ag,z=t.l,H=t.m,G=t.b,L=t.j,W=t.aQ,V=t.a9,K=t.d,X=t.f,Y=t.aq,q=t.aP,Z=t.a3,Q=t.T},function(t){$=t.a3,tt=t.M},function(t){et=t.T},function(){},function(){},function(t){it=t.M}],execute:function(){t({c:xt,d:bt,e:function(t,e){for(var i=t,n="";null!==i&&i!==e;)n=i.name+"/"+n,i=i.parent;return n.slice(0,-1)},f:st,g:yt});var nt=t("B",Symbol("BakeNodeCurves")),rt=t("h",function(){function t(){}return t.getOrExtract=function(i){var n=t.pool.get(i);if(!n||n.samples!==i.sample){n&&e.director.root.dataPoolManager.releaseAnimationClip(i);var r=Math.ceil(i.sample*i.duration)+1,o=i.sample;n=i[nt](0,o,r),t.pool.set(i,n)}return n},t.destroy=function(e){t.pool.delete(e)},t}());rt.pool=new Map;var ot=new i;function st(t,e,n){for(i.identity(n);t!==e;)i.fromRTS(ot,t.rotation,t.position,t.scale),i.multiply(n,ot,n),t=t.parent;return n}var at=new J(z.POINT,z.POINT,z.NONE,H.CLAMP,H.CLAMP,H.CLAMP),ut=function(t,e,i){t[e+0]=i.m00,t[e+1]=i.m01,t[e+2]=i.m02,t[e+3]=i.m12,t[e+4]=i.m04,t[e+5]=i.m05,t[e+6]=i.m06,t[e+7]=i.m13,t[e+8]=i.m08,t[e+9]=i.m09,t[e+10]=i.m10,t[e+11]=i.m14};function lt(t,e){var i=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*i,t)/12)}new n,new n,new r,new n,new r;var ft=new r,ht=new r,dt=new r,ct=new r,pt=new i,_t=new i,mt=new o,vt=Number.MAX_SAFE_INTEGER,Tt=(t("J",function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.getFormatFeatures(G.RGBA32F)&L.SAMPLED_TEXTURE?G.RGBA32F:G.RGBA8}(this._device);this._formatSize=W[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new et(t),this._pool.initialize({format:e,roundUpFn:lt}),this._customPool=new et(t),this._customPool.initialize({format:e,roundUpFn:lt})}var e=t.prototype;return e.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},e.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++){var i=t[e],n=i.textureLength;this._device.getFormatFeatures(G.RGBA32F)&L.SAMPLED_TEXTURE||(n*=2);for(var r=this._customPool.createChunk(n),o=0;o<i.contents.length;o++){var s=i.contents[o],a=s.skeleton;this._chunkIdxMap.set(a,r);for(var u=0;u<s.clips.length;u++){var l=s.clips[u];this._chunkIdxMap.set(a^l,r)}}}},e.getDefaultPoseTexture=function(t,e,n){var s=0^t.hash,a=this._textureBuffers.get(s)||null;if(a&&a.bounds.has(e.hash))return a.refCount++,a;var u=t.joints,l=t.bindposes,f=null,h=!1,d=u.length;if(a)a.refCount++;else{var c=12*d,p=this._chunkIdxMap.get(s),_=void 0!==p?this._customPool.alloc(c*Float32Array.BYTES_PER_ELEMENT,p):this._pool.alloc(c*Float32Array.BYTES_PER_ELEMENT);if(!_)return a;a={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:_},f=new Float32Array(c),h=!0}r.set(dt,vt,vt,vt),r.set(ct,-vt,-vt,-vt);for(var m=e.getBoneSpaceBounds(t),v=0,T=0;v<d;v++,T+=12){var g=n.getChildByPath(u[v]),y=g?st(g,n,pt):t.inverseBindposes[v],x=m[v];x&&(o.transform(mt,x,y),mt.getBoundary(ft,ht),r.min(dt,dt,ft),r.max(ct,ct,ht)),h&&(g&&i.multiply(y,y,l[v]),ut(f,T,g?y:i.IDENTITY))}var b=[new o];return a.bounds.set(e.hash,b),o.fromPoints(b[0],dt,ct),h&&(this._pool.update(a.handle,f.buffer),this._textureBuffers.set(s,a)),a},e.getSequencePoseTexture=function(t,e,n,s){var a=t.hash^e.hash,u=this._textureBuffers.get(a)||null;if(u&&u.bounds.has(n.hash))return u.refCount++,u;var l=t.joints,f=t.bindposes,h=rt.getOrExtract(e).frames,d=null,c=!1,p=l.length;if(u)u.refCount++;else{var _=12*p*h,m=this._chunkIdxMap.get(a),v=void 0!==m?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,m):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!v)return null;var T=this._createAnimInfos(t,e,s);u={pixelOffset:v.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:v,animInfos:T},d=new Float32Array(_),c=!0}var g=n.getBoneSpaceBounds(t),y=[];u.bounds.set(n.hash,y);for(var x=0;x<h;x++)y.push(new o(vt,vt,vt,-vt,-vt,-vt));for(var b=0,M=0;b<h;b++){for(var w=y[b],A=0;A<p;A++,M+=12){var I=u.animInfos[A],k=I.curveData,B=I.downstream,N=I.bindposeIdx,E=I.bindposeCorrection,S=void 0,R=!0;k&&B?S=i.multiply(pt,k[b],B):k?S=k[b]:B?S=B:(S=t.inverseBindposes[N],R=!1);var P=g[A];if(P){var j=E?i.multiply(_t,S,E):S;o.transform(mt,P,j),mt.getBoundary(ft,ht),r.min(w.center,w.center,ft),r.max(w.halfExtents,w.halfExtents,ht)}c&&(R&&i.multiply(pt,S,f[N]),ut(d,M,R?pt:i.IDENTITY))}o.fromPoints(w,w.center,w.halfExtents)}return c&&(this._pool.update(u.handle,d.buffer),this._textureBuffers.set(a,u)),u},e.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},e.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.skeletonHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),i=e.next();!i.done;){var n=i.value;n.clipHash===t.hash&&(n.readyToBeDeleted=!0,n.refCount?this._textureBuffers.delete(n.skeletonHash^n.clipHash):this.releaseHandle(n)),i=e.next()}},e._createAnimInfos=function(t,e,n){for(var r=[],o=t.joints,s=t.bindposes,a=o.length,u=rt.getOrExtract(e),l=0;l<a;l++){for(var f=o[l],h=u.joints[f],d=n.getChildByPath(f),c=void 0,p=void 0;!h;){var _=f.lastIndexOf("/");if(f=f.substring(0,_),h=u.joints[f],d?(c||(c=new i),i.fromRTS(pt,d.rotation,d.position,d.scale),i.multiply(c,pt,c),d=d.parent):p=f,_<0)break}var m=l,v=void 0;if(void 0!==p&&h){m=l-1;for(var T=0;T<a;T++)if(o[T]===p){m=T,v=new i,i.multiply(v,s[T],t.inverseBindposes[l]);break}}r.push({curveData:h&&h.transforms,downstream:c,bindposeIdx:m,bindposeCorrection:v})}return r},s(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),t}()),t("i",function(){function t(t){this._pool=new Map,this._device=void 0,this._device=t}var e=t.prototype;return e.getData=function(t){void 0===t&&(t="-1");var e=this._pool.get(t);if(e)return e;var i=this._device.createBuffer(new V(K.UNIFORM|K.TRANSFER_DST,X.HOST|X.DEVICE,j.SIZE,j.SIZE)),n=new Float32Array([0,0,0,0]);i.update(n);var r={buffer:i,data:n,dirty:!1,dirtyForJSB:new Uint8Array([0]),currentClip:null};return this._pool.set(t,r),r},e.destroy=function(t){var e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))},e.switchClip=function(t,e){return t.currentClip=e,t.data[0]=0,t.buffer.update(t.data),t.dirty=!1,t},e.clear=function(){for(var t,e=a(this._pool.values());!(t=e()).done;)t.value.buffer.destroy();this._pool.clear()},t}()),[]),gt=new Map;function yt(t,e){for(var n=0,r=i.IDENTITY;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){r=t.world,t.stamp=e;break}t.stamp=e,Tt[n++]=t,t=t.parent}for(;n>0;){t=Tt[--n],Tt[n]=null;var o=t.node;i.fromRTS(t.local,o.rotation,o.position,o.scale),r=i.multiply(t.world,r,t.local)}return r}function xt(t,e){for(var n,r=null,o=0;t!==e;){var s=t.uuid;if(gt.has(s)){r=gt.get(s);break}r={node:t,local:new i,world:new i,stamp:-1,parent:null},gt.set(s,r),Tt[o++]=r,t=t.parent,r=null}for(;o>0;)n=Tt[--o],Tt[o]=null,n.parent=r,r=n;return r}function bt(t){for(var e=gt.get(t.uuid)||null;e;)gt.delete(e.node.uuid),e=e.parent}var Mt=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_REAL_TIME_JOINT_TEXTURE",value:!1}],wt=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_REAL_TIME_JOINT_TEXTURE",value:!0}];function At(t,e,i,n){for(var r=0;r<i.length;r++){for(var o=i[r],s=-1,a=0;a<o.length;a++)if(o[a]===n){s=a;break}s>=0&&(e.push(r),t.push(s))}}var It=new r,kt=new r,Bt=new r,Nt=new r,Et=new i,St=new o,Rt=function(){this._format=M.RGBA32F,this._textures=[],this._buffers=[]};Rt.WIDTH=256,Rt.HEIGHT=3;var Pt,jt,Dt,Ot,Ct,Ft,Ut,Jt,zt,Ht,Gt,Lt,Wt,Vt,Kt,Xt,Yt,qt,Zt,Qt,$t,te,ee,ie,ne,re,oe,se,ae,ue,le,fe,he=function(t){function e(){var e;return(e=t.call(this)||this)._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e._realTimeJointTexture=new Rt,e._realTimeTextureMode=!1,e.type=tt.SKINNING,e}u(e,t);var n=e.prototype;return n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}this._dataArray.length=0,this._realTimeJointTexture._textures.forEach((function(t){t.destroy()})),this._realTimeJointTexture._textures.length=0,this._realTimeJointTexture._buffers.length=0,t.prototype.destroy.call(this)},n.uploadAnimation=function(){},n.bindSkeleton=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null);for(var n=0;n<this._joints.length;n++)bt(this._joints[n].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&i){this._realTimeTextureMode=!1,D.JOINT_UNIFORM_CAPACITY<t.joints.length&&(this._realTimeTextureMode=!0),this.transform=e;var r=i.getBoneSpaceBounds(t),o=i.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=i.jointBufferIndices,this._initRealTimeJointTexture();for(var s=0;s<t.joints.length;s++){var a=r[s],u=e.getChildByPath(t.joints[s]);if(a&&u){var l=xt(u,e),f=t.bindposes[s],h=[],d=[];o?At(h,d,o,s):(h.push(s),d.push(0)),this._joints.push({indices:h,buffers:d,bound:a,target:u,bindpose:f,transform:l})}}}},n.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e.isTransformDirty())&&(e.updateWorldTransform(),this._localDataUpdated=!0),r.set(It,1/0,1/0,1/0),r.set(kt,-1/0,-1/0,-1/0);for(var i=0;i<this._joints.length;i++){var n=this._joints[i],s=n.bound,a=yt(n.transform,t);o.transform(St,s,a),St.getBoundary(Bt,Nt),r.min(It,It,Bt),r.max(kt,kt,Nt)}var u=this._worldBounds;this._modelBounds&&u&&(o.fromPoints(this._modelBounds,It,kt),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds))},n.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var n=0;n<this._joints.length;n++){var r=this._joints[n],o=r.indices,s=r.buffers,a=r.transform,u=r.bindpose;i.multiply(Et,a.world,u);for(var l=0;l<s.length;l++)ut(this._dataArray[s[l]],12*o[l],Et)}if(this._realTimeTextureMode)this._updateRealTimeJointTextureBuffer();else for(var f=0;f<this._buffers.length;f++)this._buffers[f].update(this._dataArray[f]);return!0},n.initSubModel=function(e,i,n){var r=i.vertexBuffers,o=i.iaInfo;o.vertexBuffers=i.jointMappedBuffers,t.prototype.initSubModel.call(this,e,i,n),o.vertexBuffers=r},n.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e),n=Mt;return this._realTimeTextureMode&&(n=wt),i?n.concat(i):n},n._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._bufferIndices[e];if(this._realTimeTextureMode)this._bindRealTimeJointTexture(n,i);else{var r=this._buffers[n];r&&i.bindBuffer(D.BINDING,r)}},n._updateInstancedAttributes=function(e,i){i.passes[0].batchingScheme!==b.NONE&&l(3936,this.node.getPathInHierarchy()),t.prototype._updateInstancedAttributes.call(this,e,i)},n._ensureEnoughBuffers=function(t){if(this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}if(this._dataArray.length&&(this._dataArray.length=0),this._realTimeTextureMode)for(var i=0;i<t;i++){var n=Rt.WIDTH;this._dataArray[i]=new Float32Array(12*n)}else for(var r=0;r<t;r++){this._buffers[r]=this._device.createBuffer(new V(K.UNIFORM|K.TRANSFER_DST,X.HOST|X.DEVICE,D.SIZE,D.SIZE));var o=D.JOINT_UNIFORM_CAPACITY;this._dataArray[r]=new Float32Array(12*o)}},n._initRealTimeJointTexture=function(){if(this._realTimeJointTexture._textures.length&&(this._realTimeJointTexture._textures.forEach((function(t){t.destroy()})),this._realTimeJointTexture._textures.length=0),this._realTimeJointTexture._buffers.length=0,this._realTimeTextureMode){var t=$.root.device,e=Rt.WIDTH,i=Rt.HEIGHT;0==(t.getFormatFeatures(G.RGBA32F)&L.SAMPLED_TEXTURE)&&(this._realTimeJointTexture._format=M.RGBA8888,e=4*Rt.WIDTH);for(var n=this._realTimeJointTexture._textures,r=this._realTimeJointTexture._buffers,o=this._realTimeJointTexture._format,s=0;s<this._dataArray.length;s++){r[s]=new Float32Array(4*Rt.HEIGHT*Rt.WIDTH);var a=r[s],u=o===M.RGBA32F?a:new Uint8Array(a.buffer),l=new w({width:e,height:i,_data:u,_compressed:!1,format:o}),f=new A;f.setFilters(A.Filter.NEAREST,A.Filter.NEAREST),f.setMipFilter(A.Filter.NONE),f.setWrapMode(A.WrapMode.CLAMP_TO_EDGE,A.WrapMode.CLAMP_TO_EDGE,A.WrapMode.CLAMP_TO_EDGE),f.image=l,n[s]=f}}},n._bindRealTimeJointTexture=function(t,e){if(this._realTimeTextureMode){var i=this._realTimeJointTexture._textures[t];if(i){var n=i.getGFXTexture(),r=i.getGFXSampler();e.bindTexture(O,n),e.bindSampler(O,r)}}},n._updateRealTimeJointTextureBuffer=function(){if(this._realTimeTextureMode)for(var t=this._realTimeJointTexture._textures,e=this._realTimeJointTexture._buffers,i=0;i<t.length;i++){for(var n=e[i],r=this._dataArray[i],o=r.length/12,s=0,a=0,u=0;u<o;u++)a=4*u,n[a++]=r[s++],n[a++]=r[s++],n[a++]=r[s++],n[a++]=r[s++],a=4*(u+Rt.WIDTH),n[a++]=r[s++],n[a++]=r[s++],n[a++]=r[s++],n[a++]=r[s++],a=4*(u+2*Rt.WIDTH),n[a++]=r[s++],n[a++]=r[s++],n[a++]=r[s++],n[a++]=r[s++];var l=this._realTimeJointTexture._format===M.RGBA32F?n:new Uint8Array(n.buffer);t[i].uploadData(l)}},e}(R),de=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],ce=function(t){function i(){var i;(i=t.call(this)||this).uploadedAnim=void 0,i._jointsMedium=void 0,i._skeleton=null,i._mesh=null,i._dataPoolManager=void 0,i._instAnimInfoIdx=-1,i.type=tt.BAKED_SKINNING,i._dataPoolManager=e.director.root.dataPoolManager;var n=new Float32Array(4),r=i._dataPoolManager.jointAnimationInfo.getData();return i._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:r,texture:null,boundsInfo:null},i}u(i,t);var n=i.prototype;return n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),t.prototype.destroy.call(this)},n.bindSkeleton=function(t,e,i){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),this._skeleton=t,this._mesh=i,t&&e&&i){this.transform=e;var n=this._dataPoolManager;this._jointsMedium.animInfo=n.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new V(K.UNIFORM|K.TRANSFER_DST,X.DEVICE,C.SIZE,C.SIZE)))}},n.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var i=this._jointsMedium,n=i.animInfo,r=i.boundsInfo[n.data[0]],o=this._worldBounds;if(o&&r){var s=this.transform;r.transform(s._mat,s._pos,s._rot,s._scale,o)}}},n.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var i=this._jointsMedium.animInfo,n=!1,r=this._instAnimInfoIdx,o=0;o<this._subModels.length;o++){var s=this._subModels[o];r>=0?s.instancedAttributeBlock.views[r][0]=i.data[0]:n=!0}return n&&i.dirty&&(i.buffer.update(i.data),i.dirty=!1),!0},n.getMacroPatches=function(e){var i=t.prototype.getMacroPatches.call(this,e);return i?i.concat(de):de},n.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,i=null;t?(i=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=i&&i.bounds.get(this._mesh.hash),this._modelBounds=null):(i=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=i&&i.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(i)}},n._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var i=this._jointsMedium,n=i.buffer,r=i.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),n&&n.update(r);for(var o=t.handle.texture,s=0;s<this._subModels.length;++s)this._subModels[s].descriptorSet.bindTexture(F,o)}},n._updateLocalDescriptors=function(e,i){t.prototype._updateLocalDescriptors.call(this,e,i);var n=this._jointsMedium,r=n.buffer,o=n.texture,s=n.animInfo;if(i.bindBuffer(C.BINDING,r),i.bindBuffer(j.BINDING,s.buffer),o){var a=this._device.getSampler(at);i.bindTexture(F,o.handle.texture),i.bindSampler(F,a)}},n._updateInstancedAttributes=function(e,i){t.prototype._updateInstancedAttributes.call(this,e,i),this._instAnimInfoIdx=i.getInstancedAttributeIndex(U),this.updateInstancedJointTextureInfo()},n.updateInstancedJointTextureInfo=function(){for(var t=this._jointsMedium,e=t.jointTextureInfo,i=t.animInfo,n=this._instAnimInfoIdx,r=0;r<this._subModels.length;r++){var o=this._subModels[r].instancedAttributeBlock.views;if(n>=0&&o.length>0){var s=o[n];s[0]=i.data[0],s[1]=e[1],s[2]=e[2]}}},i}(R),pe=t("S",(Pt=f("cc.SkinnedMeshRenderer"),jt=_(100),Dt=h(x),Ot=h(I),Ct=h(x),Ft=h(I),Pt(Ut=jt((Jt=function(t){function i(){var e;return(e=t.call(this)||this)._skeleton=zt&&zt(),e._skinningRoot=Ht&&Ht(),e._clip=null,e.associatedAnimation=null,e._modelType=ce,e}u(i,t);var n=i.prototype;return n.onLoad=function(){t.prototype.onLoad.call(this),this._tryBindAnimation()},n.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),d(null===this.associatedAnimation)),t.prototype.onDestroy.call(this)},n.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},n.setUseBakedAnimation=function(t,i){void 0===t&&(t=!0),void 0===i&&(i=!1);var n=t?ce:he;(i||this._modelType!==n)&&(this._modelType=n,this._model&&(e.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._updateUseLightProbe(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(e,i){t.prototype.setMaterial.call(this,e,i),this._modelType===he&&this.getMaterialInstance(i)},n._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var t=this._skinningRoot;if(t){for(var e=!1,i=this.node;i;i=i.parent)if(i===t){e=!0;break}if(e){var n=t.getComponent("cc.SkeletalAnimation");n?n.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},s(i,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){t!==this._skinningRoot&&(this._skinningRoot=t,this._tryBindAnimation(),this._update())}},{key:"model",get:function(){return this._model}}]),i}(P),zt=c(Jt.prototype,"_skeleton",[Dt],(function(){return null})),Ht=c(Jt.prototype,"_skinningRoot",[Ot],(function(){return null})),p(Jt.prototype,"skeleton",[Ct],Object.getOwnPropertyDescriptor(Jt.prototype,"skeleton"),Jt.prototype),p(Jt.prototype,"skinningRoot",[Ft],Object.getOwnPropertyDescriptor(Jt.prototype,"skinningRoot"),Jt.prototype),Ut=Jt))||Ut)||Ut)),_e=new Y(q.ATTR_BATCH_ID,G.R32F),me=new Y(q.ATTR_BATCH_UV,G.RG32F),ve=W[_e.format].size+W[me.format].size,Te=t("b",(Gt=f("cc.SkinnedMeshUnit"),Lt=h(it),Wt=h(x),Vt=h(N),Kt=h(pe),Gt((Yt=function(){function t(){this.mesh=qt&&qt(),this.skeleton=Zt&&Zt(),this.material=Qt&&Qt(),this._localTransform=$t&&$t(),this._offset=te&&te(),this._size=ee&&ee()}return s(t,[{key:"offset",get:function(){return this._offset},set:function(t){v.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){v.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getSharedMaterial(0),t.skinningRoot&&st(t.node,t.skinningRoot,this._localTransform))}}]),t}(),qt=c(Yt.prototype,"mesh",[Lt],(function(){return null})),Zt=c(Yt.prototype,"skeleton",[Wt],(function(){return null})),Qt=c(Yt.prototype,"material",[Vt],(function(){return null})),$t=c(Yt.prototype,"_localTransform",[T],(function(){return new i})),te=c(Yt.prototype,"_offset",[T],(function(){return new v(0,0)})),ee=c(Yt.prototype,"_size",[T],(function(){return new v(1,1)})),p(Yt.prototype,"copyFrom",[Kt],Object.getOwnPropertyDescriptor(Yt.prototype,"copyFrom"),Yt.prototype),Xt=Yt))||Xt)),ge=new i;new i;var ye=new r,xe=t("a",(ie=f("cc.SkinnedMeshBatchRenderer"),ne=_(100),re=h([g]),oe=h([Te]),ie(se=ne((ae=function(t){function n(){for(var e,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(e=t.call.apply(t,[this].concat(n))||this).atlasSize=ue&&ue(),e.batchableTextureNames=le&&le(),e.units=fe&&fe(),e._textures={},e._batchMaterial=null,e}u(n,t);var o=n.prototype;return o.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},o.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},o._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},o.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},o.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getSharedMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var i=e.effectAsset.techniques[e.technique],n=function(n){var r=i.passes[n];if(!r.properties)return"continue";var o=function(i){if(r.properties[i].type>=Q.SAMPLER1D){var o=null;t.batchableTextureNames.find((function(t){return t===i}))?((o=t._textures[i])||(o=t.createTexture(i)),t.cookTextures(o,i,n)):t.units.some((function(t){return o=t.material&&t.material.getProperty(i,n)})),o&&e.setProperty(i,o,n)}else{for(var s=[],a=0;a<t.units.length;a++){var u=t.units[a];u.material&&s.push(u.material.getProperty(i.slice(0,-3),n))}e.setProperty(i,s,n)}};for(var s in r.properties)o(s)},r=0;r<i.passes.length;r++)n(r)}else console.warn("incomplete batch material!")},o.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],e=[],n=0;n<this.units.length;n++){var r=this.units[n];if(r&&r.skeleton){var o=r.skeleton;i.invert(ge,r._localTransform);for(var s=function(){var n=o.joints[a];if(t.findIndex((function(t){return t===n}))>=0)return"continue";t.push(n),e.push(i.multiply(new i,o.bindposes[a]||i.IDENTITY,ge))},a=0;a<o.joints.length;a++)s()}}var u=Array.from(Array(t.length).keys()).sort((function(e,i){return t[e]>t[i]?1:t[e]<t[i]?-1:0})),l=new x;l.joints=t.map((function(t,e,i){return i[u[e]]})),l.bindposes=e.map((function(t,e,i){return i[u[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=l}else console.warn("no skinning root specified!")},o.cookMeshes=function(){for(var t=this,e=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new it;for(var o=0,s=G.UNKNOWN,a=0,u=G.UNKNOWN,l=0,f=G.UNKNOWN,h=0,d=G.UNKNOWN,c=0,p=G.UNKNOWN,_=new Array(this.units.length),m=this.units.length,v=0;v<m;v++){var T=this.units[v];T&&T.skeleton&&(_[v]=T.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var g=function(){var e=t.units[y];if(!e||!e.mesh||!e.mesh.data)return"continue";var n=t._createUnitMesh(y,e.mesh),m=new DataView(n.data.buffer);i.invert(ge,e._localTransform),i.transpose(ge,ge);for(var v=e.offset,T=e.size,g=function(){var t=n.struct.vertexBundles[x];o=t.view.offset,s=G.UNKNOWN;for(var i=0;i<t.attributes.length;i++){var g=t.attributes[i];if(g.name===q.ATTR_POSITION){s=g.format;break}o+=W[g.format].size}if(s){for(var b=B(m,s,o,t.view.length,t.view.stride),M=0;M<b.length;M+=3)r.fromArray(ye,b,M),r.transformMat4(ye,ye,e._localTransform),r.toArray(b,ye,M);E(m,b,s,o,t.view.stride)}a=t.view.offset,u=G.UNKNOWN;for(var w=0;w<t.attributes.length;w++){var A=t.attributes[w];if(A.name===q.ATTR_NORMAL){u=A.format;break}a+=W[A.format].size}if(u){for(var I=B(m,u,a,t.view.length,t.view.stride),k=0;k<I.length;k+=3)r.fromArray(ye,I,k),r.transformMat4Normal(ye,ye,ge),r.toArray(I,ye,k);E(m,I,u,a,t.view.stride)}l=t.view.offset,f=G.UNKNOWN;for(var N=0;N<t.attributes.length;N++){var R=t.attributes[N];if(R.name===q.ATTR_TANGENT){f=R.format;break}l+=W[R.format].size}if(f){for(var P=B(m,f,l,t.view.length,t.view.stride),j=0;j<P.length;j+=3)r.fromArray(ye,P,j),r.transformMat4Normal(ye,ye,ge),r.toArray(P,ye,j);E(m,P,f,l,t.view.stride)}h=t.view.offset,d=G.UNKNOWN;for(var D=0;D<t.attributes.length;D++){var O=t.attributes[D];if(O.name===q.ATTR_BATCH_UV){d=O.format;break}h+=W[O.format].size}d&&S(m,(function(t,e){var i,n=0===e?"x":"y";return(t=(i=t)-Math.floor(i))*T[n]+v[n]}),d,h,t.view.length,t.view.stride,m);var C=_[y];if(!C)return"continue";c=t.view.offset,p=G.UNKNOWN;for(var F=0;F<t.attributes.length;F++){var U=t.attributes[F];if(U.name===q.ATTR_JOINTS){p=U.format;break}c+=W[U.format].size}p&&S(m,(function(t){return C[t]}),p,c,t.view.length,t.view.stride,m)},x=0;x<n.struct.vertexBundles.length;x++)g();t._mesh.merge(n)},y=0;y<m;y++)g();this._onMeshChanged(this._mesh),this._updateModels()}},o.cookTextures=function(t,i,n){for(var r=[],o=[],s=[],a=[],u=0;u<this.units.length;u++){var l=this.units[u];if(l.material){var f=l.material.getProperty(i,n);if(f&&f.image&&f.image.data){var h=new Z;h.texOffset.x=l.offset.x*this.atlasSize,h.texOffset.y=l.offset.y*this.atlasSize,h.texExtent.width=l.size.x*this.atlasSize,h.texExtent.height=l.size.y*this.atlasSize;var d=f.image.data;ArrayBuffer.isView(d)?(s.push(d),a.push(h)):(r.push(d),o.push(h))}}}var c=t.getGFXTexture(),p=e.director.root.device;s.length>0&&p.copyBuffersToTexture(s,c,a),r.length>0&&p.copyTexImagesToTexture(r,c,o)},o.createTexture=function(t){var e=new A;return e.setFilters(k.LINEAR,k.LINEAR),e.setMipFilter(k.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:M.RGBA8888}),this._textures[t]=e,e},o.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:M.RGBA8888})},o._createUnitMesh=function(t,i){for(var n=JSON.parse(JSON.stringify(i.struct)),r={},o=0;o<i.struct.primitives.length;o++){for(var s=i.struct.primitives[o],a=0,u=G.UNKNOWN,l=0;l<s.vertexBundelIndices.length;l++){var f=i.struct.vertexBundles[s.vertexBundelIndices[l]];a=f.view.offset,u=G.UNKNOWN;for(var h=0;h<f.attributes.length;h++){var d=f.attributes[h];if(d.name===q.ATTR_TEX_COORD){u=d.format;break}a+=W[d.format].size}if(u)break}if(void 0===r[l]){r[l]=[u,a];var c=n.vertexBundles[l];c.attributes.push(_e),c.attributes.push(me),c.view.offset=0,c.view.length+=c.view.count*ve,c.view.stride+=ve}}for(var p=0,_=0;_<n.vertexBundles.length;_++)p+=n.vertexBundles[_].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=p,p+=v.indexView.length)}var T=new Uint8Array(p),g=i.data,y=new DataView(T.buffer),x=new DataView(g.buffer),b=e.sys.isLittleEndian;for(var M in r)for(var w=n.vertexBundles[M],A=i.struct.vertexBundles[M],I=r[M],k=I[0],N=I[1],E=B(x,k,N,A.view.length,A.view.stride),S=A.view,R=w.view,P=S.stride,j=R.stride,D=S.offset,O=R.offset,C=0;C<R.count;C++){var F=g.subarray(D,D+P);T.set(F,O),y.setFloat32(O+P,t),y.setFloat32(O+P+4,E[2*C],b),y.setFloat32(O+P+8,E[2*C+1],b),O+=j,D+=P}for(var U=0;U<n.primitives.length;U++){var J=i.struct.primitives[U],z=n.primitives[U];if(J.indexView&&z.indexView)for(var H=J.indexView.stride,L=z.indexView.stride,V=J.indexView.offset,K=z.indexView.offset,X=0;X<z.indexView.count;X++){var Y=g.subarray(V,V+H);T.set(Y,K),K+=L,V+=H}}var Z=new it;return Z.reset({struct:n,data:T}),Z},s(n,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),n}(pe),ue=c(ae.prototype,"atlasSize",[T],(function(){return 1024})),le=c(ae.prototype,"batchableTextureNames",[re,T],(function(){return[]})),fe=c(ae.prototype,"units",[oe,T],(function(){return[]})),p(ae.prototype,"mesh",[m],Object.getOwnPropertyDescriptor(ae.prototype,"mesh"),ae.prototype),p(ae.prototype,"skeleton",[m],Object.getOwnPropertyDescriptor(ae.prototype,"skeleton"),ae.prototype),se=ae))||se)||se));e.SkinningModelComponent=pe,y(pe,"cc.SkinningModelComponent"),e.SkinningModelUnit=Te,y(Te,"cc.SkinningModelUnit"),e.BatchedSkinningModelComponent=xe,y(xe,"cc.BatchedSkinningModelComponent")}}}));
