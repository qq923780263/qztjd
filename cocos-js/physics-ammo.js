System.register(["./deprecated-37e42d8f.js","./director-56fe9b8d.js","./index-b814fbd9.js","./index-68ccac70.js","./pipeline-state-manager-8f16c5a7.js","./buffer-barrier-d1733967.js","./instantiated-e4510e58.js","./physics-framework.js","./find-222dc7da.js","./collision-matrix-571eda5a.js","./array-collision-matrix-9005c23d.js","./tuple-dictionary-fbc126e2.js","./util-06cac5ac.js","./node-event-40319828.js","./touch-685512cb.js","./mesh-97b1b18c.js","./skeleton-99c82a69.js","./terrain-asset-b17fae4a.js","./wasm-minigame-cb39f0e3.js","./base.js","./deprecated-0752a51c.js","./builtin-pipelines-98225268.js","./deprecated-2e80a469.js","./camera-component-9188fe5a.js","./model-renderer-8b84c274.js","./renderer-7bc9d919.js","./instantiate-42c48975.js","./move-8e10dd33.js","./capsule-212e055a.js"],(function(){"use strict";var t,i,e,s,n,o,r,a,l,h,c,d,p,_,u,f,y,g,m,S,C,T,B,v,w,b,E,M,A,O,D,R;return{setters:[function(e){t=e.g,i=e.G},function(){},function(t){e=t.P,s=t.q,n=t.s},function(t){o=t.bx,r=t.o,a=t.Q,l=t.t,h=t.bO,c=t.e,d=t.bA,p=t.a4,_=t.a5,u=t.d,f=t.w,y=t.N,g=t.cN},function(){},function(t){m=t.v},function(t){S=t.b,C=t.E,T=t.a},function(){},function(t){B=t.T},function(t){v=t.P,w=t.a,b=t.b,E=t.f,M=t.g},function(t){A=t.A},function(t){O=t.T},function(t){D=t.V,R=t.a},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){}],execute:function(){var I={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},F={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},x=function(){function t(){this.BT_TRANSFORM_0=S.Transform_new(),this.BT_TRANSFORM_1=S.Transform_new(),this.BT_V3_0=S.Vec3_new(0,0,0),this.BT_V3_1=S.Vec3_new(0,0,0),this.BT_V3_2=S.Vec3_new(0,0,0),this.BT_QUAT_0=S.Quat_new(0,0,0,1)}return t.setWrapper=function(t,i,e){this.ROOT[i]||(this.ROOT[i]={}),this.ROOT[i][t]=e},t.delWrapper=function(t,i){delete this.ROOT[i][t]},t.getWrapper=function(t,i){return this.ROOT[i][t]},t.isNotEmptyShape=function(t){return t!==S.EmptyShape_static()},o(t,null,[{key:"instance",get:function(){return null==t._instance&&(t._instance=new t),t._instance}}]),t}();x._instance=void 0,x.ROOT={};var G=new r,P=new r;new r;var L,k,V,N,W,H=new a,j=new a,U=new l;function z(t,i){return S.Vec3_set(t,i.x,i.y,i.z),t}function Y(t,i){return t.x=S.Vec3_x(i),t.y=S.Vec3_y(i),t.z=S.Vec3_z(i),t}function J(t,i){return S.Quat_set(t,i.x,i.y,i.z,i.w),t}function Q(t,i){return t.x=S.Quat_x(i),t.y=S.Quat_y(i),t.z=S.Quat_z(i),t.w=S.Quat_w(i),t}function Z(t,i){for(var e=i.renderingSubMeshes.length,s=0;s<e;s++){var n=i.renderingSubMeshes[s],o=n.geometricInfo;if(o){var r=n.primitiveMode,a=o.positions,l=o.indices,h=x.instance.BT_V3_0,c=x.instance.BT_V3_1,d=x.instance.BT_V3_2;if(r===m.TRIANGLE_LIST)for(var p=l.length,_=0;_<p;_+=3){var u=3*l[_],f=3*l[_+1],y=3*l[_+2];S.Vec3_set(h,a[u],a[u+1],a[u+2]),S.Vec3_set(c,a[f],a[f+1],a[f+2]),S.Vec3_set(d,a[y],a[y+1],a[y+2]),S.TriangleMesh_addTriangle(t,h,c,d)}else if(r===m.TRIANGLE_STRIP)for(var g=l.length-2,C=0,T=0;T<g;T+=1){var B=3*l[T-C],v=3*l[T+C+1],w=3*l[T+2];C=~C,S.Vec3_set(h,a[B],a[B+1],a[B+2]),S.Vec3_set(c,a[v],a[v+1],a[v+2]),S.Vec3_set(d,a[w],a[w+1],a[w+2]),S.TriangleMesh_addTriangle(t,h,c,d)}else if(r===m.TRIANGLE_FAN){var b=l.length-1,E=3*l[0];S.Vec3_set(h,a[E],a[E+1],a[E+2]);for(var M=1;M<b;M+=1){var A=3*l[M],O=3*l[M+1];S.Vec3_set(c,a[A],a[A+1],a[A+2]),S.Vec3_set(d,a[O],a[O+1],a[O+2]),S.TriangleMesh_addTriangle(t,h,c,d)}}}}return t}function K(t,i){return t*i}new l,S.CACHE=x,function(t){t[t.BODY_RE_ADD=1]="BODY_RE_ADD",t[t.GHOST_RE_ADD=2]="GHOST_RE_ADD"}(L||(L={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}(k||(k={})),function(t){t[t.CO_COLLISION_OBJECT=1]="CO_COLLISION_OBJECT",t[t.CO_RIGID_BODY=2]="CO_RIGID_BODY",t[t.CO_GHOST_OBJECT=4]="CO_GHOST_OBJECT",t[t.CO_SOFT_BODY=8]="CO_SOFT_BODY",t[t.CO_HF_FLUID=16]="CO_HF_FLUID",t[t.CO_USER_TYPE=32]="CO_USER_TYPE",t[t.CO_FEATHERSTONE_LINK=64]="CO_FEATHERSTONE_LINK"}(V||(V={})),function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(N||(N={})),function(t){t[t.BT_DISABLE_WORLD_GRAVITY=1]="BT_DISABLE_WORLD_GRAVITY",t[t.BT_ENABLE_GYROPSCOPIC_FORCE=2]="BT_ENABLE_GYROPSCOPIC_FORCE"}(W||(W={}));var q=G,X=P,$=function(){var t=i.prototype;function i(){this.id=void 0,this._isEnabled=!1,this._isUsingCCD=!1,this._sharedBody=void 0,this._rigidBody=void 0,this.id=i.idCounter++}return t.setMass=function(t){this._rigidBody.isDynamic&&(S.RigidBody_setMass(this.impl,t),this._wakeUpIfSleep(),this._sharedBody.dirty|=L.BODY_RE_ADD)},t.setType=function(t){this._sharedBody.setType(t)},t.setLinearDamping=function(){S.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.setAngularDamping=function(){S.RigidBody_setDamping(this.impl,this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.useGravity=function(t){if(this._rigidBody.isDynamic){var i=S.RigidBody_getFlags(this.impl);t?i&=~W.BT_DISABLE_WORLD_GRAVITY:(S.RigidBody_setGravity(this.impl,z(x.instance.BT_V3_0,r.ZERO)),i|=W.BT_DISABLE_WORLD_GRAVITY),S.RigidBody_setFlags(this.impl,i),this._wakeUpIfSleep(),this._sharedBody.dirty|=L.BODY_RE_ADD}},t.useCCD=function(t){S.CollisionObject_setCcdMotionThreshold(this.impl,t?.01:0),S.CollisionObject_setCcdSweptSphereRadius(this.impl,t?.1:0),this._isUsingCCD=t},t.isUsingCCD=function(){return this._isUsingCCD},t.setLinearFactor=function(t){S.RigidBody_setLinearFactor(this.impl,z(x.instance.BT_V3_0,t)),this._wakeUpIfSleep()},t.setAngularFactor=function(t){S.RigidBody_setAngularFactor(this.impl,z(x.instance.BT_V3_0,t)),this._wakeUpIfSleep()},t.setAllowSleep=function(t){this._rigidBody.isDynamic&&(t?S.CollisionObject_forceActivationState(this.impl,N.ACTIVE_TAG):S.CollisionObject_forceActivationState(this.impl,N.DISABLE_DEACTIVATION),this._wakeUpIfSleep())},t.clearState=function(){S.RigidBody_clearState(this.impl)},t.clearVelocity=function(){this.setLinearVelocity(r.ZERO),this.setAngularVelocity(r.ZERO)},t.clearForces=function(){S.RigidBody_clearForces(this.impl)},t.initialize=function(t){this._rigidBody=t,this._sharedBody=e.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0},t.onEnable=function(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.wakeUp=function(t){void 0===t&&(t=!0),S.CollisionObject_activate(this.impl,t)},t.sleep=function(){var t=S.CollisionObject_getActivationState(this.impl);t!==N.DISABLE_DEACTIVATION&&t!==N.DISABLE_SIMULATION&&S.CollisionObject_forceActivationState(this.impl,N.ISLAND_SLEEPING)},t.setSleepThreshold=function(t){this._wakeUpIfSleep(),S.RigidBody_setSleepingThresholds(this.impl,t,t)},t.getSleepThreshold=function(){return S.RigidBody_getLinearSleepingThreshold(this.impl)},t.getLinearVelocity=function(t){return Y(t,S.RigidBody_getLinearVelocity(this.impl))},t.setLinearVelocity=function(t){this._wakeUpIfSleep(),z(S.RigidBody_getLinearVelocity(this.impl),t)},t.getAngularVelocity=function(t){return Y(t,S.RigidBody_getAngularVelocity(this.impl))},t.setAngularVelocity=function(t){this._wakeUpIfSleep(),z(S.RigidBody_getAngularVelocity(this.impl),t)},t.applyLocalForce=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var e=this._sharedBody.node.worldRotation,s=r.transformQuat(q,t,e),n=i?r.transformQuat(X,i,e):r.ZERO;S.RigidBody_applyForce(this.impl,z(x.instance.BT_V3_0,s),z(x.instance.BT_V3_1,n))},t.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),r.transformQuat(q,t,this._sharedBody.node.worldRotation),S.RigidBody_applyTorque(this.impl,z(x.instance.BT_V3_0,q))},t.applyLocalImpulse=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var e=this._sharedBody.node.worldRotation,s=r.transformQuat(q,t,e),n=i?r.transformQuat(X,i,e):r.ZERO;S.RigidBody_applyImpulse(this.impl,z(x.instance.BT_V3_0,s),z(x.instance.BT_V3_1,n))},t.applyForce=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var e=i||r.ZERO;S.RigidBody_applyForce(this.impl,z(x.instance.BT_V3_0,t),z(x.instance.BT_V3_1,e))},t.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),S.RigidBody_applyTorque(this.impl,z(x.instance.BT_V3_0,t))},t.applyImpulse=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var e=i||r.ZERO;S.RigidBody_applyImpulse(this.impl,z(x.instance.BT_V3_0,t),z(x.instance.BT_V3_1,e))},t.getGroup=function(){return this._sharedBody.collisionFilterGroup},t.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},t.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},t.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},t.getMask=function(){return this._sharedBody.collisionFilterMask},t.setMask=function(t){this._sharedBody.collisionFilterMask=t},t.addMask=function(t){this._sharedBody.collisionFilterMask|=t},t.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},t._wakeUpIfSleep=function(){this.isAwake||S.CollisionObject_activate(this.impl,!0)},o(i,[{key:"isAwake",get:function(){var t=S.CollisionObject_getActivationState(this.impl);return t===N.ACTIVE_TAG||t===N.DISABLE_DEACTIVATION}},{key:"isSleepy",get:function(){return S.CollisionObject_getActivationState(this.impl)===N.WANTS_DEACTIVATION}},{key:"isSleeping",get:function(){return S.CollisionObject_getActivationState(this.impl)===N.ISLAND_SLEEPING}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),i}();$.idCounter=0;var tt=G,it=H,et=0,st=function(){function t(i,s){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.wrappedJoints0=[],this.wrappedJoints1=[],this.dirty=0,this._collisionFilterGroup=e.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._bodyStruct=void 0,this._ghostStruct=void 0,this._wrappedBody=null,this.id=t.idCounter++,this.wrappedWorld=s,this.node=i}t.getSharedBody=function(i,s,n){var o,r=i.uuid;if(t.sharedBodesMap.has(r))o=t.sharedBodesMap.get(r);else{o=new t(i,s);var a=v.DEFAULT,l=e.instance.collisionMatrix[a];o._collisionFilterGroup=a,o._collisionFilterMask=l,t.sharedBodesMap.set(i.uuid,o)}if(n){o._wrappedBody=n;var h=n.rigidBody.group,c=e.instance.collisionMatrix[h];o._collisionFilterGroup=h,o._collisionFilterMask=c}return o};var i=t.prototype;return i._instantiateBodyStruct=function(){if(!this._bodyStruct){var t=0;this._wrappedBody&&this._wrappedBody.rigidBody.enabled&&this._wrappedBody.rigidBody.isDynamic&&(t=this._wrappedBody.rigidBody.mass);var i=x.instance.BT_TRANSFORM_0,s=x.instance.BT_QUAT_0;z(S.Transform_getOrigin(i),this.node.worldPosition),J(s,this.node.worldRotation),S.Transform_setRotation(i,s);var n=S.ccMotionState_new(this.id,i),o=S.RigidBody_new(t,n),r=e.instance.sleepThreshold;S.RigidBody_setSleepingThresholds(o,r,r),this._bodyStruct={id:et++,body:o,motionState:n,compound:S.ccCompoundShape_new(),wrappedShapes:[],useCompound:!1},x.setWrapper(this.id,S.BODY_CACHE_NAME,this),this._ghostStruct&&S.CollisionObject_setIgnoreCollisionCheck(this.ghost,this.body,!0),this._wrappedBody&&this.setBodyType(this._wrappedBody.rigidBody.type)}},i._instantiateGhostStruct=function(){if(!this._ghostStruct){var t=S.CollisionObject_new(),i=S.ccCompoundShape_new();S.CollisionObject_setCollisionShape(t,i),S.CollisionObject_setCollisionFlags(t,k.CF_STATIC_OBJECT|k.CF_NO_CONTACT_RESPONSE),this._ghostStruct={id:et++,ghost:t,compound:i,wrappedShapes:[]},this._bodyStruct&&S.CollisionObject_setIgnoreCollisionCheck(this.body,this.ghost,!0),this._wrappedBody&&this.setGhostType(this._wrappedBody.rigidBody.type)}},i.setType=function(t){this.setBodyType(t),this.setGhostType(t)},i.setBodyType=function(t){if(this._bodyStruct&&this._wrappedBody){var i=this._bodyStruct.body,e=this._wrappedBody,s=e.rigidBody,n=S.CollisionObject_getCollisionFlags(i),o=x.instance.BT_V3_0;switch(t){case w.DYNAMIC:n&=~k.CF_KINEMATIC_OBJECT,n&=~k.CF_STATIC_OBJECT,S.CollisionObject_setCollisionFlags(i,n),e.setMass(s.mass),e.useGravity(s.useGravity),e.setAllowSleep(s.allowSleep);break;case w.KINEMATIC:S.Vec3_set(o,0,0,0),S.RigidBody_setMassProps(i,0,o),n|=k.CF_KINEMATIC_OBJECT,n&=~k.CF_STATIC_OBJECT,S.CollisionObject_setCollisionFlags(i,n),S.CollisionObject_forceActivationState(i,N.DISABLE_DEACTIVATION);break;case w.STATIC:default:S.Vec3_set(o,0,0,0),S.RigidBody_setMassProps(i,0,o),n|=k.CF_STATIC_OBJECT,n&=~k.CF_KINEMATIC_OBJECT,S.CollisionObject_setCollisionFlags(i,n),S.CollisionObject_forceActivationState(i,N.ISLAND_SLEEPING)}this.dirty|=L.BODY_RE_ADD}},i.setGhostType=function(t){if(this._ghostStruct){var i=this._ghostStruct.ghost,e=S.CollisionObject_getCollisionFlags(i);switch(t){case w.DYNAMIC:case w.KINEMATIC:e&=~k.CF_STATIC_OBJECT,e|=k.CF_KINEMATIC_OBJECT,S.CollisionObject_setCollisionFlags(i,e),S.CollisionObject_forceActivationState(i,N.DISABLE_DEACTIVATION);break;case w.STATIC:default:e&=~k.CF_KINEMATIC_OBJECT,e|=k.CF_STATIC_OBJECT,S.CollisionObject_setCollisionFlags(i,e),S.CollisionObject_forceActivationState(i,N.ISLAND_SLEEPING)}this.dirty|=L.GHOST_RE_ADD}},i.addShape=function(t,i){function e(t,i){S.CollisionObject_setCollisionShape(t.body,i),t.dirty|=L.BODY_RE_ADD,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(i)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{var s=this.bodyStruct.wrappedShapes.length;if(1!==s||t.needCompound()){this.bodyStruct.useCompound=!0;for(var n=0;n<s;n++)this.bodyStruct.wrappedShapes[n].setCompound(this.bodyCompoundShape);e(this,this.bodyStruct.compound)}else e(this,t.impl)}this.bodyEnabled=!0}},i.removeShape=function(t,i){if(i){var e=this.ghostStruct.wrappedShapes.indexOf(t);e>=0&&(h(this.ghostStruct.wrappedShapes,e),t.setCompound(0),this.ghostEnabled=!1)}else{var s=this.bodyStruct.wrappedShapes.indexOf(t);s>=0&&(this.bodyStruct.useCompound?t.setCompound(0):S.CollisionObject_setCollisionShape(this.body,S.EmptyShape_static()),S.CollisionObject_activate(this.body,!0),this.dirty|=L.BODY_RE_ADD,h(this.bodyStruct.wrappedShapes,s),this.bodyEnabled=!1)}},i.addJoint=function(t,i){i?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)},i.removeJoint=function(t,i){if(i){var e=this.wrappedJoints1.indexOf(t);e>=0&&h(this.wrappedJoints1,e)}else{var s=this.wrappedJoints0.indexOf(t);s>=0&&h(this.wrappedJoints0,s)}},i.updateDirty=function(){this.dirty&&(this.bodyIndex>=0&&this.dirty&L.BODY_RE_ADD&&this.updateBodyByReAdd(),this.ghostIndex>=0&&this.dirty&L.GHOST_RE_ADD&&this.updateGhostByReAdd(),this.dirty=0)},i.syncSceneToPhysics=function(){if(this.node.hasChangedFlags){var t=x.instance.BT_QUAT_0,i=S.CollisionObject_getWorldTransform(this.body);if(J(t,this.node.worldRotation),z(S.Transform_getOrigin(i),this.node.worldPosition),S.Transform_setRotation(i,t),this.node.hasChangedFlags&B.SCALE&&this.syncBodyScale(),S.CollisionObject_isKinematicObject(this.body)){var e=S.RigidBody_getMotionState(this.body);e&&S.MotionState_setWorldTransform(e,i)}else this.isBodySleeping()&&S.CollisionObject_activate(this.body)}},i.syncPhysicsToScene=function(){S.CollisionObject_isStaticOrKinematicObject(this.body)||this.syncPhysicsToGraphics()},i.syncPhysicsToGraphics=function(){if(!this.isBodySleeping()){var t=x.instance.BT_QUAT_0,i=x.instance.BT_TRANSFORM_0;if(S.MotionState_getWorldTransform(S.RigidBody_getMotionState(this.body),i),S.Transform_getRotation(i,t),this.node.worldRotation=Q(it,t),this.node.worldPosition=Y(tt,S.Transform_getOrigin(i)),this._ghostStruct){var e=S.CollisionObject_getWorldTransform(this.ghost);z(S.Transform_getOrigin(e),this.node.worldPosition),J(t,this.node.worldRotation),S.Transform_setRotation(e,t)}}},i.syncSceneToGhost=function(){if(this.node.hasChangedFlags){var t=x.instance.BT_QUAT_0,i=S.CollisionObject_getWorldTransform(this.ghost);z(S.Transform_getOrigin(i),this.node.worldPosition),J(t,this.node.worldRotation),S.Transform_setRotation(i,t),this.node.hasChangedFlags&B.SCALE&&this.syncGhostScale(),S.CollisionObject_activate(this.ghost)}},i.syncInitialBody=function(){var t=x.instance.BT_QUAT_0,i=S.CollisionObject_getWorldTransform(this.body);z(S.Transform_getOrigin(i),this.node.worldPosition),J(t,this.node.worldRotation),S.Transform_setRotation(i,t),this.syncBodyScale(),S.CollisionObject_activate(this.body)},i.syncInitialGhost=function(){var t=x.instance.BT_QUAT_0,i=S.CollisionObject_getWorldTransform(this.ghost);z(S.Transform_getOrigin(i),this.node.worldPosition),J(t,this.node.worldRotation),S.Transform_setRotation(i,t),this.syncGhostScale(),S.CollisionObject_activate(this.body)},i.syncBodyScale=function(){for(var t=0;t<this.bodyStruct.wrappedShapes.length;t++)this.bodyStruct.wrappedShapes[t].updateScale();for(var i=0;i<this.wrappedJoints0.length;i++)this.wrappedJoints0[i].updateScale0();for(var e=0;e<this.wrappedJoints1.length;e++)this.wrappedJoints1[e].updateScale1()},i.syncGhostScale=function(){for(var t=0;t<this.ghostStruct.wrappedShapes.length;t++)this.ghostStruct.wrappedShapes[t].updateScale()},i.updateBodyByReAdd=function(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))},i.updateGhostByReAdd=function(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))},i.destroy=function(){if(t.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){var i=this._bodyStruct;x.delWrapper(i.body,S.BODY_CACHE_NAME),S._safe_delete(i.motionState,C.EBulletTypeMotionState),S._safe_delete(i.compound,C.EBulletTypeCollisionShape),S._safe_delete(i.body,C.EBulletTypeCollisionObject),this._bodyStruct=null}if(this._ghostStruct){var e=this._ghostStruct;S._safe_delete(e.compound,C.EBulletTypeCollisionShape),S._safe_delete(e.ghost,C.EBulletTypeCollisionObject),this._ghostStruct=null}},i.isBodySleeping=function(){return S.CollisionObject_getActivationState(this.body)===N.ISLAND_SLEEPING},o(t,[{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"bodyCompoundShape",get:function(){return this.bodyStruct.compound}},{key:"ghostCompoundShape",get:function(){return this.ghostStruct.compound}},{key:"body",get:function(){return this.bodyStruct.body}},{key:"ghost",get:function(){return this.ghostStruct.ghost}},{key:"collisionFilterGroup",get:function(){return this._collisionFilterGroup},set:function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=L.BODY_RE_ADD,this.dirty|=L.GHOST_RE_ADD)}},{key:"collisionFilterMask",get:function(){return this._collisionFilterMask},set:function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=L.BODY_RE_ADD,this.dirty|=L.GHOST_RE_ADD)}},{key:"bodyStruct",get:function(){return this._instantiateBodyStruct(),this._bodyStruct}},{key:"ghostStruct",get:function(){return this._instantiateGhostStruct(),this._ghostStruct}},{key:"bodyEnabled",set:function(t){if(t){if(this.bodyIndex<0){if(0===this.bodyStruct.wrappedShapes.length){if(!this.wrappedBody)return;if(!this.wrappedBody.rigidBody.isDynamic)return}this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitialBody()}}else this.bodyIndex>=0&&(0===this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)&&(S.RigidBody_clearState(this.body),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"ghostEnabled",set:function(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0===this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();st.idCounter=0,st.sharedBodesMap=new Map;var nt=G,ot={},rt=function(){function t(){this.id=t.idCounter++,this._isEnabled=!1,this._isTrigger=!1,this._isInitialized=!1,this._impl=0,this._compound=0,this.quat=S.Quat_new(0,0,0,1),this.transform=S.Transform_new(),this._collider=void 0,this._sharedBody=void 0}var i=t.prototype;return i.updateEventListener=function(){this._sharedBody.wrappedWorld.updateNeedEmitEvents(this.collider.needCollisionEvent||this.collider.needTriggerEvent)},i.setMaterial=function(t){var i=null==t?e.instance.defaultMaterial:t;if(!this._isTrigger&&this._isEnabled)if(this._compound){ot[i._uuid]||(ot[i._uuid]=S.ccMaterial_new());var s=ot[i._uuid];S.ccMaterial_set(s,i.restitution,i.friction,i.rollingFriction,i.spinningFriction),S.CollisionShape_setMaterial(this._impl,s)}else S.CollisionObject_setMaterial(this._sharedBody.body,i.restitution,i.friction,i.rollingFriction,i.spinningFriction)},i.setCenter=function(t){r.copy(nt,t),nt.multiply(this._collider.node.worldScale),z(S.Transform_getOrigin(this.transform),nt),this.updateCompoundTransform()},i.setAsTrigger=function(t){this._isTrigger!==t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)},i.getAABB=function(t){var i=x.instance.BT_TRANSFORM_0;S.Transform_setIdentity(i),S.Transform_setRotation(i,J(x.instance.BT_QUAT_0,this._collider.node.worldRotation));var e=x.instance.BT_V3_0,s=x.instance.BT_V3_1;S.CollisionShape_getAabb(this._impl,i,e,s),t.halfExtents.x=(S.Vec3_x(s)-S.Vec3_x(e))/2,t.halfExtents.y=(S.Vec3_y(s)-S.Vec3_y(e))/2,t.halfExtents.z=(S.Vec3_z(s)-S.Vec3_z(e))/2,r.add(t.center,this._collider.node.worldPosition,this._collider.center)},i.getBoundingSphere=function(t){t.radius=S.CollisionShape_getLocalBoundingSphere(this._impl),r.add(t.center,this._collider.node.worldPosition,this._collider.center)},i.initialize=function(t){this._collider=t,this._isInitialized=!0,this._sharedBody=e.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),this.setWrapper()},i.setWrapper=function(){x.isNotEmptyShape(this._impl)&&(S.CollisionShape_setUserPointer(this._impl,this._impl),x.setWrapper(this._impl,t.TYPE,this))},i.onLoad=function(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},i.onEnable=function(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)},i.onDisable=function(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)},i.onDestroy=function(){this._sharedBody.reference=!1,this._collider=null,S._safe_delete(this.quat,C.EBulletTypeQuat),S._safe_delete(this.transform,C.EBulletTypeTransform),this._compound&&S._safe_delete(this._compound,C.EBulletTypeCollisionShape),x.isNotEmptyShape(this._impl)&&(S._safe_delete(this._impl,C.EBulletTypeCollisionShape),x.delWrapper(this._impl,t.TYPE))},i.updateByReAdd=function(){this._isEnabled&&(this._sharedBody.removeShape(this,this._isTrigger),this._sharedBody.addShape(this,this._isTrigger))},i.getGroup=function(){return this._sharedBody.collisionFilterGroup},i.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},i.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},i.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},i.getMask=function(){return this._sharedBody.collisionFilterMask},i.setMask=function(t){this._sharedBody.collisionFilterMask=t},i.addMask=function(t){this._sharedBody.collisionFilterMask|=t},i.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},i.setCompound=function(t){this._compound&&S.CompoundShape_removeChildShape(this._compound,this._impl),t&&S.CompoundShape_addChildShape(t,this.transform,this._impl),this._compound=t},i.updateScale=function(){this.setCenter(this._collider.center)},i.updateCompoundTransform=function(){this._compound?S.CompoundShape_updateChildTransform(this._compound,this._impl,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=L.BODY_RE_ADD)},i.needCompound=function(){return this._collider.type===b.TERRAIN||!this._collider.center.equals(r.ZERO)},o(t,[{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}},{key:"sharedBody",get:function(){return this._sharedBody}}]),t}();rt.TYPE="shape",rt.idCounter=0;var at=function(){function t(t){this.impl=0,this.event=void 0,this.event=t}var i=t.prototype;return i.getLocalPointOnA=function(t){this.impl&&Y(t,S.ManifoldPoint_get_m_localPointA(this.impl))},i.getLocalPointOnB=function(t){this.impl&&Y(t,S.ManifoldPoint_get_m_localPointB(this.impl))},i.getWorldPointOnA=function(t){this.impl&&Y(t,S.ManifoldPoint_get_m_positionWorldOnA(this.impl))},i.getWorldPointOnB=function(t){this.impl&&Y(t,S.ManifoldPoint_get_m_positionWorldOnB(this.impl))},i.getLocalNormalOnA=function(t){if(this.impl){var i=x.instance.BT_QUAT_0,e=S.PersistentManifold_getBody0(this.event.impl),s=S.CollisionObject_getWorldTransform(e);S.Transform_getRotation(s,i);var n=H;Q(n,i),a.conjugate(n,n),Y(t,S.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||r.negate(t,t),r.transformQuat(t,t,n)}},i.getLocalNormalOnB=function(t){if(this.impl){var i=x.instance.BT_QUAT_0,e=S.PersistentManifold_getBody1(this.event.impl),s=S.CollisionObject_getWorldTransform(e);S.Transform_getRotation(s,i);var n=H;Q(n,i),a.conjugate(n,n),Y(t,S.ManifoldPoint_get_m_normalWorldOnB(this.impl)),r.transformQuat(t,t,n)}},i.getWorldNormalOnA=function(t){this.impl&&(Y(t,S.ManifoldPoint_get_m_normalWorldOnB(this.impl)),this.isBodyA||r.negate(t,t))},i.getWorldNormalOnB=function(t){this.impl&&Y(t,S.ManifoldPoint_get_m_normalWorldOnB(this.impl))},o(t,[{key:"isBodyA",get:function(){return this.event.selfCollider.shape.sharedBody.body===S.PersistentManifold_getBody0(this.event.impl)}}]),t}(),lt=[],ht=G,ct=P,dt=new s,pt=function(){var t=i.prototype;function i(){this._world=void 0,this._broadphase=void 0,this._solver=void 0,this._dispatcher=void 0,this._needEmitEvents=!1,this._needSyncAfterEvents=!1,this._needEmitCCTEvents=!1,this.bodies=[],this.ghosts=[],this.ccts=[],this.constraints=[],this.triggerArrayMat=new A,this.collisionArrayMat=new A,this.contactsDic=new O,this.oldContactsDic=new O,this.cctShapeEventDic=new O,this._broadphase=S.DbvtBroadphase_new(),this._dispatcher=S.CollisionDispatcher_new(),this._solver=S.SequentialImpulseConstraintSolver_new(),this._world=S.ccDiscreteDynamicsWorld_new(this._dispatcher,this._broadphase,this._solver)}return t.setDefaultMaterial=function(){},t.setAllowSleep=function(t){S.ccDiscreteDynamicsWorld_setAllowSleep(this._world,t)},t.setGravity=function(t){S.DynamicsWorld_setGravity(this._world,z(x.instance.BT_V3_0,t))},t.updateNeedEmitEvents=function(t){if(this.ghosts)if(t)this._needEmitEvents=!0;else{this._needEmitEvents=!1;for(var i=0;i<this.ghosts.length;i++)for(var e=this.ghosts[i].ghostStruct.wrappedShapes,s=0;s<e.length;s++){var n=e[s].collider;if(n.needCollisionEvent||n.needTriggerEvent)return void(this._needEmitEvents=!0)}for(var o=0;o<this.bodies.length;o++)for(var r=this.bodies[o].bodyStruct.wrappedShapes,a=0;a<r.length;a++){var l=r[a].collider;if(l.needCollisionEvent||l.needTriggerEvent)return void(this._needEmitEvents=!0)}}},t.updateNeedEmitCCTEvents=function(t){if(this.ccts)if(t)this._needEmitCCTEvents=!0;else{this._needEmitCCTEvents=!1;for(var i=this.ccts,e=i.length,s=0;s<e;s++)if(i[s].characterController.needCollisionEvent)return void(this._needEmitCCTEvents=!0)}},t.destroy=function(){(this.constraints.length||this.bodies.length||this.ccts.length)&&c("You should destroy all physics component first."),S._safe_delete(this._world,C.EBulletTypeCollisionWorld),S._safe_delete(this._broadphase,C.EBulletTypeDbvtBroadPhase),S._safe_delete(this._dispatcher,C.EBulletTypeCollisionDispatcher),S._safe_delete(this._solver,C.EBulletTypeSequentialImpulseConstraintSolver),this.bodies=null,this.ghosts=null,this.ccts=null,this.constraints=null,this.triggerArrayMat=null,this.collisionArrayMat=null,this.contactsDic=null,this.oldContactsDic=null,this.cctShapeEventDic=null,this.cctShapeEventPool=null,lt.length=0},t.step=function(t,i,e){if(void 0===e&&(e=0),this.bodies.length||this.ghosts.length||this.ccts.length){void 0===i&&(i=t),S.DynamicsWorld_stepSimulation(this._world,i,e,t);for(var s=this.ccts,n=s.length,o=0;o<n;o++)s[o].syncPhysicsToScene()}},t.syncSceneToPhysics=function(){for(var t=this.ghosts.length-1;t>=0;t--){var i=this.ghosts[t];i.updateDirty(),i.syncSceneToGhost()}for(var e=this.bodies.length-1;e>=0;e--){var s=this.bodies[e];s.updateDirty(),s.syncSceneToPhysics()}for(var n=this.ccts,o=n.length-1;o>=0;o--){var r=n[o];r.updateDirty(),r.syncSceneToPhysics()}},t.syncAfterEvents=function(){this._needSyncAfterEvents&&this.syncSceneToPhysics()},t.raycast=function(t,i,e,s){t.computeHit(ht,i.maxDistance);var n=z(x.instance.BT_V3_0,ht),o=z(x.instance.BT_V3_1,t.o),a=S.ccAllRayCallback_static();if(S.ccAllRayCallback_reset(a,o,n,i.mask,i.queryTrigger),S.ccAllRayCallback_setFlags(a,T.UseSubSimplexConvexCastRaytest),S.CollisionWorld_rayTest(this._world,o,n,a),S.RayCallback_hasHit(a)){for(var l=S.ccAllRayCallback_getHitPointWorld(a),h=S.ccAllRayCallback_getHitNormalWorld(a),c=S.ccAllRayCallback_getCollisionShapePtrs(a),d=0,p=S.int_array_size(c);d<p;d++){Y(ht,S.Vec3_array_at(l,d)),Y(ct,S.Vec3_array_at(h,d));var _=x.getWrapper(S.int_array_at(c,d),rt.TYPE),u=e.add();s.push(u),u._assign(ht,r.distance(t.o,ht),_.collider,ct)}return!0}return!1},t.raycastClosest=function(t,i,e){t.computeHit(ht,i.maxDistance);var s=z(x.instance.BT_V3_0,ht),n=z(x.instance.BT_V3_1,t.o),o=S.ccClosestRayCallback_static();if(S.ccClosestRayCallback_reset(o,n,s,i.mask,i.queryTrigger),S.ccClosestRayCallback_setFlags(o,T.UseSubSimplexConvexCastRaytest),S.CollisionWorld_rayTest(this._world,n,s,o),S.RayCallback_hasHit(o)){Y(ht,S.ccClosestRayCallback_getHitPointWorld(o)),Y(ct,S.ccClosestRayCallback_getHitNormalWorld(o));var a=x.getWrapper(S.ccClosestRayCallback_getCollisionShapePtr(o),rt.TYPE);return e._assign(ht,r.distance(t.o,ht),a.collider,ct),!0}return!1},t.sweepBox=function(t,e,s,n,o,r){var a=x.instance.BT_V3_0;return z(a,e),i._sweepBoxGeometry||(i._sweepBoxGeometry=S.BoxShape_new(a)),S.BoxShape_setUnscaledHalfExtents(i._sweepBoxGeometry,a),this.sweep(t,i._sweepBoxGeometry,s,n,o,r)},t.sweepBoxClosest=function(t,e,s,n,o){var r=x.instance.BT_V3_0;return z(r,e),i._sweepBoxGeometry||(i._sweepBoxGeometry=S.BoxShape_new(r)),S.BoxShape_setUnscaledHalfExtents(i._sweepBoxGeometry,r),this.sweepClosest(t,i._sweepBoxGeometry,s,n,o)},t.sweepSphere=function(t,e,s,n,o){return i._sweepSphereGeometry||(i._sweepSphereGeometry=S.SphereShape_new(e)),S.SphereShape_setUnscaledRadius(i._sweepSphereGeometry,e),this.sweep(t,i._sweepSphereGeometry,a.IDENTITY,s,n,o)},t.sweepSphereClosest=function(t,e,s,n){return i._sweepSphereGeometry||(i._sweepSphereGeometry=S.SphereShape_new(e)),S.SphereShape_setUnscaledRadius(i._sweepSphereGeometry,e),this.sweepClosest(t,i._sweepSphereGeometry,a.IDENTITY,s,n)},t.sweepCapsule=function(t,e,s,n,o,r,a){return i._sweepCapsuleGeometry||(i._sweepCapsuleGeometry=S.CapsuleShape_new(e,s)),S.CapsuleShape_updateProp(i._sweepCapsuleGeometry,e,.5*s,1),this.sweep(t,i._sweepCapsuleGeometry,n,o,r,a)},t.sweepCapsuleClosest=function(t,e,s,n,o,r){return i._sweepCapsuleGeometry||(i._sweepCapsuleGeometry=S.CapsuleShape_new(e,s)),S.CapsuleShape_updateProp(i._sweepCapsuleGeometry,e,.5*s,1),this.sweepClosest(t,i._sweepCapsuleGeometry,n,o,r)},t.sweep=function(t,i,e,s,n,o){var a=x.instance.BT_TRANSFORM_0,l=x.instance.BT_TRANSFORM_1,h=x.instance.BT_QUAT_0;z(S.Transform_getOrigin(a),t.o),J(h,e),S.Transform_setRotation(a,h),t.computeHit(ht,s.maxDistance),z(S.Transform_getOrigin(l),ht),J(h,e),S.Transform_setRotation(l,h);var c=S.ccAllConvexCallback_static();if(S.ccAllConvexCallback_reset(c,a,l,s.mask,s.queryTrigger),S.CollisionWorld_convexSweepTest(this._world,i,a,l,c,0),S.ConvexCallback_hasHit(c)){for(var d=S.ccAllConvexCallback_getHitPointWorld(c),p=S.ccAllConvexCallback_getHitNormalWorld(c),_=S.ccAllConvexCallback_getCollisionShapePtrs(c),u=0,f=S.int_array_size(_);u<f;u++){Y(ht,S.Vec3_array_at(d,u)),Y(ct,S.Vec3_array_at(p,u));var y=x.getWrapper(S.int_array_at(_,u),rt.TYPE),g=n.add();o.push(g),g._assign(ht,r.distance(t.o,ht),y.collider,ct)}return!0}return!1},t.sweepClosest=function(t,i,e,s,n){var o=x.instance.BT_TRANSFORM_0,a=x.instance.BT_TRANSFORM_1,l=x.instance.BT_QUAT_0;z(S.Transform_getOrigin(o),t.o),J(l,e),S.Transform_setRotation(o,l),t.computeHit(ht,s.maxDistance),z(S.Transform_getOrigin(a),ht),J(l,e),S.Transform_setRotation(a,l);var h=S.ccClosestConvexCallback_static();if(S.ccClosestConvexCallback_reset(h,o,a,s.mask,s.queryTrigger),S.CollisionWorld_convexSweepTest(this._world,i,o,a,h,0),S.ConvexCallback_hasHit(h)){Y(ht,S.ccClosestConvexCallback_getHitPointWorld(h)),Y(ct,S.ccClosestConvexCallback_getHitNormalWorld(h));var c=x.getWrapper(S.ccClosestConvexCallback_getCollisionShapePtr(h),rt.TYPE);return n._assign(ht,r.distance(t.o,ht),c.collider,ct),!0}return!1},t.getSharedBody=function(t,i){return st.getSharedBody(t,this,i)},t.addSharedBody=function(t){this.bodies.indexOf(t)<0&&(this.bodies.push(t),S.DynamicsWorld_addRigidBody(this._world,t.body,t.collisionFilterGroup,t.collisionFilterMask))},t.removeSharedBody=function(t){var i=this.bodies.indexOf(t);i>=0&&(h(this.bodies,i),S.DynamicsWorld_removeRigidBody(this._world,t.body))},t.addGhostObject=function(t){this.ghosts.indexOf(t)<0&&(this.ghosts.push(t),S.CollisionWorld_addCollisionObject(this._world,t.ghost,t.collisionFilterGroup,t.collisionFilterMask))},t.removeGhostObject=function(t){var i=this.ghosts.indexOf(t);i>=0&&(h(this.ghosts,i),S.CollisionWorld_removeCollisionObject(this._world,t.ghost))},t.addCCT=function(t){if(this.ccts.indexOf(t)<0){this.ccts.push(t);var i=S.CharacterController_getGhostObject(t.impl);S.CollisionWorld_addCollisionObject(this._world,i,t.getGroup(),t.getMask()),S.DynamicsWorld_addAction(this._world,t.impl)}},t.removeCCT=function(t){var i=this.ccts.indexOf(t);if(i>=0){h(this.ccts,i);var e=S.CharacterController_getGhostObject(t.impl);S.CollisionWorld_removeCollisionObject(this._world,e),S.DynamicsWorld_removeAction(this._world,t.impl)}},t.addConstraint=function(t){var i=this.constraints.indexOf(t);i<0&&(this.constraints.push(t),S.DynamicsWorld_addConstraint(this.impl,t.impl,!t.constraint.enableCollision),t.index=i)},t.removeConstraint=function(t){var i=this.constraints.indexOf(t);i>=0&&(this.constraints.splice(i,1),S.DynamicsWorld_removeConstraint(this.impl,t.impl),t.index=-1)},t.emitEvents=function(){if(this._needSyncAfterEvents=!1,this._needEmitEvents){this.gatherConatactData();for(var t=this.contactsDic.getLength();t--;){lt.push.apply(lt,F.contacts),F.contacts.length=0;var i=this.contactsDic.getKeyByIndex(t),e=this.contactsDic.getDataByKey(i),s=e.shape0,n=e.shape1;this.oldContactsDic.set(s.id,n.id,e);var o=s.collider,r=n.collider;if(o&&r){if(o.isTrigger||r.isTrigger)this.triggerArrayMat.get(s.id,n.id)?I.type="onTriggerStay":(I.type="onTriggerEnter",this.triggerArrayMat.set(s.id,n.id,!0)),I.impl=e.impl,I.selfCollider=o,I.otherCollider=r,o.emit(I.type,I),I.selfCollider=r,I.otherCollider=o,r.emit(I.type,I),this._needSyncAfterEvents=!0;else{var a=o.attachedRigidBody,l=r.attachedRigidBody;if(a&&l){if(a.isSleeping&&l.isSleeping)continue}else if(!a&&l){if(l.isSleeping)continue}else if(!l&&a&&a.isSleeping)continue;this.collisionArrayMat.get(s.id,n.id)?F.type="onCollisionStay":(F.type="onCollisionEnter",this.collisionArrayMat.set(s.id,n.id,!0));for(var h=0;h<e.contacts.length;h++){var c=e.contacts[h];if(lt.length>0){var d=lt.pop();d.impl=c,F.contacts.push(d)}else{var p=new at(F);p.impl=c,F.contacts.push(p)}}F.impl=e.impl,F.selfCollider=o,F.otherCollider=r,o.emit(F.type,F),F.selfCollider=r,F.otherCollider=o,r.emit(F.type,F),this._needSyncAfterEvents=!0}null==this.oldContactsDic.get(s.id,n.id)&&this.oldContactsDic.set(s.id,n.id,e)}}for(var _=this.oldContactsDic.getLength();_--;){var u=this.oldContactsDic.getKeyByIndex(_),f=this.oldContactsDic.getDataByKey(u),y=f.shape0,g=f.shape1,m=y.collider,S=g.collider;if(m&&S){var C=m.isTrigger||S.isTrigger;null==this.contactsDic.getDataByKey(u)&&(C?this.triggerArrayMat.get(y.id,g.id)&&(I.type="onTriggerExit",I.selfCollider=m,I.otherCollider=S,m.emit(I.type,I),I.selfCollider=S,I.otherCollider=m,S.emit(I.type,I),this.triggerArrayMat.set(y.id,g.id,!1),this.oldContactsDic.set(y.id,g.id,null),this._needSyncAfterEvents=!0):this.collisionArrayMat.get(y.id,g.id)&&(lt.push.apply(lt,F.contacts),F.contacts.length=0,F.type="onCollisionExit",F.selfCollider=m,F.otherCollider=S,m.emit(F.type,F),F.selfCollider=S,F.otherCollider=m,S.emit(F.type,F),this.collisionArrayMat.set(y.id,g.id,!1),this.oldContactsDic.set(y.id,g.id,null),this._needSyncAfterEvents=!0))}}this.contactsDic.reset()}if(this._needEmitCCTEvents){for(var T=this.cctShapeEventDic.getLength();T--;){var B,v=this.cctShapeEventDic.getKeyByIndex(T),w=this.cctShapeEventDic.getDataByKey(v),b=w.BulletCharacterController,E=w.BulletShape,M=w.worldPos,A=w.worldNormal,O=w.motionDir,D=w.motionLength;dt.controller=b.characterController,dt.collider=E.collider,dt.worldPosition.set(M.x,M.y,M.z),dt.worldNormal.set(A.x,A.y,A.z),dt.motionDirection.set(O.x,O.y,O.z),dt.motionLength=D,null===(B=dt.controller)||void 0===B||B.emit("onControllerColliderHit",dt),this._needSyncAfterEvents=!0}this.cctShapeEventDic.reset()}},t.gatherConatactData=function(){for(var t=S.Dispatcher_getNumManifolds(this._dispatcher),i=0;i<t;i++)for(var e=S.Dispatcher_getManifoldByIndexInternal(this._dispatcher,i),s=S.PersistentManifold_getNumContacts(e),n=0;n<s;n++){var o=S.PersistentManifold_getContactPoint(e,n),r=S.ManifoldPoint_getShape0(o),a=S.ManifoldPoint_getShape1(o),l=x.getWrapper(r,rt.TYPE),h=x.getWrapper(a,rt.TYPE);if(l&&h&&(l.collider.needTriggerEvent||h.collider.needTriggerEvent||l.collider.needCollisionEvent||h.collider.needCollisionEvent)){var c=this.contactsDic.get(l.id,h.id);c||(c=this.contactsDic.set(l.id,h.id,{shape0:l,shape1:h,contacts:[],impl:e})),c.contacts.push(o)}}},o(i,[{key:"impl",get:function(){return this._world}}]),i}();pt._sweepBoxGeometry=void 0,pt._sweepSphereGeometry=void 0,pt._sweepCapsuleGeometry=void 0;var _t=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var s=i.prototype;return s.updateSize=function(){var t=x.instance.BT_V3_0;z(t,this.getMinUnscaledHalfExtents(D)),S.BoxShape_setUnscaledHalfExtents(this.impl,t),this.updateCompoundTransform()},s.onComponentSet=function(){var t=x.instance.BT_V3_0;z(t,this.getMinUnscaledHalfExtents(D)),this._impl=S.BoxShape_new(t),this.updateScale()},s.updateScale=function(){t.prototype.updateScale.call(this);var i=x.instance.BT_V3_0;S.CollisionShape_setLocalScaling(this._impl,z(i,this.getMinScale(D))),this.updateCompoundTransform()},s.getMinUnscaledHalfExtents=function(t){var i=this.collider.size,s=R(D.set(this._collider.node.worldScale)),n=e.instance.minVolumeSize,o=i.x/2,r=i.y/2,a=i.z/2,l=o*s.x<n?n/s.x:o,h=r*s.y<n?n/s.y:r,c=a*s.z<n?n/s.z:a;return t.set(l,h,c),t},s.getMinScale=function(t){var i=this.collider.size,s=R(D.set(this._collider.node.worldScale)),n=e.instance.minVolumeSize,o=i.x/2,r=i.y/2,a=i.z/2,l=o*s.x<n?n/o:s.x,h=r*s.y<n?n/r:s.y,c=a*s.z<n?n/a:s.z;return t.set(l,h,c),t},o(i,[{key:"collider",get:function(){return this._collider}}]),i}(rt),ut=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var s=i.prototype;return s.updateRadius=function(){S.SphereShape_setUnscaledRadius(this.impl,this.getMinUnscaledRadius()),this.updateCompoundTransform()},s.onComponentSet=function(){this._impl=S.SphereShape_new(this.getMinUnscaledRadius()),this.updateScale()},s.updateScale=function(){t.prototype.updateScale.call(this);var i=this.getMinScale();G.set(i,i,i);var e=x.instance.BT_V3_0;S.CollisionShape_setLocalScaling(this._impl,z(e,G)),this.updateCompoundTransform()},s.getMinUnscaledRadius=function(){var t=this.collider.radius,i=Math.abs(p(this._collider.node.worldScale)),s=e.instance.minVolumeSize;return i*t<s?s/i:t},s.getMinScale=function(){var t=this.collider.radius,i=Math.abs(p(this._collider.node.worldScale)),s=e.instance.minVolumeSize;return i*t<s?s/t:i},o(i,[{key:"collider",get:function(){return this._collider}}]),i}(rt),ft=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var e=i.prototype;return e.setCylinderHeight=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){this._impl=S.CapsuleShape_new(.5,1),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n,o,r=s,a=e;1===a?(n=t*Math.abs(_(r.x,r.z)),o=i/2*Math.abs(r.y)):0===a?(n=t*Math.abs(_(r.y,r.z)),o=i/2*Math.abs(r.x)):(n=t*Math.abs(_(r.x,r.y)),o=i/2*Math.abs(r.z)),S.CapsuleShape_updateProp(this._impl,n,o,a),this.updateCompoundTransform()},o(i,[{key:"collider",get:function(){return this._collider}}]),i}(rt),yt=function(){function t(t,i){this.key=void 0,this.ref=0,this.bulletBvhTriangleMeshShapePtr=void 0,this.btTriangleMeshPtr=0,this.reference=!0,this.key=t,this.btTriangleMeshPtr=S.TriangleMesh_new(),Z(this.btTriangleMeshPtr,i),this.bulletBvhTriangleMeshShapePtr=S.BvhTriangleMeshShape_new(this.btTriangleMeshPtr,!0,!0)}return t.getBulletBvhTriangleMeshShape=function(i,e){var s;return t.BulletBvhTriangleMeshShapeMap.has(i)?(s=t.BulletBvhTriangleMeshShapeMap.get(i)).reference=!0:(s=new t(i,e),t.BulletBvhTriangleMeshShapeMap.set(i,s)),s},t.prototype.destroy=function(){this.bulletBvhTriangleMeshShapePtr&&S._safe_delete(C.EBulletTypeCollisionShape,this.bulletBvhTriangleMeshShapePtr),this.btTriangleMeshPtr&&S._safe_delete(C.EBulletTypeTriangleMesh,this.btTriangleMeshPtr),t.BulletBvhTriangleMeshShapeMap.delete(this.key)},o(t,[{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),t}();yt.BulletBvhTriangleMeshShapeMap=new Map;var gt,mt,St=function(t){function i(){for(var i,e=arguments.length,s=new Array(e),n=0;n<e;n++)s[n]=arguments[n];return(i=t.call.apply(t,[this].concat(s))||this).btBVHMeshShape=void 0,i.refBtTriangleMesh=0,i}d(i,t);var e=i.prototype;return e.setMesh=function(t){if(this._isInitialized)if(this._impl&&x.isNotEmptyShape(this._impl))u(9620);else{var i=t;if(i&&i.renderingSubMeshes.length>0){if(this.collider.convex){var e=this._getBtTriangleMesh(i);this._impl=S.ConvexTriangleMeshShape_new(e)}else this.btBVHMeshShape=yt.getBulletBvhTriangleMeshShape(i.hash,i),this._impl=S.ScaledBvhTriangleMeshShape_new(this.btBVHMeshShape.bulletBvhTriangleMeshShapePtr,1,1,1);var s=x.instance.BT_V3_0;z(s,this._collider.node.worldScale),S.CollisionShape_setLocalScaling(this._impl,s),S.CollisionShape_setMargin(this._impl,.01),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=S.EmptyShape_static()}},e.onComponentSet=function(){this.setMesh(this.collider.mesh)},e.onDestroy=function(){this.collider.convex?this.refBtTriangleMesh&&S._safe_delete(this.refBtTriangleMesh,C.EBulletTypeTriangleMesh):this.btBVHMeshShape&&(this.btBVHMeshShape.reference=!1),t.prototype.onDestroy.call(this)},e.updateScale=function(){t.prototype.updateScale.call(this);var i=x.instance.BT_V3_0;z(i,this._collider.node.worldScale),S.CollisionShape_setLocalScaling(this._impl,i),this.updateCompoundTransform()},e._getBtTriangleMesh=function(t){return this.refBtTriangleMesh=S.TriangleMesh_new(),Z(this.refBtTriangleMesh,t),this.refBtTriangleMesh},o(i,[{key:"collider",get:function(){return this._collider}}]),i}(rt),Ct=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var e=i.prototype;return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){var t=x.instance.BT_V3_0;S.Vec3_set(t,.5,1,.5),this._impl=S.CylinderShape_new(t),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n,o,r=s,a=e;1===a?(o=i*Math.abs(r.y),n=t*Math.abs(_(r.x,r.z))):0===a?(o=i*Math.abs(r.x),n=t*Math.abs(_(r.y,r.z))):(o=i*Math.abs(r.z),n=t*Math.abs(_(r.x,r.y))),S.CylinderShape_updateProp(this._impl,n,o/2,a),this.updateCompoundTransform()},o(i,[{key:"collider",get:function(){return this._collider}}]),i}(rt),Tt=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var e=i.prototype;return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.onComponentSet=function(){this._impl=S.ConeShape_new(.5,1),this.setRadius(this.collider.radius)},e.updateScale=function(){t.prototype.updateScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var n,o,r=s,a=e;1===a?(o=i*Math.abs(r.y),n=t*Math.abs(_(r.x,r.z))):0===a?(o=i*Math.abs(r.x),n=t*Math.abs(_(r.y,r.z))):(o=i*Math.abs(r.z),n=t*Math.abs(_(r.x,r.y))),S.ConeShape_setRadius(this._impl,n),S.ConeShape_setHeight(this._impl,o),S.ConeShape_setConeUpIndex(this._impl,a);var l=x.instance.BT_V3_0;S.Vec3_set(l,1,1,1),S.CollisionShape_setLocalScaling(this._impl,l),this.updateCompoundTransform()},o(i,[{key:"impl",get:function(){return this._impl}},{key:"collider",get:function(){return this._collider}}]),i}(rt),Bt=function(t){function i(){for(var i,e=arguments.length,s=new Array(e),n=0;n<e;n++)s[n]=arguments[n];return(i=t.call.apply(t,[this].concat(s))||this)._bufPtr=0,i._tileSize=0,i._localOffset=new r,i}d(i,t);var e=i.prototype;return e.setTerrain=function(t){if(this._isInitialized)if(this._impl&&x.isNotEmptyShape(this._impl))f("[Physics][Bullet]: change the terrain asset after initialization is not support.");else{var i=t;if(i){this._tileSize=i.tileSize;var e=i.getVertexCountI(),s=i.getVertexCountJ();this._bufPtr=S._malloc(4*e*s);for(var n=0,o=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,a=0;a<s;a++)for(var l=0;l<e;l++){var h=i.getHeight(l,a);S._write_f32(this._bufPtr+n,h),o>h&&(o=h),h>r&&(r=h),n+=4}r+=.01,o-=.01,this._localOffset.set((e-1)/2*this._tileSize,(r+o)/2,(s-1)/2*this._tileSize),this._impl=S.TerrainShape_new(e,s,this._bufPtr,1,o,r);var c=x.instance.BT_V3_0;S.Vec3_set(c,this._tileSize,1,this._tileSize),S.CollisionShape_setLocalScaling(this._impl,c),this.setCompound(this._compound),this.updateByReAdd(),this.setWrapper()}else this._impl=S.EmptyShape_static()}},e.onComponentSet=function(){this.setTerrain(this.collider.terrain)},e.onDestroy=function(){this._bufPtr&&S._free(this._bufPtr),t.prototype.onDestroy.call(this)},e.setCenter=function(t){r.copy(G,t),G.add(this._localOffset),z(S.Transform_getOrigin(this.transform),G),this.updateCompoundTransform()},o(i,[{key:"collider",get:function(){return this._collider}}]),i}(rt),vt=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var e=i.prototype;return e.setShapeType=function(){},e.setVertices=function(){},e.onComponentSet=function(){this._impl=S.SimplexShape_new();for(var t=this.collider.shapeType,i=this.collider.vertices,e=x.instance.BT_V3_0,s=0;s<t;s++)S.SimplexShape_addVertex(this._impl,z(e,i[s]));S.CollisionShape_setLocalScaling(this._impl,z(e,this._collider.node.worldScale))},e.onLoad=function(){t.prototype.onLoad.call(this),this.collider.updateVertices()},e.updateScale=function(){t.prototype.updateScale.call(this);var i=x.instance.BT_V3_0;S.CollisionShape_setLocalScaling(this._impl,z(i,this._collider.node.worldScale))},o(i,[{key:"collider",get:function(){return this._collider}}]),i}(rt),wt=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var e=i.prototype;return e.setNormal=function(t){z(S.StaticPlaneShape_getPlaneNormal(this.impl),t),this.updateCompoundTransform()},e.setConstant=function(t){S.StaticPlaneShape_setPlaneConstant(this.impl,t),this.updateCompoundTransform()},e.updateScale=function(){t.prototype.updateScale.call(this);var i=x.instance.BT_V3_0;z(i,this._collider.node.worldScale),S.CollisionShape_setLocalScaling(this._impl,i),this.updateCompoundTransform()},e.onComponentSet=function(){var t=x.instance.BT_V3_0;z(t,this.collider.normal),this._impl=S.StaticPlaneShape_new(t,this.collider.constant),this.updateScale()},o(i,[{key:"collider",get:function(){return this._collider}}]),i}(rt),bt=function(){function t(){this.dirty=0,this.index=-1,this._impl=0,this._com=void 0,this._rigidBody=void 0,this._connectedBody=null,this._collided=!1}var i=t.prototype;return i.setConnectedBody=function(t){if(this._connectedBody!==t){var i=this._connectedBody;i&&i.body.sharedBody.removeJoint(this,1);var e=this._rigidBody.body.sharedBody;e.removeJoint(this,0),this._impl&&(e.wrappedWorld.removeConstraint(this),S._safe_delete(this._impl,C.EBulletTypeTypedConstraint)),this._connectedBody=t;var s=this._connectedBody;this.onComponentSet(),this.setEnableCollision(this._collided),e.wrappedWorld.addConstraint(this),e.addJoint(this,0),s&&s.body.sharedBody.addJoint(this,1)}},i.setEnableCollision=function(t){this._collided!==t&&(this._collided=t,this.updateByReAdd())},i.updateByReAdd=function(){if(this._rigidBody&&this.index>=0){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}},i.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this._connectedBody=t.connectedBody,this._collided=t.enableCollision,this.onComponentSet(),this.setEnableCollision(this._collided)},i.onEnable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);var i=this._connectedBody;i&&i.body.sharedBody.addJoint(this,1)},i.onDisable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);var i=this._connectedBody;i&&i.body.sharedBody.removeJoint(this,1)},i.onDestroy=function(){S._safe_delete(this._impl,C.EBulletTypeTypedConstraint),this._com=null,this._rigidBody=null,this._connectedBody=null},o(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(),Et=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var e=i.prototype;return e.setPivotA=function(){var t=this.constraint,i=x.instance.BT_V3_0;r.multiply(G,t.node.worldScale,t.pivotA),z(i,G),S.P2PConstraint_setPivotA(this._impl,i),t.connectedBody||this.setPivotB(t.pivotB)},e.setPivotB=function(){var t=this.constraint,i=this._rigidBody.node,e=x.instance.BT_V3_0,s=t.connectedBody;s?(r.multiply(G,s.node.worldScale,t.pivotB),z(e,G)):(r.multiply(G,i.worldScale,t.pivotA),r.transformQuat(G,G,i.worldRotation),r.add(G,G,i.worldPosition),z(e,G)),S.P2PConstraint_setPivotB(this._impl,e)},e.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t?t.body.impl:S.TypedConstraint_getFixedBody(),s=x.instance.BT_V3_0,n=x.instance.BT_V3_1;this._impl=S.P2PConstraint_new(i,e,s,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},e.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},e.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},o(i,[{key:"constraint",get:function(){return this._com}}]),i}(bt),Mt=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var e=i.prototype;return e.setBreakForce=function(t){S.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},e.setBreakTorque=function(){},e.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t?t.body.impl:S.TypedConstraint_getFixedBody(),s=x.instance.BT_TRANSFORM_0,n=x.instance.BT_TRANSFORM_1;this._impl=S.FixedConstraint_new(i,e,s,n),this.setBreakForce(this.constraint.breakForce),this.setBreakTorque(this.constraint.breakTorque),this.updateFrames()},e.updateFrames=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.sharedBody,e=G,s=H,n=x.instance.BT_TRANSFORM_0,o=x.instance.BT_TRANSFORM_1,r=x.instance.BT_QUAT_0,a=U;if(l.fromRT(a,i.node.worldRotation,i.node.worldPosition),l.invert(a,a),l.getRotation(s,a),l.getTranslation(e,a),z(S.Transform_getOrigin(n),e),J(r,s),S.Transform_setRotation(n,r),t){var h=t.body.sharedBody;l.fromRT(a,h.node.worldRotation,h.node.worldPosition),l.invert(a,a),l.getRotation(s,a),l.getTranslation(e,a),z(S.Transform_getOrigin(o),e),J(r,s),S.Transform_setRotation(o,r)}else S.Transform_setIdentity(o);S.FixedConstraint_setFrames(this._impl,n,o)},e.updateScale0=function(){this.updateFrames()},e.updateScale1=function(){this.updateFrames()},o(i,[{key:"constraint",get:function(){return this._com}}]),i}(bt),At=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var s=i.prototype;return s.setPivotA=function(){this.updateFrames()},s.setPivotB=function(){this.updateFrames()},s.setAxis=function(){this.updateFrames()},s.setLimitEnabled=function(){this.constraint.limitEnabled?S.HingeConstraint_setLimit(this._impl,y(this.constraint.lowerLimit),y(this.constraint.upperLimit),.9,.3,1):S.HingeConstraint_setLimit(this._impl,1,0,.9,.3,1)},s.setLowerLimit=function(){this.constraint.limitEnabled&&S.HingeConstraint_setLimit(this._impl,y(this.constraint.lowerLimit),y(this.constraint.upperLimit),.9,.3,1)},s.setUpperLimit=function(){this.constraint.limitEnabled&&S.HingeConstraint_setLimit(this._impl,y(this.constraint.lowerLimit),y(this.constraint.upperLimit),.9,.3,1)},s.setMotorEnabled=function(t){S.HingeConstraint_enableMotor(this._impl,t);var i=-this.constraint.motorVelocity/60,s=K(this.constraint.motorForceLimit,e.instance.fixedTimeStep);S.HingeConstraint_setMotorVelocity(this._impl,i),S.HingeConstraint_setMaxMotorImpulse(this._impl,s)},s.setMotorVelocity=function(t){if(this.constraint.motorEnabled){var i=-t/60;S.HingeConstraint_setMotorVelocity(this._impl,i)}},s.setMotorForceLimit=function(t){if(this.constraint.motorEnabled){var i=K(t,e.instance.fixedTimeStep);S.HingeConstraint_setMaxMotorImpulse(this._impl,i)}},s.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t?t.body.impl:S.TypedConstraint_getFixedBody(),s=x.instance.BT_TRANSFORM_0,n=x.instance.BT_TRANSFORM_1;this._impl=S.HingeConstraint_new(i,e,s,n),this.setLimitEnabled(this.constraint.limitEnabled),this.setLowerLimit(this.constraint.lowerLimit),this.setUpperLimit(this.constraint.upperLimit),this.setMotorEnabled(this.constraint.motorEnabled),this.setMotorVelocity(this.constraint.motorVelocity),this.setMotorForceLimit(this.constraint.motorForceLimit),this.updateFrames()},s.updateFrames=function(){var t=this.constraint,i=t.node,e=G,s=H,n=j,o=x.instance.BT_TRANSFORM_0;r.multiply(e,i.worldScale,t.pivotA),z(S.Transform_getOrigin(o),e);var l=x.instance.BT_QUAT_0;r.normalize(e,t.axis),a.rotationTo(n,r.UNIT_Z,e),J(l,n),S.Transform_setRotation(o,l);var h=x.instance.BT_TRANSFORM_1,c=this.constraint.connectedBody;c?(r.multiply(e,c.node.worldScale,t.pivotB),a.multiply(n,i.worldRotation,n),a.invert(s,c.node.worldRotation),a.multiply(n,s,n)):(r.multiply(e,i.worldScale,t.pivotA),r.transformQuat(e,e,i.worldRotation),r.add(e,e,i.worldPosition),a.multiply(n,i.worldRotation,n)),z(S.Transform_getOrigin(h),e),J(l,n),S.Transform_setRotation(h,l),S.HingeConstraint_setFrames(this._impl,o,h)},s.updateScale0=function(){this.updateFrames()},s.updateScale1=function(){this.updateFrames()},o(i,[{key:"constraint",get:function(){return this._com}}]),i}(bt);!function(t){t[t.RO_XYZ=0]="RO_XYZ",t[t.RO_XZY=1]="RO_XZY",t[t.RO_YXZ=2]="RO_YXZ",t[t.RO_YZX=3]="RO_YZX",t[t.RO_ZXY=4]="RO_ZXY",t[t.RO_ZYX=5]="RO_ZYX"}(gt||(gt={})),function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z",t[t.TWIST=3]="TWIST",t[t.SWING1=4]="SWING1",t[t.SWING2=5]="SWING2"}(mt||(mt={}));var Ot=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var s=i.prototype;return s._setLimit=function(t,i,e,s){switch(t){case E.LOCKED:S.Generic6DofSpring2Constraint_setLimit(this._impl,i,0,0);break;case E.LIMITED:S.Generic6DofSpring2Constraint_setLimit(this._impl,i,e,s);break;case E.FREE:S.Generic6DofSpring2Constraint_setLimit(this._impl,i,1,0)}},s.setConstraintMode=function(t,i){var e=this.constraint.linearLimitSettings,s=this.constraint.angularLimitSettings,n=[0,0,0],o=[0,0,0],a=0,l=0;switch(t){case 0:case 1:case 2:r.toArray(n,e.lower),r.toArray(o,e.upper),l=n[t],a=o[t];break;case 3:l=-(a=.5*y(s.twistExtent));break;case 4:l=-(a=.5*y(s.swingExtent1));break;case 5:l=-(a=.5*y(s.swingExtent2));break;default:c("idx should be in [0, 5], but give "+t)}this._setLimit(i,t,l,a)},s.setLinearLimit=function(t,i,e){var s=0,n=this.constraint.linearLimitSettings;switch(t){case 0:s=n.xMotion;break;case 1:s=n.yMotion;break;case 2:s=n.zMotion}this._setLimit(s,t,i,e)},s.setAngularExtent=function(t,i,e){var s=this.constraint.angularLimitSettings;this._setLimit(s.twistMotion,mt.TWIST,.5*-y(t),.5*y(t)),this._setLimit(s.swingMotion1,mt.SWING1,.5*-y(i),.5*y(i)),this._setLimit(s.swingMotion2,mt.SWING2,.5*-y(e),.5*y(e))},s.setSwingSoftConstraint=function(t){S.Generic6DofSpring2Constraint_enableSpring(this._impl,mt.SWING1,t),S.Generic6DofSpring2Constraint_enableSpring(this._impl,mt.SWING2,t)},s.setTwistSoftConstraint=function(t){S.Generic6DofSpring2Constraint_enableSpring(this._impl,mt.TWIST,t)},s.setLinearSoftConstraint=function(t){S.Generic6DofSpring2Constraint_enableSpring(this._impl,mt.X,t),S.Generic6DofSpring2Constraint_enableSpring(this._impl,mt.Y,t),S.Generic6DofSpring2Constraint_enableSpring(this._impl,mt.Z,t)},s.setLinearStiffness=function(t){S.Generic6DofSpring2Constraint_setStiffness(this._impl,mt.X,t),S.Generic6DofSpring2Constraint_setStiffness(this._impl,mt.Y,t),S.Generic6DofSpring2Constraint_setStiffness(this._impl,mt.Z,t)},s.setLinearDamping=function(t){S.Generic6DofSpring2Constraint_setDamping(this._impl,mt.X,t),S.Generic6DofSpring2Constraint_setDamping(this._impl,mt.Y,t),S.Generic6DofSpring2Constraint_setDamping(this._impl,mt.Z,t)},s.setLinearRestitution=function(t){S.Generic6DofSpring2Constraint_setBounce(this._impl,mt.X,t),S.Generic6DofSpring2Constraint_setBounce(this._impl,mt.Y,t),S.Generic6DofSpring2Constraint_setBounce(this._impl,mt.Z,t)},s.setSwingStiffness=function(t){S.Generic6DofSpring2Constraint_setStiffness(this._impl,mt.SWING1,t),S.Generic6DofSpring2Constraint_setStiffness(this._impl,mt.SWING2,t)},s.setSwingDamping=function(t){S.Generic6DofSpring2Constraint_setDamping(this._impl,mt.SWING1,t),S.Generic6DofSpring2Constraint_setDamping(this._impl,mt.SWING2,t)},s.setSwingRestitution=function(t){S.Generic6DofSpring2Constraint_setBounce(this._impl,mt.SWING1,t),S.Generic6DofSpring2Constraint_setBounce(this._impl,mt.SWING2,t)},s.setTwistStiffness=function(t){S.Generic6DofSpring2Constraint_setStiffness(this._impl,mt.TWIST,t)},s.setTwistDamping=function(t){S.Generic6DofSpring2Constraint_setDamping(this._impl,mt.TWIST,t)},s.setTwistRestitution=function(t){S.Generic6DofSpring2Constraint_setBounce(this._impl,mt.TWIST,t)},s.setDriverMode=function(t,i){i===M.DISABLED?S.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!1):i===M.SERVO?(S.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!0),S.Generic6DofSpring2Constraint_setServo(this._impl,t,!0)):i===M.INDUCTION&&(S.Generic6DofSpring2Constraint_enableMotor(this._impl,t,!0),S.Generic6DofSpring2Constraint_setServo(this._impl,t,!1))},s._updateMotorTargetAndVelocity=function(t){var i=M.DISABLED,e=0,s=0,n=0,o=this.constraint.linearDriverSettings,r=this.constraint.angularDriverSettings;switch(t){case 0:e=mt.X,i=o.xDrive,s=o.targetPosition.x,n=-o.targetVelocity.x;break;case 1:e=mt.Y,i=o.yDrive,s=o.targetPosition.y,n=-o.targetVelocity.y;break;case 2:e=mt.Z,i=o.zDrive,s=o.targetPosition.z,n=-o.targetVelocity.z;break;case 3:e=mt.TWIST,i=r.twistDrive,s=-y(r.targetOrientation.x),n=-y(r.targetVelocity.x);break;case 4:e=mt.SWING1,i=r.swingDrive1,s=-y(r.targetOrientation.y),n=-y(r.targetVelocity.y);break;case 5:e=mt.SWING2,i=r.swingDrive2,s=-y(r.targetOrientation.z),n=-y(r.targetVelocity.z)}var a=t>2?r.strength:o.strength;S.Generic6DofSpring2Constraint_setServoTarget(this._impl,e,s),i===M.SERVO?t>2?S.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,e,-s*a*.1):S.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,e,s*a*.1):i===M.INDUCTION&&S.Generic6DofSpring2Constraint_setTargetVelocity(this._impl,e,n)},s.setLinearMotorTarget=function(){this._updateMotorTargetAndVelocity(0),this._updateMotorTargetAndVelocity(1),this._updateMotorTargetAndVelocity(2)},s.setLinearMotorVelocity=function(){this._updateMotorTargetAndVelocity(0),this._updateMotorTargetAndVelocity(1),this._updateMotorTargetAndVelocity(2)},s.setLinearMotorForceLimit=function(t){S.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,mt.X,t),S.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,mt.Y,t),S.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,mt.Z,t)},s.setAngularMotorTarget=function(){this._updateMotorTargetAndVelocity(3),this._updateMotorTargetAndVelocity(4),this._updateMotorTargetAndVelocity(5)},s.setAngularMotorVelocity=function(){this._updateMotorTargetAndVelocity(3),this._updateMotorTargetAndVelocity(4),this._updateMotorTargetAndVelocity(5)},s.setAngularMotorForceLimit=function(t){S.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,mt.TWIST,t),S.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,mt.SWING1,t),S.Generic6DofSpring2Constraint_setMaxMotorForce(this._impl,mt.SWING2,t)},s.setPivotA=function(){this.updateFrames()},s.setPivotB=function(){this.updateFrames()},s.setAutoPivotB=function(){this.updateFrames()},s.setAxis=function(){this.updateFrames()},s.setSecondaryAxis=function(){this.updateFrames()},s.setBreakForce=function(){var t=K(Math.max(this.constraint.breakForce,this.constraint.breakTorque),e.instance.fixedTimeStep);S.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},s.setBreakTorque=function(){var t=K(Math.max(this.constraint.breakForce,this.constraint.breakTorque),e.instance.fixedTimeStep);S.TypedConstraint_setMaxImpulseThreshold(this._impl,t)},s.onComponentSet=function(){var t=this.constraint.connectedBody,i=this._rigidBody.body.impl,e=t&&t.body.impl||S.TypedConstraint_getFixedBody(),s=x.instance.BT_TRANSFORM_0,n=x.instance.BT_TRANSFORM_1;this._impl=S.Generic6DofSpring2Constraint_new(i,e,s,n,gt.RO_YZX);var o=this.constraint.linearLimitSettings,r=this.constraint.angularLimitSettings;this.setConstraintMode(0,o.xMotion),this.setConstraintMode(1,o.yMotion),this.setConstraintMode(2,o.zMotion),this.setConstraintMode(3,r.twistMotion),this.setConstraintMode(4,r.swingMotion1),this.setConstraintMode(5,r.swingMotion2),this.setLinearSoftConstraint(o.enableSoftConstraint),this.setLinearStiffness(o.stiffness),this.setLinearDamping(o.damping),this.setLinearRestitution(o.restitution),this.setSwingSoftConstraint(r.enableSoftConstraintSwing),this.setSwingRestitution(r.swingRestitution),this.setSwingStiffness(r.swingStiffness),this.setSwingDamping(r.swingDamping),this.setTwistSoftConstraint(r.enableSoftConstraintTwist),this.setTwistRestitution(r.twistRestitution),this.setTwistStiffness(r.twistStiffness),this.setTwistDamping(r.twistDamping);var a=this.constraint.linearDriverSettings,l=this.constraint.angularDriverSettings;this.setDriverMode(0,a.xDrive),this.setDriverMode(1,a.yDrive),this.setDriverMode(2,a.zDrive),this.setDriverMode(3,l.twistDrive),this.setDriverMode(4,l.swingDrive1),this.setDriverMode(5,l.swingDrive2),this.setLinearMotorTarget(a.targetPosition),this.setLinearMotorVelocity(a.targetVelocity),this.setLinearMotorForceLimit(a.strength),this.setAngularMotorTarget(l.targetOrientation),this.setAngularMotorVelocity(l.targetVelocity),this.setAngularMotorForceLimit(l.strength),this.setBreakForce(this.constraint.breakForce),this.setBreakTorque(this.constraint.breakTorque),this.updateFrames()},s.updateFrames=function(){var t=this.constraint,i=t.node,e=G,s=H,n=j,o=x.instance.BT_TRANSFORM_0;r.multiply(e,i.worldScale,t.pivotA),z(S.Transform_getOrigin(o),e);var h=x.instance.BT_QUAT_0,c=t.axis,d=t.secondaryAxis,p=r.cross(P,c,d);l.set(U,c.x,c.y,c.z,0,d.x,d.y,d.z,0,p.x,p.y,p.z,0,0,0,0,1).getRotation(s),J(h,s),S.Transform_setRotation(o,h);var _=x.instance.BT_TRANSFORM_1,u=this.constraint.connectedBody;u?(a.multiply(s,i.worldRotation,s),a.invert(n,u.node.worldRotation),a.multiply(s,n,s),t.autoPivotB?(r.multiply(e,t.node.worldScale,t.pivotA),r.transformQuat(e,e,i.worldRotation),r.add(e,e,t.node.worldPosition),r.subtract(e,e,u.node.worldPosition),r.transformQuat(e,e,n)):r.multiply(e,u.node.worldScale,t.pivotB)):(r.multiply(e,i.worldScale,t.pivotA),r.transformQuat(e,e,i.worldRotation),r.add(e,e,i.worldPosition),a.multiply(s,i.worldRotation,s)),z(S.Transform_getOrigin(_),e),J(h,s),S.Transform_setRotation(_,h),S.Generic6DofSpring2Constraint_setFrames(this._impl,o,_)},s.updateScale0=function(){this.updateFrames()},s.updateScale1=function(){this.updateFrames()},o(i,[{key:"constraint",get:function(){return this._com}}]),i}(bt),Dt=new r(0,0,0),Rt=new r(0,0,0);new r(0,0,0);var It=function(){function t(){this.wrappedWorld=void 0,this._isEnabled=!1,this._impl=null,this._comp=null,this._btCollisionFlags=0,this._word3=0,this._dirty=!1,this._collisionFilterGroup=v.DEFAULT,this._collisionFilterMask=-1,this.wrappedWorld=e.instance.physicsWorld}var i=t.prototype;return i.onComponentSet=function(){},i.updateScale=function(){},i.initialize=function(t){this._comp=t;var i=this._comp.group,s=e.instance.collisionMatrix[i];return this._collisionFilterGroup=i,this._collisionFilterMask=s,this.onComponentSet(),null!=this._impl||(c("[Physics]: Initialize BulletCharacterController failed"),!1)},i.setWrapper=function(){x.setWrapper(this._impl,S.CCT_CACHE_NAME,this)},i.onEnable=function(){this._isEnabled=!0,this._impl||this.onComponentSet(),this.setDetectCollisions(!1),this.setOverlapRecovery(!0),e.instance.physicsWorld.addCCT(this),this.setWrapper()},i.onDisable=function(){this._isEnabled=!1,this.wrappedWorld.removeCCT(this),this.onDestroy()},i.onDestroy=function(){S._safe_delete(this._impl,C.EBulletTypeCharacterController),x.delWrapper(this._impl,S.CCT_CACHE_NAME),this._impl=null},i.onLoad=function(){},i.getPosition=function(t){this._impl&&Y(t,S.CharacterController_getPosition(this.impl))},i.setPosition=function(t){this._impl&&(z(S.CharacterController_getPosition(this.impl),t),this.syncPhysicsToScene())},i.setContactOffset=function(t){this._impl&&S.CharacterController_setContactOffset(this._impl,t)},i.setStepOffset=function(t){this._impl&&S.CharacterController_setStepOffset(this._impl,t)},i.setSlopeLimit=function(t){this._impl&&S.CharacterController_setSlopeLimit(this._impl,g(t))},i.setDetectCollisions=function(t){this._impl&&S.CharacterController_setCollision(this.impl,t)},i.setOverlapRecovery=function(t){this._impl&&S.CharacterController_setOverlapRecovery(this.impl,t)},i.onGround=function(){return(4&this._btCollisionFlags)>0},i.syncSceneToPhysics=function(){var t=this.characterController.node;t.hasChangedFlags&&(t.hasChangedFlags&B.SCALE&&this.syncScale(),t.hasChangedFlags&B.POSITION&&(r.add(Dt,t.worldPosition,this.scaledCenter),this.setPosition(Dt)))},i.syncPhysicsToScene=function(){this.getPosition(Dt),Dt.subtract(this.scaledCenter),this._comp.node.setWorldPosition(Dt)},i.syncScale=function(){this.updateScale()},i.move=function(t,i,e){if(this._isEnabled){var s=x.instance.BT_V3_0;S.Vec3_set(s,t.x,t.y,t.z),this._btCollisionFlags=S.CharacterController_move(this.impl,s,i,e)}},i.setGroup=function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this._dirty=!0)},i.getGroup=function(){return this._collisionFilterGroup},i.addGroup=function(t){this._collisionFilterGroup|=t,this._dirty=!0},i.removeGroup=function(t){this._collisionFilterGroup&=~t,this._dirty=!0},i.setMask=function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this._dirty=!0)},i.getMask=function(){return this._collisionFilterMask},i.addMask=function(t){this._collisionFilterMask|=t,this._dirty=!0},i.removeMask=function(t){this._collisionFilterMask&=~t,this._dirty=!0},i.updateEventListener=function(){this.wrappedWorld.updateNeedEmitCCTEvents(this.characterController.needCollisionEvent)},i.updateDirty=function(){this._dirty&&(e.instance.physicsWorld.removeCCT(this),e.instance.physicsWorld.addCCT(this),this._dirty=!1)},i.onShapeHitExt=function(t){var i=S.ControllerShapeHit_getHitShape(t),s=e.instance.physicsWorld;s.cctShapeEventDic.get(this.impl,i);var n=new r;Y(n,S.ControllerHit_getHitWorldPos(t));var o=new r;Y(o,S.ControllerHit_getHitWorldNormal(t));var a=new r;Y(a,S.ControllerHit_getHitMotionDir(t));var l=S.ControllerHit_getHitMotionLength(t),h=x.getWrapper(i,rt.TYPE);h&&s.cctShapeEventDic.set(this.impl,i,{BulletCharacterController:this,BulletShape:h,worldPos:n,worldNormal:o,motionDir:a,motionLength:l})},o(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"impl",get:function(){return this._impl}},{key:"characterController",get:function(){return this._comp}},{key:"scaledCenter",get:function(){return r.multiply(Rt,this._comp.center,this._comp.node.worldScale),Rt}}]),t}(),Ft=new r(0,0,0),xt=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var s=i.prototype;return s.onComponentSet=function(){this.component.node.getWorldPosition(Ft),Ft.add(this.scaledCenter);var t=x.instance.BT_V3_0;S.Vec3_set(t,Ft.x,Ft.y,Ft.z);var i=r.UNIT_Y,s=x.instance.BT_V3_1;S.Vec3_set(s,i.x,i.y,i.z);var n=S.ControllerHitReport_new(),o=e.instance.physicsWorld,a=S.CapsuleCharacterControllerDesc_new(g(this.component.slopeLimit),this.component.stepOffset,this.component.skinWidth,s,t,n,this.component.radius,this.component.height);this._impl=S.CapsuleCharacterController_new(o.impl,a,0),this.updateScale()},s.setRadius=function(){this.updateScale()},s.setHeight=function(){this.updateScale()},s.updateScale=function(){this.updateGeometry()},s.updateGeometry=function(){var t=this.component.node.worldScale,i=this.component.radius*_(t.x,t.z),e=this.component.height*Math.abs(t.y);S.CapsuleCharacterController_setRadius(this.impl,i),S.CapsuleCharacterController_setHeight(this.impl,e),this._dirty=!0},o(i,[{key:"component",get:function(){return this._comp}}]),i}(It),Gt=new r(0,0,0),Pt=function(t){function i(){return t.apply(this,arguments)||this}d(i,t);var s=i.prototype;return s.onComponentSet=function(){this.component.node.getWorldPosition(Gt),Gt.add(this.scaledCenter);var t=x.instance.BT_V3_0;S.Vec3_set(t,Gt.x,Gt.y,Gt.z);var i=r.UNIT_Y,s=x.instance.BT_V3_1;S.Vec3_set(s,i.x,i.y,i.z);var n=S.ControllerHitReport_new(),o=e.instance.physicsWorld,a=S.BoxCharacterControllerDesc_new(g(this.component.slopeLimit),this.component.stepOffset,this.component.skinWidth,s,t,n,this.component.halfHeight,this.component.halfSideExtent,this.component.halfForwardExtent);this._impl=S.BoxCharacterController_new(o.impl,a,0),this.updateScale()},s.setHalfHeight=function(){this.updateScale()},s.setHalfSideExtent=function(){this.updateScale()},s.setHalfForwardExtent=function(){this.updateScale()},s.updateScale=function(){this.updateGeometry()},s.updateGeometry=function(){var t=this.component.node.worldScale;S.BoxCharacterController_setHalfSideExtent(this.impl,this.component.halfSideExtent*t.x),S.BoxCharacterController_setHalfHeight(this.impl,this.component.halfHeight*t.y),S.BoxCharacterController_setHalfForwardExtent(this.impl,this.component.halfForwardExtent*t.z),this._dirty=!0},o(i,[{key:"component",get:function(){return this._comp}}]),i}(It);t.once(i.EVENT_PRE_SUBSYSTEM_INIT,(function(){n.register("bullet",{PhysicsWorld:pt,RigidBody:$,BoxShape:_t,SphereShape:ut,CapsuleShape:ft,TrimeshShape:St,CylinderShape:Ct,ConeShape:Tt,TerrainShape:Bt,SimplexShape:vt,PlaneShape:wt,PointToPointConstraint:Et,HingeConstraint:At,FixedConstraint:Mt,ConfigurableConstraint:Ot,BoxCharacterController:Pt,CapsuleCharacterController:xt})}))}}}));
