System.register(["./deprecated-51f2c4c2.js","./index-68ccac70.js","./animation-component-a7d670b3.js","./find-222dc7da.js","./skeleton-99c82a69.js","./node-event-40319828.js","./buffer-barrier-d1733967.js","./mesh-renderer-c40c4f87.js","./mesh-97b1b18c.js","./pipeline-state-manager-8f16c5a7.js","./director-56fe9b8d.js","./touch-685512cb.js","./deprecated-0752a51c.js","./model-renderer-8b84c274.js","./renderer-7bc9d919.js","./deprecated-37e42d8f.js"],(function(t){"use strict";var e,n,i,o,s,a,r,c,u,h,l,d,f,p,m,k,_,v,S,y,A,g,B,b;return{setters:[function(a){e=a.J,n=a.i,i=a.h,o=a.S,s=a.f,t("SkelAnimDataHub",a.h)},function(t){a=t.l,r=t.t,c=t.bA,u=t.o,h=t.Q,l=t.bD,d=t.bF,f=t.bE,p=t.cq,m=t.i,k=t.bu,_=t.bx,v=t.b$,S=t.bg,y=t.ct},function(t){A=t.A,g=t.y,B=t.s},function(t){b=t.N},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){}],execute:function(){var j=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new e(t),this.jointAnimationInfo=new n(t)}var i=t.prototype;return i.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},i.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},i.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();a.internal.DataPoolManager=j;var C,I,w,P,x,T,D,M,E,O,U,R,N,L,q,z=new r,F=new r,H=t("SkeletalAnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this,e,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._parent=null,i._curvesInited=!1,i._animInfoMgr=a.director.root.dataPoolManager.jointAnimationInfo,i}c(e,t);var n=e.prototype;return n.initialize=function(e){if(!this._curveLoaded){this._parent=e.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,t.prototype.initialize.call(this,e),this._curvesInited=!n;var o=i.getOrExtract(this.clip),s=o.frames,a=o.samples;this._frames=s-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/a,this.setUseBaked(n)}},n.onPlay=function(){var e=this;t.prototype.onPlay.call(this),this._parent.useBakedAnimation&&(this._animInfoMgr.switchClip(this._animInfo,this.clip),this._parent.getUsers().forEach((function(t){t.uploadAnimation(e.clip)})))},n.setUseBaked=function(e){e?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var e=this._targetNode,n=0;n<t.length;++n){var o=t[n],s=e.getChildByPath(o.path);if(o.target){for(var a=i.getOrExtract(this.clip),c=o.path,l=a.joints[c],d=s,f=void 0;!l;){var p=c.lastIndexOf("/");if(c=c.substring(0,p),l=a.joints[c],d&&(f||(f=r.identity(F)),r.fromRTS(z,d.rotation,d.position,d.scale),r.multiply(f,z,f),d=d.parent),p<0)break}for(var m=l&&l.transforms,k=a.frames,_=[],v=0;v<k;v++){var S;S=m&&f?r.multiply(z,m[v],f):m?m[v]:f||new r;var y={pos:new u,rot:new h,scale:new u};r.toRTS(S,y.rot,y.pos,y.scale),_.push(y)}this._sockets.push({target:o.target,frames:_})}}},n._sampleCurvesBaked=function(t){var e=t/this.duration,n=this._animInfo,i=this.clip;n.currentClip!==i&&(this._animInfoMgr.switchClip(this._animInfo,i),this._parent.getUsers().forEach((function(t){t.uploadAnimation(i)})),n.data[0]=-1);var o=e*this._frames+.5|0;if(o!==n.data[0]){n.data[0]=o,n.dirty=!0;for(var s=0;s<this._sockets.length;++s){var a=this._sockets[s],r=a.target,c=a.frames[o],u=c.pos,h=c.rot,l=c.scale;r.setRTS(h,u,l)}}},e}(A)),J=t("Socket",(C=l("cc.SkeletalAnimation.Socket"),I=d(b),C((P=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),this.path=x&&x(),this.target=T&&T(),this.path=t,this.target=e},x=f(P.prototype,"path",[S],(function(){return""})),T=f(P.prototype,"target",[I],(function(){return null})),w=P))||w));p(J,"cc.SkeletalAnimationComponent.Socket");var Q=new r,W=new r;function $(t,e,n){void 0===e&&(e=""),void 0===n&&(n=[]);for(var i=0;i<t.children.length;i++){var o=t.children[i];if(o){var s=e?e+"/"+o.name:o.name;n.push(s),$(o,s,n)}}return n}var G=(D=l("cc.SkeletalAnimation"),M=y(99),E=d([J]),O=d([J]),D(U=M(((q=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];return(e=t.call.apply(t,[this].concat(i))||this)._useBakedAnimation=N&&N(),e._sockets=L&&L(),e._users=new Set,e._currentBakedState=null,e}c(e,t);var n=e.prototype;return n.onLoad=function(){t.prototype.onLoad.call(this);for(var e=this.node.getComponentsInChildren(o),n=0;n<e.length;++n){var i=e[n];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}},n.onDestroy=function(){t.prototype.onDestroy.call(this),a.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),g().removeSockets(this.node,this._sockets),this._removeAllUsers()},n.onEnable=function(){var e;t.prototype.onEnable.call(this),null===(e=this._currentBakedState)||void 0===e||e.resume()},n.onDisable=function(){var e;t.prototype.onDisable.call(this),null===(e=this._currentBakedState)||void 0===e||e.pause()},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,t.prototype.start.call(this)},n.pause=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.pause():t.prototype.pause.call(this)},n.resume=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.resume():t.prototype.resume.call(this)},n.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):t.prototype.stop.call(this)},n.querySockets=function(){var t=this._defaultClip&&Object.keys(i.getOrExtract(this._defaultClip).joints).sort().reduce((function(t,e){return e.startsWith(t[t.length-1]+"/")||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],n=0;n<t.length;n++){var o=t[n],s=this.node.getChildByPath(o);s&&(e.push(o),$(s,o,e))}return e},n.rebuildSocketAnimations=function(){for(var t,e=m(this._sockets);!(t=e()).done;){var n=t.value,i=this.node.getChildByPath(n.path),o=n.target;i&&o&&(o.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",o.parent=this.node,s(i,this.node,Q),r.fromRTS(W,o.rotation,o.position,o.scale),r.equals(W,Q)||(o.matrix=Q))}for(var a=0,c=Object.keys(this._nameToState);a<c.length;a++){var u=c[a];this._nameToState[u].rebuildSocketCurves(this._sockets)}},n.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var n=new b;return n.parent=this.node,this._sockets.push(new J(t,n)),this.rebuildSocketAnimations(),n},n.notifySkinnedMeshAdded=function(t){var e=this._useBakedAnimation,n=t.associatedAnimation;if(n&&n._users.delete(t),t.associatedAnimation=this,t.setUseBakedAnimation(e,!0),e){var i=this._currentBakedState;i&&t.uploadAnimation(i.clip)}this._users.add(t)},n.notifySkinnedMeshRemoved=function(t){k(t.associatedAnimation===this||null===t.associatedAnimation),t.setUseBakedAnimation(!1),t.associatedAnimation=null,this._users.delete(t)},n.getUsers=function(){return this._users},n._createState=function(t,e){return new H(t,e)},n._doCreateState=function(e,n){var i=t.prototype._doCreateState.call(this,e,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(e,n){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var i=e;this._currentBakedState=i,i.play()}else t.prototype.doPlayOrCrossFade.call(this,e,n)},n._removeAllUsers=function(){var t=this;Array.from(this._users).forEach((function(e){t.notifySkinnedMeshRemoved(e)}))},_(e,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedAnimation){var e=g();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){for(var e in this._useBakedAnimation=t,this._nameToState)this._nameToState[e].setUseBaked(t);this._users.forEach((function(e){e.setUseBakedAnimation(t)})),this._useBakedAnimation?g().removeSockets(this.node,this._sockets):(g().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),e}(B)).Socket=J,v((R=q).prototype,"sockets",[E],Object.getOwnPropertyDescriptor(R.prototype,"sockets"),R.prototype),N=f(R.prototype,"_useBakedAnimation",[S],(function(){return!0})),L=f(R.prototype,"_sockets",[O],(function(){return[]})),U=R))||U)||U);t({SkeletalAnimation:G,SkeletalAnimationComponent:G}),a.SkeletalAnimationComponent=G,p(G,"cc.SkeletalAnimationComponent")}}}));
