System.register(["./index-68ccac70.js","./director-56fe9b8d.js","./find-222dc7da.js","./pipeline-state-manager-8f16c5a7.js","./buffer-barrier-d1733967.js"],(function(e){"use strict";var a,r,d,i,t,n,o,s,c,h,w,l,u,g,R,f,T,S,p,E,m,v,A,N,D,C,L,P,O,_,I;return{setters:[function(e){a=e.i},function(e){r=e.ad,d=e.ae,i=e.af,t=e.ag,n=e.ah,o=e.ai,s=e.aj,c=e.ak,h=e.al,w=e.am,l=e.an,u=e.ao,g=e.ap,R=e.aq,f=e.ar,T=e.L,S=e.f,p=e.as},function(e){E=e.ag,m=e.ad,v=e.b},function(e){A=e.s},function(e){N=e.T,D=e.b,C=e.L,L=e.t,P=e.a4,O=e.a5,_=e.J,I=e.F}],execute:function(){function M(e){for(var a=e.scene.batches,r=0;a&&r<a.length;r++){var d=a[r];if(e.visibility&d.visFlags)return!0}return!1}e({g:function(e){switch(e){case N.BOOL:case N.INT:case N.UINT:case N.FLOAT:return 1;case N.INT2:case N.FLOAT2:case N.UINT2:case N.BOOL2:return 2;case N.FLOAT3:case N.BOOL3:case N.UINT3:case N.INT3:return 3;case N.BOOL4:case N.FLOAT4:case N.UINT4:case N.INT4:case N.MAT2:return 4;case N.MAT2X3:case N.MAT3X2:return 6;case N.MAT2X4:case N.MAT4X2:return 8;case N.MAT3:return 9;case N.MAT3X4:case N.MAT4X3:return 12;case N.MAT4:return 16;default:return 0}},i:M});var F=function(e,a,r,d,i){this.camera=void 0,this.id=4294967295,this.windowID=4294967295,this.width=0,this.height=0,this.camera=e,this.id=a,this.windowID=r,this.width=d,this.height=i},B=new Map,G=new Map;function x(e){var a=G.get(e.window);return void 0===a&&(a=G.size,G.set(e.window,a)),a}function U(e,a,r,d){var i=B.get(a);if(void 0!==i)return a.window.width,a.window.height,x(a),d(e,i),i;var t=x(a);return r(e,i=new F(a,B.size,t,a.window.width?a.window.width:1,a.window.height?a.window.height:1)),B.set(a,i),i}function y(e,a,r,d){var i=r,n=d,o=a,s=e.device;if(!e.containsResource(o)){var c=A(s)?D.R32F:D.RGBA8;e.addRenderTarget(o,c,i,n,t.MANAGED),e.addDepthStencil(o+"Depth",D.DEPTH_STENCIL,i,n,t.MANAGED)}e.updateRenderTarget(o,i,n),e.updateDepthStencil(o+"Depth",i,n)}var b=new r;function Q(e,a){var r=a.camera;f(e,r);var d=e,i=d.pipelineSceneData.shadows,t=e.pipelineSceneData.validPunctualLights,n=e.pipelineSceneData.shadows;if(b.reset(),!i.enabled||i.type!==v.ShadowMap)return b;b.shadowEnabled=!0;for(var o=b.validLights,s=0,c=0;s<i.maxReceived&&c<t.length;){var h=t[c];h.type===T.SPOT&&h.shadowEnabled&&(o.push(h),s++),c++}var w=r.scene.mainLight,l=n.size.x,u=n.size.y;if(w&&w.shadowEnabled)if(b.mainLightShadowNames[0]="MainLightShadow"+a.id,w.shadowFixedArea)y(e,b.mainLightShadowNames[0],l,u);else{var g=d.pipelineSceneData.csmSupported?w.csmLevel:1;b.mainLightShadowNames[0]="MainLightShadow"+a.id;for(var R=0;R<g;R++)y(e,b.mainLightShadowNames[0],l,u)}for(var S=0;S<o.length;S++){o[S];var p="SpotLightShadow"+S.toString()+a.id;b.spotLightShadowNames[S]=p,y(e,b.spotLightShadowNames[S],l,u)}return b}var H,z=Q;function W(e,a,r,i,t,c,h){var w=c,l=h,u=d(r,c,h,i,t);c=u.width,h=u.height;var g=e;t||((H=a.addRenderPass(c,h,"default")).name=e,H.setViewport(new P(0,0,w,l)),H.addRenderTarget(g,C.CLEAR,L.STORE,new O(1,1,1,r.clearColor.w)),H.addDepthStencil(g+"Depth",C.CLEAR,L.DISCARD,r.clearDepth,r.clearStencil,_.DEPTH_STENCIL));var R=H.addQueue(n.RENDER_OPAQUE,"shadow-caster");R.addSceneOfCamera(r,new o(i,t),s.SHADOW_CASTER),R.setViewport(new P(u.x,u.y,u.width,u.height))}function J(e,a){if(b.shadowEnabled){var r=a.camera,d=e.pipelineSceneData.shadows,i=d.size.x,t=d.size.y,n=r.scene.mainLight;if(n&&n.shadowEnabled)if(b.mainLightShadowNames[0]="MainLightShadow"+a.id,n.shadowFixedArea)W(b.mainLightShadowNames[0],e,r,n,0,i,t);else{var o=e.pipelineSceneData.csmSupported?n.csmLevel:1;b.mainLightShadowNames[0]="MainLightShadow"+a.id;for(var s=0;s<o;s++)W(b.mainLightShadowNames[0],e,r,n,s,i,t)}for(var c=0;c<b.validLights.length;c++){var h=b.validLights[c],w="SpotLightShadow"+c.toString()+a.id;b.spotLightShadowNames[c]=w,W(w,e,r,h,0,i,t)}}}function V(e,r,i){var t=d(r.camera,r.camera.window.width,r.camera.window.height),c=t.width,h=t.height,w=e.addRenderPass(c,h,"default"),l=r.camera;w.addRenderTarget(i,C.LOAD,L.STORE),w.addDepthStencil(k.ds,C.LOAD,L.DISCARD);for(var u,g=a(b.mainLightShadowNames);!(u=g()).done;){var R=u.value;e.containsResource(R)&&w.addTexture(R,"cc_shadowMap")}for(var f,T=a(b.spotLightShadowNames);!(f=T()).done;){var S=f.value;e.containsResource(S)&&w.addTexture(S,"cc_spotShadowMap")}w.addQueue(n.RENDER_OPAQUE,"deferred-forward").addSceneOfCamera(l,new o,s.OPAQUE_OBJECT|s.PLANAR_SHADOW|s.CUTOUT_OBJECT|s.DEFAULT_LIGHTING|s.DRAW_INSTANCING),w.addQueue(n.RENDER_TRANSPARENT,"deferred-forward").addSceneOfCamera(l,new o,s.TRANSPARENT_OBJECT|s.GEOMETRY)}function j(e,r,i,t){void 0===i&&(i=!1),void 0===t&&(t=!0),J(e,r);var w=r.id,l=d(r.camera,r.camera.window.width,r.camera.window.height),u=l.width,g=l.height,R=e.addRenderPass(u,g,"default");R.name="ForwardPass"+w,R.setViewport(new P(l.x,l.y,u,g));for(var f,T=a(b.mainLightShadowNames);!(f=T()).done;){var S=f.value;e.containsResource(S)&&R.addTexture(S,"cc_shadowMap")}for(var p,E=a(b.spotLightShadowNames);!(p=E()).done;){var m=p.value;e.containsResource(m)&&R.addTexture(m,"cc_spotShadowMap")}var v=r.camera;R.addRenderTarget("ForwardColor"+r.id,i?C.CLEAR:c(v.clearFlag,h.RENDER_TARGET),L.STORE,new O(v.clearColor.x,v.clearColor.y,v.clearColor.z,v.clearColor.w)),R.addDepthStencil("ForwardDepthStencil"+r.id,i?C.CLEAR:c(v.clearFlag,h.DEPTH_STENCIL),i?L.DISCARD:L.STORE,v.clearDepth,v.clearStencil,v.clearFlag),R.addQueue(n.RENDER_OPAQUE).addSceneOfCamera(v,new o,s.OPAQUE_OBJECT|s.PLANAR_SHADOW|s.CUTOUT_OBJECT|s.DEFAULT_LIGHTING|s.DRAW_INSTANCING);var A=s.TRANSPARENT_OBJECT|s.GEOMETRY;return i||(A|=s.UI,R.showStatistics=!0),t&&R.addQueue(n.RENDER_TRANSPARENT).addSceneOfCamera(v,new o,A),{rtName:"ForwardColor"+r.id,dsName:"ForwardDepthStencil"+r.id}}var X,Y,k=new w;function q(e,a){var r=a.camera,i=d(r,r.window.width,r.window.height),t=i.width,c=i.height,h=k.color,w=k.normal,l=k.emissive,u=k.ds,g=e.addRenderPass(t,c,"gbuffer");g.name="CameraGBufferPass"+a.id,g.setViewport(new P(i.x,i.y,t,c));var R=new O(0,0,0,0);return r.clearFlag&_.COLOR&&(e.pipelineSceneData.isHDR?E(R,r.clearColor):(R.x=r.clearColor.x,R.y=r.clearColor.y,R.z=r.clearColor.z)),g.addRenderTarget(h,C.CLEAR,L.STORE,R),g.addRenderTarget(l,C.CLEAR,L.STORE,new O(0,0,0,0)),g.addRenderTarget(w,C.CLEAR,L.STORE,new O(0,0,0,0)),g.addDepthStencil(u,C.CLEAR,L.STORE,r.clearDepth,r.clearStencil,r.clearFlag),g.addQueue(n.RENDER_OPAQUE,"gbuffer").addSceneOfCamera(r,new o,s.OPAQUE_OBJECT|s.CUTOUT_OBJECT),g}function K(e,r,i){J(e,r),X||(X=new l(i));var t=e,o=r.camera,c=d(o,o.window.width,o.window.height),h=c.width,w=c.height,R=u(o),f="deferredLightingPassRTName"+r.id,T=t.addRenderPass(h,w,"deferred-lighting");T.name="CameraLightingPass"+r.id,T.setViewport(new P(c.x,c.y,h,w));for(var S,p=a(b.mainLightShadowNames);!(S=p()).done;){var E=S.value;t.containsResource(E)&&T.addTexture(E,"cc_shadowMap")}for(var m,v=a(b.spotLightShadowNames);!(m=v()).done;){var A=m.value;t.containsResource(A)&&T.addTexture(A,"cc_spotShadowMap")}t.containsResource(k.color)&&(T.addTexture(k.color,"albedoMap"),T.addTexture(k.normal,"normalMap"),T.addTexture(k.emissive,"emissiveMap"),T.addTexture(k.ds,"depthStencil"));var N="clusterLightBuffer"+R,D="clusterLightIndicesBuffer"+R,I="clusterLightGridBuffer"+R;t.containsResource(N)&&(T.addStorageBuffer(N,g.READ,"b_ccLightsBuffer"),T.addStorageBuffer(D,g.READ,"b_clusterLightIndicesBuffer"),T.addStorageBuffer(I,g.READ,"b_clusterLightGridBuffer"));var M=new O(0,0,0,0);return o.clearFlag&_.COLOR&&(M.x=o.clearColor.x,M.y=o.clearColor.y,M.z=o.clearColor.z),M.w=0,T.addRenderTarget(f,C.CLEAR,L.STORE,M),T.addQueue(n.RENDER_TRANSPARENT).addCameraQuad(o,X.deferredLightingMaterial,0,s.VOLUMETRIC_LIGHTING),{rtName:f}}function Z(e,a,r){Y||(Y=new R);var i=a.id,t=a.camera,o=d(t,t.window.width,t.window.height),w=o.width,l=o.height,u="postprocessPassRTName"+i,g="postprocessPassDS"+i,f=e.addRenderPass(w,l,"post-process");f.name="CameraPostprocessPass"+i,f.setViewport(new P(o.x,o.y,o.width,o.height)),e.containsResource(r)&&f.addTexture(r,"outputResultMap");var T=new O(0,0,0,t.clearColor.w);return t.clearFlag&_.COLOR&&(T.x=t.clearColor.x,T.y=t.clearColor.y,T.z=t.clearColor.z),f.addRenderTarget(u,c(t.clearFlag,h.RENDER_TARGET),L.STORE,T),f.addDepthStencil(g,c(t.clearFlag,h.DEPTH_STENCIL),L.STORE,t.clearDepth,t.clearStencil,t.clearFlag),f.addQueue(n.NONE).addCameraQuad(t,Y.postMaterial,0,s.NONE),m()===t&&(f.showStatistics=!0),{rtName:u,dsName:g}}function $(e,a){var r=a.camera,i=d(r,r.window.width,r.window.height),t=i.width,w=i.height,l="dsUIAndProfilerPassColor"+a.id,u="dsUIAndProfilerPassDS"+a.id,g=e.addRenderPass(t,w,"default");g.name="CameraUIAndProfilerPass"+a.id,g.setViewport(new P(i.x,i.y,t,w)),g.addRenderTarget(l,c(r.clearFlag,h.RENDER_TARGET),L.STORE,new O(r.clearColor.x,r.clearColor.y,r.clearColor.z,r.clearColor.w)),g.addDepthStencil(u,c(r.clearFlag,h.DEPTH_STENCIL),L.STORE,r.clearDepth,r.clearStencil,r.clearFlag);var R=s.UI;g.addQueue(n.RENDER_TRANSPARENT).addSceneOfCamera(r,new o,R),m()===r&&(g.showStatistics=!0)}new O(0,0,0,0),e("F",function(){function e(){}var a=e.prototype;return a.setup=function(e,a){for(var r=0;r<e.length;r++){var d=e[r];null!==d.scene&&(a.update(d),j(a,U(a,d,this.initResource,this.updateResource)))}},a.initResource=function(e,a){!function(e,a,r){void 0===r&&(r=!1);var n=a.camera,o=d(n,n.window.width,n.window.height),s=o.width,c=o.height;Q(e,a),r?e.addRenderTarget("ForwardColor"+a.id,i(e),s,c,t.PERSISTENT):e.addRenderWindow("ForwardColor"+a.id,D.BGRA8,s,c,a.camera.window),e.addDepthStencil("ForwardDepthStencil"+a.id,D.DEPTH_STENCIL,s,c)}(e,a)},a.updateResource=function(e,a){!function(e,a,r){void 0===r&&(r=!1);var i=a.camera,t=d(i,i.window.width,i.window.height),n=t.width,o=t.height;z(e,a),r?e.updateRenderTarget("ForwardColor"+a.id,n,o):e.updateRenderWindow("ForwardColor"+a.id,a.camera.window),e.updateDepthStencil("ForwardDepthStencil"+a.id,n,o)}(e,a)},e}()),e("D",function(){function e(){}var a=e.prototype;return a.setup=function(e,a){for(var r=0;r<e.length;++r){var d=e[r];if(d.scene){a.update(d);var i=a.device.hasFeature(I.COMPUTE_SHADER),t=d.cameraUsage===S.GAME||d.cameraUsage===S.GAME_VIEW,n=U(a,d,this.initResource,this.updateResource);if(t)if(M(d))$(a,n);else{i&&p(d,a),q(a,n);var o=K(a,n,i);V(a,n,o.rtName),Z(a,n,o.rtName)}else j(a,n)}}},a.initResource=function(e,a){M(a.camera)?function(e,a){var r=a.camera,i=d(r,r.window.width,r.window.height),n=i.width,o=i.height,s="dsUIAndProfilerPassColor"+a.id,c="dsUIAndProfilerPassDS"+a.id;e.addRenderWindow(s,D.BGRA8,n,o,r.window),e.addDepthStencil(c,D.DEPTH_STENCIL,n,o,t.MANAGED)}(e,a):(function(e,a){var r=a.camera,i=d(r,r.window.width,r.window.height),n=i.width,o=i.height,s="gBufferPassColorCamera"+a.id,c="gBufferPassNormal"+a.id,h="gBufferPassEmissive"+a.id,w="gBufferPassDSCamera"+a.id,l=D.RGBA16F;e.addRenderTarget(s,l,n,o,t.MANAGED),e.addRenderTarget(h,l,n,o,t.MANAGED),e.addRenderTarget(c,l,n,o,t.MANAGED),e.addDepthStencil(w,D.DEPTH_STENCIL,n,o,t.MANAGED),k.color=s,k.normal=c,k.emissive=h,k.ds=w}(e,a),function(e,a){Q(e,a);var r=a.camera,i=d(r,r.window.width,r.window.height),n=i.width,o=i.height,s="deferredLightingPassRTName"+a.id;e.addRenderTarget(s,D.RGBA8,n,o,t.MANAGED)}(e,a),function(e,a){var r=a.id,i=a.camera,n=d(i,i.window.width,i.window.height),o=n.width,s=n.height,c="postprocessPassRTName"+r,h="postprocessPassDS"+r;e.addRenderWindow(c,D.BGRA8,o,s,i.window),e.addDepthStencil(h,D.DEPTH_STENCIL,o,s,t.MANAGED)}(e,a))},a.updateResource=function(e,a){M(a.camera)?function(e,a){var r=a.camera,i=d(r,r.window.width,r.window.height),t=i.width,n=i.height,o="dsUIAndProfilerPassColor"+a.id,s="dsUIAndProfilerPassDS"+a.id;e.updateRenderWindow(o,r.window),e.updateDepthStencil(s,t,n)}(e,a):(function(e,a){var r=a.camera,i=d(r,r.window.width,r.window.height),t=i.width,n=i.height,o="gBufferPassColorCamera"+a.id,s="gBufferPassNormal"+a.id,c="gBufferPassEmissive"+a.id,h="gBufferPassDSCamera"+a.id;e.updateRenderTarget(o,t,n),e.updateRenderTarget(c,t,n),e.updateRenderTarget(s,t,n),e.updateDepthStencil(h,t,n)}(e,a),function(e,a){z(e,a);var r=a.camera,i=d(r,r.window.width,r.window.height),t=i.width,n=i.height,o="deferredLightingPassRTName"+a.id;e.updateRenderTarget(o,t,n)}(e,a),function(e,a){var r=a.id,i=a.camera,t=d(i,i.window.width,i.window.height),n=t.width,o=t.height,s="postprocessPassRTName"+r,c="postprocessPassDS"+r;e.updateRenderWindow(s,i.window),e.updateDepthStencil(c,n,o)}(e,a))},e}())}}}));
