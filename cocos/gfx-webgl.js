System.register(["./index-68ccac70.js","./buffer-barrier-d1733967.js"],(function(e){"use strict";var t,r,s,a,i,n,u,l,_,o,f,c,h,E,g,T,d,R,S,A,p,m,B,C,x,b,P,F,v,y,O,G,I,L,M,D,w,N,U,k,X,H,V,W,z,K,Y,j,q,Z,Q,J,$,ee,te,re,se,ae,ie,ne,ue,le,_e,oe,fe,ce,he,Ee,ge,Te,de,Re,Se,Ae,pe,me,Be,Ce,xe,be,Pe,Fe,ve;return{setters:[function(e){t=e.bA,r=e.bx,s=e.f,a=e.g,i=e.aG,n=e.l,u=e.C,l=e.a0,_=e.d,o=e.w,f=e.bG,c=e.bH,h=e.cl,E=e.aN,g=e.cf,T=e.i},function(e){d=e.aR,R=e.aS,S=e.D,A=e.Z,p=e.J,m=e.aN,B=e.ab,C=e.l,x=e.f,b=e.d,P=e.g,F=e.aQ,v=e.aW,y=e.b,O=e.L,G=e.r,I=e.y,L=e.z,M=e.i,D=e.aZ,w=e.a_,N=e.a$,U=e.aj,k=e.T,X=e._,H=e.Y,V=e.s,W=e.ai,z=e.ah,K=e.aC,Y=e.G,j=e.ba,q=e.aq,Z=e.B,Q=e.E,J=e.I,$=e.C,ee=e.b3,te=e.b4,re=e.aT,se=e.b5,ae=e.b6,ie=e.bc,ne=e.bd,ue=e.be,le=e.bf,_e=e.bg,oe=e.a4,fe=e.b9,ce=e.b7,he=e.aV,Ee=e.aX,ge=e.ae,Te=e.h,de=e.bh,Re=e.a3,Se=e.b2,Ae=e.A,pe=e.b0,me=e.aI,Be=e.Q,Ce=e.aH,xe=e.F,be=e.j,Pe=e.bi,Fe=e.bj,ve=e.bm}],execute:function(){var ye,Oe=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSet=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,r=t.bindings,s=t.descriptorIndices,a=t.descriptorCount;this._buffers=Array(a).fill(null),this._textures=Array(a).fill(null),this._samplers=Array(a).fill(null);var i=[];this._gpuDescriptorSet={gpuDescriptors:i,descriptorIndices:s};for(var n=0;n<r.length;++n)for(var u=r[n],l=0;l<u.count;l++)i.push({type:u.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},a.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},a.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&d){var r=this._buffers[t];r&&(e[t].gpuBuffer=r.gpuBuffer||r.gpuBufferView)}else e[t].type&R&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},r(s,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),s}(S);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(ye||(ye={}));var Ge=function(){function e(){}return e.setInstance=function(t){e._instance=t},r(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function Ie(e,t){switch(e){case y.R8:return t.UNSIGNED_BYTE;case y.R8SN:return t.BYTE;case y.R8UI:return t.UNSIGNED_BYTE;case y.R8I:return t.BYTE;case y.R16F:return ye.HALF_FLOAT_OES;case y.R16UI:return t.UNSIGNED_SHORT;case y.R16I:return t.SHORT;case y.R32F:return t.FLOAT;case y.R32UI:return t.UNSIGNED_INT;case y.R32I:return t.INT;case y.RG8:return t.UNSIGNED_BYTE;case y.RG8SN:return t.BYTE;case y.RG8UI:return t.UNSIGNED_BYTE;case y.RG8I:return t.BYTE;case y.RG16F:return ye.HALF_FLOAT_OES;case y.RG16UI:return t.UNSIGNED_SHORT;case y.RG16I:return t.SHORT;case y.RG32F:return t.FLOAT;case y.RG32UI:return t.UNSIGNED_INT;case y.RG32I:return t.INT;case y.RGB8:case y.SRGB8:return t.UNSIGNED_BYTE;case y.RGB8SN:return t.BYTE;case y.RGB8UI:return t.UNSIGNED_BYTE;case y.RGB8I:return t.BYTE;case y.RGB16F:return ye.HALF_FLOAT_OES;case y.RGB16UI:return t.UNSIGNED_SHORT;case y.RGB16I:return t.SHORT;case y.RGB32F:return t.FLOAT;case y.RGB32UI:return t.UNSIGNED_INT;case y.RGB32I:return t.INT;case y.BGRA8:case y.RGBA8:case y.SRGB8_A8:return t.UNSIGNED_BYTE;case y.RGBA8SN:return t.BYTE;case y.RGBA8UI:return t.UNSIGNED_BYTE;case y.RGBA8I:return t.BYTE;case y.RGBA16F:return ye.HALF_FLOAT_OES;case y.RGBA16UI:return t.UNSIGNED_SHORT;case y.RGBA16I:return t.SHORT;case y.RGBA32F:return t.FLOAT;case y.RGBA32UI:return t.UNSIGNED_INT;case y.RGBA32I:return t.INT;case y.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case y.R11G11B10F:return t.FLOAT;case y.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case y.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case y.RGB10A2:return t.UNSIGNED_BYTE;case y.RGB10A2UI:return t.UNSIGNED_INT;case y.RGB9E5:return t.UNSIGNED_BYTE;case y.DEPTH:return t.UNSIGNED_INT;case y.DEPTH_STENCIL:return ye.UNSIGNED_INT_24_8_WEBGL;case y.BC1:case y.BC1_SRGB:case y.BC2:case y.BC2_SRGB:case y.BC3:case y.BC3_SRGB:case y.BC4:return t.UNSIGNED_BYTE;case y.BC4_SNORM:return t.BYTE;case y.BC5:return t.UNSIGNED_BYTE;case y.BC5_SNORM:return t.BYTE;case y.BC6H_SF16:case y.BC6H_UF16:return t.FLOAT;case y.BC7:case y.BC7_SRGB:case y.ETC_RGB8:case y.ETC2_RGB8:case y.ETC2_SRGB8:case y.ETC2_RGB8_A1:case y.ETC2_SRGB8_A1:case y.EAC_R11:return t.UNSIGNED_BYTE;case y.EAC_R11SN:return t.BYTE;case y.EAC_RG11:return t.UNSIGNED_BYTE;case y.EAC_RG11SN:return t.BYTE;case y.PVRTC_RGB2:case y.PVRTC_RGBA2:case y.PVRTC_RGB4:case y.PVRTC_RGBA4:case y.PVRTC2_2BPP:case y.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case y.ASTC_RGBA_4X4:case y.ASTC_RGBA_5X4:case y.ASTC_RGBA_5X5:case y.ASTC_RGBA_6X5:case y.ASTC_RGBA_6X6:case y.ASTC_RGBA_8X5:case y.ASTC_RGBA_8X6:case y.ASTC_RGBA_8X8:case y.ASTC_RGBA_10X5:case y.ASTC_RGBA_10X6:case y.ASTC_RGBA_10X8:case y.ASTC_RGBA_10X10:case y.ASTC_RGBA_12X10:case y.ASTC_RGBA_12X12:case y.ASTC_SRGBA_4X4:case y.ASTC_SRGBA_5X4:case y.ASTC_SRGBA_5X5:case y.ASTC_SRGBA_6X5:case y.ASTC_SRGBA_6X6:case y.ASTC_SRGBA_8X5:case y.ASTC_SRGBA_8X6:case y.ASTC_SRGBA_8X8:case y.ASTC_SRGBA_10X5:case y.ASTC_SRGBA_10X6:case y.ASTC_SRGBA_10X8:case y.ASTC_SRGBA_10X10:case y.ASTC_SRGBA_12X10:case y.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function Le(e,t){switch(e){case k.BOOL:return t.BOOL;case k.BOOL2:return t.BOOL_VEC2;case k.BOOL3:return t.BOOL_VEC3;case k.BOOL4:return t.BOOL_VEC4;case k.INT:return t.INT;case k.INT2:return t.INT_VEC2;case k.INT3:return t.INT_VEC3;case k.INT4:return t.INT_VEC4;case k.UINT:return t.UNSIGNED_INT;case k.FLOAT:return t.FLOAT;case k.FLOAT2:return t.FLOAT_VEC2;case k.FLOAT3:return t.FLOAT_VEC3;case k.FLOAT4:return t.FLOAT_VEC4;case k.MAT2:return t.FLOAT_MAT2;case k.MAT3:return t.FLOAT_MAT3;case k.MAT4:return t.FLOAT_MAT4;case k.SAMPLER2D:return t.SAMPLER_2D;case k.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),k.UNKNOWN}}function Me(e){switch(e){case k.BOOL:case k.BOOL2:case k.BOOL3:case k.BOOL4:case k.INT:case k.INT2:case k.INT3:case k.INT4:case k.UINT:return Int32Array;case k.FLOAT:case k.FLOAT2:case k.FLOAT3:case k.FLOAT4:case k.MAT2:case k.MAT3:case k.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function De(e,t){switch(e){case t.BOOL:return k.BOOL;case t.BOOL_VEC2:return k.BOOL2;case t.BOOL_VEC3:return k.BOOL3;case t.BOOL_VEC4:return k.BOOL4;case t.INT:return k.INT;case t.INT_VEC2:return k.INT2;case t.INT_VEC3:return k.INT3;case t.INT_VEC4:return k.INT4;case t.UNSIGNED_INT:return k.UINT;case t.FLOAT:return k.FLOAT;case t.FLOAT_VEC2:return k.FLOAT2;case t.FLOAT_VEC3:return k.FLOAT3;case t.FLOAT_VEC4:return k.FLOAT4;case t.FLOAT_MAT2:return k.MAT2;case t.FLOAT_MAT3:return k.MAT3;case t.FLOAT_MAT4:return k.MAT4;case t.SAMPLER_2D:return k.SAMPLER2D;case t.SAMPLER_CUBE:return k.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),k.UNKNOWN}}function we(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function Ne(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}Ge._instance=null;var Ue,ke=[512,513,514,515,516,517,518,519],Xe=[0,7680,7681,7682,7683,5386,34055,34056],He=[32774,32778,32779,32775,32776],Ve=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.BLIT_TEXTURE=6]="BLIT_TEXTURE",e[e.COUNT=7]="COUNT"}(Ue||(Ue={}));var We=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},ze=function(e){function r(){var t;return(t=e.call(this,Ue.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new A,t.clearFlag=p.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return t(r,e),r.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},r}(We),Ke=function(e){function r(){var t;return(t=e.call(this,Ue.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new m,t}return t(r,e),r.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},r}(We),Ye=function(e){function r(){var t;return(t=e.call(this,Ue.DRAW)||this).drawInfo=new B,t}return t(r,e),r.prototype.clear=function(){},r}(We),je=function(e){function r(){var t;return(t=e.call(this,Ue.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return t(r,e),r.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},r}(We),qe=function(e){function r(){var t;return(t=e.call(this,Ue.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return t(r,e),r.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},r}(We),Ze=function(e){function r(){var t;return(t=e.call(this,Ue.BLIT_TEXTURE)||this).srcTexture=null,t.dstTexture=null,t.regions=[],t.filter=C.LINEAR,t}return t(r,e),r.prototype.clear=function(){this.srcTexture=null,this.dstTexture=null,this.regions.length=0},r}(We),Qe=function(){function e(){this.cmds=new u(1),this.beginRenderPassCmds=new u(1),this.bindStatesCmds=new u(1),this.drawCmds=new u(1),this.updateBufferCmds=new u(1),this.copyBufferToTextureCmds=new u(1),this.blitTextureCmds=new u(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.blitTextureCmds.length&&(e.blitTextureCmdPool.freeCmds(this.blitTextureCmds),this.blitTextureCmds.clear()),this.cmds.clear()},e}();function Je(e,t){var r=e.gl,s=e.stateCache,a=t.memUsage&x.HOST?r.DYNAMIC_DRAW:r.STATIC_DRAW;if(t.usage&b.VERTEX){t.glTarget=r.ARRAY_BUFFER;var i=r.createBuffer();i&&(t.glBuffer=i,t.size>0&&(e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),it.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),r.bufferData(r.ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&b.INDEX){t.glTarget=r.ELEMENT_ARRAY_BUFFER;var n=r.createBuffer();n&&(t.glBuffer=n,t.size>0&&(e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),s.glVAO=null),it.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.size,a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&b.UNIFORM?(t.glTarget=r.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&b.INDIRECT||t.usage&b.TRANSFER_DST||t.usage&b.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=r.NONE)}function $e(e,t){var r=e.gl,s=e.stateCache;if(t.glBuffer){switch(t.glTarget){case r.ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),it.gpuInputAssembler=null,r.bindBuffer(r.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case r.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&s.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),it.gpuInputAssembler=null,r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}r.deleteBuffer(t.glBuffer),t.glBuffer=null}}function et(e,t,r,s,a){if(t.usage&b.UNIFORM)ArrayBuffer.isView(r)?t.vf32.set(r,s/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(r),s/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&b.INDIRECT){t.indirects.clearDraws();for(var i=r.drawInfos,n=0;n<i.length;++n)t.indirects.setDrawInfo(s+n,i[n])}else{var u=r,l=e.gl,_=e.stateCache;switch(t.glTarget){case l.ARRAY_BUFFER:e.extensions.useVAO&&_.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),_.glVAO=null),it.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case l.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&_.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),_.glVAO=null),it.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}a===u.byteLength?l.bufferSubData(t.glTarget,s,u):l.bufferSubData(t.glTarget,s,u.slice(0,a))}}function tt(e,t){for(var r=e.gl,s=function(){var e=t.gpuStages[a],s=0,i="",n=1;switch(e.type){case V.VERTEX:i="VertexShader",s=r.VERTEX_SHADER;break;case V.FRAGMENT:i="FragmentShader",s=r.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var u=r.createShader(s);if(u&&(e.glShader=u,r.shaderSource(e.glShader,e.source),r.compileShader(e.glShader),!r.getShaderParameter(e.glShader,r.COMPILE_STATUS))){console.error(i+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",e.source.replace(/^|\n/g,(function(){return"\n"+n+++" "}))),console.error(r.getShaderInfoLog(e.glShader));for(var l=0;l<t.gpuStages.length;l++){var _=t.gpuStages[a];_.glShader&&(r.deleteShader(_.glShader),_.glShader=null)}return{v:void 0}}},a=0;a<t.gpuStages.length;a++){var u=s();if("object"==typeof u)return u.v}var l=r.createProgram();if(l){t.glProgram=l;for(var _=0;_<t.gpuStages.length;_++){var o=t.gpuStages[_];r.attachShader(t.glProgram,o.glShader)}if(r.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var f=0;f<t.gpuStages.length;f++){var c=t.gpuStages[f];c.glShader&&(r.detachShader(t.glProgram,c.glShader),r.deleteShader(c.glShader),c.glShader=null)}if(!r.getProgramParameter(t.glProgram,r.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(r.getProgramInfoLog(t.glProgram));i("Shader '"+t.name+"' compilation succeeded.");var h=r.getProgramParameter(t.glProgram,r.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var E=0;E<h;++E){var g=r.getActiveAttrib(t.glProgram,E);if(g){var T,d=g.name.indexOf("[");T=-1!==d?g.name.substr(0,d):g.name;var R=r.getAttribLocation(t.glProgram,T),S=De(g.type,r),A=we(g.type,r);t.glInputs[E]={binding:R,name:T,type:S,stride:A,count:g.size,size:A*g.size,glType:g.type,glLoc:R}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var p=0;p<t.blocks.length;++p){var m=t.blocks[p],B={set:m.set,binding:m.binding,name:m.name,size:0,glUniforms:new Array(m.members.length),glActiveUniforms:[]};t.glBlocks[p]=B;for(var C=0;C<m.members.length;++C){var x=m.members[C],b=Le(x.type,r),P=we(b,r),F=P*x.count;B.glUniforms[C]={binding:-1,name:x.name,type:x.type,stride:P,count:x.count,size:F,offset:0,glType:b,glLoc:null,array:null}}}}for(var v=0;v<t.subpassInputs.length;++v){var y=t.subpassInputs[v];t.samplerTextures.push(new U(y.set,y.binding,y.name,k.SAMPLER2D,y.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var O=0;O<t.samplerTextures.length;++O){var G=t.samplerTextures[O];t.glSamplerTextures[O]={set:G.set,binding:G.binding,name:G.name,type:G.type,count:G.count,units:[],glUnits:null,glType:Le(G.type,r),glLoc:null}}}for(var I=r.getProgramParameter(t.glProgram,r.ACTIVE_UNIFORMS),L=0;L<I;++L){var M=r.getActiveUniform(t.glProgram,L);if(M&&M.type!==r.SAMPLER_2D&&M.type!==r.SAMPLER_CUBE){var D=r.getUniformLocation(t.glProgram,M.name);if(e.extensions.isLocationActive(D)){var w,N=M.name.indexOf("[");w=-1!==N?M.name.substr(0,N):M.name;for(var X=0;X<t.glBlocks.length;X++)for(var H=t.glBlocks[X],W=0;W<H.glUniforms.length;W++){var z=H.glUniforms[W];if(z.name===w){z.glLoc=D,z.count=M.size,z.size=z.stride*z.count,z.array=new(Me(z.type))(z.size/4),H.glActiveUniforms.push(z);break}}}}}for(var K=0;K<t.glBlocks.length;K++)for(var Y=t.glBlocks[K],j=0;j<Y.glUniforms.length;j++){var q=Y.glUniforms[j];q.offset=Y.size/4,Y.size+=q.size}var Z=[],Q=[],J=e.bindingMappings,$=e.stateCache.texUnitCacheMap;if(n.rendering&&n.rendering.enableEffectImport)for(var ee=0;ee<t.samplerTextures.length;++ee){var te=t.samplerTextures[ee],re=r.getUniformLocation(t.glProgram,te.name);e.extensions.isLocationActive(re)&&(Z.push(t.glSamplerTextures[ee]),Q.push(re)),void 0===$[te.name]&&($[te.name]=te.flattened%e.capabilities.maxTextureUnits)}else{for(var se=0,ae=0;ae<t.blocks.length;++ae)t.blocks[ae].set===J.flexibleSet&&se++;for(var ie=0,ne=0;ne<t.samplerTextures.length;++ne){var ue=t.samplerTextures[ne],le=r.getUniformLocation(t.glProgram,ue.name);if(e.extensions.isLocationActive(le)&&(Z.push(t.glSamplerTextures[ne]),Q.push(le)),void 0===$[ue.name]){var _e=ue.binding+J.samplerTextureOffsets[ue.set]+ie;ue.set===J.flexibleSet&&(_e-=se),$[ue.name]=_e%e.capabilities.maxTextureUnits,ie+=ue.count-1}}}if(Z.length){for(var oe=[],fe=0;fe<Z.length;++fe){var ce=Z[fe],he=$[ce.name];if(void 0!==he){ce.glLoc=Q[fe];for(var Ee=0;Ee<ce.count;++Ee){for(;oe[he];)he=(he+1)%e.capabilities.maxTextureUnits;ce.units.push(he),oe[he]=!0}}}for(var ge=0,Te=0;Te<Z.length;++Te){var de=Z[Te];if(!e.extensions.isLocationActive(de.glLoc)){de.glLoc=Q[Te];for(var Re=0;Re<de.count;++Re){for(;oe[ge];)ge=(ge+1)%e.capabilities.maxTextureUnits;void 0===$[de.name]&&($[de.name]=ge),de.units.push(ge),oe[ge]=!0}}}e.stateCache.glProgram!==t.glProgram&&r.useProgram(t.glProgram);for(var Se=0;Se<Z.length;Se++){var Ae=Z[Se];Ae.glUnits=new Int32Array(Ae.units),r.uniform1iv(Ae.glLoc,Ae.glUnits)}e.stateCache.glProgram!==t.glProgram&&r.useProgram(e.stateCache.glProgram)}for(var pe=0;pe<t.glBlocks.length;)t.glBlocks[pe].glActiveUniforms.length?pe++:(t.glBlocks[pe]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=Z}}function rt(e,t){if(t.glProgram){var r=e.gl;if(!e.extensions.destroyShadersImmediately)for(var s=0;s<t.gpuStages.length;s++){var a=t.gpuStages[s];a.glShader&&(r.detachShader(t.glProgram,a.glShader),r.deleteShader(a.glShader),a.glShader=null)}r.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}function st(e,t){var r=e.gl;t.glAttribs=new Array(t.attributes.length);for(var s=[0,0,0,0,0,0,0,0],a=0;a<t.attributes.length;++a){var i=t.attributes[a],n=void 0!==i.stream?i.stream:0,u=t.gpuVertexBuffers[n],l=Ie(i.format,r),_=F[i.format].size;t.glAttribs[a]={name:i.name,glBuffer:u.glBuffer,glType:l,size:_,count:F[i.format].count,stride:u.stride,componentCount:Ne(l,r),isNormalized:void 0!==i.isNormalized&&i.isNormalized,isInstanced:void 0!==i.isInstanced&&i.isInstanced,offset:s[n]},s[n]+=_}}function at(e,t){for(var r=t.glVAOs.values(),s=r.next(),a=e.extensions.OES_vertex_array_object,i=e.stateCache.glVAO;!s.done;)a.deleteVertexArrayOES(s.value),i===s.value&&(a.bindVertexArrayOES(null),i=null),s=r.next();e.stateCache.glVAO=i,t.glVAOs.clear()}var it={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},nt=new A;function ut(e,t,r,s,a,i,n){var u=e.gl,l=e.stateCache,_=0;if(r&&(nt.x=s.x<<r.lodLevel,nt.y=s.y<<r.lodLevel,nt.width=s.width<<r.lodLevel,nt.height=s.height<<r.lodLevel),r&&t){l.glFramebuffer!==r.glFramebuffer&&(u.bindFramebuffer(u.FRAMEBUFFER,r.glFramebuffer),l.glFramebuffer=r.glFramebuffer),l.viewport.left===nt.x&&l.viewport.top===nt.y&&l.viewport.width===nt.width&&l.viewport.height===nt.height||(u.viewport(nt.x,nt.y,nt.width,nt.height),l.viewport.left=nt.x,l.viewport.top=nt.y,l.viewport.width=nt.width,l.viewport.height=nt.height),l.scissorRect.x===nt.x&&l.scissorRect.y===nt.y&&l.scissorRect.width===nt.width&&l.scissorRect.height===nt.height||(u.scissor(nt.x,nt.y,nt.width,nt.height),l.scissorRect.x=nt.x,l.scissorRect.y=nt.y,l.scissorRect.width=nt.width,l.scissorRect.height=nt.height);var o=a.length;e.extensions.WEBGL_draw_buffers||(o=1);for(var f=0;f<o;++f){var c=t.colorAttachments[f];if(c.format!==y.UNKNOWN)switch(c.loadOp){case O.LOAD:break;case O.CLEAR:l.bs.targets[0].blendColorMask!==G.ALL&&u.colorMask(!0,!0,!0,!0);var h=a[0];u.clearColor(h.x,h.y,h.z,h.w),_|=u.COLOR_BUFFER_BIT;break;case O.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==y.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case O.LOAD:break;case O.CLEAR:l.dss.depthWrite||u.depthMask(!0),u.clearDepth(i),_|=u.DEPTH_BUFFER_BIT;break;case O.DISCARD:}if(F[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case O.LOAD:break;case O.CLEAR:l.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,65535),l.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,65535),u.clearStencil(n),_|=u.STENCIL_BUFFER_BIT;break;case O.DISCARD:}}if(_&&u.clear(_),_&u.COLOR_BUFFER_BIT){var E=l.bs.targets[0].blendColorMask;if(E!==G.ALL){var g=(E&G.R)!==G.NONE,T=(E&G.G)!==G.NONE,d=(E&G.B)!==G.NONE,R=(E&G.A)!==G.NONE;u.colorMask(g,T,d,R)}}_&u.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&u.depthMask(!1),_&u.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||u.stencilMaskSeparate(u.FRONT,0),l.dss.stencilWriteMaskBack||u.stencilMaskSeparate(u.BACK,0))}}function lt(e,t,r,s,a,i){var n,u,l,_=e.gl,o=e.stateCache,f=t&&t.gpuShader,c=!1;if(t&&it.gpuPipelineState!==t){if(it.gpuPipelineState=t,it.glPrimitive=t.glPrimitive,t.gpuShader){var h=t.gpuShader.glProgram;o.glProgram!==h&&(_.useProgram(h),o.glProgram=h,c=!0)}var E=t.rs;if(E){if(o.rs.cullMode!==E.cullMode){switch(E.cullMode){case I.NONE:_.disable(_.CULL_FACE);break;case I.FRONT:_.enable(_.CULL_FACE),_.cullFace(_.FRONT);break;case I.BACK:_.enable(_.CULL_FACE),_.cullFace(_.BACK)}o.rs.cullMode=E.cullMode}var g=E.isFrontFaceCCW;o.rs.isFrontFaceCCW!==g&&(_.frontFace(g?_.CCW:_.CW),o.rs.isFrontFaceCCW=g),o.rs.depthBias===E.depthBias&&o.rs.depthBiasSlop===E.depthBiasSlop||(_.polygonOffset(E.depthBias,E.depthBiasSlop),o.rs.depthBias=E.depthBias,o.rs.depthBiasSlop=E.depthBiasSlop),o.rs.lineWidth!==E.lineWidth&&(_.lineWidth(E.lineWidth),o.rs.lineWidth=E.lineWidth)}var T=t.dss;T&&(o.dss.depthTest!==T.depthTest&&(T.depthTest?_.enable(_.DEPTH_TEST):_.disable(_.DEPTH_TEST),o.dss.depthTest=T.depthTest),o.dss.depthWrite!==T.depthWrite&&(_.depthMask(T.depthWrite),o.dss.depthWrite=T.depthWrite),o.dss.depthFunc!==T.depthFunc&&(_.depthFunc(ke[T.depthFunc]),o.dss.depthFunc=T.depthFunc),o.dss.stencilTestFront===T.stencilTestFront&&o.dss.stencilTestBack===T.stencilTestBack||(T.stencilTestFront||T.stencilTestBack?_.enable(_.STENCIL_TEST):_.disable(_.STENCIL_TEST),o.dss.stencilTestFront=T.stencilTestFront,o.dss.stencilTestBack=T.stencilTestBack),o.dss.stencilFuncFront===T.stencilFuncFront&&o.dss.stencilRefFront===T.stencilRefFront&&o.dss.stencilReadMaskFront===T.stencilReadMaskFront||(_.stencilFuncSeparate(_.FRONT,ke[T.stencilFuncFront],T.stencilRefFront,T.stencilReadMaskFront),o.dss.stencilFuncFront=T.stencilFuncFront,o.dss.stencilRefFront=T.stencilRefFront,o.dss.stencilReadMaskFront=T.stencilReadMaskFront),o.dss.stencilFailOpFront===T.stencilFailOpFront&&o.dss.stencilZFailOpFront===T.stencilZFailOpFront&&o.dss.stencilPassOpFront===T.stencilPassOpFront||(_.stencilOpSeparate(_.FRONT,Xe[T.stencilFailOpFront],Xe[T.stencilZFailOpFront],Xe[T.stencilPassOpFront]),o.dss.stencilFailOpFront=T.stencilFailOpFront,o.dss.stencilZFailOpFront=T.stencilZFailOpFront,o.dss.stencilPassOpFront=T.stencilPassOpFront),o.dss.stencilWriteMaskFront!==T.stencilWriteMaskFront&&(_.stencilMaskSeparate(_.FRONT,T.stencilWriteMaskFront),o.dss.stencilWriteMaskFront=T.stencilWriteMaskFront),o.dss.stencilFuncBack===T.stencilFuncBack&&o.dss.stencilRefBack===T.stencilRefBack&&o.dss.stencilReadMaskBack===T.stencilReadMaskBack||(_.stencilFuncSeparate(_.BACK,ke[T.stencilFuncBack],T.stencilRefBack,T.stencilReadMaskBack),o.dss.stencilFuncBack=T.stencilFuncBack,o.dss.stencilRefBack=T.stencilRefBack,o.dss.stencilReadMaskBack=T.stencilReadMaskBack),o.dss.stencilFailOpBack===T.stencilFailOpBack&&o.dss.stencilZFailOpBack===T.stencilZFailOpBack&&o.dss.stencilPassOpBack===T.stencilPassOpBack||(_.stencilOpSeparate(_.BACK,Xe[T.stencilFailOpBack],Xe[T.stencilZFailOpBack],Xe[T.stencilPassOpBack]),o.dss.stencilFailOpBack=T.stencilFailOpBack,o.dss.stencilZFailOpBack=T.stencilZFailOpBack,o.dss.stencilPassOpBack=T.stencilPassOpBack),o.dss.stencilWriteMaskBack!==T.stencilWriteMaskBack&&(_.stencilMaskSeparate(_.BACK,T.stencilWriteMaskBack),o.dss.stencilWriteMaskBack=T.stencilWriteMaskBack));var d=t.bs;if(d){o.bs.isA2C!==d.isA2C&&(d.isA2C?_.enable(_.SAMPLE_ALPHA_TO_COVERAGE):_.disable(_.SAMPLE_ALPHA_TO_COVERAGE),o.bs.isA2C=d.isA2C),o.bs.blendColor.x===d.blendColor.x&&o.bs.blendColor.y===d.blendColor.y&&o.bs.blendColor.z===d.blendColor.z&&o.bs.blendColor.w===d.blendColor.w||(_.blendColor(d.blendColor.x,d.blendColor.y,d.blendColor.z,d.blendColor.w),o.bs.blendColor.x=d.blendColor.x,o.bs.blendColor.y=d.blendColor.y,o.bs.blendColor.z=d.blendColor.z,o.bs.blendColor.w=d.blendColor.w);var R=d.targets[0],S=o.bs.targets[0];S.blend!==R.blend&&(R.blend?_.enable(_.BLEND):_.disable(_.BLEND),S.blend=R.blend),S.blendEq===R.blendEq&&S.blendAlphaEq===R.blendAlphaEq||(_.blendEquationSeparate(He[R.blendEq],He[R.blendAlphaEq]),S.blendEq=R.blendEq,S.blendAlphaEq=R.blendAlphaEq),S.blendSrc===R.blendSrc&&S.blendDst===R.blendDst&&S.blendSrcAlpha===R.blendSrcAlpha&&S.blendDstAlpha===R.blendDstAlpha||(_.blendFuncSeparate(Ve[R.blendSrc],Ve[R.blendDst],Ve[R.blendSrcAlpha],Ve[R.blendDstAlpha]),S.blendSrc=R.blendSrc,S.blendDst=R.blendDst,S.blendSrcAlpha=R.blendSrcAlpha,S.blendDstAlpha=R.blendDstAlpha),S.blendColorMask!==R.blendColorMask&&(_.colorMask((R.blendColorMask&G.R)!==G.NONE,(R.blendColorMask&G.G)!==G.NONE,(R.blendColorMask&G.B)!==G.NONE,(R.blendColorMask&G.A)!==G.NONE),S.blendColorMask=R.blendColorMask)}}if(t&&t.gpuPipelineLayout&&f){for(var A=f.glBlocks.length,p=t.gpuPipelineLayout.dynamicOffsetIndices,m=0;m<A;m++){var B=f.glBlocks[m],C=s[B.set],x=C&&C.descriptorIndices[B.binding],b=x>=0&&C.gpuDescriptors[x],P=null,F=0;if(b&&b.gpuBuffer){var v=b.gpuBuffer,y=p[B.set],O=y&&y[B.binding];O>=0&&(F=a[O]),"vf32"in v?P=v.vf32:(F+=v.offset,P=v.gpuBuffer.vf32),F>>=2}if(P)for(var M=B.glActiveUniforms.length,D=0;D<M;D++){var w=B.glActiveUniforms[D];switch(w.glType){case _.BOOL:case _.INT:for(var N=0;N<w.array.length;++N){var U=w.offset+F+N;if(P[U]!==w.array[N]){for(var k=N,X=U;k<w.array.length;++k,++X)w.array[k]=P[X];_.uniform1iv(w.glLoc,w.array);break}}break;case _.BOOL_VEC2:case _.INT_VEC2:for(var H=0;H<w.array.length;++H){var V=w.offset+F+H;if(P[V]!==w.array[H]){for(var W=H,z=V;W<w.array.length;++W,++z)w.array[W]=P[z];_.uniform2iv(w.glLoc,w.array);break}}break;case _.BOOL_VEC3:case _.INT_VEC3:for(var K=0;K<w.array.length;++K){var Y=w.offset+F+K;if(P[Y]!==w.array[K]){for(var j=K,q=Y;j<w.array.length;++j,++q)w.array[j]=P[q];_.uniform3iv(w.glLoc,w.array);break}}break;case _.BOOL_VEC4:case _.INT_VEC4:for(var Z=0;Z<w.array.length;++Z){var Q=w.offset+F+Z;if(P[Q]!==w.array[Z]){for(var J=Z,$=Q;J<w.array.length;++J,++$)w.array[J]=P[$];_.uniform4iv(w.glLoc,w.array);break}}break;case _.FLOAT:for(var ee=0;ee<w.array.length;++ee){var te=w.offset+F+ee;if(P[te]!==w.array[ee]){for(var re=ee,se=te;re<w.array.length;++re,++se)w.array[re]=P[se];_.uniform1fv(w.glLoc,w.array);break}}break;case _.FLOAT_VEC2:for(var ae=0;ae<w.array.length;++ae){var ie=w.offset+F+ae;if(P[ie]!==w.array[ae]){for(var ne=ae,ue=ie;ne<w.array.length;++ne,++ue)w.array[ne]=P[ue];_.uniform2fv(w.glLoc,w.array);break}}break;case _.FLOAT_VEC3:for(var le=0;le<w.array.length;++le){var _e=w.offset+F+le;if(P[_e]!==w.array[le]){for(var oe=le,fe=_e;oe<w.array.length;++oe,++fe)w.array[oe]=P[fe];_.uniform3fv(w.glLoc,w.array);break}}break;case _.FLOAT_VEC4:for(var ce=0;ce<w.array.length;++ce){var he=w.offset+F+ce;if(P[he]!==w.array[ce]){for(var Ee=ce,ge=he;Ee<w.array.length;++Ee,++ge)w.array[Ee]=P[ge];_.uniform4fv(w.glLoc,w.array);break}}break;case _.FLOAT_MAT2:for(var Te=0;Te<w.array.length;++Te){var de=w.offset+F+Te;if(P[de]!==w.array[Te]){for(var Re=Te,Se=de;Re<w.array.length;++Re,++Se)w.array[Re]=P[Se];_.uniformMatrix2fv(w.glLoc,!1,w.array);break}}break;case _.FLOAT_MAT3:for(var Ae=0;Ae<w.array.length;++Ae){var pe=w.offset+F+Ae;if(P[pe]!==w.array[Ae]){for(var me=Ae,Be=pe;me<w.array.length;++me,++Be)w.array[me]=P[Be];_.uniformMatrix3fv(w.glLoc,!1,w.array);break}}break;case _.FLOAT_MAT4:for(var Ce=0;Ce<w.array.length;++Ce){var xe=w.offset+F+Ce;if(P[xe]!==w.array[Ce]){for(var be=Ce,Pe=xe;be<w.array.length;++be,++Pe)w.array[be]=P[Pe];_.uniformMatrix4fv(w.glLoc,!1,w.array);break}}}}}for(var Fe=f.glSamplerTextures.length,ve=0;ve<Fe;ve++)for(var ye=f.glSamplerTextures[ve],Oe=s[ye.set],Ge=Oe&&Oe.descriptorIndices[ye.binding],Ie=Ge>=0&&Oe.gpuDescriptors[Ge],Le=ye.units.length,Me=0;Me<Le;Me++){var De=ye.units[Me];if(Ie&&Ie.gpuSampler){if(Ie.gpuTexture&&Ie.gpuTexture.size>0){var we=Ie.gpuTexture,Ne=o.glTexUnits[De];Ne.glTexture!==we.glTexture&&(o.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),o.texUnit=De),we.glTexture?_.bindTexture(we.glTarget,we.glTexture):_.bindTexture(we.glTarget,e.nullTex2D.gpuTexture.glTexture),Ne.glTexture=we.glTexture);var Ue=Ie.gpuSampler;we.isPowerOf2?(n=Ue.glWrapS,u=Ue.glWrapT):(n=_.CLAMP_TO_EDGE,u=_.CLAMP_TO_EDGE),l=we.isPowerOf2?we.mipLevel<=1&&(Ue.glMinFilter===_.LINEAR_MIPMAP_NEAREST||Ue.glMinFilter===_.LINEAR_MIPMAP_LINEAR)?_.LINEAR:Ue.glMinFilter:Ue.glMinFilter===_.LINEAR||Ue.glMinFilter===_.LINEAR_MIPMAP_NEAREST||Ue.glMinFilter===_.LINEAR_MIPMAP_LINEAR?_.LINEAR:_.NEAREST,we.glWrapS!==n&&(o.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),o.texUnit=De),_.texParameteri(we.glTarget,_.TEXTURE_WRAP_S,n),we.glWrapS=n),we.glWrapT!==u&&(o.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),o.texUnit=De),_.texParameteri(we.glTarget,_.TEXTURE_WRAP_T,u),we.glWrapT=u),we.glMinFilter!==l&&(o.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),o.texUnit=De),_.texParameteri(we.glTarget,_.TEXTURE_MIN_FILTER,l),we.glMinFilter=l),we.glMagFilter!==Ue.glMagFilter&&(o.texUnit!==De&&(_.activeTexture(_.TEXTURE0+De),o.texUnit=De),_.texParameteri(we.glTarget,_.TEXTURE_MAG_FILTER,Ue.glMagFilter),we.glMagFilter=Ue.glMagFilter)}Ie=Oe.gpuDescriptors[++Ge]}}}if(r&&f&&(c||it.gpuInputAssembler!==r)){it.gpuInputAssembler=r;var We=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var ze=e.extensions.OES_vertex_array_object,Ke=r.glVAOs.get(f.glProgram);if(!Ke){var Ye;Ke=ze.createVertexArrayOES(),r.glVAOs.set(f.glProgram,Ke),ze.bindVertexArrayOES(Ke),_.bindBuffer(_.ARRAY_BUFFER,null),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),o.glArrayBuffer=null,o.glElementArrayBuffer=null;for(var je=f.glInputs.length,qe=0;qe<je;qe++){var Ze=f.glInputs[qe];Ye=null;for(var Qe=r.glAttribs.length,Je=0;Je<Qe;Je++){var $e=r.glAttribs[Je];if($e.name===Ze.name){Ye=$e;break}}if(Ye){o.glArrayBuffer!==Ye.glBuffer&&(_.bindBuffer(_.ARRAY_BUFFER,Ye.glBuffer),o.glArrayBuffer=Ye.glBuffer);for(var et=0;et<Ye.componentCount;++et){var tt=Ze.glLoc+et,rt=Ye.offset+Ye.size*et;_.enableVertexAttribArray(tt),o.glCurrentAttribLocs[tt]=!0,_.vertexAttribPointer(tt,Ye.count,Ye.glType,Ye.isNormalized,Ye.stride,rt),We&&We.vertexAttribDivisorANGLE(tt,Ye.isInstanced?1:0)}}}var st=r.gpuIndexBuffer;st&&_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,st.glBuffer),ze.bindVertexArrayOES(null),_.bindBuffer(_.ARRAY_BUFFER,null),_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,null),o.glArrayBuffer=null,o.glElementArrayBuffer=null}o.glVAO!==Ke&&(ze.bindVertexArrayOES(Ke),o.glVAO=Ke)}else{for(var at=0;at<e.capabilities.maxVertexAttributes;++at)o.glCurrentAttribLocs[at]=!1;for(var nt=f.glInputs.length,ut=0;ut<nt;ut++){for(var lt=f.glInputs[ut],_t=null,ot=r.glAttribs.length,ft=0;ft<ot;ft++){var ct=r.glAttribs[ft];if(ct.name===lt.name){_t=ct;break}}if(_t){o.glArrayBuffer!==_t.glBuffer&&(_.bindBuffer(_.ARRAY_BUFFER,_t.glBuffer),o.glArrayBuffer=_t.glBuffer);for(var ht=0;ht<_t.componentCount;++ht){var Et=lt.glLoc+ht,gt=_t.offset+_t.size*ht;!o.glEnabledAttribLocs[Et]&&Et>=0&&(_.enableVertexAttribArray(Et),o.glEnabledAttribLocs[Et]=!0),o.glCurrentAttribLocs[Et]=!0,_.vertexAttribPointer(Et,_t.count,_t.glType,_t.isNormalized,_t.stride,gt),We&&We.vertexAttribDivisorANGLE(Et,_t.isInstanced?1:0)}}}var Tt=r.gpuIndexBuffer;Tt&&o.glElementArrayBuffer!==Tt.glBuffer&&(_.bindBuffer(_.ELEMENT_ARRAY_BUFFER,Tt.glBuffer),o.glElementArrayBuffer=Tt.glBuffer);for(var dt=0;dt<e.capabilities.maxVertexAttributes;++dt)o.glEnabledAttribLocs[dt]!==o.glCurrentAttribLocs[dt]&&(_.disableVertexAttribArray(dt),o.glEnabledAttribLocs[dt]=!1)}}if(t&&t.dynamicStates.length)for(var Rt=t.dynamicStates.length,St=0;St<Rt;St++)switch(t.dynamicStates[St]){case L.LINE_WIDTH:o.rs.lineWidth!==i.lineWidth&&(_.lineWidth(i.lineWidth),o.rs.lineWidth=i.lineWidth);break;case L.DEPTH_BIAS:o.rs.depthBias===i.depthBiasConstant&&o.rs.depthBiasSlop===i.depthBiasSlope||(_.polygonOffset(i.depthBiasConstant,i.depthBiasSlope),o.rs.depthBias=i.depthBiasConstant,o.rs.depthBiasSlop=i.depthBiasSlope);break;case L.BLEND_CONSTANTS:var At=i.blendConstant;o.bs.blendColor.x===At.x&&o.bs.blendColor.y===At.y&&o.bs.blendColor.z===At.z&&o.bs.blendColor.w===At.w||(_.blendColor(At.x,At.y,At.z,At.w),o.bs.blendColor.copy(At));break;case L.STENCIL_WRITE_MASK:var pt=i.stencilStatesFront,mt=i.stencilStatesBack;o.dss.stencilWriteMaskFront!==pt.writeMask&&(_.stencilMaskSeparate(_.FRONT,pt.writeMask),o.dss.stencilWriteMaskFront=pt.writeMask),o.dss.stencilWriteMaskBack!==mt.writeMask&&(_.stencilMaskSeparate(_.BACK,mt.writeMask),o.dss.stencilWriteMaskBack=mt.writeMask);break;case L.STENCIL_COMPARE_MASK:var Bt=i.stencilStatesFront,Ct=i.stencilStatesBack;o.dss.stencilRefFront===Bt.reference&&o.dss.stencilReadMaskFront===Bt.compareMask||(_.stencilFuncSeparate(_.FRONT,ke[o.dss.stencilFuncFront],Bt.reference,Bt.compareMask),o.dss.stencilRefFront=Bt.reference,o.dss.stencilReadMaskFront=Bt.compareMask),o.dss.stencilRefBack===Ct.reference&&o.dss.stencilReadMaskBack===Ct.compareMask||(_.stencilFuncSeparate(_.BACK,ke[o.dss.stencilFuncBack],Ct.reference,Ct.compareMask),o.dss.stencilRefBack=Ct.reference,o.dss.stencilReadMaskBack=Ct.compareMask)}}function _t(e,t){var r=e.gl,s=e.extensions,a=s.ANGLE_instanced_arrays,i=s.WEBGL_multi_draw,n=it.gpuInputAssembler,u=it.glPrimitive;if(n){var l=n.gpuIndexBuffer;if(n.gpuIndirectBuffer){var _=n.gpuIndirectBuffer.indirects;if(_.drawByIndex){for(var o=0;o<_.drawCount;o++)_.byteOffsets[o]=_.offsets[o]*l.stride;if(i)_.instancedDraw?i.multiDrawElementsInstancedWEBGL(u,_.counts,0,n.glIndexType,_.byteOffsets,0,_.instances,0,_.drawCount):i.multiDrawElementsWEBGL(u,_.counts,0,n.glIndexType,_.byteOffsets,0,_.drawCount);else for(var f=0;f<_.drawCount;f++)_.instances[f]&&a?a.drawElementsInstancedANGLE(u,_.counts[f],n.glIndexType,_.byteOffsets[f],_.instances[f]):r.drawElements(u,_.counts[f],n.glIndexType,_.byteOffsets[f])}else if(i)_.instancedDraw?i.multiDrawArraysInstancedWEBGL(u,_.offsets,0,_.counts,0,_.instances,0,_.drawCount):i.multiDrawArraysWEBGL(u,_.offsets,0,_.counts,0,_.drawCount);else for(var c=0;c<_.drawCount;c++)_.instances[c]&&a?a.drawArraysInstancedANGLE(u,_.offsets[c],_.counts[c],_.instances[c]):r.drawArrays(u,_.offsets[c],_.counts[c])}else if(t.instanceCount&&a)if(l){if(t.indexCount>0){var h=t.firstIndex*l.stride;a.drawElementsInstancedANGLE(u,t.indexCount,n.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&a.drawArraysInstancedANGLE(u,t.firstVertex,t.vertexCount,t.instanceCount);else if(l){if(t.indexCount>0){var E=t.firstIndex*l.stride;r.drawElements(u,t.indexCount,n.glIndexType,E)}}else t.vertexCount>0&&r.drawArrays(u,t.firstVertex,t.vertexCount)}}var ot=new Array(Ue.COUNT);function ft(e,t){ot.fill(0);for(var r=0;r<t.cmds.length;++r){var s=t.cmds.array[r],a=ot[s]++;switch(s){case Ue.BEGIN_RENDER_PASS:var i=t.beginRenderPassCmds.array[a];ut(e,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break;case Ue.BIND_STATES:var n=t.bindStatesCmds.array[a];lt(e,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.dynamicStates);break;case Ue.DRAW:_t(e,t.drawCmds.array[a].drawInfo);break;case Ue.UPDATE_BUFFER:var u=t.updateBufferCmds.array[a];et(e,u.gpuBuffer,u.buffer,u.offset,u.size);break;case Ue.COPY_BUFFER_TO_TEXTURE:var l=t.copyBufferToTextureCmds.array[a];Et(e,l.buffers,l.gpuTexture,l.regions);break;case Ue.BLIT_TEXTURE:var _=t.blitTextureCmds.array[a];gt(e,_.srcTexture,_.dstTexture,_.regions,_.filter)}}}var ct=new Uint8Array(1);function ht(e,t,r,s,i){var n=w(t).height,u=v(t,i.width,i.height,i.depth),l=v(t,s.width,1,1),_=v(t,s.width,s.height,1),o=v(t,i.width,1,1),f=D(F[t]);ct.byteLength<u&&(ct=new Uint8Array(u));for(var c=0,h=r,E=0;E<i.depth;E++){h=r+_*E;for(var g=0;g<i.height;g+=n)ct.subarray(c,c+o).set(new Uint8Array(e.buffer,e.byteOffset+h,o)),c+=o,h+=l}var T=u/f.BYTES_PER_ELEMENT;return a(Number.isInteger(T),9101),new f(ct.buffer,0,T)}function Et(e,t,r,s){var i=e.gl,n=e.stateCache.glTexUnits[e.stateCache.texUnit];n.glTexture!==r.glTexture&&(i.bindTexture(r.glTarget,r.glTexture),n.glTexture=r.glTexture);var u=0,l=0,_=F[r.format],o=D(_),f=_.isCompressed,c=w(r.format),h=new X,E=new H,g=new X;switch(r.glTarget){case i.TEXTURE_2D:for(var T=0;T<s.length;T++){var d=s[T],R=d.texSubres.mipLevel;E.x=0===d.texOffset.x?0:N(d.texOffset.x,c.width),E.y=0===d.texOffset.y?0:N(d.texOffset.y,c.height),h.width=d.texExtent.width<c.width?d.texExtent.width:N(d.texExtent.width,c.width),h.height=d.texExtent.height<c.height?d.texExtent.width:N(d.texExtent.height,c.height),g.width=d.buffStride>0?d.buffStride:h.width,g.height=d.buffTexHeight>0?d.buffTexHeight:h.height;var S=d.texExtent.width+E.x===r.width>>R?d.texExtent.width:h.width,A=d.texExtent.height+E.y===r.height>>R?d.texExtent.height:h.height,p=void 0,m=t[u++];if(g.width===h.width&&g.height===h.height){var B=v(r.format,S,A,1)/o.BYTES_PER_ELEMENT;a(Number.isInteger(B),9101),p=new o(m.buffer,m.byteOffset+d.buffOffset,B)}else p=ht(m,r.format,d.buffOffset,g,h);f?r.glInternalFmt===ye.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?i.compressedTexImage2D(i.TEXTURE_2D,R,r.glInternalFmt,S,A,0,p):i.compressedTexSubImage2D(i.TEXTURE_2D,R,E.x,E.y,S,A,r.glFormat,p):i.texSubImage2D(i.TEXTURE_2D,R,E.x,E.y,S,A,r.glFormat,r.glType,p)}break;case i.TEXTURE_CUBE_MAP:for(var C=0;C<s.length;C++){var x=s[C],b=x.texSubres.mipLevel;E.x=0===x.texOffset.x?0:N(x.texOffset.x,c.width),E.y=0===x.texOffset.y?0:N(x.texOffset.y,c.height),h.width=x.texExtent.width<c.width?x.texExtent.width:N(x.texExtent.width,c.width),h.height=x.texExtent.height<c.height?x.texExtent.width:N(x.texExtent.height,c.height),g.width=x.buffStride>0?x.buffStride:h.width,g.height=x.buffTexHeight>0?x.buffTexHeight:h.height;var P=x.texExtent.width+E.x===r.width>>b?x.texExtent.width:h.width,y=x.texExtent.height+E.y===r.height>>b?x.texExtent.height:h.height,O=x.texSubres.baseArrayLayer+x.texSubres.layerCount;for(l=x.texSubres.baseArrayLayer;l<O;++l){var G=void 0,I=t[u++];if(g.width===h.width&&g.height===h.height){var L=v(r.format,P,y,1)/o.BYTES_PER_ELEMENT;a(Number.isInteger(L),9101),G=new o(I.buffer,I.byteOffset+x.buffOffset,L)}else G=ht(I,r.format,x.buffOffset,g,h);f?r.glInternalFmt===ye.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,b,r.glInternalFmt,P,y,0,G):i.compressedTexSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,b,E.x,E.y,P,y,r.glFormat,G):i.texSubImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+l,b,E.x,E.y,P,y,r.glFormat,r.glType,G)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&M.GEN_MIPMAP&&i.generateMipmap(r.glTarget)}function gt(e,t,r,s,a){e.blitManager.draw(t,r,s,a)}var Tt=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=l(e);var t=new Int32Array(this._capacity),r=new Int32Array(this._capacity),s=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),r.set(this.offsets),s.set(this.instances),this.counts=t,this.offsets=r,this.instances=s}},e}(),dt=function(){function e(){this._gpuShader=null,this._gpuDescriptorSetLayout=null,this._gpuPipelineLayout=null,this._gpuPipelineState=null,this._gpuVertexBuffer=null,this._gpuInputAssembler=null,this._gpuPointSampler=null,this._gpuLinearSampler=null,this._gpuDescriptorSet=null,this._gpuUniformBuffer=null,this._drawInfo=null,this._glFramebuffer=null,this._uniformBuffer=null;var e=Ge.instance.gl,t=Ge.instance.bindingMappingInfo.maxBlockCounts[0];this._gpuShader={name:"Blit Pass",blocks:[new W(0,0,"BlitParams",[new z("tilingOffsetSrc",k.FLOAT4,1),new z("tilingOffsetDst",k.FLOAT4,1)],1)],samplerTextures:[new U(0,t,"textureSrc",k.SAMPLER2D,1)],subpassInputs:[],gpuStages:[{type:V.VERTEX,source:"\n                    precision mediump float;\n\n                    attribute vec2 a_position;\n                    attribute vec2 a_texCoord;\n            \n                    uniform vec4 tilingOffsetSrc;\n                    uniform vec4 tilingOffsetDst;\n            \n                    varying vec2 v_texCoord;\n            \n                    void main() {\n                        v_texCoord = a_texCoord * tilingOffsetSrc.xy + tilingOffsetSrc.zw;\n                        gl_Position = vec4((a_position + 1.0) * tilingOffsetDst.xy - 1.0 + tilingOffsetDst.zw * 2.0, 0, 1);\n                    }",glShader:null},{type:V.FRAGMENT,source:"\n                    precision mediump float;\n                    uniform sampler2D textureSrc;\n\n                    varying vec2 v_texCoord;\n                    \n                    void main() {\n                        gl_FragColor = texture2D(textureSrc, v_texCoord);\n                    }",glShader:null}],glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]},tt(Ge.instance,this._gpuShader),this._gpuDescriptorSetLayout={bindings:[new K(0,Y.UNIFORM_BUFFER,1,V.VERTEX),new K(t,Y.SAMPLER_TEXTURE,1,V.FRAGMENT)],dynamicBindings:[],descriptorIndices:[],descriptorCount:t+1};for(var r=0;r<t;r++)this._gpuDescriptorSetLayout.descriptorIndices[r]=0;this._gpuDescriptorSetLayout.descriptorIndices.push(1),this._gpuPipelineLayout={gpuSetLayouts:[this._gpuDescriptorSetLayout],dynamicOffsetCount:0,dynamicOffsetOffsets:[0],dynamicOffsetIndices:[[]]},this._gpuPipelineState={glPrimitive:e.TRIANGLE_STRIP,gpuShader:this._gpuShader,gpuPipelineLayout:this._gpuPipelineLayout,rs:null,dss:new j(!1,!1),bs:null,dynamicStates:[],gpuRenderPass:null},this._gpuVertexBuffer={usage:b.VERTEX,memUsage:x.DEVICE,size:16*Float32Array.BYTES_PER_ELEMENT,stride:4*Float32Array.BYTES_PER_ELEMENT,buffer:null,vf32:null,indirects:new Tt,glTarget:0,glBuffer:null},Je(Ge.instance,this._gpuVertexBuffer),Ge.instance.memoryStatus.bufferSize+=this._gpuVertexBuffer.size;var s=new Float32Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]);et(Ge.instance,this._gpuVertexBuffer,s,0,s.length),this._gpuInputAssembler={attributes:[new q("a_position",y.RG32F),new q("a_texCoord",y.RG32F)],gpuVertexBuffers:[this._gpuVertexBuffer],gpuIndexBuffer:null,gpuIndirectBuffer:null,glAttribs:[],glIndexType:0,glVAOs:new Map},st(Ge.instance,this._gpuInputAssembler),this._gpuPointSampler={glMinFilter:9728,glMagFilter:9728,glWrapS:10497,glWrapT:10497,glWrapR:10497},this._gpuLinearSampler={glMinFilter:9729,glMagFilter:9729,glWrapS:10497,glWrapT:10497,glWrapR:10497},this._uniformBuffer=new Float32Array(8),this._gpuUniformBuffer={usage:b.UNIFORM,memUsage:x.DEVICE,size:8*Float32Array.BYTES_PER_ELEMENT,stride:8*Float32Array.BYTES_PER_ELEMENT,buffer:this._uniformBuffer,vf32:null,indirects:new Tt,glTarget:0,glBuffer:null},Je(Ge.instance,this._gpuUniformBuffer),Ge.instance.memoryStatus.bufferSize+=this._gpuUniformBuffer.size,this._gpuDescriptorSet={gpuDescriptors:[{type:Y.UNIFORM_BUFFER,gpuBuffer:this._gpuUniformBuffer,gpuTexture:null,gpuSampler:null},{type:Y.SAMPLER_TEXTURE,gpuBuffer:null,gpuTexture:null,gpuSampler:null}],descriptorIndices:this._gpuDescriptorSetLayout.descriptorIndices},this._drawInfo=new B(4,0,0,0,0,0,0),this._glFramebuffer=Ge.instance.gl.createFramebuffer()}var t=e.prototype;return t.destroy=function(){this._glFramebuffer&&(Ge.instance.gl.deleteFramebuffer(this._glFramebuffer),this._glFramebuffer=null),this._gpuVertexBuffer&&(Ge.instance.memoryStatus.bufferSize-=this._gpuVertexBuffer.size,$e(Ge.instance,this._gpuVertexBuffer)),this._gpuUniformBuffer&&(Ge.instance.memoryStatus.bufferSize-=this._gpuUniformBuffer.size,$e(Ge.instance,this._gpuUniformBuffer)),this._gpuShader&&rt(Ge.instance,this._gpuShader),this._gpuInputAssembler&&at(Ge.instance,this._gpuInputAssembler)},t.draw=function(e,t,r,s){var a=Ge.instance,i=a.gl,n=a.stateCache,u=n.glFramebuffer;if(i.viewport(0,0,t.width,t.height),i.scissor(0,0,t.width,t.height),this._uniformBuffer&&this._gpuUniformBuffer&&this._gpuPipelineState&&this._gpuInputAssembler&&this._gpuDescriptorSet&&this._drawInfo){var l=this._gpuDescriptorSet.gpuDescriptors[1];l.gpuTexture=e,l.gpuSampler=s===C.POINT?this._gpuPointSampler:this._gpuLinearSampler;var _=F[t.format],o=i.COLOR_ATTACHMENT0;_.hasStencil?o=i.DEPTH_STENCIL_ATTACHMENT:_.hasDepth&&(o=i.DEPTH_ATTACHMENT);var f=r.map((function(e,t){return t}));f.sort((function(e,t){return r[e].srcSubres.mipLevel-r[t].srcSubres.mipLevel})),n.glFramebuffer!==this._glFramebuffer&&(a.gl.bindFramebuffer(a.gl.FRAMEBUFFER,this._glFramebuffer),n.glFramebuffer=this._glFramebuffer);var c=r[0].dstSubres.mipLevel;t.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,o,t.glTarget,t.glTexture,c):i.framebufferRenderbuffer(i.FRAMEBUFFER,o,i.RENDERBUFFER,t.glRenderbuffer);for(var h=0;h<f.length;++h){var E=r[f[h]];e.glTexture&&c!==E.srcSubres.mipLevel&&(c=E.srcSubres.mipLevel,i.framebufferTexture2D(i.FRAMEBUFFER,o,t.glTarget,t.glTexture,c));var g=e.width,T=e.height,d=t.width,R=t.height;this._uniformBuffer[0]=E.srcExtent.width/g,this._uniformBuffer[1]=E.srcExtent.height/T,this._uniformBuffer[2]=E.srcOffset.x/g,this._uniformBuffer[3]=E.srcOffset.y/T,this._uniformBuffer[4]=E.dstExtent.width/d,this._uniformBuffer[5]=E.dstExtent.height/R,this._uniformBuffer[6]=E.dstOffset.x/d,this._uniformBuffer[7]=E.dstOffset.y/R,et(a,this._gpuUniformBuffer,this._uniformBuffer,0,this._uniformBuffer.length*Float32Array.BYTES_PER_ELEMENT),lt(a,this._gpuPipelineState,this._gpuInputAssembler,[this._gpuDescriptorSet],[],null),_t(a,this._drawInfo)}n.glFramebuffer!==u&&(a.gl.bindFramebuffer(a.gl.FRAMEBUFFER,u),n.glFramebuffer=u);var S=n.viewport;i.viewport(S.left,S.top,S.width,S.height);var A=n.scissorRect;i.scissor(A.x,A.y,A.width,A.height)}},e}(),Rt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&b.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new Tt,glTarget:0,glBuffer:null},this._usage&b.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),Je(Ge.instance,this._gpuBuffer),Ge.instance.memoryStatus.bufferSize+=this._size},a.destroy=function(){this._gpuBuffer&&($e(Ge.instance,this._gpuBuffer),Ge.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},a.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t,r,s,a,i,n=this._size;n!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(t=Ge.instance,r=this._gpuBuffer,s=t.gl,a=t.stateCache,i=r.memUsage&x.HOST?s.DYNAMIC_DRAW:s.STATIC_DRAW,r.usage&b.VERTEX?(t.extensions.useVAO&&a.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),it.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ARRAY_BUFFER,r.buffer,i):s.bufferData(s.ARRAY_BUFFER,r.size,i),s.bindBuffer(s.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):r.usage&b.INDEX?(t.extensions.useVAO&&a.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=null),it.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==r.glBuffer&&s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glBuffer),r.buffer?s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.buffer,i):s.bufferData(s.ELEMENT_ARRAY_BUFFER,r.size,i),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):r.usage&b.UNIFORM?r.buffer&&(r.vf32=new Float32Array(r.buffer.buffer)):(r.usage&b.INDIRECT||r.usage&b.TRANSFER_DST||r.usage&b.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),r.glTarget=s.NONE),Ge.instance.memoryStatus.bufferSize-=n,Ge.instance.memoryStatus.bufferSize+=e)))}},a.update=function(e,t){var r;this._isBufferView?console.warn("cannot update through buffer views!"):(r=void 0!==t?t:this._usage&b.INDIRECT?0:e.byteLength,et(Ge.instance,this._gpuBuffer,e,0,r))},r(s,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),s}(Z),St=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new u(t);for(var r=0;r<t;++r)this._frees[r]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,r=this._frees;this._frees=new Array(t);for(var s=t-r.length,a=0;a<s;++a)this._frees[a]=new e;for(var i=s,n=0;i<t;++i,++n)this._frees[i]=r[n];this._freeIdx+=s}var u=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++u.refCount,u},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),At=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.blitTextureCmdPool=void 0,this.beginRenderPassCmdPool=new St(ze,1),this.bindStatesCmdPool=new St(Ke,1),this.drawCmdPool=new St(Ye,1),this.updateBufferCmdPool=new St(je,1),this.copyBufferToTextureCmdPool=new St(qe,1),this.blitTextureCmdPool=new St(Ze,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.blitTextureCmds.length&&(this.blitTextureCmdPool.freeCmds(e.blitTextureCmds),e.blitTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release(),this.blitTextureCmdPool.release()},e}(),pt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).cmdPackage=new Qe,t._cmdAllocator=new At,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new m,t._isStateInvalied=!1,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=Ge.instance.bindingMappings.blockOffsets.length,r=0;r<t;r++)this._curGPUDescriptorSets.push(null)},s.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},s.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},s.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},s.beginRenderPass=function(e,t,r,s,a,i){var n=this._cmdAllocator.beginRenderPassCmdPool.alloc(ze);n.gpuRenderPass=e.gpuRenderPass,n.gpuFramebuffer=t.gpuFramebuffer,n.renderArea.copy(r),n.clearColors.length=s.length;for(var u=0;u<s.length;++u)n.clearColors[u]=s[u];n.clearDepth=a,n.clearStencil=i,this.cmdPackage.beginRenderPassCmds.push(n),this.cmdPackage.cmds.push(Ue.BEGIN_RENDER_PASS),this._isInRenderPass=!0},s.endRenderPass=function(){this._isInRenderPass=!1},s.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},s.bindDescriptorSet=function(e,t,r){var s=t.gpuDescriptorSet;if(s!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=s,this._isStateInvalied=!0),r){var a,i=null===(a=this._curGPUPipelineState)||void 0===a?void 0:a.gpuPipelineLayout;if(i){for(var n=this._curDynamicOffsets,u=i.dynamicOffsetOffsets[e],l=0;l<r.length;l++)n[u+l]=r[l];this._isStateInvalied=!0}}},s.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},s.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},s.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},s.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},s.setDepthBias=function(e,t,r){var s=this._curDynamicStates;s.depthBiasConstant===e&&s.depthBiasClamp===t&&s.depthBiasSlope===r||(s.depthBiasConstant=e,s.depthBiasClamp=t,s.depthBiasSlope=r,this._isStateInvalied=!0)},s.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},s.setDepthBound=function(e,t){var r=this._curDynamicStates;r.depthMinBounds===e&&r.depthMaxBounds===t||(r.depthMinBounds=e,r.depthMaxBounds=t,this._isStateInvalied=!0)},s.setStencilWriteMask=function(e,t){var r=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;e&Q.FRONT&&r.writeMask!==t&&(r.writeMask=t,this._isStateInvalied=!0),e&Q.BACK&&s.writeMask!==t&&(s.writeMask=t,this._isStateInvalied=!0)},s.setStencilCompareMask=function(e,t,r){var s=this._curDynamicStates.stencilStatesFront,a=this._curDynamicStates.stencilStatesBack;e&Q.FRONT&&(s.compareMask===r&&s.reference===t||(s.reference=t,s.compareMask=r,this._isStateInvalied=!0)),e&Q.BACK&&(a.compareMask===r&&a.reference===t||(a.reference=t,a.compareMask=r,this._isStateInvalied=!0))},s.draw=function(e){if(this._type===J.PRIMARY&&this._isInRenderPass||this._type===J.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,r=this._cmdAllocator.drawCmdPool.alloc(Ye);r.drawInfo.copy(t),this.cmdPackage.drawCmds.push(r),this.cmdPackage.cmds.push(Ue.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var s=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=s/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(s-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.updateBuffer=function(e,t,r){if(this._type===J.PRIMARY&&!this._isInRenderPass||this._type===J.SECONDARY){var s=e.gpuBuffer;if(s){var a,i=this._cmdAllocator.updateBufferCmdPool.alloc(je),n=0;e.usage&b.INDIRECT||(n=void 0!==r?r:t.byteLength),a=t,i.gpuBuffer=s,i.buffer=a,i.offset=0,i.size=n,this.cmdPackage.updateBufferCmds.push(i),this.cmdPackage.cmds.push(Ue.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},s.copyBuffersToTexture=function(e,t,r){if(this._type===J.PRIMARY&&!this._isInRenderPass||this._type===J.SECONDARY){var s=t.gpuTexture;if(s){var a=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(qe);a&&(a.gpuTexture=s,a.regions=r,a.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(a),this.cmdPackage.cmds.push(Ue.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},s.execute=function(e,t){for(var r=0;r<t;++r){for(var s=e[r],a=0;a<s.cmdPackage.beginRenderPassCmds.length;++a){var i=s.cmdPackage.beginRenderPassCmds.array[a];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(var n=0;n<s.cmdPackage.bindStatesCmds.length;++n){var u=s.cmdPackage.bindStatesCmds.array[n];++u.refCount,this.cmdPackage.bindStatesCmds.push(u)}for(var l=0;l<s.cmdPackage.drawCmds.length;++l){var _=s.cmdPackage.drawCmds.array[l];++_.refCount,this.cmdPackage.drawCmds.push(_)}for(var o=0;o<s.cmdPackage.updateBufferCmds.length;++o){var f=s.cmdPackage.updateBufferCmds.array[o];++f.refCount,this.cmdPackage.updateBufferCmds.push(f)}for(var c=0;c<s.cmdPackage.copyBufferToTextureCmds.length;++c){var h=s.cmdPackage.copyBufferToTextureCmds.array[c];++h.refCount,this.cmdPackage.copyBufferToTextureCmds.push(h)}for(var E=0;E<s.cmdPackage.blitTextureCmds.length;++E){var g=s.cmdPackage.blitTextureCmds.array[E];++g.refCount,this.cmdPackage.blitTextureCmds.push(g)}this.cmdPackage.cmds.concat(s.cmdPackage.cmds.array),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.pipelineBarrier=function(){},s.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(Ke);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(Ue.BIND_STATES),this._isStateInvalied=!1)},s.blitTexture=function(e,t,r,s){var a=this._cmdAllocator.blitTextureCmdPool.alloc(Ze);a.srcTexture=e.gpuTexture,a.dstTexture=t.gpuTexture,a.regions=r,a.filter=s,++this._numDrawCalls,this.cmdPackage.blitTextureCmds.push(a),this.cmdPackage.cmds.push(Ue.BLIT_TEXTURE)},r}($),mt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuFramebuffer=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=0,r=[],s=0;s<e.colorTextures.length;++s){var a=e.colorTextures[s];a&&(r.push(a.gpuTexture),t=a.lodLevel)}var i=null;e.depthStencilTexture&&(i=e.depthStencilTexture.gpuTexture,t=e.depthStencilTexture.lodLevel);var n=Number.MAX_SAFE_INTEGER,u=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:r,gpuDepthStencilTexture:i,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?n:this.gpuColorTextures[0].width},set width(e){n=e},get height(){return this.isOffscreen?u:this.gpuColorTextures[0].height},set height(e){u=e},lodLevel:t},function(e,t){for(var r=0;r<t.gpuColorTextures.length;++r)if(t.gpuColorTextures[r].isSwapchainTexture)return void(t.isOffscreen=!1);var s=e.gl,a=[],i=s.createFramebuffer();if(i){t.glFramebuffer=i,e.stateCache.glFramebuffer!==t.glFramebuffer&&s.bindFramebuffer(s.FRAMEBUFFER,t.glFramebuffer);for(var n=0;n<t.gpuColorTextures.length;++n){var u=t.gpuColorTextures[n];u&&(u.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+n,u.glTarget,u.glTexture,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+n,s.RENDERBUFFER,u.glRenderbuffer),a.push(s.COLOR_ATTACHMENT0+n),t.width=Math.min(t.width,u.width),t.height=Math.min(t.height,u.height))}var l=t.gpuDepthStencilTexture;if(l){var _=F[l.format].hasStencil?s.DEPTH_STENCIL_ATTACHMENT:s.DEPTH_ATTACHMENT;l.glTexture?s.framebufferTexture2D(s.FRAMEBUFFER,_,l.glTarget,l.glTexture,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,_,s.RENDERBUFFER,l.glRenderbuffer),t.width=Math.min(t.width,l.width),t.height=Math.min(t.height,l.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(a);var o=s.checkFramebufferStatus(s.FRAMEBUFFER);if(o!==s.FRAMEBUFFER_COMPLETE)switch(o){case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case s.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&s.bindFramebuffer(s.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(Ge.instance,this._gpuFramebuffer)},a.destroy=function(){var e,t;this._gpuFramebuffer&&(e=Ge.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},r(s,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),s}(ee),Bt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuInputAssembler=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var r=new Array(e.vertexBuffers.length),s=0;s<e.vertexBuffers.length;++s){var a=e.vertexBuffers[s];a.gpuBuffer&&(r[s]=a.gpuBuffer)}var i=null,n=0;if(e.indexBuffer&&(i=e.indexBuffer.gpuBuffer))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}var u=null;e.indirectBuffer&&(u=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:r,gpuIndexBuffer:i,gpuIndirectBuffer:u,glAttribs:[],glIndexType:n,glVAOs:new Map},st(Ge.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},a.destroy=function(){var e=Ge.instance;this._gpuInputAssembler&&e.extensions.useVAO&&at(e,this._gpuInputAssembler),this._gpuInputAssembler=null},r(s,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),s}(te),Ct=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuDescriptorSetLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,r=-1,s=[],a=0;a<this._bindings.length;a++){var i=this._bindings[a];s.push(t),t+=i.count,i.binding>r&&(r=i.binding)}this._bindingIndices=Array(r+1).fill(-1);for(var n=this._descriptorIndices=Array(r+1).fill(-1),u=0;u<this._bindings.length;u++){var l=this._bindings[u];this._bindingIndices[l.binding]=u,n[l.binding]=s[u]}for(var _=[],o=0;o<this._bindings.length;o++){var f=this._bindings[o];if(f.descriptorType&re)for(var c=0;c<f.count;c++)_.push(f.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:_,descriptorIndices:n,descriptorCount:t}},a.destroy=function(){this._bindings.length=0},r(s,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),s}(se),xt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineLayout=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],r=[],s=0,a=[],i=0;i<this._setLayouts.length;i++){for(var n=this._setLayouts[i],u=n.gpuDescriptorSetLayout.dynamicBindings,l=Array(n.bindingIndices.length).fill(-1),_=0;_<u.length;_++){var o=u[_];l[o]<0&&(l[o]=s+_)}r.push(n.gpuDescriptorSetLayout),t.push(l),a.push(s),s+=u.length}this._gpuPipelineLayout={gpuSetLayouts:r,dynamicOffsetIndices:t,dynamicOffsetCount:s,dynamicOffsetOffsets:a}},a.destroy=function(){this._setLayouts.length=0},r(s,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),s}(ae),bt=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],Pt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuPipelineState=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var r=e.blendState,s=r.targets;s&&s.forEach((function(e,r){t.setTarget(r,e)})),void 0!==r.isA2C&&(t.isA2C=r.isA2C),void 0!==r.isIndepend&&(t.isIndepend=r.isIndepend),void 0!==r.blendColor&&(t.blendColor=r.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var a=[],i=0;i<31;i++)this._dynamicStates&1<<i&&a.push(1<<i);this._gpuPipelineState={glPrimitive:bt[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:a}},a.destroy=function(){this._gpuPipelineState=null},r(s,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),s}(ie),Ft=function(e){function r(){return e.apply(this,arguments)||this}t(r,e);var s=r.prototype;return s.beginRenderPass=function(e,t,r,s,a,i){ut(Ge.instance,e.gpuRenderPass,t.gpuFramebuffer,r,s,a,i),this._isInRenderPass=!0},s.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;_t(Ge.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var r=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=r/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(r-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},s.setViewport=function(e){var t=Ge.instance,r=t.stateCache,s=t.gl;r.viewport.left===e.left&&r.viewport.top===e.top&&r.viewport.width===e.width&&r.viewport.height===e.height||(s.viewport(e.left,e.top,e.width,e.height),r.viewport.left=e.left,r.viewport.top=e.top,r.viewport.width=e.width,r.viewport.height=e.height)},s.setScissor=function(e){var t=Ge.instance,r=t.stateCache,s=t.gl;r.scissorRect.x===e.x&&r.scissorRect.y===e.y&&r.scissorRect.width===e.width&&r.scissorRect.height===e.height||(s.scissor(e.x,e.y,e.width,e.height),r.scissorRect.x=e.x,r.scissorRect.y=e.y,r.scissorRect.width=e.width,r.scissorRect.height=e.height)},s.updateBuffer=function(e,t,r){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var s,a=e.gpuBuffer;a&&(s=void 0!==r?r:e.usage&b.INDIRECT?0:t.byteLength,et(Ge.instance,a,t,0,s))}},s.copyBuffersToTexture=function(e,t,r){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var s=t.gpuTexture;s&&Et(Ge.instance,e,s,r)}},s.execute=function(e,t){for(var r=0;r<t;++r){var s=e[r];ft(Ge.instance,s.cmdPackage),this._numDrawCalls+=s._numDrawCalls,this._numInstances+=s._numInstances,this._numTris+=s._numTris}},s.bindStates=function(){lt(Ge.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},s.blitTexture=function(e,t,r,s){var a=e.gpuTexture,i=t.gpuTexture;gt(Ge.instance,a,i,r,s)},r}(pt),vt=function(e){function r(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}t(r,e);var s=r.prototype;return s.initialize=function(e){this._type=e.type},s.destroy=function(){},s.submit=function(e){for(var t=e.length,r=0;r<t;r++){var s=e[r];this.numDrawCalls+=s.numDrawCalls,this.numInstances+=s.numInstances,this.numTris+=s.numTris}},s.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},r}(ne),yt=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuRenderPass=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},a.destroy=function(){this._gpuRenderPass=null},r(s,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),s}(ue),Ot=[10497,33648,33071,33071],Gt=function(e){function s(t,r){var s;(s=e.call(this,t,r)||this)._gpuSampler=null;var a,i,n=s._info.minFilter,u=s._info.magFilter,l=s._info.mipFilter;a=n===C.LINEAR||n===C.ANISOTROPIC?l===C.LINEAR||l===C.ANISOTROPIC?9987:l===C.POINT?9985:9729:l===C.LINEAR||l===C.ANISOTROPIC?9986:l===C.POINT?9984:9728,i=u===C.LINEAR||u===C.ANISOTROPIC?9729:9728;var _=Ot[s._info.addressU],o=Ot[s._info.addressV],f=Ot[s._info.addressW];return s._gpuSampler={glMinFilter:a,glMagFilter:i,glWrapS:_,glWrapT:o,glWrapR:f},s}return t(s,e),r(s,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),s}(le),It=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuShader=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var r=e.stages[t];this._gpuShader.gpuStages[t]={type:r.stage,source:r.source,glShader:null}}},a.destroy=function(){this._gpuShader&&(rt(Ge.instance,this._gpuShader),this._gpuShader=null)},r(s,[{key:"gpuShader",get:function(){return null===this._gpuShader.glProgram&&tt(Ge.instance,this._gpuShader),this._gpuShader}}]),s}(_e),Lt=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new oe,this.scissorRect=new A(0,0,0,0),this.rs=new fe,this.dss=new j,this.bs=new ce,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var r=0;r<e;++r)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),Mt=function(e){function a(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._gpuTexture=null,t._lodLevel=0,t}t(a,e);var i=a.prototype;return i.initialize=function(e,t){var r=e,a=e;"texture"in e&&(r=a.texture.info,this._isTextureView=!0),this._info.copy(r),this._isPowerOf2=he(this._info.width)&&he(this._info.height),this._size=Ee(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(a),this._lodLevel=a.baseLevel,this._gpuTexture=a.texture._gpuTexture):(this._gpuTexture={type:r.type,format:r.format,usage:r.usage,width:r.width,height:r.height,depth:r.depth,size:this._size,arrayLayer:r.layerCount,mipLevel:r.levelCount,samples:r.samples,flags:r.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},this._gpuTexture.isSwapchainTexture||(function(e,t){var r=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case y.A8:return t.ALPHA;case y.L8:return t.LUMINANCE;case y.LA8:return t.LUMINANCE_ALPHA;case y.RGB8:case y.RGB16F:case y.RGB32F:return t.RGB;case y.BGRA8:case y.RGBA8:case y.SRGB8_A8:case y.RGBA16F:case y.RGBA32F:return t.RGBA;case y.R5G6B5:return t.RGB;case y.RGB5A1:case y.RGBA4:return t.RGBA;case y.DEPTH:return t.DEPTH_COMPONENT;case y.DEPTH_STENCIL:return t.DEPTH_STENCIL;case y.BC1:return ye.COMPRESSED_RGB_S3TC_DXT1_EXT;case y.BC1_ALPHA:return ye.COMPRESSED_RGBA_S3TC_DXT1_EXT;case y.BC1_SRGB:return ye.COMPRESSED_SRGB_S3TC_DXT1_EXT;case y.BC1_SRGB_ALPHA:return ye.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case y.BC2:return ye.COMPRESSED_RGBA_S3TC_DXT3_EXT;case y.BC2_SRGB:return ye.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case y.BC3:return ye.COMPRESSED_RGBA_S3TC_DXT5_EXT;case y.BC3_SRGB:return ye.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case y.ETC_RGB8:return ye.COMPRESSED_RGB_ETC1_WEBGL;case y.ETC2_RGB8:return ye.COMPRESSED_RGB8_ETC2;case y.ETC2_SRGB8:return ye.COMPRESSED_SRGB8_ETC2;case y.ETC2_RGB8_A1:return ye.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case y.ETC2_SRGB8_A1:return ye.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case y.ETC2_RGBA8:return ye.COMPRESSED_RGBA8_ETC2_EAC;case y.ETC2_SRGB8_A8:return ye.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case y.EAC_R11:return ye.COMPRESSED_R11_EAC;case y.EAC_R11SN:return ye.COMPRESSED_SIGNED_R11_EAC;case y.EAC_RG11:return ye.COMPRESSED_RG11_EAC;case y.EAC_RG11SN:return ye.COMPRESSED_SIGNED_RG11_EAC;case y.PVRTC_RGB2:return ye.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case y.PVRTC_RGBA2:return ye.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case y.PVRTC_RGB4:return ye.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case y.PVRTC_RGBA4:return ye.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case y.ASTC_RGBA_4X4:return ye.COMPRESSED_RGBA_ASTC_4x4_KHR;case y.ASTC_RGBA_5X4:return ye.COMPRESSED_RGBA_ASTC_5x4_KHR;case y.ASTC_RGBA_5X5:return ye.COMPRESSED_RGBA_ASTC_5x5_KHR;case y.ASTC_RGBA_6X5:return ye.COMPRESSED_RGBA_ASTC_6x5_KHR;case y.ASTC_RGBA_6X6:return ye.COMPRESSED_RGBA_ASTC_6x6_KHR;case y.ASTC_RGBA_8X5:return ye.COMPRESSED_RGBA_ASTC_8x5_KHR;case y.ASTC_RGBA_8X6:return ye.COMPRESSED_RGBA_ASTC_8x6_KHR;case y.ASTC_RGBA_8X8:return ye.COMPRESSED_RGBA_ASTC_8x8_KHR;case y.ASTC_RGBA_10X5:return ye.COMPRESSED_RGBA_ASTC_10x5_KHR;case y.ASTC_RGBA_10X6:return ye.COMPRESSED_RGBA_ASTC_10x6_KHR;case y.ASTC_RGBA_10X8:return ye.COMPRESSED_RGBA_ASTC_10x8_KHR;case y.ASTC_RGBA_10X10:return ye.COMPRESSED_RGBA_ASTC_10x10_KHR;case y.ASTC_RGBA_12X10:return ye.COMPRESSED_RGBA_ASTC_12x10_KHR;case y.ASTC_RGBA_12X12:return ye.COMPRESSED_RGBA_ASTC_12x12_KHR;case y.ASTC_SRGBA_4X4:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case y.ASTC_SRGBA_5X4:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case y.ASTC_SRGBA_5X5:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case y.ASTC_SRGBA_6X5:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case y.ASTC_SRGBA_6X6:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case y.ASTC_SRGBA_8X5:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case y.ASTC_SRGBA_8X6:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case y.ASTC_SRGBA_8X8:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case y.ASTC_SRGBA_10X5:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case y.ASTC_SRGBA_10X6:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case y.ASTC_SRGBA_10X8:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case y.ASTC_SRGBA_10X10:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case y.ASTC_SRGBA_12X10:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case y.ASTC_SRGBA_12X12:return ye.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,r),t.glType=Ie(t.format,r);var a=t.width,i=t.height;switch(t.type){case P.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(a,i);if(n>e.capabilities.maxTextureSize&&s(9100,n,e.capabilities.maxTextureSize),e.textureExclusive[t.format]||e.extensions.WEBGL_depth_texture||!F[t.format].hasDepth){if(t.glTexture=r.createTexture(),t.size>0){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),F[t.format].isCompressed)for(var l=0;l<t.mipLevel;++l){var _=v(t.format,a,i,1),o=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_2D,l,t.glInternalFmt,a,i,0,o),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}else for(var f=0;f<t.mipLevel;++f)r.texImage2D(r.TEXTURE_2D,f,t.glInternalFmt,a,i,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),i=Math.max(1,i>>1);t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}}else t.glInternalFmt=function(e,t){switch(e){case y.R5G6B5:return t.RGB565;case y.RGB5A1:return t.RGB5_A1;case y.RGBA4:return t.RGBA4;case y.RGBA16F:return ye.RGBA16F_EXT;case y.RGBA32F:return ye.RGBA32F_EXT;case y.SRGB8_A8:return ye.SRGB8_ALPHA8_EXT;case y.DEPTH:return t.DEPTH_COMPONENT16;case y.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,r),t.glRenderbuffer=r.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,a,i));break;case P.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var c=Math.max(a,i);if(c>e.capabilities.maxCubeMapTextureSize&&s(9100,c,e.capabilities.maxTextureSize),t.glTexture=r.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),F[t.format].isCompressed)for(var E=0;E<6;++E){a=t.width,i=t.height;for(var g=0;g<t.mipLevel;++g){var T=v(t.format,a,i,1),d=new Uint8Array(T);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+E,g,t.glInternalFmt,a,i,0,d),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}}else for(var R=0;R<6;++R){a=t.width,i=t.height;for(var S=0;S<t.mipLevel;++S)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+R,S,t.glInternalFmt,a,i,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}t.isPowerOf2?(t.glWrapS=r.REPEAT,t.glWrapT=r.REPEAT):(t.glWrapS=r.CLAMP_TO_EDGE,t.glWrapT=r.CLAMP_TO_EDGE),t.glMinFilter=r.LINEAR,t.glMagFilter=r.LINEAR,r.texParameteri(t.glTarget,r.TEXTURE_WRAP_S,t.glWrapS),r.texParameteri(t.glTarget,r.TEXTURE_WRAP_T,t.glWrapT),r.texParameteri(t.glTarget,r.TEXTURE_MIN_FILTER,t.glMinFilter),r.texParameteri(t.glTarget,r.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=P.TEX2D,t.glTarget=r.TEXTURE_2D}}(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize+=this._size),this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount)},i.destroy=function(){!this._isTextureView&&this._gpuTexture&&(function(e,t){var r=e.gl;if(t.glTexture){var s=e.stateCache.glTexUnits,a=e.stateCache.texUnit;r.deleteTexture(t.glTexture);for(var i=0;i<s.length;i++)s[i].glTexture===t.glTexture&&(r.activeTexture(r.TEXTURE0+i),a=i,r.bindTexture(t.glTarget,null),s[i].glTexture=null);e.stateCache.texUnit=a,t.glTexture=null}if(t.glRenderbuffer){var n=e.stateCache.glRenderbuffer;r.deleteRenderbuffer(t.glRenderbuffer),n===t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,null),n=null),t.glRenderbuffer=null}}(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},i.getGLTextureHandle=function(){var e=this._gpuTexture;return e?e.glTexture?e.glTexture:e.glRenderbuffer?e.glRenderbuffer:0:0},i.resize=function(e,t){if(this._info.width!==e||this._info.height!==t){this._info.levelCount===a.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=a.getLevelCount(e,t):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,a.getLevelCount(e,t)));var r=this._size;this._info.width=e,this._info.height=t,this._size=Ee(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,this._gpuTexture.isSwapchainTexture||(function(e,t){if(t.size){var r=e.gl,a=t.width,i=t.height;switch(t.type){case P.TEX2D:t.glTarget=r.TEXTURE_2D;var n=Math.max(a,i);if(n>e.capabilities.maxTextureSize&&s(9100,n,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(r.bindRenderbuffer(r.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),r.renderbufferStorage(r.RENDERBUFFER,t.glInternalFmt,a,i);else if(t.glTexture){var u=e.stateCache.glTexUnits[e.stateCache.texUnit];if(u.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_2D,t.glTexture),u.glTexture=t.glTexture),F[t.format].isCompressed)for(var l=0;l<t.mipLevel;++l){var _=v(t.format,a,i,1),o=new Uint8Array(_);r.compressedTexImage2D(r.TEXTURE_2D,l,t.glInternalFmt,a,i,0,o),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}else for(var f=0;f<t.mipLevel;++f)r.texImage2D(r.TEXTURE_2D,f,t.glInternalFmt,a,i,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}break;case P.CUBE:t.glTarget=r.TEXTURE_CUBE_MAP;var c=Math.max(a,i);c>e.capabilities.maxCubeMapTextureSize&&s(9100,c,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(r.bindTexture(r.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),F[t.format].isCompressed)for(var E=0;E<6;++E){a=t.width,i=t.height;for(var g=0;g<t.mipLevel;++g){var T=v(t.format,a,i,1),d=new Uint8Array(T);r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+E,g,t.glInternalFmt,a,i,0,d),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}}else for(var R=0;R<6;++R){a=t.width,i=t.height;for(var S=0;S<t.mipLevel;++S)r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+R,S,t.glInternalFmt,a,i,0,t.glFormat,t.glType,null),a=Math.max(1,a>>1),i=Math.max(1,i>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=P.TEX2D,t.glTarget=r.TEXTURE_2D}}}(Ge.instance,this._gpuTexture),Ge.instance.memoryStatus.textureSize-=r,Ge.instance.memoryStatus.textureSize+=this._size))}},i.initAsSwapchainTexture=function(e){var t=new ge;t.format=e.format,t.usage=F[e.format].hasDepth?Te.DEPTH_STENCIL_ATTACHMENT:Te.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},r(a,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}}]),a}(de),Dt="webglcontextlost";function wt(e,t){for(var r=["","WEBKIT_","MOZ_"],s=0;s<r.length;++s){var a=e.getExtension(r[s]+t);if(a)return a}return null}function Nt(e){var t={EXT_texture_filter_anisotropic:wt(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:wt(e,"EXT_blend_minmax"),EXT_frag_depth:wt(e,"EXT_frag_depth"),EXT_shader_texture_lod:wt(e,"EXT_shader_texture_lod"),EXT_sRGB:wt(e,"EXT_sRGB"),OES_vertex_array_object:wt(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:wt(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:wt(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:wt(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:wt(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:wt(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:wt(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:wt(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:wt(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:wt(e,"WEBGL_draw_buffers"),WEBGL_lose_context:wt(e,"WEBGL_lose_context"),WEBGL_depth_texture:wt(e,"WEBGL_depth_texture"),OES_texture_half_float:wt(e,"OES_texture_half_float"),OES_texture_half_float_linear:wt(e,"OES_texture_half_float_linear"),OES_texture_float:wt(e,"OES_texture_float"),OES_texture_float_linear:wt(e,"OES_texture_float_linear"),OES_standard_derivatives:wt(e,"OES_standard_derivatives"),OES_element_index_uint:wt(e,"OES_element_index_uint"),ANGLE_instanced_arrays:wt(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:wt(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return f.os===c.IOS&&14===f.osMainVersion&&f.isBrowser||(t.WEBGL_compressed_texture_astc=wt(e,"WEBGL_compressed_texture_astc")),f.os!==c.ANDROID&&f.os!==c.IOS&&(t.WEBGL_multi_draw=wt(e,"WEBGL_multi_draw")),f.browserType===h.UC&&(t.ANGLE_instanced_arrays=null),(f.os===c.IOS&&f.osMainVersion<=10||f.os===c.ANDROID)&&(t.destroyShadersImmediately=!1),t.isLocationActive=function(e){return!!e&&-1!==e.id},t.noCompressedTexSubImage2D=!0,t.OES_vertex_array_object&&(t.useVAO=!0),t}var Ut=function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this).stateCache=new Lt,t.cmdAllocator=new At,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t._blitManager=null,t}t(s,e);var a=s.prototype;return a.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Dt,this._onWebGLContextLost);var t=Ge.instance.gl;this.stateCache.initialize(Ge.instance.capabilities.maxTextureUnits,Ge.instance.capabilities.maxVertexAttributes),this._extensions=Nt(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var r=y.RGBA8,s=y.DEPTH_STENCIL,a=t.getParameter(t.DEPTH_BITS),i=t.getParameter(t.STENCIL_BITS);a&&i?s=y.DEPTH_STENCIL:a&&(s=y.DEPTH),this._colorTexture=new Mt,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:r,width:e.width,height:e.height}),this._depthStencilTexture=new Mt,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:s,width:e.width,height:e.height}),this.nullTex2D=Ge.instance.createTexture(new ge(P.TEX2D,Te.SAMPLED,y.RGBA8,2,2,M.GEN_MIPMAP)),this.nullTexCube=Ge.instance.createTexture(new ge(P.CUBE,Te.SAMPLED,y.RGBA8,2,2,M.GEN_MIPMAP,6));var n=new Re;n.texExtent.width=2,n.texExtent.height=2;var u=new Uint8Array(this.nullTex2D.size);u.fill(0),Ge.instance.copyBuffersToTexture([u],this.nullTex2D,[n]),n.texSubres.layerCount=6,Ge.instance.copyBuffersToTexture([u,u,u,u,u,u],this.nullTexCube,[n]),this._blitManager=new dt},a.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(Dt,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._blitManager&&(this._blitManager.destroy(),this._blitManager=null),this._extensions=null,this._canvas=null},a.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(i("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},a._onWebGLContextLost=function(e){_(11e3),o(e)},r(s,[{key:"extensions",get:function(){return this._extensions}},{key:"blitManager",get:function(){return this._blitManager}}]),s}(Se),kt=e("WebGLDevice",function(e){function s(){for(var t,r=arguments.length,s=new Array(r),a=0;a<r;a++)s[a]=arguments[a];return(t=e.call.apply(e,[this].concat(s))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(y.COUNT),t}t(s,e);var a=s.prototype;return a.initialize=function(e){Ge.setInstance(this),this._gfxAPI=Ae.WEBGL;var t=this._bindingMappingInfo=e.bindingMappingInfo,r=[],s=[],a=t.setIndices[0];r[a]=0,s[a]=0;for(var n=1;n<t.setIndices.length;++n){var u=t.setIndices[n],l=t.setIndices[n-1];r[u]=t.maxBlockCounts[l]+r[l],s[u]=t.maxSamplerTextureCounts[l]+s[l]}for(var _=0;_<t.setIndices.length;++_){var o=t.setIndices[_];s[o]-=t.maxBlockCounts[o]}this._bindingMappings={blockOffsets:r,samplerTextureOffsets:s,flexibleSet:t.setIndices[t.setIndices.length-1]};var f=this._context=function(e){var t=null;try{var r={alpha:E.ENABLE_TRANSPARENT_CANVAS,antialias:g||E.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",r)}catch(e){return null}return t}(pe.canvas);if(!f)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new me(Be.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Ce(this._queue)),this._caps.maxVertexAttributes=f.getParameter(f.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=f.getParameter(f.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=f.getParameter(f.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=f.getParameter(f.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=f.getParameter(f.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=f.getParameter(f.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=f.getParameter(f.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxArrayTextureLayers=0,this._caps.max3DTextureSize=0,this._caps.maxUniformBufferBindings=16;var c=f.getSupportedExtensions(),h="";if(c)for(var d,R=T(c);!(d=R()).done;)h+=d.value+" ";var S=Nt(f);S.WEBGL_debug_renderer_info?(this._renderer=f.getParameter(S.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=f.getParameter(S.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=f.getParameter(f.RENDERER),this._vendor=f.getParameter(f.VENDOR));var A=f.getParameter(f.VERSION);this._features.fill(!1),this.initFormatFeatures(S),S.EXT_blend_minmax&&(this._features[xe.BLEND_MINMAX]=!0),S.OES_element_index_uint&&(this._features[xe.ELEMENT_INDEX_UINT]=!0),S.ANGLE_instanced_arrays&&(this._features[xe.INSTANCED_ARRAYS]=!0),S.WEBGL_draw_buffers&&(this._features[xe.MULTIPLE_RENDER_TARGETS]=!0);var p="";return this.getFormatFeatures(y.ETC_RGB8)&&(p+="etc1 "),this.getFormatFeatures(y.ETC2_RGB8)&&(p+="etc2 "),this.getFormatFeatures(y.BC1)&&(p+="dxt "),this.getFormatFeatures(y.PVRTC_RGB2)&&(p+="pvrtc "),this.getFormatFeatures(y.ASTC_RGBA_4X4)&&(p+="astc "),i("WebGL device initialized."),i("RENDERER: "+this._renderer),i("VENDOR: "+this._vendor),i("VERSION: "+A),i("COMPRESSED_FORMAT: "+p),i("EXTENSIONS: "+h),!0},a.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._swapchain=null},a.flushCommands=function(){},a.acquire=function(){},a.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},a.initFormatFeatures=function(e){this._formatFeatures.fill(be.NONE),this._textureExclusive.fill(!0);var t=be.RENDER_TARGET|be.SAMPLED_TEXTURE|be.LINEAR_FILTER;this._formatFeatures[y.RGB8]=t,this._formatFeatures[y.R5G6B5]=t,this._textureExclusive[y.R5G6B5]=!1,this._formatFeatures[y.RGBA8]=t,this._formatFeatures[y.RGBA4]=t,this._textureExclusive[y.RGBA4]=!1,this._formatFeatures[y.RGB5A1]=t,this._textureExclusive[y.RGB5A1]=!1,this._formatFeatures[y.DEPTH]=be.RENDER_TARGET,this._textureExclusive[y.DEPTH]=!1,this._formatFeatures[y.DEPTH_STENCIL]=be.RENDER_TARGET,this._textureExclusive[y.DEPTH_STENCIL]=!1,this._formatFeatures[y.R8I]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RG8I]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGB8I]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGBA8I]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.R8UI]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RG8UI]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGB8UI]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGBA8UI]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.R8I]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RG8I]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGB8I]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGBA8I]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.R8UI]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RG8UI]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGB8UI]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGBA8UI]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.R32F]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RG32F]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGB32F]|=be.VERTEX_ATTRIBUTE,this._formatFeatures[y.RGBA32F]|=be.VERTEX_ATTRIBUTE,e.EXT_sRGB&&(this._formatFeatures[y.SRGB8]=t,this._formatFeatures[y.SRGB8_A8]=t,this._textureExclusive[y.SRGB8_A8]=!1),e.WEBGL_depth_texture&&(this._formatFeatures[y.DEPTH]|=t,this._formatFeatures[y.DEPTH_STENCIL]|=t),e.WEBGL_color_buffer_float&&(this._formatFeatures[y.RGB32F]|=be.RENDER_TARGET,this._formatFeatures[y.RGBA32F]|=be.RENDER_TARGET,this._textureExclusive[y.RGB32F]=!1,this._textureExclusive[y.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._formatFeatures[y.RGB16F]|=be.RENDER_TARGET,this._formatFeatures[y.RGBA16F]|=be.RENDER_TARGET,this._textureExclusive[y.RGB16F]=!1,this._textureExclusive[y.RGBA16F]=!1),e.OES_texture_float&&(this._formatFeatures[y.RGB32F]|=be.RENDER_TARGET|be.SAMPLED_TEXTURE,this._formatFeatures[y.RGBA32F]|=be.RENDER_TARGET|be.SAMPLED_TEXTURE),e.OES_texture_half_float&&(this._formatFeatures[y.RGB16F]|=be.RENDER_TARGET|be.SAMPLED_TEXTURE,this._formatFeatures[y.RGBA16F]|=be.RENDER_TARGET|be.SAMPLED_TEXTURE),e.OES_texture_float_linear&&(this._formatFeatures[y.RGB32F]|=be.LINEAR_FILTER,this._formatFeatures[y.RGBA32F]|=be.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[y.RGB16F]|=be.LINEAR_FILTER,this._formatFeatures[y.RGBA16F]|=be.LINEAR_FILTER);var r=be.SAMPLED_TEXTURE|be.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[y.ETC_RGB8]=r),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[y.ETC2_RGB8]=r,this._formatFeatures[y.ETC2_RGBA8]=r,this._formatFeatures[y.ETC2_SRGB8]=r,this._formatFeatures[y.ETC2_SRGB8_A8]=r,this._formatFeatures[y.ETC2_RGB8_A1]=r,this._formatFeatures[y.ETC2_SRGB8_A1]=r),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[y.BC1]=r,this._formatFeatures[y.BC1_ALPHA]=r,this._formatFeatures[y.BC1_SRGB]=r,this._formatFeatures[y.BC1_SRGB_ALPHA]=r,this._formatFeatures[y.BC2]=r,this._formatFeatures[y.BC2_SRGB]=r,this._formatFeatures[y.BC3]=r,this._formatFeatures[y.BC3_SRGB]=r),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[y.PVRTC_RGB2]|=r,this._formatFeatures[y.PVRTC_RGBA2]|=r,this._formatFeatures[y.PVRTC_RGB4]|=r,this._formatFeatures[y.PVRTC_RGBA4]|=r),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[y.ASTC_RGBA_4X4]|=r,this._formatFeatures[y.ASTC_RGBA_5X4]|=r,this._formatFeatures[y.ASTC_RGBA_5X5]|=r,this._formatFeatures[y.ASTC_RGBA_6X5]|=r,this._formatFeatures[y.ASTC_RGBA_6X6]|=r,this._formatFeatures[y.ASTC_RGBA_8X5]|=r,this._formatFeatures[y.ASTC_RGBA_8X6]|=r,this._formatFeatures[y.ASTC_RGBA_8X8]|=r,this._formatFeatures[y.ASTC_RGBA_10X5]|=r,this._formatFeatures[y.ASTC_RGBA_10X6]|=r,this._formatFeatures[y.ASTC_RGBA_10X8]|=r,this._formatFeatures[y.ASTC_RGBA_10X10]|=r,this._formatFeatures[y.ASTC_RGBA_12X10]|=r,this._formatFeatures[y.ASTC_RGBA_12X12]|=r,this._formatFeatures[y.ASTC_SRGBA_4X4]|=r,this._formatFeatures[y.ASTC_SRGBA_5X4]|=r,this._formatFeatures[y.ASTC_SRGBA_5X5]|=r,this._formatFeatures[y.ASTC_SRGBA_6X5]|=r,this._formatFeatures[y.ASTC_SRGBA_6X6]|=r,this._formatFeatures[y.ASTC_SRGBA_8X5]|=r,this._formatFeatures[y.ASTC_SRGBA_8X6]|=r,this._formatFeatures[y.ASTC_SRGBA_8X8]|=r,this._formatFeatures[y.ASTC_SRGBA_10X5]|=r,this._formatFeatures[y.ASTC_SRGBA_10X6]|=r,this._formatFeatures[y.ASTC_SRGBA_10X8]|=r,this._formatFeatures[y.ASTC_SRGBA_10X10]|=r,this._formatFeatures[y.ASTC_SRGBA_12X10]|=r,this._formatFeatures[y.ASTC_SRGBA_12X12]|=r)},a.createCommandBuffer=function(e){var t=new(e.type===J.PRIMARY?Ft:pt);return t.initialize(e),t},a.createSwapchain=function(e){var t=new Ut;return this._swapchain=t,t.initialize(e),t},a.createBuffer=function(e){var t=new Rt;return t.initialize(e),t},a.createTexture=function(e){var t=new Mt;return t.initialize(e),t},a.createDescriptorSet=function(e){var t=new Oe;return t.initialize(e),t},a.createShader=function(e){var t=new It;return t.initialize(e),t},a.createInputAssembler=function(e){var t=new Bt;return t.initialize(e),t},a.createRenderPass=function(e){var t=new yt;return t.initialize(e),t},a.createFramebuffer=function(e){var t=new mt;return t.initialize(e),t},a.createDescriptorSetLayout=function(e){var t=new Ct;return t.initialize(e),t},a.createPipelineLayout=function(e){var t=new xt;return t.initialize(e),t},a.createPipelineState=function(e){var t=new Pt;return t.initialize(e),t},a.createQueue=function(e){var t=new vt;return t.initialize(e),t},a.getSampler=function(e){var t=le.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new Gt(e,t)),this._samplers.get(t)},a.getSwapchains=function(){return[this._swapchain]},a.getGeneralBarrier=function(e){var t=Pe.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new Pe(e,t)),this._generalBarrierss.get(t)},a.getTextureBarrier=function(e){var t=Fe.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Fe(e,t)),this._textureBarriers.get(t)},a.getBufferBarrier=function(e){var t=ve.computeHash(e);return this._bufferBarriers.has(t)||this._bufferBarriers.set(t,new ve(e,t)),this._bufferBarriers.get(t)},a.copyBuffersToTexture=function(e,t,r){Et(this,e,t.gpuTexture,r)},a.copyTextureToBuffers=function(e,t,r){!function(e,t,r,s){var a=e.gl,i=e.stateCache,n=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,n);var u=0,l=0,_=1,o=1;switch(t.glTarget){case a.TEXTURE_2D:for(var f=0;f<s.length;f++){var c=s[f];a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,c.texSubres.mipLevel),u=c.texOffset.x,l=c.texOffset.y,_=c.texExtent.width,o=c.texExtent.height,a.readPixels(u,l,_,o,t.glFormat,t.glType,r[f])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}a.bindFramebuffer(a.FRAMEBUFFER,null),i.glFramebuffer=null,a.deleteFramebuffer(n)}(this,e.gpuTexture,t,r)},a.copyTexImagesToTexture=function(e,t,r){!function(e,t,r,s){var a=e.gl,i=e.stateCache.glTexUnits[e.stateCache.texUnit];i.glTexture!==r.glTexture&&(a.bindTexture(r.glTarget,r.glTexture),i.glTexture=r.glTexture);var n=0,u=0;switch(r.glTarget){case a.TEXTURE_2D:for(var l=0;l<s.length;l++){var _=s[l];a.texSubImage2D(a.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,r.glFormat,r.glType,t[n++])}break;case a.TEXTURE_CUBE_MAP:for(var o=0;o<s.length;o++){var f=s[o],c=f.texSubres.baseArrayLayer+f.texSubres.layerCount;for(u=f.texSubres.baseArrayLayer;u<c;++u)a.texSubImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X+u,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,r.glFormat,r.glType,t[n++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}r.flags&M.GEN_MIPMAP&&r.isPowerOf2&&a.generateMipmap(r.glTarget)}(this,e,t.gpuTexture,r)},r(s,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}},{key:"blitManager",get:function(){return this._swapchain.blitManager}}]),s}(pe));n.WebGLDevice=kt}}}));
