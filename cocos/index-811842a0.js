System.register(["./find-222dc7da.js","./create-mesh-1be8f092.js","./index-68ccac70.js","./mesh-renderer-c40c4f87.js","./mesh-97b1b18c.js","./util-06cac5ac.js","./skeleton-99c82a69.js","./node-event-40319828.js","./director-56fe9b8d.js","./pipeline-state-manager-8f16c5a7.js","./buffer-barrier-d1733967.js","./deprecated-0752a51c.js","./deprecated-51f2c4c2.js","./camera-component-9188fe5a.js"],(function(e){"use strict";var t,i,o,r,n,s,a,h,c,l,p,u,d,_,g,y,f,m,b,D,w,P,O,v,L,R,S,M,C,B,k,z,T,x,E,N,A,F,I,j,U,H,G,W,X,V,Z,K,q,Y,$,J,Q,ee,te,ie,oe,re,ne,se,ae,he,ce,le,pe,ue,de;return{setters:[function(e){t=e.x,i=e.as,o=e.at,r=e.au,n=e.P,s=e.C,a=e.c,h=e.d,c=e.a2,l=e.av,p=e.a3,u=e.T,d=e.N},function(e){_=e.r,g=e._,y=e.M},function(e){f=e.t,m=e.ah,b=e.l,D=e.cq,w=e.o,P=e.aa,O=e.bD,v=e.bx,L=e.bE,R=e.bF,S=e.bA,M=e.b$,C=e.bg,B=e.B,k=e.ck,z=e.at,T=e.av,x=e.au,E=e.a$,N=e.a_,A=e.J,F=e.d,I=e.bf,j=e.N,U=e.ag,H=e.i,G=e.bC,W=e.as},function(e){X=e.M},function(e){V=e.M},function(e){Z=e.a},function(){},function(e){K=e.C,q=e.N},function(e){Y=e.L,$=e.l,J=e.D,Q=e.g,ee=e.m,te=e.n,ie=e.o,oe=e.P,re=e.R,ne=e.s,se=e.t,ae=e.au,he=e.q,ce=e.p,le=e.r},function(e){pe=e.b,ue=e.C},function(){},function(){},function(){},function(e){de=e.C}],execute:function(){var _e,ge,ye,fe,me,be,De,we,Pe,Oe,ve,Le,Re,Se,Me,Ce,Be=Object.freeze({__proto__:null,find:t,toPPM:function(e,t,i){return"P3 "+t+" "+i+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:_,createMesh:g,MeshUtils:y,readBuffer:i,writeBuffer:o,mapBuffer:r});function ke(e,t){var i=e.sharedMaterials.length;if(i!==t.sharedMaterials.length)return!1;for(var o=0;o<i;o++)if(e.getRenderMaterial(o)!==t.getRenderMaterial(o))return!1;return!0}e("u",Be),e("B",function(){function e(){}return e.batchStaticModel=function(e,t){var i=e.getComponentsInChildren(X);if(i.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var o=1;o<i.length;o++){if(!i[0].mesh.validateMergingMesh(i[o].mesh))return console.error("the meshes of "+i[0].node.name+" and "+i[o].node.name+" can't be merged"),!1;if(!ke(i[0],i[o]))return console.error("the materials of "+i[0].node.name+" and "+i[o].node.name+" can't be merged"),!1}var r=new V,n=new f,s=new f;e.getWorldMatrix(s),f.invert(s,s);for(var a=0;a<i.length;a++){var h=i[a];h.node.getWorldMatrix(n),f.multiply(n,s,n),r.merge(i[a].mesh,n),h.enabled=!1}var c=t.addComponent(X);return c.mesh=r,c.sharedMaterials=i[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var i=e.getComponentsInChildren(X),o=0;o<i.length;o++)i[o].enabled=!0;var r=t.getComponent(X);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}()),m(X.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),b.ModelComponent=X,D(X,"cc.ModelComponent");var ze,Te,xe,Ee,Ne,Ae,Fe,Ie,je,Ue,He,Ge,We,Xe,Ve,Ze,Ke,qe,Ye,$e,Je,Qe,et,tt,it,ot,rt,nt,st,at,ht,ct,lt,pt,ut,dt,_t,gt,yt,ft,mt,bt,Dt,wt,Pt,Ot,vt,Lt,Rt,St,Mt,Ct,Bt,kt,zt,Tt,xt,Et,Nt,At,Ft,It,jt,Ut,Ht,Gt,Wt,Xt,Vt,Zt,Kt,qt,Yt,$t,Jt,Qt,ei,ti,ii,oi,ri,ni,si,ai,hi,ci,li,pi,ui,di,_i,gi,yi,fi,mi,bi,Di,wi,Pi,Oi,vi,Li,Ri,Si,Mi,Ci,Bi,ki,zi,Ti,xi,Ei,Ni,Ai,Fi,Ii,ji,Ui,Hi,Gi,Wi,Xi,Vi,Zi,Ki,qi,Yi,$i,Ji,Qi,eo,to,io,oo,ro=new w,no=P({LUMINOUS_FLUX:0,LUMINANCE:1}),so=O("cc.StaticLightSettings")((ge=function(){function e(){this._baked=ye&&ye(),this._editorOnly=fe&&fe(),this._castShadow=me&&me()}return v(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),ye=L(ge.prototype,"_baked",[C],(function(){return!1})),fe=L(ge.prototype,"_editorOnly",[C],(function(){return!1})),me=L(ge.prototype,"_castShadow",[C],(function(){return!1})),_e=ge))||_e,ao=e("L",(be=O("cc.Light"),De=R(so),we=R(pe.BitMask),be(((Ce=function(e){function t(){var t;return(t=e.call(this)||this)._color=ve&&ve(),t._useColorTemperature=Le&&Le(),t._colorTemperature=Re&&Re(),t._staticSettings=Se&&Se(),t._visibility=Me&&Me(),t._type=Y.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=$,t}S(t,e);var i=t.prototype;return i.onLoad=function(){this._createLight()},i.onEnable=function(){this._attachToScene()},i.onDisable=function(){this._detachFromScene()},i.onDestroy=function(){this._destroyLight()},i._createLight=function(){this._light||(this._light=b.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked,this._light.visibility=this.visibility},i._destroyLight=function(){this._light&&(b.director.root.recycleLight(this._light),this._light=null)},i._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case Y.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case Y.SPHERE:e.addSphereLight(this._light);break;case Y.SPOT:e.addSpotLight(this._light);break;case Y.POINT:e.addPointLight(this._light);break;case Y.RANGED_DIRECTIONAL:e.addRangedDirLight(this._light)}}},i._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case Y.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case Y.SPHERE:e.removeSphereLight(this._light);break;case Y.SPOT:e.removeSpotLight(this._light);break;case Y.POINT:e.removePointLight(this._light);break;case Y.RANGED_DIRECTIONAL:e.removeRangedDirLight(this._light)}}},i._onUpdateReceiveDirLight=function(){},v(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(ro.x=e.r/255,ro.y=e.g/255,ro.z=e.b/255,this._light.color=ro)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._light&&(this._light.visibility=e),this._onUpdateReceiveDirLight()}}]),t}(K)).Type=Y,Ce.PhotometricTerm=no,ve=L((Oe=Ce).prototype,"_color",[C],(function(){return B.WHITE.clone()})),Le=L(Oe.prototype,"_useColorTemperature",[C],(function(){return!1})),Re=L(Oe.prototype,"_colorTemperature",[C],(function(){return 6550})),Se=L(Oe.prototype,"_staticSettings",[C],(function(){return new so})),Me=L(Oe.prototype,"_visibility",[C],(function(){return ue})),M(Oe.prototype,"staticSettings",[De],Object.getOwnPropertyDescriptor(Oe.prototype,"staticSettings"),Oe.prototype),M(Oe.prototype,"visibility",[we],Object.getOwnPropertyDescriptor(Oe.prototype,"visibility"),Oe.prototype),Pe=Oe))||Pe)),ho=k,co=C,lo=I,po=R,uo=e("D",(ze=O("cc.DirectionalLight"),Te=lo("_illuminance"),xe=po(z),Ee=ho({group:{name:"DynamicShadowSettings",displayOrder:1}}),Ne=po(T),Ae=ho({group:{name:"DynamicShadowSettings",displayOrder:5}}),Fe=po(n),Ie=ho({group:{name:"DynamicShadowSettings",displayOrder:6}}),je=po(x),Ue=ho({group:{name:"DynamicShadowSettings",displayOrder:7}}),He=po(x),Ge=ho({group:{name:"DynamicShadowSettings",displayOrder:8}}),We=po(x),Xe=ho({group:{name:"DynamicShadowSettings",displayOrder:9}}),Ve=po(x),Ze=ho({group:{name:"DynamicShadowSettings",displayOrder:22}}),Ke=po(x),qe=ho({group:{name:"DynamicShadowSettings",displayOrder:10}}),Ye=po(s),$e=ho({group:{name:"DynamicShadowSettings",displayOrder:11}}),Je=po(T),Qe=ho({group:{name:"DynamicShadowSettings",displayOrder:12}}),et=po(x),tt=ho({group:{name:"DynamicShadowSettings",displayOrder:13}}),it=po(a),ot=ho({group:{name:"DynamicShadowSettings",displayOrder:14}}),rt=po(T),nt=ho({group:{name:"DynamicShadowSettings",displayOrder:15}}),st=po(x),at=ho({group:{name:"DynamicShadowSettings",displayOrder:16}}),ht=po(x),ct=ho({group:{name:"DynamicShadowSettings",displayOrder:17}}),lt=po(x),pt=ho({group:{name:"DynamicShadowSettings",displayOrder:19}}),ut=po(T),dt=ho({group:{name:"DynamicShadowSettings",displayOrder:20}}),_t=po(T),gt=ho({group:{name:"DynamicShadowSettings",displayOrder:21}}),yt=po(x),ze((mt=function(e){function t(){var t;return(t=e.call(this)||this)._illuminanceHDR=bt&&bt(),t._illuminanceLDR=Dt&&Dt(),t._shadowEnabled=wt&&wt(),t._shadowPcf=Pt&&Pt(),t._shadowBias=Ot&&Ot(),t._shadowNormalBias=vt&&vt(),t._shadowSaturation=Lt&&Lt(),t._shadowDistance=Rt&&Rt(),t._shadowInvisibleOcclusionRange=St&&St(),t._csmLevel=Mt&&Mt(),t._csmLayerLambda=Ct&&Ct(),t._csmOptimizationMode=Bt&&Bt(),t._csmAdvancedOptions=kt&&kt(),t._csmLayersTransition=zt&&zt(),t._csmTransitionRange=Tt&&Tt(),t._shadowFixedArea=xt&&xt(),t._shadowNear=Et&&Et(),t._shadowFar=Nt&&Nt(),t._shadowOrthoSize=At&&At(),t._lightType=J,E.querySettings(N.Category.RENDERING,"highQualityMode")&&(t._shadowPcf=n.SOFT_2X,t._shadowDistance=50,t.enableCSM=!0,t.staticSettings.castShadow=!0),t}S(t,e);var i=t.prototype;return i._createLight=function(){if(e.prototype._createLight.call(this),this._type=Y.DIRECTIONAL,this._light){var t=this._light;t.illuminanceHDR=this._illuminanceHDR,t.illuminanceLDR=this._illuminanceLDR,t.shadowEnabled=this._shadowEnabled,t.shadowPcf=this._shadowPcf,t.shadowBias=this._shadowBias,t.shadowNormalBias=this._shadowNormalBias,t.shadowSaturation=this._shadowSaturation,t.shadowDistance=this._shadowDistance,t.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange,t.shadowFixedArea=this._shadowFixedArea,t.shadowNear=this._shadowNear,t.shadowFar=this._shadowFar,t.shadowOrthoSize=this._shadowOrthoSize,t.csmLevel=this._csmLevel,t.csmLayerLambda=this._csmLayerLambda,t.csmOptimizationMode=this._csmOptimizationMode,t.csmLayersTransition=this._csmLayersTransition,t.csmTransitionRange=this._csmTransitionRange}},i._onUpdateReceiveDirLight=function(){if(this._light){e.prototype._onUpdateReceiveDirLight.call(this);var t=this.node.scene;if(t&&t.renderScene&&t.renderScene.mainLight===this._light)for(var i=t.renderScene.models,o=0;o<i.length;o++){var r=i[o];if(r.node){var n=r.node.getComponent(X);n&&n.onUpdateReceiveDirLight(this._visibility)}}}},v(t,[{key:"illuminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=this._shadowEnabled)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=this._shadowPcf)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=this._shadowBias)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=this._shadowNormalBias)}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=A(e,0,1),this._light&&(this._light.shadowSaturation=this._shadowSaturation)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,h.MAX_FAR),this._shadowDistance/.1<10&&F(15003,this._shadowDistance),this._light&&(this._light.shadowDistance=this._shadowDistance,this._light.csmNeedUpdate=!0)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,h.MAX_FAR),this._light&&(this._light.shadowInvisibleOcclusionRange=this._shadowInvisibleOcclusionRange)}},{key:"csmLevel",get:function(){return this._csmLevel},set:function(e){this._csmLevel=e,this._light&&(this._light.csmLevel=this._csmLevel,this._light.csmNeedUpdate=!0)}},{key:"enableCSM",get:function(){return this._csmLevel>s.LEVEL_1},set:function(e){this._csmLevel=e?s.LEVEL_4:s.LEVEL_1,this._light&&(this._light.csmLevel=this._csmLevel,this._light.csmNeedUpdate=!0)}},{key:"csmLayerLambda",get:function(){return this._csmLayerLambda},set:function(e){this._csmLayerLambda=e,this._light&&(this._light.csmLayerLambda=this._csmLayerLambda,this._light.csmNeedUpdate=!0)}},{key:"csmOptimizationMode",get:function(){return this._csmOptimizationMode},set:function(e){this._csmOptimizationMode=e,this._light&&(this._light.csmOptimizationMode=this._csmOptimizationMode)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this._light&&(this._light.shadowFixedArea=this._shadowFixedArea)}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e,this._light&&(this._light.shadowNear=this._shadowNear)}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,h.MAX_FAR),this._light&&(this._light.shadowFar=this._shadowFar)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e,this._light&&(this._light.shadowOrthoSize=this._shadowOrthoSize)}},{key:"csmAdvancedOptions",get:function(){return this._csmAdvancedOptions},set:function(e){this._csmAdvancedOptions=e}},{key:"csmLayersTransition",get:function(){return this._csmLayersTransition},set:function(e){this._csmLayersTransition=e,this._light&&(this._light.csmLayersTransition=e)}},{key:"csmTransitionRange",get:function(){return this._csmTransitionRange},set:function(e){this._csmTransitionRange=e,this._light&&(this._light.csmTransitionRange=e)}}]),t}(ao),bt=L(mt.prototype,"_illuminanceHDR",[ho,Te],(function(){return 65e3})),Dt=L(mt.prototype,"_illuminanceLDR",[co],(function(){return 65e3*Q.standardExposureValue})),wt=L(mt.prototype,"_shadowEnabled",[co],(function(){return!1})),Pt=L(mt.prototype,"_shadowPcf",[co],(function(){return n.HARD})),Ot=L(mt.prototype,"_shadowBias",[co],(function(){return 1e-5})),vt=L(mt.prototype,"_shadowNormalBias",[co],(function(){return 0})),Lt=L(mt.prototype,"_shadowSaturation",[co],(function(){return 1})),Rt=L(mt.prototype,"_shadowDistance",[co],(function(){return 50})),St=L(mt.prototype,"_shadowInvisibleOcclusionRange",[co],(function(){return 200})),Mt=L(mt.prototype,"_csmLevel",[co],(function(){return s.LEVEL_4})),Ct=L(mt.prototype,"_csmLayerLambda",[co],(function(){return.75})),Bt=L(mt.prototype,"_csmOptimizationMode",[co],(function(){return a.RemoveDuplicates})),kt=L(mt.prototype,"_csmAdvancedOptions",[co],(function(){return!1})),zt=L(mt.prototype,"_csmLayersTransition",[co],(function(){return!1})),Tt=L(mt.prototype,"_csmTransitionRange",[co],(function(){return.05})),xt=L(mt.prototype,"_shadowFixedArea",[co],(function(){return!1})),Et=L(mt.prototype,"_shadowNear",[co],(function(){return.1})),Nt=L(mt.prototype,"_shadowFar",[co],(function(){return 10})),At=L(mt.prototype,"_shadowOrthoSize",[co],(function(){return 5})),M(mt.prototype,"illuminance",[xe],Object.getOwnPropertyDescriptor(mt.prototype,"illuminance"),mt.prototype),M(mt.prototype,"shadowEnabled",[Ee,Ne],Object.getOwnPropertyDescriptor(mt.prototype,"shadowEnabled"),mt.prototype),M(mt.prototype,"shadowPcf",[Ae,Fe],Object.getOwnPropertyDescriptor(mt.prototype,"shadowPcf"),mt.prototype),M(mt.prototype,"shadowBias",[Ie,je],Object.getOwnPropertyDescriptor(mt.prototype,"shadowBias"),mt.prototype),M(mt.prototype,"shadowNormalBias",[Ue,He],Object.getOwnPropertyDescriptor(mt.prototype,"shadowNormalBias"),mt.prototype),M(mt.prototype,"shadowSaturation",[Ge,We],Object.getOwnPropertyDescriptor(mt.prototype,"shadowSaturation"),mt.prototype),M(mt.prototype,"shadowDistance",[Xe,Ve],Object.getOwnPropertyDescriptor(mt.prototype,"shadowDistance"),mt.prototype),M(mt.prototype,"shadowInvisibleOcclusionRange",[Ze,Ke],Object.getOwnPropertyDescriptor(mt.prototype,"shadowInvisibleOcclusionRange"),mt.prototype),M(mt.prototype,"csmLevel",[qe,Ye],Object.getOwnPropertyDescriptor(mt.prototype,"csmLevel"),mt.prototype),M(mt.prototype,"enableCSM",[$e,Je],Object.getOwnPropertyDescriptor(mt.prototype,"enableCSM"),mt.prototype),M(mt.prototype,"csmLayerLambda",[Qe,et],Object.getOwnPropertyDescriptor(mt.prototype,"csmLayerLambda"),mt.prototype),M(mt.prototype,"csmOptimizationMode",[tt,it],Object.getOwnPropertyDescriptor(mt.prototype,"csmOptimizationMode"),mt.prototype),M(mt.prototype,"shadowFixedArea",[ot,rt],Object.getOwnPropertyDescriptor(mt.prototype,"shadowFixedArea"),mt.prototype),M(mt.prototype,"shadowNear",[nt,st],Object.getOwnPropertyDescriptor(mt.prototype,"shadowNear"),mt.prototype),M(mt.prototype,"shadowFar",[at,ht],Object.getOwnPropertyDescriptor(mt.prototype,"shadowFar"),mt.prototype),M(mt.prototype,"shadowOrthoSize",[ct,lt],Object.getOwnPropertyDescriptor(mt.prototype,"shadowOrthoSize"),mt.prototype),M(mt.prototype,"csmAdvancedOptions",[pt,ut],Object.getOwnPropertyDescriptor(mt.prototype,"csmAdvancedOptions"),mt.prototype),M(mt.prototype,"csmLayersTransition",[dt,_t],Object.getOwnPropertyDescriptor(mt.prototype,"csmLayersTransition"),mt.prototype),M(mt.prototype,"csmTransitionRange",[gt,yt],Object.getOwnPropertyDescriptor(mt.prototype,"csmTransitionRange"),mt.prototype),ft=mt))||ft)),_o=e("S",(Ft=O("cc.SphereLight"),It=I("_luminance"),jt=R(z),Ut=R(z),Ht=R(no),Gt=R(x),Wt=R(x),Ft((Vt=function(e){function t(){var t;return(t=e.call(this)||this)._size=Zt&&Zt(),t._luminanceHDR=Kt&&Kt(),t._luminanceLDR=qt&&qt(),t._term=Yt&&Yt(),t._range=$t&&$t(),t._lightType=ee,t}return S(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._type=Y.SPHERE,this.size=this._size,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},v(t,[{key:"luminousFlux",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*te(this._size):this._luminanceLDR},set:function(e){var t=0;b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/te(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(ao),Zt=L(Vt.prototype,"_size",[C],(function(){return.15})),Kt=L(Vt.prototype,"_luminanceHDR",[C,It],(function(){return 1700/te(.15)})),qt=L(Vt.prototype,"_luminanceLDR",[C],(function(){return 1700/te(.15)*Q.standardExposureValue*Q.standardLightMeterScale})),Yt=L(Vt.prototype,"_term",[C],(function(){return no.LUMINOUS_FLUX})),$t=L(Vt.prototype,"_range",[C],(function(){return 1})),M(Vt.prototype,"luminousFlux",[jt],Object.getOwnPropertyDescriptor(Vt.prototype,"luminousFlux"),Vt.prototype),M(Vt.prototype,"luminance",[Ut],Object.getOwnPropertyDescriptor(Vt.prototype,"luminance"),Vt.prototype),M(Vt.prototype,"term",[Ht],Object.getOwnPropertyDescriptor(Vt.prototype,"term"),Vt.prototype),M(Vt.prototype,"size",[Gt],Object.getOwnPropertyDescriptor(Vt.prototype,"size"),Vt.prototype),M(Vt.prototype,"range",[Wt],Object.getOwnPropertyDescriptor(Vt.prototype,"range"),Vt.prototype),Xt=Vt))||Xt)),go=R,yo=C,fo=I,mo=k,bo=e("a",(Jt=O("cc.SpotLight"),Qt=fo("_luminance"),ei=go(no),ti=go(x),ii=mo({group:{name:"DynamicShadowSettings",displayOrder:1}}),oi=go(T),ri=mo({group:{name:"DynamicShadowSettings",displayOrder:2}}),ni=go(n),si=mo({group:{name:"DynamicShadowSettings",displayOrder:3}}),ai=go(x),hi=mo({group:{name:"DynamicShadowSettings",displayOrder:4}}),ci=go(x),Jt((pi=function(e){function t(){var t;return(t=e.call(this)||this)._size=ui&&ui(),t._luminanceHDR=di&&di(),t._luminanceLDR=_i&&_i(),t._term=gi&&gi(),t._range=yi&&yi(),t._spotAngle=fi&&fi(),t._shadowEnabled=mi&&mi(),t._shadowPcf=bi&&bi(),t._shadowBias=Di&&Di(),t._shadowNormalBias=wi&&wi(),t._lightType=ie,t}return S(t,e),t.prototype._createLight=function(){if(e.prototype._createLight.call(this),this._type=Y.SPOT,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,this._light){var t=this._light;t.luminanceHDR=this._luminanceHDR,t.luminanceLDR=this._luminanceLDR,t.shadowEnabled=this._shadowEnabled,t.shadowPcf=this._shadowPcf,t.shadowBias=this._shadowBias,t.shadowNormalBias=this._shadowNormalBias}},v(t,[{key:"luminousFlux",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*te(this._size):this._luminanceLDR},set:function(e){var t=0;b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/te(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=j(e))}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this._light&&(this._light.shadowEnabled=e)}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this._light&&(this._light.shadowPcf=e)}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e,this._light&&(this._light.shadowBias=e)}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e,this._light&&(this._light.shadowNormalBias=e)}}]),t}(ao),ui=L(pi.prototype,"_size",[yo],(function(){return.15})),di=L(pi.prototype,"_luminanceHDR",[yo,Qt],(function(){return 1700/te(.15)})),_i=L(pi.prototype,"_luminanceLDR",[yo],(function(){return 1700/te(.15)*Q.standardExposureValue*Q.standardLightMeterScale})),gi=L(pi.prototype,"_term",[yo],(function(){return no.LUMINOUS_FLUX})),yi=L(pi.prototype,"_range",[yo],(function(){return 1})),fi=L(pi.prototype,"_spotAngle",[yo],(function(){return 60})),mi=L(pi.prototype,"_shadowEnabled",[yo],(function(){return!1})),bi=L(pi.prototype,"_shadowPcf",[yo],(function(){return n.HARD})),Di=L(pi.prototype,"_shadowBias",[yo],(function(){return 1e-5})),wi=L(pi.prototype,"_shadowNormalBias",[yo],(function(){return 0})),M(pi.prototype,"term",[ei],Object.getOwnPropertyDescriptor(pi.prototype,"term"),pi.prototype),M(pi.prototype,"size",[ti],Object.getOwnPropertyDescriptor(pi.prototype,"size"),pi.prototype),M(pi.prototype,"shadowEnabled",[ii,oi],Object.getOwnPropertyDescriptor(pi.prototype,"shadowEnabled"),pi.prototype),M(pi.prototype,"shadowPcf",[ri,ni],Object.getOwnPropertyDescriptor(pi.prototype,"shadowPcf"),pi.prototype),M(pi.prototype,"shadowBias",[si,ai],Object.getOwnPropertyDescriptor(pi.prototype,"shadowBias"),pi.prototype),M(pi.prototype,"shadowNormalBias",[hi,ci],Object.getOwnPropertyDescriptor(pi.prototype,"shadowNormalBias"),pi.prototype),li=pi))||li));e("P",(Pi=O("cc.PointLight"),Oi=I("_luminance"),vi=R(z),Li=R(z),Ri=R(no),Si=R(x),Pi((Ci=function(e){function t(){var t;return(t=e.call(this)||this)._luminanceHDR=Bi&&Bi(),t._luminanceLDR=ki&&ki(),t._term=zi&&zi(),t._range=Ti&&Ti(),t._lightType=oe,t}return S(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._type=Y.POINT,this.range=this._range,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},v(t,[{key:"luminousFlux",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*te(1):this._luminanceLDR},set:function(e){var t=0;b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/te(1),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(ao),Bi=L(Ci.prototype,"_luminanceHDR",[C,Oi],(function(){return 1700/te(.15)})),ki=L(Ci.prototype,"_luminanceLDR",[C],(function(){return 1700/te(.15)*Q.standardExposureValue*Q.standardLightMeterScale})),zi=L(Ci.prototype,"_term",[C],(function(){return no.LUMINOUS_FLUX})),Ti=L(Ci.prototype,"_range",[C],(function(){return 1})),M(Ci.prototype,"luminousFlux",[vi],Object.getOwnPropertyDescriptor(Ci.prototype,"luminousFlux"),Ci.prototype),M(Ci.prototype,"luminance",[Li],Object.getOwnPropertyDescriptor(Ci.prototype,"luminance"),Ci.prototype),M(Ci.prototype,"term",[Ri],Object.getOwnPropertyDescriptor(Ci.prototype,"term"),Ci.prototype),M(Ci.prototype,"range",[Si],Object.getOwnPropertyDescriptor(Ci.prototype,"range"),Ci.prototype),Mi=Ci))||Mi)),e("R",(xi=O("cc.RangedDirectionalLight"),Ei=I("_illuminance"),Ni=R(z),xi((Fi=function(e){function t(){var t;return(t=e.call(this)||this)._illuminanceHDR=Ii&&Ii(),t._illuminanceLDR=ji&&ji(),t._lightType=re,t}return S(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._type=Y.RANGED_DIRECTIONAL,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},v(t,[{key:"illuminance",get:function(){return b.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){b.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),t}(ao),Ii=L(Fi.prototype,"_illuminanceHDR",[k,Ei],(function(){return 65e3})),ji=L(Fi.prototype,"_illuminanceLDR",[C],(function(){return 65e3*Q.standardExposureValue})),M(Fi.prototype,"illuminance",[Ni],Object.getOwnPropertyDescriptor(Fi.prototype,"illuminance"),Fi.prototype),Ai=Fi))||Ai)),b.LightComponent=ao,D(ao,"cc.LightComponent"),b.DirectionalLightComponent=uo,D(uo,"cc.DirectionalLightComponent"),b.SphereLightComponent=_o,D(_o,"cc.SphereLightComponent"),b.SpotLightComponent=bo,D(bo,"cc.SpotLightComponent"),U(bo.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),U(_o.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),U(ao.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var Do,wo,Po,Oo,vo,Lo,Ro,So,Mo,Co,Bo,ko,zo,To,xo,Eo,No,Ao,Fo,Io,jo,Uo,Ho,Go=[.25,.125,.01],Wo=e("b",(Ui=O("cc.LOD"),Hi=R([X]),Gi=R(x),Wi=R([X]),Xi=R([z]),Ui((Zi=function(){function e(){this._screenUsagePercentage=Ki&&Ki(),this._renderers=qi&&qi(),this._LODData=new ne,this._modelAddedCallback=void 0,this._LODData.screenUsagePercentage=this._screenUsagePercentage,this._modelAddedCallback=null}var t=e.prototype;return t.insertRenderer=function(e,t){(e<0||e>this._renderers.length)&&(e=this._renderers.length),this._renderers.splice(e,0,t);var i=!1;return t.model&&(i=!0,this._LODData.addModel(t.model)),this._modelAddedCallback&&i&&this._modelAddedCallback(),t},t.deleteRenderer=function(e){var t,i=this._renderers.splice(e,1),o=i.length>0?null===(t=i[0])||void 0===t?void 0:t.model:null;return o&&this._LODData.eraseModel(o),i[0]},t.getRenderer=function(e){return this._renderers[e]||null},t.setRenderer=function(e,t){e<0||e>=this.rendererCount?console.error("setRenderer to LOD error, index out of range"):(this.deleteRenderer(e),this.insertRenderer(e,t))},v(e,[{key:"screenUsagePercentage",get:function(){return this._screenUsagePercentage},set:function(e){this._screenUsagePercentage=e,this._LODData.screenUsagePercentage=e}},{key:"renderers",get:function(){return this._renderers},set:function(e){if(e!==this._renderers){var t=!1;this._renderers.length=0,this._LODData.clearModels();for(var i=0;i<e.length;i++){var o;this._renderers[i]=e[i];var r=null===(o=e[i])||void 0===o?void 0:o.model;r&&(t=!0,this._LODData.addModel(r))}this._modelAddedCallback&&t&&this._modelAddedCallback()}}},{key:"triangleCount",get:function(){var e=[];return this._renderers.forEach((function(t){var i=0;if(t&&t.mesh){var o=t.mesh.struct.primitives;null==o||o.forEach((function(e){e&&e.indexView&&(i+=e.indexView.count)}))}e.push(i/3)})),e}},{key:"rendererCount",get:function(){return this._renderers.length}},{key:"lodData",get:function(){return this._LODData}},{key:"modelAddedCallback",set:function(e){this._modelAddedCallback=e}}]),e}(),Ki=L(Zi.prototype,"_screenUsagePercentage",[C],(function(){return 1})),qi=L(Zi.prototype,"_renderers",[Hi,C],(function(){return[]})),M(Zi.prototype,"screenUsagePercentage",[Gi],Object.getOwnPropertyDescriptor(Zi.prototype,"screenUsagePercentage"),Zi.prototype),M(Zi.prototype,"renderers",[Wi],Object.getOwnPropertyDescriptor(Zi.prototype,"renderers"),Zi.prototype),M(Zi.prototype,"triangleCount",[Xi],Object.getOwnPropertyDescriptor(Zi.prototype,"triangleCount"),Zi.prototype),Vi=Zi))||Vi)),Xo=(e("c",(Yi=O("cc.LODGroup"),$i=R(x),Ji=R([Wo]),Yi((eo=function(e){function t(){var t;return(t=e.call(this)||this)._localBoundaryCenter=to&&to(),t._objectSize=io&&io(),t._LODs=oo&&oo(),t._lodGroup=new se,t._eventRegistered=!1,t}S(t,e);var i=t.prototype;return i.onLodModelAddedCallback=function(){0===this.objectSize&&this.recalculateBounds()},i.insertLOD=function(e,t,i){if((e<0||e>this.lodCount)&&(e=this.lodCount),i||(i=new Wo),i.modelAddedCallback=this.onLodModelAddedCallback.bind(this),!t){var o=this.getLOD(e-1),r=this.getLOD(e);if(o&&r)t=(o.screenUsagePercentage+r.screenUsagePercentage)/2;else if(o&&!r)(t=o.screenUsagePercentage/2)>.01&&(t=.01);else if(r&&!o){t=r.screenUsagePercentage;var n=this.getLOD(e+1);r.screenUsagePercentage=(t+(n?n.screenUsagePercentage:0))/2}else t=Go[0]}return i.screenUsagePercentage=t,this._LODs.splice(e,0,i),this._lodGroup.insertLOD(e,i.lodData),this._updateDataToScene(),this.node&&this._emitChangeNode(this.node),i},i.eraseLOD=function(e){if(e<0||e>=this.lodCount)return console.warn("eraseLOD error, index out of range"),null;var t=this._LODs[e];return t?(this._LODs.splice(e,1),this._lodGroup.eraseLOD(e),this._updateDataToScene(),this._emitChangeNode(this.node),t):(console.warn("eraseLOD error, LOD not exist at specified index."),null)},i.getLOD=function(e){return e<0||e>=this.lodCount?(console.warn("getLOD error, index out of range"),null):this._LODs[e]},i.setLOD=function(e,t){e<0||e>=this.lodCount?console.warn("setLOD error, index out of range"):(this._LODs[e]=t,t.modelAddedCallback=this.onLodModelAddedCallback.bind(this),this.lodGroup.updateLOD(e,t.lodData),this._updateDataToScene())},i.recalculateBounds=function(){for(var e=new w,t=new w,i=null,o=new w,r=0;r<this.lodCount;++r){var n=this.getLOD(r);if(n)for(var s=0;s<n.rendererCount;++s){var a,h,c=n.getRenderer(s);if(c){null===(a=c.model)||void 0===a||a.updateWorldBound();var l=null===(h=c.model)||void 0===h?void 0:h.worldBounds;l&&(l.getBoundary(e,t),i?(w.min(i,i,e),w.max(o,o,t)):(i=e.clone(),o=t.clone()))}}}if(i){var p=i,u=new w(.5*(o.x+p.x),.5*(o.y+p.y),.5*(o.z+p.z)),d=new w(.5*(o.x-p.x),.5*(o.y-p.y),.5*(o.z-p.z)),_=function(e,t,i){var o,r,n=new Array(new w(e.x-t.x,e.y-t.y,e.z-t.z),new w(e.x-t.x,e.y+t.y,e.z-t.z),new w(e.x+t.x,e.y+t.y,e.z-t.z),new w(e.x+t.x,e.y-t.y,e.z-t.z),new w(e.x-t.x,e.y-t.y,e.z+t.z),new w(e.x-t.x,e.y+t.y,e.z+t.z),new w(e.x+t.x,e.y+t.y,e.z+t.z),new w(e.x+t.x,e.y-t.y,e.z+t.z));r=(o=n[0].transformMat4(i)).clone();for(var s=1;s<8;++s){var a=n[s].transformMat4(i);o=w.min(o,o,a),r=w.max(r,r,a)}return[o,r]}(u,d,this.node.worldMatrix.clone().invert()),g=_[0],y=_[1];u.set(.5*(y.x+g.x),.5*(y.y+g.y),.5*(y.z+g.z)),d.set(.5*(y.x-g.x),.5*(y.y-g.y),.5*(y.z-g.z)),this.localBoundaryCenter=u,this.objectSize=2*Math.max(d.x,d.y,d.z)}else this.localBoundaryCenter=new w(0,0,0),this.objectSize=0;this._emitChangeNode(this.node)},i.resetObjectSize=function(){if(1!==this.objectSize){0===this.objectSize&&(this.objectSize=1);var e=1/this.objectSize;this.objectSize=1;for(var t=0;t<this.lodCount;++t){var i=this.getLOD(t);i&&(i.screenUsagePercentage*=e)}this._emitChangeNode(this.node)}},i.forceLOD=function(e){this.lodGroup.lockLODLevels(e<0?[]:[e])},i.onLoad=function(){this._lodGroup.node=this.node,this._lodGroup.objectSize=this._objectSize,this._lodGroup.localBoundaryCenter=this._localBoundaryCenter,this._eventRegistered||(this.node.on(q.COMPONENT_REMOVED,this._onRemove,this),this._eventRegistered=!0),this._constructLOD()},i._onRemove=function(e){e===this&&this.onDisable()},i._constructLOD=function(){if(this.lodCount<1)for(var e=Go.length,t=0;t<e;t++)this.insertLOD(t,Go[t])},i.onRestore=function(){this._constructLOD(),this.enabledInHierarchy&&this._attachToScene()},i.onEnable=function(){var e=this;this._attachToScene(),0===this.objectSize&&this.recalculateBounds(),this.lodCount>0&&this._lodGroup.lodCount<1&&this._LODs.forEach((function(t,i){t.lodData.screenUsagePercentage=t.screenUsagePercentage;var o=t.renderers;if(null!==o&&o.length>0)for(var r=0;r<o.length;r++){var n=t.lodData,s=o[r];n&&s&&s.model&&n.addModel(s.model)}e._lodGroup.insertLOD(i,t.lodData)}))},i.onDisable=function(){this._detachFromScene()},i._attachToScene=function(){if(this.node&&this.node.scene){var e=this._getRenderScene();this._lodGroup.scene&&this._detachFromScene(),e.addLODGroup(this._lodGroup)}},i._detachFromScene=function(){this._lodGroup.scene&&this._lodGroup.scene.removeLODGroup(this._lodGroup)},i._emitChangeNode=function(){},i._updateDataToScene=function(){this._detachFromScene(),this._attachToScene()},v(t,[{key:"localBoundaryCenter",get:function(){return this._localBoundaryCenter.clone()},set:function(e){this._localBoundaryCenter.set(e),this._lodGroup.localBoundaryCenter=e}},{key:"lodCount",get:function(){return this._LODs.length}},{key:"objectSize",get:function(){return this._objectSize},set:function(e){this._objectSize=e,this._lodGroup.objectSize=e}},{key:"LODs",get:function(){return this._LODs},set:function(e){var t=this;e!==this._LODs?(this._LODs.length=0,this.lodGroup.clearLODs(),e.forEach((function(e,i){t.lodGroup.insertLOD(i,e.lodData),t._LODs[i]=e,e.modelAddedCallback=t.onLodModelAddedCallback.bind(t)})),this._updateDataToScene()):this._updateDataToScene()}},{key:"lodGroup",get:function(){return this._lodGroup}}]),t}(K),to=L(eo.prototype,"_localBoundaryCenter",[C],(function(){return new w(0,0,0)})),io=L(eo.prototype,"_objectSize",[C],(function(){return 0})),oo=L(eo.prototype,"_LODs",[C],(function(){return[]})),M(eo.prototype,"objectSize",[$i],Object.getOwnPropertyDescriptor(eo.prototype,"objectSize"),eo.prototype),M(eo.prototype,"LODs",[Ji],Object.getOwnPropertyDescriptor(eo.prototype,"LODs"),eo.prototype),Qi=eo))||Qi)),pe.makeMaskExclude([pe.BitMask.UI_2D,pe.BitMask.UI_3D,pe.BitMask.GIZMOS,pe.BitMask.EDITOR,pe.BitMask.SCENE_GIZMO,pe.BitMask.PROFILER,pe.Enum.IGNORE_RAYCAST])),Vo=e("e",function(){function e(){this._probes=[],this._useCubeModels=new Map,this._usePlanarModels=new Map,this._updateForRuntime=!0,this._dataTexture=null,this._registeredEvent=!1}var t=e.prototype;return t.registerEvent=function(){this._registeredEvent||(b.director.on(b.Director.EVENT_BEFORE_UPDATE,this.onUpdateProbes,this),this._registeredEvent=!0)},t.onUpdateProbes=function(e){if(void 0===e&&(e=!1),this._updateForRuntime&&0!==this._probes.length){var t=b.director.getScene();if(t&&t.renderScene)for(var i=t.renderScene.models,o=0;o<i.length;o++){var r=i[o];r.node&&r.node.layer&Xo&&(r.node.hasChangedFlags||e)&&(r.reflectionProbeType===ae.BAKED_CUBEMAP||this._isUsedBlending(r)?this.updateUseCubeModels(r):r.reflectionProbeType===ae.PLANAR_REFLECTION&&this.updateUsePlanarModels(r))}}},t.filterModelsForPlanarReflection=function(){if(0!==this._probes.length){var e=b.director.getScene();if(e&&e.renderScene)for(var t=e.renderScene.models,i=0;i<t.length;i++){var o=t[i];o.node&&o.node.layer&Xo&&o.reflectionProbeType===ae.PLANAR_REFLECTION&&this.updateUsePlanarModels(o)}}},t.clearPlanarReflectionMap=function(e){for(var t,i=H(this._usePlanarModels.entries());!(t=i()).done;){var o=t.value;o[1]===e&&this._updatePlanarMapOfModel(o[0],null,null)}},t.register=function(e){-1===this._probes.indexOf(e)&&(this._probes.push(e),this.updateProbeData())},t.unregister=function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t]===e){var i=this._probes.splice(t,1);i[0]&&this._removeDependentModels(i[0]);break}this.updateProbeData()},t.exists=function(e){if(0===this._probes.length)return!1;for(var t=0;t<this._probes.length;t++)if(this._probes[t].getProbeId()===e)return!0;return!1},t.getNewReflectionProbeId=function(){for(var e=0;;){if(!this.exists(e))return e;e++}},t.getProbes=function(){return this._probes},t.getProbeById=function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t].getProbeId()===e)return this._probes[t];return null},t.clearAll=function(){this._probes=[]},t.getProbeByCamera=function(e){for(var t=0;t<this._probes.length;t++)if(this._probes[t].camera===e)return this._probes[t];return null},t.updateBakedCubemap=function(e){var t=this._getModelsByProbe(e);if(e.cubemap){for(var i=0;i<t.length;i++){var o=t[i];this._updateCubemapOfModel(o,e)}if(e.needRefresh=!1,0===t.length)for(var r,n=H(this._useCubeModels.entries());!(r=n()).done;){var s=r.value;s[0].reflectionProbeBlendId===e.getProbeId()&&this._updateBlendCubemap(s[0],e)}}},t.updatePlanarMap=function(e,t){if(e.node&&e.node.scene){for(var i=this._getModelsByProbe(e),o=0;o<i.length;o++)this._updatePlanarMapOfModel(i[o],t,e);if(e.previewPlane){var r=e.previewPlane.getComponent(X);r&&r.updateProbePlanarMap(t)}}},t.updateUsePlanarModels=function(e){if(e.node&&e.worldBounds&&e.reflectionProbeType===ae.PLANAR_REFLECTION){for(var t=0;t<this._probes.length;t++){var i=this._probes[t];i.probeType===he.PLANAR&&e.node.layer&Xo&&(e.updateWorldBound(),G.aabbWithAABB(e.worldBounds,i.boundingBox)?this._usePlanarModels.set(e,i):this._usePlanarModels.has(e)&&this._usePlanarModels.get(e)===i&&(this._usePlanarModels.delete(e),this._updatePlanarMapOfModel(e,null,null)))}for(var o=0;o<this._probes.length;o++)this._probes[o].probeType===he.PLANAR&&(this._probes[o].realtimePlanarTexture?this.updatePlanarMap(this._probes[o],this._probes[o].realtimePlanarTexture.getGFXTexture()):this.updatePlanarMap(this._probes[o],null))}},t.updateUseCubeModels=function(e){if(e.node&&e.worldBounds&&e.node.layer&Xo){e.updateWorldBound();var t=this._getNearestProbe(e);t?this._useCubeModels.has(e)?(this._useCubeModels.get(e)!==t&&this._useCubeModels.set(e,t),t.needRefresh=!0):(this._useCubeModels.set(e,t),t.needRefresh=!0):(this._updateCubemapOfModel(e,null),this._useCubeModels.delete(e))}for(var i=0;i<this._probes.length;i++)(this._probes[i].needRefresh&&this._probes[i].probeType===he.CUBE||this._isUsedBlending(e))&&this.updateBakedCubemap(this._probes[i])},t.updatePreviewSphere=function(e){if(e&&e.previewSphere){var t=e.previewSphere.getComponent(X);t&&(t.updateProbeCubemap(e.cubemap),t.updateReflectionProbeId(e.getProbeId()))}},t.updatePreviewPlane=function(e){e&&e.previewPlane&&e.previewPlane.getComponent(X)&&e.realtimePlanarTexture&&this.updatePlanarMap(e,e.realtimePlanarTexture.getGFXTexture())},t.updateProbeData=function(){if(0!==this._probes.length){var e=this.getMaxProbeId(),t=e+1;this._dataTexture&&this._dataTexture.destroy();for(var i=new Float32Array(12*t),o=0,r=0;r<=e;r++){var n=this.getProbeById(r);if(n){if(n.probeType===he.CUBE){i[o]=n.node.worldPosition.x,i[o+1]=n.node.worldPosition.y,i[o+2]=n.node.worldPosition.z,i[o+3]=0,i[o+4]=n.size.x,i[o+5]=n.size.y,i[o+6]=n.size.z,i[o+7]=0;var s=n.isRGBE()?1e3:0;i[o+8]=n.cubemap?n.cubemap.mipmapLevel+s:1+s}else i[o]=n.node.up.x,i[o+1]=n.node.up.y,i[o+2]=n.node.up.z,i[o+3]=1,i[o+4]=1,i[o+5]=1,i[o+6]=0,i[o+7]=0,i[o+8]=1;o+=12}else o+=12}var a=new Uint8Array(i.buffer),h=new c({_data:a,_compressed:!1,width:12,height:t,format:l.RGBA8888});this._dataTexture=new p,this._dataTexture.setFilters(p.Filter.NONE,p.Filter.NONE),this._dataTexture.setMipFilter(p.Filter.NONE),this._dataTexture.setWrapMode(p.WrapMode.CLAMP_TO_EDGE,p.WrapMode.CLAMP_TO_EDGE,p.WrapMode.CLAMP_TO_EDGE),this._dataTexture.image=h,this._dataTexture.uploadData(a);for(var u=0;u<this._probes.length;u++)for(var d=this._probes[u],_=this._getModelsByProbe(d),g=0;g<_.length;g++){var y=_[g].node.getComponent(X);y&&y.updateReflectionProbeDataMap(this._dataTexture)}}},t.getMaxProbeId=function(){return 0===this._probes.length?-1:1===this._probes.length?this._probes[0].getProbeId():(this._probes.sort((function(e,t){return e.getProbeId()-t.getProbeId()})),this._probes[this._probes.length-1].getProbeId())},t.getUsedReflectionProbe=function(e,t){if(t){if(this._usePlanarModels.has(e))return this._usePlanarModels.get(e)}else if(this._useCubeModels.has(e))return this._useCubeModels.get(e);return null},t._getNearestProbe=function(e){if(!e.node||!e.worldBounds||0===this._probes.length)return null;for(var t,i=null,o=1/0,r=H(this._probes);!(t=r()).done;){var n=t.value;if(n.probeType===he.CUBE&&n.validate()&&G.aabbWithAABB(e.worldBounds,n.boundingBox)){var s=w.distance(e.node.worldPosition,n.node.worldPosition);s<o&&(o=s,i=n)}}return i},t._getBlendProbe=function(e){if(!e||!e.node||!e.worldBounds||this._probes.length<2)return null;for(var t=[],i=0;i<this._probes.length;i++)this._probes[i].probeType===he.CUBE&&this._probes[i].validate()&&G.aabbWithAABB(e.worldBounds,this._probes[i].boundingBox)&&t.push(this._probes[i]);return t.sort((function(t,i){return w.distance(e.node.worldPosition,t.node.worldPosition)-w.distance(e.node.worldPosition,i.node.worldPosition)})),t.length>1?t[1]:null},t._getModelsByProbe=function(e){var t=[],i=this._useCubeModels;e.probeType===he.PLANAR&&(i=this._usePlanarModels);for(var o,r=H(i.entries());!(o=r()).done;){var n=o.value;n[1]===e&&t.push(n[0])}return t},t._removeDependentModels=function(e){for(var t,i=H(this._useCubeModels.keys());!(t=i()).done;){var o=t.value,r=this._useCubeModels.get(o);void 0!==r&&r===e&&(this._useCubeModels.delete(o),this.updateUseCubeModels(o))}for(var n,s=H(this._usePlanarModels.keys());!(n=s()).done;){var a=n.value,h=this._usePlanarModels.get(a);void 0!==h&&h===e&&(this._usePlanarModels.delete(a),this.updateUsePlanarModels(a))}},t._updateCubemapOfModel=function(e,t){var i=e.node;if(i){var o=i.getComponent(X);o&&(o.updateProbeCubemap(t?t.cubemap:null),o.updateReflectionProbeId(t&&t.cubemap?t.getProbeId():-1),t&&(o.updateReflectionProbeDataMap(this._dataTexture),this._isUsedBlending(e)&&this._updateBlendProbeInfo(e,t)))}},t._updatePlanarMapOfModel=function(e,t,i){var o=e.node.getComponent(X);o&&(o.updateProbePlanarMap(t),i?(o.updateReflectionProbeId(i.getProbeId()),o.updateReflectionProbeDataMap(this._dataTexture)):o.updateReflectionProbeId(-1))},t._isUsedBlending=function(e){return e.reflectionProbeType===ae.BLEND_PROBES||e.reflectionProbeType===ae.BLEND_PROBES_AND_SKYBOX},t._updateBlendProbeInfo=function(e,t){var i=e.node;if(i){var o=i.getComponent(X);if(o){var r=this._getBlendProbe(e);r?(o.updateReflectionProbeBlendId(r.getProbeId()),o.updateProbeBlendCubemap(r.cubemap),o.updateReflectionProbeBlendWeight(this._calculateBlendWeight(e,t,r))):(o.updateReflectionProbeBlendId(-1),e.reflectionProbeType===ae.BLEND_PROBES_AND_SKYBOX&&o.updateReflectionProbeBlendWeight(this._calculateBlendWeight(e,t,r)))}}},t._updateBlendCubemap=function(e,t){var i=e.node;if(i&&this._isUsedBlending(e)){var o=i.getComponent(X);o&&o.updateProbeBlendCubemap(t.cubemap)}},t._calculateBlendWeight=function(e,t,i){if(i){var o=w.distance(e.node.worldPosition,t.node.worldPosition),r=w.distance(e.node.worldPosition,i.node.worldPosition);return 1-r/(o+r)}return e.reflectionProbeType===ae.BLEND_PROBES?0:e.reflectionProbeType===ae.BLEND_PROBES_AND_SKYBOX?this._calculateBlendOfSkybox(e.worldBounds,t.boundingBox):0},t._calculateBlendOfSkybox=function(e,t){if(!e)return 1;var i=new w,o=new w,r=new w,n=new w;if(w.subtract(i,e.center,e.halfExtents),w.add(o,e.center,e.halfExtents),w.subtract(r,t.center,t.halfExtents),w.add(n,t.center,t.halfExtents),i.x<=n.x&&o.x>=r.x&&i.y<=n.y&&o.y>=r.y&&i.z<=n.z&&o.z>=r.z){var s=new w;w.multiplyScalar(s,e.halfExtents,2);var a=i.x+s.x<=n.x&&o.x+s.x>=r.x,h=i.x-s.x<=n.x&&o.x-s.x>=r.x,c=i.y+s.y<=n.y&&o.y+s.y>=r.y,l=i.y-s.y<=n.y&&o.y-s.y>=r.y,p=i.z+s.z<=n.z&&o.z+s.z>=r.z,u=i.z-s.z<=n.z&&o.z-s.z>=r.z,d=[];if(!a){var _=o.x-n.x;d.push(_/s.x)}if(!h){var g=Math.abs(i.x-r.x);d.push(g/s.x)}if(!c){var y=o.y-n.y;d.push(y/s.y)}if(!l){var f=Math.abs(i.y-r.y);d.push(f/s.y)}if(!p){var m=o.z-n.z;d.push(m/s.z)}if(!u){var b=Math.abs(i.z-r.z);d.push(b/s.z)}return d.length>0?(d.sort((function(e,t){return t-e})),d[0]):0}return 1},v(e,[{key:"updateForRuntime",get:function(){return this._updateForRuntime},set:function(e){this._updateForRuntime=e}}]),e}());Vo.probeManager=void 0,Vo.probeManager=new Vo,b.internal.reflectionProbeManager=Vo.probeManager,function(e){e[e.Low_256x256=256]="Low_256x256",e[e.Medium_512x512=512]="Medium_512x512",e[e.High_768x768=768]="High_768x768"}(Ho||(Ho={})),e("d",(Do=O("cc.ReflectionProbe"),wo=R(w),Po=R(P(he)),Oo=R(P(Ho)),vo=R(P(ce)),Lo=R(B),Ro=R(pe.BitMask),So=R(de),Mo=R(T),Do(((Uo=function(e){function t(){for(var t,i=arguments.length,o=new Array(i),r=0;r<i;r++)o[r]=arguments[r];return(t=e.call.apply(e,[this].concat(o))||this)._lastSize=new w,t._resolution=ko&&ko(),t._clearFlag=zo&&zo(),t._backgroundColor=To&&To(),t._visibility=xo&&xo(),t._probeType=Eo&&Eo(),t._cubemap=No&&No(),t._size=Ao&&Ao(),t._sourceCamera=Fo&&Fo(),t._probeId=Io&&Io(),t._fastBake=jo&&jo(),t._probe=null,t._previewSphere=null,t._previewPlane=null,t._sourceCameraPos=new w(0,0,0),t}S(t,e);var i=t.prototype;return i.onLoad=function(){this._createProbe(),Vo.probeManager.registerEvent()},i.onEnable=function(){if(this._probe){var e=Vo.probeManager.getProbeById(this._probeId);null!==e&&e!==this._probe&&(this._probeId=Vo.probeManager.getNewReflectionProbeId(),this._probe.updateProbeId(this._probeId)),Vo.probeManager.register(this._probe),Vo.probeManager.onUpdateProbes(!0),this._probe.enable()}},i.onDisable=function(){this._probe&&(Vo.probeManager.unregister(this._probe),this._probe.disable())},i.start=function(){this._sourceCamera&&this.probeType===he.PLANAR&&(this.probe.renderPlanarReflection(this.sourceCamera.camera),Vo.probeManager.filterModelsForPlanarReflection()),Vo.probeManager.updateProbeData()},i.onDestroy=function(){this.probe&&this.probe.destroy()},i.update=function(){this.probe&&this.probeType===he.PLANAR&&this.sourceCamera&&(this.sourceCamera.node.hasChangedFlags&u.TRS||!this._sourceCameraPos.equals(this.sourceCamera.node.getWorldPosition()))&&(this._sourceCameraPos=this.sourceCamera.node.getWorldPosition(),this.probe.renderPlanarReflection(this.sourceCamera.camera))},i.clearBakedCubemap=function(){this.cubemap=null,Vo.probeManager.updateBakedCubemap(this.probe),Vo.probeManager.updatePreviewSphere(this.probe)},i._createProbe=function(){if((-1===this._probeId||Vo.probeManager.exists(this._probeId))&&(this._probeId=Vo.probeManager.getNewReflectionProbeId()),this._probe=new le(this._probeId),this._probe){var e=new d("ReflectionProbeCamera");e.hideFlags|=W.Flags.DontSave|W.Flags.HideInHierarchy,this.node.scene.addChild(e),this._probe.initialize(this.node,e),this.enabled&&Vo.probeManager.register(this._probe),this._probe.resolution=this._resolution,this._probe.clearFlag=this._clearFlag,this._probe.backgroundColor=this._backgroundColor,this._probe.visibility=this._visibility,this._probe.probeType=this._probeType,this._probe.size=this._size,this._probe.cubemap=this._cubemap}},v(t,[{key:"size",get:function(){return this._size},set:function(e){this._size.set(e),Z(this._size),this.probe.size=this._size,this.probe&&(Vo.probeManager.onUpdateProbes(!0),Vo.probeManager.updateProbeData())}},{key:"probeType",get:function(){return this._probeType},set:function(e){if(this.probe.probeType=e,e!==this._probeType){var i=this._size.clone(),o=w.equals(this._lastSize,w.ZERO);this._probeType=e,this._probeType===he.CUBE?(o&&this._size.set(t.DEFAULT_CUBE_SIZE),this.probe.switchProbeType(e,null),Vo.probeManager.clearPlanarReflectionMap(this.probe)):(o&&this._size.set(t.DEFAULT_PLANER_SIZE),this._sourceCamera?this.probe.switchProbeType(e,this._sourceCamera.camera):console.warn("the reflection camera is invalid, please set the reflection camera")),o||this._size.set(this._lastSize),this._lastSize.set(i),this.size=this._size}}},{key:"resolution",get:function(){return this._resolution},set:function(e){this._resolution=e,this.probe.resolution=e}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this.probe.clearFlag=this._clearFlag}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.probe.backgroundColor=this._backgroundColor}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this.probe.visibility=this._visibility}},{key:"sourceCamera",get:function(){return this._sourceCamera},set:function(e){this._sourceCamera=e,e&&(this.visibility=e.visibility,this.clearFlag=e.clearFlags,this.backgroundColor=e.clearColor,this.probeType===he.PLANAR&&this.probe.switchProbeType(this.probeType,e.camera))}},{key:"fastBake",get:function(){return this._fastBake},set:function(e){this._fastBake=e}},{key:"cubemap",get:function(){return this._cubemap},set:function(e){this._cubemap=e,this.probe.cubemap=e,Vo.probeManager.onUpdateProbes(!0)}},{key:"probe",get:function(){return this._probe}},{key:"previewSphere",get:function(){return this._previewSphere},set:function(e){this._previewSphere=e,this.probe&&(this.probe.previewSphere=e,this._previewSphere&&Vo.probeManager.updatePreviewSphere(this.probe))}},{key:"previewPlane",get:function(){return this._previewPlane},set:function(e){this._previewPlane=e,this.probe&&(this.probe.previewPlane=e,this._previewPlane&&Vo.probeManager.updatePreviewPlane(this.probe))}}]),t}(K)).DEFAULT_CUBE_SIZE=new w(1,1,1),Uo.DEFAULT_PLANER_SIZE=new w(5,.5,5),ko=L((Bo=Uo).prototype,"_resolution",[C],(function(){return 256})),zo=L(Bo.prototype,"_clearFlag",[C],(function(){return ce.SKYBOX})),To=L(Bo.prototype,"_backgroundColor",[C],(function(){return new B(0,0,0,255)})),xo=L(Bo.prototype,"_visibility",[C],(function(){return ue})),Eo=L(Bo.prototype,"_probeType",[C],(function(){return he.CUBE})),No=L(Bo.prototype,"_cubemap",[C],(function(){return null})),Ao=L(Bo.prototype,"_size",[C],(function(){return new w(1,1,1)})),Fo=L(Bo.prototype,"_sourceCamera",[C],(function(){return null})),Io=L(Bo.prototype,"_probeId",[C],(function(){return-1})),jo=L(Bo.prototype,"_fastBake",[C],(function(){return!1})),M(Bo.prototype,"size",[wo],Object.getOwnPropertyDescriptor(Bo.prototype,"size"),Bo.prototype),M(Bo.prototype,"probeType",[Po],Object.getOwnPropertyDescriptor(Bo.prototype,"probeType"),Bo.prototype),M(Bo.prototype,"resolution",[Oo],Object.getOwnPropertyDescriptor(Bo.prototype,"resolution"),Bo.prototype),M(Bo.prototype,"clearFlag",[vo],Object.getOwnPropertyDescriptor(Bo.prototype,"clearFlag"),Bo.prototype),M(Bo.prototype,"backgroundColor",[Lo],Object.getOwnPropertyDescriptor(Bo.prototype,"backgroundColor"),Bo.prototype),M(Bo.prototype,"visibility",[Ro],Object.getOwnPropertyDescriptor(Bo.prototype,"visibility"),Bo.prototype),M(Bo.prototype,"sourceCamera",[So],Object.getOwnPropertyDescriptor(Bo.prototype,"sourceCamera"),Bo.prototype),M(Bo.prototype,"fastBake",[Mo],Object.getOwnPropertyDescriptor(Bo.prototype,"fastBake"),Bo.prototype),Co=Bo))||Co)),b.utils=Be}}}));
