System.register(["./index-68ccac70.js","./find-222dc7da.js","./node-event-40319828.js","./director-56fe9b8d.js","./create-mesh-1be8f092.js","./pipeline-state-manager-8f16c5a7.js","./buffer-barrier-d1733967.js","./deprecated-0752a51c.js","./deprecated-2e80a469.js","./camera-component-9188fe5a.js","./model-renderer-8b84c274.js","./renderer-7bc9d919.js","./index-811842a0.js","./mesh-97b1b18c.js","./instantiate-42c48975.js","./touch-685512cb.js","./mesh-renderer-c40c4f87.js","./util-06cac5ac.js","./capsule-212e055a.js","./skeleton-99c82a69.js","./deprecated-51f2c4c2.js","./deprecated-37e42d8f.js"],(function(t){"use strict";var e,i,s,r,n,o,a,l,h,u,c,_,d,p,f,m,v,y,M,g,S,b,T,x,w,A,R,O,C,E,F,D,P,z,I,B,L,V,N,k,U,G,X,H,W,Y,j,Z,q,Q,K,J,$,tt,et,it,st,rt,nt,ot,at,lt,ht,ut,ct,_t,dt,pt,ft,mt,vt,yt,Mt,gt,St,bt,Tt,xt,wt,At,Rt,Ot,Ct,Et,Ft,Dt,Pt;return{setters:[function(t){e=t.bD,i=t.bF,s=t.bA,r=t.B,n=t.l,o=t.bx,a=t.bE,l=t.b$,h=t.q,u=t.O,c=t.N,_=t.bg,d=t.o,p=t.aq,f=t.aa,m=t.L,v=t.I,y=t.cJ,M=t.aQ,g=t.F,S=t.cK,b=t.cf,T=t.aZ,x=t.be,w=t.V,A=t.Q,R=t.t,O=t.U,C=t.W,E=t.X,F=t.cL,D=t.Y,P=t.a1,z=t.bf,I=t.a2,B=t.J,L=t.i,V=t.R,N=t.w,k=t.f,U=t.d,G=t.P,X=t.cM,H=t.bz,W=t.au,Y=t.at,j=t.ce,Z=t.bC,q=t.ct,Q=t.av,K=t.ah,J=t.ag,$=t.cq},function(t){tt=t.a6,et=t.ac,it=t.a3,st=t._,rt=t.a2,nt=t.av,ot=t.aw,at=t.ay,lt=t.M,ht=t.s,ut=t.T,ct=t.N},function(t){_t=t.C},function(t){dt=t.h,pt=t.M,ft=t.a3,mt=t.a2},function(t){vt=t._},function(t){yt=t.d},function(t){Mt=t.v,gt=t.aq,St=t.aP,bt=t.b,Tt=t.aQ,xt=t.a9,wt=t.d,At=t.f,Rt=t.F,Ot=t.A,Ct=t.j},function(){},function(){},function(){},function(t){Et=t.M},function(t){Ft=t.R},function(){},function(t){Dt=t.M},function(t){Pt=t.i},function(){},function(){},function(){},function(){},function(){},function(){},function(){}],execute:function(){var zt,It,Bt,Lt,Vt,Nt,kt,Ut,Gt,Xt=(zt=e("cc.Billboard"),It=i(it),Bt=i(it),zt((Vt=function(t){function e(){var e;return(e=t.call(this)||this)._texture=Nt&&Nt(),e._height=kt&&kt(),e._width=Ut&&Ut(),e._rotation=Gt&&Gt(),e._model=null,e._mesh=null,e._material=null,e._uniform=new h(1,1,0,0),e}s(e,t);var i=e.prototype;return i.onLoad=function(){this.createModel()},i.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},i.onDisable=function(){this.detachFromScene()},i.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},i.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},i.createModel=function(){this._mesh=vt({primitiveMode:Mt.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[r.WHITE.r,r.WHITE.g,r.WHITE.b,r.WHITE.a,r.WHITE.r,r.WHITE.g,r.WHITE.b,r.WHITE.a,r.WHITE.r,r.WHITE.g,r.WHITE.b,r.WHITE.a,r.WHITE.r,r.WHITE.g,r.WHITE.b,r.WHITE.a],attributes:[new gt(St.ATTR_POSITION,bt.RGB32F),new gt(St.ATTR_TEX_COORD,bt.RG32F),new gt(St.ATTR_COLOR,bt.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var t=this._model=n.director.root.createModel(dt,this.node);t.node=t.transform=this.node,null==this._material&&(this._material=new tt,this._material.copy(et.get("default-billboard-material"))),t.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},o(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this._material&&this._material.setProperty("mainTexture",t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._material&&(this._uniform.y=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._material&&(this._uniform.x=t,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*u(this._rotation))/100},set:function(t){this._rotation=c(t),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),e}(_t),Nt=a(Vt.prototype,"_texture",[It],(function(){return null})),l(Vt.prototype,"texture",[Bt],Object.getOwnPropertyDescriptor(Vt.prototype,"texture"),Vt.prototype),kt=a(Vt.prototype,"_height",[_],(function(){return 0})),Ut=a(Vt.prototype,"_width",[_],(function(){return 0})),Gt=a(Vt.prototype,"_rotation",[_],(function(){return 0})),Lt=Vt))||Lt);t({Billboard:Xt,BillboardComponent:Xt});var Ht,Wt,Yt,jt,Zt,qt,Qt,Kt,Jt,$t,te,ee,ie,se,re,ne,oe,ae,le=[new gt(St.ATTR_POSITION,bt.RGB32F),new gt(St.ATTR_TEX_COORD,bt.RGBA32F),new gt(St.ATTR_TEX_COORD1,bt.RGB32F),new gt(St.ATTR_COLOR,bt.RGBA8,!0)],he=new d,ue=new d,ce=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._subMeshData=null,e._vertCount=0,e._indexCount=0,e._material=null,e._iaVertCount=0,e._iaIndexCount=0,e.type=pt.LINE,e._capacity=100,e}s(e,t);var i=e.prototype;return i.setCapacity=function(t){this._capacity=t,this.createBuffer()},i.createBuffer=function(){this._vertSize=0;for(var t=0,e=le;t<e.length;t++){var i=e[t];i.offset=this._vertSize,this._vertSize+=Tt[i.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},i.updateMaterial=function(e){this._material=e,t.prototype.setSubModelMaterial.call(this,0,e)},i.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var t=this._device.createBuffer(new xt(wt.VERTEX|wt.TRANSFER_DST,At.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),e=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);t.update(e);for(var i=new Uint16Array((this._capacity-1)*this._indexCount),s=0,r=0;r<this._capacity-1;++r){var n=2*r;i[s++]=n,i[s++]=n+1,i[s++]=n+2,i[s++]=n+3,i[s++]=n+2,i[s++]=n+1}var o=this._device.createBuffer(new xt(wt.INDEX|wt.TRANSFER_DST,At.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return o.update(i),this._iaVertCount=this._capacity*this._vertCount,this._iaIndexCount=(this._capacity-1)*this._indexCount,this._subMeshData=new st([t],le,Mt.TRIANGLE_LIST,o),this.initSubModel(0,this._subMeshData,this._material),e},i.addLineVertexData=function(t,e,i){if(t.length>1){var s=0;d.subtract(he,t[1],t[0]),this._vdataF32[s++]=t[0].x,this._vdataF32[s++]=t[0].y,this._vdataF32[s++]=t[0].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(0,1),this._vdataF32[s++]=0,this._vdataF32[s++]=0,this._vdataF32[s++]=he.x,this._vdataF32[s++]=he.y,this._vdataF32[s++]=he.z,this._vdataUint32[s++]=i.evaluate(0,1)._val,this._vdataF32[s++]=t[0].x,this._vdataF32[s++]=t[0].y,this._vdataF32[s++]=t[0].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(0,1),this._vdataF32[s++]=0,this._vdataF32[s++]=1,this._vdataF32[s++]=he.x,this._vdataF32[s++]=he.y,this._vdataF32[s++]=he.z,this._vdataUint32[s++]=i.evaluate(0,1)._val;for(var r=1;r<t.length-1;r++){d.subtract(he,t[r-1],t[r]),d.subtract(ue,t[r+1],t[r]),d.subtract(ue,ue,he);var n=r/t.length;this._vdataF32[s++]=t[r].x,this._vdataF32[s++]=t[r].y,this._vdataF32[s++]=t[r].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(n,1),this._vdataF32[s++]=n,this._vdataF32[s++]=0,this._vdataF32[s++]=ue.x,this._vdataF32[s++]=ue.y,this._vdataF32[s++]=ue.z,this._vdataUint32[s++]=i.evaluate(n,1)._val,this._vdataF32[s++]=t[r].x,this._vdataF32[s++]=t[r].y,this._vdataF32[s++]=t[r].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(n,1),this._vdataF32[s++]=n,this._vdataF32[s++]=1,this._vdataF32[s++]=ue.x,this._vdataF32[s++]=ue.y,this._vdataF32[s++]=ue.z,this._vdataUint32[s++]=i.evaluate(n,1)._val}d.subtract(he,t[t.length-1],t[t.length-2]),this._vdataF32[s++]=t[t.length-1].x,this._vdataF32[s++]=t[t.length-1].y,this._vdataF32[s++]=t[t.length-1].z,this._vdataF32[s++]=0,this._vdataF32[s++]=e.evaluate(1,1),this._vdataF32[s++]=1,this._vdataF32[s++]=0,this._vdataF32[s++]=he.x,this._vdataF32[s++]=he.y,this._vdataF32[s++]=he.z,this._vdataUint32[s++]=i.evaluate(1,1)._val,this._vdataF32[s++]=t[t.length-1].x,this._vdataF32[s++]=t[t.length-1].y,this._vdataF32[s++]=t[t.length-1].z,this._vdataF32[s++]=1,this._vdataF32[s++]=e.evaluate(1,1),this._vdataF32[s++]=1,this._vdataF32[s++]=1,this._vdataF32[s++]=he.x,this._vdataF32[s++]=he.y,this._vdataF32[s++]=he.z,this._vdataUint32[s++]=i.evaluate(1,1)._val}this.updateIA(Math.max(0,t.length-1))},i.updateIA=function(t){var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.firstIndex=0,e.indexCount=this._indexCount*t,e.vertexCount=this._iaVertCount},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},e}(dt),_e=p.Attr.setClassAttr,de=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],pe=f({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),fe=t("CurveRange",e("cc.CurveRange")(((Wt=function(){function t(){this.constant=0,this.constantMin=0,this.constantMax=0,this.multiplier=1,this._mode=pe.Constant}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){default:case pe.Constant:return this.constant;case pe.Curve:return this.spline.evaluate(t)*this.multiplier;case pe.TwoCurves:return m(this.splineMin.evaluate(t),this.splineMax.evaluate(t),e)*this.multiplier;case pe.TwoConstants:return m(this.constantMin,this.constantMax,e)}},e.getMax=function(){switch(this._mode){default:case pe.Constant:return this.constant;case pe.Curve:return this.multiplier;case pe.TwoConstants:return this.constantMax;case pe.TwoCurves:return this.multiplier}},e.isZero=function(){switch(this._mode){default:case pe.Constant:return v(this.constant,0,g);case pe.Curve:return v(this.multiplier,0,g);case pe.TwoConstants:return v(Math.max(Math.abs(this.constantMax),Math.abs(this.constantMin)),0,g);case pe.TwoCurves:return v(this.multiplier,0,g)}},e._onBeforeSerialize=function(){return de[this._mode]},o(t,[{key:"mode",get:function(){return this._mode},set:function(t){switch(this._mode=t,t){case pe.Constant:case pe.TwoConstants:break;case pe.Curve:this.spline||(this.spline=y());break;case pe.TwoCurves:this.splineMax||(this.splineMax=y()),this.splineMin||(this.splineMin=y())}}},{key:"curve",get:function(){var t;return null!==(t=this._curve)&&void 0!==t?t:this._curve=new S(this.spline)},set:function(t){this._curve=t,this.spline=t._internalCurve}},{key:"curveMin",get:function(){var t;return null!==(t=this._curveMin)&&void 0!==t?t:this._curveMin=new S(this.splineMin)},set:function(t){this._curveMin=t,this.splineMin=t._internalCurve}},{key:"curveMax",get:function(){var t;return null!==(t=this._curveMax)&&void 0!==t?t:this._curveMax=new S(this.splineMax)},set:function(t){this._curveMax=t,this.splineMax=t._internalCurve}}]),t}()).Mode=pe,Ht=Wt))||Ht);function me(t,e,i){switch(t.mode){case pe.Constant:return t.constant;case pe.Curve:return t.spline.evaluate(e)*t.multiplier;case pe.TwoCurves:return 0===i?t.splineMin.evaluate(e)*t.multiplier:t.splineMax.evaluate(e)*t.multiplier;case pe.TwoConstants:return 0===i?t.constantMin:t.constantMax;default:return 0}}function ve(t){switch(t.mode){case pe.TwoConstants:case pe.TwoCurves:return 2;default:return 1}}function ye(t,e,i,s){return null===t||i!==t.width||s!==t.height?(t&&t.destroy(),t=function(t,e,i){var s=new rt({width:e,height:i,_data:t,_compressed:!1,format:nt.RGBA32F}),r=new it;return r.setFilters(ot.NEAREST,ot.NEAREST),r.setMipFilter(ot.NONE),r.setWrapMode(at.CLAMP_TO_EDGE,at.CLAMP_TO_EDGE,at.CLAMP_TO_EDGE),r.image=s,r}(e,i,s)):t.uploadData(e),t}function Me(t,e,i,s,r,n,o){var a=Math.max(ve(s),ve(r),ve(n)),l=i*a*4;null!==e&&e.length===l||(e=new Float32Array(i*a*4));for(var h=[s,r,n],u=1/(i-1),c=0;c<a;c++)for(var _=0;_<3;_++)for(var d=h[_],p=0,f=0,m=0;m<i;m++){var v=me(d,u*m,c);f=o?v:(p+=v)/(m+1),e[4*(c*i+m)+_]=f}return{texture:ye(t,e,i,a),texdata:e}}p.fastDefine("cc.CurveRange",fe,{multiplier:1,constantMax:0,constantMin:0,constant:0,mode:pe.Constant,splineMax:Object.freeze(y()),splineMin:Object.freeze(y()),spline:Object.freeze(y())}),_e(fe,"multiplier","visible",!0),_e(fe,"constantMax","visible",!0),_e(fe,"constantMin","visible",!0),_e(fe,"constant","visible",!0),_e(fe,"mode","type","Enum"),_e(fe,"mode","enumList",f.getList(pe)),_e(fe,"mode","visible",!0),_e(fe,"splineMax","type","Object"),_e(fe,"splineMax","ctor",M),_e(fe,"splineMax","visible",!0),_e(fe,"splineMin","type","Object"),_e(fe,"splineMin","ctor",M),_e(fe,"splineMin","visible",!0),_e(fe,"spline","type","Object"),_e(fe,"spline","ctor",M),_e(fe,"spline","visible",!0);var ge,Se,be,Te,xe,we,Ae,Re,Oe,Ce,Ee,Fe,De,Pe,ze,Ie,Be,Le,Ve,Ne,ke=b,Ue=f({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),Ge=new r,Xe=new r,He=t("GradientRange",(Yt=e("cc.GradientRange"),jt=i(Ue),Zt=i(T),qt=i(T),Qt=i(T),Kt=i(Ue),Yt(((ae=function(){function t(){this.color=te&&te(),this.colorMin=ee&&ee(),this.colorMax=ie&&ie(),this.gradient=se&&se(),this.gradientMin=re&&re(),this.gradientMax=ne&&ne(),this._mode=oe&&oe(),this._color=r.WHITE.clone()}var e=t.prototype;return e.evaluate=function(t,e){switch(this._mode){case Ue.Color:return this.color;case Ue.TwoColors:return r.lerp(this._color,this.colorMin,this.colorMax,e),this._color;case Ue.RandomColor:return this.gradient.getRandomColor(this._color);case Ue.Gradient:return this.gradient.evaluateFast(this._color,t);case Ue.TwoGradients:return r.lerp(this._color,this.gradientMin.evaluateFast(Ge,t),this.gradientMax.evaluateFast(Xe,t),e),this._color;default:return this.color}},e._onBeforeSerialize=function(){return ke[this._mode]},o(t,[{key:"mode",get:function(){return this._mode},set:function(t){this._mode=t}}]),t}()).Mode=Ue,l(($t=ae).prototype,"mode",[jt],Object.getOwnPropertyDescriptor($t.prototype,"mode"),$t.prototype),te=a($t.prototype,"color",[_],(function(){return r.WHITE.clone()})),ee=a($t.prototype,"colorMin",[_],(function(){return r.WHITE.clone()})),ie=a($t.prototype,"colorMax",[_],(function(){return r.WHITE.clone()})),se=a($t.prototype,"gradient",[Zt],(function(){return new T})),re=a($t.prototype,"gradientMin",[qt],(function(){return new T})),ne=a($t.prototype,"gradientMax",[Qt],(function(){return new T})),oe=a($t.prototype,"_mode",[Kt],(function(){return Ue.Color})),Jt=$t))||Jt));function We(t,e,i){switch(t.mode){case Ue.Color:return t.color;case Ue.TwoColors:return 0===i?t.colorMin:t.colorMax;case Ue.RandomColor:return t.gradient.getRandomColor(Ge);case Ue.Gradient:return t.gradient.evaluateFast(Ge,e);case Ue.TwoGradients:return 0===i?t.gradientMin.evaluateFast(Ge,e):t.gradientMax.evaluateFast(Ge,e);default:return t.color}}var Ye={CC_USE_WORLD_SPACE:!1,CC_USE_WORLD_SCALE:!0},je=(ge=e("cc.Line"),Se=i(it),be=i(it),Te=i(tt),xe=i([d]),we=i([d]),Ae=i(fe),Re=i(He),Oe=i(w),Ce=i(w),ge((Fe=function(t){function e(){var e;return(e=t.call(this)||this)._texture=De&&De(),e._material=Pe&&Pe(),e._worldSpace=ze&&ze(),e._positions=Ie&&Ie(),e._width=Be&&Be(),e._color=Le&&Le(),e._tile=Ve&&Ve(),e._tile_offset=new h,e._offset=Ne&&Ne(),e}s(e,t);var i=e.prototype;return i.onLoad=function(){var t=n.director.root.createModel(ce);if(0===this._models.length?this._models.push(t):this._models[0]=t,t.node=t.transform=this.node,this._material&&(this.lineMaterial=this._material,this._material=null),null===this.lineMaterial){var e=et.get("default-trail-material");this.material=e}var i=this.getMaterialInstance(0);i&&(Ye.CC_USE_WORLD_SPACE=this.worldSpace,i.recompileShaders(Ye),t.updateMaterial(i)),t.setCapacity(100)},i.onEnable=function(){t.prototype.onEnable.call(this),0!==this._models.length&&this._models[0]&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._models[0].addLineVertexData(this._positions,this.width,this.color))},i.onDisable=function(){this._models.length>0&&this._models[0]&&this._detachFromScene()},i._attachToScene=function(){if(t.prototype._attachToScene.call(this),this._models.length>0&&this._models[0]&&this.node&&this.node.scene){var e=this._models[0];e.scene&&this._detachFromScene(),this._getRenderScene().addModel(e)}},i._detachFromScene=function(){if(t.prototype._detachFromScene.call(this),this._models.length>0&&this._models[0]){var e=this._models[0];e.scene&&e.scene.removeModel(e)}},i._onMaterialModified=function(e,i){t.prototype._onMaterialModified.call(this,e,i);var s=this.getMaterialInstance(0);s&&(Ye.CC_USE_WORLD_SPACE=this.worldSpace,s.recompileShaders(Ye),this._models[0]&&this._models[0].updateMaterial(s))},o(e,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture=t,this.material&&this.material.setProperty("mainTexture",t)}},{key:"lineMaterial",get:function(){return this.getSharedMaterial(0)},set:function(t){this.setMaterial(t,0)}},{key:"sharedMaterials",get:function(){return t.prototype.sharedMaterials},set:function(t){this.sharedMaterials=t}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(t){this._worldSpace=t;var e=this.getMaterialInstance(0);e&&(Ye.CC_USE_WORLD_SPACE=this.worldSpace,e.recompileShaders(Ye),this._models[0]&&this._models[0].setSubModelMaterial(0,e))}},{key:"positions",get:function(){return this._positions},set:function(t){this._positions=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this.width,this.color)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this._width,this._color)}},{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._models[0]&&this._models[0].addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(t){this._tile.set(t),this.material&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this.material.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t),this.material&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this.material.setProperty("mainTiling_Offset",this._tile_offset))}}]),e}(Et),De=a(Fe.prototype,"_texture",[Se],(function(){return null})),l(Fe.prototype,"texture",[be],Object.getOwnPropertyDescriptor(Fe.prototype,"texture"),Fe.prototype),Pe=a(Fe.prototype,"_material",[_],(function(){return null})),l(Fe.prototype,"lineMaterial",[Te],Object.getOwnPropertyDescriptor(Fe.prototype,"lineMaterial"),Fe.prototype),l(Fe.prototype,"sharedMaterials",[x,_],Object.getOwnPropertyDescriptor(Fe.prototype,"sharedMaterials"),Fe.prototype),ze=a(Fe.prototype,"_worldSpace",[_],(function(){return!1})),Ie=a(Fe.prototype,"_positions",[xe],(function(){return[]})),l(Fe.prototype,"positions",[we],Object.getOwnPropertyDescriptor(Fe.prototype,"positions"),Fe.prototype),l(Fe.prototype,"width",[Ae],Object.getOwnPropertyDescriptor(Fe.prototype,"width"),Fe.prototype),Be=a(Fe.prototype,"_width",[_],(function(){return new fe})),l(Fe.prototype,"color",[Re],Object.getOwnPropertyDescriptor(Fe.prototype,"color"),Fe.prototype),Le=a(Fe.prototype,"_color",[_],(function(){return new He})),Ve=a(Fe.prototype,"_tile",[_],(function(){return new w(1,1)})),l(Fe.prototype,"tile",[Oe],Object.getOwnPropertyDescriptor(Fe.prototype,"tile"),Fe.prototype),Ne=a(Fe.prototype,"_offset",[_],(function(){return new w(0,0)})),l(Fe.prototype,"offset",[Ce],Object.getOwnPropertyDescriptor(Fe.prototype,"offset"),Fe.prototype),Ee=Fe))||Ee);t({Line:je,LineComponent:je});var Ze=function(){function t(t){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=t,this.position=new d(0,0,0),this.velocity=new d(0,0,0),this.animatedVelocity=new d(0,0,0),this.ultimateVelocity=new d(0,0,0),this.angularVelocity=new d(0,0,0),this.axisOfRotation=new d(0,0,0),this.rotation=new d(0,0,0),this.startEuler=new d(0,0,0),this.startRotation=new A,this.startRotated=!1,this.deltaQuat=new A,this.deltaMat=new R,this.localMat=new R,this.startSize=new d(0,0,0),this.size=new d(0,0,0),this.startColor=r.WHITE.clone(),this.color=r.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return t.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},t}();Ze.INDENTIFY_NEG_QUAT=10,Ze.R2D=180/Math.PI;var qe,Qe,Ke,Je,$e,ti,ei="colorModule",ii="rotationModule",si="sizeModule",ri="textureModule",ni="noiseModule",oi=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule","noiseModule"],ai=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule","_trailModule"],li=function(){function t(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var e=t.prototype;return e.bindTarget=function(t){this.target=t},e.update=function(){},t}(),hi=f({World:0,Local:1,Custom:2}),ui=f({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),ci=f({World:0,Local:1,View:2}),_i=f({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),di=f({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),pi=f({Base:0,Edge:1,Shell:2,Volume:3}),fi=f({Random:0,Loop:1,PingPong:2}),mi=f({Particles:0}),vi=f({Stretch:0}),yi=new d(0,0,-1);function Mi(t,e,i,s){return e!==t?(t===hi.World||R.invert(i,i),R.getRotation(s,i),!0):(A.set(s,0,0,0,1),!1)}function gi(t,e){w.set(t,Math.cos(e),Math.sin(e))}function Si(t){var e=C(-1,1),i=C(0,2*Math.PI),s=Math.sqrt(1-e*e),r=s*Math.cos(i),n=s*Math.sin(i);d.set(t,r,n,e)}function bi(t,e,i){Si(t),d.multiplyScalar(t,t,e+(i-e)*O())}function Ti(t,e,i,s){gi(t,s),t.z=0,d.multiplyScalar(t,t,e+(i-e)*O())}function xi(t){for(var e=0;e<t.length;e++){var i=e+E(0,t.length-e),s=t[i];t[i]=t[e],t[e]=s}}function wi(){var t=C(-1,1);return 0===t&&t++,F(t)}function Ai(t){var e=fe.Mode;switch(t.mode){case e.TwoCurves:case e.TwoConstants:return!0;default:return!1}}var Ri,Oi,Ci,Ei,Fi,Di,Pi,zi,Ii,Bi,Li,Vi,Ni,ki,Ui,Gi,Xi,Hi,Wi,Yi,ji,Zi,qi,Qi,Ki,Ji,$i,ts,es,is,ss,rs,ns,os,as,ls,hs,us,cs,_s=(qe=e("cc.ColorOvertimeModule"),Qe=i(He),qe((Je=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=$e&&$e(),e.color=ti&&ti(),e.name=ei,e}return s(e,t),e.prototype.animate=function(t){t.color.set(t.startColor);var e=function(t){var e=He.Mode;switch(t.mode){case e.TwoGradients:case e.TwoColors:return!0;default:return!1}}(this.color)?D(t.randomSeed+91041):0;t.color.multiply(this.color.evaluate(1-t.remainingLifetime/t.startLifetime,e))},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(li),$e=a(Je.prototype,"_enable",[_],(function(){return!1})),ti=a(Je.prototype,"color",[Qe,_],(function(){return new He})),Ke=Je))||Ke),ds=212165,ps=new d,fs=(Ri=e("cc.ForceOvertimeModule"),Oi=i(fe),Ci=i(fe),Ei=i(fe),Fi=i(hi),Ri((Pi=function(t){function e(){var e;return(e=t.call(this)||this)._enable=zi&&zi(),e.x=Ii&&Ii(),e.y=Bi&&Bi(),e.z=Li&&Li(),e.space=Vi&&Vi(),e.randomized=!1,e.rotation=void 0,e.needTransform=void 0,e.name="forceModule",e.rotation=new A,e.needTransform=!1,e.needUpdate=!0,e}s(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=Mi(t,this.space,e,this.rotation)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,s=Ai(this.x)?D(t.randomSeed+ds):0,r=Ai(this.y)?D(t.randomSeed+ds):0,n=Ai(this.z)?D(t.randomSeed+ds):0,o=d.set(ps,this.x.evaluate(i,s),this.y.evaluate(i,r),this.z.evaluate(i,n));this.needTransform&&d.transformQuat(o,o,this.rotation),d.scaleAndAdd(t.velocity,t.velocity,o,e),d.copy(t.ultimateVelocity,t.velocity)},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(li),zi=a(Pi.prototype,"_enable",[_],(function(){return!1})),Ii=a(Pi.prototype,"x",[Oi,_],(function(){return new fe})),Bi=a(Pi.prototype,"y",[Ci,_],(function(){return new fe})),Li=a(Pi.prototype,"z",[Ei,_],(function(){return new fe})),Vi=a(Pi.prototype,"space",[Fi,_],(function(){return hi.Local})),Di=Pi))||Di),ms=23541,vs=new d,ys=new d,Ms=(Ni=e("cc.LimitVelocityOvertimeModule"),ki=i(fe),Ui=i(fe),Gi=i(fe),Xi=i(fe),Hi=i(hi),Ni((Yi=function(t){function e(){var e;return(e=t.call(this)||this)._enable=ji&&ji(),e.limitX=Zi&&Zi(),e.limitY=qi&&qi(),e.limitZ=Qi&&Qi(),e.limit=Ki&&Ki(),e.dampen=Ji&&Ji(),e.separateAxes=$i&&$i(),e.space=ts&&ts(),e.drag=null,e.multiplyDragByParticleSize=!1,e.multiplyDragByParticleVelocity=!1,e.name="limitModule",e.rotation=void 0,e.needTransform=void 0,e.rotation=new A,e.needTransform=!1,e.needUpdate=!0,e}s(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=Mi(t,this.space,e,this.rotation)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=vs;if(this.separateAxes){var s=Ai(this.limitX)?D(t.randomSeed+ms):0,r=Ai(this.limitY)?D(t.randomSeed+ms):0,n=Ai(this.limitZ)?D(t.randomSeed+ms):0;d.set(ys,this.limitX.evaluate(e,s),this.limitY.evaluate(e,r),this.limitZ.evaluate(e,n)),this.needTransform&&d.transformQuat(ys,ys,this.rotation),d.set(i,gs(t.ultimateVelocity.x,ys.x,this.dampen),gs(t.ultimateVelocity.y,ys.y,this.dampen),gs(t.ultimateVelocity.z,ys.z,this.dampen))}else{d.normalize(i,t.ultimateVelocity);var o=Ai(this.limit)?D(t.randomSeed+ms):0;d.multiplyScalar(i,i,gs(t.ultimateVelocity.length(),this.limit.evaluate(e,o),this.dampen))}d.copy(t.ultimateVelocity,i),d.copy(t.velocity,t.ultimateVelocity)},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(li),ji=a(Yi.prototype,"_enable",[_],(function(){return!1})),Zi=a(Yi.prototype,"limitX",[ki,_],(function(){return new fe})),qi=a(Yi.prototype,"limitY",[Ui,_],(function(){return new fe})),Qi=a(Yi.prototype,"limitZ",[Gi,_],(function(){return new fe})),Ki=a(Yi.prototype,"limit",[Xi,_],(function(){return new fe})),Ji=a(Yi.prototype,"dampen",[_],(function(){return 3})),$i=a(Yi.prototype,"separateAxes",[_],(function(){return!1})),ts=a(Yi.prototype,"space",[Hi,_],(function(){return hi.Local})),Wi=Yi))||Wi);function gs(t,e,i){var s=Math.sign(t),r=Math.abs(t);if(r>e){var n=r-r*i;r=n>e?n:e}return r*s}var Ss,bs,Ts,xs,ws,As,Rs,Os,Cs,Es,Fs,Ds,Ps,zs,Is,Bs,Ls,Vs,Ns,ks,Us,Gs,Xs,Hs,Ws,Ys,js,Zs,qs,Qs,Ks,Js,$s,tr,er,ir,sr,rr,nr,or,ar,lr,hr,ur,cr,_r,dr,pr,fr,mr,vr,yr,Mr,gr,Sr,br,Tr,xr,wr,Ar,Rr,Or,Cr,Er,Fr,Dr,Pr,zr,Ir,Br,Lr,Vr,Nr,kr,Ur,Gr,Xr,Hr,Wr,Yr,jr,Zr,qr,Qr,Kr,Jr,$r=125292,tn=(es=e("cc.RotationOvertimeModule"),is=i(fe),ss=i(fe),rs=i(fe),es((os=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=as&&as(),e._separateAxes=ls&&ls(),e.x=hs&&hs(),e.y=us&&us(),e.z=cs&&cs(),e.name=ii,e._startMat=new R,e._matRot=new R,e._quatRot=new A,e._otherEuler=new d,e}s(e,t);var i=e.prototype;return i._processRotation=function(t){var e=t.particleSystem.processor.getInfo().renderMode;e!==_i.Mesh&&e===_i.StrecthedBillboard&&this._quatRot.set(0,0,0,1),A.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=Ze.INDENTIFY_NEG_QUAT)},i.animate=function(t,e){var i=1-t.remainingLifetime/t.startLifetime,s=Ai(this.z)?D(t.randomSeed+$r):0,r=t.particleSystem.processor.getInfo().renderMode;if(this._separateAxes&&r!==_i.VerticalBillboard&&r!==_i.HorizontalBillboard){var n=Ai(this.x)?D(t.randomSeed+$r):0,o=Ai(this.y)?D(t.randomSeed+$r):0;A.fromEuler(t.deltaQuat,this.x.evaluate(i,n)*e*Ze.R2D,this.y.evaluate(i,o)*e*Ze.R2D,this.z.evaluate(i,s)*e*Ze.R2D)}else A.fromEuler(t.deltaQuat,0,0,this.z.evaluate(i,s)*e*Ze.R2D);t.deltaMat=R.fromQuat(t.deltaMat,t.deltaQuat),t.localMat=t.localMat.multiply(t.deltaMat),t.startRotated||(r!==_i.Mesh&&(r===_i.StrecthedBillboard?t.startEuler.set(0,0,0):r!==_i.Billboard&&t.startEuler.set(0,0,t.startEuler.z)),A.fromEuler(t.startRotation,t.startEuler.x*Ze.R2D,t.startEuler.y*Ze.R2D,t.startEuler.z*Ze.R2D),t.startRotated=!0),this._startMat=R.fromQuat(this._startMat,t.startRotation),this._matRot=this._startMat.multiply(t.localMat),R.getRotation(this._quatRot,this._matRot),this._processRotation(t,Ze.R2D),t.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(t){this._separateAxes=t}}]),e}(li),as=a(os.prototype,"_enable",[_],(function(){return!1})),ls=a(os.prototype,"_separateAxes",[_],(function(){return!1})),hs=a(os.prototype,"x",[is,_],(function(){return new fe})),us=a(os.prototype,"y",[ss,_],(function(){return new fe})),cs=a(os.prototype,"z",[rs,_],(function(){return new fe})),ns=os))||ns),en=39825,sn=(Ss=e("cc.SizeOvertimeModule"),bs=i(fe),Ts=i(fe),xs=i(fe),ws=i(fe),Ss((Rs=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=Os&&Os(),e.separateAxes=Cs&&Cs(),e.size=Es&&Es(),e.x=Fs&&Fs(),e.y=Ds&&Ds(),e.z=Ps&&Ps(),e.name=si,e}return s(e,t),e.prototype.animate=function(t){if(this.separateAxes){var e=1-t.remainingLifetime/t.startLifetime,i=Ai(this.x)?D(t.randomSeed+en):0,s=Ai(this.y)?D(t.randomSeed+en):0,r=Ai(this.z)?D(t.randomSeed+en):0;t.size.x=t.startSize.x*this.x.evaluate(e,i),t.size.y=t.startSize.y*this.y.evaluate(e,s),t.size.z=t.startSize.z*this.z.evaluate(e,r)}else{var n=Ai(this.size)?D(t.randomSeed+en):0;d.multiplyScalar(t.size,t.startSize,this.size.evaluate(1-t.remainingLifetime/t.startLifetime,n))}},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(li),Os=a(Rs.prototype,"_enable",[_],(function(){return!1})),Cs=a(Rs.prototype,"separateAxes",[_],(function(){return!1})),Es=a(Rs.prototype,"size",[bs,_],(function(){return new fe})),Fs=a(Rs.prototype,"x",[Ts,_],(function(){return new fe})),Ds=a(Rs.prototype,"y",[xs,_],(function(){return new fe})),Ps=a(Rs.prototype,"z",[ws,_],(function(){return new fe})),As=Rs))||As),rn=f({Grid:0}),nn=f({WholeSheet:0,SingleRow:1}),on=(zs=e("cc.TextureAnimationModule"),Is=z("numTilesX"),Bs=z("numTilesY"),Ls=i(rn),Vs=i(rn),Ns=i(nn),ks=i(fe),Us=i(fe),zs((Xs=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=Hs&&Hs(),e._numTilesX=Ws&&Ws(),e._numTilesY=Ys&&Ys(),e._mode=js&&js(),e.animation=Zs&&Zs(),e.frameOverTime=qs&&qs(),e.startFrame=Qs&&Qs(),e.cycleCount=Ks&&Ks(),e._flipU=Js&&Js(),e._flipV=$s&&$s(),e._uvChannelMask=tr&&tr(),e.randomRow=er&&er(),e.rowIndex=ir&&ir(),e.name=ri,e}s(e,t);var i=e.prototype;return i.init=function(t){t.startRow=Math.floor(Math.random()*this.numTilesY)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Ai(this.startFrame)?D(t.randomSeed+90794):0,s=Ai(this.frameOverTime)?D(t.randomSeed+90794):0,r=this.startFrame.evaluate(e,i)/(this.numTilesX*this.numTilesY);if(this.animation===nn.WholeSheet)t.frameIndex=P(this.cycleCount*(this.frameOverTime.evaluate(e,s)+r),1);else if(this.animation===nn.SingleRow){var n=1/this.numTilesY;if(this.randomRow){var o=P(this.cycleCount*(this.frameOverTime.evaluate(e,s)+r),1),a=t.startRow*n,l=a+n;t.frameIndex=m(a,l,o)}else{var h=this.rowIndex*n,u=h+n;t.frameIndex=m(h,u,P(this.cycleCount*(this.frameOverTime.evaluate(e,s)+r),1))}}},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,t,this)))}},{key:"mode",get:function(){return this._mode},set:function(t){t!==rn.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(t){this._numTilesX!==t&&(this._numTilesX=t,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(t){this._numTilesY!==t&&(this._numTilesY=t,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),e}(li),Hs=a(Xs.prototype,"_enable",[_],(function(){return!1})),Ws=a(Xs.prototype,"_numTilesX",[Is],(function(){return 0})),Ys=a(Xs.prototype,"_numTilesY",[Bs],(function(){return 0})),js=a(Xs.prototype,"_mode",[Ls],(function(){return rn.Grid})),l(Xs.prototype,"mode",[Vs],Object.getOwnPropertyDescriptor(Xs.prototype,"mode"),Xs.prototype),Zs=a(Xs.prototype,"animation",[Ns,_],(function(){return nn.WholeSheet})),qs=a(Xs.prototype,"frameOverTime",[ks,_],(function(){return new fe})),Qs=a(Xs.prototype,"startFrame",[Us,_],(function(){return new fe})),Ks=a(Xs.prototype,"cycleCount",[_],(function(){return 0})),Js=a(Xs.prototype,"_flipU",[_],(function(){return 0})),$s=a(Xs.prototype,"_flipV",[_],(function(){return 0})),tr=a(Xs.prototype,"_uvChannelMask",[_],(function(){return-1})),er=a(Xs.prototype,"randomRow",[_],(function(){return!1})),ir=a(Xs.prototype,"rowIndex",[_],(function(){return 0})),Gs=Xs))||Gs),an=197866,ln=new d,hn=(sr=e("cc.VelocityOvertimeModule"),rr=i(fe),nr=i(fe),or=i(fe),ar=i(fe),lr=i(hi),sr((ur=function(t){function e(){var e;return(e=t.call(this)||this)._enable=cr&&cr(),e.x=_r&&_r(),e.y=dr&&dr(),e.z=pr&&pr(),e.speedModifier=fr&&fr(),e.space=mr&&mr(),e.rotation=void 0,e.needTransform=void 0,e.name="velocityModule",e.rotation=new A,e.speedModifier.constant=1,e.needTransform=!1,e.needUpdate=!0,e}s(e,t);var i=e.prototype;return i.update=function(t,e){this.needTransform=Mi(t,this.space,e,this.rotation)},i.animate=function(t){var e=1-t.remainingLifetime/t.startLifetime,i=Ai(this.x)?D(t.randomSeed^an):0,s=Ai(this.y)?D(156497^t.randomSeed):0,r=Ai(this.z)?D(984136^t.randomSeed):0,n=Ai(this.speedModifier)?D(t.randomSeed+an):0,o=d.set(ln,this.x.evaluate(e,i),this.y.evaluate(e,s),this.z.evaluate(e,r));this.needTransform&&d.transformQuat(o,o,this.rotation),d.add(t.animatedVelocity,t.animatedVelocity,o),d.add(t.ultimateVelocity,t.velocity,t.animatedVelocity),d.multiplyScalar(t.ultimateVelocity,t.ultimateVelocity,this.speedModifier.evaluate(1-t.remainingLifetime/t.startLifetime,n))},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}}]),e}(li),cr=a(ur.prototype,"_enable",[_],(function(){return!1})),_r=a(ur.prototype,"x",[rr,_],(function(){return new fe})),dr=a(ur.prototype,"y",[nr,_],(function(){return new fe})),pr=a(ur.prototype,"z",[or,_],(function(){return new fe})),fr=a(ur.prototype,"speedModifier",[ar,_],(function(){return new fe})),mr=a(ur.prototype,"space",[lr,_],(function(){return hi.Local})),hr=ur))||hr),un=t("Burst",(vr=e("cc.Burst"),yr=i(fe),vr((gr=function(){function t(){this._time=Sr&&Sr(),this._repeatCount=br&&br(),this.repeatInterval=Tr&&Tr(),this.count=xr&&xr(),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var e=t.prototype;return e.update=function(t,e){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var i=P(t._time-t.startDelay.evaluate(0,1),t.duration)-e;i=i>0?i:0;var s=P(t.time-t.startDelay.evaluate(0,1),t.duration);this._curTime>=i&&this._curTime<s&&(t.emit(this.count.evaluate(this._curTime/t.duration,1),e-(s-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},e.reset=function(){this._remainingCount=0,this._curTime=0},e.getMaxCount=function(t){return this.count.getMax()*Math.min(Math.ceil(t.duration/this.repeatInterval),this.repeatCount)},o(t,[{key:"time",get:function(){return this._time},set:function(t){this._time=t,this._curTime=t}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t,this._remainingCount=t}}]),t}(),Sr=a(gr.prototype,"_time",[_],(function(){return 0})),br=a(gr.prototype,"_repeatCount",[_],(function(){return 1})),Tr=a(gr.prototype,"repeatInterval",[_],(function(){return 1})),xr=a(gr.prototype,"count",[yr,_],(function(){return new fe})),Mr=gr))||Mr)),cn=new d(0,0,0),_n=[],dn=new d(.5,.5,.5),pn=(wr=e("cc.ShapeModule"),Ar=i(di),Rr=z("shapeType"),Or=i(di),Cr=i(pi),Er=i(fi),Fr=i(fe),wr((Pr=function(){function t(){this._enable=zr&&zr(),this._shapeType=Ir&&Ir(),this.emitFrom=Br&&Br(),this.alignToDirection=Lr&&Lr(),this.randomDirectionAmount=Vr&&Vr(),this.sphericalDirectionAmount=Nr&&Nr(),this.randomPositionAmount=kr&&kr(),this.radius=Ur&&Ur(),this.radiusThickness=Gr&&Gr(),this.arcMode=Xr&&Xr(),this.arcSpread=Hr&&Hr(),this.arcSpeed=Wr&&Wr(),this.length=Yr&&Yr(),this.boxThickness=jr&&jr(),this._position=Zr&&Zr(),this._rotation=qr&&qr(),this._scale=Qr&&Qr(),this._arc=Kr&&Kr(),this._angle=Jr&&Jr(),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new R,this.quat=new A,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var e=t.prototype;return e.onInit=function(t){this.particleSystem=t,this.constructMat(),this.lastTime=this.particleSystem._time},e.emit=function(t){switch(this.shapeType){case di.Box:!function(t,e,i,s){switch(t){case pi.Volume:r=i,n=dn,d.set(r,C(-n.x,n.x),C(-n.y,n.y),C(-n.z,n.z));break;case pi.Shell:_n.splice(0,_n.length),_n.push(C(-.5,.5)),_n.push(C(-.5,.5)),_n.push(.5*wi()),xi(_n),fn(_n,e),d.set(i,_n[0],_n[1],_n[2]);break;case pi.Edge:_n.splice(0,_n.length),_n.push(C(-.5,.5)),_n.push(.5*wi()),_n.push(.5*wi()),xi(_n),fn(_n,e),d.set(i,_n[0],_n[1],_n[2]);break;default:console.warn(t+" is not supported for box emitter.")}var r,n;d.copy(s,yi)}(this.emitFrom,this.boxThickness,t.position,t.velocity);break;case di.Circle:e=this.radius,i=this.radiusThickness,s=this.generateArcAngle(),r=t.position,n=t.velocity,Ti(r,e*(1-i),e,s),d.normalize(n,r);break;case di.Cone:!function(t,e,i,s,r,n,o,a){switch(t){case pi.Base:Ti(o,e*(1-i),e,s),w.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r)*e,d.normalize(a,a),o.z=0;break;case pi.Shell:gi(o,s),w.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r),d.normalize(a,a),w.multiplyScalar(o,o,e),o.z=0;break;case pi.Volume:Ti(o,e*(1-i),e,s),w.multiplyScalar(a,o,Math.sin(r)),a.z=-Math.cos(r)*e,d.normalize(a,a),o.z=0,d.add(o,o,d.multiplyScalar(cn,a,n*O()/-a.z));break;default:console.warn(t+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,t.position,t.velocity);break;case di.Sphere:!function(t,e,i,s,r){switch(t){case pi.Volume:bi(s,e*(1-i),e),d.normalize(r,s);break;case pi.Shell:Si(s),d.multiplyScalar(s,s,e),d.normalize(r,s);break;default:console.warn(t+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;case di.Hemisphere:!function(t,e,i,s,r){switch(t){case pi.Volume:bi(s,e*(1-i),e),s.z>0&&(s.z*=-1),d.normalize(r,s);break;case pi.Shell:Si(s),d.multiplyScalar(s,s,e),s.z>0&&(s.z*=-1),d.normalize(r,s);break;default:console.warn(t+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,t.position,t.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}var e,i,s,r,n;if(this.randomPositionAmount>0&&(t.position.x+=C(-this.randomPositionAmount,this.randomPositionAmount),t.position.y+=C(-this.randomPositionAmount,this.randomPositionAmount),t.position.z+=C(-this.randomPositionAmount,this.randomPositionAmount)),d.transformQuat(t.velocity,t.velocity,this.quat),d.transformMat4(t.position,t.position,this.mat),this.sphericalDirectionAmount>0){var o=d.normalize(cn,t.position);d.lerp(t.velocity,t.velocity,o,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},e.constructMat=function(){A.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),R.fromRTS(this.mat,this.quat,this._position,this._scale)},e.generateArcAngle=function(){if(this.arcMode===fi.Random)return C(0,this._arc);var t=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=t,0!==this.arcSpread&&(t=Math.floor(t/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case fi.Loop:return P(t,this._arc);case fi.PingPong:return I(t,this._arc);default:return P(t,this._arc)}},o(t,[{key:"position",get:function(){return this._position},set:function(t){this._position=t,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation=t,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(t){this._scale=t,this.constructMat()}},{key:"arc",get:function(){return u(this._arc)},set:function(t){this._arc=c(t)}},{key:"angle",get:function(){return Math.round(100*u(this._angle))/100},set:function(t){this._angle=c(t)}},{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"shapeType",get:function(){return this._shapeType},set:function(t){switch(this._shapeType=t,this._shapeType){case di.Box:this.emitFrom===pi.Base&&(this.emitFrom=pi.Volume);break;case di.Cone:this.emitFrom===pi.Edge&&(this.emitFrom=pi.Base);break;case di.Sphere:case di.Hemisphere:this.emitFrom!==pi.Base&&this.emitFrom!==pi.Edge||(this.emitFrom=pi.Volume)}}}]),t}(),zr=a(Pr.prototype,"_enable",[_],(function(){return!1})),Ir=a(Pr.prototype,"_shapeType",[Ar,Rr],(function(){return di.Cone})),l(Pr.prototype,"shapeType",[Or],Object.getOwnPropertyDescriptor(Pr.prototype,"shapeType"),Pr.prototype),Br=a(Pr.prototype,"emitFrom",[Cr,_],(function(){return pi.Volume})),Lr=a(Pr.prototype,"alignToDirection",[_],(function(){return!1})),Vr=a(Pr.prototype,"randomDirectionAmount",[_],(function(){return 0})),Nr=a(Pr.prototype,"sphericalDirectionAmount",[_],(function(){return 0})),kr=a(Pr.prototype,"randomPositionAmount",[_],(function(){return 0})),Ur=a(Pr.prototype,"radius",[_],(function(){return 1})),Gr=a(Pr.prototype,"radiusThickness",[_],(function(){return 1})),Xr=a(Pr.prototype,"arcMode",[Er,_],(function(){return fi.Random})),Hr=a(Pr.prototype,"arcSpread",[_],(function(){return 0})),Wr=a(Pr.prototype,"arcSpeed",[Fr,_],(function(){return new fe})),Yr=a(Pr.prototype,"length",[_],(function(){return 5})),jr=a(Pr.prototype,"boxThickness",[_],(function(){return new d(0,0,0)})),Zr=a(Pr.prototype,"_position",[_],(function(){return new d(0,0,0)})),qr=a(Pr.prototype,"_rotation",[_],(function(){return new d(0,0,0)})),Qr=a(Pr.prototype,"_scale",[_],(function(){return new d(1,1,1)})),Kr=a(Pr.prototype,"_arc",[_],(function(){return c(360)})),Jr=a(Pr.prototype,"_angle",[_],(function(){return c(25)})),Dr=Pr))||Dr);function fn(t,e){e.x>0&&(t[0]+=.5*C(-e.x,e.x),t[0]=B(t[0],-.5,.5)),e.y>0&&(t[1]+=.5*C(-e.y,e.y),t[1]=B(t[1],-.5,.5)),e.z>0&&(t[2]+=.5*C(-e.z,e.z),t[2]=B(t[2],-.5,.5))}var mn=[0,0,1,0,0,1,1,1],vn=[0,0,0,1,0,0,0,1,0,1,1,0],yn=function(t){function e(){var e;return(e=t.call(this)||this)._capacity=void 0,e._vertAttrs=void 0,e._vertAttribSize=void 0,e._vBuffer=void 0,e._vertAttrsFloatCount=void 0,e._vdataF32=void 0,e._vdataUint32=void 0,e._subMeshData=void 0,e._mesh=void 0,e._vertCount=0,e._indexCount=0,e._startTimeOffset=0,e._lifeTimeOffset=0,e._material=null,e._vertAttribSizeStatic=void 0,e._vertStaticAttrsFloatCount=void 0,e._insBuffers=void 0,e._insIndices=void 0,e._useInstance=void 0,e._iaVertCount=0,e._iaIndexCount=0,e.type=pt.PARTICLE_BATCH,e._capacity=0,e._vertAttrs=null,e._vertAttribSize=0,e._vBuffer=null,e._vertAttrsFloatCount=0,e._vdataF32=null,e._vdataUint32=null,e._vertAttribSizeStatic=0,e._vertStaticAttrsFloatCount=0,e._insBuffers=[],e._insIndices=null,yt.gfxDevice.hasFeature(Rt.INSTANCED_ARRAYS)?e._useInstance=!0:e._useInstance=!1,e._subMeshData=null,e._mesh=null,e}s(e,t);var i=e.prototype;return i.setCapacity=function(t){var e=this._capacity!==t;this._capacity=t,this._subMeshData&&e&&this.rebuild()},i.setVertexAttributes=function(t,e){if(this._useInstance)this.setVertexAttributesIns(t,e);else{if(this._mesh===t&&this._vertAttrs===e)return;this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0;for(var i,s=L(this._vertAttrs);!(i=s()).done;){var r=i.value;r.offset=this._vertAttribSize,this._vertAttribSize+=Tt[r.format].size}this._vertAttrsFloatCount=this._vertAttribSize/4,this.rebuild()}},i.setVertexAttributesIns=function(t,e){if(this._mesh!==t||this._vertAttrs!==e){this._mesh=t,this._vertAttrs=e,this._vertAttribSize=0,this._vertAttribSizeStatic=0;for(var i,s=L(this._vertAttrs);!(i=s()).done;){var r=i.value;0===r.stream?(r.offset=this._vertAttribSize,this._vertAttribSize+=Tt[r.format].size):1===r.stream&&(r.offset=this._vertAttribSizeStatic,this._vertAttribSizeStatic+=Tt[r.format].size)}this._vertAttrsFloatCount=this._vertAttribSize/4,this._vertStaticAttrsFloatCount=this._vertAttribSizeStatic/4,this.rebuild()}},i.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new xt(wt.VERTEX|wt.TRANSFER_DST,At.HOST|At.DEVICE,this._vertAttribSize*this._capacity*this._vertCount,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._capacity*this._vertCount);if(this._mesh&&this._capacity>0){var i=this._vertAttrs[this._vertAttrs.findIndex((function(t){return t.name===St.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,St.ATTR_TEX_COORD,e,this._vertAttribSize,i);var s=this._vertAttrs.findIndex((function(t){return t.name===St.ATTR_TEX_COORD3}));if(i=this._vertAttrs[s++].offset,this._mesh.copyAttribute(0,St.ATTR_POSITION,e,this._vertAttribSize,i),i=this._vertAttrs[s++].offset,this._mesh.copyAttribute(0,St.ATTR_NORMAL,e,this._vertAttribSize,i),i=this._vertAttrs[s++].offset,!this._mesh.copyAttribute(0,St.ATTR_COLOR,e,this._vertAttribSize,i))for(var n=new Uint32Array(e),o=0;o<this._vertCount;++o)n[o*this._vertAttrsFloatCount+i/4]=r.WHITE._val;for(var a=new Float32Array(e),l=1;l<this._capacity;l++)a.copyWithin(l*this._vertAttribSize*this._vertCount/4,0,this._vertAttribSize*this._vertCount/4)}t.update(e);var h=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,h);for(var u=1;u<this._capacity;u++)for(var c=0;c<this._indexCount;c++)h[u*this._indexCount+c]=h[c]+u*this._vertCount}else for(var _=0,d=0;d<this._capacity;++d){var p=4*d;h[_++]=p,h[_++]=p+1,h[_++]=p+2,h[_++]=p+3,h[_++]=p+2,h[_++]=p+1}var f=this._device.createBuffer(new xt(wt.INDEX|wt.TRANSFER_DST,At.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return f.update(h),this._iaVertCount=this._capacity*this._vertCount,this._iaIndexCount=this._capacity*this._indexCount,this._subMeshData=new st([t],this._vertAttrs,Mt.TRIANGLE_LIST,f),this.initSubModel(0,this._subMeshData,this._material),e},i.createSubMeshDataInsDynamic=function(){this._insBuffers.length=0,this.destroySubMeshData();var t=this._device.createBuffer(new xt(wt.VERTEX|wt.TRANSFER_DST,At.HOST|At.DEVICE,this._vertAttribSize*this._capacity,this._vertAttribSize)),e=new ArrayBuffer(this._vertAttribSize*this._capacity);return t.update(e),this._insBuffers.push(t),e},i.createSubMeshDataInsStatic=function(){this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var t=this._device.createBuffer(new xt(wt.VERTEX|wt.TRANSFER_DST,At.HOST|At.DEVICE,this._vertAttribSizeStatic*this._vertCount,this._vertAttribSizeStatic)),e=new ArrayBuffer(this._vertAttribSizeStatic*this._vertCount);if(this._mesh){var i=this._vertAttrs.findIndex((function(t){return t.name===St.ATTR_TEX_COORD})),s=this._vertAttrs[i].offset;if(this._mesh.copyAttribute(0,St.ATTR_TEX_COORD,e,this._vertAttribSizeStatic,s),i=this._vertAttrs.findIndex((function(t){return t.name===St.ATTR_TEX_COORD3})),s=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,St.ATTR_POSITION,e,this._vertAttribSizeStatic,s),s=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,St.ATTR_NORMAL,e,this._vertAttribSizeStatic,s),s=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,St.ATTR_COLOR,e,this._vertAttribSizeStatic,s))for(var n=new Uint32Array(e),o=0;o<this._vertCount;++o)n[o*this._vertStaticAttrsFloatCount+s/4]=r.WHITE._val}else for(var a=new Float32Array(e),l=0;l<vn.length;++l)a[l]=vn[l];t.update(e);var h=new Uint16Array(this._indexCount);this._mesh?this._mesh.copyIndices(0,h):(h[0]=0,h[1]=1,h[2]=2,h[3]=3,h[4]=2,h[5]=1);var u=this._device.createBuffer(new xt(wt.INDEX|wt.TRANSFER_DST,At.DEVICE,this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));u.update(h),this._insIndices=u,this._iaVertCount=this._vertCount,this._iaIndexCount=this._indexCount,this._insBuffers.push(t)},i.createInsSubmesh=function(){this._subMeshData=new st(this._insBuffers,this._vertAttrs,Mt.TRIANGLE_LIST,this._insIndices),this.initSubModel(0,this._subMeshData,this._material)},i.updateMaterial=function(t){this._material=t,this.setSubModelMaterial(0,t)},i.addParticleVertexData=function(t,e){if(this._useInstance)this.addParticleVertexDataIns(t,e);else if(this._mesh)for(var i=0;i<this._vertCount;i++){var s=(t*this._vertCount+i)*this._vertAttrsFloatCount;this._vdataF32[s++]=e[0].x,this._vdataF32[s++]=e[0].y,this._vdataF32[s++]=e[0].z,s+=2,this._vdataF32[s++]=e[1].z,this._vdataF32[s++]=e[2].x,this._vdataF32[s++]=e[2].y,this._vdataF32[s++]=e[2].z,this._vdataF32[s++]=e[3].x,this._vdataF32[s++]=e[3].y,this._vdataF32[s++]=e[3].z,this._vdataUint32[s++]=e[4]}else{var r=t*this._vertAttrsFloatCount;this._vdataF32[r++]=e[0].x,this._vdataF32[r++]=e[0].y,this._vdataF32[r++]=e[0].z,this._vdataF32[r++]=e[1].x,this._vdataF32[r++]=e[1].y,this._vdataF32[r++]=e[1].z,this._vdataF32[r++]=e[2].x,this._vdataF32[r++]=e[2].y,this._vdataF32[r++]=e[2].z,this._vdataF32[r++]=e[3].x,this._vdataF32[r++]=e[3].y,this._vdataF32[r++]=e[3].z,this._vdataUint32[r++]=e[4],e[5]&&(this._vdataF32[r++]=e[5].x,this._vdataF32[r++]=e[5].y,this._vdataF32[r++]=e[5].z)}},i.addParticleVertexDataIns=function(t,e){var i=t*this._vertAttrsFloatCount;this._mesh?(this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=e[1].z,this._vdataF32[i++]=e[2].x,this._vdataF32[i++]=e[2].y,this._vdataF32[i++]=e[2].z,this._vdataF32[i++]=e[3].x,this._vdataF32[i++]=e[3].y,this._vdataF32[i++]=e[3].z,this._vdataUint32[i++]=e[4]):(this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=e[1].z,this._vdataF32[i++]=e[2].x,this._vdataF32[i++]=e[2].y,this._vdataF32[i++]=e[2].z,this._vdataF32[i++]=e[3].x,this._vdataF32[i++]=e[3].y,this._vdataF32[i++]=e[3].z,this._vdataUint32[i++]=e[4],e[5]&&(this._vdataF32[i++]=e[5].x,this._vdataF32[i++]=e[5].y,this._vdataF32[i++]=e[5].z))},i.addGPUParticleVertexData=function(t,e,i){if(this._useInstance)this.addGPUParticleVertexDataIns(t,e,i);else for(var s=e*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var n=s;this._vdataF32[n++]=t.position.x,this._vdataF32[n++]=t.position.y,this._vdataF32[n++]=t.position.z,this._vdataF32[n++]=i,this._vdataF32[n++]=t.startSize.x,this._vdataF32[n++]=t.startSize.y,this._vdataF32[n++]=t.startSize.z,this._vdataF32[n++]=mn[2*r],this._vdataF32[n++]=t.rotation.x,this._vdataF32[n++]=t.rotation.y,this._vdataF32[n++]=t.rotation.z,this._vdataF32[n++]=mn[2*r+1],this._vdataF32[n++]=t.startColor.r/255,this._vdataF32[n++]=t.startColor.g/255,this._vdataF32[n++]=t.startColor.b/255,this._vdataF32[n++]=t.startColor.a/255,this._vdataF32[n++]=t.velocity.x,this._vdataF32[n++]=t.velocity.y,this._vdataF32[n++]=t.velocity.z,this._vdataF32[n++]=t.startLifetime,this._vdataF32[n++]=t.randomSeed,s+=this._vertAttrsFloatCount}},i.addGPUParticleVertexDataIns=function(t,e,i){var s=e*this._vertAttrsFloatCount,r=s;this._vdataF32[r++]=t.position.x,this._vdataF32[r++]=t.position.y,this._vdataF32[r++]=t.position.z,this._vdataF32[r++]=i,this._vdataF32[r++]=t.startSize.x,this._vdataF32[r++]=t.startSize.y,this._vdataF32[r++]=t.startSize.z,this._vdataF32[r++]=t.frameIndex,this._vdataF32[r++]=t.rotation.x,this._vdataF32[r++]=t.rotation.y,this._vdataF32[r++]=t.rotation.z,this._vdataF32[r++]=t.startColor.r/255,this._vdataF32[r++]=t.startColor.g/255,this._vdataF32[r++]=t.startColor.b/255,this._vdataF32[r++]=t.startColor.a/255,this._vdataF32[r++]=t.velocity.x,this._vdataF32[r++]=t.velocity.y,this._vdataF32[r++]=t.velocity.z,this._vdataF32[r++]=t.startLifetime,this._vdataF32[r++]=t.randomSeed,s+=this._vertAttrsFloatCount},i.updateGPUParticles=function(t,e,i){if(this._useInstance)return this.updateGPUParticlesIns(t,e,i);for(var s=this._vertAttrsFloatCount*this._vertCount,r=0,n=0,o=0,a=0;a<t;++a)r=a*s,n=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-n)<i&&(o=--t*s,this._vdataF32.copyWithin(r,o,o+s),a--);return t},i.updateGPUParticlesIns=function(t,e,i){for(var s=this._vertAttrsFloatCount,r=0,n=0,o=0,a=0;a<t;++a)r=a*s,n=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(e-n)<i&&(o=--t*s,this._vdataF32.copyWithin(r,o,o+s),a--);return t},i.constructAttributeIndex=function(){if(this._vertAttrs){var t=this._vertAttrs.findIndex((function(t){return"a_position_starttime"===t.name})),e=this._vertAttrs[t].offset;this._startTimeOffset=e/4+3,t=this._vertAttrs.findIndex((function(t){return"a_dir_life"===t.name})),e=this._vertAttrs[t].offset,this._lifeTimeOffset=e/4+3}},i.updateIA=function(t){if(this._useInstance)this.updateIAIns(t);else{if(t<=0)return;var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.firstIndex=0,e.indexCount=this._indexCount*t,e.vertexCount=this._iaVertCount}},i.updateIAIns=function(t){if(!(t<=0)){var e=this._subModels[0].inputAssembler;e.vertexBuffers[0].update(this._vdataF32),e.instanceCount=t,e.firstIndex=0,e.indexCount=this._indexCount,e.instanceCount=t,e.vertexCount=this._iaVertCount}},i.clear=function(){this._useInstance?this.clearIns():this._subModels[0].inputAssembler.indexCount=0},i.clearIns=function(){this._subModels[0].inputAssembler.instanceCount=0},i.destroy=function(){t.prototype.destroy.call(this),this.doDestroy()},i.doDestroy=function(){this._vBuffer=null,this._vdataF32=null,this._vdataUint32=null,this._insBuffers=[],this._insIndices=null,this._vertAttrs=null,this._material=null,this._mesh=null,this.destroySubMeshData()},i.rebuild=function(){this._useInstance?this.rebuildIns():(this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer))},i.rebuildIns=function(){this._vBuffer=this.createSubMeshDataInsDynamic(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer),this.createSubMeshDataInsStatic(),this.createInsSubmesh()},i.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},o(e,[{key:"useInstance",get:function(){return this._useInstance},set:function(t){this._useInstance!==t&&(this._useInstance=t)}}]),e}(dt),Mn=function(){function t(t){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._useInstance=void 0,this._renderInfo=t,yt.gfxDevice.hasFeature(Rt.INSTANCED_ARRAYS)?this._useInstance=!0:this._useInstance=!1}var e=t.prototype;return e.getUseInstance=function(){return this._useInstance},e.getInfo=function(){return this._renderInfo},e.onInit=function(t){this._particleSystem=t},e.onEnable=function(){if(this._particleSystem){this.attachToScene();var t=this._model;t&&(t.node=t.transform=this._particleSystem.node)}},e.onDisable=function(){this.detachFromScene()},e.onDestroy=function(){this._model&&(n.director.root.destroyModel(this._model),this._model=null)},e.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},e.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},e.setVertexAttributes=function(){this._model&&(this.updateVertexAttrib(),this._model.setVertexAttributes(this._renderInfo.renderMode===_i.Mesh?this._renderInfo.mesh:null,this._vertAttrs))},e.clear=function(){this._model&&(this._model.enabled=!1)},e.getModel=function(){return this._model},e._initModel=function(){this._model||(this._model=n.director.root.createModel(yn),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},e.updateTrailMaterial=function(){},e.getDefaultTrailMaterial=function(){return null},o(t,[{key:"model",get:function(){return this._model}}]),t}(),gn=function(){function t(t){this.permutation=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],this.accSpeed=new d,this.noiseSpeed=new d,this.noiseFrequency=0,this.noiseAbs=new d,this.noiseAmplitude=new d,this.octaves=new d,this.dt=0,this.point=new d,this.result=new d,this.mixOut=new w,t&&(this.permutation=t)}var e=t.prototype;return e.noise=function(t,e,i,s,r){void 0===s&&(s=0),void 0===r&&(r=1);for(var n=new Array(512),o=0;o<256;o++)n[256+o]=n[o]=this.permutation[o];var a=255&Math.floor(t),l=255&Math.floor(e),h=255&Math.floor(i);t-=Math.floor(t),e-=Math.floor(e),i-=Math.floor(i);var u=this.fade(t),c=this.fade(e),_=this.fade(i),d=n[a]+l,p=n[d]+h,f=n[d+1]+h,m=n[a+1]+l,v=n[m]+h,y=n[m+1]+h;return s+this.scale(this.lerp(_,this.lerp(c,this.lerp(u,this.grad(n[p],t,e,i),this.grad(n[v],t-1,e,i)),this.lerp(u,this.grad(n[f],t,e-1,i),this.grad(n[y],t-1,e-1,i))),this.lerp(c,this.lerp(u,this.grad(n[p+1],t,e,i-1),this.grad(n[v+1],t-1,e,i-1)),this.lerp(u,this.grad(n[f+1],t,e-1,i-1),this.grad(n[y+1],t-1,e-1,i-1)))))*(r-s)},e.fade=function(t){return t*t*t*(t*(6*t-15)+10)},e.lerp=function(t,e,i){return e+t*(i-e)},e.grad=function(t,e,i,s){var r=15&t,n=r<8?e:i,o=r<4?i:12===r||14===r?e:s;return(0==(1&r)?n:-n)+(0==(2&r)?o:-o)},e.scale=function(t){return(1+t)/2},e.setSpeed=function(t,e,i){this.noiseSpeed.set(t,e,i)},e.setFrequency=function(t){this.noiseFrequency=t},e.setAbs=function(t,e,i){this.noiseAbs.set(t,e,i)},e.setAmplititude=function(t,e,i){this.noiseAmplitude.set(t,e,i)},e.setOctaves=function(t,e,i){this.octaves.set(t,e,i)},e.setTime=function(t){this.dt=t},e.setSamplePoint=function(t){this.point.set(t)},e.getResult=function(){return this.result},e.getNoise=function(t,e,i,s,r,n,o){var a=n,l=0;if(l+=this.noise(t*a,e*a,i*a,-1,1),1===o.x)return l;for(var h=1,u=1,c=1;c<o.x;++c)h*=o.y,a*=o.z,u+=h,l+=this.noise(t*a,e*a,i*a,-1,1)*h;return l/u},e.getNoiseMix=function(t,e,i,s,r,n){t.x=this.getNoise(e.x,e.y,e.z,i,s,r,n),t.y=this.getNoise(e.y,e.z,e.x,i,s,r,n)},e.getNoiseParticle=function(){this.accSpeed.set(this.noiseSpeed.x*this.dt,this.noiseSpeed.y*this.dt,this.noiseSpeed.z*this.dt);var t=this.getNoise(this.point.z+this.accSpeed.x,this.point.y,this.point.x,this.dt,this.accSpeed,this.noiseFrequency,this.octaves),e=this.getNoise(this.point.x+1e3,this.point.z+this.accSpeed.y,this.point.y,this.dt,this.accSpeed,this.noiseFrequency,this.octaves),i=this.getNoise(this.point.y,this.point.x+1e3,this.point.z+this.accSpeed.z,this.dt,this.accSpeed,this.noiseFrequency,this.octaves);this.result.set(t*this.noiseAmplitude.x,e*this.noiseAmplitude.y,i*this.noiseAmplitude.z)},e.getPreview=function(t,e,i){for(var s=0;s<i;++s)for(var r=0;r<e;++r){var n=(r-.5*e)/e+this.noiseSpeed.x*this.dt,o=(s-.5*i)/i+this.noiseSpeed.y*this.dt,a=this.getNoise(n,o,0,this.dt,this.accSpeed,this.noiseFrequency,this.octaves);t[s*e+r]=.5*(a+1)}},t}(),Sn=new d,bn=new R,Tn=new R,xn=new A;new d;var wn=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_noiseModule"],An=[0,0,1,0,0,1,1,1],Rn=[new gt(St.ATTR_POSITION,bt.RGB32F),new gt(St.ATTR_TEX_COORD,bt.RGB32F),new gt(St.ATTR_TEX_COORD1,bt.RGB32F),new gt(St.ATTR_TEX_COORD2,bt.RGB32F),new gt(St.ATTR_COLOR,bt.RGBA8,!0)],On=[new gt(St.ATTR_POSITION,bt.RGB32F),new gt(St.ATTR_TEX_COORD,bt.RGB32F),new gt(St.ATTR_TEX_COORD1,bt.RGB32F),new gt(St.ATTR_TEX_COORD2,bt.RGB32F),new gt(St.ATTR_COLOR,bt.RGBA8,!0),new gt(St.ATTR_COLOR1,bt.RGB32F)],Cn=[new gt(St.ATTR_POSITION,bt.RGB32F),new gt(St.ATTR_TEX_COORD,bt.RGB32F),new gt(St.ATTR_TEX_COORD1,bt.RGB32F),new gt(St.ATTR_TEX_COORD2,bt.RGB32F),new gt(St.ATTR_COLOR,bt.RGBA8,!0),new gt(St.ATTR_TEX_COORD3,bt.RGB32F),new gt(St.ATTR_NORMAL,bt.RGB32F),new gt(St.ATTR_COLOR1,bt.RGBA8,!0)],En=[new gt(St.ATTR_TEX_COORD4,bt.RGBA32F,!1,0,!0),new gt(St.ATTR_TEX_COORD1,bt.RGB32F,!1,0,!0),new gt(St.ATTR_TEX_COORD2,bt.RGB32F,!1,0,!0),new gt(St.ATTR_COLOR,bt.RGBA8,!0,0,!0),new gt(St.ATTR_TEX_COORD,bt.RGB32F,!1,1)],Fn=[new gt(St.ATTR_TEX_COORD4,bt.RGBA32F,!1,0,!0),new gt(St.ATTR_TEX_COORD1,bt.RGB32F,!1,0,!0),new gt(St.ATTR_TEX_COORD2,bt.RGB32F,!1,0,!0),new gt(St.ATTR_COLOR,bt.RGBA8,!0,0,!0),new gt(St.ATTR_COLOR1,bt.RGB32F,!1,0,!0),new gt(St.ATTR_TEX_COORD,bt.RGB32F,!1,1)],Dn=[new gt(St.ATTR_TEX_COORD4,bt.RGBA32F,!1,0,!0),new gt(St.ATTR_TEX_COORD1,bt.RGB32F,!1,0,!0),new gt(St.ATTR_TEX_COORD2,bt.RGB32F,!1,0,!0),new gt(St.ATTR_COLOR,bt.RGBA8,!0,0,!0),new gt(St.ATTR_TEX_COORD,bt.RGB32F,!1,1),new gt(St.ATTR_TEX_COORD3,bt.RGB32F,!1,1),new gt(St.ATTR_NORMAL,bt.RGB32F,!1,1),new gt(St.ATTR_COLOR1,bt.RGBA8,!0,1)],Pn={parent:null,owner:null,subModelIdx:0},zn=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._trailDefines=void 0,i._frameTile_velLenScale=void 0,i._tmp_velLenScale=void 0,i._defaultMat=null,i._node_scale=void 0,i._attrs=void 0,i._particles=null,i._defaultTrailMat=null,i._updateList=new Map,i._animateList=new Map,i._runAnimateList=new Array,i._fillDataFunc=null,i._uScaleHandle=0,i._uLenHandle=0,i._uNodeRotHandle=0,i._alignSpace=ci.View,i._inited=!1,i._localMat=new R,i._gravity=new h,i.noise=new gn,i._model=null,i._frameTile_velLenScale=new h(1,1,0,0),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new h,i._attrs=new Array(7),i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},i._trailDefines={CC_USE_WORLD_SPACE:!0},i}s(e,t);var i=e.prototype;return i.onInit=function(e){var i=this;t.prototype.onInit.call(this,e),this._particles=new V((function(){return new Ze(i)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},i.clear=function(){t.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},i.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},i.onDestroy=function(){var e;null===(e=this._particles)||void 0===e||e.destroy(),t.prototype.onDestroy.call(this)},i.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},i.getDefaultTrailMaterial=function(){return this._defaultTrailMat},i.setNewParticle=function(){},i._initModuleList=function(){var t=this;wn.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=oi.length;e<i;e++){var s=this._animateList[oi[e]];s&&this._runAnimateList.push(s)}},i.enableModule=function(t,e,i){e?(i.needUpdate&&(this._updateList[i.name]=i),i.needAnimate&&(this._animateList[i.name]=i)):(delete this._animateList[t],delete this._updateList[t]),this._runAnimateList.length=0;for(var s=0,r=oi.length;s<r;s++){var n=this._animateList[oi[s]];n&&this._runAnimateList.push(n)}this.updateMaterialParams()},i.updateAlignSpace=function(t){this._alignSpace=t},i.getDefaultMaterial=function(){return this._defaultMat},i.updateRotation=function(t){t&&this.doUpdateRotation(t)},i.doUpdateRotation=function(t){if(this._renderInfo.renderMode===_i.Mesh||this._alignSpace!==ci.View){if(this._alignSpace===ci.Local)this._particleSystem.node.getRotation(xn);else if(this._alignSpace===ci.World)this._particleSystem.node.getWorldRotation(xn);else if(this._alignSpace===ci.View){var e;xn.set(0,0,0,1);var i=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==i)for(var s=0;s<(null==i?void 0:i.length);++s){var r=i[s];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){A.fromViewUp(xn,r.forward);break}}}else xn.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,xn)}},i.updateScale=function(t){t&&this.doUpdateScale(t)},i.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case hi.Local:this._particleSystem.node.getScale(this._node_scale);break;case hi.World:this._particleSystem.node.getWorldScale(this._node_scale)}t.setUniform(this._uScaleHandle,this._node_scale)},i.updateParticles=function(t){var e=this,i=this._particleSystem;if(!i)return this._particles.length;i.node.getWorldMatrix(bn);var s=(i.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(s),this.doUpdateRotation(s),this._updateList.forEach((function(t){t.update(i._simulationSpace,bn)}));var r=i._trailModule,n=r&&r.enable;n&&r.update();var o=!i.gravityModifier.isZero();if(o){if(i.simulationSpace===hi.Local){var a=i.node.getRotation();R.fromQuat(this._localMat,a),this._localMat.transpose()}if(i.node.parent){var l=i.node.parent.getWorldRotation();R.fromQuat(Tn,l),Tn.transpose()}}for(var h=function(s){var a=e._particles.data[s];if(a.remainingLifetime-=t,d.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return n&&r.removeParticle(a),e._particles.removeAt(s),--s,u=s,"continue";if(o){var l=Ai(i.gravityModifier)?D(a.randomSeed):0;if(i.simulationSpace===hi.Local){var h=1-a.remainingLifetime/a.startLifetime,c=9.8*-i.gravityModifier.evaluate(h,l)*t;e._gravity.x=0,e._gravity.y=c,e._gravity.z=0,e._gravity.w=1,v(c,0,g)||(i.node.parent&&(e._gravity=e._gravity.transformMat4(Tn)),e._gravity=e._gravity.transformMat4(e._localMat),a.velocity.x+=e._gravity.x,a.velocity.y+=e._gravity.y,a.velocity.z+=e._gravity.z)}else a.velocity.y-=9.8*i.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,l)*t}d.copy(a.ultimateVelocity,a.velocity),e._runAnimateList.forEach((function(e){e.animate(a,t)})),d.scaleAndAdd(a.position,a.position,a.ultimateVelocity,t),n&&r.animate(a,t),u=s},u=0;u<this._particles.length;++u)h(u);return this._model.enabled=this._particles.length>0,this._particles.length},i.getNoisePreview=function(t,e,i){var s=this;this._runAnimateList.forEach((function(r){r.name===ni&&r.getNoisePreview(t,s._particleSystem,e,i)}))},i.updateRenderData=function(){for(var t=0,e=0;e<this._particles.length;++e){var i=this._particles.data[e],s=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(s=i.frameIndex),t=4*e,this._fillDataFunc(i,t,s)}},i.beforeRender=function(){this._model.updateIA(this._particles.length)},i.getParticleCount=function(){return this._particles.length},i.onMaterialModified=function(t){this._inited&&(0===t?this.updateMaterialParams():this.updateTrailMaterial())},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e);var i=this._particleSystem._trailModule;i&&i._trailModel&&1===t&&i._trailModel.setSubModelMaterial(0,e)},i._setFillFunc=function(){this._renderInfo.renderMode===_i.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===_i.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},i._fillMeshData=function(t,e,i){var s=e/4;this._attrs[0]=t.position,Sn.z=i,this._attrs[1]=Sn,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._model.addParticleVertexData(s,this._attrs)},i._fillStrecthedData=function(t,e,i){if(this._useInstance)this._fillStrecthedDataIns(t,e,i);else for(var s=0;s<4;++s)this._attrs[0]=t.position,Sn.x=An[2*s],Sn.y=An[2*s+1],Sn.z=i,this._attrs[1]=Sn,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=t.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(e++,this._attrs)},i._fillStrecthedDataIns=function(t,e,i){var s=e/4;this._attrs[0]=t.position,Sn.z=i,this._attrs[1]=Sn,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=t.ultimateVelocity,this._model.addParticleVertexData(s,this._attrs)},i._fillNormalData=function(t,e,i){if(this._useInstance)this._fillNormalDataIns(t,e,i);else for(var s=0;s<4;++s)this._attrs[0]=t.position,Sn.x=An[2*s],Sn.y=An[2*s+1],Sn.z=i,this._attrs[1]=Sn,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this._model.addParticleVertexData(e++,this._attrs)},i._fillNormalDataIns=function(t,e,i){var s=e/4;this._attrs[0]=t.position,Sn.z=i,this._attrs[1]=Sn,this._attrs[2]=t.size,this._attrs[3]=t.rotation,this._attrs[4]=t.color._val,this._attrs[5]=null,this._model.addParticleVertexData(s,this._attrs)},i.updateVertexAttrib=function(){if(this._renderInfo.renderMode===_i.Mesh&&this._renderInfo.mesh){var t=this._renderInfo.mesh.readAttributeFormat(0,St.ATTR_COLOR);if(t){for(var e=bt.RGBA8,i=0;i<Tt.length;++i)if(Tt[i].name===t.name){e=i;break}this._vertAttrs[7]=new gt(St.ATTR_COLOR1,e,!0,this._useInstance?1:0)}else{var s=bt.RGBA8;this._vertAttrs[7]=new gt(St.ATTR_COLOR1,s,!0,this._useInstance?1:0)}}},i._setVertexAttrib=function(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case _i.StrecthedBillboard:this._vertAttrs=On.slice();break;case _i.Mesh:this._vertAttrs=Cn.slice();break;default:this._vertAttrs=Rn.slice()}},i._setVertexAttribIns=function(){switch(this._renderInfo.renderMode){case _i.StrecthedBillboard:this._vertAttrs=Fn.slice();break;case _i.Mesh:this._vertAttrs=Dn.slice();break;default:this._vertAttrs=En.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;null!=e&&(e._effectAsset._name,this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(Pn.parent=et.get("default-particle-material"),Pn.owner=this._particleSystem,Pn.subModelIdx=0,this._defaultMat=new lt(Pn),Pn.parent=null,Pn.owner=null,Pn.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t._simulationSpace===hi.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var s=i.passes[0];this._uScaleHandle=s.getHandle("scale"),this._uLenHandle=s.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=s.getHandle("nodeRotation");var r=this._renderInfo.renderMode,n=this._frameTile_velLenScale;r===_i.Billboard?this._defines.CC_RENDER_MODE=0:r===_i.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,n.z=this._renderInfo.velocityScale,n.w=this._renderInfo.lengthScale):r===_i.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===_i.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===_i.Mesh?this._defines.CC_RENDER_MODE=4:N("particle system renderMode "+r+" not support.");var o=t._textureAnimationModule;o&&o.enable?(h.copy(this._tmp_velLenScale,n),w.set(this._tmp_velLenScale,o.numTilesX,o.numTilesY),s.setUniform(this._uLenHandle,this._tmp_velLenScale)):s.setUniform(this._uLenHandle,n);var a,l=this._particleSystem._rotationOvertimeModule;a=!!l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=a,this._defines.CC_INSTANCE_PARTICLE=this._useInstance,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},i.updateTrailMaterial=function(){if(this._particleSystem){var t=this._particleSystem,e=t._trailModule;if(e&&e.enable){t.simulationSpace===hi.World||e.space===hi.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var i=t.getMaterialInstance(1);null===i&&null===this._defaultTrailMat&&(Pn.parent=et.get("default-trail-material"),Pn.owner=this._particleSystem,Pn.subModelIdx=1,this._defaultTrailMat=new lt(Pn),Pn.parent=null,Pn.owner=null,Pn.subModelIdx=0),(i=i||this._defaultTrailMat).recompileShaders(this._trailDefines),e.updateMaterial()}}},i.setUseInstance=function(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())},e}(Mn),In=new R,Bn=new h,Ln=new A,Vn=new A;new d;var Nn,kn,Un,Gn,Xn,Hn,Wn,Yn,jn,Zn,qn,Qn,Kn,Jn,$n,to,eo,io,so,ro,no,oo=32,ao="a_position_starttime",lo="a_size_uv",ho="a_rotation_uv",uo="a_color",co="a_dir_life",_o="a_rndSeed",po="a_size_fid",fo="a_rotation",mo=[new gt(ao,bt.RGBA32F),new gt(lo,bt.RGBA32F),new gt(ho,bt.RGBA32F),new gt(uo,bt.RGBA32F),new gt(co,bt.RGBA32F),new gt(_o,bt.R32F)],vo=[new gt(ao,bt.RGBA32F),new gt(lo,bt.RGBA32F),new gt(ho,bt.RGBA32F),new gt(uo,bt.RGBA32F),new gt(co,bt.RGBA32F),new gt(_o,bt.R32F),new gt(St.ATTR_TEX_COORD,bt.RGB32F),new gt(St.ATTR_TEX_COORD3,bt.RGB32F),new gt(St.ATTR_NORMAL,bt.RGB32F),new gt(St.ATTR_COLOR1,bt.RGBA8,!0)],yo=[new gt(ao,bt.RGBA32F,!1,0,!0),new gt(po,bt.RGBA32F,!1,0,!0),new gt(fo,bt.RGB32F,!1,0,!0),new gt(uo,bt.RGBA32F,!1,0,!0),new gt(co,bt.RGBA32F,!1,0,!0),new gt(_o,bt.R32F,!1,0,!0),new gt("a_uv",bt.RGB32F,!1,1)],Mo=[new gt(ao,bt.RGBA32F,!1,0,!0),new gt(po,bt.RGBA32F,!1,0,!0),new gt(fo,bt.RGB32F,!1,0,!0),new gt(uo,bt.RGBA32F,!1,0,!0),new gt(co,bt.RGBA32F,!1,0,!0),new gt(_o,bt.R32F,!1,0,!0),new gt(St.ATTR_TEX_COORD,bt.RGB32F,!1,1),new gt(St.ATTR_TEX_COORD3,bt.RGB32F,!1,1),new gt(St.ATTR_NORMAL,bt.RGB32F,!1,1),new gt(St.ATTR_COLOR1,bt.RGBA8,!0,1)],go={parent:null,owner:null,subModelIdx:0},So=function(t){function e(e){var i;return(i=t.call(this,e)||this)._defines=void 0,i._frameTile_velLenScale=void 0,i._unifrom_velLenScale=void 0,i._tmp_velLenScale=void 0,i._node_scale=void 0,i._vertAttrs=[],i._defaultMat=null,i._particleNum=0,i._tempParticle=null,i._colorTexture=null,i._forceTexture=null,i._velocityTexture=null,i._rotationTexture=null,i._sizeTexture=null,i._animTexture=null,i._colorData=null,i._forceData=null,i._velocityData=null,i._rotationData=null,i._sizeData=null,i._animData=null,i._uTimeHandle=0,i._uRotHandle=0,i._uNodeRotHandle=0,i._alignSpace=ci.View,i._inited=!1,i._frameTile_velLenScale=new h(1,1,0,0),i._unifrom_velLenScale=i._frameTile_velLenScale.clone(),i._tmp_velLenScale=i._frameTile_velLenScale.clone(),i._node_scale=new h,i._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},i._tempParticle=new Ze(null),i._particleNum=0,i}s(e,t);var i=e.prototype;return i.onInit=function(e){t.prototype.onInit.call(this,e),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},i.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},i.setVertexAttributes=function(){t.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},i.clear=function(){t.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},i.onDestroy=function(){t.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy(),this._forceData=null,this._velocityData=null,this._colorData=null,this._sizeData=null,this._rotationData=null,this._animData=null},i.enableModule=function(){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;t&&(this.initShaderUniform(t),t.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,t))},i.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},i.setNewParticle=function(t){this._model.addGPUParticleVertexData(t,this._particleNum,this._particleSystem._time),this._particleNum++},i.getDefaultMaterial=function(){return this._defaultMat},i.updateRotation=function(t){t&&this.doUpdateRotation(t)},i.doUpdateRotation=function(t){if(this._renderInfo.renderMode===_i.Mesh||this._alignSpace!==ci.View){if(this._alignSpace===ci.Local)this._particleSystem.node.getRotation(Vn);else if(this._alignSpace===ci.World)this._particleSystem.node.getWorldRotation(Vn);else if(this._alignSpace===ci.View){var e;Vn.set(0,0,0,1);var i=null===(e=this._particleSystem.node.scene.renderScene)||void 0===e?void 0:e.cameras;if(void 0!==i)for(var s=0;s<(null==i?void 0:i.length);++s){var r=i[s];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){A.fromViewUp(Vn,r.forward);break}}}else Vn.set(0,0,0,1);t.setUniform(this._uNodeRotHandle,Vn)}},i.updateScale=function(t){t&&this.doUpdateScale(t)},i.doUpdateScale=function(t){switch(this._particleSystem.scaleSpace){case hi.Local:this._particleSystem.node.getScale(this._node_scale);break;case hi.World:this._particleSystem.node.getWorldScale(this._node_scale)}t.setUniform(t.getHandle("scale"),this._node_scale)},i.updateParticles=function(t){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,t),this.updateShaderUniform(t),this._model.enabled=this._particleNum>0,this._particleNum},i.updateRenderData=function(){},i.beforeRender=function(){this._model.updateIA(this._particleNum)},i.updateAlignSpace=function(t){this._alignSpace=t},i.updateShaderUniform=function(t){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(e){var i=e.passes[0];Bn.x=this._particleSystem._time,Bn.y=t,i.setUniform(this._uTimeHandle,Bn),this._particleSystem.node.getWorldRotation(Ln),i.setUniform(this._uRotHandle,Ln),this.doUpdateRotation(i)}},i.initShaderUniform=function(t){var e=t.passes[0];this._uTimeHandle=e.getHandle("u_timeDelta"),this._uRotHandle=e.getHandle("u_worldRot"),this._uNodeRotHandle=e.getHandle("nodeRotation"),this.doUpdateScale(e),e.setUniform(e.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),Bn.x=oo,Bn.y=.03125,e.setUniform(e.getHandle("u_sampleInfo"),Bn);var i=!1,s=this._particleSystem._forceOvertimeModule;if(i=!!s&&s.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=i,i){var r=Me(this._forceTexture,this._forceData,oo,s.x,s.y,s.z);this._forceTexture=r.texture,this._forceData=r.texdata;var n=e.getHandle("force_over_time_tex0"),o=ht.getBindingFromHandle(n);e.bindSampler(o,this._forceTexture.getGFXSampler()),e.bindTexture(o,this._forceTexture.getGFXTexture());var a=e.getHandle("u_force_space");e.setUniform(a,s.space);var l=e.getHandle("u_force_mode");e.setUniform(l,this._forceTexture.height)}var h=this._particleSystem._velocityOvertimeModule;if(i=!!h&&h.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=i,i){var u=function(t,e,i,s,r,n,o){var a=Math.max(ve(s),ve(r),ve(n),ve(o)),l=i*a*4;null!==e&&e.length===l||(e=new Float32Array(i*a*4));for(var h=[s,r,n,o],u=0;u<a;u++)for(var c=0;c<4;c++)for(var _=h[c],d=0,p=0,f=0;f<i;f++){var m=me(_,.03225806451612903*f,u);p=(d+=m)/(f+1),e[4*(u*i+f)+c]=p}return{texture:ye(t,e,i,a),texdata:e}}(this._velocityTexture,this._velocityData,oo,h.x,h.y,h.z,h.speedModifier);this._velocityTexture=u.texture,this._velocityData=u.texdata;var c=e.getHandle("velocity_over_time_tex0"),_=ht.getBindingFromHandle(c);e.bindSampler(_,this._velocityTexture.getGFXSampler()),e.bindTexture(_,this._velocityTexture.getGFXTexture());var d=e.getHandle("u_velocity_space");e.setUniform(d,h.space);var p=e.getHandle("u_velocity_mode");e.setUniform(p,this._velocityTexture.height)}var f=this._particleSystem._colorOverLifetimeModule;if(i=!!f&&f.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=i,i){var m=function(t,e,i,s){var r=function(t){switch(t.mode){case Ue.TwoColors:case Ue.TwoGradients:return 2;default:return 1}}(s),n=i*r*4;null!==e&&e.length===n||(e=new Uint8Array(i*r*4));for(var o=1/(i-1),a=0,l=0;l<r;l++)for(var h=0;h<i;h++){var u=We(s,o*h,l);e[a]=u.r,e[a+1]=u.g,e[a+2]=u.b,e[a+3]=u.a,a+=4}return null!==t&&i===t.width&&r===t.height||(t&&t.destroy(),(t=new it).create(i,r,nt.RGBA8888),t.setFilters(ot.LINEAR,ot.LINEAR),t.setWrapMode(at.CLAMP_TO_EDGE,at.CLAMP_TO_EDGE)),t.uploadData(e),{texture:t,texdata:e}}(this._colorTexture,this._colorData,oo,f.color);this._colorTexture=m.texture,this._colorData=m.texdata;var v=e.getHandle("color_over_time_tex0"),y=ht.getBindingFromHandle(v);e.bindSampler(y,this._colorTexture.getGFXSampler()),e.bindTexture(y,this._colorTexture.getGFXTexture());var M=e.getHandle("u_color_mode");e.setUniform(M,this._colorTexture.height)}var g,S=this._particleSystem._rotationOvertimeModule;if(i=!!S&&S.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=i,i&&(g=S.separateAxes?Me(this._rotationTexture,this._rotationData,oo,S.x,S.y,S.z):function(t,e,i,s){var r=ve(s),n=128*r;null!==e&&e.length===n||(e=new Float32Array(128*r));for(var o=0,a=0;a<r;a++)for(var l=0;l<32;l++){var h=me(s,.03225806451612903*l,a);e[o+2]=h,o+=4}return{texture:ye(t,e,32,r),texdata:e}}(this._rotationTexture,this._rotationData,0,S.z),this._rotationTexture=g.texture,this._rotationData=g.texdata,this._rotationTexture)){var b=e.getHandle("rotation_over_time_tex0"),T=ht.getBindingFromHandle(b);e.bindSampler(T,this._rotationTexture.getGFXSampler()),e.bindTexture(T,this._rotationTexture.getGFXTexture());var x=e.getHandle("u_rotation_mode");e.setUniform(x,this._rotationTexture.height)}var w,A=this._particleSystem._sizeOvertimeModule;if(i=!!A&&A.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=i,i&&(w=A.separateAxes?Me(this._sizeTexture,this._sizeData,oo,A.x,A.y,A.z,!0):function(t,e,i,s){var r=ve(s),n=128*r;null!==e&&e.length===n||(e=new Float32Array(128*r));for(var o=0,a=0,l=0;l<r;l++){0;for(var h=0;h<32;h++){var u=me(s,.03225806451612903*h,l);o=u,e[a]=o,e[a+1]=o,e[a+2]=o,a+=4}}return{texture:ye(t,e,32,r),texdata:e}}(this._sizeTexture,this._sizeData,0,A.size),this._sizeTexture=w.texture,this._sizeData=w.texdata,this._sizeTexture)){var R=e.getHandle("size_over_time_tex0"),O=ht.getBindingFromHandle(R);e.bindSampler(O,this._sizeTexture.getGFXSampler()),e.bindTexture(O,this._sizeTexture.getGFXTexture());var C=e.getHandle("u_size_mode");e.setUniform(C,this._sizeTexture.height)}var E=this._particleSystem._textureAnimationModule;if(i=!!E&&E.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=i,i){var F=function(t,e,i,s,r){var n=Math.max(ve(s),ve(r)),o=i*n*4;null!==e&&e.length===o||(e=new Float32Array(i*n*4));for(var a=[s,r],l=0;l<n;l++)for(var h=0;h<2;h++)for(var u=a[h],c=0,_=0;_<i;_++){var d=me(u,.03225806451612903*_,l);c=d,e[4*(l*i+_)+h]=c}return{texture:ye(t,e,i,n),texdata:e}}(this._animTexture,this._animData,oo,E.startFrame,E.frameOverTime);this._animTexture=F.texture,this._animData=F.texdata;var D=e.getHandle("texture_animation_tex0"),P=ht.getBindingFromHandle(D);e.bindSampler(P,this._animTexture.getGFXSampler()),e.bindTexture(P,this._animTexture.getGFXTexture());var z=e.getHandle("u_anim_info");Bn.x=this._animTexture.height,Bn.y=E.numTilesX*E.numTilesY,Bn.z=E.cycleCount,e.setUniform(z,Bn)}this._defines.USE_VK_SHADER=yt.gfxDevice.gfxAPI===Ot.VULKAN,this._defines.CC_INSTANCE_PARTICLE=this._useInstance},i.getParticleCount=function(){return this._particleNum},i.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},i.onRebuildPSO=function(t,e){this._model&&0===t&&this._model.setSubModelMaterial(0,e)},i.updateVertexAttrib=function(){if(this._renderInfo.renderMode===_i.Mesh&&this._renderInfo.mesh){var t=this._renderInfo.mesh.readAttributeFormat(0,St.ATTR_COLOR);if(t){for(var e=bt.RGBA8,i=0;i<Tt.length;++i)if(Tt[i].name===t.name){e=i;break}this._vertAttrs[9]=new gt(St.ATTR_COLOR1,e,!0,this._useInstance?1:0)}else{var s=bt.RGBA8;this._vertAttrs[9]=new gt(St.ATTR_COLOR1,s,!0,this._useInstance?1:0)}}},i._setVertexAttrib=function(){if(this._useInstance)this._setVertexAttribIns();else switch(this._renderInfo.renderMode){case _i.StrecthedBillboard:this._vertAttrs=mo.slice();break;case _i.Mesh:this._vertAttrs=vo.slice();break;default:this._vertAttrs=mo.slice()}},i._setVertexAttribIns=function(){switch(this._renderInfo.renderMode){case _i.StrecthedBillboard:this._vertAttrs=yo.slice();break;case _i.Mesh:this._vertAttrs=Mo.slice();break;default:this._vertAttrs=yo.slice()}},i.updateMaterialParams=function(){if(this._particleSystem){var t=this._particleSystem,e=t.sharedMaterial;null!==e&&(e._effectAsset._name,this._renderInfo.mainTexture=e.getProperty("mainTexture",0)),null==t.sharedMaterial&&null==this._defaultMat&&(go.parent=et.get("default-particle-gpu-material"),go.owner=t,go.subModelIdx=0,this._defaultMat=new lt(go),go.parent=null,go.owner=null,go.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=t.getMaterialInstance(0)||this._defaultMat;t.node.getWorldMatrix(In),t._simulationSpace===hi.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var s=this._renderInfo.renderMode;s===_i.Billboard?this._defines.CC_RENDER_MODE=0:s===_i.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):s===_i.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:s===_i.VerticalBillboard?this._defines.CC_RENDER_MODE=3:s===_i.Mesh?this._defines.CC_RENDER_MODE=4:N("particle system renderMode "+s+" not support.");var r=t._textureAnimationModule;r&&r.enable?(w.set(this._frameTile_velLenScale,r.numTilesX,r.numTilesY),h.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,h.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},i.setUseInstance=function(t){this._useInstance!==t&&(this._useInstance=t,this._model&&(this._model.useInstance=t,this._model.doDestroy()),this.updateRenderMode())},i.getNoisePreview=function(){},e}(Mn);function bo(){var t=ft.root.device;return!!(t.capabilities.maxVertexTextureUnits>=8&&t.getFormatFeatures(bt.RGBA32F)&(Ct.RENDER_TARGET|Ct.SAMPLED_TEXTURE))||(n.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var To,xo,wo,Ao,Ro,Oo,Co,Eo,Fo,Do,Po,zo,Io,Bo,Lo,Vo,No,ko,Uo,Go,Xo,Ho,Wo,Yo,jo,Zo,qo,Qo,Ko,Jo,$o,ta,ea,ia,sa,ra,na,oa,aa,la,ha,ua,ca,_a,da,pa,fa,ma,va,ya,Ma,ga,Sa,ba,Ta,xa,wa,Aa,Ra,Oa,Ca,Ea,Fa,Da,Pa,za,Ia,Ba,La,Va,Na,ka,Ua,Ga,Xa,Ha,Wa,Ya,ja,Za,qa,Qa,Ka,Ja,$a,tl,el,il,sl,rl,nl,ol,al,ll,hl,ul,cl,_l,dl,pl,fl,ml,vl,yl,Ml,gl,Sl,bl,Tl,xl,wl,Al,Rl,Ol,Cl,El,Fl,Dl,Pl,zl,Il,Bl,Ll,Vl,Nl,kl,Ul,Gl,Xl,Hl,Wl,Yl,jl,Zl,ql,Ql,Kl,Jl,$l,th,eh,ih,sh,rh,nh,oh=(Nn=e("cc.ParticleSystemRenderer"),kn=i(_i),Un=i(_i),Gn=i(Dt),Xn=i(tt),Hn=i(tt),Wn=i(tt),Yn=i(tt),jn=i(ci),Nn(((no=function(){function t(){this._renderMode=Qn&&Qn(),this._velocityScale=Kn&&Kn(),this._lengthScale=Jn&&Jn(),this._mesh=$n&&$n(),this._cpuMaterial=to&&to(),this._gpuMaterial=eo&&eo(),this._mainTexture=io&&io(),this._useGPU=so&&so(),this._alignSpace=ro&&ro(),this._particleSystem=null}var e=t.prototype;return e.create=function(t){null===this._particleSystem?this._particleSystem=t:this._particleSystem!==t&&k(6033)},e.onInit=function(t){this.create(t);var e=this._useGPU&&bo();this._particleSystem.processor?k(6034):(this._particleSystem.processor=e?new So(this):new zn(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(t)),e?this.gpuMaterial=this.particleMaterial:(this.particleMaterial&&-1!==this.particleMaterial.effectName.indexOf("particle-gpu")&&(this.particleMaterial=null,U(6035)),this.cpuMaterial=this.particleMaterial)},e._switchProcessor=function(){if(this._particleSystem){this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null);var t=this._useGPU&&bo();!t&&this.cpuMaterial&&(this.particleMaterial=this.cpuMaterial),t&&this.gpuMaterial&&(this.particleMaterial=this.gpuMaterial),this._particleSystem.processor=t?new So(this):new zn(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule()}},o(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode!==t&&(this._renderMode=t,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(t){this._velocityScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(t){this._lengthScale=t,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(t){this._mesh=t,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getSharedMaterial(0):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,0)}},{key:"cpuMaterial",get:function(){return this._cpuMaterial},set:function(t){if(null!==t){var e=t.effectName;-1!==e.indexOf("particle")&&-1===e.indexOf("particle-gpu")?(this._cpuMaterial=t,this.particleMaterial=this._cpuMaterial):U(6035)}}},{key:"gpuMaterial",get:function(){return this._gpuMaterial},set:function(t){null!==t&&(-1!==t.effectName.indexOf("particle-gpu")?(this._gpuMaterial=t,this.particleMaterial=this._gpuMaterial):U(6035))}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getSharedMaterial(1):null},set:function(t){this._particleSystem&&this._particleSystem.setMaterial(t,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(t){this._mainTexture=t}},{key:"useGPU",get:function(){return this._useGPU},set:function(t){this._useGPU!==t&&(bo()?this._useGPU=t:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(t){this._alignSpace=t,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),t}()).AlignmentSpace=ci,l((qn=no).prototype,"renderMode",[kn],Object.getOwnPropertyDescriptor(qn.prototype,"renderMode"),qn.prototype),Qn=a(qn.prototype,"_renderMode",[Un,_],(function(){return _i.Billboard})),Kn=a(qn.prototype,"_velocityScale",[_],(function(){return 1})),Jn=a(qn.prototype,"_lengthScale",[_],(function(){return 1})),$n=a(qn.prototype,"_mesh",[_],(function(){return null})),l(qn.prototype,"mesh",[Gn],Object.getOwnPropertyDescriptor(qn.prototype,"mesh"),qn.prototype),l(qn.prototype,"particleMaterial",[Xn],Object.getOwnPropertyDescriptor(qn.prototype,"particleMaterial"),qn.prototype),l(qn.prototype,"cpuMaterial",[Hn],Object.getOwnPropertyDescriptor(qn.prototype,"cpuMaterial"),qn.prototype),to=a(qn.prototype,"_cpuMaterial",[_],(function(){return null})),l(qn.prototype,"gpuMaterial",[Wn],Object.getOwnPropertyDescriptor(qn.prototype,"gpuMaterial"),qn.prototype),eo=a(qn.prototype,"_gpuMaterial",[_],(function(){return null})),l(qn.prototype,"trailMaterial",[Yn],Object.getOwnPropertyDescriptor(qn.prototype,"trailMaterial"),qn.prototype),io=a(qn.prototype,"_mainTexture",[_],(function(){return null})),so=a(qn.prototype,"_useGPU",[_],(function(){return!1})),l(qn.prototype,"alignSpace",[jn],Object.getOwnPropertyDescriptor(qn.prototype,"alignSpace"),qn.prototype),ro=a(qn.prototype,"_alignSpace",[_],(function(){return ci.View})),Zn=qn))||Zn),ah=Math.cos(c(100)),lh={position:new d,velocity:new d},hh=new A,uh=new d,ch=new d,_h=new r,dh=function(){function t(t){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];t--;)this.trailElements.push({position:new d,lifetime:0,width:0,velocity:new d,direction:0,color:new r})}var e=t.prototype;return e.getElement=function(t){return-1===this.start?null:(t<0&&(t=(t+this.trailElements.length)%this.trailElements.length),t>=this.trailElements.length&&(t%=this.trailElements.length),this.trailElements[t])},e.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new d,lifetime:0,width:0,velocity:new d,direction:0,color:new r}),this.start++,this.start%=this.trailElements.length);var t=this.end++;return this.end%=this.trailElements.length,this.trailElements[t]},e.iterateElement=function(t,e,i,s){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,n=this.start;n<r;n++)e(t,this.trailElements[n%this.trailElements.length],i,s)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},e.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},e.clear=function(){this.start=-1,this.end=-1},t}(),ph=(To=e("cc.TrailModule"),xo=i(mi),wo=i(fe),Ao=i(hi),Ro=i(vi),Oo=i(fe),Co=i(He),Eo=i(He),Fo=i(hi),To((Po=function(){var t=e.prototype;function e(){this._enable=zo&&zo(),this.mode=Io&&Io(),this.lifeTime=Bo&&Bo(),this._minParticleDistance=Lo&&Lo(),this.existWithParticles=Vo&&Vo(),this.textureMode=No&&No(),this.widthFromParticle=ko&&ko(),this.widthRatio=Uo&&Uo(),this.colorFromParticle=Go&&Go(),this.colorOverTrail=Xo&&Xo(),this.colorOvertime=Ho&&Ho(),this._space=Wo&&Wo(),this._particleSystem=Yo&&Yo(),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._psTransform=new R,this._iaVertCount=0,this._iaIndexCount=0,this._inited=void 0,this._vertAttrs=[new gt(St.ATTR_POSITION,bt.RGB32F),new gt(St.ATTR_TEX_COORD,bt.RGBA32F),new gt(St.ATTR_TEX_COORD1,bt.RGB32F),new gt(St.ATTR_COLOR,bt.RGBA8,!0)],this._vertSize=0;for(var t,e=L(this._vertAttrs);!(t=e()).done;){var i=t.value;this._vertSize+=Tt[i.format].size}this._particleTrail=new Map,this._inited=!1}return t.getModel=function(){return this._trailModel},t.onInit=function(t){this._particleSystem=t,this.minParticleDistance=this._minParticleDistance;for(var e=0,i=t.startLifetime.getMax(),s=t.rateOverTime.getMax(),r=t.duration,n=0,o=t.bursts.length;n<o;n++)e+=t.bursts[n].getMaxCount(t)*Math.ceil(i/r);this.lifeTime.getMax()<1&&U(6036),this._trailNum=Math.ceil(i*Math.ceil(this.lifeTime.getMax())*60*(s*r+e)),this._trailSegments=new G((function(){return new dh(10)}),Math.ceil(s*r),(function(t){return t.trailElements.length=0})),this._enable&&(this.enable=this._enable),this._inited=!0},t.onEnable=function(){this._attachToScene()},t.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},t._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},t._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},t.destroy=function(){this.destroySubMeshData(),this._trailModel&&(ft.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},t.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},t.clear=function(){if(this.enable){for(var t=this._particleTrail.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},t.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},t.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===hi.World&&this._particleSystem._simulationSpace===hi.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(this._psTransform),this._particleSystem.node.getWorldRotation(hh)):this._needTransform=!1},t.animate=function(t,e){if(this._trailSegments)if(t.loopCount>t.lastLoop)t.trailDelay>1?(t.lastLoop=t.loopCount,t.trailDelay=0):t.trailDelay++;else{var i=this._particleTrail.get(t);if(!i)return i=this._trailSegments.alloc(),void this._particleTrail.set(t,i);var s=i.getElement(i.end-1);if(this._needTransform?d.transformMat4(uh,t.position,this._psTransform):d.copy(uh,t.position),!(s&&(i.iterateElement(this,this._updateTrailElement,t,e),d.squaredDistance(s.position,uh)<this._minSquaredDistance))&&(s=i.addElement())){d.copy(s.position,uh),s.lifetime=0,this.widthFromParticle?s.width=t.size.x*this.widthRatio.evaluate(0,1):s.width=this.widthRatio.evaluate(0,1);var r=i.count();if(2===r){var n=i.getElement(i.end-2);d.subtract(n.velocity,s.position,n.position)}else if(r>2){var o=i.getElement(i.end-2),a=i.getElement(i.end-3);d.subtract(uh,a.position,o.position),d.subtract(ch,s.position,o.position),d.subtract(o.velocity,ch,uh),d.equals(d.ZERO,o.velocity)&&d.copy(o.velocity,uh),d.normalize(o.velocity,o.velocity),this._checkDirectionReverse(o,a)}this.colorFromParticle?s.color.set(t.color):s.color.set(this.colorOvertime.evaluate(0,1))}}},t.removeParticle=function(t){var e=this._particleTrail.get(t);e&&this._trailSegments&&(e.clear(),this._trailSegments.free(e),this._particleTrail.delete(t))},t.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var t,e=L(this._particleTrail.keys());!(t=e()).done;){var i=t.value,s=this._particleTrail.get(i);if(-1!==s.start){var r=4*this.vbOffset/this._vertSize,n=s.start>=s.end?s.end+s.trailElements.length:s.end,o=n-s.start,a=1/o,l=s.trailElements[s.start];this._fillVertexBuffer(l,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var h=s.start+1;h<n;h++){var u=s.trailElements[h%s.trailElements.length],c=h-s.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-c/o,1),r,1-c*a,c,5)}this._needTransform?d.transformMat4(lh.position,i.position,this._psTransform):d.copy(lh.position,i.position);var _=this._trailModel;if(_&&_.node.invalidateChildren(ut.POSITION),1===o||2===o){var p=s.getElement(s.end-1);d.subtract(p.velocity,lh.position,p.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=p.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=p.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=p.velocity.z,this._vbF32[this.vbOffset-4]=p.velocity.x,this._vbF32[this.vbOffset-3]=p.velocity.y,this._vbF32[this.vbOffset-2]=p.velocity.z,d.subtract(lh.velocity,lh.position,p.position),this._checkDirectionReverse(lh,p)}else if(o>2){var f=s.getElement(s.end-1),m=s.getElement(s.end-2);d.subtract(uh,m.position,f.position),d.subtract(ch,lh.position,f.position),d.normalize(uh,uh),d.normalize(ch,ch),d.subtract(f.velocity,ch,uh),d.normalize(f.velocity,f.velocity),this._checkDirectionReverse(f,m),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(f,this.colorOverTrail.evaluate(a,1),r,a,o-1,5),d.subtract(lh.velocity,lh.position,f.position),d.normalize(lh.velocity,lh.velocity),this._checkDirectionReverse(lh,f)}this.widthFromParticle?lh.width=i.size.x*this.widthRatio.evaluate(0,1):lh.width=this.widthRatio.evaluate(0,1),lh.color=i.color,d.equals(lh.velocity,d.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(lh,this.colorOverTrail.evaluate(0,1),r,0,o,1)}}this._trailModel&&(this._trailModel.enabled=this.ibOffset>0)},t.updateIA=function(t){var e=this._trailModel&&this._trailModel.subModels;if(e&&e.length>0){var i=e[0];i.inputAssembler.vertexBuffers[0].update(this._vbF32),i.inputAssembler.indexBuffer.update(this._iBuffer),i.inputAssembler.firstIndex=0,i.inputAssembler.indexCount=t,i.inputAssembler.vertexCount=this._iaVertCount}},t.beforeRender=function(){this.updateIA(this.ibOffset)},t._createModel=function(){this._trailModel||(this._trailModel=n.director.root.createModel(dt))},t.rebuild=function(){var t=ft.root.device,e=t.createBuffer(new xt(wt.VERTEX|wt.TRANSFER_DST,At.HOST|At.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),i=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(i),this._vbUint32=new Uint32Array(i),e.update(i);var s=t.createBuffer(new xt(wt.INDEX|wt.TRANSFER_DST,At.HOST|At.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),s.update(this._iBuffer),this._iaVertCount=2*(this._trailNum+1),this._iaIndexCount=6*this._trailNum,this._subMeshData=new st([e],this._vertAttrs,Mt.TRIANGLE_LIST,s);var r=this._trailModel;r&&this._material&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},t._updateTrailElement=function(t,e,i,s){return e.lifetime+=s,t.colorFromParticle?(e.color.set(i.color),e.color.multiply(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1))):e.color.set(t.colorOvertime.evaluate(1-i.remainingLifetime/i.startLifetime,1)),t.widthFromParticle?e.width=i.size.x*t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1):e.width=t.widthRatio.evaluate(e.lifetime/t._trailLifetime,1),e.lifetime>t._trailLifetime},t._fillVertexBuffer=function(t,e,i,s,r,n){this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=s,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,_h.set(t.color),_h.multiply(e),this._vbUint32[this.vbOffset++]=_h._val,this._vbF32[this.vbOffset++]=t.position.x,this._vbF32[this.vbOffset++]=t.position.y,this._vbF32[this.vbOffset++]=t.position.z,this._vbF32[this.vbOffset++]=1-t.direction,this._vbF32[this.vbOffset++]=t.width,this._vbF32[this.vbOffset++]=s,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=t.velocity.x,this._vbF32[this.vbOffset++]=t.velocity.y,this._vbF32[this.vbOffset++]=t.velocity.z,this._vbUint32[this.vbOffset++]=_h._val,1&n&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r-1,this._iBuffer[this.ibOffset++]=i+2*r+1),4&n&&(this._iBuffer[this.ibOffset++]=i+2*r,this._iBuffer[this.ibOffset++]=i+2*r+1,this._iBuffer[this.ibOffset++]=i+2*r+2)},t._checkDirectionReverse=function(t,e){d.dot(t.velocity,e.velocity)<ah?t.direction=1-e.direction:t.direction=e.direction},t.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){t===this._enable&&this._trailModel||(t&&!this._enable&&(this._enable=t,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),t&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=t,this._trailModel&&(this._trailModel.enabled=t),t?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(t){this._minParticleDistance=t,this._minSquaredDistance=t*t}},{key:"space",get:function(){return this._space},set:function(t){this._space=t;var e=this._particleSystem;e&&e.processor&&e.processor.updateTrailMaterial()}},{key:"inited",get:function(){return this._inited}}]),e}(),zo=a(Po.prototype,"_enable",[_],(function(){return!1})),Io=a(Po.prototype,"mode",[xo,_],(function(){return mi.Particles})),Bo=a(Po.prototype,"lifeTime",[wo,_],(function(){return new fe})),Lo=a(Po.prototype,"_minParticleDistance",[_],(function(){return.1})),l(Po.prototype,"space",[Ao],Object.getOwnPropertyDescriptor(Po.prototype,"space"),Po.prototype),Vo=a(Po.prototype,"existWithParticles",[_],(function(){return!0})),No=a(Po.prototype,"textureMode",[Ro,_],(function(){return vi.Stretch})),ko=a(Po.prototype,"widthFromParticle",[_],(function(){return!0})),Uo=a(Po.prototype,"widthRatio",[Oo,_],(function(){return new fe})),Go=a(Po.prototype,"colorFromParticle",[_],(function(){return!1})),Xo=a(Po.prototype,"colorOverTrail",[Co,_],(function(){return new He})),Ho=a(Po.prototype,"colorOvertime",[Eo,_],(function(){return new He})),Wo=a(Po.prototype,"_space",[Fo],(function(){return hi.World})),Yo=a(Po.prototype,"_particleSystem",[_],(function(){return null})),Do=Po))||Do),fh=new R,mh=new R,vh=new A,yh=new d,Mh=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],gh=function(){function t(t){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new R,this._gravity=new h,this.minPos=new d,this.maxPos=new d,this._nodePos=new d,this._nodeSize=new d,this._particleSystem=t,this._processor=this._particleSystem.processor,this._node=t.node,this._particlesAll=[],this._initModuleList()}var e=t.prototype;return e._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},e.setBoundingBoxSize=function(t){this.maxPos.x=this._nodePos.x+t.x,this.maxPos.y=this._nodePos.y+t.y,this.maxPos.z=this._nodePos.z+t.z,this.minPos.x=this._nodePos.x-t.x,this.minPos.y=this._nodePos.y-t.y,this.minPos.z=this._nodePos.z-t.z,this._updateBoundingNode()},e.setBoundingBoxCenter=function(t,e,i){this.maxPos.x=t+.5*this._nodeSize.x,this.maxPos.y=e+.5*this._nodeSize.y,this.maxPos.z=i+.5*this._nodeSize.z,this.minPos.x=t-.5*this._nodeSize.x,this.minPos.y=e-.5*this._nodeSize.y,this.minPos.z=i-.5*this._nodeSize.z,this._updateBoundingNode()},e._initModuleList=function(){var t=this;Mh.forEach((function(e){var i=t._particleSystem[e];i&&i.enable&&(i.needUpdate&&(t._updateList[i.name]=i),i.needAnimate&&(t._animateList[i.name]=i))})),this._runAnimateList.length=0;for(var e=0,i=oi.length;e<i;e++){var s=this._animateList[oi[e]];s&&this._runAnimateList.push(s)}},e._emit=function(t,e,i){var s=this._particleSystem,r=this._node,n=s.time%s.duration/s.duration;r.invalidateChildren(ut.POSITION),s.simulationSpace===hi.World&&(r.getWorldMatrix(fh),r.getWorldRotation(vh));for(var o=0;o<t;++o){var a=new Ze(s);a.particleSystem=s,a.reset();var l=D(E(0,X));s._shapeModule&&s._shapeModule.enable?s._shapeModule.emit(a):(d.set(a.position,0,0,0),d.copy(a.velocity,yi)),s._textureAnimationModule&&s._textureAnimationModule.enable&&s._textureAnimationModule.init(a);var h=s.startSpeed.evaluate(n,l);d.multiplyScalar(a.velocity,a.velocity,h),s.simulationSpace===hi.World&&(d.transformMat4(a.position,a.position,fh),d.transformQuat(a.velocity,a.velocity,vh)),d.copy(a.ultimateVelocity,a.velocity),d.set(a.rotation,0,0,0),s.startSize3D?d.set(a.startSize,s.startSizeX.evaluate(n,l),s.startSizeY.evaluate(n,l),s.startSizeZ.evaluate(n,l)):(d.set(a.startSize,s.startSizeX.evaluate(n,l),1,1),a.startSize.y=a.startSize.x),d.copy(a.size,a.startSize),a.startLifetime=s.startLifetime.evaluate(n,l)+e,a.remainingLifetime=a.startLifetime,i.push(a)}},e._updateParticles=function(t,e){var i=this,s=this._particleSystem;switch(s.node.getWorldMatrix(fh),s.scaleSpace){case hi.Local:s.node.getScale(yh);break;case hi.World:s.node.getWorldScale(yh)}if(this._updateList.forEach((function(t){t.update(s.simulationSpace,fh)})),s.simulationSpace===hi.Local){var r=s.node.getRotation();R.fromQuat(this._localMat,r),this._localMat.transpose()}s.node.parent&&(s.node.parent.getWorldMatrix(mh),mh.invert());for(var n=function(){var r=e[o];if(r.remainingLifetime-=t,d.set(r.animatedVelocity,0,0,0),s.gravityModifier.mode!==pe.Constant||0!==s.gravityModifier.constant){var n=Ai(s.gravityModifier)?D(r.randomSeed):0;if(s.simulationSpace===hi.Local){var a=9.8*-s.gravityModifier.evaluate(1-r.remainingLifetime/r.startLifetime,n)*t;i._gravity.x=0,i._gravity.y=a,i._gravity.z=0,i._gravity.w=1,v(a,0,g)||(s.node.parent&&(i._gravity=i._gravity.transformMat4(mh)),i._gravity=i._gravity.transformMat4(i._localMat),r.velocity.x+=i._gravity.x,r.velocity.y+=i._gravity.y,r.velocity.z+=i._gravity.z)}else r.velocity.y-=9.8*s.gravityModifier.evaluate(1-r.remainingLifetime/r.startLifetime,n)*t}d.copy(r.ultimateVelocity,r.velocity),i._runAnimateList.forEach((function(e){e.animate(r,t)})),d.scaleAndAdd(r.position,r.position,r.ultimateVelocity,t)},o=0;o<e.length;++o)n()},e._calculateBounding=function(t){var e=new d,i=new d,s=new d,r=new d,n=new d(1,1,1);if(this._processor.getInfo().renderMode===_i.Mesh){var o=this._processor.getInfo().mesh;if(o&&o.struct.minPosition&&o.struct.maxPosition){var a=new H;H.fromPoints(a,o.struct.minPosition,o.struct.maxPosition);var l=Math.max(a.halfExtents.x,a.halfExtents.y,a.halfExtents.z);n.set(l,l,l)}}for(var h=this._particleSystem.node.worldMatrix,u=0;u<this._particlesAll.length;++u){var c=this._particlesAll[u];d.multiply(e,yh,c.size),d.multiply(e,e,n),i.set(c.position),this._particleSystem.simulationSpace!==hi.World&&d.transformMat4(i,i,h),t&&0===u?(d.subtract(this.minPos,i,e),d.add(this.maxPos,i,e)):(d.subtract(s,i,e),d.add(r,i,e),d.min(this.minPos,this.minPos,s),d.max(this.maxPos,this.maxPos,r))}},e.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var t=Ai(this._particleSystem.startLifetime)?D(E(0,X)):0;this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,t),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},e.clear=function(){this._particlesAll.length=0},e.destroy=function(){},t}(),Sh=_,bh=i,Th=(jo=e("cc.NoiseModule"),Zo=bh(W),qo=bh(W),Qo=bh(W),Ko=bh(W),Jo=bh(W),$o=bh(W),ta=bh(W),ea=bh(W),ia=bh(W),sa=bh(W),ra=bh(Y),na=bh(W),oa=bh(W),jo((la=function(t){function e(){for(var e,i=arguments.length,s=new Array(i),r=0;r<i;r++)s[r]=arguments[r];return(e=t.call.apply(t,[this].concat(s))||this)._enable=ha&&ha(),e._strengthX=ua&&ua(),e._strengthY=ca&&ca(),e._strengthZ=_a&&_a(),e._noiseSpeedX=da&&da(),e._noiseSpeedY=pa&&pa(),e._noiseSpeedZ=fa&&fa(),e._noiseFrequency=ma&&ma(),e._remapX=va&&va(),e._remapY=ya&&ya(),e._remapZ=Ma&&Ma(),e._octaves=ga&&ga(),e._octaveMultiplier=Sa&&Sa(),e._octaveScale=ba&&ba(),e.name=ni,e.noise=new gn,e.samplePosition=new d,e}s(e,t);var i=e.prototype;return i.animate=function(t,e){this.noise.setTime(t.particleSystem.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.samplePosition.set(t.position),this.samplePosition.add3f(1*Math.random(),1*Math.random(),1*Math.random()),this.noise.setSamplePoint(this.samplePosition),this.noise.getNoiseParticle();var i=this.noise.getResult();i.multiply3f(Math.random(),Math.random(),Math.random()),d.add(t.position,t.position,i.multiplyScalar(e))},i.getNoisePreview=function(t,e,i,s){this.noise.setTime(e.time),this.noise.setSpeed(this.noiseSpeedX,this.noiseSpeedY,this.noiseSpeedZ),this.noise.setFrequency(this.noiseFrequency),this.noise.setAbs(this.remapX,this.remapY,this.remapZ),this.noise.setAmplititude(this.strengthX,this.strengthY,this.strengthZ),this.noise.setOctaves(this.octaves,this.octaveMultiplier,this.octaveScale),this.noise.getNoiseParticle(),this.noise.getPreview(t,i,s)},o(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable!==t&&(this._enable=t,this.target&&this.target.enableModule(this.name,t,this))}},{key:"strengthX",get:function(){return this._strengthX},set:function(t){this._strengthX=t}},{key:"strengthY",get:function(){return this._strengthY},set:function(t){this._strengthY=t}},{key:"strengthZ",get:function(){return this._strengthZ},set:function(t){this._strengthZ=t}},{key:"noiseSpeedX",get:function(){return this._noiseSpeedX},set:function(t){this._noiseSpeedX=t}},{key:"noiseSpeedY",get:function(){return this._noiseSpeedY},set:function(t){this._noiseSpeedY=t}},{key:"noiseSpeedZ",get:function(){return this._noiseSpeedZ},set:function(t){this._noiseSpeedZ=t}},{key:"noiseFrequency",get:function(){return this._noiseFrequency},set:function(t){this._noiseFrequency=t}},{key:"remapX",get:function(){return this._remapX},set:function(t){this._remapX=t}},{key:"remapY",get:function(){return this._remapY},set:function(t){this._remapY=t}},{key:"remapZ",get:function(){return this._remapZ},set:function(t){this._remapZ=t}},{key:"octaves",get:function(){return this._octaves},set:function(t){this._octaves=t}},{key:"octaveMultiplier",get:function(){return this._octaveMultiplier},set:function(t){this._octaveMultiplier=t}},{key:"octaveScale",get:function(){return this._octaveScale},set:function(t){this._octaveScale=t}}]),e}(li),ha=a(la.prototype,"_enable",[Sh],(function(){return!1})),l(la.prototype,"strengthX",[Zo],Object.getOwnPropertyDescriptor(la.prototype,"strengthX"),la.prototype),ua=a(la.prototype,"_strengthX",[Sh],(function(){return 10})),l(la.prototype,"strengthY",[qo],Object.getOwnPropertyDescriptor(la.prototype,"strengthY"),la.prototype),ca=a(la.prototype,"_strengthY",[Sh],(function(){return 10})),l(la.prototype,"strengthZ",[Qo],Object.getOwnPropertyDescriptor(la.prototype,"strengthZ"),la.prototype),_a=a(la.prototype,"_strengthZ",[Sh],(function(){return 10})),l(la.prototype,"noiseSpeedX",[Ko],Object.getOwnPropertyDescriptor(la.prototype,"noiseSpeedX"),la.prototype),da=a(la.prototype,"_noiseSpeedX",[Sh],(function(){return 0})),l(la.prototype,"noiseSpeedY",[Jo],Object.getOwnPropertyDescriptor(la.prototype,"noiseSpeedY"),la.prototype),pa=a(la.prototype,"_noiseSpeedY",[Sh],(function(){return 0})),l(la.prototype,"noiseSpeedZ",[$o],Object.getOwnPropertyDescriptor(la.prototype,"noiseSpeedZ"),la.prototype),fa=a(la.prototype,"_noiseSpeedZ",[Sh],(function(){return 0})),l(la.prototype,"noiseFrequency",[ta],Object.getOwnPropertyDescriptor(la.prototype,"noiseFrequency"),la.prototype),ma=a(la.prototype,"_noiseFrequency",[Sh],(function(){return 1})),l(la.prototype,"remapX",[ea],Object.getOwnPropertyDescriptor(la.prototype,"remapX"),la.prototype),va=a(la.prototype,"_remapX",[Sh],(function(){return 0})),l(la.prototype,"remapY",[ia],Object.getOwnPropertyDescriptor(la.prototype,"remapY"),la.prototype),ya=a(la.prototype,"_remapY",[Sh],(function(){return 0})),l(la.prototype,"remapZ",[sa],Object.getOwnPropertyDescriptor(la.prototype,"remapZ"),la.prototype),Ma=a(la.prototype,"_remapZ",[Sh],(function(){return 0})),l(la.prototype,"octaves",[ra],Object.getOwnPropertyDescriptor(la.prototype,"octaves"),la.prototype),ga=a(la.prototype,"_octaves",[Sh],(function(){return 1})),l(la.prototype,"octaveMultiplier",[na],Object.getOwnPropertyDescriptor(la.prototype,"octaveMultiplier"),la.prototype),Sa=a(la.prototype,"_octaveMultiplier",[Sh],(function(){return.5})),l(la.prototype,"octaveScale",[oa],Object.getOwnPropertyDescriptor(la.prototype,"octaveScale"),la.prototype),ba=a(la.prototype,"_octaveScale",[Sh],(function(){return 2})),aa=la))||aa),xh=new R,wh=new A,Ah=Object.getOwnPropertyDescriptor(Ft.prototype,"sharedMaterials"),Rh=(Ta=e("cc.ParticleSystem"),xa=q(99),wa=i(He),Aa=i(hi),Ra=z("startSize"),Oa=i(fe),Ca=i(fe),Ea=i(fe),Fa=i(fe),Da=i(fe),Pa=i(fe),za=i(fe),Ia=z("startRotation"),Ba=i(fe),La=i(fe),Va=i(hi),Na=i(fe),ka=i(fe),Ua=i(fe),Ga=i([un]),Xa=i(Q),Ha=i(ui),Wa=i(W),Ya=i(W),ja=i(W),Za=z("enableCulling"),qa=i(_s),Qa=i(_s),Ka=i(pn),Ja=i(pn),$a=i(sn),tl=i(sn),el=i(hn),il=i(hn),sl=i(fs),rl=i(fs),nl=i(Ms),ol=i(Ms),al=i(tn),ll=i(tn),hl=i(on),ul=i(on),cl=i(Th),_l=i(Th),dl=i(ph),pl=i(ph),fl=i(oh),Ta(ml=xa(((nh=function(t){function e(){var e;return(e=t.call(this)||this).startColor=yl&&yl(),e.scaleSpace=Ml&&Ml(),e.startSize3D=gl&&gl(),e.startSizeX=Sl&&Sl(),e.startSizeY=bl&&bl(),e.startSizeZ=Tl&&Tl(),e.startSpeed=xl&&xl(),e.startRotation3D=wl&&wl(),e.startRotationX=Al&&Al(),e.startRotationY=Rl&&Rl(),e.startRotationZ=Ol&&Ol(),e.startDelay=Cl&&Cl(),e.startLifetime=El&&El(),e.duration=Fl&&Fl(),e.loop=Dl&&Dl(),e.simulationSpeed=Pl&&Pl(),e.playOnAwake=zl&&zl(),e.gravityModifier=Il&&Il(),e.rateOverTime=Bl&&Bl(),e.rateOverDistance=Ll&&Ll(),e.bursts=Vl&&Vl(),e._renderCulling=Nl&&Nl(),e._cullingMode=kl&&kl(),e._aabbHalfX=Ul&&Ul(),e._aabbHalfY=Gl&&Gl(),e._aabbHalfZ=Xl&&Xl(),e._dataCulling=Hl&&Hl(),e._colorOverLifetimeModule=Wl&&Wl(),e._shapeModule=Yl&&Yl(),e._sizeOvertimeModule=jl&&jl(),e._velocityOvertimeModule=Zl&&Zl(),e._forceOvertimeModule=ql&&ql(),e._limitVelocityOvertimeModule=Ql&&Ql(),e._rotationOvertimeModule=Kl&&Kl(),e._textureAnimationModule=Jl&&Jl(),e._noiseModule=$l&&$l(),e._trailModule=th&&th(),e.renderer=eh&&eh(),e._isPlaying=void 0,e._isPaused=void 0,e._isStopped=void 0,e._isEmitting=void 0,e._needToRestart=void 0,e._needRefresh=void 0,e._time=void 0,e._emitRateTimeCounter=void 0,e._emitRateDistanceCounter=void 0,e._oldWPos=void 0,e._curWPos=void 0,e._boundingBox=void 0,e._culler=void 0,e._oldPos=void 0,e._curPos=void 0,e._isCulled=void 0,e._isSimulating=void 0,e._customData1=void 0,e._customData2=void 0,e._subEmitters=void 0,e._needAttach=void 0,e._prewarm=ih&&ih(),e._capacity=sh&&sh(),e._simulationSpace=rh&&rh(),e.processor=null,e.rateOverTime.constant=10,e.startLifetime.constant=5,e.startSizeX.constant=1,e.startSpeed.constant=5,e._isPlaying=!1,e._isPaused=!1,e._isStopped=!0,e._isEmitting=!1,e._needToRestart=!1,e._needRefresh=!0,e._needAttach=!1,e._time=0,e._emitRateTimeCounter=0,e._emitRateDistanceCounter=0,e._oldWPos=new d,e._curWPos=new d,e._boundingBox=null,e._culler=null,e._oldPos=null,e._curPos=null,e._isCulled=!1,e._isSimulating=!0,e._customData1=new w,e._customData2=new w,e._subEmitters=[],e}s(e,t);var i=e.prototype;return i.onFocusInEditor=function(){this.renderer.create(this)},i.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&!this.renderer.useGPU&&this._trailModule.enable&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},i._onMaterialModified=function(t,e){null!==this.processor&&this.processor.onMaterialModified(t,e)},i._onRebuildPSO=function(t,e){this.processor.onRebuildPSO(t,e)},i._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},i._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},i._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor),this._noiseModule&&this._noiseModule.bindTarget(this.processor)},i.play=function(){if(this._needToRestart&&(this.reset(),this._needToRestart=!1),this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var t=this.processor.getModel();t&&(t.enabled=this.enabledInHierarchy)}},i.pause=function(){this._isStopped?N("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},i.stopEmitting=function(){this._isEmitting=!1,this._needToRestart=!0},i.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._isEmitting&&(this._isEmitting=!1),this._isStopped=!0,this._needRefresh=!0,this.reset()},i.reset=function(){this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._resetPosition();for(var t,e=L(this.bursts);!(t=e()).done;)t.value.reset()},i.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},i.getParticleCount=function(){return this.processor?this.processor.getParticleCount():0},i.setCustomData1=function(t,e){w.set(this._customData1,t,e)},i.setCustomData2=function(t,e){w.set(this._customData2,t,e)},i.onDestroy=function(){var t;this.stop(),null!==(t=this.processor.getModel())&&void 0!==t&&t.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene()),n.director.off(n.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.onEnable=function(){t.prototype.onEnable.call(this),n.director.on(n.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&!j&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},i.onDisable=function(){n.director.off(n.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i._calculateBounding=function(t){this._boundingBox&&(this._culler||(this._culler=new gh(this)),this._culler.calculatePositions(),H.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),t?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},i.update=function(t){var e,i,s=t*this.simulationSpeed;if(this.renderCulling){var r;if(this._boundingBox||(this._boundingBox=new H,this._calculateBounding(!1)),this._curPos||(this._curPos=new d),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new d,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var n=this._curPos.x-this._oldPos.x,o=this._curPos.y-this._oldPos.y,a=this._curPos.z-this._oldPos.z,l=this._boundingBox.center;l.x+=n,l.y+=o,l.z+=a,this._culler.setBoundingBoxCenter(l.x,l.y,l.z),this._oldPos.set(this._curPos)}var h=null===(r=this.node.scene.renderScene)||void 0===r?void 0:r.cameras,u=!0;if(void 0!==h&&this._boundingBox)for(var c=0;c<h.length;++c){var _=h[c];if((_.visibility&this.node.layer)===this.node.layer&&Z.aabbFrustum(this._boundingBox,_.frustum)){u=!1;break}}if(u){if(this._cullingMode!==ui.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===ui.PauseAndCatchup&&(this._time+=s),this._cullingMode!==ui.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=s,this._emit(s),0!==this.processor.updateParticles(s)||this._isEmitting||this.stop();else{var p=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(p),this.processor.updateScale(p)}this._needAttach&&this.getParticleCount()>0&&!this._isCulled&&(null!==(e=this.processor.getModel())&&void 0!==e&&e.scene||this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&(null!==(i=this._trailModule.getModel())&&void 0!==i&&i.scene||this._trailModule._attachToScene()),this._needAttach=!1);!this.renderer.useGPU&&this._trailModule&&this._trailModule.enable&&(this._trailModule.inited||(this._trailModule.clear(),this._trailModule.destroy(),this._trailModule.onInit(this),this._trailModule.enable=!1,this._trailModule.enable=!0))},i.beforeRender=function(){var t,e;this.getParticleCount()<=0?null!==(e=this.processor.getModel())&&void 0!==e&&e.scene&&(this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._needAttach=!1):null!==(t=this.processor.getModel())&&void 0!==t&&t.scene||(this._needAttach=!0),this._isPlaying&&(this.processor.updateRenderData(),this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&(this._trailModule.updateRenderData(),this._trailModule.beforeRender()))},i._onVisibilityChange=function(t){this.processor.model&&(this.processor.model.visFlags=t)},i.emit=function(t,e){var i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(ut.POSITION),this._needRefresh=!1),this._simulationSpace===hi.World&&(this.node.getWorldMatrix(xh),this.node.getWorldRotation(wh));for(var s=0;s<t;++s){var r=this.processor.getFreeParticle();if(null===r)return;r.particleSystem=this,r.reset();var n=D(E(0,X));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(r):(d.set(r.position,0,0,0),d.copy(r.velocity,yi)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(r);var o=this.startSpeed.evaluate(i,n);d.multiplyScalar(r.velocity,r.velocity,o),this._simulationSpace===hi.World&&(d.transformMat4(r.position,r.position,xh),d.transformQuat(r.velocity,r.velocity,wh)),d.copy(r.ultimateVelocity,r.velocity),this.startRotation3D?r.startEuler.set(this.startRotationX.evaluate(i,n),this.startRotationY.evaluate(i,n),this.startRotationZ.evaluate(i,n)):r.startEuler.set(0,0,this.startRotationZ.evaluate(i,n)),r.rotation.set(r.startEuler),this.startSize3D?d.set(r.startSize,this.startSizeX.evaluate(i,n),this.startSizeY.evaluate(i,n),this.startSizeZ.evaluate(i,n)):(d.set(r.startSize,this.startSizeX.evaluate(i,n),1,1),r.startSize.y=r.startSize.x),d.copy(r.size,r.startSize),r.startColor.set(this.startColor.evaluate(i,n)),r.color.set(r.startColor),r.startLifetime=this.startLifetime.evaluate(i,n)+e,r.remainingLifetime=r.startLifetime,r.randomSeed=E(0,233280),r.loopCount++,this.processor.setNewParticle(r)}},i._prewarmSystem=function(){this.startDelay.mode=pe.Constant,this.startDelay.constant=0;for(var t=this.duration/1,e=0;e<t;++e)this._time+=1,this._emit(1),this.processor.updateParticles(1)},i._emit=function(t){var e=this.startDelay.evaluate(0,1);if(this._time>e){if(this._time>this.duration+e&&(this.loop||(this._isEmitting=!1)),!this._isEmitting)return;if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*t,this._emitRateTimeCounter>1){var i=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=i,this.emit(i,t)}var s=this.rateOverDistance.evaluate(this._time/this.duration,1);if(s>0){d.copy(this._oldWPos,this._curWPos),this.node.getWorldPosition(this._curWPos);var r=d.distance(this._curWPos,this._oldWPos);this._emitRateDistanceCounter+=r*s}if(this._emitRateDistanceCounter>1){var n=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=n,this.emit(n,t)}for(var o,a=L(this.bursts);!(o=a()).done;)o.value.update(this,t)}},i._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),d.copy(this._curWPos,this._oldWPos)},i.addSubEmitter=function(t){this._subEmitters.push(t)},i.removeSubEmitter=function(t){this._subEmitters.splice(this._subEmitters.indexOf(t),1)},i.addBurst=function(t){this.bursts.push(t)},i.removeBurst=function(t){this.bursts.splice(this.bursts.indexOf(t),1)},i.getBoundingX=function(){return this._aabbHalfX},i.getBoundingY=function(){return this._aabbHalfY},i.getBoundingZ=function(){return this._aabbHalfZ},i.setBoundingX=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=t)},i.setBoundingY=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=t)},i.setBoundingZ=function(t){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=t,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=t)},i._onBeforeSerialize=function(t){var e=this;return this.dataCulling?t.filter((function(t){return!ai.includes(t)||e[t]&&e[t].enable})):t},i.getNoisePreview=function(t,e){var i=[];return this.processor&&this.processor.getNoisePreview(i,t,e),i},o(e,[{key:"capacity",get:function(){return this._capacity},set:function(t){this._capacity=Math.floor(t>0?t:0),this.processor&&this.processor.model&&this.processor.model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(t){!0===t&&this.loop,this._prewarm=t}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(t){t!==this._simulationSpace&&(this._simulationSpace=t,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(t){this._renderCulling=t,t&&(this._boundingBox||(this._boundingBox=new H,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(t){this._cullingMode=t}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(t){this.setBoundingX(t)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(t){this.setBoundingY(t)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(t){this.setBoundingZ(t)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(t){this._dataCulling=t}},{key:"sharedMaterials",get:function(){return Ah.get.call(this)},set:function(t){Ah.set.call(this,t)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(t){t&&(this._colorOverLifetimeModule=t)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(t){t&&(this._shapeModule=t)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(t){t&&(this._sizeOvertimeModule=t)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(t){t&&(this._velocityOvertimeModule=t)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(t){t&&(this._forceOvertimeModule=t)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(t){t&&(this._limitVelocityOvertimeModule=t)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(t){t&&(this._rotationOvertimeModule=t)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(t){t&&(this._textureAnimationModule=t)}},{key:"noiseModule",get:function(){return this._noiseModule},set:function(t){t&&(this._noiseModule=t)}},{key:"trailModule",get:function(){return this._trailModule},set:function(t){t&&(this._trailModule=t)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),e}(Et)).CullingMode=ui,yl=a((vl=nh).prototype,"startColor",[wa,_],(function(){return new He})),Ml=a(vl.prototype,"scaleSpace",[Aa,_],(function(){return hi.Local})),gl=a(vl.prototype,"startSize3D",[_],(function(){return!1})),Sl=a(vl.prototype,"startSizeX",[Ra,Oa],(function(){return new fe})),bl=a(vl.prototype,"startSizeY",[Ca,_],(function(){return new fe})),Tl=a(vl.prototype,"startSizeZ",[Ea,_],(function(){return new fe})),xl=a(vl.prototype,"startSpeed",[Fa,_],(function(){return new fe})),wl=a(vl.prototype,"startRotation3D",[_],(function(){return!1})),Al=a(vl.prototype,"startRotationX",[Da,_],(function(){return new fe})),Rl=a(vl.prototype,"startRotationY",[Pa,_],(function(){return new fe})),Ol=a(vl.prototype,"startRotationZ",[za,Ia],(function(){return new fe})),Cl=a(vl.prototype,"startDelay",[Ba,_],(function(){return new fe})),El=a(vl.prototype,"startLifetime",[La,_],(function(){return new fe})),Fl=a(vl.prototype,"duration",[_],(function(){return 5})),Dl=a(vl.prototype,"loop",[_],(function(){return!0})),l(vl.prototype,"simulationSpace",[Va,_],Object.getOwnPropertyDescriptor(vl.prototype,"simulationSpace"),vl.prototype),Pl=a(vl.prototype,"simulationSpeed",[_],(function(){return 1})),zl=a(vl.prototype,"playOnAwake",[_],(function(){return!0})),Il=a(vl.prototype,"gravityModifier",[Na,_],(function(){return new fe})),Bl=a(vl.prototype,"rateOverTime",[ka,_],(function(){return new fe})),Ll=a(vl.prototype,"rateOverDistance",[Ua,_],(function(){return new fe})),Vl=a(vl.prototype,"bursts",[Ga,_],(function(){return[]})),l(vl.prototype,"renderCulling",[Xa],Object.getOwnPropertyDescriptor(vl.prototype,"renderCulling"),vl.prototype),Nl=a(vl.prototype,"_renderCulling",[_],(function(){return!1})),l(vl.prototype,"cullingMode",[Ha],Object.getOwnPropertyDescriptor(vl.prototype,"cullingMode"),vl.prototype),kl=a(vl.prototype,"_cullingMode",[_],(function(){return ui.Pause})),l(vl.prototype,"aabbHalfX",[Wa],Object.getOwnPropertyDescriptor(vl.prototype,"aabbHalfX"),vl.prototype),Ul=a(vl.prototype,"_aabbHalfX",[_],(function(){return 0})),l(vl.prototype,"aabbHalfY",[Ya],Object.getOwnPropertyDescriptor(vl.prototype,"aabbHalfY"),vl.prototype),Gl=a(vl.prototype,"_aabbHalfY",[_],(function(){return 0})),l(vl.prototype,"aabbHalfZ",[ja],Object.getOwnPropertyDescriptor(vl.prototype,"aabbHalfZ"),vl.prototype),Xl=a(vl.prototype,"_aabbHalfZ",[_],(function(){return 0})),Hl=a(vl.prototype,"_dataCulling",[_,Za],(function(){return!1})),l(vl.prototype,"sharedMaterials",[x,_],Object.getOwnPropertyDescriptor(vl.prototype,"sharedMaterials"),vl.prototype),Wl=a(vl.prototype,"_colorOverLifetimeModule",[qa],(function(){return null})),l(vl.prototype,"colorOverLifetimeModule",[Qa],Object.getOwnPropertyDescriptor(vl.prototype,"colorOverLifetimeModule"),vl.prototype),Yl=a(vl.prototype,"_shapeModule",[Ka],(function(){return null})),l(vl.prototype,"shapeModule",[Ja],Object.getOwnPropertyDescriptor(vl.prototype,"shapeModule"),vl.prototype),jl=a(vl.prototype,"_sizeOvertimeModule",[$a],(function(){return null})),l(vl.prototype,"sizeOvertimeModule",[tl],Object.getOwnPropertyDescriptor(vl.prototype,"sizeOvertimeModule"),vl.prototype),Zl=a(vl.prototype,"_velocityOvertimeModule",[el],(function(){return null})),l(vl.prototype,"velocityOvertimeModule",[il],Object.getOwnPropertyDescriptor(vl.prototype,"velocityOvertimeModule"),vl.prototype),ql=a(vl.prototype,"_forceOvertimeModule",[sl],(function(){return null})),l(vl.prototype,"forceOvertimeModule",[rl],Object.getOwnPropertyDescriptor(vl.prototype,"forceOvertimeModule"),vl.prototype),Ql=a(vl.prototype,"_limitVelocityOvertimeModule",[nl],(function(){return null})),l(vl.prototype,"limitVelocityOvertimeModule",[ol],Object.getOwnPropertyDescriptor(vl.prototype,"limitVelocityOvertimeModule"),vl.prototype),Kl=a(vl.prototype,"_rotationOvertimeModule",[al],(function(){return null})),l(vl.prototype,"rotationOvertimeModule",[ll],Object.getOwnPropertyDescriptor(vl.prototype,"rotationOvertimeModule"),vl.prototype),Jl=a(vl.prototype,"_textureAnimationModule",[hl],(function(){return null})),l(vl.prototype,"textureAnimationModule",[ul],Object.getOwnPropertyDescriptor(vl.prototype,"textureAnimationModule"),vl.prototype),$l=a(vl.prototype,"_noiseModule",[cl],(function(){return null})),l(vl.prototype,"noiseModule",[_l],Object.getOwnPropertyDescriptor(vl.prototype,"noiseModule"),vl.prototype),th=a(vl.prototype,"_trailModule",[dl],(function(){return null})),l(vl.prototype,"trailModule",[pl],Object.getOwnPropertyDescriptor(vl.prototype,"trailModule"),vl.prototype),eh=a(vl.prototype,"renderer",[fl,_],(function(){return new oh})),ih=a(vl.prototype,"_prewarm",[_],(function(){return!1})),sh=a(vl.prototype,"_capacity",[_],(function(){return 100})),rh=a(vl.prototype,"_simulationSpace",[_],(function(){return hi.Local})),ml=vl))||ml)||ml);t({ParticleSystem:Rh,ParticleSystemComponent:Rh});var Oh=t("ParticleUtils",function(){function t(){}return t.instantiate=function(t){return this.registeredSceneEvent||(ft.on(mt.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(t._uuid)||this.particleSystemPool.set(t._uuid,new G((function(){return Pt(t)||new ct}),1,(function(t){return t.destroy()}))),this.particleSystemPool.get(t._uuid).alloc()},t.destroy=function(t){this.particleSystemPool.has(t._prefab.asset._uuid)&&(this.stop(t),this.particleSystemPool.get(t._prefab.asset._uuid).free(t))},t.play=function(t){for(var e,i=L(t.getComponentsInChildren(Rh));!(e=i()).done;)e.value.play()},t.stop=function(t){for(var e,i=L(t.getComponentsInChildren(Rh));!(e=i()).done;)e.value.stop()},t.onSceneUnload=function(){this.particleSystemPool.forEach((function(t){return t.destroy()})),this.particleSystemPool.clear()},t}());Oh.particleSystemPool=new Map,Oh.registeredSceneEvent=!1,K(un.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),J(Rh.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),n.ParticleSystemComponent=Rh,$(Rh,"cc.ParticleSystemComponent"),n.BillboardComponent=Xt,$(Xt,"cc.BillboardComponent"),n.LineComponent=je,$(je,"cc.LineComponent"),n.ParticleUtils=Oh}}}));
