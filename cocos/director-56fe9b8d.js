System.register(["./index-68ccac70.js","./find-222dc7da.js","./touch-685512cb.js","./pipeline-state-manager-8f16c5a7.js","./buffer-barrier-d1733967.js","./node-event-40319828.js"],(function(e){"use strict";var t,i,r,n,a,s,o,h,u,l,c,d,_,p,f,g,m,v,E,S,T,w,y,A,R,O,b,N,I,D,P,C,L,F,M,B,x,U,k,H,V,G,W,z,Q,j,Y,K,X,q,Z,J,$,ee,te,ie,re,ne,ae,se,oe,he,ue,le,ce,de,_e,pe,fe,ge,me,ve,Ee,Se,Te,we,ye,Ae,Re,Oe,be,Ne,Ie,De,Pe,Ce,Le,Fe,Me,Be,xe,Ue,ke,He,Ve,Ge,We,ze,Qe,je,Ye,Ke,Xe,qe,Ze,Je,$e,et,tt,it,rt,nt,at,st,ot,ht,ut,lt,ct,dt,_t,pt,ft,gt,mt,vt,Et,St,Tt,wt,yt,At,Rt,Ot,bt,Nt,It,Dt,Pt,Ct,Lt,Ft,Mt,Bt,xt,Ut,kt,Ht,Vt,Gt,Wt,zt,Qt,jt,Yt,Kt,Xt,qt,Zt,Jt,$t,ei,ti,ii,ri,ni,ai,si,oi,hi,ui,li,ci,di,_i,pi,fi,gi,mi,vi,Ei,Si,Ti,wi,yi,Ai,Ri,Oi,bi,Ni,Ii,Di,Pi,Ci,Li,Fi,Mi,Bi,xi,Ui,ki,Hi,Vi,Gi,Wi,zi,Qi,ji,Yi,Ki,Xi,qi,Zi,Ji,$i,er;return{setters:[function(e){t=e.i,i=e.o,r=e.t,n=e.y,a=e.l,s=e.E,o=e.bw,h=e.L,u=e.q,l=e.bx,c=e.N,d=e.by,_=e.d,p=e.f,f=e.bz,g=e.V,m=e.Q,v=e.B,E=e.F,S=e.bA,T=e.bB,w=e.P,y=e.bC,A=e.b,R=e.a0,O=e.aN,b=e.bD,N=e.bE,I=e.bg,D=e.bF,P=e.aD,C=e.bG,L=e.bH,F=e.ai,M=e.ab,B=e.aw,x=e.R,U=e.C,k=e.bI,H=e.aq,V=e.bo,G=e.aj,W=e.bJ,z=e.bK,Q=e.bL,j=e.aM,Y=e.bM,K=e.ag,X=e.S,q=e.ah,Z=e.as,J=e.bN,$=e.bO,ee=e.bP,te=e.bm,ie=e.bQ,re=e.bR,ne=e.bS,ae=e.bT,se=e.bl,oe=e.ar,he=e.bU,ue=e.aa,le=e.bV,ce=e.bW,de=e.bX,_e=e.a$,pe=e.a_,fe=e.bY,ge=e.aJ,me=e.g,ve=e.e,Ee=e.aP,Se=e.b0,Te=e.bZ},function(e){we=e.v,ye=e.B,Ae=e.a7,Re=e.b,Oe=e.ac,be=e.T,Ne=e.A,Ie=e.P,De=e.C,Pe=e.c,Ce=e.d,Le=e.a6,Fe=e.a3,Me=e.a2,Be=e.ad,xe=e.ae,Ue=e.af,ke=e.e,He=e.S,Ve=e.ag,Ge=e.N,We=e.V,ze=e.ah,Qe=e.ai,je=e.aj,Ye=e.ak,Ke=e.a8,Xe=e.aa,qe=e.al,Ze=e.am,Je=e.an,$e=e.a9,et=e.ao,tt=e.ap,it=e.aq,rt=e.ar,nt=e.$,at=e.w},function(e){st=e.d,ot=e.I,ht=e.a,ut=e.K,lt=e.b,ct=e.c,dt=e.T,_t=e.S,pt=e.E},function(e){ft=e.C,gt=e.d,mt=e.c,vt=e.i,Et=e.U,St=e.e,Tt=e.I,wt=e.f,yt=e.g,At=e.b,Rt=e.h,Ot=e.j,bt=e.k,Nt=e.l,It=e.m,Dt=e.n,Pt=e.o,Ct=e.p,Lt=e.s,Ft=e.q,Mt=e.r,Bt=e.t,xt=e.u,Ut=e.v,kt=e.w,Ht=e.x,Vt=e.y,Gt=e.z,Wt=e.P,zt=e.S,Qt=e.A,jt=e.B,Yt=e.E,Kt=e.F,Xt=e.G,qt=e.L,Zt=e.H},function(e){Jt=e.J,$t=e.a,ei=e.a5,ti=e.ae,ii=e.g,ri=e.h,ni=e.b,ai=e.ag,si=e.l,oi=e.m,hi=e.F,ui=e.aQ,li=e.aq,ci=e.aZ,di=e.aE,_i=e.a9,pi=e.d,fi=e.f,gi=e.ah,mi=e.aC,vi=e.T,Ei=e.s,Si=e.R,Ti=e.ai,wi=e.Z,yi=e.a4,Ai=e.L,Ri=e.t,Oi=e.B,bi=e.bh,Ni=e.bf,Ii=e.aD,Di=e.at,Pi=e.au,Ci=e.ay,Li=e.u,Fi=e.ax,Mi=e.bk,Bi=e.aB,xi=e.as,Ui=e.j,ki=e.aa,Hi=e.A,Vi=e.i},function(e){Gi=e.A,Wi=e.E,zi=e.N,Qi=e.e,ji=e.f,Yi=e.t,Ki=e.c,Xi=e.B,qi=e.h,Zi=e.i,Ji=e.k,$i=e.d,er=e.b}],execute:function(){function tr(e,i){for(var r,n=t(i);!(r=n()).done;){var a=r.value;Array.isArray(a)?tr(e,a):e.push(a)}}function ir(e){var t=[];return tr(t,e),t.join("")}var rr,nr,ar,sr,or,hr,ur,lr;e({a$:function(e,t){var i=e.readNumber();t.bindings.length=i;for(var r=0;r!==i;++r){var n=new mi;An(e,n),t.bindings[r]=n}},aD:ra,aG:function(e,t){void 0===t&&(t="default"),aa(e,t,!0)},aH:function(e,t,i){void 0===i&&(i=!1),e.update();var r=e.gpuDescriptorSet,n=t.gpuDescriptorSet,a=[];if(i)return n.gpuDescriptors=r.gpuDescriptors,n.descriptorIndices=r.descriptorIndices,a;for(var s=0;s<n.gpuDescriptors.length;s++){var o=r.gpuDescriptors[s];if(o){var h=n.gpuDescriptors[s];!h.gpuBuffer&&o.gpuBuffer?(h.gpuBuffer=o.gpuBuffer,a.push(s)):"gpuTextureView"in h&&!h.gpuTextureView?(h.gpuTextureView=o.gpuTextureView,h.gpuSampler=o.gpuSampler,a.push(s)):"gpuTexture"in h&&!h.gpuTexture&&(h.gpuTexture=o.gpuTexture,h.gpuSampler=o.gpuSampler,a.push(s))}}return a},aI:oa,aK:function(e){return a.director.root.pipeline.layoutGraph.getLayout(e).descriptorSets.get(kr.PER_PASS)},aP:function(e,i,r,n){void 0===n&&(n=!0);var a=Vn(e),s="Camera"+a,o=$n(s,e,i),h=Wn(e,e.window.width,e.window.height),u=h.width,l=h.height,c="dsForwardPassColor"+s,d="dsForwardPassDS"+s;i.containsResource(c)||(r?i.addRenderTarget(c,Un(i),u,l,Vr.PERSISTENT):i.addRenderWindow(c,ni.BGRA8,u,l,e.window),i.addDepthStencil(d,ni.DEPTH_STENCIL,u,l,Vr.MANAGED)),r?(i.updateRenderTarget(c,u,l),i.updateDepthStencil(d,u,l)):(i.updateRenderWindow(c,e.window),i.updateDepthStencil(d,u,l));var _=i.addRenderPass(u,l,"default");_.name="CameraForwardPass"+a,_.setViewport(new yi(h.x,h.y,u,l));for(var p,f=t(o.mainLightShadowNames);!(p=f()).done;){var g=p.value;i.containsResource(g)&&_.addTexture(g,"cc_shadowMap")}for(var m,v=t(o.spotLightShadowNames);!(m=v()).done;){var E=m.value;i.containsResource(E)&&_.addTexture(E,"cc_spotShadowMap")}_.addRenderTarget(c,r?Ai.CLEAR:Gn(e.clearFlag,Kr.RENDER_TARGET),Ri.STORE,new ei(e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w)),_.addDepthStencil(d,r?Ai.CLEAR:Gn(e.clearFlag,Kr.DEPTH_STENCIL),r?Ri.DISCARD:Ri.STORE,e.clearDepth,e.clearStencil,e.clearFlag),_.addQueue(Gr.RENDER_OPAQUE).addSceneOfCamera(e,new On,jr.OPAQUE_OBJECT|jr.PLANAR_SHADOW|jr.CUTOUT_OBJECT|jr.DEFAULT_LIGHTING|jr.DRAW_INSTANCING);var S=jr.TRANSPARENT_OBJECT|jr.GEOMETRY;return r||(S|=jr.UI,_.showStatistics=!0),n&&_.addQueue(Gr.RENDER_TRANSPARENT).addSceneOfCamera(e,new On,S),{rtName:c,dsName:d}},aQ:function(e,t){if(a.internal.reflectionProbeManager){var i=a.internal.reflectionProbeManager.getProbes();if(0!==i.length)for(var r=0;r<i.length;r++){var n=i[r];n.needRender&&i[r].probeType===dr.PLANAR&&Jn(e,t,n,n.realtimePlanarTexture.window,0)}}},aR:ga,aS:function(e,t){e.addCopyPass(t)},aT:function(e,t,i,r){if(ga(t)){!function(e){if(e.pipelineSceneData.isHDR&&!e.getMacroBool("CC_USE_FLOAT_OUTPUT")){var t=Ft(e.device);e.setMacroBool("CC_USE_FLOAT_OUTPUT",t),O.ENABLE_FLOAT_OUTPUT=t}}(t);var n=function(e,t,i,r){var n=t.pipelineSceneData,a=n.skin,s=n.standardSkinModel;if(!a.enabled&&s)return{rtName:i,dsName:r};if(fa||(fa=new pa),fa.ssssFov=e.fov,fa.ssssWidth=a.blurRadius,s&&s.worldBounds){var o=s.worldBounds.halfExtents;fa.boundingBox=2*Math.min(o.x,o.y,o.z)}fa.ssssScale=a.sssIntensity;var h=Vn(e),l="Camera"+h,c=t,d=Wn(e,e.window.width,e.window.height),_=d.width,p=d.height,f=new ei(0,0,0,1);e.clearFlag&Jt.COLOR&&(f.x=e.clearColor.x,f.y=e.clearColor.y,f.z=e.clearColor.z),f.w=e.clearColor.w;var g="dsSSSSBlurColor"+l,m="dsSSSSBlurDSColor"+l;t.containsResource(g)||(t.addRenderTarget(g,Un(t),_,p,Vr.MANAGED),t.addRenderTarget(m,ni.RGBA8,_,p,Vr.MANAGED)),t.updateRenderTarget(g,_,p),t.updateRenderTarget(m,_,p);var v=t.addRenderPass(_,p,"copy-pass");if(v.name="CameraCopyDSPass"+h,v.setViewport(new yi(d.x,d.y,_,p)),t.containsResource(r)){var E=c.resourceGraph.vertex(r),S=c.resourceGraph.getSampler(E);S.minFilter=si.POINT,S.magFilter=si.POINT,S.mipFilter=si.NONE,v.addTexture(r,"depthRaw")}v.addRenderTarget(m,Ai.CLEAR,Ri.STORE,new ei(1,0,0,0)),v.addQueue(Gr.RENDER_OPAQUE|Gr.RENDER_TRANSPARENT).addCameraQuad(e,fa.ssssBlurMaterial,0,jr.NONE);var T=t.addRenderPass(_,p,"ssss-blurX");if(T.name="CameraSSSSBlurXPass"+h,T.setViewport(new yi(d.x,d.y,_,p)),t.containsResource(i)){var w=c.resourceGraph.vertex(i),y=c.resourceGraph.getSampler(w);y.minFilter=si.POINT,y.magFilter=si.POINT,y.mipFilter=si.NONE,T.addTexture(i,"colorTex")}if(t.containsResource(m)){var A=c.resourceGraph.vertex(m),R=c.resourceGraph.getSampler(A);R.minFilter=si.POINT,R.magFilter=si.POINT,R.mipFilter=si.NONE,T.addTexture(m,"depthTex")}T.addRenderTarget(g,Ai.CLEAR,Ri.STORE,f),T.addDepthStencil(r,Ai.LOAD,Ri.STORE,e.clearDepth,e.clearStencil,e.clearFlag),fa.ssssBlurMaterial.setProperty("blurInfo",new u(fa.ssssFov,fa.ssssWidth,fa.boundingBox,fa.ssssScale),1),fa.ssssBlurMaterial.setProperty("kernel",fa.kernel,1),T.addQueue(Gr.RENDER_OPAQUE|Gr.RENDER_TRANSPARENT).addCameraQuad(e,fa.ssssBlurMaterial,1,jr.NONE);var O=t.addRenderPass(_,p,"ssss-blurY");if(O.name="CameraSSSSBlurYPass"+h,O.setViewport(new yi(d.x,d.y,_,p)),t.containsResource(g)){var b=c.resourceGraph.vertex(g),N=c.resourceGraph.getSampler(b);N.minFilter=si.POINT,N.magFilter=si.POINT,N.mipFilter=si.NONE,O.addTexture(g,"colorTex")}if(t.containsResource(m)){var I=c.resourceGraph.vertex(m),D=c.resourceGraph.getSampler(I);D.minFilter=si.POINT,D.magFilter=si.POINT,D.mipFilter=si.NONE,O.addTexture(m,"depthTex")}return O.addRenderTarget(i,Ai.LOAD,Ri.STORE,f),O.addDepthStencil(r,Ai.LOAD,Ri.STORE,e.clearDepth,e.clearStencil,e.clearFlag),fa.ssssBlurMaterial.setProperty("blurInfo",new u(fa.ssssFov,fa.ssssWidth,fa.boundingBox,fa.ssssScale),2),fa.ssssBlurMaterial.setProperty("kernel",fa.kernel,2),O.addQueue(Gr.RENDER_OPAQUE|Gr.RENDER_TRANSPARENT).addCameraQuad(e,fa.ssssBlurMaterial,2,jr.NONE),{rtName:i,dsName:r}}(e,t,i,r),a=Ea(e,t,n.rtName,n.dsName);return{rtName:a.rtName,dsName:a.dsName}}var s=Ea(e,t,i,r);return{rtName:s.rtName,dsName:s.dsName}},aU:function(e,i,r,n,a){if(a)return{rtName:r,dsName:n};var s=Vn(e),o=$n("Camera"+s,e,i),h=Wn(e,e.window.width,e.window.height),u=h.width,l=h.height,c=i.addRenderPass(u,l,"default");c.name="CameraAlphaPass"+s,c.setViewport(new yi(h.x,h.y,u,l));for(var d,_=t(o.mainLightShadowNames);!(d=_()).done;){var p=d.value;i.containsResource(p)&&c.addTexture(p,"cc_shadowMap")}for(var f,g=t(o.spotLightShadowNames);!(f=g()).done;){var m=f.value;i.containsResource(m)&&c.addTexture(m,"cc_spotShadowMap")}return c.addRenderTarget(r,Ai.LOAD,Ri.STORE,new ei(e.clearDepth,e.clearStencil,0,0)),c.addDepthStencil(n,Ai.LOAD,Ri.STORE,e.clearDepth,e.clearStencil,e.clearFlag),c.addQueue(Gr.RENDER_TRANSPARENT).addSceneOfCamera(e,new On,jr.TRANSPARENT_OBJECT|jr.GEOMETRY),{rtName:r,dsName:n}},aV:function(e,t,i,r,n,s,o,h,l,c){void 0===n&&(n=1),void 0===s&&(s=10),void 0===o&&(o=3),void 0===h&&(h=1),void 0===l&&(l=1),void 0===c&&(c=!0);var d=Wn(e,e.window.width,e.window.height),_=d.width,p=d.height;Ta||(Ta=new Sa);var f=e.nearClip;Ta.depthTexFullResolution=wa.set(_,p),Ta.depthTexResolution=wa.set(_,p),Ta.sceneScale=f,Ta.cameraFov=e.fov,Ta.radiusScale=n,Ta.angleBiasDegree=s,Ta.aoStrength=l,Ta.blurSharpness=o,Ta.aoSaturation=h,Ta.update();var g=a.director.root;if(g.debugView&&g.debugView.isEnabled()&&(g.debugView.singleMode!==Ln.NONE&&g.debugView.singleMode!==Ln.AO||!g.debugView.isCompositeModeEnabled(Fn.AO)))return{rtName:i,dsName:r};var m=function(e,t,i,r){if(!Ta)return{rtName:i,dsName:r};var n=Vn(e),a=Wn(e,e.window.width,e.window.height),s=a.width,o=a.height,h=new ei(0,0,0,e.clearColor.w),l="hbaoRTName"+n;t.containsResource(l)||t.addRenderTarget(l,ni.BGRA8,s,o,Vr.MANAGED),t.updateRenderTarget(l,s,o);var c=t.addRenderPass(s,o,"hbao-pass");if(c.name="CameraHBAOPass"+n,c.setViewport(new yi(a.x,a.y,a.width,a.height)),t.containsResource(r)){var d=t,_=d.resourceGraph.vertex(r),p=d.resourceGraph.getSampler(_);p.minFilter=p.magFilter=si.POINT,p.mipFilter=si.NONE,p.addressU=p.addressV=oi.CLAMP,c.addTexture(r,"DepthTex")}c.addRenderTarget(l,Ai.LOAD,Ri.STORE,h);return Ta.hbaoMaterial.setProperty("uvDepthToEyePosParams",Ta.uvDepthToEyePosParams,0),Ta.hbaoMaterial.setProperty("radiusParam",Ta.radiusParam,0),Ta.hbaoMaterial.setProperty("miscParam",Ta.miscParam,0),Ta.hbaoMaterial.setProperty("randomTexSize",new u(Ta.randomTexture.width,Ta.randomTexture.height,1/Ta.randomTexture.width,1/Ta.randomTexture.height),0),Ta.hbaoMaterial.setProperty("blurParam",Ta.blurParam,0),c.addQueue(Gr.RENDER_TRANSPARENT|Gr.RENDER_OPAQUE).addCameraQuad(e,Ta.hbaoMaterial,0,jr.NONE),{rtName:l,dsName:r}}(e,t,i,r),v=m.rtName;if(c){var E=ya(e,t,m.rtName,r,!1);v=ya(e,t,E.rtName,r,!0).rtName}return{rtName:Aa(e,t,v,r,i).rtName,dsName:r}},aW:function(e,t,i,r){if(!t.pipelineSceneData.isHDR||!t.getMacroBool("CC_USE_FLOAT_OUTPUT"))return{rtName:i,dsName:r};va||(va=new ma);var n=Vn(e),a=Wn(e,e.window.width,e.window.height),s=a.width,o=a.height,h=new ei(0,0,0,e.clearColor.w);e.clearFlag&Jt.COLOR&&(h.x=e.clearColor.x,h.y=e.clearColor.y,h.z=e.clearColor.z);var u="toneMappingPassRTName"+n,l="toneMappingPassDS"+n;t.containsResource(u)||(t.addRenderTarget(u,ni.RGBA8,s,o,Vr.MANAGED),t.addDepthStencil(l,ni.DEPTH_STENCIL,s,o,Vr.MANAGED)),t.updateRenderTarget(u,s,o),t.updateDepthStencil(l,s,o);var c=t.addRenderPass(s,o,"tone-mapping");return c.name="CameraToneMappingPass"+n,c.setViewport(new yi(a.x,a.y,a.width,a.height)),t.containsResource(i)&&c.addTexture(i,"u_texSampler"),c.addRenderTarget(u,Gn(e.clearFlag,Kr.RENDER_TARGET),Ri.STORE,h),c.addDepthStencil(l,Gn(e.clearFlag,Kr.DEPTH_STENCIL),Ri.STORE,e.clearDepth,e.clearStencil,e.clearFlag),c.addQueue(Gr.NONE).addFullscreenQuad(va.toneMappingMaterial,0,jr.NONE),c.addQueue(Gr.RENDER_TRANSPARENT).addSceneOfCamera(e,new On,jr.UI),Be()===e&&(c.showStatistics=!0),{rtName:u,dsName:l}},aX:function(e,t,i,r){Yn||(Yn=new jn);var n=Vn(e),a="Camera"+n,s=e.window.width,o=e.window.height,h=Wn(e,s,o);s=h.width,o=h.height;var l=new ei(0,0,0,1);e.clearFlag&Jt.COLOR&&(l.x=e.clearColor.x,l.y=e.clearColor.y,l.z=e.clearColor.z),l.w=e.clearColor.w;var c="dsFxaaPassColor"+a;t.containsResource(c)||t.addRenderTarget(c,ni.RGBA8,s,o,Vr.MANAGED),t.updateRenderTarget(c,s,o);var d=t.addRenderPass(s,o,"fxaa");return d.name="CameraFxaaPass"+n,d.setViewport(new yi(h.x,h.y,s,o)),t.containsResource(i)&&d.addTexture(i,"sceneColorMap"),d.addRenderTarget(c,Ai.CLEAR,Ri.STORE,l),Yn.fxaaMaterial.setProperty("texSize",new u(s,o,1/s,1/o),0),d.addQueue(Gr.RENDER_TRANSPARENT).addCameraQuad(e,Yn.fxaaMaterial,0,jr.NONE),{rtName:c,dsName:r}},aY:function(e,t,i,r,n,a){void 0===r&&(r=.6),void 0===n&&(n=2),void 0===a&&(a=2),Xn||(Xn=new Kn),Xn.threshold=r,Xn.iterations=n,Xn.intensity=a;var s=Vn(e),o="Camera"+s,h=e.window.width,l=e.window.height,c=Wn(e,h,l);h=c.width,l=c.height;var d=new ei(0,0,0,1);e.clearFlag&Jt.COLOR&&(d.x=e.clearColor.x,d.y=e.clearColor.y,d.z=e.clearColor.z),d.w=e.clearColor.w;var _="dsBloomPassPrefilterColor"+o,p="dsBloomPassPrefilterDS"+o;h>>=1,l>>=1,t.containsResource(_)||(t.addRenderTarget(_,ni.RGBA8,h,l,Vr.MANAGED),t.addDepthStencil(p,ni.DEPTH_STENCIL,h,l,Vr.MANAGED)),t.updateRenderTarget(_,h,l),t.updateDepthStencil(p,h,l);var f=t.addRenderPass(h,l,"bloom-prefilter");f.name="CameraBloomPrefilterPass"+s,f.setViewport(new yi(c.x,c.y,h,l)),t.containsResource(i)&&f.addTexture(i,"outputResultMap"),f.addRenderTarget(_,Ai.CLEAR,Ri.STORE,d),Xn.bloomMaterial.setProperty("texSize",new u(0,0,Xn.threshold,0),0),f.addQueue(Gr.RENDER_TRANSPARENT).addCameraQuad(e,Xn.bloomMaterial,0,jr.NONE);for(var g=0;g<Xn.iterations;++g){var m=new u(h,l,0,0),v="dsBloomPassDownSampleColor"+o+g,E="dsBloomPassDownSampleDS"+o+g;h>>=1,l>>=1,t.containsResource(v)||(t.addRenderTarget(v,ni.RGBA8,h,l,Vr.MANAGED),t.addDepthStencil(E,ni.DEPTH_STENCIL,h,l,Vr.MANAGED)),t.updateRenderTarget(v,h,l),t.updateDepthStencil(E,h,l);var S=t.addRenderPass(h,l,"bloom-downsample"+g);S.name="CameraBloomDownSamplePass"+s+g,S.setViewport(new yi(c.x,c.y,h,l)),0===g?S.addTexture(_,"bloomTexture"):S.addTexture("dsBloomPassDownSampleColor"+o+(g-1),"bloomTexture"),S.addRenderTarget(v,Ai.CLEAR,Ri.STORE,d),Xn.bloomMaterial.setProperty("texSize",m,1+g),S.addQueue(Gr.RENDER_TRANSPARENT).addCameraQuad(e,Xn.bloomMaterial,1+g,jr.NONE)}for(var T=0;T<Xn.iterations;++T){var w=new u(h,l,0,0),y="dsBloomPassUpSampleColor"+o+(Xn.iterations-1-T),A="dsBloomPassUpSampleDS"+o+(Xn.iterations-1-T);h<<=1,l<<=1,t.containsResource(y)||(t.addRenderTarget(y,ni.RGBA8,h,l,Vr.MANAGED),t.addDepthStencil(A,ni.DEPTH_STENCIL,h,l,Vr.MANAGED)),t.updateRenderTarget(y,h,l),t.updateDepthStencil(A,h,l);var R=t.addRenderPass(h,l,"bloom-upsample"+T);R.name="CameraBloomUpSamplePass"+s+(Xn.iterations-1-T),R.setViewport(new yi(c.x,c.y,h,l)),0===T?R.addTexture("dsBloomPassDownSampleColor"+o+(Xn.iterations-1),"bloomTexture"):R.addTexture("dsBloomPassUpSampleColor"+o+(Xn.iterations-T),"bloomTexture"),R.addRenderTarget(y,Ai.CLEAR,Ri.STORE,d),Xn.bloomMaterial.setProperty("texSize",w,7+T),R.addQueue(Gr.RENDER_TRANSPARENT).addCameraQuad(e,Xn.bloomMaterial,7+T,jr.NONE)}var O="dsBloomPassCombineColor"+o,b="dsBloomPassCombineDS"+o;h=c.width,l=c.height,t.containsResource(O)||(t.addRenderTarget(O,ni.RGBA8,h,l,Vr.MANAGED),t.addDepthStencil(b,ni.DEPTH_STENCIL,h,l,Vr.MANAGED)),t.updateRenderTarget(O,h,l),t.updateDepthStencil(b,h,l);var N=t.addRenderPass(h,l,"bloom-combine");return N.name="CameraBloomCombinePass"+s,N.setViewport(new yi(c.x,c.y,h,l)),N.addTexture(i,"outputResultMap"),N.addTexture("dsBloomPassUpSampleColor"+o+0,"bloomTexture"),N.addRenderTarget(O,Ai.CLEAR,Ri.STORE,d),Xn.bloomMaterial.setProperty("texSize",new u(0,0,0,Xn.intensity),13),N.addQueue(Gr.RENDER_TRANSPARENT).addCameraQuad(e,Xn.bloomMaterial,13,jr.NONE),{rtName:O,dsName:b}},aZ:function(e,t,i){zn||(zn=new qn);var r=Vn(e),n=Wn(e,e.window.width,e.window.height),a=n.width,s=n.height,o="postprocessPassRTName"+r,h="postprocessPassDS"+r;t.containsResource(o)||(t.addRenderWindow(o,ni.BGRA8,a,s,e.window),t.addDepthStencil(h,ni.DEPTH_STENCIL,a,s,Vr.MANAGED)),t.updateRenderWindow(o,e.window),t.updateDepthStencil(h,a,s);var u=t.addRenderPass(a,s,"post-process");u.name="CameraPostprocessPass"+r,u.setViewport(new yi(n.x,n.y,n.width,n.height)),t.containsResource(i)&&u.addTexture(i,"outputResultMap");var l=new ei(0,0,0,e.clearColor.w);return e.clearFlag&Jt.COLOR&&(l.x=e.clearColor.x,l.y=e.clearColor.y,l.z=e.clearColor.z),u.addRenderTarget(o,Gn(e.clearFlag,Kr.RENDER_TARGET),Ri.STORE,l),u.addDepthStencil(h,Gn(e.clearFlag,Kr.DEPTH_STENCIL),Ri.STORE,e.clearDepth,e.clearStencil,e.clearFlag),u.addQueue(Gr.NONE).addFullscreenQuad(zn.postMaterial,0,jr.NONE),Be()===e&&(u.showStatistics=!0),{rtName:o,dsName:h}},a_:function(e,t){var i=Vn(e),r="Camera"+i,n=Wn(e,e.window.width,e.window.height),a=n.width,s=n.height,o="dsUIAndProfilerPassColor"+r,h="dsUIAndProfilerPassDS"+r;t.containsResource(o)||(t.addRenderWindow(o,ni.BGRA8,a,s,e.window),t.addDepthStencil(h,ni.DEPTH_STENCIL,a,s,Vr.MANAGED)),t.updateRenderWindow(o,e.window),t.updateDepthStencil(h,a,s);var u=t.addRenderPass(a,s,"default");u.name="CameraUIAndProfilerPass"+i,u.setViewport(new yi(n.x,n.y,a,s)),u.addRenderTarget(o,Gn(e.clearFlag,Kr.RENDER_TARGET),Ri.STORE,new ei(e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w)),u.addDepthStencil(h,Gn(e.clearFlag,Kr.DEPTH_STENCIL),Ri.STORE,e.clearDepth,e.clearStencil,e.clearFlag);var l=jr.UI;u.addQueue(Gr.RENDER_TRANSPARENT).addSceneOfCamera(e,new On,l),Be()===e&&(u.showStatistics=!0)},ae:Wn,af:Un,ak:Gn,ao:Vn,ar:kn,as:function(e,i){!function(e,i){kn(i,e);var r=i.pipelineSceneData,n=80*R(Math.max(r.validPunctualLights.length,1)),a=Vn(e),s="clusterLightBuffer"+a,o="globalIndexBuffer"+a,h=i;h.containsResource(o)||h.addStorageBuffer(o,ni.UNKNOWN,4,Vr.PERSISTENT),h.containsResource(s)||h.addStorageBuffer(s,ni.UNKNOWN,n,Vr.PERSISTENT),h.updateStorageBuffer(s,n);var u=function(e,i,r,n){for(var a,s=new ArrayBuffer(e),o=new Float32Array(s),h=n.pipelineSceneData,u=r.exposure,l=0,c=t(h.validPunctualLights);!(a=c()).done;){var d=a.value,_=20*l,p=_+0,f=_+4,g=_+8,m=_+12,v=_+16,E=0,S=0,T=void 0;if(d.type===Lr.POINT){var w=d;T=w.position,S=w.luminanceLDR,E=w.luminanceHDR,o[g]=0,o[g+1]=w.range,o[g+2]=0,o[g+3]=0}else if(d.type===Lr.SPHERE){var y=d;T=y.position,S=y.luminanceLDR,E=y.luminanceHDR,o[g]=y.size,o[g+1]=y.range,o[g+2]=0,o[g+3]=0}else if(d.type===Lr.SPOT){var A=d;T=A.position,S=A.luminanceLDR,E=A.luminanceHDR,o[g]=A.size,o[g+1]=A.range,o[g+2]=A.spotAngle,o[g+3]=0;var R=A.direction;o[m]=R.x,o[m+1]=R.y,o[m+2]=R.z,o[m+3]=0}else if(d.type===Lr.RANGED_DIRECTIONAL){var O=d;T=O.position,S=O.illuminanceLDR,E=O.illuminanceHDR;var b=O.right;o[g]=b.x,o[g+1]=b.y,o[g+2]=b.z,o[g+3]=0;var N=O.direction;o[m]=N.x,o[m+1]=N.y,o[m+2]=N.z,o[m+3]=0;var I=O.scale;o[v]=.5*I.x,o[v+1]=.5*I.y,o[v+2]=.5*I.z,o[v+3]=0}o[p]=T.x,o[p+1]=T.y,o[p+2]=T.z,o[p+3]=d.type;var D=d.color;if(d.useColorTemperature){var P=d.colorTemperatureRGB;o[f]=D.x*P.x,o[f+1]=D.y*P.y,o[f+2]=D.z*P.z}else o[f]=D.x,o[f+1]=D.y,o[f+2]=D.z;o[f+3]=h.isHDR?E*u*1e4:S,l++}return o[15]=h.validPunctualLights.length,s}(n,0,e,i),l=new ArrayBuffer(4);new Uint32Array(l)[0]=0;var c=new In(new Uint8Array(u),s),d=new In(new Uint8Array(l),o);h.addUploadPass([c,d])}(e,i);var r=i;La||(La=new Ca),function(e,t,i){var r="clusterBuffer"+Vn(e);i.containsResource(r)||i.addStorageBuffer(r,ni.UNKNOWN,98304,Vr.MANAGED),i.updateStorageBuffer(r,98304);var n=i.addComputePass("cluster-build-cs");n.addStorageBuffer(r,Xr.WRITE,"b_clustersBuffer"),n.addQueue().addDispatch(t.dispatchX,t.dispatchY,t.dispatchZ,t.clusterBuildCS,0);var a=e.width*i.pipelineSceneData.shadingScale,s=e.height*i.pipelineSceneData.shadingScale;n.setVec4("cc_nearFar",new u(e.nearClip,e.farClip,e.getClipSpaceMinz(),0)),n.setVec4("cc_viewPort",new u(0,0,a,s)),n.setVec4("cc_workGroup",new u(16,8,24,0)),n.setMat4("cc_matView",e.matView),n.setMat4("cc_matProjInv",e.matProjInv)}(e,La,r),function(e,t,i){var r=Vn(e),n="clusterBuffer"+r,a="clusterLightBuffer"+r,s="globalIndexBuffer"+r,o="clusterLightIndicesBuffer"+r,h="clusterLightGridBuffer"+r;i.containsResource(o)||i.addStorageBuffer(o,ni.UNKNOWN,1228800,Vr.MANAGED),i.containsResource(h)||i.addStorageBuffer(h,ni.UNKNOWN,49152,Vr.MANAGED);var l=i.addComputePass("cluster-culling-cs");l.addStorageBuffer(a,Xr.READ,"b_ccLightsBuffer"),l.addStorageBuffer(n,Xr.READ,"b_clustersBuffer"),l.addStorageBuffer(o,Xr.WRITE,"b_clusterLightIndicesBuffer"),l.addStorageBuffer(h,Xr.WRITE,"b_clusterLightGridBuffer"),l.addStorageBuffer(s,Xr.WRITE,"b_globalIndexBuffer"),l.addQueue().addDispatch(t.dispatchX,t.dispatchY,t.dispatchZ,t.clusterLightCullingCS,0);var c=e.width*i.pipelineSceneData.shadingScale,d=e.height*i.pipelineSceneData.shadingScale;l.setVec4("cc_nearFar",new u(e.nearClip,e.farClip,e.getClipSpaceMinz(),0)),l.setVec4("cc_viewPort",new u(c,d,c,d)),l.setVec4("cc_workGroup",new u(Da,8,Pa,0)),l.setMat4("cc_matView",e.matView),l.setMat4("cc_matProjInv",e.matProjInv)}(e,La,r)},b1:yn,b2:function(e){switch(e){case kr.PER_INSTANCE:return"PER_INSTANCE";case kr.PER_BATCH:return"PER_BATCH";case kr.PER_PHASE:return"PER_PHASE";case kr.PER_PASS:return"PER_PASS";case kr.COUNT:return"COUNT";default:return""}},b3:function(e){switch(e){case Rn.UNIFORM_BUFFER:return"UNIFORM_BUFFER";case Rn.DYNAMIC_UNIFORM_BUFFER:return"DYNAMIC_UNIFORM_BUFFER";case Rn.SAMPLER_TEXTURE:return"SAMPLER_TEXTURE";case Rn.SAMPLER:return"SAMPLER";case Rn.TEXTURE:return"TEXTURE";case Rn.STORAGE_BUFFER:return"STORAGE_BUFFER";case Rn.DYNAMIC_STORAGE_BUFFER:return"DYNAMIC_STORAGE_BUFFER";case Rn.STORAGE_IMAGE:return"STORAGE_IMAGE";case Rn.INPUT_ATTACHMENT:return"INPUT_ATTACHMENT";default:return""}},b6:function(e,t){void 0===t&&(t="default"),aa(e,t)},bA:function(e,i){e.writeNumber(i.descriptorNames.length);for(var r,n=t(i.descriptorNames);!(r=n()).done;){var a=r.value;e.writeString(a)}e.writeNumber(i.uniformBlockNames.length);for(var s,o=t(i.uniformBlockNames);!(s=o()).done;){var h=s.value;e.writeString(h)}e.writeNumber(i.descriptors.length);for(var u,l=t(i.descriptors);!(u=l()).done;){Dn(e,u.value)}e.writeNumber(i.uniformBlocks.length);for(var c,d=t(i.uniformBlocks);!(c=d()).done;){wn(e,c.value)}e.writeNumber(i.capacity),e.writeNumber(i.count)},bB:function(e,t){var i=0;i=e.readNumber(),t.descriptorNames.length=i;for(var r=0;r!==i;++r)t.descriptorNames[r]=e.readString();i=e.readNumber(),t.uniformBlockNames.length=i;for(var n=0;n!==i;++n)t.uniformBlockNames[n]=e.readString();i=e.readNumber(),t.descriptors.length=i;for(var a=0;a!==i;++a){var s=new Nn;Pn(e,s),t.descriptors[a]=s}i=e.readNumber(),t.uniformBlocks.length=i;for(var o=0;o!==i;++o){var h=new Ti;yn(e,h),t.uniformBlocks[o]=h}t.capacity=e.readNumber(),t.count=e.readNumber()},bC:function(e,t){e.writeNumber(t.updateFrequency),e.writeNumber(t.parameterType),e.writeNumber(t.descriptorType),e.writeNumber(t.visibility)},bD:function(e,t){t.updateFrequency=e.readNumber(),t.parameterType=e.readNumber(),t.descriptorType=e.readNumber(),t.visibility=e.readNumber()},bE:function(e,t){e.writeString(t.source),e.writeString(t.target),e.writeNumber(t.resolveFlags),e.writeNumber(t.mode),e.writeNumber(t.mode1)},bF:function(e,t){t.source=e.readString(),t.target=e.readString(),t.resolveFlags=e.readNumber(),t.mode=e.readNumber(),t.mode1=e.readNumber()},bG:function(e,t){e.writeString(t.source),e.writeString(t.target),e.writeNumber(t.mipLevels),e.writeNumber(t.numSlices),e.writeNumber(t.sourceMostDetailedMip),e.writeNumber(t.sourceFirstSlice),e.writeNumber(t.sourcePlaneSlice),e.writeNumber(t.targetMostDetailedMip),e.writeNumber(t.targetFirstSlice),e.writeNumber(t.targetPlaneSlice)},bH:function(e,t){t.source=e.readString(),t.target=e.readString(),t.mipLevels=e.readNumber(),t.numSlices=e.readNumber(),t.sourceMostDetailedMip=e.readNumber(),t.sourceFirstSlice=e.readNumber(),t.sourcePlaneSlice=e.readNumber(),t.targetMostDetailedMip=e.readNumber(),t.targetFirstSlice=e.readNumber(),t.targetPlaneSlice=e.readNumber()},bI:function(e,t){e.writeString(t.source),e.writeString(t.target),e.writeNumber(t.mipLevels),e.writeNumber(t.numSlices),e.writeNumber(t.targetMostDetailedMip),e.writeNumber(t.targetFirstSlice),e.writeNumber(t.targetPlaneSlice)},bJ:function(e,t){t.source=e.readString(),t.target=e.readString(),t.mipLevels=e.readNumber(),t.numSlices=e.readNumber(),t.targetMostDetailedMip=e.readNumber(),t.targetFirstSlice=e.readNumber(),t.targetPlaneSlice=e.readNumber()},bK:function(e,t){e.writeNumber(t.numRenderPasses),e.writeNumber(t.numManagedTextures),e.writeNumber(t.totalManagedTextures),e.writeNumber(t.numUploadBuffers),e.writeNumber(t.numUploadBufferViews),e.writeNumber(t.numFreeUploadBuffers),e.writeNumber(t.numFreeUploadBufferViews),e.writeNumber(t.numDescriptorSets),e.writeNumber(t.numFreeDescriptorSets),e.writeNumber(t.numInstancingBuffers),e.writeNumber(t.numInstancingUniformBlocks)},bL:function(e,t){t.numRenderPasses=e.readNumber(),t.numManagedTextures=e.readNumber(),t.totalManagedTextures=e.readNumber(),t.numUploadBuffers=e.readNumber(),t.numUploadBufferViews=e.readNumber(),t.numFreeUploadBuffers=e.readNumber(),t.numFreeUploadBufferViews=e.readNumber(),t.numDescriptorSets=e.readNumber(),t.numFreeDescriptorSets=e.readNumber(),t.numInstancingBuffers=e.readNumber(),t.numInstancingUniformBlocks=e.readNumber()},bb:$n,bd:function(e){switch(e){case Hr.CONSTANTS:return"CONSTANTS";case Hr.CBV:return"CBV";case Hr.UAV:return"UAV";case Hr.SRV:return"SRV";case Hr.TABLE:return"TABLE";case Hr.SSV:return"SSV";default:return""}},be:function(e){switch(e){case Vr.MANAGED:return"MANAGED";case Vr.MEMORYLESS:return"MEMORYLESS";case Vr.PERSISTENT:return"PERSISTENT";case Vr.EXTERNAL:return"EXTERNAL";case Vr.BACKBUFFER:return"BACKBUFFER";default:return""}},bf:function(e){switch(e){case Gr.NONE:return"NONE";case Gr.OPAQUE:return"OPAQUE";case Gr.MASK:return"MASK";case Gr.BLEND:return"BLEND";default:return""}},bg:function(e){switch(e){case Wr.BUFFER:return"BUFFER";case Wr.TEXTURE1D:return"TEXTURE1D";case Wr.TEXTURE2D:return"TEXTURE2D";case Wr.TEXTURE3D:return"TEXTURE3D";default:return""}},bh:function(e){switch(e){case Qr.SYNC:return"SYNC";case Qr.ASYNC:return"ASYNC";default:return""}},bi:function(e){switch(e){case Yr.NONE:return"NONE";case Yr.DEFAULT:return"DEFAULT";case Yr.CLUSTERED:return"CLUSTERED";default:return""}},bj:function(e){switch(e){case Kr.RENDER_TARGET:return"RENDER_TARGET";case Kr.DEPTH_STENCIL:return"DEPTH_STENCIL";case Kr.SHADING_RATE:return"SHADING_RATE";default:return""}},bk:function(e){switch(e){case Xr.READ:return"READ";case Xr.READ_WRITE:return"READ_WRITE";case Xr.WRITE:return"WRITE";default:return""}},bl:function(e){switch(e){case qr.NONE:return"NONE";case qr.FLOAT_TYPE:return"FLOAT_TYPE";case qr.INT_TYPE:return"INT_TYPE";default:return""}},bu:function(e,t){e.writeNumber(t.level)},bv:function(e,t){t.level=e.readNumber()},bw:Dn,bx:Pn,by:function(e,i){e.writeNumber(i.descriptors.size);for(var r,n=t(i.descriptors);!(r=n()).done;){var a=r.value,s=a[0],o=a[1];e.writeString(s),Dn(e,o)}e.writeNumber(i.uniformBlocks.size);for(var h,u=t(i.uniformBlocks);!(h=u()).done;){var l=h.value,c=l[0],d=l[1];e.writeString(c),wn(e,d)}e.writeNumber(i.capacity),e.writeNumber(i.count)},bz:function(e,t){var i=0;i=e.readNumber();for(var r=0;r!==i;++r){var n=e.readString(),a=new Nn;Pn(e,a),t.descriptors.set(n,a)}i=e.readNumber();for(var s=0;s!==i;++s){var o=e.readString(),h=new Ti;yn(e,h),t.uniformBlocks.set(o,h)}t.capacity=e.readNumber(),t.count=e.readNumber()},k:Ur,w:ir,x:Cl}),e("C",rr),function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(rr||e("C",rr={})),e("a",nr),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(nr||e("a",nr={})),e("b",ar),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(ar||e("b",ar={})),e("c",sr),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(sr||e("c",sr={})),e("d",or),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(or||e("d",or={})),e("e",hr),function(e){e[e.DEFAULT=-1]="DEFAULT",e[e.LEFT_EYE=0]="LEFT_EYE",e[e.RIGHT_EYE=1]="RIGHT_EYE",e[e.MAIN=2]="MAIN"}(hr||e("e",hr={})),e("T",ur),function(e){e[e.NO_TRACKING=0]="NO_TRACKING",e[e.POSITION_AND_ROTATION=1]="POSITION_AND_ROTATION",e[e.POSITION=2]="POSITION",e[e.ROTATION=3]="ROTATION"}(ur||e("T",ur={})),e("f",lr),function(e){e[e.EDITOR=0]="EDITOR",e[e.GAME_VIEW=1]="GAME_VIEW",e[e.SCENE_VIEW=2]="SCENE_VIEW",e[e.PREVIEW=3]="PREVIEW",e[e.GAME=100]="GAME"}(lr||e("f",lr={}));var cr,dr,_r=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],pr=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],fr=[100,200,400,800],gr=new i,mr=new i,vr=new r,Er=e("S",Jt.STENCIL<<1),Sr=[],Tr=e("g",function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this.postProcess=null,this.usePostProcess=!1,this.pipeline="",this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=rr.VERTICAL,this._fov=c(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new ei(.2,.2,.2,1),this._viewport=new n(0,0,1,1),this._orientedViewport=new n(0,0,1,1),this._curTransform=$t.IDENTITY,this._isProjDirty=!0,this._matView=new r,this._matProj=new r,this._matProjInv=new r,this._matViewProj=new r,this._matViewProjInv=new r,this._frustum=new d,this._forward=new i,this._position=new i,this._priority=0,this._aperture=ar.F16_0,this._apertureValue=void 0,this._shutter=or.D125,this._shutterValue=0,this._iso=sr.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Jt.NONE,this._clearDepth=1,this._visibility=ft,this._exposure=0,this._clearStencil=0,this._geometryRenderer=null,this._windowId=0,this._cameraType=hr.DEFAULT,this._trackingType=ur.NO_TRACKING,this._usage=lr.GAME,this._device=e,this._apertureValue=_r[this._aperture],this._shutterValue=pr[this._shutter],this._isoValue=fr[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!Sr.length){var t=e.capabilities.clipSpaceSignY;Sr[$t.IDENTITY]=new r(1,0,0,0,0,t),Sr[$t.ROTATE_90]=new r(0,1,0,0,-t,0),Sr[$t.ROTATE_180]=new r(-1,0,0,0,0,-t),Sr[$t.ROTATE_270]=new r(0,-1,0,0,t,0)}}var t=e.prototype;return t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||$t.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t.initialize=function(e){void 0!==e.usage?this._usage=e.usage:this.setDefaultUsage(),void 0!==e.trackingType&&(this._trackingType=e.trackingType),void 0!==e.cameraType&&(this._cameraType=e.cameraType),this.node=e.node,this._width=1,this._height=1,this.clearFlag=Jt.NONE,this.clearDepth=1,this.visibility=ft,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t.destroy=function(){var e;this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,null===(e=this._geometryRenderer)||void 0===e||e.destroy()},t.attachToScene=function(e){this._enabled=!0,this._scene=e},t.detachFromScene=function(){this._enabled=!1,this._scene=null},t.resize=function(e,t){this._window&&(this._width=e,this._height=t,this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0)},t.setFixedSize=function(e,t){this._width=e,this._height=t,this._updateAspect(),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var i=!1,a=globalThis.__globalXR;if(a&&a.isWebXR&&a.webXRWindowMap&&a.updateViewport){var s=a.webXRMatProjs?1/a.webXRMatProjs.length:1,o=a.webXRWindowMap.get(this._window);this.setViewportInOrientedSpace(new n(s*o,0,s,1))}(this._node.hasChangedFlags||e)&&(r.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,r.multiply(this._matView,(new r).scale(this._node.worldScale),this._matView),this._node.getWorldPosition(this._position),i=!0);var h=null===(t=this.window)||void 0===t?void 0:t.swapchain,u=h&&h.surfaceTransform||$t.IDENTITY;if(this._isProjDirty||this._curTransform!==u){this._curTransform=u;var l=this._device.capabilities.clipSpaceSignY;if(this._proj===nr.PERSPECTIVE)if(a&&a.isWebXR&&a.webXRWindowMap&&a.webXRMatProjs){var c=a.webXRWindowMap.get(this._window);this._matProj.set(a.webXRMatProjs[c])}else r.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===rr.VERTICAL,this._device.capabilities.clipSpaceMinZ,l,u);else{var d=this._orthoHeight*this._aspect,_=this._orthoHeight;r.ortho(this._matProj,-d,d,-_,_,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,l,u)}r.invert(this._matProjInv,this._matProj),i=!0,this._isProjDirty=!1}i&&(r.multiply(this._matViewProj,this._matProj,this._matView),r.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,i=e.x,r=e.width,n=e.height,a=this._device.capabilities.screenSpaceSignY<0?1-e.y-n:e.y,s=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(s&&s.surfaceTransform||$t.IDENTITY){case $t.ROTATE_90:this._viewport.x=1-a-n,this._viewport.y=i,this._viewport.width=n,this._viewport.height=r;break;case $t.ROTATE_180:this._viewport.x=1-i-r,this._viewport.y=1-a-n,this._viewport.width=r,this._viewport.height=n;break;case $t.ROTATE_270:this._viewport.x=a,this._viewport.y=1-i-r,this._viewport.width=n,this._viewport.height=r;break;case $t.IDENTITY:this._viewport.x=i,this._viewport.y=a,this._viewport.width=r,this._viewport.height=n}this._orientedViewport.x=i,this._orientedViewport.y=a,this._orientedViewport.width=r,this._orientedViewport.height=n,this.resize(this.width,this.height)},t.initGeometryRenderer=function(){var e;this._geometryRenderer||(this._geometryRenderer=a.internal.GeometryRenderer?new a.internal.GeometryRenderer:null,null===(e=this._geometryRenderer)||void 0===e||e.activate(this._device))},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||a.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var i=t.swapchain;(i&&i.surfaceTransform||$t.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,r){if(!this._node)return null;var n=this.width,a=this.height,h=this._orientedViewport.x*n,u=this._orientedViewport.y*a,l=this._orientedViewport.width*n,c=this._orientedViewport.height*a,d=this._proj===nr.PERSPECTIVE,_=this._device.capabilities.clipSpaceSignY,p=s[this._curTransform];i.set(gr,(t-h)/l*2-1,(r-u)/c*2-1,d?1:-1);var f=gr.x,g=gr.y;return gr.x=f*p[0]+g*p[2]*_,gr.y=f*p[1]+g*p[3]*_,i.transformMat4(d?gr:e.o,gr,this._matViewProjInv),d?(this._node.getWorldPosition(mr),o.fromPoints(e,mr,gr)):i.transformQuat(e.d,i.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var r=this.width,n=this.height,a=this._orientedViewport.x*r,o=this._orientedViewport.y*n,u=this._orientedViewport.width*r,l=this._orientedViewport.height*n,c=this._device.capabilities.clipSpaceSignY,d=s[this._curTransform];if(this._proj===nr.PERSPECTIVE){i.set(e,(t.x-a)/u*2-1,(t.y-o)/l*2-1,1);var _=e.x,p=e.y;e.x=_*d[0]+p*d[2]*c,e.y=_*d[1]+p*d[3]*c,i.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(gr),i.lerp(e,gr,e,h(this._nearClip/this._farClip,1,t.z))}else{i.set(e,(t.x-a)/u*2-1,(t.y-o)/l*2-1,2*t.z-1);var f=e.x,g=e.y;e.x=f*d[0]+g*d[2]*c,e.y=f*d[1]+g*d[3]*c,i.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var r=this._device.capabilities.clipSpaceSignY,n=s[this._curTransform];i.transformMat4(e,t,this._matViewProj);var a=e.x,o=e.y;e.x=a*n[0]+o*n[2]*r,e.y=a*n[1]+o*n[3]*r;var h=this.width,u=this.height,l=this._orientedViewport.x*h,c=this._orientedViewport.y*u,d=this._orientedViewport.width*h,_=this._orientedViewport.height*u;return e.x=l+.5*(e.x+1)*d,e.y=c+.5*(e.y+1)*_,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,a){r.multiply(e,this._matViewProj,t),r.multiply(e,Sr[this._curTransform],e);var s=n/2,o=a/2;return r.identity(vr),r.transform(vr,vr,i.set(gr,s,o,0)),r.scale(vr,vr,i.set(gr,s,o,1)),r.multiply(e,vr,e),e},t.calculateObliqueMat=function(e){var t=new u(Math.sign(e.x),Math.sign(e.y),1,1).transformMat4(this._matProjInv),i=new u(this._matProj.m03,this._matProj.m07,this._matProj.m11,this._matProj.m15),r=2/u.dot(e,t),n=e.multiplyScalar(r).subtract(i);this._matProj.m02=n.x,this._matProj.m06=n.y,this._matProj.m10=n.z,this._matProj.m14=n.w},t.getClipSpaceMinz=function(){return this._device.capabilities.clipSpaceMinZ},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},t.setDefaultUsage=function(){this._usage=lr.GAME},l(e,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"systemWindowId",get:function(){return this._windowId}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=_r[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=pr[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=fr[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(e){_(8302),this.setViewportInOrientedSpace(e)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"surfaceTransform",get:function(){return this._curTransform}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"cameraType",get:function(){return this._cameraType},set:function(e){this._cameraType=e}},{key:"trackingType",get:function(){return this._trackingType},set:function(e){this._trackingType=e}},{key:"cameraUsage",get:function(){return this._usage},set:function(e){this._usage=e}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}()),wr=new di(null),yr=e("i",function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=mt.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._reflectionTex=null,this._reflectionSampler=null,this._instancedAttributeBlock={buffer:null,views:[],attributes:[]},this._instancedWorldMatrixIndex=-1,this._instancedSHIndex=-1,this._useReflectionProbeType=0}var t=e.prototype;return t.initialize=function(e,t,i){void 0===i&&(i=null);var r=a.director.root;this._device=gt.gfxDevice,wr.layout=t[0].localSetLayout,this._inputAssembler=this._device.createInputAssembler(e.iaInfo),this._descriptorSet=this._device.createDescriptorSet(wr);var n=a.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass();if(n){var s=new di(null);s.layout=n.localSetLayout,this._worldBoundDescriptorSet=this._device.createDescriptorSet(s)}this._subMesh=e,this._patches=i?i.sort():null,this._passes=t,this._flushPassInfo(),this.priority=mt.DEFAULT;var o=a.rendering;if((!o||!o.enableEffectImport)&&t[0].phase===we("reflection")||vt()&&t[0].phaseID===o.getPhaseID(o.getPassID("default"),"reflection")){var h=r.mainWindow.width,u=r.mainWindow.height,l=512;u<h?(h=l*h/u,u=l):u=l*u/(h=l),this._reflectionTex=this._device.createTexture(new ti(ii.TEX2D,ri.STORAGE|ri.TRANSFER_SRC|ri.SAMPLED,ni.RGBA8,h,u)),this.descriptorSet.bindTexture(Et,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new ai(si.LINEAR,si.LINEAR,si.NONE,oi.CLAMP,oi.CLAMP,oi.CLAMP)),this.descriptorSet.bindSampler(Et,this._reflectionSampler),this.descriptorSet.bindTexture(St,this._reflectionTex)}},t.destroy=function(){var e;this._descriptorSet.destroy(),this._descriptorSet=null,this._inputAssembler.destroy(),this._inputAssembler=null,null===(e=this._worldBoundDescriptorSet)||void 0===e||e.destroy(),this._worldBoundDescriptorSet=null,this.priority=mt.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null},t.update=function(){for(var e,t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),null===(e=this._worldBoundDescriptorSet)||void 0===e||e.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){if((e||this._patches)&&(!e||(e=e.sort(),!this._patches||e.length!==this._patches.length||JSON.stringify(e)!==JSON.stringify(this._patches)))){this._patches=e;var t=this._passes;if(t){for(var i=0;i<t.length;i++){var r=t[i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}this._flushPassInfo()}}},t.onGeometryChanged=function(){if(this._subMesh){var e=this._subMesh.drawInfo;if(this._inputAssembler&&e){var t=this._inputAssembler.drawInfo;Object.keys(e).forEach((function(i){t[i]=e[i]})),this._inputAssembler.drawInfo=t}}},t.getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributeBlock.attributes,i=0;i<t.length;i++)if(t[i].name===e)return i;return-1},t.updateInstancedWorldMatrix=function(e,t){var i=this.instancedAttributeBlock.views,r=i[t],n=i[t+1],a=i[t+2];r[0]=e.m00,r[1]=e.m01,r[2]=e.m02,r[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,a[0]=e.m08,a[1]=e.m09,a[2]=e.m10,a[3]=e.m14},t.updateInstancedSH=function(e,t){for(var i=this.instancedAttributeBlock.views,r=(yt.SH_QUADRATIC_R_OFFSET-yt.SH_LINEAR_CONST_R_OFFSET)/4,n=0,a=t;a<t+r;a++)for(var s=0;s<4;s++)i[a][s]=e[n++]},t.UpdateInstancedAttributes=function(e){this.instancedWorldMatrixIndex=-1,this.instancedSHIndex=-1;var t=this.passes[0];if(t.device.hasFeature(hi.INSTANCED_ARRAYS)){for(var i=0,r=0;r<e.length;r++){var n=e[r];n.isInstanced&&(i+=ui[n.format].size)}var a=this.instancedAttributeBlock;a.buffer=new Uint8Array(i),a.views.length=a.attributes.length=0;for(var s=0,o=0;o<e.length;o++){var h=e[o];if(h.isInstanced){var u=new li;u.format=h.format,u.name=h.name,u.isNormalized=h.isNormalized,u.location=h.location,a.attributes.push(u);var l=ui[h.format],c=new(ci(l))(a.buffer.buffer,s,l.count);a.views.push(c),s+=l.size}}t.batchingScheme===ye.INSTANCING&&t.getInstancedBuffer().destroy(),this.instancedWorldMatrixIndex=this.getInstancedAttributeIndex(Tt),this.instancedSHIndex=this.getInstancedAttributeIndex(wt)}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,i=e.length;t<i;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},l(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?p(12004,8):(this._passes=e,this._flushPassInfo(),this._descriptorSet&&(this._descriptorSet.destroy(),wr.layout=e[0].localSetLayout,this._descriptorSet=this._device.createDescriptorSet(wr)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler=this._device.createInputAssembler(e.iaInfo),this._subMesh=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"instancedAttributeBlock",get:function(){return this._instancedAttributeBlock}},{key:"instancedWorldMatrixIndex",get:function(){return this._instancedWorldMatrixIndex},set:function(e){this._instancedWorldMatrixIndex=e}},{key:"instancedSHIndex",get:function(){return this._instancedSHIndex},set:function(e){this._instancedSHIndex=e}},{key:"useReflectionProbeType",get:function(){return this._useReflectionProbeType},set:function(e){this._useReflectionProbeType=e}}]),e}());e("p",cr),function(e){e[e.SKYBOX=Er|Jt.DEPTH_STENCIL]="SKYBOX",e[e.SOLID_COLOR=Jt.ALL]="SOLID_COLOR"}(cr||e("p",cr={})),e("q",dr),function(e){e[e.CUBE=0]="CUBE",e[e.PLANAR=1]="PLANAR"}(dr||e("q",dr={}));var Ar,Rr=[new i(0,-90,0),new i(0,90,0),new i(90,0,0),new i(-90,0,0),new i(0,0,0),new i(0,180,0)];e("r",function(){function e(e){this.bakedCubeTextures=[],this.realtimePlanarTexture=null,this._resolution=256,this._clearFlag=cr.SKYBOX,this._backgroundColor=new v(0,0,0,255),this._visibility=ft,this._probeType=dr.CUBE,this._cubemap=null,this._size=new i(1,1,1),this._camera=null,this._probeId=0,this._needRefresh=!1,this._needRender=!1,this._node=null,this._cameraNode=null,this._boundingBox=null,this._cameraWorldPos=new i,this._cameraWorldRotation=new m,this._forward=new i,this._up=new i,this._previewSphere=null,this._previewPlane=null,this._probeId=e}var t=e.prototype;return t.initialize=function(e,t){this._node=e,this._cameraNode=t;var i=this.node.getWorldPosition();this._boundingBox=f.create(i.x,i.y,i.z,this._size.x,this._size.y,this._size.z),this._createCamera(t)},t.initBakedTextures=function(){if(0===this.bakedCubeTextures.length)for(var e=0;e<6;e++){var t=this._createTargetTexture(this._resolution,this._resolution);this.bakedCubeTextures.push(t)}},t.captureCubemap=function(){this.initBakedTextures(),this._resetCameraParams(),this._needRender=!0},t.renderPlanarReflection=function(e){if(e){if(!this.realtimePlanarTexture){var t=a.view.getDesignResolutionSize();this.realtimePlanarTexture=this._createTargetTexture(t.width,t.height),a.internal.reflectionProbeManager.updatePlanarMap(this,this.realtimePlanarTexture.getGFXTexture())}this._syncCameraParams(e),this._transformReflectionCamera(e),this._needRender=!0}},t.switchProbeType=function(e,t){e===dr.CUBE?this._needRender=!1:null!==t&&this.renderPlanarReflection(t)},t.getProbeId=function(){return this._probeId},t.updateProbeId=function(e){this._probeId=e},t.renderArea=function(){return this._probeType===dr.PLANAR?new g(this.realtimePlanarTexture.width,this.realtimePlanarTexture.height):new g(this.resolution,this.resolution)},t.isFinishedRendering=function(){return!0},t.validate=function(){return null!==this.cubemap},t.destroy=function(){this._camera&&(this._camera.destroy(),this._camera=null);for(var e=0;e<this.bakedCubeTextures.length;e++)this.bakedCubeTextures[e].destroy();this.bakedCubeTextures=[],this.realtimePlanarTexture&&(this.realtimePlanarTexture.destroy(),this.realtimePlanarTexture=null)},t.enable=function(){},t.disable=function(){},t.updateCameraDir=function(e){this.cameraNode.setRotationFromEuler(Rr[e]),this.camera.update(!0)},t.updateBoundingBox=function(){if(this.node){this.node.updateWorldTransform();var e=this.node.getWorldPosition();f.set(this._boundingBox,e.x,e.y,e.z,this._size.x,this._size.y,this._size.z)}},t.hasFrameBuffer=function(e){if(this.probeType===dr.PLANAR){var t;if(!this.realtimePlanarTexture)return!1;if((null===(t=this.realtimePlanarTexture.window)||void 0===t?void 0:t.framebuffer)===e)return!0}else{if(0===this.bakedCubeTextures.length)return!1;for(var i=0;i<this.bakedCubeTextures.length;i++){var r;if((null===(r=this.bakedCubeTextures[i].window)||void 0===r?void 0:r.framebuffer)===e)return!0}}return!1},t.isRGBE=function(){return!0},t._syncCameraParams=function(e){this.camera.projectionType=e.projectionType,this.camera.orthoHeight=e.orthoHeight,this.camera.nearClip=e.nearClip,this.camera.farClip=e.farClip,this.camera.fov=e.fov,this.camera.visibility=e.visibility,this.camera.clearFlag=e.clearFlag,this.camera.clearColor=e.clearColor,this.camera.priority=e.priority-1,this.camera.resize(e.width,e.height)},t._createCamera=function(e){if(a.director.root,!this._camera){if(this._camera=a.director.root.createCamera(),!this._camera)return null;this._camera.initialize({name:e.name,node:e,projection:nr.PERSPECTIVE,window:a.director.root&&a.director.root.tempWindow,priority:0,cameraType:hr.DEFAULT,trackingType:ur.NO_TRACKING})}return this._camera.setViewportInOrientedSpace(new n(0,0,1,1)),this._camera.fovAxis=rr.VERTICAL,this._camera.fov=c(90),this._camera.orthoHeight=10,this._camera.nearClip=1,this._camera.farClip=1e3,this._camera.clearColor=this._backgroundColor,this._camera.clearDepth=1,this._camera.clearStencil=0,this._camera.clearFlag=this._clearFlag,this._camera.visibility=this._visibility,this._camera.aperture=ar.F16_0,this._camera.shutter=or.D125,this._camera.iso=sr.ISO100,this._camera},t._resetCameraParams=function(){this.camera.projectionType=nr.PERSPECTIVE,this.camera.orthoHeight=10,this.camera.nearClip=1,this.camera.farClip=1e3,this.camera.fov=c(90),this.camera.priority=0,this.camera.resize(this.resolution,this.resolution),this.camera.visibility=this._visibility,this.camera.clearFlag=this._clearFlag,this.camera.clearColor=this._backgroundColor,this.cameraNode.worldPosition=this.node.worldPosition,this.cameraNode.worldRotation=this.node.worldRotation,this.camera.update(!0)},t._createTargetTexture=function(e,t){var i=new Ae;return i.reset({width:e,height:t}),i},t._transformReflectionCamera=function(e){var t=i.dot(this.node.worldPosition,this.node.up);this._reflect(this._cameraWorldPos,e.node.worldPosition,this.node.up,t),this.cameraNode.worldPosition=this._cameraWorldPos,i.transformQuat(this._forward,i.FORWARD,e.node.worldRotation),this._reflect(this._forward,this._forward,this.node.up,0),this._forward.normalize(),this._forward.negative(),i.transformQuat(this._up,i.UP,e.node.worldRotation),this._reflect(this._up,this._up,this.node.up,0),this._up.normalize(),m.fromViewUp(this._cameraWorldRotation,this._forward,this._up),this.cameraNode.worldRotation=this._cameraWorldRotation,this.camera.update(!0);var r=new u(this.node.up.x,this.node.up.y,this.node.up.z,-i.dot(this.node.up,this.node.worldPosition));r.transformMat4(this.camera.matView.clone().invert().transpose()),this.camera.calculateObliqueMat(r)},t._reflect=function(e,t,r,n){var a=i.clone(r);a.normalize();var s=i.dot(a,t)-n;return a.multiplyScalar(2*s),i.subtract(e,t,a),e},l(e,[{key:"probeType",get:function(){return this._probeType},set:function(e){this._probeType=e}},{key:"resolution",get:function(){return this._resolution},set:function(e){e!==this._resolution&&this.bakedCubeTextures.forEach((function(t){t.resize(e,e)})),this._resolution=e}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e,this.camera.clearFlag=this._clearFlag}},{key:"backgroundColor",get:function(){return this._backgroundColor},set:function(e){this._backgroundColor=e,this.camera.clearColor=this._backgroundColor}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera.visibility=this._visibility}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e);var t=this.node.getWorldPosition();f.set(this._boundingBox,t.x,t.y,t.z,this._size.x,this._size.y,this._size.z)}},{key:"cubemap",get:function(){return this._cubemap},set:function(e){this._cubemap=e}},{key:"node",get:function(){return this._node}},{key:"camera",get:function(){return this._camera}},{key:"needRefresh",get:function(){return this._needRefresh},set:function(e){this._needRefresh=e}},{key:"needRender",get:function(){return this._needRender},set:function(e){this._needRender=e}},{key:"boundingBox",get:function(){return this._boundingBox}},{key:"cameraNode",get:function(){return this._cameraNode},set:function(e){this._cameraNode=e}},{key:"previewSphere",get:function(){return this._previewSphere},set:function(e){this._previewSphere=e}},{key:"previewPlane",get:function(){return this._previewPlane},set:function(e){this._previewPlane=e}}]),e}()),e("au",Ar),function(e){e[e.NONE=0]="NONE",e[e.BAKED_CUBEMAP=1]="BAKED_CUBEMAP",e[e.PLANAR_REFLECTION=2]="PLANAR_REFLECTION",e[e.BLEND_PROBES=3]="BLEND_PROBES",e[e.BLEND_PROBES_AND_SKYBOX=4]="BLEND_PROBES_AND_SKYBOX"}(Ar||e("au",Ar={}));var Or,br=new r,Nr=[{name:"CC_RECEIVE_SHADOW",value:!0}],Ir=[{name:"CC_USE_LIGHTMAP",value:1}],Dr=[{name:"CC_USE_LIGHTMAP",value:2}],Pr=[{name:"CC_LIGHT_MAP_VERSION",value:2}],Cr=[{name:"CC_USE_LIGHT_PROBE",value:!0}];e("M",Or),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Or||e("M",Or={}));var Lr,Fr=new ai(si.LINEAR,si.LINEAR,si.NONE,oi.CLAMP,oi.CLAMP,oi.CLAMP),Mr=new ai(si.LINEAR,si.LINEAR,si.LINEAR,oi.CLAMP,oi.CLAMP,oi.CLAMP),Br=(e("h",function(){function e(){this.type=Or.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(Rt.COUNT),this._localBuffer=null,this._localSHData=null,this._localSHBuffer=null,this._lightmap=null,this._lightmapUVParam=new u,this._tetrahedronIndex=-1,this._lastWorldBoundCenter=new i(1/0,1/0,1/0),this._useLightProbe=!1,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._receiveDirLight=!0,this._shadowBias=0,this._shadowNormalBias=0,this._reflectionProbeId=-1,this._reflectionProbeBlendId=-1,this._reflectionProbeBlendWeight=0,this._enabled=!0,this._visFlags=At.Enum.NONE,this._priority=0,this._bakeToReflectionProbe=!0,this._reflectionProbeType=Ar.NONE,this._device=gt.gfxDevice}var n=e.prototype;return n.initialize=function(){this._inited||(this._receiveShadow=!0,this.castShadow=!1,this.enabled=!0,this.visFlags=At.Enum.NONE,this._inited=!0,this._bakeToReflectionProbe=!0,this._reflectionProbeType=Ar.NONE)},n.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++)this._subModels[t].destroy();this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._localSHBuffer&&(this._localSHBuffer.destroy(),this._localSHBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1},n.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},n.detachFromScene=function(){this.scene=null},n.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e.isTransformDirty()){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},n.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},n.updateUBOs=function(e){for(var t=this._subModels,i=0;i<t.length;i++)t[i].update();this._updateStamp=e,this.updateSHUBOs();var n=this.node.scene.globals.shadows.enabled&&this.node.scene.globals.shadows.type===Re.Planar;if(this._localDataUpdated){this._localDataUpdated=!1;for(var a=this.transform._mat,s=!1,o=0;o<t.length;o++){var h=t[o],u=h.instancedWorldMatrixIndex;u>=0?h.updateInstancedWorldMatrix(a,u):s=!0}(s||n)&&this._localBuffer&&(r.toArray(this._localData,a,Rt.MAT_WORLD_OFFSET),r.invert(br,a),r.transpose(br,br),r.toArray(this._localData,br,Rt.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},n.showTetrahedron=function(){return this.isLightProbeAvailable()},n.isLightProbeAvailable=function(){if(!this._useLightProbe)return!1;var e=a.director.root.pipeline.pipelineSceneData.lightProbes;return!(!e||e.empty()||!this._worldBounds)},n.updateSHBuffer=function(){if(this._localSHData){for(var e=this._subModels,t=!1,i=0;i<e.length;i++){var r=e[i],n=r.instancedSHIndex;n>=0?r.updateInstancedSH(this._localSHData,n):t=!0}t&&this._localSHBuffer&&this._localSHBuffer.update(this._localSHData)}},n.clearSHUBOs=function(){if(this._localSHData){for(var e=0;e<yt.COUNT;e++)this._localSHData[e]=0;this.updateSHBuffer()}},n.updateSHUBOs=function(){if(this.isLightProbeAvailable()){var e=this._worldBounds.center;if(!e.equals(this._lastWorldBoundCenter,E)){var t=[],i=new u(0,0,0,0),r=a.director.root.pipeline.pipelineSceneData.lightProbes;this._lastWorldBoundCenter.set(e),this._tetrahedronIndex=r.data.getInterpolationWeights(e,this._tetrahedronIndex,i),r.data.getInterpolationSHCoefficients(this._tetrahedronIndex,i,t)&&this._localSHData&&(a.internal.SH.reduceRinging(t,r.reduceRinging),a.internal.SH.updateUBOData(this._localSHData,yt.SH_LINEAR_CONST_R_OFFSET,t),this.updateSHBuffer())}}},n.createBoundingShape=function(e,t){e&&t&&(this._modelBounds||(this._modelBounds=f.create()),this._worldBounds||(this._worldBounds=f.create()),f.fromPoints(this._modelBounds,e,t),f.copy(this._worldBounds,this._modelBounds))},n._createSubModel=function(){return new yr},n.initSubModel=function(e,t,i){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,i.passes,this.getMacroPatches(e)),this._updateAttributesAndBinding(e)},n.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},n.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},n.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},n.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},n.onGeometryChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onGeometryChanged()},n.initLightingmap=function(e,t){this._lightmap=e,this._lightmapUVParam=t},n.updateLightingmap=function(e,t){u.toArray(this._localData,t,Rt.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,this.onMacroPatchesStateChanged(),e||(e=Oe.get("empty-texture"));var i=e.getGFXTexture();if(i)for(var r=this._device.getSampler(e.mipmaps.length>1?Mr:Fr),n=this._subModels,a=0;a<n.length;a++){var s=n[a].descriptorSet;s.bindTexture(Ot,i),s.bindSampler(Ot,r),s.update()}},n.updateReflectionProbeCubemap=function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),e||(e=Oe.get("default-cube-texture"));var t=e.getGFXTexture();if(t)for(var i=this._device.getSampler(e.getSamplerInfo()),r=this._subModels,n=0;n<r.length;n++){var a=r[n].descriptorSet;a&&(a.bindSampler(bt,i),a.bindTexture(bt,t),a.update())}},n.updateReflectionProbeBlendCubemap=function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),e||(e=Oe.get("default-cube-texture"));var t=e.getGFXTexture();if(t)for(var i=this._device.getSampler(e.getSamplerInfo()),r=this._subModels,n=0;n<r.length;n++){var a=r[n].descriptorSet;a&&(a.bindSampler(Nt,i),a.bindTexture(Nt,t),a.update())}},n.updateReflectionProbePlanarMap=function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged();var t=this._device.getSampler(new ai(si.LINEAR,si.LINEAR,si.NONE,oi.CLAMP,oi.CLAMP,oi.CLAMP));if(e||(e=Oe.get("empty-texture").getGFXTexture()),e)for(var i=this._subModels,r=0;r<i.length;r++){var n=i[r].descriptorSet;n&&(n.bindTexture(It,e),n.bindSampler(It,t),n.update())}},n.updateReflectionProbeDataMap=function(e){this._localDataUpdated=!0,this.onMacroPatchesStateChanged(),e||(e=Oe.get("empty-texture"));var t=e.getGFXTexture();if(t)for(var i=this._subModels,r=0;r<i.length;r++){var n=i[r].descriptorSet;n&&(n.bindTexture(Dt,t),n.bindSampler(Dt,e.getGFXSampler()),n.update())}},n.updateLocalShadowBias=function(){var e=this._localData;e[Rt.LOCAL_SHADOW_BIAS+0]=this._shadowBias,e[Rt.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,this._localDataUpdated=!0},n.updateReflectionProbeId=function(){var e=this._localData;e[Rt.LOCAL_SHADOW_BIAS+2]=this._reflectionProbeId,e[Rt.LOCAL_SHADOW_BIAS+3]=this._reflectionProbeBlendId;var t=null,i=null;if(a.internal.reflectionProbeManager&&(t=a.internal.reflectionProbeManager.getProbeById(this._reflectionProbeId),i=a.internal.reflectionProbeManager.getProbeById(this._reflectionProbeBlendId)),t){if(t.probeType===dr.PLANAR)e[Rt.REFLECTION_PROBE_DATA1]=t.node.up.x,e[Rt.REFLECTION_PROBE_DATA1+1]=t.node.up.y,e[Rt.REFLECTION_PROBE_DATA1+2]=t.node.up.z,e[Rt.REFLECTION_PROBE_DATA1+3]=1,e[Rt.REFLECTION_PROBE_DATA2]=1,e[Rt.REFLECTION_PROBE_DATA2+1]=0,e[Rt.REFLECTION_PROBE_DATA2+2]=0,e[Rt.REFLECTION_PROBE_DATA2+3]=1;else{e[Rt.REFLECTION_PROBE_DATA1]=t.node.worldPosition.x,e[Rt.REFLECTION_PROBE_DATA1+1]=t.node.worldPosition.y,e[Rt.REFLECTION_PROBE_DATA1+2]=t.node.worldPosition.z,e[Rt.REFLECTION_PROBE_DATA1+3]=0,e[Rt.REFLECTION_PROBE_DATA2]=t.size.x,e[Rt.REFLECTION_PROBE_DATA2+1]=t.size.y,e[Rt.REFLECTION_PROBE_DATA2+2]=t.size.z;var r=t.isRGBE()?1e3:0;e[Rt.REFLECTION_PROBE_DATA2+3]=t.cubemap?t.cubemap.mipmapLevel+r:1+r}if(this._reflectionProbeType===Ar.BLEND_PROBES||this._reflectionProbeType===Ar.BLEND_PROBES_AND_SKYBOX)if(i){e[Rt.REFLECTION_PROBE_BLEND_DATA1]=i.node.worldPosition.x,e[Rt.REFLECTION_PROBE_BLEND_DATA1+1]=i.node.worldPosition.y,e[Rt.REFLECTION_PROBE_BLEND_DATA1+2]=i.node.worldPosition.z,e[Rt.REFLECTION_PROBE_BLEND_DATA1+3]=this.reflectionProbeBlendWeight,e[Rt.REFLECTION_PROBE_BLEND_DATA2]=i.size.x,e[Rt.REFLECTION_PROBE_BLEND_DATA2+1]=i.size.y,e[Rt.REFLECTION_PROBE_BLEND_DATA2+2]=i.size.z;var n=i.isRGBE()?1e3:0;e[Rt.REFLECTION_PROBE_BLEND_DATA2+3]=i.cubemap?i.cubemap.mipmapLevel+n:1+n}else this._reflectionProbeType===Ar.BLEND_PROBES_AND_SKYBOX&&(e[Rt.REFLECTION_PROBE_BLEND_DATA1+3]=this.reflectionProbeBlendWeight)}this._localDataUpdated=!0},n.getMacroPatches=function(){var e=this.receiveShadow?Nr:null;if(null!=this._lightmap&&this.node&&this.node.scene&&!this.node.scene.globals.disableLightmap){var t=this.node.scene.globals.bakedWithStationaryMainLight?Dr:Ir;e=e?e.concat(t):t,this.node.scene.globals.bakedWithHighpLightmap&&(e=e.concat(Pr))}this._useLightProbe&&(e=e?e.concat(Cr):Cr);var i=[{name:"CC_USE_REFLECTION_PROBE",value:this._reflectionProbeType}];e=e?e.concat(i):i;var r=[{name:"CC_DISABLE_DIRECTIONAL_LIGHT",value:!this._receiveDirLight}];return e?e.concat(r):r},n._updateAttributesAndBinding=function(e){var i=this._subModels[e];if(i){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,i.descriptorSet),this._initLocalSHDescriptors(e),this._updateLocalSHDescriptors(e,i.descriptorSet),this._initWorldBoundDescriptors(e),i.worldBoundDescriptorSet&&this._updateWorldBoundDescriptors(e,i.worldBoundDescriptorSet);for(var r,n=[],a=new Set,s=t(i.passes);!(r=s()).done;)for(var o,h=r.value.getShaderVariant(i.patches),u=t(h.attributes);!(o=u()).done;){var l=o.value;a.has(l.name)||(n.push(l),a.add(l.name))}this._updateInstancedAttributes(n,i)}},n._updateInstancedAttributes=function(e,t){t.UpdateInstancedAttributes(e),this._localDataUpdated=!0},n._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.DEVICE,Rt.SIZE,Rt.SIZE)))},n._initLocalSHDescriptors=function(){this._useLightProbe&&(this._localSHData||(this._localSHData=new Float32Array(yt.COUNT)),this._localSHBuffer||(this._localSHBuffer=this._device.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.DEVICE,yt.SIZE,yt.SIZE))))},n._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.DEVICE,Pt.SIZE,Pt.SIZE)))},n._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(Rt.BINDING,this._localBuffer)},n._updateLocalSHDescriptors=function(e,t){this._localSHBuffer&&t.bindBuffer(yt.BINDING,this._localSHBuffer)},n._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(Pt.BINDING,this._worldBoundBuffer)},l(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"localSHBuffer",get:function(){return this._localSHBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"useLightProbe",get:function(){return this._useLightProbe},set:function(e){this._useLightProbe=e,this.onMacroPatchesStateChanged()}},{key:"tetrahedronIndex",get:function(){return this._tetrahedronIndex},set:function(e){this._tetrahedronIndex=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e,this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveDirLight",get:function(){return this._receiveDirLight},set:function(e){this._receiveDirLight=e,this.onMacroPatchesStateChanged()}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"bakeToReflectionProbe",get:function(){return this._bakeToReflectionProbe},set:function(e){this._bakeToReflectionProbe=e}},{key:"reflectionProbeType",get:function(){return this._reflectionProbeType},set:function(e){this._reflectionProbeType=e;for(var t=this._subModels,i=0;i<t.length;i++)t[i].useReflectionProbeType=e;this.onMacroPatchesStateChanged()}},{key:"reflectionProbeId",get:function(){return this._reflectionProbeId},set:function(e){this._reflectionProbeId=e}},{key:"reflectionProbeBlendId",get:function(){return this._reflectionProbeBlendId},set:function(e){this._reflectionProbeBlendId=e}},{key:"reflectionProbeBlendWeight",get:function(){return this._reflectionProbeBlendWeight},set:function(e){this._reflectionProbeBlendWeight=e}}]),e}()),e("O",function(){function e(){this._enabled=!1,this._minPos=new i(0,0,0),this._maxPos=new i(0,0,0),this._depth=0}return e.prototype.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},l(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}}]),e}())),xr=e("j",function(){function e(){this._enabled=!0,this._blurRadius=.01,this._sssIntensity=3}return e.prototype.initialize=function(e){this._enabled=e.enabled,this._blurRadius=e.blurRadius,this._sssIntensity=e.sssIntensity},l(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"blurRadius",get:function(){return this._blurRadius},set:function(e){this._blurRadius=e}},{key:"sssIntensity",get:function(){return this._sssIntensity},set:function(e){this._sssIntensity=e}}]),e}());function Ur(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,r=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),n=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),a=2*r-8*n+4,s=3*r/a,o=2*n/a,h=1/o*s,u=1/o*(1-s-o);e.x=3.2404542*h-1.5371385+-.4985314*u,e.y=-.969266*h+1.8760108+.041556*u,e.z=.0556434*h-.2040259+1.0572252*u}e("L",Lr),function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.POINT=3]="POINT",e[e.RANGED_DIRECTIONAL=4]="RANGED_DIRECTIONAL",e[e.UNKNOWN=5]="UNKNOWN"}(Lr||e("L",Lr={}));var kr,Hr,Vr,Gr,Wr,zr,Qr,jr,Yr,Kr,Xr,qr,Zr=e("n",(function(e){return 4*Math.PI*Math.PI*e*e})),Jr=e("l",function(){function e(){this._baked=!1,this._color=new i(1,1,1),this._colorTemp=6550,this._colorTempRGB=new i(1,1,1),this._finalColor=new i(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Lr.UNKNOWN,this._visibility=ft}var t=e.prototype;return t.initialize=function(){this.color=new i(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null},t.update=function(){},l(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e),this._useColorTemperature&&i.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,e&&i.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,Ur(this._colorTempRGB,this._colorTemp),this._useColorTemperature&&i.multiply(this._finalColor,this._color,this._colorTempRGB)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"finalColor",get:function(){return this._finalColor}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=be.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}}]),e}()),$r=new i(0,0,-1),en=new i,tn=(e("D",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new i(1,-1,-1),t._illuminanceHDR=Ne.SUN_ILLUM,t._illuminanceLDR=1,t._shadowEnabled=!1,t._shadowPcf=Ie.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._shadowSaturation=1,t._shadowDistance=50,t._shadowInvisibleOcclusionRange=200,t._csmLevel=De.LEVEL_4,t._csmNeedUpdate=!1,t._csmLayerLambda=.75,t._csmOptimizationMode=Pe.DisableRotationFix,t._csmLayersTransition=!1,t._csmTransitionRange=.05,t._shadowFixedArea=!1,t._shadowNear=.1,t._shadowFar=10,t._shadowOrthoSize=5,t._type=Lr.DIRECTIONAL,t}S(t,e);var r=t.prototype;return r.initialize=function(){e.prototype.initialize.call(this),this.illuminance=Ne.SUN_ILLUM,this.direction=new i(1,-1,-1)},r.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=i.transformQuat(en,$r,this._node.worldRotation))},r.activate=function(){var e=a.director.root,t=e.pipeline;this._shadowEnabled?(this._shadowFixedArea||!t.pipelineSceneData.csmSupported?t.macros.CC_DIR_LIGHT_SHADOW_TYPE=1:this.csmLevel>1&&t.pipelineSceneData.csmSupported?(t.macros.CC_DIR_LIGHT_SHADOW_TYPE=2,t.macros.CC_CASCADED_LAYERS_TRANSITION=this._csmLayersTransition):t.macros.CC_DIR_LIGHT_SHADOW_TYPE=1,t.macros.CC_DIR_SHADOW_PCF_TYPE=this._shadowPcf):t.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,e.onGlobalPipelineStateChanged()},l(t,[{key:"direction",get:function(){return this._dir},set:function(e){i.normalize(this._dir,e)}},{key:"illuminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e,this.activate()}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e,this.activate()}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,Ce.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,Ce.MAX_FAR)}},{key:"csmLevel",get:function(){return this._csmLevel},set:function(e){this._csmLevel=e,this.activate()}},{key:"csmNeedUpdate",get:function(){return this._csmNeedUpdate},set:function(e){this._csmNeedUpdate=e}},{key:"csmLayerLambda",get:function(){return this._csmLayerLambda},set:function(e){this._csmLayerLambda=e}},{key:"csmOptimizationMode",get:function(){return this._csmOptimizationMode},set:function(e){this._csmOptimizationMode=e}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e,this.activate()}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,Ce.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e}},{key:"csmLayersTransition",get:function(){return this._csmLayersTransition},set:function(e){this._csmLayersTransition=e,this.activate()}},{key:"csmTransitionRange",get:function(){return this._csmTransitionRange},set:function(e){this._csmTransitionRange=e}}]),t}(Jr)),e("m",function(e){function t(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=f.create(),t._pos=new i,t._type=Lr.SPHERE,t}S(t,e);var r=t.prototype;return r.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/Zr(.15),this.luminanceLDR=1},r.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;f.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},l(t,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),t}(Jr)),new i(0,0,-1)),rn=new m,nn=new r,an=new r,sn=new r,on=new r,hn=(e("o",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new i(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._shadowEnabled=!1,t._shadowPcf=Ie.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._aabb=f.create(),t._frustum=d.create(),t._pos=new i,t._type=Lr.SPOT,t}S(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.luminanceHDR=1700/Zr(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._dir.set(new i(1,-1,-1))},n.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),i.transformQuat(this._dir,tn,this._node.getWorldRotation(rn)),i.normalize(this._dir,this._dir),f.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(nn),r.invert(nn,nn),r.perspective(an,this._angle,1,.001,this._range),r.multiply(sn,an,nn),this._frustum.update(sn,on),this._needUpdate=!1)},l(t,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}}]),t}(Jr)),e("P",function(e){function t(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=f.create(),t._pos=new i,t._type=Lr.POINT,t}S(t,e);var r=t.prototype;return r.initialize=function(){e.prototype.initialize.call(this),this.range=1,this.luminanceHDR=1700/Zr(1),this.luminanceLDR=1},r.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;f.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},l(t,[{key:"position",get:function(){return this._pos}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),t}(Jr)),new i(0,0,-1)),un=(e("R",function(e){function t(){var t;return(t=e.call(this)||this)._dir=new i(0,0,-1),t._pos=new i(0,0,0),t._scale=new i(1,1,1),t._right=new i(1,0,0),t._illuminanceHDR=Ne.SUN_ILLUM,t._illuminanceLDR=1,t._type=Lr.RANGED_DIRECTIONAL,t}S(t,e);var r=t.prototype;return r.initialize=function(){e.prototype.initialize.call(this),this.illuminance=Ne.SUN_ILLUM},r.update=function(){this._node&&this._node.hasChangedFlags&&(this._node.getWorldPosition(this._pos),this._node.getWorldScale(this._scale),i.transformQuat(this._dir,hn,this._node.worldRotation),i.transformQuat(this._right,i.RIGHT,this._node.worldRotation))},l(t,[{key:"direction",get:function(){return this._dir}},{key:"right",get:function(){return this._right}},{key:"position",get:function(){return this._pos}},{key:"scale",get:function(){return this._scale}},{key:"illuminance",get:function(){return a.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){a.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}}]),t}(Jr)),e("s",function(){function e(){this.screenUsagePercentage=1,this._models=[]}var t=e.prototype;return t.addModel=function(e){this._models.splice(0,0,e)},t.eraseModel=function(e){var t=this._models.indexOf(e);t>=0&&this._models.splice(t,1)},t.clearModels=function(){this._models.length=0},l(e,[{key:"models",get:function(){return this._models}}]),e}()),e("t",function(){function e(){this.scene=void 0,this.node=null,this._device=void 0,this.enabled=!0,this._localBoundaryCenter=new i(0,0,0),this._objectSize=1,this._lodDataArray=[],this._lockedLODLevelVec=[],this._isLockLevelChanged=!1,this._device=gt.gfxDevice}var t=e.prototype;return t.attachToScene=function(e){this.scene=e},t.detachFromScene=function(){this.scene=null},t.lockLODLevels=function(e){if(e.length!==this._lockedLODLevelVec.length)this._isLockLevelChanged=!0;else for(var t=e.length,i=0;i<t;i++)if(e[i]!==this._lockedLODLevelVec[i]){this._isLockLevelChanged=!0;break}this._lockedLODLevelVec=e},t.isLockLevelChanged=function(){return this._isLockLevelChanged},t.resetLockChangeFlag=function(){this._isLockLevelChanged=!1},t.getLockedLODLevels=function(){return this._lockedLODLevelVec},t.clearLODs=function(){this._lodDataArray.length=0},t.insertLOD=function(e,t){this._lodDataArray.splice(e,0,t)},t.updateLOD=function(e,t){this._lodDataArray[e]=t},t.eraseLOD=function(e){this._lodDataArray.splice(e,1)},t.getVisibleLODLevel=function(e){for(var t=this.getScreenUsagePercentage(e),i=-1,r=0;r<this.lodCount;++r)if(t>=this.lodDataArray[r].screenUsagePercentage){i=r;break}return i},t.getScreenUsagePercentage=function(e){return this.node?(e.projectionType===nr.PERSPECTIVE&&(t=i.len(this.localBoundaryCenter.transformMat4(this.node.worldMatrix).subtract(e.node.worldPosition))),this.distanceToScreenUsagePercentage(e,t,this.getWorldSpaceSize())):0;var t},t.distanceToScreenUsagePercentage=function(e,t,i){return e.projectionType===nr.PERSPECTIVE?i*e.matProj.m05/(2*t):i*e.matProj.m05*.5},t.getWorldSpaceSize=function(){var e=this.node.scale;return Math.max(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))*this.objectSize},l(e,[{key:"localBoundaryCenter",get:function(){return this._localBoundaryCenter.clone()},set:function(e){this._localBoundaryCenter.set(e)}},{key:"lodCount",get:function(){return this._lodDataArray.length}},{key:"objectSize",get:function(){return this._objectSize},set:function(e){this._objectSize=e}},{key:"lodDataArray",get:function(){return this._lodDataArray}}]),e}()),e("u",function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._lodGroups=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._pointLights=[],this._rangedDirLights=[],this._mainLight=null,this._modelId=0,this._lodStateCache=null,this._root=e}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var i=e.prototype;return i.initialize=function(e){return this._name=e.name,this._lodStateCache=new cn(this),!0},i.update=function(e){var t=this._mainLight;t&&t.update();for(var i=this._sphereLights,r=0;r<i.length;r++)i[r].update();for(var n=this._spotLights,a=0;a<n.length;a++)n[a].update();for(var s=this._pointLights,o=0;o<s.length;o++)s[o].update();for(var h=this._rangedDirLights,u=0;u<h.length;u++)h[u].update();for(var l=this._models,c=0;c<l.length;c++){var d=l[c];d.enabled&&(d.updateTransform(e),d.updateUBOs(e))}this._lodStateCache.updateLodState()},i.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeRangedDirLights(),this.removeModels(),this.removeLODGroups(),this._lodStateCache.clearCache()},i.isCulledByLod=function(e,t){return this._lodStateCache.isLodModelCulled(e,t)},i.addCamera=function(e){e.attachToScene(this),this._cameras.push(e),this._lodStateCache.addCamera(e)},i.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),e.detachFromScene(),void this._lodStateCache.removeCamera(e)},i.removeCameras=function(){for(var e,i=t(this._cameras);!(e=i()).done;){var r=e.value;r.detachFromScene(),this._lodStateCache.removeCamera(r)}this._cameras.splice(0)},i.setMainLight=function(e){this._mainLight=e,this._mainLight&&this._mainLight.activate()},i.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=be.ROTATION));this.setMainLight(null)}},i.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},i.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},i.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},i.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},i.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},i.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},i.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},i.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights.length=0},i.addPointLight=function(e){e.attachToScene(this),this._pointLights.push(e)},i.removePointLight=function(e){for(var t=0;t<this._pointLights.length;++t)if(this._pointLights[t]===e)return e.detachFromScene(),void this._pointLights.splice(t,1)},i.removePointLights=function(){for(var e=0;e<this._pointLights.length;++e)this._pointLights[e].detachFromScene();this._pointLights.length=0},i.addRangedDirLight=function(e){e.attachToScene(this),this._rangedDirLights.push(e)},i.removeRangedDirLight=function(e){for(var t=0;t<this._rangedDirLights.length;++t)if(this._rangedDirLights[t]===e)return e.detachFromScene(),void this._rangedDirLights.splice(t,1)},i.removeRangedDirLights=function(){for(var e=0;e<this._rangedDirLights.length;++e)this._rangedDirLights[e].detachFromScene();this._rangedDirLights.length=0},i.addModel=function(e){e.attachToScene(this),this._models.push(e)},i.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return this._lodStateCache.removeModel(e),e.detachFromScene(),void this._models.splice(t,1)},i.removeModels=function(){for(var e,i=t(this._models);!(e=i()).done;){var r=e.value;this._lodStateCache.removeModel(r),r.detachFromScene(),r.destroy()}this._models.length=0},i.addBatch=function(e){this._batches.push(e)},i.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},i.removeBatches=function(){this._batches.length=0},i.addLODGroup=function(e){this._lodGroups.push(e),e.attachToScene(this),this._lodStateCache.addLodGroup(e)},i.removeLODGroup=function(e){var t=this._lodGroups.indexOf(e);t>=0&&(this._lodGroups.splice(t,1),e.detachFromScene(),this._lodStateCache.removeLodGroup(e))},i.removeLODGroups=function(){for(var e,i=t(this._lodGroups);!(e=i()).done;){var r=e.value;this._lodStateCache.removeLodGroup(r)}this._lodGroups.length=0},i.onGlobalPipelineStateChanged=function(){for(var e,i=t(this._models);!(e=i()).done;)e.value.onGlobalPipelineStateChanged()},i.generateModelId=function(){return this._modelId++},l(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"pointLights",get:function(){return this._pointLights}},{key:"rangedDirLights",get:function(){return this._rangedDirLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}},{key:"lodGroups",get:function(){return this._lodGroups}}]),e}())),ln=function(){this.usedLevel=-1,this.lastUsedLevel=-1,this.transformDirty=!0},cn=function(){function e(e){this._renderScene=null,this._modelsInLODGroup=new Map,this._lodStateInCamera=new Map,this._newAddedLodGroupVec=new Array,this._levelModels=new Map,this._renderScene=e}var i=e.prototype;return i.addCamera=function(e){for(var i,r=t(this._renderScene.lodGroups);!(i=r()).done;){var n=i.value.node.layer;if((e.visibility&n)===n){this._lodStateInCamera.has(e)||this._lodStateInCamera.set(e,new Map);break}}},i.removeCamera=function(e){this._lodStateInCamera.has(e)&&this._lodStateInCamera.delete(e)},i.addLodGroup=function(e){this._newAddedLodGroupVec.push(e);for(var i,r=t(this._renderScene.cameras);!(i=r()).done;){var n=i.value;if(!this._lodStateInCamera.has(n)){var a=e.node.layer;(n.visibility&a)===a&&this._lodStateInCamera.set(n,new Map)}}},i.removeLodGroup=function(e){for(var i=0;i<e.lodCount;i++)for(var r,n=e.lodDataArray[i],a=t(n.models);!(r=a()).done;){var s=r.value;this._modelsInLODGroup.delete(s)}for(var o,h=t(this._lodStateInCamera);!(o=h()).done;)o.value[1].delete(e);this._levelModels.delete(e)},i.removeModel=function(e){this._modelsInLODGroup.has(e)&&this._modelsInLODGroup.delete(e)},i.updateLodState=function(){for(var e,i=this,r=t(this._newAddedLodGroupVec);!(e=r()).done;){var n=e.value,a=this._levelModels.get(n);a||(a=new Map,this._levelModels.set(n,a));for(var s=0;s<n.lodCount;s++){var o=a.get(s);o||(o=new Array);for(var h,u=n.lodDataArray[s],l=t(u.models);!(h=l()).done;){var c=h.value,d=this._modelsInLODGroup.get(c);d||(d=new Map),this._modelsInLODGroup.set(c,d),o.push(c)}a.set(s,o)}}this._newAddedLodGroupVec.length=0;for(var _,p=function(){var e=_.value;if(e.enabled){var r=e.getLockedLODLevels();if(r.length>0){if(e.node.hasChangedFlags>0)for(var n,a=t(i._lodStateInCamera);!(n=a()).done;){var s=n.value,o=s[1].get(e);o||(o=new ln,s[1].set(e,o)),o.transformDirty=!0}if(e.isLockLevelChanged()){e.resetLockChangeFlag();var h=i._levelModels.get(e);if(h){h.forEach((function(e){e.forEach((function(e){var t=i._modelsInLODGroup.get(e);t&&t.clear()}))}));for(var u,l=t(r);!(u=l()).done;){var c=u.value,d=h.get(c);d&&d.forEach((function(e){var r=i._modelsInLODGroup.get(e);if(r&&e.node&&e.node.active)for(var n,a=t(i._lodStateInCamera);!(n=a()).done;){var s=n.value;r.set(s[0],!0)}}))}}}return"continue"}for(var p,f=!1,g=t(i._lodStateInCamera);!(p=g()).done;){var m=p.value,v=m[1].get(e);v||(v=new ln,m[1].set(e,v));var E=m[0].node.hasChangedFlags,S=e.node.hasChangedFlags;if(E>0||S>0||v.transformDirty){v.transformDirty&&(v.transformDirty=!1);var T=e.getVisibleLODLevel(m[0]);T!==v.usedLevel&&(v.lastUsedLevel=v.usedLevel,v.usedLevel=T,f=!0)}}var w=i._levelModels.get(e);if(!w)return"continue";e.isLockLevelChanged()?(e.resetLockChangeFlag(),w.forEach((function(e){e.forEach((function(e){var t=i._modelsInLODGroup.get(e);t&&t.clear()}))})),f=!0):f&&i._lodStateInCamera.forEach((function(t){var r=t.get(e);if(r&&r.usedLevel!==r.lastUsedLevel){var n=w.get(r.lastUsedLevel);n&&n.forEach((function(e){var t=i._modelsInLODGroup.get(e);t&&t.clear()}))}})),f&&i._lodStateInCamera.forEach((function(t,r){var n=t.get(e);if(n){var a=n.usedLevel,s=w.get(a);s&&s.forEach((function(e){var t=i._modelsInLODGroup.get(e);t&&e.node&&e.node.active&&t.set(r,!0)}))}}))}},f=t(this._renderScene.lodGroups);!(_=f()).done;)p()},i.isLodModelCulled=function(e,t){var i=this._modelsInLODGroup.get(t);return!!i&&!i.has(e)},i.clearCache=function(){this._levelModels.clear(),this._modelsInLODGroup.clear(),this._lodStateInCamera.clear(),this._newAddedLodGroupVec.length=0},i.isLodGroupVisibleByCamera=function(e,t){var i=e.node.layer;return(t.visibility&i)===i},e}(),dn=new i,_n=T.create(0,0,0,1),pn=new f(0,0,0,.5,.5,.5),fn=new f,gn=new w((function(){return{model:null,depth:0}}),128);function mn(e,t){var r=0;e.node&&(i.subtract(dn,e.node.worldPosition,t.position),r=i.dot(dn,t.forward));var n=gn.alloc();return n.model=e,n.depth=r,n}function vn(e,t){var i=e.pipelineSceneData,r=i.validPunctualLights;r.length=0;for(var n=t.scene.spotLights,a=0;a<n.length;a++){var s=n[a];s.baked&&!t.node.scene.globals.disableLightmap||(T.set(_n,s.position.x,s.position.y,s.position.z,s.range),y.sphereFrustum(_n,t.frustum)&&r.push(s))}for(var o=t.scene.sphereLights,h=0;h<o.length;h++){var u=o[h];u.baked&&!t.node.scene.globals.disableLightmap||(T.set(_n,u.position.x,u.position.y,u.position.z,u.range),y.sphereFrustum(_n,t.frustum)&&r.push(u))}for(var l=t.scene.pointLights,c=0;c<l.length;c++){var d=l[c];d.baked||(T.set(_n,d.position.x,d.position.y,d.position.z,d.range),y.sphereFrustum(_n,t.frustum)&&r.push(d))}for(var _=t.scene.rangedDirLights,p=0;p<_.length;p++){var g=_[p];f.transform(fn,pn,g.node.getWorldMatrix()),y.aabbFrustum(fn,t.frustum)&&r.push(g)}i.validPunctualLights=r}function En(e,t){var i=t.scene,r=i.mainLight,n=e.pipelineSceneData,s=n.shadows,o=n.skybox,h=n.csmLayers,u=n.renderObjects;gn.freeArray(u),u.length=0;var l=h.castShadowObjects;l.length=0;var c=h.layerObjects;c.clear(),s.enabled&&(e.pipelineUBO.updateShadowUBORange(Ct.SHADOW_COLOR_OFFSET,s.shadowColor),s.type===Re.ShadowMap&&r&&r.node&&h.update(n,t)),t.clearFlag&Er&&(o.enabled&&o.model?u.push(mn(o.model,t)):t.cameraUsage!==lr.EDITOR&&t.cameraUsage!==lr.SCENE_VIEW&&a.warnID(15100,t.name));var d=i.models,_=t.visibility;function p(e){if(e.enabled){if(i.isCulledByLod(t,e))return;if(e.castShadow&&(l.push(mn(e,t)),c.push(mn(e,t))),e.node&&(_&e.node.layer)===e.node.layer||_&e.visFlags){if(e.worldBounds&&!y.aabbFrustum(e.worldBounds,t.frustum))return;u.push(mn(e,t))}}}for(var f=0;f<d.length;f++)p(d[f])}function Sn(e,t){e.writeString(t.name),e.writeNumber(t.type),e.writeNumber(t.count)}function Tn(e,t){t.name=e.readString(),t.type=e.readNumber(),t.count=e.readNumber()}function wn(e,i){e.writeNumber(i.set),e.writeNumber(i.binding),e.writeString(i.name),e.writeNumber(i.members.length);for(var r,n=t(i.members);!(r=n()).done;)Sn(e,r.value);e.writeNumber(i.count)}function yn(e,t){var i;t.set=e.readNumber(),t.binding=e.readNumber(),t.name=e.readString(),i=e.readNumber(),t.members.length=i;for(var r=0;r!==i;++r){var n=new gi;Tn(e,n),t.members[r]=n}t.count=e.readNumber()}function An(e,t){t.binding=e.readNumber(),t.descriptorType=e.readNumber(),t.count=e.readNumber(),t.stageFlags=e.readNumber()}e("aE",kr),function(e){e[e.PER_INSTANCE=0]="PER_INSTANCE",e[e.PER_BATCH=1]="PER_BATCH",e[e.PER_PHASE=2]="PER_PHASE",e[e.PER_PASS=3]="PER_PASS",e[e.COUNT=4]="COUNT"}(kr||e("aE",kr={})),e("b5",Hr),function(e){e[e.CONSTANTS=0]="CONSTANTS",e[e.CBV=1]="CBV",e[e.UAV=2]="UAV",e[e.SRV=3]="SRV",e[e.TABLE=4]="TABLE",e[e.SSV=5]="SSV"}(Hr||e("b5",Hr={})),e("ag",Vr),function(e){e[e.MANAGED=0]="MANAGED",e[e.MEMORYLESS=1]="MEMORYLESS",e[e.PERSISTENT=2]="PERSISTENT",e[e.EXTERNAL=3]="EXTERNAL",e[e.BACKBUFFER=4]="BACKBUFFER"}(Vr||e("ag",Vr={})),e("ah",Gr),function(e){e[e.NONE=0]="NONE",e[e.OPAQUE=1]="OPAQUE",e[e.MASK=2]="MASK",e[e.BLEND=3]="BLEND",e[e.RENDER_OPAQUE=1]="RENDER_OPAQUE",e[e.RENDER_CUTOUT=2]="RENDER_CUTOUT",e[e.RENDER_TRANSPARENT=3]="RENDER_TRANSPARENT"}(Gr||e("ah",Gr={})),e("aA",Wr),function(e){e[e.BUFFER=0]="BUFFER",e[e.TEXTURE1D=1]="TEXTURE1D",e[e.TEXTURE2D=2]="TEXTURE2D",e[e.TEXTURE3D=3]="TEXTURE3D"}(Wr||e("aA",Wr={})),e("aB",zr),function(e){e[e.NONE=0]="NONE",e[e.UNIFORM=1]="UNIFORM",e[e.INDIRECT=2]="INDIRECT",e[e.STORAGE=4]="STORAGE",e[e.SAMPLED=8]="SAMPLED",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT",e[e.SHADING_RATE=128]="SHADING_RATE"}(zr||e("aB",zr={})),e("aC",Qr),function(e){e[e.SYNC=0]="SYNC",e[e.ASYNC=1]="ASYNC"}(Qr||e("aC",Qr={})),e("aj",jr),function(e){e[e.NONE=0]="NONE",e[e.OPAQUE=1]="OPAQUE",e[e.MASK=2]="MASK",e[e.BLEND=4]="BLEND",e[e.OPAQUE_OBJECT=1]="OPAQUE_OBJECT",e[e.CUTOUT_OBJECT=2]="CUTOUT_OBJECT",e[e.TRANSPARENT_OBJECT=4]="TRANSPARENT_OBJECT",e[e.SHADOW_CASTER=8]="SHADOW_CASTER",e[e.UI=16]="UI",e[e.DEFAULT_LIGHTING=32]="DEFAULT_LIGHTING",e[e.VOLUMETRIC_LIGHTING=64]="VOLUMETRIC_LIGHTING",e[e.CLUSTERED_LIGHTING=128]="CLUSTERED_LIGHTING",e[e.PLANAR_SHADOW=256]="PLANAR_SHADOW",e[e.GEOMETRY=512]="GEOMETRY",e[e.PROFILER=1024]="PROFILER",e[e.DRAW_INSTANCING=2048]="DRAW_INSTANCING",e[e.DRAW_NON_INSTANCING=4096]="DRAW_NON_INSTANCING",e[e.REFLECTION_PROBE=8192]="REFLECTION_PROBE",e[e.ALL=4294967295]="ALL"}(jr||e("aj",jr={})),e("b9",Yr),function(e){e[e.NONE=0]="NONE",e[e.DEFAULT=1]="DEFAULT",e[e.CLUSTERED=2]="CLUSTERED"}(Yr||e("b9",Yr={})),e("al",Kr),function(e){e[e.RENDER_TARGET=0]="RENDER_TARGET",e[e.DEPTH_STENCIL=1]="DEPTH_STENCIL",e[e.SHADING_RATE=2]="SHADING_RATE"}(Kr||e("al",Kr={})),e("ap",Xr),function(e){e[e.READ=0]="READ",e[e.READ_WRITE=1]="READ_WRITE",e[e.WRITE=2]="WRITE"}(Xr||e("ap",Xr={})),e("az",qr),function(e){e[e.NONE=0]="NONE",e[e.FLOAT_TYPE=1]="FLOAT_TYPE",e[e.INT_TYPE=2]="INT_TYPE"}(qr||e("az",qr={}));var Rn,On=e("ai",(function(e,t){void 0===e&&(e=null),void 0===t&&(t=0),this.light=void 0,this.level=void 0,this.light=e,this.level=t}));e("b0",Rn),function(e){e[e.UNIFORM_BUFFER=0]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=1]="DYNAMIC_UNIFORM_BUFFER",e[e.SAMPLER_TEXTURE=2]="SAMPLER_TEXTURE",e[e.SAMPLER=3]="SAMPLER",e[e.TEXTURE=4]="TEXTURE",e[e.STORAGE_BUFFER=5]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=6]="DYNAMIC_STORAGE_BUFFER",e[e.STORAGE_IMAGE=7]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=8]="INPUT_ATTACHMENT"}(Rn||e("b0",Rn={}));var bn,Nn=e("bm",(function(e){void 0===e&&(e=vi.UNKNOWN),this.type=void 0,this.count=1,this.type=e}));e("bn",(function(){this.descriptors=new Map,this.uniformBlocks=new Map,this.capacity=0,this.count=0})),e("b4",(function(){this.descriptorNames=[],this.uniformBlockNames=[],this.descriptors=[],this.uniformBlocks=[],this.capacity=0,this.count=0})),e("bo",(function(e,t,i,r){void 0===e&&(e=kr.PER_INSTANCE),void 0===t&&(t=Hr.CONSTANTS),void 0===i&&(i=Rn.UNIFORM_BUFFER),void 0===r&&(r=Ei.NONE),this.updateFrequency=void 0,this.parameterType=void 0,this.descriptorType=void 0,this.visibility=void 0,this.updateFrequency=e,this.parameterType=t,this.descriptorType=i,this.visibility=r})),e("bp",bn),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL"}(bn||e("bp",bn={})),e("bq",(function(e,t,i,r,n){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=bn.NONE),void 0===r&&(r=Si.SAMPLE_ZERO),void 0===n&&(n=Si.SAMPLE_ZERO),this.source=void 0,this.target=void 0,this.resolveFlags=void 0,this.mode=void 0,this.mode1=void 0,this.source=e,this.target=t,this.resolveFlags=i,this.mode=r,this.mode1=n})),e("aO",(function(e,t,i,r,n,a,s,o,h,u){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===o&&(o=0),void 0===h&&(h=0),void 0===u&&(u=0),this.source=void 0,this.target=void 0,this.mipLevels=void 0,this.numSlices=void 0,this.sourceMostDetailedMip=void 0,this.sourceFirstSlice=void 0,this.sourcePlaneSlice=void 0,this.targetMostDetailedMip=void 0,this.targetFirstSlice=void 0,this.targetPlaneSlice=void 0,this.source=e,this.target=t,this.mipLevels=i,this.numSlices=r,this.sourceMostDetailedMip=n,this.sourceFirstSlice=a,this.sourcePlaneSlice=s,this.targetMostDetailedMip=o,this.targetFirstSlice=h,this.targetPlaneSlice=u}));var In=e("br",(function(e,t,i,r,n,a,s){void 0===e&&(e=new Uint8Array(0)),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===a&&(a=0),void 0===s&&(s=0),this.source=void 0,this.target=void 0,this.mipLevels=void 0,this.numSlices=void 0,this.targetMostDetailedMip=void 0,this.targetFirstSlice=void 0,this.targetPlaneSlice=void 0,this.source=e,this.target=t,this.mipLevels=i,this.numSlices=r,this.targetMostDetailedMip=n,this.targetFirstSlice=a,this.targetPlaneSlice=s}));function Dn(e,t){e.writeNumber(t.type),e.writeNumber(t.count)}function Pn(e,t){t.type=e.readNumber(),t.count=e.readNumber()}e("bs",(function(e,t,i,r,n,a,s){void 0===e&&(e=""),void 0===t&&(t=""),void 0===i&&(i=4294967295),void 0===r&&(r=4294967295),void 0===n&&(n=0),void 0===a&&(a=0),void 0===s&&(s=0),this.source=void 0,this.target=void 0,this.mipLevels=void 0,this.numSlices=void 0,this.targetMostDetailedMip=void 0,this.targetFirstSlice=void 0,this.targetPlaneSlice=void 0,this.source=e,this.target=t,this.mipLevels=i,this.numSlices=r,this.targetMostDetailedMip=n,this.targetFirstSlice=a,this.targetPlaneSlice=s})),e("bt",(function(){this.numRenderPasses=0,this.numManagedTextures=0,this.totalManagedTextures=0,this.numUploadBuffers=0,this.numUploadBufferViews=0,this.numFreeUploadBuffers=0,this.numFreeUploadBufferViews=0,this.numDescriptorSets=0,this.numFreeDescriptorSets=0,this.numInstancingBuffers=0,this.numInstancingUniformBlocks=0}));var Cn,Ln=e("bc",{NONE:0,VERTEX_COLOR:1,VERTEX_NORMAL:2,VERTEX_TANGENT:3,WORLD_POS:4,VERTEX_MIRROR:5,FACE_SIDE:6,UV0:7,UV1:8,UV_LIGHTMAP:9,PROJ_DEPTH:10,LINEAR_DEPTH:11,FRAGMENT_NORMAL:12,FRAGMENT_TANGENT:13,FRAGMENT_BINORMAL:14,BASE_COLOR:15,DIFFUSE_COLOR:16,SPECULAR_COLOR:17,TRANSPARENCY:18,METALLIC:19,ROUGHNESS:20,SPECULAR_INTENSITY:21,IOR:22,DIRECT_DIFFUSE:23,DIRECT_SPECULAR:24,DIRECT_ALL:25,ENV_DIFFUSE:26,ENV_SPECULAR:27,ENV_ALL:28,EMISSIVE:29,LIGHT_MAP:30,SHADOW:31,AO:32,FRESNEL:33,DIRECT_TRANSMIT_DIFFUSE:34,DIRECT_TRANSMIT_SPECULAR:35,ENV_TRANSMIT_DIFFUSE:36,ENV_TRANSMIT_SPECULAR:37,TRANSMIT_ALL:38,DIRECT_TRT:39,ENV_TRT:40,TRT_ALL:41,FOG:42}),Fn=e("b8",{DIRECT_DIFFUSE:0,DIRECT_SPECULAR:1,ENV_DIFFUSE:2,ENV_SPECULAR:3,EMISSIVE:4,LIGHT_MAP:5,SHADOW:6,AO:7,NORMAL_MAP:8,FOG:9,TONE_MAPPING:10,GAMMA_CORRECTION:11,FRESNEL:12,TRANSMIT_DIFFUSE:13,TRANSMIT_SPECULAR:14,TRT:15,TT:16,MAX_BIT_COUNT:17}),Mn=e("Y",function(){function e(){this._singleMode=Ln.NONE,this._compositeModeValue=0,this._lightingWithAlbedo=!0,this._csmLayerColoration=!1,this._activate()}var t=e.prototype;return t.isCompositeModeEnabled=function(e){return 0!=(this._compositeModeValue&1<<e)},t.enableCompositeMode=function(e,t){this._enableCompositeMode(e,t),this._updatePipeline()},t.enableAllCompositeMode=function(e){this._enableAllCompositeMode(e),this._updatePipeline()},t.isEnabled=function(){return 0!==this._getType()},t.reset=function(){this._activate(),this._updatePipeline()},t._activate=function(){this._singleMode=Ln.NONE,this._enableAllCompositeMode(!0),this._lightingWithAlbedo=!0,this._csmLayerColoration=!1},t._updatePipeline=function(){var e=a.director.root,t=e.pipeline,i=this._getType();t.macros.CC_USE_DEBUG_VIEW!==i&&(t.macros.CC_USE_DEBUG_VIEW=i,e.onGlobalPipelineStateChanged())},t._enableCompositeMode=function(e,t){t?this._compositeModeValue|=1<<e:this._compositeModeValue&=~(1<<e)},t._enableAllCompositeMode=function(e){for(var t=0;t<Fn.MAX_BIT_COUNT;t++)e?this._compositeModeValue|=1<<t:this._compositeModeValue&=~(1<<t)},t._getType=function(){if(this._singleMode!==Ln.NONE)return 1;if(!0!==this._lightingWithAlbedo||!1!==this._csmLayerColoration)return 2;for(var e=0;e<Fn.MAX_BIT_COUNT;e++)if(!this.isCompositeModeEnabled(e))return 2;return 0},l(e,[{key:"singleMode",get:function(){return this._singleMode},set:function(e){this._singleMode=e,this._updatePipeline()}},{key:"lightingWithAlbedo",get:function(){return this._lightingWithAlbedo},set:function(e){this._lightingWithAlbedo=e,this._updatePipeline()}},{key:"csmLayerColoration",get:function(){return this._csmLayerColoration},set:function(e){this._csmLayerColoration=e,this._updatePipeline()}}]),e}()),Bn=new f(0,0,0,.5,.5,.5),xn=new f;function Un(e){var t=e.getMacroBool("CC_USE_FLOAT_OUTPUT");return e.pipelineSceneData.isHDR&&t&&Ft(e.device)?ni.RGBA16F:ni.RGBA8}function kn(e,t){var i=e.pipelineSceneData,r=i.validPunctualLights;r.length=0;for(var n=T.create(0,0,0,1),a=t.scene.spotLights,s=0;s<a.length;s++){var o=a[s];o.baked&&!t.node.scene.globals.disableLightmap||(T.set(n,o.position.x,o.position.y,o.position.z,o.range),y.sphereFrustum(n,t.frustum)&&r.push(o))}for(var h=t.scene.sphereLights,u=0;u<h.length;u++){var l=h[u];l.baked&&!t.node.scene.globals.disableLightmap||(T.set(n,l.position.x,l.position.y,l.position.z,l.range),y.sphereFrustum(n,t.frustum)&&r.push(l))}for(var c=t.scene.pointLights,d=0;d<c.length;d++){var _=c[d];_.baked||(T.set(n,_.position.x,_.position.y,_.position.z,_.range),y.sphereFrustum(n,t.frustum)&&r.push(_))}for(var p=t.scene.rangedDirLights,g=0;g<p.length;g++){var m=p[g];f.transform(xn,Bn,m.node.getWorldMatrix()),y.aabbFrustum(xn,t.frustum)&&r.push(m)}i.validPunctualLights=r}!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA",e[e.FXAAHQ=2]="FXAAHQ"}(Cn||(Cn={}));var Hn=[];function Vn(e){return Hn.includes(e)||Hn.push(e),Hn.indexOf(e)}function Gn(e,t){var i=Ai.CLEAR;return e&Jt.COLOR||t!==Kr.RENDER_TARGET||(i=e&Er?Ai.CLEAR:Ai.LOAD),(e&Jt.DEPTH_STENCIL)!==Jt.DEPTH_STENCIL&&t===Kr.DEPTH_STENCIL&&(e&Jt.DEPTH||(i=Ai.LOAD),e&Jt.STENCIL||(i=Ai.LOAD)),i}function Wn(e,t,i,r,n,s){void 0===r&&(r=null),void 0===n&&(n=0),s=s||new wi;var o=e?e.viewport:new wi(0,0,1,1),h=t,u=i;if(s.x=o.x*h,s.y=o.y*u,s.width=o.width*h,s.height=o.height*u,r)switch(r.type){case Lr.DIRECTIONAL:var l=r;if(l.shadowFixedArea||l.csmLevel===De.LEVEL_1)s.x=0,s.y=0,s.width=h,s.height=u;else{var c=a.director.root.device.capabilities.screenSpaceSignY;s.x=n%2*.5*h,s.y=c>0?.5*(1-Math.floor(n/2))*u:.5*Math.floor(n/2)*u,s.width=.5*h,s.height=.5*u}break;case Lr.SPOT:s.x=0,s.y=0,s.width=h,s.height=u}return s}var zn,Qn,jn=function(){var e=t.prototype;function t(){this._init()}return e._updateFxaaPass=function(){if(this.fxaaMaterial){var e=this.fxaaMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},e._init=function(){if(!this.fxaaMaterial){this.fxaaMaterial=new Le,this.fxaaMaterial._uuid="builtin-fxaa-material",this.fxaaMaterial.initialize({effectName:"pipeline/post-process/fxaa-hq"});for(var e=0;e<this.fxaaMaterial.passes.length;++e)this.fxaaMaterial.passes[e].tryCompile();this._updateFxaaPass()}},t}(),Yn=null,Kn=function(){var e=t.prototype;function t(){this.threshold=.1,this.iterations=2,this.intensity=.8,this._init()}return e._updateBloomPass=function(){if(this.bloomMaterial){var e=this.bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var i=this.bloomMaterial.passes[1+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently();var r=this.bloomMaterial.passes[7+t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}var n=this.bloomMaterial.passes[13];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}},e._init=function(){if(!this.bloomMaterial){this.bloomMaterial=new Le,this.bloomMaterial._uuid="builtin-bloom-material",this.bloomMaterial.initialize({effectName:"pipeline/post-process/bloom"});for(var e=0;e<this.bloomMaterial.passes.length;++e)this.bloomMaterial.passes[e].tryCompile();this._updateBloomPass()}},t}(),Xn=null,qn=e("aq",function(){function e(e){void 0===e&&(e=Cn.NONE),this.antiAliasing=Cn.NONE,this.antiAliasing=e,this._init()}return e.prototype._init=function(){this.postMaterial=new Le,this.postMaterial.name="builtin-post-process-material",this.postMaterial.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this.antiAliasing}});for(var e=0;e<this.postMaterial.passes.length;++e)this.postMaterial.passes[e].tryCompile()},e}());function Zn(e,t,i,r,n,a,s){var o=a,h=s,u=Wn(i,a,s,r,n);a=u.width,s=u.height;var l=t.device,c=e;if(!t.containsResource(c)){var d=Lt(l)?ni.R32F:ni.RGBA8;t.addRenderTarget(c,d,o,h,Vr.MANAGED),t.addDepthStencil(c+"Depth",ni.DEPTH_STENCIL,o,h,Vr.MANAGED)}t.updateRenderTarget(c,o,h),t.updateDepthStencil(c+"Depth",o,h),n||((Qn=t.addRenderPass(a,s,"default")).name=e,Qn.setViewport(new yi(0,0,o,h)),Qn.addRenderTarget(c,Ai.CLEAR,Ri.STORE,new ei(1,1,1,i.clearColor.w)),Qn.addDepthStencil(c+"Depth",Ai.CLEAR,Ri.DISCARD,i.clearDepth,i.clearStencil,Jt.DEPTH_STENCIL));var _=Qn.addQueue(Gr.RENDER_OPAQUE,"shadow-caster");_.addSceneOfCamera(i,new On(r,n),jr.SHADOW_CASTER),_.setViewport(new yi(u.x,u.y,u.width,u.height))}function Jn(e,t,i,r,n){var s="Camera"+n,o=i.renderArea(),h=o.x,l=o.y,d=i.camera,_="reflectionProbePassColor"+s,p="reflectionProbePassDS"+s;t.containsResource(_)||(t.addRenderWindow(_,ni.RGBA8,h,l,r),t.addDepthStencil(p,ni.DEPTH_STENCIL,h,l,Vr.EXTERNAL)),t.updateRenderWindow(_,r),t.updateDepthStencil(p,h,l);var f=t.addRenderPass(h,l,"default");f.name="ReflectionProbePass"+n,f.setViewport(new yi(0,0,h,l)),f.addRenderTarget(_,Gn(d.clearFlag,Kr.RENDER_TARGET),Ri.STORE,new ei(d.clearColor.x,d.clearColor.y,d.clearColor.z,d.clearColor.w)),f.addDepthStencil(p,Gn(d.clearFlag,Kr.DEPTH_STENCIL),Ri.STORE,d.clearDepth,d.clearStencil,d.clearFlag);var g=f.addQueue(Gr.RENDER_OPAQUE);g.addSceneOfCamera(e,new On,jr.REFLECTION_PROBE),function(e,t,i){var r=a.director.root.pipeline,n=i.pipelineSceneData,s=n.skybox;e.addConstant("CCCamera"),e.setMat4("cc_matView",t.matView),e.setMat4("cc_matViewInv",t.node.worldMatrix),e.setMat4("cc_matProj",t.matProj),e.setMat4("cc_matProjInv",t.matProjInv),e.setMat4("cc_matViewProj",t.matViewProj),e.setMat4("cc_matViewProjInv",t.matViewProjInv),e.setVec4("cc_cameraPos",new u(t.position.x,t.position.y,t.position.z,r.getCombineSignY())),e.setVec4("cc_surfaceTransform",new u(t.surfaceTransform,0,Math.cos(c(s.getRotationAngle())),Math.sin(c(s.getRotationAngle())))),e.setVec4("cc_screenScale",new u(n.shadingScale,n.shadingScale,1/n.shadingScale,1/n.shadingScale)),e.setVec4("cc_exposure",new u(t.exposure,1/t.exposure,n.isHDR?1:0,1/Tr.standardExposureValue))}(g,d,t)}function $n(e,t,i){kn(i,t);var r=i,n=r.pipelineSceneData.shadows,a=i.pipelineSceneData.validPunctualLights;ea.reset();var s=i.pipelineSceneData.shadows;if(!n.enabled||n.type!==Re.ShadowMap)return ea;ea.shadowEnabled=!0;for(var o=0,h=0;o<n.maxReceived&&h<a.length;){var u=a[h];u.type===Lr.SPOT&&u.shadowEnabled&&(ea.validLights.push(u),o++),h++}var l=t.scene.mainLight,c=s.size.x,d=s.size.y;if(l&&l.shadowEnabled)if(ea.mainLightShadowNames[0]="MainLightShadow"+e,l.shadowFixedArea)Zn(ea.mainLightShadowNames[0],i,t,l,0,c,d);else{var _=r.pipelineSceneData.csmSupported?l.csmLevel:1;ea.mainLightShadowNames[0]="MainLightShadow"+e;for(var p=0;p<_;p++)Zn(ea.mainLightShadowNames[0],i,t,l,p,c,d)}for(var f=0;f<ea.validLights.length;f++){var g=ea.validLights[f],m="SpotLightShadow"+f.toString()+e;ea.spotLightShadowNames[f]=m,Zn(m,i,t,g,0,c,d)}return ea}var ea=new(e("ad",function(){function e(){this.shadowEnabled=!1,this.mainLightShadowNames=new Array,this.spotLightShadowNames=new Array,this.validLights=[]}return e.prototype.reset=function(){this.shadowEnabled=!1,this.mainLightShadowNames.length=0,this.spotLightShadowNames.length=0,this.validLights.length=0},e}()));function ta(e,t,i){!function(e,t,i){i instanceof Oi?e.bindBuffer(t,i):i instanceof bi?e.bindTexture(t,i):i instanceof Ni&&e.bindSampler(t,i)}(e,t,i)}function ia(e,i){for(var r,n=t(i.descriptorSetLayoutData.descriptorBlocks);!(r=n()).done;)for(var a=r.value,s=0;s!==a.descriptors.length;++s)if(e===a.descriptors[s].descriptorID)return a.offset+s;return-1}function ra(e){for(var i,r=a.director.root.pipeline.layoutGraph,n=r.vertices(),s=r.attributeIndex.get(e),o=t(n);!(i=o()).done;)for(var h,u=i.value,l=r.getLayout(u),c=t(l.descriptorSets);!(h=c()).done;){var d=h.value;d[0];for(var _,p=d[1],f=p.descriptorSetLayoutData.descriptorBlocks,g=t(f);!(_=g()).done;)for(var m,v=_.value,E=t(v.descriptors);!(m=E()).done;)if(m.value.descriptorID===s)return ia(s,p)}return-1}e("am",(function(){this.color=void 0,this.normal=void 0,this.emissive=void 0,this.ds=void 0})),e("an",function(){function e(e){this.enableCluster=void 0,this.enableCluster=e?1:0,this._init()}return e.prototype._init=function(){this.deferredLightingMaterial=new Le,this.deferredLightingMaterial.name="builtin-deferred-material",this.deferredLightingMaterial.initialize({effectName:"pipeline/deferred-lighting",defines:{CC_ENABLE_CLUSTERED_LIGHT_CULLING:this.enableCluster,CC_RECEIVE_SHADOW:1}});for(var e=0;e<this.deferredLightingMaterial.passes.length;++e)this.deferredLightingMaterial.passes[e].tryCompile()},e}());var na=new Map;function aa(e,i,r){void 0===r&&(r=!1);for(var n,s=e.constants,o=e.samplers,h=e.textures,u=a.director.root.device,l=oa(i),c=l.descriptorSet,d=t(s);!(n=d()).done;){var _=n.value,p=_[0],f=_[1],g=ia(p,l);if(-1!==g){var m=""+i+g,v=c.getBuffer(g),E=!0;if(v||r||(v=u.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,4*f.length,4*f.length)),E=!1),r){var S=na.get(m);S||(na.set(m,new Float32Array(f)),S=na.get(m)),S.set(f),v.update(S)}E||ta(c,g,v)}}for(var T,w=t(h);!(T=w()).done;){var y=T.value,A=y[0],R=y[1],O=ia(A,l);-1!==O&&(c.getTexture(O)&&!r||ta(c,O,R))}for(var b,N=t(o);!(b=N()).done;){var I=b.value,D=I[0],P=I[1],C=ia(D,l);-1!==C&&(c.getSampler(C)&&!r||ta(c,C,P))}}var sa=new Map;function oa(e){var t=sa.get(e);if(t)return t;var i=a.director.root.pipeline,r=i.layoutGraph.locateChild(i.layoutGraph.nullVertex(),e);A(4294967295!==r);var n=i.layoutGraph.getLayout(r).descriptorSets.get(kr.PER_PASS);return sa.set(e,n),n}var ha=[.0484,.187,.567,1.99,7.41],ua=[.1,.118,.113,.358,.078],la=new i,ca=new i,da=new u,_a=new u,pa=function(){var e=t.prototype;function t(){this.ssssFov=45/57.3,this.ssssWidth=.01,this.boundingBox=.4,this.ssssScale=3,this._v3SSSSStrength=new i(.48,.41,.28),this._v3SSSSFallOff=new i(1,.37,.3),this._kernel=[],this._init()}return e._gaussian=function(e,t,i){var r=i/(.001+this._v3SSSSFallOff.x);e.x=Math.exp(-r*r/(2*t))/(6.28*t);var n=i/(.001+this._v3SSSSFallOff.y);e.y=Math.exp(-n*n/(2*t))/(6.28*t);var a=i/(.001+this._v3SSSSFallOff.z);e.z=Math.exp(-a*a/(2*t))/(6.28*t)},e._profile=function(e,t){for(var i=0;i<5;i++)this._gaussian(ca,ha[i],t),ca.multiplyScalar(ua[i]),e.add(ca)},e._updateSampleCount=function(){for(var e=this._v3SSSSStrength,t=0;t<25;t++){var i=.25*t-3,r=i<0?-1:1;this._kernel[t].w=3*r*Math.abs(Math.pow(i,2))/Math.pow(3,2)}for(var n=0;n<25;n++){var a=((n>0?Math.abs(this._kernel[n].w-this._kernel[n-1].w):0)+(n<24?Math.abs(this._kernel[n].w-this._kernel[n+1].w):0))/2;la.set(0),this._profile(la,this._kernel[n].w),la.multiplyScalar(a),this._kernel[n].x=la.x,this._kernel[n].y=la.y,this._kernel[n].z=la.z}da.set(this._kernel[12]);for(var s=12;s>0;s--)_a.set(this._kernel[s-1]),this._kernel[s].set(_a);this._kernel[0].set(da),la.set(0);for(var o=0;o<25;o++)la.add3f(this._kernel[o].x,this._kernel[o].y,this._kernel[o].z);for(var h=0;h<25;h++)this._kernel[h].x/=la.x,this._kernel[h].y/=la.y,this._kernel[h].z/=la.z;this._kernel[0].x=1*(1-e.x)+e.x*this._kernel[0].x,this._kernel[0].y=1*(1-e.y)+e.y*this._kernel[0].y,this._kernel[0].z=1*(1-e.z)+e.z*this._kernel[0].z;for(var u=1;u<25;u++)this._kernel[u].x*=e.x,this._kernel[u].y*=e.y,this._kernel[u].z*=e.z},e._updateBlurPass=function(){if(this.ssssBlurMaterial){var e=this.ssssBlurMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();var t=this.ssssBlurMaterial.passes[1];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();var i=this.ssssBlurMaterial.passes[2];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}},e._init=function(){if(!this.ssssBlurMaterial){this.ssssBlurMaterial=new Le,this.ssssBlurMaterial._uuid="builtin-ssssBlur-material",this.ssssBlurMaterial.initialize({effectName:"pipeline/ssss-blur"});for(var e=0;e<this.ssssBlurMaterial.passes.length;++e)this.ssssBlurMaterial.passes[e].tryCompile();this._updateBlurPass();for(var t=0;t<25;t++)this._kernel[t]=new u;this._updateSampleCount()}},l(t,[{key:"ssssStrength",get:function(){return this._v3SSSSStrength},set:function(e){this._v3SSSSStrength=e,this._updateSampleCount()}},{key:"ssssFallOff",get:function(){return this._v3SSSSFallOff},set:function(e){this._v3SSSSFallOff=e,this._updateSampleCount()}},{key:"kernel",get:function(){return this._kernel}}]),t}(),fa=null;function ga(e){var t=e.pipelineSceneData;return t.skin.enabled&&null!==t.standardSkinModel}var ma=function(){function e(){this._init()}return e.prototype._init=function(){this.toneMappingMaterial=new Le,this.toneMappingMaterial.name="builtin-tone-mapping-material",this.toneMappingMaterial.initialize({effectName:"pipeline/tone-mapping"});for(var e=0;e<this.toneMappingMaterial.passes.length;++e)this.toneMappingMaterial.passes[e].tryCompile()},e}(),va=null;function Ea(e,i,r,n){var a=Vn(e),s=$n("Camera"+a,e,i),o=Wn(e,e.window.width,e.window.height),h=o.width,u=o.height,l=i.addRenderPass(h,u,"specular-pass");l.name="CameraSpecalurPass"+a,l.setViewport(new yi(o.x,o.y,h,u));for(var c,d=t(s.mainLightShadowNames);!(c=d()).done;){var _=c.value;i.containsResource(_)&&l.addTexture(_,"cc_shadowMap")}for(var p,f=t(s.spotLightShadowNames);!(p=f()).done;){var g=p.value;i.containsResource(g)&&l.addTexture(g,"cc_spotShadowMap")}return l.addRenderTarget(r,Ai.LOAD,Ri.STORE,new ei(e.clearColor.x,e.clearColor.y,e.clearColor.z,e.clearColor.w)),l.addDepthStencil(n,Ai.LOAD,Ri.STORE,e.clearDepth,e.clearStencil,e.clearFlag),l.addQueue(Gr.RENDER_OPAQUE,"default").addSceneOfCamera(e,new On,jr.TRANSPARENT_OBJECT|jr.DEFAULT_LIGHTING|jr.PLANAR_SHADOW|jr.CUTOUT_OBJECT|jr.DRAW_INSTANCING|jr.GEOMETRY),l.addQueue(Gr.RENDER_TRANSPARENT,"forward-add").addSceneOfCamera(e,new On,jr.TRANSPARENT_OBJECT|jr.DEFAULT_LIGHTING|jr.PLANAR_SHADOW|jr.CUTOUT_OBJECT|jr.DRAW_INSTANCING|jr.GEOMETRY),{rtName:r,dsName:n}}var Sa=function(){var e=t.prototype;function t(){this._uvDepthToEyePosParams=new u,this._radiusParam=new u,this._miscParam=new u,this._blurParam=new u,this._depthTexFullResolution=new g(1024),this._depthTexResolution=new g(1024),this._sceneScale=1,this._cameraFov=c(45),this._radiusScale=1,this._angleBiasDegree=10,this._aoStrength=1,this._blurSharpness=8,this._aoSaturation=1,this._randomDirAndJitter=[238,91,87,255,251,44,119,255,247,64,250,255,232,5,225,255,253,177,140,255,250,51,84,255,243,76,97,255,252,36,232,255,235,100,24,255,252,36,158,255,254,20,142,255,245,135,124,255,251,43,121,255,253,31,145,255,235,98,160,255,240,146,198,255],this._init(),this.update()}return e._init=function(){if(!this.hbaoMaterial){this.hbaoMaterial=new Le,this.hbaoMaterial.name="builtin-hbao-material",this.hbaoMaterial.initialize({effectName:"pipeline/post-process/hbao"});for(var e=0;e<this.hbaoMaterial.passes.length;++e)this.hbaoMaterial.passes[e].tryCompile();for(var t=Fe.PixelFormat.RGBA8888,i=new Uint8Array(64),r=0;r<this._randomDirAndJitter.length;r++)i[r]=this._randomDirAndJitter[r];var n=new Me({width:4,height:4,_data:i,_compressed:!1,format:t});this.randomTexture=new Fe,this.randomTexture.setFilters(Fe.Filter.NEAREST,Fe.Filter.NEAREST),this.randomTexture.setMipFilter(Fe.Filter.NONE),this.randomTexture.setWrapMode(Fe.WrapMode.REPEAT,Fe.WrapMode.REPEAT,Fe.WrapMode.REPEAT),this.randomTexture.image=n,this.hbaoMaterial.setProperty("RandomTex",this.randomTexture,0)}},e.update=function(){var e=this._radiusScale*this._sceneScale,t=e*e,i=-1/t,r=.1*Math.min(this._depthTexFullResolution.x,this._depthTexFullResolution.y);this._radiusParam.set(e,t,i,r);var n=new g(this._depthTexResolution.y/this._depthTexResolution.x,1),a=new g(n.x/Math.tan(.5*this._cameraFov),n.y/Math.tan(.5*this._cameraFov)),s=Math.tan(c(this._angleBiasDegree)),o=this._aoStrength;this._miscParam.set(a.x,a.y,s,o);var h=new g(2/a.x,-2/a.y),u=new g(-1/a.x,1/a.y);this._uvDepthToEyePosParams.set(h.x,h.y,u.x,u.y);var l=this._sceneScale/this._blurSharpness*1.6651092;this._blurParam.set(.11541560320000001,l,this._blurSharpness/8,this._aoSaturation)},l(t,[{key:"uvDepthToEyePosParams",get:function(){return this._uvDepthToEyePosParams}},{key:"radiusParam",get:function(){return this._radiusParam}},{key:"miscParam",get:function(){return this._miscParam}},{key:"blurParam",get:function(){return this._blurParam}},{key:"depthTexFullResolution",set:function(e){this._depthTexFullResolution.set(e)}},{key:"depthTexResolution",set:function(e){this._depthTexResolution.set(e)}},{key:"sceneScale",set:function(e){this._sceneScale=e}},{key:"cameraFov",set:function(e){this._cameraFov=e}},{key:"radiusScale",set:function(e){this._radiusScale=e}},{key:"angleBiasDegree",set:function(e){this._angleBiasDegree=e}},{key:"aoStrength",set:function(e){this._aoStrength=e}},{key:"blurSharpness",set:function(e){this._blurSharpness=e}},{key:"aoSaturation",set:function(e){this._aoSaturation=e}}]),t}(),Ta=null,wa=new g;function ya(e,t,i,r,n){if(!Ta)return{rtName:i,dsName:r};var a=Vn(e),s=Wn(e,e.window.width,e.window.height),o=s.width,h=s.height,u=new ei(0,0,0,e.clearColor.w),l="hbaoRTName"+a,c="hbaoBluredRTName"+a,d="blurx-pass",_="CameraHBAOBluredXPass"+a;n&&(c="hbaoRTName"+a,l="hbaoBluredRTName"+a,d="blury-pass",_="CameraHBAOBluredYPass"+a),t.containsResource(c)||t.addRenderTarget(c,ni.BGRA8,o,h,Vr.MANAGED),t.updateRenderTarget(c,o,h);var p=t.addRenderPass(o,h,d);if(p.name=_,p.setViewport(new yi(s.x,s.y,s.width,s.height)),t.containsResource(r)){var f=t,g=f.resourceGraph.vertex(r),m=f.resourceGraph.getSampler(g);m.minFilter=m.magFilter=si.POINT,m.mipFilter=si.NONE,m.addressU=m.addressV=oi.CLAMP,p.addTexture(r,"DepthTex")}if(t.containsResource(l)){var v=t,E=v.resourceGraph.vertex(l),S=v.resourceGraph.getSampler(E);S.minFilter=S.magFilter=si.LINEAR,S.mipFilter=si.NONE,S.addressU=S.addressV=oi.CLAMP,p.addTexture(l,"AOTexNearest")}p.addRenderTarget(c,Ai.LOAD,Ri.STORE,u);var T=n?2:1;return Ta.hbaoMaterial.setProperty("uvDepthToEyePosParams",Ta.uvDepthToEyePosParams,T),Ta.hbaoMaterial.setProperty("radiusParam",Ta.radiusParam,T),Ta.hbaoMaterial.setProperty("miscParam",Ta.miscParam,T),Ta.hbaoMaterial.setProperty("blurParam",Ta.blurParam,T),p.addQueue(Gr.RENDER_TRANSPARENT|Gr.RENDER_OPAQUE).addCameraQuad(e,Ta.hbaoMaterial,T,jr.NONE),{rtName:c,dsName:r}}function Aa(e,t,i,r,n){if(!Ta)return{rtName:i,dsName:r};var a=Vn(e),s=Wn(e,e.window.width,e.window.height),o=s.width,h=s.height,u=new ei(0,0,0,e.clearColor.w),l=n;t.containsResource(l)||t.addRenderTarget(l,Un(t),o,h,Vr.MANAGED),t.updateRenderTarget(l,o,h);var c=t.addRenderPass(o,h,"combine-pass");c.name="CameraHBAOCombinedPass"+a,c.setViewport(new yi(s.x,s.y,s.width,s.height));var d=i;if(t.containsResource(d)){var _=t,p=_.resourceGraph.vertex(d),f=_.resourceGraph.getSampler(p);f.minFilter=f.magFilter=si.LINEAR,f.mipFilter=si.NONE,f.addressU=f.addressV=oi.CLAMP,c.addTexture(d,"AOTexNearest")}return c.addRenderTarget(l,Ai.LOAD,Ri.STORE,u),Ta.hbaoMaterial.setProperty("uvDepthToEyePosParams",Ta.uvDepthToEyePosParams,3),Ta.hbaoMaterial.setProperty("radiusParam",Ta.radiusParam,3),Ta.hbaoMaterial.setProperty("miscParam",Ta.miscParam,3),Ta.hbaoMaterial.setProperty("blurParam",Ta.blurParam,3),c.addQueue(Gr.RENDER_TRANSPARENT|Gr.RENDER_OPAQUE).addCameraQuad(e,Ta.hbaoMaterial,3,jr.NONE),{rtName:l,dsName:r}}var Ra,Oa,ba,Na,Ia,Da=16,Pa=24,Ca=function(){var e=t.prototype;function t(){this.clusters_x_threads=16,this.clusters_y_threads=8,this.clusters_z_threads=1,this.dispatchX=1,this.dispatchY=1,this.dispatchZ=1,this._init()}return e._initMaterial=function(e,t){var i=new Le;i.name=e,i.initialize({effectName:t});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();return i},e._init=function(){this.clusterBuildCS=this._initMaterial("builtin-cluster-build-cs-material","pipeline/cluster-build"),this.clusterLightCullingCS=this._initMaterial("builtin-cluster-culling-cs-material","pipeline/cluster-culling"),this.dispatchX=Da/this.clusters_x_threads,this.dispatchY=8/this.clusters_y_threads,this.dispatchZ=Pa/this.clusters_z_threads},t}(),La=null,Fa=new ai(si.LINEAR,si.LINEAR,si.NONE,oi.CLAMP,oi.CLAMP,oi.CLAMP),Ma=new ai(si.POINT,si.POINT,si.NONE,oi.CLAMP,oi.CLAMP,oi.CLAMP),Ba=e("b7",function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e,this._linearSampler=this._device.getSampler(Fa),this._pointSampler=this._device.getSampler(Ma);var t=new Ii(Bt.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new di(this._descriptorSetLayout))}var t=e.prototype;return t.regenLayout=function(){var e=new Ii(Bt.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new di(this._descriptorSetLayout))},t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindBuffer(e,t),r=i.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindSampler(e,t),r=i.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var i=this._descriptorSetMap.values(),r=i.next();!r.done;)r.value.bindTexture(e,t),r=i.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var i=vt()?oa("default").descriptorSet:this._globalDescriptorSet,r=t.createDescriptorSet(new di(vt()?oa("default").descriptorSetLayout:this._descriptorSetLayout));this._descriptorSetMap.set(e,r);for(var n=Mt.UBO_GLOBAL;n<Mt.COUNT;n++)r.bindBuffer(n,i.getBuffer(n)),r.bindSampler(n,i.getSampler(n)),r.bindTexture(n,i.getTexture(n));var a=t.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,Ct.SIZE,Ct.SIZE)),s=vt()?ra("CCShadow"):Ct.BINDING;r.bindBuffer(s,a),r.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},l(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet},set:function(e){this._globalDescriptorSet=e}}]),e}()),xa=new r,Ua=new r,ka=new r,Ha=new u,Va=new u(0,0,1,0),Ga=new i,Wa=e("ba",function(){function e(){this._globalUBO=new Float32Array(xt.COUNT),this._cameraUBO=new Float32Array(Ut.COUNT),this._shadowUBO=new Float32Array(Ct.COUNT),this._csmUBO=new Float32Array(kt.COUNT)}e.updateGlobalUBOView=function(e,t){var i=a.director,r=i.root,n=t,s=Math.floor(e.width),o=Math.floor(e.height);n[xt.TIME_OFFSET]=r.cumulativeTime,n[xt.TIME_OFFSET+1]=r.frameTime,n[xt.TIME_OFFSET+2]=i.getTotalFrames(),n[xt.TIME_OFFSET+3]=r.cumulativeTime-Math.floor(r.frameTime),n[xt.SCREEN_SIZE_OFFSET]=s,n[xt.SCREEN_SIZE_OFFSET+1]=o,n[xt.SCREEN_SIZE_OFFSET+2]=1/s,n[xt.SCREEN_SIZE_OFFSET+3]=1/o,n[xt.NATIVE_SIZE_OFFSET]=s,n[xt.NATIVE_SIZE_OFFSET+1]=o,n[xt.NATIVE_SIZE_OFFSET+2]=1/n[xt.NATIVE_SIZE_OFFSET],n[xt.NATIVE_SIZE_OFFSET+3]=1/n[xt.NATIVE_SIZE_OFFSET+1],a.internal.reflectionProbeManager&&(n[xt.PROBE_INFO_OFFSET]=a.internal.reflectionProbeManager.getMaxProbeId()+1);var h=r.debugView;n[xt.DEBUG_VIEW_MODE_OFFSET]=h.singleMode;for(var u=1;u<=3;u++)n[xt.DEBUG_VIEW_MODE_OFFSET+u]=0;for(var l=Fn.DIRECT_DIFFUSE;l<Fn.MAX_BIT_COUNT;l++){var c=l>>3,d=l%8;n[xt.DEBUG_VIEW_MODE_OFFSET+1+c]+=(h.isCompositeModeEnabled(l)?1:0)*Math.pow(10,d)}n[xt.DEBUG_VIEW_MODE_OFFSET+3]+=(h.lightingWithAlbedo?1:0)*Math.pow(10,6),n[xt.DEBUG_VIEW_MODE_OFFSET+3]+=(h.csmLayerColoration?1:0)*Math.pow(10,7)},e.updateCameraUBOView=function(e,t,n){var s,o=(n.scene?n.scene:a.director.getScene().renderScene).mainLight,h=e.pipelineSceneData,l=h.ambient,d=h.skybox,_=h.fog,p=h.shadows,f=t,g=n.exposure,m=h.isHDR;if(f[Ut.SCREEN_SCALE_OFFSET]=h.shadingScale,f[Ut.SCREEN_SCALE_OFFSET+1]=h.shadingScale,f[Ut.SCREEN_SCALE_OFFSET+2]=1/f[Ut.SCREEN_SCALE_OFFSET],f[Ut.SCREEN_SCALE_OFFSET+3]=1/f[Ut.SCREEN_SCALE_OFFSET+1],f[Ut.EXPOSURE_OFFSET]=g,f[Ut.EXPOSURE_OFFSET+1]=1/g,f[Ut.EXPOSURE_OFFSET+2]=m?1:0,f[Ut.EXPOSURE_OFFSET+3]=1/Tr.standardExposureValue,o){var v=o.shadowEnabled&&p.type===Re.ShadowMap?1:0,E=o.direction;if(Va.set(E.x,E.y,E.z,v),u.toArray(f,Va,Ut.MAIN_LIT_DIR_OFFSET),i.toArray(f,o.color,Ut.MAIN_LIT_COLOR_OFFSET),o.useColorTemperature){var S=o.colorTemperatureRGB;f[Ut.MAIN_LIT_COLOR_OFFSET]*=S.x,f[Ut.MAIN_LIT_COLOR_OFFSET+1]*=S.y,f[Ut.MAIN_LIT_COLOR_OFFSET+2]*=S.z}f[Ut.MAIN_LIT_COLOR_OFFSET+3]=m?o.illuminance*g:o.illuminance}else Va.set(0,0,1,0),u.toArray(f,Va,Ut.MAIN_LIT_DIR_OFFSET),u.toArray(f,u.ZERO,Ut.MAIN_LIT_COLOR_OFFSET);var T=l.skyColor;T.w=m?l.skyIllum*g:l.skyIllum,f[Ut.AMBIENT_SKY_OFFSET+0]=T.x,f[Ut.AMBIENT_SKY_OFFSET+1]=T.y,f[Ut.AMBIENT_SKY_OFFSET+2]=T.z,f[Ut.AMBIENT_SKY_OFFSET+3]=T.w,f[Ut.AMBIENT_GROUND_OFFSET+0]=l.groundAlbedo.x,f[Ut.AMBIENT_GROUND_OFFSET+1]=l.groundAlbedo.y,f[Ut.AMBIENT_GROUND_OFFSET+2]=l.groundAlbedo.z,f[Ut.AMBIENT_GROUND_OFFSET+3]=d.envmap?null===(s=d.envmap)||void 0===s?void 0:s.mipmapLevel:1,r.toArray(f,n.matView,Ut.MAT_VIEW_OFFSET),r.toArray(f,n.node.worldMatrix,Ut.MAT_VIEW_INV_OFFSET),i.toArray(f,n.position,Ut.CAMERA_POS_OFFSET),r.toArray(f,n.matProj,Ut.MAT_PROJ_OFFSET),r.toArray(f,n.matProjInv,Ut.MAT_PROJ_INV_OFFSET),r.toArray(f,n.matViewProj,Ut.MAT_VIEW_PROJ_OFFSET),r.toArray(f,n.matViewProjInv,Ut.MAT_VIEW_PROJ_INV_OFFSET),f[Ut.CAMERA_POS_OFFSET+3]=this.getCombineSignY(),f[Ut.SURFACE_TRANSFORM_OFFSET]=n.surfaceTransform,f[Ut.SURFACE_TRANSFORM_OFFSET+1]=n.cameraUsage,f[Ut.SURFACE_TRANSFORM_OFFSET+2]=Math.cos(c(h.skybox.getRotationAngle())),f[Ut.SURFACE_TRANSFORM_OFFSET+3]=Math.sin(c(h.skybox.getRotationAngle()));var w=_.colorArray;f[Ut.GLOBAL_FOG_COLOR_OFFSET]=w.x,f[Ut.GLOBAL_FOG_COLOR_OFFSET+1]=w.y,f[Ut.GLOBAL_FOG_COLOR_OFFSET+2]=w.z,f[Ut.GLOBAL_FOG_COLOR_OFFSET+3]=w.z,f[Ut.GLOBAL_FOG_BASE_OFFSET]=_.fogStart,f[Ut.GLOBAL_FOG_BASE_OFFSET+1]=_.fogEnd,f[Ut.GLOBAL_FOG_BASE_OFFSET+2]=_.fogDensity,f[Ut.GLOBAL_FOG_ADD_OFFSET]=_.fogTop,f[Ut.GLOBAL_FOG_ADD_OFFSET+1]=_.fogRange,f[Ut.GLOBAL_FOG_ADD_OFFSET+2]=_.fogAtten,f[Ut.NEAR_FAR_OFFSET]=n.nearClip,f[Ut.NEAR_FAR_OFFSET+1]=n.farClip,f[Ut.NEAR_FAR_OFFSET+2]=n.getClipSpaceMinz(),f[Ut.VIEW_PORT_OFFSET]=h.shadingScale*n.window.width*n.viewport.x,f[Ut.VIEW_PORT_OFFSET+1]=h.shadingScale*n.window.height*n.viewport.y,f[Ut.VIEW_PORT_OFFSET+2]=h.shadingScale*n.window.width*n.viewport.z,f[Ut.VIEW_PORT_OFFSET+3]=h.shadingScale*n.window.height*n.viewport.w},e.getPCFRadius=function(e,t){var i=e.size.x;switch(t.shadowPcf){case Ie.HARD:return 0;case Ie.SOFT:return 1/(.5*i);case Ie.SOFT_2X:return 2/(.5*i);case Ie.SOFT_4X:return 3/(.5*i)}return 0},e.updatePlanarNormalAndDistance=function(e,t){i.normalize(Ga,e.normal),t[Ct.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Ga.x,t[Ct.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Ga.y,t[Ct.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Ga.z,t[Ct.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=-e.distance},e.updateShadowUBOView=function(t,i,n,a){var s=t.device,o=a.scene.mainLight,h=t.pipelineSceneData,l=h.shadows,c=h.csmLayers,d=i,_=n,p=h.csmSupported,f=Lt(s)?0:1;if(o&&l.enabled){if(l.type===Re.ShadowMap){if(o.shadowEnabled){if(o.shadowFixedArea||o.csmLevel===De.LEVEL_1||!p){var g=c.specialLayer.matShadowView,m=c.specialLayer.matShadowProj,E=c.specialLayer.matShadowViewProj,S=.1,T=0,w=0;o.shadowFixedArea?(S=o.shadowNear,T=o.shadowFar,w=0):(T=c.specialLayer.shadowCameraFar,w=1),r.toArray(d,g,Ct.MAT_LIGHT_VIEW_OFFSET),d[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=m.m10,d[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=m.m14,d[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=m.m11,d[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=m.m15,d[Ct.SHADOW_PROJ_INFO_OFFSET+0]=m.m00,d[Ct.SHADOW_PROJ_INFO_OFFSET+1]=m.m05,d[Ct.SHADOW_PROJ_INFO_OFFSET+2]=1/m.m00,d[Ct.SHADOW_PROJ_INFO_OFFSET+3]=1/m.m05,r.toArray(d,E,Ct.MAT_LIGHT_VIEW_PROJ_OFFSET),Ha.set(S,T,0,1-o.shadowSaturation),u.toArray(d,Ha,Ct.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Ha.set(Lr.DIRECTIONAL,f,o.shadowNormalBias,w),u.toArray(d,Ha,Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}else{for(var y=this.getPCFRadius(l,o),A=0;A<o.csmLevel;A++){var R=c.layers[A],O=R.matShadowView;Ha.set(O.m00,O.m04,O.m08,y),u.toArray(_,Ha,kt.CSM_VIEW_DIR_0_OFFSET+4*A),Ha.set(O.m01,O.m05,O.m09,R.splitCameraNear),u.toArray(_,Ha,kt.CSM_VIEW_DIR_1_OFFSET+4*A),Ha.set(O.m02,O.m06,O.m10,R.splitCameraFar),u.toArray(_,Ha,kt.CSM_VIEW_DIR_2_OFFSET+4*A);var b=R.csmAtlas;u.toArray(_,b,kt.CSM_ATLAS_OFFSET+4*A);var N=R.matShadowViewProj;r.toArray(_,N,kt.MAT_CSM_VIEW_PROJ_OFFSET+16*A);var I=R.matShadowProj;_[kt.CSM_PROJ_DEPTH_INFO_OFFSET+0+4*A]=I.m10,_[kt.CSM_PROJ_DEPTH_INFO_OFFSET+1+4*A]=I.m14,_[kt.CSM_PROJ_DEPTH_INFO_OFFSET+2+4*A]=I.m11,_[kt.CSM_PROJ_DEPTH_INFO_OFFSET+3+4*A]=I.m15,_[kt.CSM_PROJ_INFO_OFFSET+0+4*A]=I.m00,_[kt.CSM_PROJ_INFO_OFFSET+1+4*A]=I.m05,_[kt.CSM_PROJ_INFO_OFFSET+2+4*A]=1/I.m00,_[kt.CSM_PROJ_INFO_OFFSET+3+4*A]=1/I.m05}Ha.set(o.csmTransitionRange,0,0,0),u.toArray(_,Ha,kt.CSM_SPLITS_INFO_OFFSET),Ha.set(.1,o.shadowDistance,0,1-o.shadowSaturation),u.toArray(d,Ha,Ct.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Ha.set(Lr.DIRECTIONAL,f,o.shadowNormalBias,o.csmLevel),u.toArray(d,Ha,Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}Ha.set(l.size.x,l.size.y,o.shadowPcf,o.shadowBias),u.toArray(d,Ha,Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}}else e.updatePlanarNormalAndDistance(l,d);v.toArray(d,l.shadowColor,Ct.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,i,n){var a=e.device,s=e.pipelineSceneData,o=s.shadows,h=s.csmLayers,l=t,c=Lt(a)?0:1,d=e.device.capabilities,_=s.csmSupported;switch(i.type){case Lr.DIRECTIONAL:var p=i;if(o.enabled&&p&&p.shadowEnabled&&o.type===Re.ShadowMap){var f,g,m,E=.1,S=0,T=0;if(p.shadowFixedArea||p.csmLevel===De.LEVEL_1||!_)f=h.specialLayer.matShadowView,g=h.specialLayer.matShadowProj,m=h.specialLayer.matShadowViewProj,p.shadowFixedArea?(E=p.shadowNear,S=p.shadowFar,T=0):(E=.1,S=h.specialLayer.shadowCameraFar,T=1),Ha.set(Lr.DIRECTIONAL,c,p.shadowNormalBias,0),u.toArray(l,Ha,Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);else{var w=h.layers[n];f=w.matShadowView,g=w.matShadowProj,m=w.matShadowViewProj,E=w.splitCameraNear,S=w.splitCameraFar,T=p.csmLevel}r.toArray(l,f,Ct.MAT_LIGHT_VIEW_OFFSET),l[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=g.m10,l[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=g.m14,l[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=g.m11,l[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=g.m15,l[Ct.SHADOW_PROJ_INFO_OFFSET+0]=g.m00,l[Ct.SHADOW_PROJ_INFO_OFFSET+1]=g.m05,l[Ct.SHADOW_PROJ_INFO_OFFSET+2]=1/g.m00,l[Ct.SHADOW_PROJ_INFO_OFFSET+3]=1/g.m05,r.toArray(l,m,Ct.MAT_LIGHT_VIEW_PROJ_OFFSET),Ha.set(E,S,0,1-p.shadowSaturation),u.toArray(l,Ha,Ct.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Ha.set(Lr.DIRECTIONAL,c,p.shadowNormalBias,T),u.toArray(l,Ha,Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),Ha.set(o.size.x,o.size.y,p.shadowPcf,p.shadowBias),u.toArray(l,Ha,Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}break;case Lr.SPOT:var y=i;o.enabled&&y&&y.shadowEnabled&&(r.invert(xa,i.node.getWorldMatrix()),r.toArray(l,xa,Ct.MAT_LIGHT_VIEW_OFFSET),r.perspective(Ua,i.angle,1,.001,i.range,!0,d.clipSpaceMinZ,d.clipSpaceSignY,0),r.multiply(ka,Ua,xa),r.toArray(l,ka,Ct.MAT_LIGHT_VIEW_PROJ_OFFSET),Ha.set(.01,i.range,0,0),u.toArray(l,Ha,Ct.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Ha.set(o.size.x,o.size.y,y.shadowPcf,y.shadowBias),u.toArray(l,Ha,Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Ha.set(Lr.SPOT,c,y.shadowNormalBias,0),u.toArray(l,Ha,Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET))}v.toArray(l,o.shadowColor,Ct.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var i=this._pipeline.descriptorSet;if(!vt()){this._initCombineSignY();var r=e.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,xt.SIZE,xt.SIZE));i.bindBuffer(xt.BINDING,r);var n=e.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,Ut.SIZE,Ut.SIZE));i.bindBuffer(Ut.BINDING,n);var a=e.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,Ct.SIZE,Ct.SIZE)),s=vt()?ra("CCShadow"):Ct.BINDING;i.bindBuffer(s,a);var o=e.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,kt.SIZE,kt.SIZE)),h=vt()?ra("CCCSM"):kt.BINDING;i.bindBuffer(h,o)}},t.updateGlobalUBO=function(t){var i=this._pipeline.globalDSManager,r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;r.update(),e.updateGlobalUBOView(t,this._globalUBO),n[0].updateBuffer(r.getBuffer(xt.BINDING),this._globalUBO),i.bindBuffer(xt.BINDING,r.getBuffer(xt.BINDING)),i.update()},t.updateCameraUBO=function(t){var i=this._pipeline.globalDSManager,r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),n[0].updateBuffer(r.getBuffer(Ut.BINDING),this._cameraUBO),i.bindBuffer(Ut.BINDING,r.getBuffer(Ut.BINDING)),i.update()},t.updateShadowUBO=function(t){var i=this._pipeline.pipelineSceneData;if(i.shadows.enabled){var r=this._pipeline.descriptorSet,n=this._pipeline.commandBuffers,a=i.shadowFrameBufferMap,s=t.scene.mainLight;s&&a.has(s)&&r.bindTexture(Ht,a.get(s).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,this._csmUBO,t),r.update();var o=vt()?ra("CCShadow"):Ct.BINDING;n[0].updateBuffer(r.getBuffer(o),this._shadowUBO);var h=vt()?ra("CCCSM"):kt.BINDING;n[0].updateBuffer(r.getBuffer(h),this._csmUBO)}},t.updateShadowUBOLight=function(t,i,r){void 0===r&&(r=0),e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,i,r),t.bindTexture(Ht,Oe.get("default-texture").getGFXTexture()),t.bindTexture(Vt,Oe.get("default-texture").getGFXTexture()),t.update();var n=vt()?ra("CCShadow"):Ct.BINDING;this._pipeline.commandBuffers[0].updateBuffer(t.getBuffer(n),this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof r?r.toArray(this._shadowUBO,t,e):t instanceof v&&v.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}());Wa._combineSignY=0;var za,Qa,ja,Ya,Ka,Xa,qa,Za,Ja=e("A",b("RenderStage")((Oa=function(){function e(){this._name=ba&&ba(),this._priority=Na&&Na(),this._enabled=!0,this._tag=Ia&&Ia(),this._pipeline=void 0,this._flow=void 0}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},l(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),ba=N(Oa.prototype,"_name",[I],(function(){return""})),Na=N(Oa.prototype,"_priority",[I],(function(){return 0})),Ia=N(Oa.prototype,"_tag",[I],(function(){return 0})),Ra=Oa))||Ra);a.RenderStage=Ja;var $a,es=e("z",(za=b("RenderFlow"),Qa=D([Ja]),za((Ya=function(){function e(){this._name=Ka&&Ka(),this._priority=Xa&&Xa(),this._tag=qa&&qa(),this._stages=Za&&Za(),this._pipeline=void 0}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},l(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),Ka=N(Ya.prototype,"_name",[I],(function(){return""})),Xa=N(Ya.prototype,"_priority",[I],(function(){return 0})),qa=N(Ya.prototype,"_tag",[I],(function(){return 0})),Za=N(Ya.prototype,"_stages",[Qa,I],(function(){return[]})),ja=Ya))||ja));a.RenderFlow=es,e("X",$a),function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}($a||e("X",$a={}));var ts,is,rs,ns,as,ss,os,hs,us,ls,cs,ds,_s,ps,fs,gs,ms,vs,Es,Ss,Ts,ws,ys,As,Rs,Os,bs,Ns,Is,Ds,Ps,Cs,Ls,Fs,Ms,Bs,xs,Us,ks,Hs,Vs,Gs,Ws,zs,Qs,js,Ys,Ks,Xs,qs,Zs,Js,$s,eo,to,io,ro,no,ao,so,oo,ho,uo,lo,co,_o,po,fo,go,mo,vo,Eo,So,To,wo,yo,Ao,Ro,Oo,bo,No,Io,Do,Po,Co,Lo,Fo,Mo,Bo,xo,Uo=e("W",function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}S(t,e);var i=t.prototype;return i.on=function(e,t,i,r){return this.eventTargetOn(e,t,i,r)},i.once=function(e,t,i){return this.eventTargetOnce(e,t,i)},t}(P)),ko=new wi,Ho=new yi,Vo=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},Go=e("aJ",(function(){this.quadIB=null,this.quadVB=null,this.quadIA=null})),Wo=e("y",(ts=b("cc.RenderPipeline"),is=D([es]),ts((ns=function(e){function i(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._tag=as&&as(),t._flows=ss&&ss(),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new Uo,t._device=void 0,t._globalDSManager=void 0,t._descriptorSet=void 0,t._commandBuffers=[],t._pipelineUBO=new Wa,t._macros={},t._constantMacros="",t._profiler=null,t._geometryRenderer=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new wi,t._clusterEnabled=!1,t._bloomEnabled=!1,t}S(i,e);var r=i.prototype;return r.getPipelineRenderData=function(){return this._pipelineRenderData},r.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},r.createRenderPass=function(e,t,i){var r=this._device,n=new Di,a=new Pi;n.format=t,a.format=i,a.stencilStoreOp=Ri.DISCARD,a.depthStoreOp=Ri.DISCARD,e&Jt.COLOR||(e&Er?n.loadOp=Ai.CLEAR:(n.loadOp=Ai.LOAD,n.barrier=r.getGeneralBarrier(new Ci(Li.COLOR_ATTACHMENT_WRITE,Li.COLOR_ATTACHMENT_WRITE)))),(e&Jt.DEPTH_STENCIL)!==Jt.DEPTH_STENCIL&&(e&Jt.DEPTH||(a.depthLoadOp=Ai.LOAD),e&Jt.STENCIL||(a.stencilLoadOp=Ai.LOAD)),a.barrier=r.getGeneralBarrier(new Ci(Li.DEPTH_STENCIL_ATTACHMENT_WRITE,Li.DEPTH_STENCIL_ATTACHMENT_WRITE));var s=new Fi([n],a);return r.createRenderPass(s)},r.getRenderPass=function(e,i){var r=function(e){for(var i,r=666,n=t(e.colorTextures);!(i=n()).done;){var a=i.value,s=null==a?void 0:a.info,o=s.type+"_"+s.usage+"_"+s.format+"_"+s.width+"_"+s.height+"_"+s.flags+"_\n            "+s.layerCount+"_"+s.levelCount+"_"+s.samples+"_"+s.depth+"_"+s.externalRes;r=Mi(o,r)}if(e.depthStencilTexture){var h=e.depthStencilTexture.info,u=h.type+"_"+h.usage+"_"+h.format+"_"+h.width+"_"+h.height+"_"+h.flags+"_\n            "+h.layerCount+"_"+h.levelCount+"_"+h.samples+"_"+h.depth+"_"+h.externalRes;r=Mi(u,r)}return r}(i),n=Mi(r+"_"+e,666),a=this._renderPasses.get(n);return a||(a=this.createRenderPass(e,i.colorTextures[0].format,i.depthStencilTexture.format),this._renderPasses.set(n,a),a)},r.newFramebufferByRatio=function(e){for(var t=this.pipelineSceneData,i=this._width*t.shadingScale,r=this._height*t.shadingScale,n=e.colorTextures,a=0;a<n.length;a++)n[a].resize(i,r);e.depthStencilTexture&&e.depthStencilTexture.resize(i,r);var s=this._device.createFramebuffer(new Bi(e.renderPass,n,e.depthStencilTexture));return e.destroy(),s},r.generateRenderArea=function(e,t){var i=e.viewport,r=e.window.width,n=e.window.height;t.x=i.x*r,t.y=i.y*n,t.width=i.width*r,t.height=i.height*n},r.generateViewport=function(e,t){this.generateRenderArea(e,ko),t||(t=Ho);var i=this.pipelineSceneData.shadingScale;return t.left=ko.x*i,t.top=ko.y*i,t.width=ko.width*i,t.height=ko.height*i,t},r.generateScissor=function(e,t){t||(t=ko),this.generateRenderArea(e,t);var i=this.pipelineSceneData.shadingScale;return t.x*=i,t.y*=i,t.width*=i,t.height*=i,t},r.getMacroString=function(e){var t=this._macros[e];return void 0===t?"":t},r.getMacroInt=function(e){var t=this._macros[e];return void 0===t?0:t},r.getMacroBool=function(e){var t=this._macros[e];return void 0!==t&&t},r.setMacroString=function(e,t){this._macros[e]=t},r.setMacroInt=function(e,t){this._macros[e]=t},r.setMacroBool=function(e,t){this._macros[e]=t},r.activate=function(){this._device=gt.gfxDevice,this._generateConstantMacros(),this._globalDSManager=new Ba(this._device),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._macros.CC_USE_DEBUG_VIEW=0,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},r._ensureEnoughSize=function(){},r.render=function(e){if(0!==e.length){this.updateGeometryRenderer(e),this._commandBuffers[0].begin(),this.emit($a.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),xe(e);for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){this.emit($a.RENDER_CAMERA_BEGIN,i),vn(this,i),En(this,i),this._pipelineUBO.updateGlobalUBO(i.window),this._pipelineUBO.updateCameraUBO(i);for(var r=0;r<this._flows.length;r++)this._flows[r].render(i);this.emit($a.RENDER_CAMERA_END,i)}}this.emit($a.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},r._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},r._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var i=0;i<t.downsampleTexs.length;++i)t.downsampleTexs[i].destroy(),t.downsampleFramebuffers[i].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var r=0;r<t.upsampleTexs.length;++r)t.upsampleTexs[r].destroy(),t.upsampleFramebuffers[r].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},r._genQuadVertexData=function(e,t){var i=new Float32Array(16),r=t.x/this._width,n=(t.x+t.width)/this._width,a=t.y/this._height,s=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var o=s;s=a,a=o}var h=0;switch(e){case $t.IDENTITY:h=0,i[h++]=-1,i[h++]=-1,i[h++]=r,i[h++]=s,i[h++]=1,i[h++]=-1,i[h++]=n,i[h++]=s,i[h++]=-1,i[h++]=1,i[h++]=r,i[h++]=a,i[h++]=1,i[h++]=1,i[h++]=n,i[h++]=a;break;case $t.ROTATE_90:h=0,i[h++]=-1,i[h++]=-1,i[h++]=n,i[h++]=s,i[h++]=1,i[h++]=-1,i[h++]=n,i[h++]=a,i[h++]=-1,i[h++]=1,i[h++]=r,i[h++]=s,i[h++]=1,i[h++]=1,i[h++]=r,i[h++]=a;break;case $t.ROTATE_180:h=0,i[h++]=-1,i[h++]=-1,i[h++]=r,i[h++]=a,i[h++]=1,i[h++]=-1,i[h++]=n,i[h++]=a,i[h++]=-1,i[h++]=1,i[h++]=r,i[h++]=s,i[h++]=1,i[h++]=1,i[h++]=n,i[h++]=s;break;case $t.ROTATE_270:h=0,i[h++]=-1,i[h++]=-1,i[h++]=r,i[h++]=a,i[h++]=1,i[h++]=-1,i[h++]=r,i[h++]=s,i[h++]=-1,i[h++]=1,i[h++]=n,i[h++]=a,i[h++]=1,i[h++]=1,i[h++]=n,i[h++]=s}return i},r._createQuadInputAssembler=function(){var e=new Go,t=4*Float32Array.BYTES_PER_ELEMENT,i=4*t,r=this._device.createBuffer(new _i(pi.VERTEX|pi.TRANSFER_DST,fi.DEVICE|fi.HOST,i,t));if(!r)return e;var n=Uint8Array.BYTES_PER_ELEMENT,a=6*n,s=this._device.createBuffer(new _i(pi.INDEX|pi.TRANSFER_DST,fi.DEVICE,a,n));if(!s)return e;var o=new Uint8Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=1,o[4]=3,o[5]=2,s.update(o);var h=new Array(2);h[0]=new li("a_position",ni.RG32F),h[1]=new li("a_texCoord",ni.RG32F);var u=this._device.createInputAssembler(new xi(h,[r],s));return e.quadIB=s,e.quadVB=r,e.quadIA=u,e},r.updateQuadVertexData=function(e,t){var i=this._lastUsedRenderArea;if(i.x!==e.x||i.y!==e.y||i.width!==e.width||i.height!==e.height){var r=this._genQuadVertexData($t.IDENTITY,e);this._quadVBOffscreen.update(r);var n=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||$t.IDENTITY,e);this._quadVBOnscreen.update(n),i.copy(e)}},r.destroy=function(){for(var t,i,r=0;r<this._flows.length;r++)this._flows[r].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var n=0;n<this._commandBuffers.length;n++)this._commandBuffers[n].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(i=this._pipelineSceneData)||void 0===i||i.destroy(),e.prototype.destroy.call(this)},r.onGlobalPipelineStateChanged=function(){},r._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(ni.RGBA32F)&(Ui.RENDER_TARGET|Ui.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(hi.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(C.os===L.ANDROID&&C.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(O.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",e+="#define CC_JOINT_UNIFORM_CAPACITY "+Gt.JOINT_UNIFORM_CAPACITY+"\n",this._constantMacros=e},r.updateGeometryRenderer=function(e){if(!this._geometryRenderer)for(var t=0;t<e.length;t++){var i=e[t];if(i&&i.window&&i.window.swapchain)return i.initGeometryRenderer(),void(this._geometryRenderer=i.geometryRenderer)}},r.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new Vo,t=this.device,i=new Di;i.format=ni.RGBA8,i.loadOp=Ai.CLEAR,i.storeOp=Ri.STORE,i.barrier=t.getGeneralBarrier(new Ci(Li.NONE,Li.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new Fi([i]));var r=this._width,n=this._height;e.prefiterTex=t.createTexture(new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED,ni.RGBA8,r>>1,n>>1)),e.prefilterFramebuffer=t.createFramebuffer(new Bi(e.renderPass,[e.prefiterTex])),r>>=1,n>>=1;for(var a=0;a<6;++a)e.downsampleTexs.push(t.createTexture(new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED,ni.RGBA8,r>>1,n>>1))),e.downsampleFramebuffers[a]=t.createFramebuffer(new Bi(e.renderPass,[e.downsampleTexs[a]])),e.upsampleTexs.push(t.createTexture(new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED,ni.RGBA8,r,n))),e.upsampleFramebuffers[a]=t.createFramebuffer(new Bi(e.renderPass,[e.upsampleTexs[a]])),r>>=1,n>>=1;e.combineTex=t.createTexture(new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED,ni.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new Bi(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},r.on=function(e,t,i,r){return this._eventProcessor.on(e,t,i,r)},r.once=function(e,t,i){return this._eventProcessor.once(e,t,i)},r.off=function(e,t,i){this._eventProcessor.off(e,t,i)},r.emit=function(e,t,i,r,n,a){this._eventProcessor.emit(e,t,i,r,n,a)},r.targetOff=function(e){this._eventProcessor.targetOff(e)},r.removeAll=function(e){this._eventProcessor.removeAll(e)},r.hasEventListener=function(e,t,i){return this._eventProcessor.hasEventListener(e,t,i)},l(i,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}},{key:"shadingScale",get:function(){return this._pipelineSceneData.shadingScale},set:function(e){this._pipelineSceneData.shadingScale!==e&&(this._pipelineSceneData.shadingScale=e,this.emit($a.ATTACHMENT_SCALE_CAHNGED,e))}}]),i}(Gi),as=N(ns.prototype,"_tag",[I],(function(){return 0})),ss=N(ns.prototype,"_flows",[is,I],(function(){return[]})),rs=ns))||rs));a.RenderPipeline=Wo,F(Wo.prototype,"RenderPipeline.prototype",[{name:"geometryRenderer",suggest:"please use camera.geometryRenderer instead."}]),function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(os||(os={})),function(e){e[e.AR=5]="AR",e[e.FORWARD=10]="FORWARD"}(hs||(hs={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(us||(us={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(ls||(ls={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(cs||(cs={})),M(ii),M(ri),M(Ri),M(Ai),M(Li),M(ni),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(xo||(xo={})),M(xo),ds=b("RenderTextureDesc"),_s=D(ii),ps=D(ri),fs=D(ni),ds((gs=function(){this.name=ms&&ms(),this.type=vs&&vs(),this.usage=Es&&Es(),this.format=Ss&&Ss(),this.width=Ts&&Ts(),this.height=ws&&ws()},ms=N(gs.prototype,"name",[I],(function(){return""})),vs=N(gs.prototype,"type",[_s],(function(){return ii.TEX2D})),Es=N(gs.prototype,"usage",[ps],(function(){return ri.COLOR_ATTACHMENT})),Ss=N(gs.prototype,"format",[fs],(function(){return ni.UNKNOWN})),Ts=N(gs.prototype,"width",[I],(function(){return-1})),ws=N(gs.prototype,"height",[I],(function(){return-1})),gs));var zo=(ys=b("RenderTextureConfig"),As=D(Ae),ys((Os=function(){this.name=bs&&bs(),this.texture=Ns&&Ns()},bs=N(Os.prototype,"name",[I],(function(){return""})),Ns=N(Os.prototype,"texture",[As],(function(){return null})),Rs=Os))||Rs);Is=b("MaterialConfig"),Ds=D(Le),Is((Ps=function(){this.name=Cs&&Cs(),this.material=Ls&&Ls()},Cs=N(Ps.prototype,"name",[I],(function(){return""})),Ls=N(Ps.prototype,"material",[Ds],(function(){return null})),Ps)),Fs=b("FrameBufferDesc"),Ms=D([B]),Bs=D(Ae),Fs((xs=function(){this.name=Us&&Us(),this.renderPass=ks&&ks(),this.colorTextures=Hs&&Hs(),this.depthStencilTexture=Vs&&Vs(),this.texture=Gs&&Gs()},Us=N(xs.prototype,"name",[I],(function(){return""})),ks=N(xs.prototype,"renderPass",[I],(function(){return 0})),Hs=N(xs.prototype,"colorTextures",[Ms],(function(){return[]})),Vs=N(xs.prototype,"depthStencilTexture",[I],(function(){return""})),Gs=N(xs.prototype,"texture",[Bs],(function(){return null})),xs));var Qo,jo=(Ws=b("ColorDesc"),zs=D(ni),Qs=D(Ai),js=D(Ri),Ys=D(Li),Ks=D(Li),Ws((qs=function(){this.format=Zs&&Zs(),this.loadOp=Js&&Js(),this.storeOp=$s&&$s(),this.sampleCount=eo&&eo(),this.beginAccesses=to&&to(),this.endAccesses=io&&io()},Zs=N(qs.prototype,"format",[zs],(function(){return ni.UNKNOWN})),Js=N(qs.prototype,"loadOp",[Qs],(function(){return Ai.CLEAR})),$s=N(qs.prototype,"storeOp",[js],(function(){return Ri.STORE})),eo=N(qs.prototype,"sampleCount",[I],(function(){return 1})),to=N(qs.prototype,"beginAccesses",[Ys],(function(){return Li.NONE})),io=N(qs.prototype,"endAccesses",[Ks],(function(){return Li.COLOR_ATTACHMENT_WRITE})),Xs=qs))||Xs),Yo=(ro=b("DepthStencilDesc"),no=D(ni),ao=D(Ai),so=D(Ri),oo=D(Ai),ho=D(Ri),uo=D(Li),lo=D(Li),ro((_o=function(){this.format=po&&po(),this.depthLoadOp=fo&&fo(),this.depthStoreOp=go&&go(),this.stencilLoadOp=mo&&mo(),this.stencilStoreOp=vo&&vo(),this.sampleCount=Eo&&Eo(),this.beginAccesses=So&&So(),this.endAccesses=To&&To()},po=N(_o.prototype,"format",[no],(function(){return ni.UNKNOWN})),fo=N(_o.prototype,"depthLoadOp",[ao],(function(){return Ai.CLEAR})),go=N(_o.prototype,"depthStoreOp",[so],(function(){return Ri.STORE})),mo=N(_o.prototype,"stencilLoadOp",[oo],(function(){return Ai.CLEAR})),vo=N(_o.prototype,"stencilStoreOp",[ho],(function(){return Ri.STORE})),Eo=N(_o.prototype,"sampleCount",[I],(function(){return 1})),So=N(_o.prototype,"beginAccesses",[uo],(function(){return Li.NONE})),To=N(_o.prototype,"endAccesses",[lo],(function(){return Li.DEPTH_STENCIL_ATTACHMENT_WRITE})),co=_o))||co);wo=b("RenderPassDesc"),yo=D([jo]),Ao=D(Yo),wo((Ro=function(){this.index=Oo&&Oo(),this.colorAttachments=bo&&bo(),this.depthStencilAttachment=No&&No()},Oo=N(Ro.prototype,"index",[I],(function(){return-1})),bo=N(Ro.prototype,"colorAttachments",[yo],(function(){return[]})),No=N(Ro.prototype,"depthStencilAttachment",[Ao],(function(){return new Yo})),Ro)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(Qo||(Qo={})),M(Qo);var Ko=(Io=b("RenderQueueDesc"),Do=D(Qo),Po=D([B]),Io((Lo=function(){this.isTransparent=Fo&&Fo(),this.sortMode=Mo&&Mo(),this.stages=Bo&&Bo()},Fo=N(Lo.prototype,"isTransparent",[I],(function(){return!1})),Mo=N(Lo.prototype,"sortMode",[Do],(function(){return Qo.FRONT_TO_BACK})),Bo=N(Lo.prototype,"stages",[Po],(function(){return[]})),Co=Lo))||Co);function Xo(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function qo(e,t){return e.priority-t.priority||e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var Zo=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new x((function(){return{priority:0,hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new U(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,i){var r=e.model.subModels[t],n=r.passes[i],a=r.shaders[i];if(n.blendState.targets[0].blend!==this._passDesc.isTransparent||!(n.phase&this._passDesc.phases))return!1;var s=0|n.priority<<16|r.priority<<8|i,o=this._passPool.add();return o.priority=e.model.priority,o.hash=s,o.depth=e.depth||0,o.shaderId=a.typedID,o.subModel=r,o.passIdx=i,this.queue.push(o),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,i){for(var r=0;r<this.queue.length;++r){var n=this.queue.array[r],a=n.subModel,s=n.passIdx,o=a.inputAssembler,h=a.passes[s],u=a.shaders[s],l=Wt.getOrCreatePipelineState(e,h,u,t,o);i.bindPipelineState(l),i.bindDescriptorSet(zt.MATERIAL,h.descriptorSet),i.bindDescriptorSet(zt.LOCAL,a.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}();function Jo(e){for(var t=0,i=0;i<e.stages.length;i++)t|=we(e.stages[i]);var r=Xo;switch(e.sortMode){case Qo.BACK_TO_FRONT:r=qo;break;case Qo.FRONT_TO_BACK:r=Xo}return new Zo({isTransparent:e.isTransparent,phases:t,sortFunc:r})}function $o(e){e.clear()}function eh(e){e.sort()}var th=function(){function e(){this.queue=new Set,this._renderQueue=[]}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._renderQueue.length=0,this.queue.clear()},t.sort=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.pass.blendState.targets[0].blend||this._renderQueue.push(t.value),t=e.next();for(t=(e=this.queue.values()).next();!t.done;)t.value.pass.blendState.targets[0].blend&&this._renderQueue.push(t.value),t=e.next()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},t.recordCommandBuffer=function(e,t,i,r,n){void 0===r&&(r=null);for(var a=0===this._renderQueue.length?this.queue.values():this._renderQueue[Symbol.iterator](),s=a.next();!s.done;){var o=s.value,h=o.instances,u=o.pass;if(o.hasPendingModels){i.bindDescriptorSet(zt.MATERIAL,u.descriptorSet);for(var l=null,c=0;c<h.length;++c){var d=h[c];if(d.count){var _=d.shader,p=Wt.getOrCreatePipelineState(e,u,_,t,d.ia);l!==p&&(i.bindPipelineState(p),l=p),r&&i.bindDescriptorSet(zt.GLOBAL,r),n?i.bindDescriptorSet(zt.LOCAL,d.descriptorSet,n):i.bindDescriptorSet(zt.LOCAL,d.descriptorSet,s.value.dynamicOffsets),i.bindInputAssembler(d.ia),i.draw(d.ia)}}}s=a.next()}},e}(),ih=new w((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),rh=new i,nh=new Float32Array(4),ah=[],sh=[],oh=new r,hh=new r,uh=new f(0,0,0,.5,.5,.5),lh=new f;function ch(e,t){return!(!t.worldBounds||y.aabbWithAABB(t.worldBounds,e.aabb))}function dh(e,t){return!(!t.worldBounds||y.aabbWithAABB(t.worldBounds,e.aabb)&&y.aabbFrustum(t.worldBounds,e.frustum))}function _h(e,t){return!(!t.worldBounds||y.aabbWithAABB(t.worldBounds,e.aabb))}function ph(e,t){return f.transform(lh,uh,e.node.getWorldMatrix()),!(!t.worldBounds||y.aabbWithAABB(t.worldBounds,lh))}var fh="forward-add",gh=we(fh),mh=[];function vh(e,t,i){void 0===i&&(i="default");var r=a.rendering;vt()&&(gh=r.getPhaseID(r.getPassID(i),fh)),t.length=0;for(var n=!1,s=0;s<e.length;s++){for(var o=e[s].passes,h=-1,u=0;u<o.length;u++)if((!r||!r.enableEffectImport)&&o[u].phase===gh||vt()&&o[u].phaseID===gh){h=u,n=!0;break}t.push(h)}return n}var Eh=e("aL",function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._instancedLightPassPool=ih.alloc(),this._shadowUBO=new Float32Array(Ct.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueues=[],this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(Qt.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new ki(this._lightBuffer,0,Qt.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueues.forEach((function(e){e.clear()})),this._instancedQueues.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}ih.freeArray(this._lightPasses),this._lightPasses.length=0,this._instancedLightPassPool.dynamicOffsets.length=0,this._instancedLightPassPool.lights.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,i=0;i<t.length;i++){var r=t[i],n=e.get(r);if(n){var a=vt()?ra("CCShadow"):Ct.BINDING;n.getBuffer(a).destroy(),n.getTexture(Ht).destroy(),n.getTexture(Vt).destroy(),n.destroy()}e.delete(r)}},t._bindForwardAddLight=function(e,t){void 0===t&&(t="default");for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var n=i[r].model,a=n.subModels;if(vh(a,mh,t)&&(sh.length=0,this._lightCulling(n,e),sh.length||!(e.length>0)))for(var s=0;s<a.length;s++){var o=mh[s];if(!(o<0)){var h=a[s],u=h.passes[o];h.passes[0].blendState.targets[0].blend||(vt()?ra("CCForwardLight"):Qt.BINDING,h.descriptorSet.bindBuffer(Qt.BINDING,this._firstLightBufferView),h.descriptorSet.update(),this._addRenderQueue(u,h,n,o))}}}},t.gatherLightPasses=function(e,t,i){void 0===i&&(i="default"),this.clear();var r=this._pipeline.pipelineSceneData.validPunctualLights;if(r.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t),this._bindForwardAddLight(r,i);for(var n=0;n<r.length;n++){var a=r[n];this._instancedLightPassPool.lights.push(a),this._instancedLightPassPool.dynamicOffsets.push(this._lightBufferStride*n)}this._instancedQueues.forEach((function(e){e.uploadBuffers(t)}))}else this._bindForwardAddLight(r,i)},t.recordCommandBuffer=function(e,t,i){for(var r=this._pipeline.globalDSManager,n=0;n<this._instancedQueues.length;++n){var a=this._instancedLightPassPool.lights[n];ah[0]=this._instancedLightPassPool.dynamicOffsets[n];var s=r.getOrCreateDescriptorSet(a);this._instancedQueues[n].recordCommandBuffer(e,t,i,s,ah)}for(var o=0;o<this._lightPasses.length;o++){var h=this._lightPasses[o],u=h.subModel,l=h.passIdx,c=h.dynamicOffsets,d=h.lights,_=u.passes[l],p=u.shaders[l],f=u.inputAssembler,g=Wt.getOrCreatePipelineState(e,_,p,t,f),m=_.descriptorSet,v=u.descriptorSet;i.bindPipelineState(g),i.bindDescriptorSet(zt.MATERIAL,m),i.bindInputAssembler(f);for(var E=0;E<c.length;++E){var S=d[E],T=r.getOrCreateDescriptorSet(S);ah[0]=c[E],i.bindDescriptorSet(zt.GLOBAL,T),i.bindDescriptorSet(zt.LOCAL,v,ah),i.draw(f)}}},t._lightCulling=function(e,t){for(var i=!1,r=0;r<t.length;r++){var n=t[r];switch(n.type){case Lr.SPHERE:i=ch(n,e);break;case Lr.SPOT:i=dh(n,e);break;case Lr.POINT:i=_h(n,e);break;case Lr.RANGED_DIRECTIONAL:i=ph(n,e)}i||sh.push(r)}},t._addRenderQueue=function(e,t,i,r){var n=this._pipeline.pipelineSceneData.validPunctualLights,a=e.batchingScheme,s=null;a===ye.NONE&&((s=ih.alloc()).subModel=t,s.passIdx=r);for(var o=0;o<sh.length;o++){var h=sh[o],u=n[h];if((u.visibility&i.node.layer)===i.node.layer)switch(a){case ye.INSTANCING:var l=e.getInstancedBuffer(o);l.merge(t,r),l.dynamicOffsets[0]=this._lightBufferStride,this._instancedQueues[o]||(this._instancedQueues[o]=new th),this._instancedQueues[o].queue.add(l);break;default:s.lights.push(u),s.dynamicOffsets.push(this._lightBufferStride*h)}}a===ye.NONE&&this._lightPasses.push(s)},t._updateLightDescriptorSet=function(e,t){for(var i=this._pipeline.device,n=this._pipeline.pipelineSceneData,a=n.shadows,s=n.shadowFrameBufferMap,o=e.scene.mainLight,h=Lt(i)?0:1,u=this._pipeline.globalDSManager,l=n.validPunctualLights,c=this._pipeline.device.capabilities,d=0;d<l.length;d++){var _=l[d],p=u.getOrCreateDescriptorSet(_);if(p){var f=void 0,g=void 0;switch(_.type){case Lr.SPHERE:o&&Wa.updatePlanarNormalAndDistance(a,this._shadowUBO),this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=Lr.SPHERE,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,v.toArray(this._shadowUBO,a.shadowColor,Ct.SHADOW_COLOR_OFFSET);break;case Lr.SPOT:var m=_;if(o&&Wa.updatePlanarNormalAndDistance(a,this._shadowUBO),r.invert(oh,_.node.getWorldMatrix()),r.perspective(hh,_.angle,1,.001,_.range,!0,c.clipSpaceMinZ,c.clipSpaceSignY,0),f=hh.clone(),g=hh.clone().invert(),r.multiply(hh,hh,oh),r.toArray(this._shadowUBO,oh,Ct.MAT_LIGHT_VIEW_OFFSET),r.toArray(this._shadowUBO,hh,Ct.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Ct.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Ct.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=_.range,this._shadowUBO[Ct.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Ct.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=m.shadowPcf,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=m.shadowBias,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=Lr.SPOT,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=m.shadowNormalBias,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Ct.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Ct.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=g.m10,this._shadowUBO[Ct.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=g.m14,this._shadowUBO[Ct.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=g.m11,this._shadowUBO[Ct.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=g.m15,this._shadowUBO[Ct.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Ct.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Ct.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Ct.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,v.toArray(this._shadowUBO,a.shadowColor,Ct.SHADOW_COLOR_OFFSET),s.has(_)){var E,S=null===(E=s.get(_))||void 0===E?void 0:E.colorTextures[0];S&&p.bindTexture(Vt,S)}break;case Lr.POINT:o&&Wa.updatePlanarNormalAndDistance(a,this._shadowUBO),this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=a.size.x,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=a.size.y,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[Ct.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=Lr.POINT,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=h,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[Ct.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,v.toArray(this._shadowUBO,a.shadowColor,Ct.SHADOW_COLOR_OFFSET)}p.update();var T=vt()?ra("CCShadow"):Ct.BINDING;t.updateBuffer(p.getBuffer(T),this._shadowUBO)}}},t._updateUBOs=function(e,t){var r=e.exposure,n=this._pipeline.pipelineSceneData,a=n.isHDR,s=n.shadows,o=n.validPunctualLights;o.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=R(o.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new ki(this._lightBuffer,0,Qt.SIZE)));for(var h=0,u=0;h<o.length;h++,u+=this._lightBufferElementCount){var l=o[h];switch(l.type){case Lr.SPHERE:if(i.toArray(nh,l.position),nh[3]=Lr.SPHERE,this._lightBufferData.set(nh,u+Qt.LIGHT_POS_OFFSET),nh[0]=l.size,nh[1]=l.range,nh[2]=0,nh[3]=0,this._lightBufferData.set(nh,u+Qt.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(nh,l.color),l.useColorTemperature){var c=l.finalColor;nh[0]=c.x,nh[1]=c.y,nh[2]=c.z}nh[3]=a?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(nh,u+Qt.LIGHT_COLOR_OFFSET);break;case Lr.SPOT:if(i.toArray(nh,l.position),nh[3]=Lr.SPOT,this._lightBufferData.set(nh,u+Qt.LIGHT_POS_OFFSET),nh[0]=l.size,nh[1]=l.range,nh[2]=l.spotAngle,nh[3]=s.enabled&&l.shadowEnabled&&s.type===Re.ShadowMap?1:0,this._lightBufferData.set(nh,u+Qt.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(nh,l.direction),this._lightBufferData.set(nh,u+Qt.LIGHT_DIR_OFFSET),i.toArray(nh,l.color),l.useColorTemperature){var d=l.finalColor;nh[0]=d.x,nh[1]=d.y,nh[2]=d.z}nh[3]=a?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(nh,u+Qt.LIGHT_COLOR_OFFSET);break;case Lr.POINT:if(i.toArray(nh,l.position),nh[3]=Lr.POINT,this._lightBufferData.set(nh,u+Qt.LIGHT_POS_OFFSET),nh[0]=0,nh[1]=l.range,nh[2]=0,nh[3]=0,this._lightBufferData.set(nh,u+Qt.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(nh,l.color),l.useColorTemperature){var _=l.finalColor;nh[0]=_.x,nh[1]=_.y,nh[2]=_.z}nh[3]=a?l.luminance*r*this._lightMeterScale:l.luminance,this._lightBufferData.set(nh,u+Qt.LIGHT_COLOR_OFFSET);break;case Lr.RANGED_DIRECTIONAL:i.toArray(nh,l.position),nh[3]=Lr.RANGED_DIRECTIONAL,this._lightBufferData.set(nh,u+Qt.LIGHT_POS_OFFSET),i.toArray(nh,l.right),nh[3]=0,this._lightBufferData.set(nh,u+Qt.LIGHT_SIZE_RANGE_ANGLE_OFFSET),i.toArray(nh,l.direction),nh[3]=0,this._lightBufferData.set(nh,u+Qt.LIGHT_DIR_OFFSET);var p=l.scale;if(rh.set(.5*p.x,.5*p.y,.5*p.z),i.toArray(nh,rh),nh[3]=0,this._lightBufferData.set(nh,u+Qt.LIGHT_BOUNDING_SIZE_VS_OFFSET),i.toArray(nh,l.color),l.useColorTemperature){var f=l.finalColor;nh[0]=f.x,nh[1]=f.y,nh[2]=f.z}nh[3]=a?l.illuminance*r:l.illuminance,this._lightBufferData.set(nh,u+Qt.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}()),Sh=new f,Th=we("planar-shadow");function wh(e){var t=e.passes,i=a.rendering;vt()&&(Th=i.getPhaseID(i.getPassID("default"),"planar-shadow"));for(var r=0;r<t.length;r++)if((!i||!i.enableEffectImport)&&t[r].phase===Th||vt()&&t[r].phaseID===Th)return r;return-1}var yh,Ah,Rh,Oh,bh,Nh,Ih,Dh,Ph=e("aM",function(){function e(e){this._subModelArray=[],this._shaderArray=[],this._passArray=[],this._castModels=[],this._instancedQueue=new th,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.clear=function(){this._subModelArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._castModels.length=0},t.gatherShadowPasses=function(e,t){this.clear();var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Re.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,n=e.frustum,a=0!=(e.visibility&At.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,o=e.visibility,h=0;h<s.length;h++){var u=s[h];r.isCulledByLod(e,u)||u.enabled&&u.node&&u.castShadow&&u.node&&(o&u.node.layer)===u.node.layer&&this._castModels.push(u)}for(var l=0;l<this._castModels.length;l++){var c=this._castModels[l];if(!c.worldBounds||(f.transform(Sh,c.worldBounds,i.matLight),y.aabbFrustum(Sh,n)))for(var d=c.subModels,_=0;_<d.length;_++){var p=d[_],g=wh(p);if(g<0){this._subModelArray.push(p);var m=i.getPlanarShader(p.patches);if(!m)continue;this._shaderArray.push(m),this._passArray.push(i.material.passes[0])}else{var v=p.passes[g];if(v.batchingScheme===ye.INSTANCING){var E=v.getInstancedBuffer();E.merge(p,g),this._instancedQueue.queue.add(E)}else{var S=p.shaders[g];this._subModelArray.push(p),S&&this._shaderArray.push(S),this._passArray.push(v)}}}}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,i){var r=this._pipeline.pipelineSceneData.shadows;if(r.enabled&&r.type===Re.Planar){this._instancedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelArray.length;++n){var a=this._subModelArray[n],s=this._shaderArray[n],o=this._passArray[n],h=a.inputAssembler,u=Wt.getOrCreatePipelineState(e,o,s,t,h),l=o.descriptorSet;i.bindPipelineState(u),i.bindDescriptorSet(zt.MATERIAL,l),i.bindDescriptorSet(zt.LOCAL,a.descriptorSet),i.bindInputAssembler(h),i.draw(h)}}},e}()),Ch=function(){function e(){this._phaseID=we("default");var e=a.rendering;vt()&&(this._phaseID=e.getPhaseID(e.getPassID("default"),"default"))}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var i=this._pipeline,r=i.device,n=i.commandBuffers[0],a=e.scene.batches,s=0;s<a.length;s++){var o=a[s],h=!1;if(e.visibility&o.visFlags&&(h=!0),h)for(var u=o.shaders.length,l=0;l<u;l++){var c=o.passes[l];if(c.phase===this._phaseID){var d=o.shaders[l],_=o.inputAssembler,p=Wt.getOrCreatePipelineState(r,c,d,t,_);n.bindPipelineState(p),n.bindDescriptorSet(zt.MATERIAL,c.descriptorSet);var f=o.descriptorSet;n.bindDescriptorSet(zt.LOCAL,f),n.bindInputAssembler(_),n.draw(_)}}}},e}(),Lh=[new ei(0,0,0,1)],Fh=e("G",(yh=b("ForwardStage"),Ah=D([Ko]),yh(((Nh=function(e){function t(){var t;return(t=e.call(this)||this).renderQueues=bh&&bh(),t._renderQueues=[],t._renderArea=new wi,t._instancedQueue=void 0,t._phaseID=we("default"),t._clearFlag=4294967295,t.additiveInstanceQueues=[],t._instancedQueue=new th,t._uiPhase=new Ch,t}S(t,e);var i=t.prototype;return i.addRenderInstancedQueue=function(e){this.additiveInstanceQueues.includes(e)||this.additiveInstanceQueues.push(e)},i.removeRenderInstancedQueue=function(e){var t=this.additiveInstanceQueues.indexOf(e);t>-1&&this.additiveInstanceQueues.splice(t,1)},i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=Jo(this.renderQueues[r]);this._additiveLightQueue=new Eh(this._pipeline),this._planarQueue=new Ph(this._pipeline),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){var t;this._instancedQueue.clear();var i=this._pipeline,r=i.device;this._renderQueues.forEach($o);for(var n=i.pipelineSceneData.renderObjects,a=0,s=0,o=0,h=0;h<n.length;++h){var u=n[h],l=u.model.subModels;for(a=0;a<l.length;++a){var c=l[a],d=c.passes;for(s=0;s<d.length;++s){var _=d[s];if(_.phase===this._phaseID)if(_.batchingScheme===ye.INSTANCING){var p=_.getInstancedBuffer();p.merge(c,s),this._instancedQueue.queue.add(p)}else for(o=0;o<this._renderQueues.length;o++)this._renderQueues[o].insertRenderPass(u,a,s)}}}this._instancedQueue.sort(),this._renderQueues.forEach(eh);var f=i.commandBuffers[0];i.pipelineUBO.updateShadowUBO(e);for(var g=0;g<this.additiveInstanceQueues.length;g++)this.additiveInstanceQueues[g].uploadBuffers(f);this._instancedQueue.uploadBuffers(f),this._additiveLightQueue.gatherLightPasses(e,f),this._planarQueue.gatherShadowPasses(e,f),e.clearFlag&Jt.COLOR&&(Lh[0].x=e.clearColor.x,Lh[0].y=e.clearColor.y,Lh[0].z=e.clearColor.z,Lh[0].w=e.clearColor.w),i.generateRenderArea(e,this._renderArea);var m=e.window.framebuffer,v=i.getRenderPass(e.clearFlag&this._clearFlag,m);f.beginRenderPass(v,m,this._renderArea,Lh,e.clearDepth,e.clearStencil),f.bindDescriptorSet(zt.GLOBAL,i.descriptorSet),this._renderQueues[0].recordCommandBuffer(r,v,f);for(var E=0;E<this.additiveInstanceQueues.length;E++)this.additiveInstanceQueues[E].recordCommandBuffer(r,v,f);this._instancedQueue.recordCommandBuffer(r,v,f),this._additiveLightQueue.recordCommandBuffer(r,v,f),f.bindDescriptorSet(zt.GLOBAL,i.descriptorSet),this._planarQueue.recordCommandBuffer(r,v,f),this._renderQueues[1].recordCommandBuffer(r,v,f),null===(t=e.geometryRenderer)||void 0===t||t.render(v,f,i.pipelineSceneData),this._uiPhase.render(e,v),Ue(r,v,f,i.profiler,e),f.endRenderPass()},t}(Ja)).initInfo={name:"ForwardStage",priority:hs.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:Qo.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Qo.BACK_TO_FRONT,stages:["default","planarShadow"]}]},bh=N((Oh=Nh).prototype,"renderQueues",[Ah,I],(function(){return[]})),Rh=Oh))||Rh)),Mh=e("E",b("ForwardFlow")(((Dh=function(e){function t(){return e.apply(this,arguments)||this}S(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new Fh;i.initialize(Fh.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(es)).initInfo={name:jt,priority:us.FORWARD,stages:[]},Ih=Dh))||Ih),Bh=we("shadow-caster");function xh(e){var t=e.passes,i=a.rendering;vt()&&(Bh=i.getPhaseID(i.getPassID("default"),"shadow-caster"));for(var r=0;r<t.length;r++)if((!i||!i.enableEffectImport)&&t[r].phase===Bh||vt()&&t[r].phaseID===Bh)return r;return-1}var Uh,kh,Hh,Vh,Gh=e("aF",function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._pipeline=e,this._instancedQueue=new th}var t=e.prototype;return t.gatherLightPasses=function(e,t,i,r){void 0===r&&(r=0),this.clear();var n=this._pipeline.pipelineSceneData,a=n.shadows;if(t&&a.enabled&&a.type===Re.ShadowMap){switch(t.type){case Lr.DIRECTIONAL:var s=t;if(s.shadowEnabled){var o,h=n.csmLayers;!function(e,t,i){var r=e.scene.mainLight,n=t.csmLayers.layerObjects,a=i.validFrustum,s=i.shadowObjects;s.length=0;for(var o=e.visibility,h=n.length-1;h>=0;h--){var u=n.array[h];if(u){var l=u.model;l&&l.enabled&&l.node&&((o&l.node.layer)===l.node.layer||o&l.visFlags)&&l.worldBounds&&l.castShadow?y.aabbFrustum(l.worldBounds,a)&&(s.push(u),i.level<r.csmLevel&&r.csmOptimizationMode===Pe.RemoveDuplicates&&y.aabbFrustumCompletelyInside(l.worldBounds,a)&&n.fastRemove(h)):n.fastRemove(h)}else n.fastRemove(h)}}(e,n,o=s.shadowFixedArea?h.specialLayer:h.layers[r]);for(var u=o.shadowObjects,l=0;l<u.length;l++){var c=u[l].model;this.add(c,r)}}break;case Lr.SPOT:var d=t;if(d.shadowEnabled)for(var _=d.visibility,p=n.csmLayers.castShadowObjects,f=0;f<p.length;f++){var g=p[f].model;(!g.worldBounds||(_&g.node.layer)===g.node.layer&&y.aabbFrustum(g.worldBounds,d.frustum))&&this.add(g,r)}}this._instancedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear()},t.add=function(e,t){for(var i=e.subModels,r=0;r<i.length;r++){var n=i[r],a=xh(n);if(!(a<0)){var s=n.passes[a];if(s.batchingScheme===ye.INSTANCING){var o=s.getInstancedBuffer(t);o.merge(n,a),this._instancedQueue.queue.add(o)}else{var h=n.shaders[a];this._subModelsArray.push(n),h&&this._shaderArray.push(h),this._passArray.push(s)}}}},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i);for(var r=0;r<this._subModelsArray.length;++r){var n=this._subModelsArray[r],a=this._shaderArray[r],s=this._passArray[r],o=n.inputAssembler,h=Wt.getOrCreatePipelineState(e,s,a,t,o),u=s.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(zt.MATERIAL,u),i.bindDescriptorSet(zt.LOCAL,n.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}()),Wh=[new ei(1,1,1,1)],zh=e("V",b("ShadowStage")(((kh=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._additiveShadowQueue=void 0,t._shadowFrameBuffer=null,t._renderArea=new wi,t._light=null,t._globalDS=null,t._level=0,t._isShadowMapCleared=!1,t}S(t,e);var i=t.prototype;return i.setUsage=function(e,t,i,r){void 0===r&&(r=0),this._globalDS=e,this._light=t,this._shadowFrameBuffer=i,this._level=r},i.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},i.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer&&!this._isShadowMapCleared){Wh[0].w=e.clearColor.w;var t=this._pipeline,i=t.pipelineSceneData,r=i.shadingScale,n=i.shadows,a=e.viewport,s=n.size;this._renderArea.x=a.x*s.x,this._renderArea.y=a.y*s.y,this._renderArea.width=a.width*s.x*r,this._renderArea.height=a.height*s.y*r;var o=t.commandBuffers[0],h=this._shadowFrameBuffer.renderPass;o.beginRenderPass(h,this._shadowFrameBuffer,this._renderArea,Wh,e.clearDepth,e.clearStencil),o.endRenderPass(),this._isShadowMapCleared=!0}},i.render=function(e){var t=this._pipeline,i=t.pipelineSceneData,r=i.shadows,n=this._globalDS,a=t.commandBuffers[0],s=this._level,o=t.device;if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(n,this._light,s),this._additiveShadowQueue.gatherLightPasses(e,this._light,a,s);var h=r.size;switch(this._light.type){case Lr.DIRECTIONAL:var u=this._light;if(u.shadowFixedArea||u.csmLevel===De.LEVEL_1||!i.csmSupported)this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=h.x,this._renderArea.height=h.y;else{var l=o.capabilities.screenSpaceSignY;this._renderArea.x=s%2*.5*h.x,this._renderArea.y=l>0?.5*(1-Math.floor(s/2))*h.y:.5*Math.floor(s/2)*h.y,this._renderArea.width=.5*h.x,this._renderArea.height=.5*h.y}break;case Lr.SPOT:this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=h.x,this._renderArea.height=h.y}var c=this._shadowFrameBuffer.renderPass;a.beginRenderPass(c,this._shadowFrameBuffer,this._renderArea,Wh,e.clearDepth,e.clearStencil),a.bindDescriptorSet(zt.GLOBAL,n),this._additiveShadowQueue.recordCommandBuffer(o,c,a),a.endRenderPass(),this._isShadowMapCleared=!1}},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._additiveShadowQueue=new Gh(t),this._isShadowMapCleared=!1},t}(Ja)).initInfo={name:"ShadowStage",priority:hs.FORWARD,tag:0},Uh=kh))||Uh),Qh=[],jh=e("U",b("ShadowFlow")(((Vh=function(e){function i(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._shadowRenderPass=null,t}S(i,e);var r=i.prototype;return r.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new zh;i.initialize(zh.initInfo),this._stages.push(i)}return!0},r.activate=function(t){e.prototype.activate.call(this,t);var i=Lt(t.device)?0:1;t.macros.CC_SHADOWMAP_FORMAT=i;var r=t.device.gfxAPI===Hi.WEBGL?1:0;t.macros.CC_SHADOWMAP_USE_LINEAR_DEPTH=r,t.pipelineSceneData.csmSupported=t.device.capabilities.maxFragmentUniformVectors>=(xt.COUNT+Ut.COUNT+Ct.COUNT+kt.COUNT)/4,t.macros.CC_SUPPORT_CASCADED_SHADOW_MAP=t.pipelineSceneData.csmSupported,t.macros.CC_SHADOW_TYPE=0,t.macros.CC_DIR_SHADOW_PCF_TYPE=Ie.HARD,t.macros.CC_DIR_LIGHT_SHADOW_TYPE=0,t.macros.CC_CASCADED_LAYERS_TRANSITION=0,t.onGlobalPipelineStateChanged()},r.render=function(e){var t=this._pipeline,i=t.pipelineSceneData.shadows,r=t.pipelineSceneData.csmLayers,n=t.pipelineSceneData.shadowFrameBufferMap,a=r.castShadowObjects,s=this._pipeline.pipelineSceneData.validPunctualLights;if(i.enabled&&i.type===Re.ShadowMap){for(var o=0,h=0;o<i.maxReceived&&h<s.length;){var u=s[h];u.type===Lr.SPOT&&u.shadowEnabled&&(Qh.push(u),o++),h++}if(0!==a.length){i.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l&&l.shadowEnabled){var c=t.descriptorSet;n.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);var d=n.get(l);if(l.shadowFixedArea)this._renderStage(e,l,d,c);else for(var _=t.pipelineSceneData.csmSupported?l.csmLevel:1,p=0;p<_;p++)this._renderStage(e,l,d,c,p)}for(var f=0;f<Qh.length;f++){var g=Qh[f],m=t.globalDSManager.getOrCreateDescriptorSet(g);n.has(g)||this._initShadowFrameBuffer(t,g,e.window.swapchain);var v=n.get(g);this._renderStage(e,g,v,m)}Qh.length=0}else this.clearShadowMap(Qh,e)}},r.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,i=Array.from(t.values()),r=0;r<i.length;r++){var n=i[r];if(n){for(var a=n.colorTextures,s=0;s<a.length;s++){var o=a[s];o&&o.destroy()}a.length=0;var h=n.depthStencilTexture;h&&h.destroy(),n.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},r._initShadowFrameBuffer=function(e,t){var i=e.device,r=e.pipelineSceneData.shadows.size,n=e.pipelineSceneData.shadowFrameBufferMap,a=Lt(i)?ni.R32F:ni.RGBA8;if(!this._shadowRenderPass){var s=new Di;s.format=a,s.loadOp=Ai.CLEAR,s.storeOp=Ri.STORE,s.sampleCount=1;var o=new Pi;o.format=ni.DEPTH_STENCIL,o.depthLoadOp=Ai.CLEAR,o.depthStoreOp=Ri.DISCARD,o.stencilLoadOp=Ai.CLEAR,o.stencilStoreOp=Ri.DISCARD,o.sampleCount=1;var h=new Fi([s],o);this._shadowRenderPass=i.createRenderPass(h)}var u=[];u.push(i.createTexture(new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED,a,r.x,r.y)));var l=i.createTexture(new ti(ii.TEX2D,ri.DEPTH_STENCIL_ATTACHMENT,ni.DEPTH_STENCIL,r.x,r.y)),c=i.createFramebuffer(new Bi(this._shadowRenderPass,u,l));n.set(t,c)},r._renderStage=function(e,t,i,r,n){void 0===n&&(n=0);for(var a=0;a<this._stages.length;a++){var s=this._stages[a];s.setUsage(r,t,i,n),s.render(e)}},r.clearShadowMap=function(e,t){var i=this._pipeline,r=i.pipelineSceneData,n=t.scene.mainLight;if(n){var a=this._pipeline.descriptorSet;r.shadowFrameBufferMap.has(n)||this._initShadowFrameBuffer(this._pipeline,n,t.window.swapchain);for(var s=r.shadowFrameBufferMap.get(n),o=0;o<this._stages.length;o++){var h=this._stages[o];h.setUsage(a,n,s),h.clearFramebuffer(t)}}for(var u=0;u<e.length;u++){var l=e[u],c=i.globalDSManager.getOrCreateDescriptorSet(l);r.shadowFrameBufferMap.has(l)||this._initShadowFrameBuffer(this._pipeline,l,t.window.swapchain);for(var d=r.shadowFrameBufferMap.get(l),_=0;_<this._stages.length;_++){var p=this._stages[_];p.setUsage(c,l,d),p.clearFramebuffer(t)}}},r.resizeShadowMap=function(){for(var e,i=this._pipeline.pipelineSceneData.shadows,r=i.size,n=this._pipeline,a=n.device,s=n.pipelineSceneData.shadowFrameBufferMap,o=Lt(a)?ni.R32F:ni.RGBA8,h=t(s.keys());!(e=h()).done;){var u=e.value,l=s.get(u);if(l){var c=[];c.push(n.device.createTexture(new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED,o,r.x,r.y)));var d=l.depthStencilTexture;d&&d.resize(r.x,r.y);var _=l.renderPass;l.destroy();var p=a.createFramebuffer(new Bi(_,c,d));s.set(u,p)}}i.shadowMapDirty=!1},i}(es)).initInfo={name:Yt,priority:us.SHADOW,tag:xo.SCENE,stages:[]},Hh=Vh))||Hh),Yh=new r,Kh=new r,Xh=new r,qh=new r,Zh=new r,Jh=new r,$h=new r,eu=new i(0,0,0),tu=new i,iu=new g,ru=new i,nu=new i,au=new i(1e7,1e7,1e7),su=new i(-1e7,-1e7,-1e7),ou=new i,hu=0,uu=0,lu=function(){function e(e){this._shadowObjects=[],this._shadowCameraFar=0,this._level=void 0,this._matShadowView=new r,this._matShadowProj=new r,this._matShadowViewProj=new r,this._validFrustum=new d,this._splitFrustum=new d,this._lightViewFrustum=new d,this._castLightViewBoundingBox=new f,this._level=e,this._validFrustum.accurate=!0,this._splitFrustum.accurate=!0,this._lightViewFrustum.accurate=!0}var t=e.prototype;return t.copyToValidFrustum=function(e){d.copy(this._validFrustum,e)},t.calculateValidFrustumOrtho=function(e,t,i,r,n){d.createOrtho(this._validFrustum,e,t,i,r,n)},t.calculateSplitFrustum=function(e,t,i,r){this._splitFrustum.split(i,r,e.aspect,e.fov,t)},t.destroy=function(){this._shadowObjects.length=0},t.createMatrix=function(e,t,n){var s=a.director.root.device,o=e.shadowInvisibleOcclusionRange;d.copy(this._lightViewFrustum,this._splitFrustum),r.fromRT(Kh,e.node.rotation,eu),r.invert(Xh,Kh);var h,u,l=Xh.clone();this._lightViewFrustum.transform(Xh),f.fromPoints(this._castLightViewBoundingBox,au,su),this._castLightViewBoundingBox.mergeFrustum(this._lightViewFrustum),e.csmOptimizationMode===Pe.DisableRotationFix?(h=2*this._castLightViewBoundingBox.halfExtents.x,u=2*this._castLightViewBoundingBox.halfExtents.y):h=u=i.distance(this._lightViewFrustum.vertices[0],this._lightViewFrustum.vertices[6]);var c=a.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1;if(c>1&&e.csmOptimizationMode===Pe.RemoveDuplicates)if(this._level>=c-1)uu=this._castLightViewBoundingBox.halfExtents.z,hu=this._castLightViewBoundingBox.center.z;else{var _=Math.abs(this._castLightViewBoundingBox.center.z-hu)+uu;this._castLightViewBoundingBox.halfExtents.z=Math.max(this._castLightViewBoundingBox.center.z,_)}var p=this._castLightViewBoundingBox.halfExtents.z;this._shadowCameraFar=2*p+o;var g=this._castLightViewBoundingBox.center;if(ou.set(g.x,g.y,g.z+p+o),i.transformMat4(ou,ou,Kh),r.fromRT(Kh,e.node.rotation,ou),r.invert(Xh,Kh),!n){var m=.5*h,v=.5*u;r.ortho(qh,-m,m,-v,v,.1,this._shadowCameraFar,s.capabilities.clipSpaceMinZ,s.capabilities.clipSpaceSignY),r.multiply(Jh,qh,l),i.transformMat4(tu,ou,Jh);var E=2/t;iu.set(E,E);var S=tu.x%iu.x,T=tu.y%iu.y;ru.set(tu.x-S,tu.y-T,tu.z),r.invert($h,Jh),i.transformMat4(nu,ru,$h),r.fromRT(Kh,e.node.rotation,nu),r.invert(Xh,Kh),r.multiply(Zh,qh,Xh),r.copy(this._matShadowView,Xh),r.copy(this._matShadowProj,qh),r.copy(this._matShadowViewProj,Zh)}d.createOrtho(this._validFrustum,h,u,.1,this._shadowCameraFar,Kh)},l(e,[{key:"level",get:function(){return this._level}},{key:"shadowObjects",get:function(){return this._shadowObjects}},{key:"shadowCameraFar",get:function(){return this._shadowCameraFar},set:function(e){this._shadowCameraFar=e}},{key:"matShadowView",get:function(){return this._matShadowView},set:function(e){this._matShadowView=e}},{key:"matShadowProj",get:function(){return this._matShadowProj},set:function(e){this._matShadowProj=e}},{key:"matShadowViewProj",get:function(){return this._matShadowViewProj},set:function(e){this._matShadowViewProj=e}},{key:"validFrustum",get:function(){return this._validFrustum}},{key:"splitFrustum",get:function(){return this._splitFrustum}},{key:"lightViewFrustum",get:function(){return this._lightViewFrustum}},{key:"castLightViewBoundingBox",get:function(){return this._castLightViewBoundingBox}}]),e}(),cu=function(e){function t(t){var i;return(i=e.call(this,t)||this)._splitCameraNear=0,i._splitCameraFar=0,i._csmAtlas=new u,i._calculateAtlas(t),i}S(t,e);var i=t.prototype;return i.destroy=function(){e.prototype.destroy.call(this)},i._calculateAtlas=function(e){var t=a.director.root.device.capabilities.clipSpaceSignY,i=e%2-.5,r=(.5-Math.floor(e/2))*t;this._csmAtlas.set(.5,.5,i,r)},l(t,[{key:"splitCameraNear",get:function(){return this._splitCameraNear},set:function(e){this._splitCameraNear=e}},{key:"splitCameraFar",get:function(){return this._splitCameraFar},set:function(e){this._splitCameraFar=e}},{key:"csmAtlas",get:function(){return this._csmAtlas},set:function(e){this._csmAtlas=e}}]),t}(lu),du=function(){function e(){this._castShadowObjects=[],this._layerObjects=new U(64),this._layers=[],this._levelCount=0,this._specialLayer=new lu(1),this._shadowDistance=0;for(var e=0;e<De.LEVEL_4;e++)this._layers[e]=new cu(e)}var t=e.prototype;return t.update=function(e,t){var i=t.scene.mainLight;if(null!==i){var r=e.shadows,n=a.director.root.pipeline.pipelineSceneData.csmSupported?i.csmLevel:1,s=i.shadowDistance;r.enabled&&i.shadowEnabled&&(i.shadowFixedArea?this._updateFixedArea(i):((i.csmNeedUpdate||this._levelCount!==n||this._shadowDistance!==s)&&(this._splitFrustumLevels(i),this._levelCount=n,this._shadowDistance=s),this._calculateCSM(t,i,r)))}},t.destroy=function(){this._castShadowObjects.length=0;for(var e=0;e<this._layers.length;e++)this._layers[e].destroy();this._layers.length=0},t._updateFixedArea=function(e){var t=a.director.root.device,i=e.shadowOrthoSize,n=e.shadowOrthoSize,s=e.shadowNear,o=e.shadowFar;r.fromRT(Kh,e.node.getWorldRotation(),e.node.getWorldPosition()),r.invert(Xh,Kh),r.ortho(qh,-i,i,-n,n,s,o,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY),r.multiply(Zh,qh,Xh),this._specialLayer.matShadowView=Xh,this._specialLayer.matShadowProj=qh,this._specialLayer.matShadowViewProj=Zh,this._specialLayer.calculateValidFrustumOrtho(2*i,2*n,s,o,Kh)},t._splitFrustumLevels=function(e){var t=.1,i=e.shadowDistance,r=i/t,n=a.director.root.pipeline.pipelineSceneData.csmSupported?e.csmLevel:1,s=e.csmLayerLambda;this._layers[0].splitCameraNear=t;for(var o=1;o<n;o++){var h=o/n,u=s*t*Math.pow(r,h)+(1-s)*(t+(i-t)*h),l=1.005*u;this._layers[o].splitCameraNear=u,this._layers[o-1].splitCameraFar=l}this._layers[n-1].splitCameraFar=i,e.csmNeedUpdate=!1},t._calculateCSM=function(e,t,i){var n=a.director.root.pipeline.pipelineSceneData.csmSupported?t.csmLevel:1,s=n>1?.5*i.size.x:i.size.x;if(!(s<0)){this._getCameraWorldMatrix(Yh,e);for(var o=n-1;o>=0;o--){var h=this._layers[o],u=h.splitCameraNear,l=h.splitCameraFar;h.calculateSplitFrustum(e,Yh,u,l),h.createMatrix(t,s,!1)}n===De.LEVEL_1?(this._specialLayer.shadowCameraFar=this._layers[0].shadowCameraFar,r.copy(this._specialLayer.matShadowView,this._layers[0].matShadowView),r.copy(this._specialLayer.matShadowProj,this._layers[0].matShadowProj),r.copy(this._specialLayer.matShadowViewProj,this._layers[0].matShadowViewProj),this._specialLayer.copyToValidFrustum(this._layers[0].validFrustum)):(this._specialLayer.calculateSplitFrustum(e,Yh,.1,t.shadowDistance),this._specialLayer.createMatrix(t,s,!0))}},t._getCameraWorldMatrix=function(e,t){if(t.node){var i=t.node,n=i.getWorldPosition(),a=i.getWorldRotation();r.fromRT(e,a,n)}},l(e,[{key:"castShadowObjects",get:function(){return this._castShadowObjects}},{key:"layerObjects",get:function(){return this._layerObjects}},{key:"layers",get:function(){return this._layers}},{key:"specialLayer",get:function(){return this._specialLayer}}]),e}(),_u=e("B",function(){function e(){this.fog=new ke,this.ambient=new Ne,this.skybox=new He,this.shadows=new Ce,this.csmLayers=new du,this.octree=new Br,this.skin=new xr,this.lightProbes=a.internal.LightProbes?new a.internal.LightProbes:null,this.validPunctualLights=[],this.renderObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._csmSupported=!0,this._standardSkinMeshRenderer=null,this._standardSkinModel=null,this._skinMaterialModel=null,this._shadingScale=1}var t=e.prototype;return t.activate=function(e){return this._device=e,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0},t.initGeometryRendererMaterials=function(){for(var e=0,t=0;t<6;t++){this._geometryRendererMaterials[t]=new Le,this._geometryRendererMaterials[t]._uuid="geometry-renderer-material-"+t,this._geometryRendererMaterials[t].initialize({effectName:"internal/builtin-geometry-renderer",technique:t});for(var i=0;i<this._geometryRendererMaterials[t].passes.length;++i)this._geometryRendererPasses[e]=this._geometryRendererMaterials[t].passes[i],this._geometryRendererShaders[e]=this._geometryRendererMaterials[t].passes[i].getShaderVariant(),e++}},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Le;e._uuid="default-occlusion-query-material",e.initialize({effectName:"internal/builtin-occlusion-query"}),this._occlusionQueryMaterial=e,e.passes.length>0&&(this._occlusionQueryShader=e.passes[0].getShaderVariant())}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial&&this._occlusionQueryMaterial.passes.length>0?this._occlusionQueryMaterial.passes[0]:null},t.updatePipelineSceneData=function(){},t.destroy=function(){var e,t,i;this.shadows.destroy(),this.csmLayers.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(i=this._occlusionQueryIndicesBuffer)||void 0===i||i.destroy(),this._occlusionQueryIndicesBuffer=null,this._standardSkinMeshRenderer=null,this._standardSkinModel=null,this._skinMaterialModel=null},t._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),i=3*Float32Array.BYTES_PER_ELEMENT,r=8*i;this._occlusionQueryVertexBuffer=e.createBuffer(new _i(pi.VERTEX|pi.TRANSFER_DST,fi.DEVICE,r,i)),this._occlusionQueryVertexBuffer.update(t);var n=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),a=Uint16Array.BYTES_PER_ELEMENT,s=36*a;this._occlusionQueryIndicesBuffer=e.createBuffer(new _i(pi.INDEX|pi.TRANSFER_DST,fi.DEVICE,s,a)),this._occlusionQueryIndicesBuffer.update(n);var o=[new li("a_position",ni.RGB32F)],h=new xi(o,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(h)},l(e,[{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale=e}},{key:"csmSupported",get:function(){return this._csmSupported},set:function(e){this._csmSupported=e}},{key:"standardSkinModel",get:function(){return this._standardSkinModel},set:function(e){this._standardSkinModel=e}},{key:"standardSkinMeshRenderer",get:function(){return this._standardSkinMeshRenderer},set:function(e){this._standardSkinMeshRenderer&&this._standardSkinMeshRenderer!==e&&this._standardSkinMeshRenderer.clearGlobalStandardSkinObjectFlag(),this._standardSkinMeshRenderer=e,this.standardSkinModel=e?e.model:null}},{key:"skinMaterialModel",get:function(){return this._skinMaterialModel},set:function(e){this._skinMaterialModel=e}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}}]),e}()),pu=At.makeMaskExclude([At.BitMask.UI_2D,At.BitMask.UI_3D,At.BitMask.GIZMOS,At.BitMask.EDITOR,At.BitMask.SCENE_GIZMO,At.BitMask.PROFILER]),fu="CC_USE_RGBE_OUTPUT",gu=we("default"),mu=we("reflect-map");function vu(e){var t=e.passes,i=a.rendering;vt()&&(gu=i.getPhaseID(i.getPassID("default"),"default"));for(var r=0;r<t.length;r++)if((!i||!i.enableEffectImport)&&t[r].phase===gu||vt()&&t[r].phaseID===gu)return r;return-1}function Eu(e){var t=e.passes,i=a.rendering;vt()&&(mu=i.getPhaseID(i.getPassID("default"),"reflect-map"));for(var r=0;r<t.length;r++)if((!i||!i.enableEffectImport)&&t[r].phase===mu||vt()&&t[r].phaseID===mu)return r;return-1}var Su,Tu,wu,yu,Au,Ru,Ou,bu,Nu,Iu,Du,Pu,Cu,Lu,Fu,Mu,Bu,xu,Uu,ku,Hu,Vu,Gu,Wu,zu,Qu,ju,Yu,Ku,Xu,qu,Zu,Ju=e("aN",function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._rgbeSubModelsArray=[],this._instancedQueue=void 0,this._patches=[],this._pipeline=e,this._instancedQueue=new th}var t=e.prototype;return t.gatherRenderObjects=function(e,t,i){this.clear();var r=t.scene,n=this._pipeline.pipelineSceneData.skybox;n.enabled&&n.model&&e.camera.clearFlag&Er&&this.add(n.model);for(var a=r.models,s=e.camera.visibility,o=0;o<a.length;o++){var h=a[o];r.isCulledByLod(t,h)||h.enabled&&h.node&&h.worldBounds&&h.bakeToReflectionProbe&&(e.probeType===dr.CUBE?((s&h.node.layer)===h.node.layer||s&h.visFlags)&&y.aabbWithAABB(h.worldBounds,e.boundingBox)&&this.add(h):((h.node.layer&pu)===h.node.layer||pu&h.visFlags)&&y.aabbFrustum(h.worldBounds,e.camera.frustum)&&this.add(h))}this._instancedQueue.uploadBuffers(i)},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._rgbeSubModelsArray.length=0},t.add=function(e){for(var t=e.subModels,i=0;i<t.length;i++){var r=t[i];if(!r.passes[0].blendState.targets[0].blend){var n=Eu(r),a=!0;if(n<0&&(n=vu(r),a=!1),!(n<0)){var s=r.passes[n],o=s.batchingScheme;if(!a){this._patches=[],this._patches=this._patches.concat(r.patches);var h=[{name:fu,value:!0}];this._patches=this._patches.concat(h),r.onMacroPatchesStateChanged(this._patches),this._rgbeSubModelsArray.push(r)}if(o===ye.INSTANCING){var u=s.getInstancedBuffer();u.merge(r,n),this._instancedQueue.queue.add(u)}else{var l=r.shaders[n];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(s)}}}}},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i);for(var r=0;r<this._subModelsArray.length;++r){var n=this._subModelsArray[r],a=this._shaderArray[r],s=this._passArray[r],o=n.inputAssembler,h=Wt.getOrCreatePipelineState(e,s,a,t,o),u=s.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(zt.MATERIAL,u),i.bindDescriptorSet(zt.LOCAL,n.descriptorSet),i.bindInputAssembler(o),i.draw(o)}this.resetRGBEMacro(),this._instancedQueue.clear()},t.resetRGBEMacro=function(){for(var e=0;e<this._rgbeSubModelsArray.length;e++){this._patches=[];var t=this._rgbeSubModelsArray[e];if(this._patches=this._patches.concat(t.patches),this._patches){for(var i=0;i<this._patches.length;i++)if(this._patches[i].name===fu){this._patches.splice(i,1);break}t.onMacroPatchesStateChanged(this._patches)}}},e}()),$u=[new ei(1,1,1,1)],el=e("_",b("ReflectionProbeStage")(((Tu=function(e){function t(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return(t=e.call.apply(e,[this].concat(n))||this)._frameBuffer=null,t._renderArea=new wi,t._probe=null,t._probeRenderQueue=void 0,t._rgbeColor=new i,t}S(t,e);var r=t.prototype;return r.setUsageInfo=function(e,t){this._probe=e,this._frameBuffer=t},r.destroy=function(){var e;this._frameBuffer=null,null===(e=this._probeRenderQueue)||void 0===e||e.clear()},r.clearFramebuffer=function(e){if(this._frameBuffer){$u[0].w=e.clearColor.w;var t=this._pipeline,i=t.pipelineSceneData.shadingScale,r=e.viewport,n=this._probe.resolution;this._renderArea.x=r.x*n,this._renderArea.y=r.y*n,this._renderArea.width=r.width*n*i,this._renderArea.height=r.height*n*i;var a=t.commandBuffers[0],s=this._frameBuffer.renderPass;a.beginRenderPass(s,this._frameBuffer,this._renderArea,$u,e.clearDepth,e.clearStencil),a.endRenderPass()}},r.render=function(e){var t=this._pipeline,i=t.commandBuffers[0];this._probeRenderQueue.gatherRenderObjects(this._probe,e,i),t.pipelineUBO.updateCameraUBO(this._probe.camera),this._renderArea.x=0,this._renderArea.y=0,this._renderArea.width=this._probe.renderArea().x,this._renderArea.height=this._probe.renderArea().y;var r=this._frameBuffer.renderPass;if(this._probe.camera.clearFlag&Jt.COLOR){this._rgbeColor.x=this._probe.camera.clearColor.x,this._rgbeColor.y=this._probe.camera.clearColor.y,this._rgbeColor.z=this._probe.camera.clearColor.z;var n=k(this._rgbeColor);$u[0].x=n.x,$u[0].y=n.y,$u[0].z=n.z,$u[0].w=n.w}var a=t.device;i.beginRenderPass(r,this._frameBuffer,this._renderArea,$u,this._probe.camera.clearDepth,this._probe.camera.clearStencil),i.bindDescriptorSet(zt.GLOBAL,t.descriptorSet),this._probeRenderQueue.recordCommandBuffer(a,r,i),i.endRenderPass(),t.pipelineUBO.updateCameraUBO(e)},r.activate=function(t,i){e.prototype.activate.call(this,t,i),this._probeRenderQueue=new Ju(t)},t}(Ja)).initInfo={name:"ReflectionProbeStage",priority:hs.FORWARD,tag:0},Su=Tu))||Su),tl=e("Z",b("ReflectionProbeFlow")(((yu=function(e){function t(){return e.apply(this,arguments)||this}S(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new el;i.initialize(el.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(e){if(a.internal.reflectionProbeManager)for(var t=a.internal.reflectionProbeManager.getProbes(),i=0;i<t.length;i++)t[i].needRender&&t[i].probeType===dr.PLANAR&&this._renderStage(e,t[i])},i.destroy=function(){e.prototype.destroy.call(this)},i._renderStage=function(e,t){for(var i=0;i<this._stages.length;i++){var r=this._stages[i];if(t.probeType===dr.PLANAR)a.internal.reflectionProbeManager.updatePlanarMap(t,null),r.setUsageInfo(t,t.realtimePlanarTexture.window.framebuffer),r.render(e),a.internal.reflectionProbeManager.updatePlanarMap(t,t.realtimePlanarTexture.getGFXTexture());else{for(var n=0;n<6;n++){var s=t.bakedCubeTextures[n];if(!s)return;t.updateCameraDir(n),r.setUsageInfo(t,s.window.framebuffer),r.render(e)}t.needRender=!1}}},t}(es)).initInfo={name:"PIPELINE_FLOW_RELECTION_PROBE",priority:0,tag:xo.SCENE,stages:[]},wu=yu))||wu),il=e("F",(Au=b("ForwardPipeline"),Ru=D([zo]),Au((bu=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).renderTextures=Nu&&Nu(),t._postRenderPass=null,t}S(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new jh;i.initialize(jh.initInfo),this._flows.push(i);var r=new tl;r.initialize(tl.initInfo),this._flows.push(r);var n=new Mh;n.initialize(Mh.initInfo),this._flows.push(n)}return!0},i.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new _u,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(p(2402),1))},i._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,r=0;r<e.length;++r){var n=e[r].window;t=Math.max(n.width,t),i=Math.max(n.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i)},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Ht,t),this._descriptorSet.bindTexture(Ht,Oe.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Vt,t),this._descriptorSet.bindTexture(Vt,Oe.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(xt.BINDING).destroy(),this._descriptorSet.getBuffer(Ct.BINDING).destroy(),this._descriptorSet.getBuffer(Ut.BINDING).destroy(),this._descriptorSet.getTexture(Ht).destroy(),this._descriptorSet.getTexture(Vt).destroy())},l(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(Wo),Nu=N(bu.prototype,"renderTextures",[Ru,I],(function(){return[]})),Ou=bu))||Ou)),rl=[new ei(0,0,0,0),new ei(0,0,0,0),new ei(0,0,0,0)],nl=e("J",(Iu=b("GbufferStage"),Du=D([Ko]),Iu(((Fu=function(e){function t(){var t;return(t=e.call(this)||this).renderQueues=Lu&&Lu(),t._renderQueues=[],t._renderArea=new wi,t._instancedQueue=void 0,t._phaseID=we("default"),t._instancedQueue=new th,t}S(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=Jo(this.renderQueues[r])},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach($o),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var r=t.pipelineSceneData.renderObjects,n=0,a=0,s=0,o=0;o<r.length;++o){var h=r[o],u=h.model.subModels;for(n=0;n<u.length;++n){var l=u[n],c=l.passes;for(a=0;a<c.length;++a){var d=c[a];if(d.phase===this._phaseID)if(d.batchingScheme===ye.INSTANCING){var _=d.getInstancedBuffer();_.merge(l,a),this._instancedQueue.queue.add(_)}else for(s=0;s<this._renderQueues.length;s++)this._renderQueues[s].insertRenderPass(h,n,a)}}}this._renderQueues.forEach(eh);var p=t.commandBuffers[0];this._instancedQueue.uploadBuffers(p),e.clearFlag&Jt.COLOR&&(t.pipelineSceneData.isHDR?Ve(rl[0],e.clearColor):(rl[0].x=e.clearColor.x,rl[0].y=e.clearColor.y,rl[0].z=e.clearColor.z)),rl[0].w=e.clearColor.w;var f=t.getPipelineRenderData().gbufferFrameBuffer,g=f.renderPass;p.beginRenderPass(g,f,this._renderArea,rl,e.clearDepth,e.clearStencil),p.setScissor(t.generateScissor(e)),p.setViewport(t.generateViewport(e)),p.bindDescriptorSet(zt.GLOBAL,t.descriptorSet);for(var m=0;m<this.renderQueues.length;m++)this._renderQueues[m].recordCommandBuffer(i,g,p);this._instancedQueue.recordCommandBuffer(i,g,p),p.endRenderPass()},t}(Ja)).initInfo={name:"GbufferStage",priority:ls.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:Qo.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:Qo.BACK_TO_FRONT,stages:["default"]}]},Lu=N((Cu=Fu).prototype,"renderQueues",[Du,I],(function(){return[]})),Pu=Cu))||Pu)),al=new i,sl=new f(0,0,0,.5,.5,.5),ol=new f,hl=[new ei(0,0,0,1)],ul=e("K",(Mu=b("LightingStage"),Bu=D(Le),xu=D([Ko]),Mu(((Gu=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=Kt.LIGHTS_PER_PASS,t._lightBufferData=void 0,t._lightMeterScale=1e4,t._descriptorSet=null,t._descriptorSetLayout=void 0,t._renderArea=new wi,t._uiPhase=void 0,t._deferredMaterial=Hu&&Hu(),t.renderQueues=Vu&&Vu(),t._phaseID=we("default"),t._renderQueues=[],t._uiPhase=new Ch,t}S(t,e);var r=t.prototype;return r.initialize=function(t){return e.prototype.initialize.call(this,t),!0},r.gatherLights=function(e){for(var t=this._pipeline,r=t.commandBuffers[0],n=e.scene.sphereLights,a=e.scene.spotLights,s=e.scene.pointLights,o=e.scene.rangedDirLights,h=T.create(0,0,0,1),l=new Float32Array(4),c=e.exposure,d=0,_=u.length,p=_*this._maxDeferredLights,g=0;g<n.length&&d<this._maxDeferredLights;g++,++d){var m=n[g];if(T.set(h,m.position.x,m.position.y,m.position.z,m.range),y.sphereFrustum(h,e.frustum)){if(i.toArray(l,m.position),l[3]=Lr.SPHERE,this._lightBufferData.set(l,d*_),i.toArray(l,m.color),m.useColorTemperature){var v=m.finalColor;l[0]=v.x,l[1]=v.y,l[2]=v.z}t.pipelineSceneData.isHDR?l[3]=m.luminance*c*this._lightMeterScale:l[3]=m.luminance,this._lightBufferData.set(l,d*_+1*p),l[0]=m.size,l[1]=m.range,l[2]=0,this._lightBufferData.set(l,d*_+2*p)}}for(var E=0;E<a.length&&d<this._maxDeferredLights;E++,++d){var S=a[E];if(T.set(h,S.position.x,S.position.y,S.position.z,S.range),y.sphereFrustum(h,e.frustum)){if(i.toArray(l,S.position),l[3]=Lr.SPOT,this._lightBufferData.set(l,d*_+0*p),i.toArray(l,S.color),S.useColorTemperature){var w=S.finalColor;l[0]=w.x,l[1]=w.y,l[2]=w.z}t.pipelineSceneData.isHDR?l[3]=S.luminance*c*this._lightMeterScale:l[3]=S.luminance,this._lightBufferData.set(l,d*_+1*p),l[0]=S.size,l[1]=S.range,l[2]=S.spotAngle,this._lightBufferData.set(l,d*_+2*p),i.toArray(l,S.direction),this._lightBufferData.set(l,d*_+3*p)}}for(var A=0;A<s.length&&d<this._maxDeferredLights;A++,++d){var R=s[A];if(T.set(h,R.position.x,R.position.y,R.position.z,R.range),y.sphereFrustum(h,e.frustum)){if(i.toArray(l,R.position),l[3]=Lr.POINT,this._lightBufferData.set(l,d*_),i.toArray(l,R.color),R.useColorTemperature){var O=R.finalColor;l[0]=O.x,l[1]=O.y,l[2]=O.z}t.pipelineSceneData.isHDR?l[3]=R.luminance*c*this._lightMeterScale:l[3]=R.luminance,this._lightBufferData.set(l,d*_+1*p),l[0]=0,l[1]=R.range,l[2]=0,this._lightBufferData.set(l,d*_+2*p)}}for(var b=0;b<o.length&&d<this._maxDeferredLights;b++,++d){var N=o[b];if(f.transform(ol,sl,N.node.getWorldMatrix()),y.aabbFrustum(ol,e.frustum)){if(i.toArray(l,N.position),l[3]=Lr.RANGED_DIRECTIONAL,this._lightBufferData.set(l,d*_),i.toArray(l,N.color),N.useColorTemperature){var I=N.finalColor;l[0]=I.x,l[1]=I.y,l[2]=I.z}t.pipelineSceneData.isHDR?l[3]=N.illuminance*c:l[3]=N.illuminance,this._lightBufferData.set(l,d*_+1*p),i.toArray(l,N.right),l[3]=0,this._lightBufferData.set(l,d*_+2*p),i.toArray(l,N.direction),l[3]=0,this._lightBufferData.set(l,d*_+3*p);var D=N.scale;al.set(.5*D.x,.5*D.y,.5*D.z),i.toArray(l,al),l[3]=0,this._lightBufferData.set(l,d*_+4*p)}}var P=3*p+3;this._lightBufferData.set([d],P),r.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},r._createStageDescriptor=function(e){var t=this._pipeline.device,i=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;i=Math.ceil(i/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,i,t.capabilities.uboOffsetAlignment));var r=t.createBuffer(new ki(this._deferredLitsBufs,0,i));this._lightBufferData=new Float32Array(i/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new di(e.localSetLayout)),this._descriptorSet.bindBuffer(Qt.BINDING,r);var n=t.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.DEVICE,Rt.SIZE,Rt.SIZE));this._descriptorSet.bindBuffer(Rt.BINDING,n)},r.activate=function(t,i){e.prototype.activate.call(this,t,i),this._uiPhase.activate(t);for(var r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=Jo(this.renderQueues[r]);this._planarQueue=new Ph(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},r.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},r.render=function(e){var t,i=this._pipeline,r=i.device,n=i.commandBuffers[0],a=i.pipelineSceneData,s=a.renderObjects;this._planarQueue.gatherShadowPasses(e,n),i.generateRenderArea(e,this._renderArea);for(var o=i.getPipelineRenderData(),h=a.deferredLightingMaterial.passes[0],u=h.getShaderVariant(),l=0;l<3;++l)h.descriptorSet.bindTexture(l,o.gbufferRenderTargets[l]),h.descriptorSet.bindSampler(l,o.sampler);h.descriptorSet.bindTexture(3,o.outputDepth),h.descriptorSet.bindSampler(3,o.sampler),h.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(h),this.gatherLights(e),e.clearFlag&Jt.COLOR&&(hl[0].x=e.clearColor.x,hl[0].y=e.clearColor.y,hl[0].z=e.clearColor.z),hl[0].w=0;var c=o.outputFrameBuffer,d=c.renderPass;i.pipelineUBO.updateShadowUBO(e),n.beginRenderPass(d,c,this._renderArea,hl,e.clearDepth,e.clearStencil),n.setScissor(i.generateScissor(e)),n.setViewport(i.generateViewport(e)),n.bindDescriptorSet(zt.GLOBAL,i.descriptorSet);var _=i.quadIAOffscreen,p=null;null!=h&&null!=u&&null!=_&&(p=Wt.getOrCreatePipelineState(r,h,u,d,_)),null!=p&&(this._descriptorSet.update(),n.bindPipelineState(p),n.bindDescriptorSet(zt.MATERIAL,h.descriptorSet),n.bindDescriptorSet(zt.LOCAL,this._descriptorSet),n.bindInputAssembler(_),n.draw(_)),this._renderQueues.forEach($o);for(var f=0,g=0,m=0,v=0;v<s.length;++v){var E=s[v],S=E.model.subModels;for(f=0;f<S.length;++f){var T=S[f].passes;for(g=0;g<T.length;++g)if(T[g].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(E,f,g)}}if(s.length>0){this._renderQueues.forEach(eh);for(var w=0;w<this._renderQueues.length;w++)this._renderQueues[w].recordCommandBuffer(r,d,n);this._planarQueue.recordCommandBuffer(r,d,n)}null===(t=e.geometryRenderer)||void 0===t||t.render(d,n,i.pipelineSceneData),this._uiPhase.render(e,d),n.endRenderPass()},t}(Ja)).initInfo={name:"LightingStage",priority:ls.LIGHTING,tag:0},Hu=N((ku=Gu).prototype,"_deferredMaterial",[Bu,I],(function(){return null})),Vu=N(ku.prototype,"renderQueues",[xu,I],(function(){return[]})),Uu=ku))||Uu)),ll=[new ei(0,0,0,1)],cl=e("Q",(Wu=b("PostProcessStage"),zu=D(Le),Qu=D([Ko]),Wu(((qu=function(e){function t(){var t;return(t=e.call(this)||this)._postProcessMaterial=Ku&&Ku(),t.renderQueues=Xu&&Xu(),t._renderArea=new wi,t._stageDesc=void 0,t._localUBO=void 0,t._uiPhase=new Ch,t}S(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){var t=this._pipeline,i=t.device,r=t.pipelineSceneData,n=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var a=e.viewport;this._renderArea.x=a.x*e.window.width,this._renderArea.y=a.y*e.window.height,this._renderArea.width=a.width*e.window.width,this._renderArea.height=a.height*e.window.height;var s=t.getPipelineRenderData(),o=e.window.framebuffer,h=t.getRenderPass(e.clearFlag,o);e.clearFlag&Jt.COLOR&&(ll[0].x=e.clearColor.x,ll[0].y=e.clearColor.y,ll[0].z=e.clearColor.z),ll[0].w=e.clearColor.w,n.beginRenderPass(h,o,this._renderArea,ll,e.clearDepth,e.clearStencil),n.bindDescriptorSet(zt.GLOBAL,t.descriptorSet);var u=r.postprocessMaterial.passes[0],l=u.getShaderVariant();t.bloomEnabled?u.descriptorSet.bindTexture(0,s.bloom.combineTex):u.descriptorSet.bindTexture(0,s.outputRenderTargets[0]),u.descriptorSet.bindSampler(0,s.sampler),u.descriptorSet.update();var c=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,d=null;null!=u&&null!=l&&null!=c&&(d=Wt.getOrCreatePipelineState(i,u,l,h,c));var _=t.pipelineSceneData.renderObjects;null!=d&&_.length>0&&(this._stageDesc||(this._stageDesc=i.createDescriptorSet(new di(u.localSetLayout)),this._localUBO=i.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.DEVICE,Rt.SIZE,Rt.SIZE)),this._stageDesc.bindBuffer(Rt.BINDING,this._localUBO)),this._stageDesc.update(),n.bindPipelineState(d),n.bindDescriptorSet(zt.MATERIAL,u.descriptorSet),n.bindDescriptorSet(zt.LOCAL,this._stageDesc),n.bindInputAssembler(c),n.draw(c)),this._uiPhase.render(e,h),Ue(i,h,n,t.profiler,e),n.endRenderPass()},t}(Ja)).initInfo={name:"PostProcessStage",priority:os.POST_PROCESS,tag:0},Ku=N((Yu=qu).prototype,"_postProcessMaterial",[zu,I],(function(){return null})),Xu=N(Yu.prototype,"renderQueues",[Qu,I],(function(){return[]})),ju=Yu))||ju));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(Zu||(Zu={}));var dl,_l,pl,fl,gl,ml,vl=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._antiAliasing=Zu.NONE,t}S(t,e);var i=t.prototype;return i.updatePipelineSceneData=function(){this.updatePipelinePassInfo()},i.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=0;t<6;++t){var i=this._bloomMaterial.passes[1+t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently();var r=this._bloomMaterial.passes[7+t];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently()}var n=this._bloomMaterial.passes[13];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}},i.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},i.initPipelinePassInfo=function(){var e=new Le;e._uuid="builtin-deferred-material",e.initialize({effectName:"pipeline/deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var i=new Le;i._uuid="builtin-bloom-material",i.initialize({effectName:"pipeline/bloom"});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();this._bloomMaterial=i;var n=new Le;n._uuid="builtin-post-process-material",n.initialize({effectName:"pipeline/post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var a=0;a<n.passes.length;++a)n.passes[a].tryCompile();this._postprocessMaterial=n,this.updatePipelinePassInfo()},i.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},i.activate=function(t){return e.prototype.activate.call(this,t),this.initPipelinePassInfo(),!0},i.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},i.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){a.director.root.pipeline.macros.CC_RECEIVE_SHADOW=1;var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},l(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var i=new Le;i.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var r=0;r<i.passes.length;++r)i.passes[r].tryCompile();this._postprocessMaterial=i}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(_u),El=[new ei(0,0,0,1)],Sl=function(){};Sl.SIZE=4*(Sl.COUNT=4+(Sl.TEXTURE_SIZE_OFFSET=0));var Tl,wl,yl,Al,Rl,Ol,bl,Nl=e("N",(dl=b("BloomStage"),_l=D(Le),dl(((ml=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,t._bloomMaterial=gl&&gl(),t._renderArea=new wi,t._bloomUBO=[],t}S(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},i.destroy=function(){},i.render=function(e){var t,i=this._pipeline;if(i.generateBloomRenderData(),(null!==(t=e.window)&&void 0!==t&&t.swapchain||i.macros.CC_PIPELINE_TYPE)&&i.bloomEnabled&&0!==i.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var r=0;r<14;++r)this._bloomUBO[r]=i.device.createBuffer(new _i(pi.UNIFORM|pi.TRANSFER_DST,fi.HOST|fi.DEVICE,Sl.SIZE,Sl.SIZE));e.clearFlag&Jt.COLOR&&(El[0].x=e.clearColor.x,El[0].y=e.clearColor.y,El[0].z=e.clearColor.z),El[0].w=e.clearColor.w,this._prefilterPass(e,i),this._downsamplePass(e,i),this._upsamplePass(e,i),this._combinePass(e,i)}},i._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial.passes[0],n=t.getPipelineRenderData(),a=n.bloom,s=new Float32Array(Sl.COUNT);s[Sl.TEXTURE_SIZE_OFFSET+2]=this.threshold,i.updateBuffer(this._bloomUBO[0],s),i.beginRenderPass(a.renderPass,a.prefilterFramebuffer,this._renderArea,El,0,0),i.bindDescriptorSet(zt.GLOBAL,t.descriptorSet),r.descriptorSet.bindBuffer(0,this._bloomUBO[0]),r.descriptorSet.bindTexture(1,n.outputRenderTargets[0]),r.descriptorSet.bindSampler(1,a.sampler),r.descriptorSet.update(),i.bindDescriptorSet(zt.MATERIAL,r.descriptorSet);var o=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null,u=r.getShaderVariant();null!=r&&null!=u&&null!=o&&(h=Wt.getOrCreatePipelineState(t.device,r,u,a.renderPass,o)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(o),i.draw(o)),i.endRenderPass()},i._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,n=t.getPipelineRenderData().bloom,a=new Float32Array(Sl.COUNT),s=0;s<this.iterations;++s){a[Sl.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[Sl.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s+1],a),this._renderArea.width>>=1,this._renderArea.height>>=1,i.beginRenderPass(n.renderPass,n.downsampleFramebuffers[s],this._renderArea,El,0,0);var o=r.passes[1+s],h=o.getShaderVariant();o.descriptorSet.bindBuffer(0,this._bloomUBO[s+1]),0===s?o.descriptorSet.bindTexture(1,n.prefiterTex):o.descriptorSet.bindTexture(1,n.downsampleTexs[s-1]),o.descriptorSet.bindSampler(1,n.sampler),o.descriptorSet.update(),i.bindDescriptorSet(zt.MATERIAL,o.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null;null!=o&&null!=h&&null!=u&&(l=Wt.getOrCreatePipelineState(t.device,o,h,n.renderPass,u)),null!=l&&(i.bindPipelineState(l),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},i._upsamplePass=function(e,t){var i=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var r=t.commandBuffers[0],n=t.pipelineSceneData.bloomMaterial,a=new Float32Array(Sl.COUNT),s=0;s<this.iterations;++s){var o=s+6+1;a[Sl.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,a[Sl.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,r.updateBuffer(this._bloomUBO[o],a),this._renderArea.width<<=1,this._renderArea.height<<=1,r.beginRenderPass(i.renderPass,i.upsampleFramebuffers[this.iterations-1-s],this._renderArea,El,0,0);var h=n.passes[7+s],u=h.getShaderVariant();h.descriptorSet.bindBuffer(0,this._bloomUBO[o]),0===s?h.descriptorSet.bindTexture(1,i.downsampleTexs[this.iterations-1]):h.descriptorSet.bindTexture(1,i.upsampleTexs[this.iterations-s]),h.descriptorSet.bindSampler(1,i.sampler),h.descriptorSet.update(),r.bindDescriptorSet(zt.MATERIAL,h.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null;null!=h&&null!=u&&null!=l&&(c=Wt.getOrCreatePipelineState(t.device,h,u,i.renderPass,l)),null!=c&&(r.bindPipelineState(c),r.bindInputAssembler(l),r.draw(l)),r.endRenderPass()}},i._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,n=t.getPipelineRenderData(),a=n.bloom,s=new Float32Array(Sl.COUNT);s[Sl.TEXTURE_SIZE_OFFSET+3]=this.intensity,i.updateBuffer(this._bloomUBO[13],s),i.beginRenderPass(a.renderPass,a.combineFramebuffer,this._renderArea,El,0,0),i.bindDescriptorSet(zt.GLOBAL,t.descriptorSet);var o=r.passes[13];o.descriptorSet.bindBuffer(0,this._bloomUBO[13]),o.descriptorSet.bindTexture(1,n.outputRenderTargets[0]),o.descriptorSet.bindTexture(2,a.upsampleTexs[0]),o.descriptorSet.bindSampler(1,a.sampler),o.descriptorSet.bindSampler(2,a.sampler),o.descriptorSet.update(),i.bindDescriptorSet(zt.MATERIAL,o.descriptorSet);var h=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null,l=o.getShaderVariant();null!=o&&null!=l&&null!=h&&(u=Wt.getOrCreatePipelineState(t.device,o,l,a.renderPass,h)),null!=u&&(i.bindPipelineState(u),i.bindInputAssembler(h),i.draw(h)),i.endRenderPass()},t}(Ja)).initInfo={name:"BloomStage",priority:os.BLOOM,tag:0},gl=N((fl=ml).prototype,"_bloomMaterial",[_l,I],(function(){return null})),pl=fl))||pl)),Il=e("I",b("MainFlow")(((wl=function(e){function t(){return e.apply(this,arguments)||this}S(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new nl;i.initialize(nl.initInfo),this._stages.push(i);var r=new ul;r.initialize(ul.initInfo),this._stages.push(r);var n=new Nl;n.initialize(Nl.initInfo),this._stages.push(n);var a=new cl;a.initialize(cl.initInfo),this._stages.push(a)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(es)).initInfo={name:Xt,priority:cs.MAIN,stages:[]},Tl=wl))||Tl),Dl=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return S(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),Pl=e("H",(yl=b("DeferredPipeline"),Al=D([zo]),yl((Ol=function(e){function t(){for(var t,i=arguments.length,r=new Array(i),n=0;n<i;n++)r[n]=arguments[n];return(t=e.call.apply(e,[this].concat(r))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,t.renderTextures=bl&&bl(),t}S(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new jh;i.initialize(jh.initInfo),this._flows.push(i);var r=new Il;r.initialize(Il.initInfo),this._flows.push(r)}return!0},i.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new vl,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(p(2402),1))},i.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i.onGlobalPipelineStateChanged=function(){this.pipelineSceneData.updatePipelineSceneData()},i.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},i._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var i=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Ht,i),this._descriptorSet.bindTexture(Ht,Oe.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Vt,i),this._descriptorSet.bindTexture(Vt,Oe.get("default-texture").getGFXTexture()),this._descriptorSet.update();var r=new Go;if(!(r=this._createQuadInputAssembler()).quadIB||!r.quadVB||!r.quadIA)return!1;this._quadIB=r.quadIB,this._quadVBOffscreen=r.quadVB,this._quadIAOffscreen=r.quadIA;var n=this._createQuadInputAssembler();if(!n.quadIB||!n.quadVB||!n.quadIA)return!1;if(this._quadVBOnscreen=n.quadVB,this._quadIAOnscreen=n.quadIA,!this._gbufferRenderPass){var a=new Di;a.format=ni.RGBA16F,a.loadOp=Ai.CLEAR,a.storeOp=Ri.STORE;var s=new Di;s.format=ni.RGBA16F,s.loadOp=Ai.CLEAR,s.storeOp=Ri.STORE;var o=new Di;o.format=ni.RGBA16F,o.loadOp=Ai.CLEAR,o.storeOp=Ri.STORE;var h=new Pi;h.format=ni.DEPTH_STENCIL,h.depthLoadOp=Ai.CLEAR,h.depthStoreOp=Ri.STORE,h.stencilLoadOp=Ai.CLEAR,h.stencilStoreOp=Ri.STORE;var u=new Fi([a,s,o],h);this._gbufferRenderPass=t.createRenderPass(u)}if(!this._lightingRenderPass){var l=new Di;l.format=ni.RGBA8,l.loadOp=Ai.CLEAR,l.storeOp=Ri.STORE,l.barrier=t.getGeneralBarrier(new Ci(Li.NONE,Li.COLOR_ATTACHMENT_WRITE));var c=new Pi;c.format=ni.DEPTH_STENCIL,c.depthLoadOp=Ai.LOAD,c.depthStoreOp=Ri.DISCARD,c.stencilLoadOp=Ai.LOAD,c.stencilStoreOp=Ri.DISCARD,l.barrier=t.getGeneralBarrier(new Ci(Li.DEPTH_STENCIL_ATTACHMENT_WRITE,Li.DEPTH_STENCIL_ATTACHMENT_WRITE));var d=new Fi([l],c);this._lightingRenderPass=t.createRenderPass(d)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},i._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(xt.BINDING).destroy(),this._descriptorSet.getBuffer(Ct.BINDING).destroy(),this._descriptorSet.getBuffer(Ut.BINDING).destroy(),this._descriptorSet.getTexture(Ht).destroy(),this._descriptorSet.getTexture(Vt).destroy())},i._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var i=0;i<e.outputRenderTargets.length;i++)e.outputRenderTargets[i].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},i._ensureEnoughSize=function(e){for(var t=this._width,i=this._height,r=0;r<e.length;++r){var n=e[r].window;t=Math.max(n.width,t),i=Math.max(n.height,i)}t===this._width&&i===this._height||(this._width=t,this._height=i,this._destroyDeferredData(),this._generateDeferredRenderData())},i._generateDeferredRenderData=function(){for(var e=this,t=this.device,i=this._pipelineRenderData=new Dl,r=this.pipelineSceneData,n=0;n<3;++n)i.gbufferRenderTargets.push(t.createTexture(new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED,ni.RGBA16F,this._width*r.shadingScale,this._height*r.shadingScale)));i.outputDepth=t.createTexture(new ti(ii.TEX2D,ri.DEPTH_STENCIL_ATTACHMENT|ri.SAMPLED,ni.DEPTH_STENCIL,this._width*r.shadingScale,this._height*r.shadingScale)),i.gbufferFrameBuffer=t.createFramebuffer(new Bi(this._gbufferRenderPass,i.gbufferRenderTargets,i.outputDepth)),i.outputRenderTargets.push(t.createTexture(new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED,ni.RGBA16F,this._width*r.shadingScale,this._height*r.shadingScale))),i.outputFrameBuffer=t.createFramebuffer(new Bi(this._lightingRenderPass,i.outputRenderTargets,null)),i.sampler=this.globalDSManager.pointSampler,this.on($a.ATTACHMENT_SCALE_CAHNGED,(function(t){i.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,i.gbufferFrameBuffer=e.newFramebufferByRatio(i.gbufferFrameBuffer),i.gbufferFrameBuffer=e.newFramebufferByRatio(i.outputFrameBuffer)}))},t}(Wo),bl=N(Ol.prototype,"renderTextures",[Al,I],(function(){return[]})),Rl=Ol))||Rl));function Cl(){var e=new il;return e.initialize({flows:[]}),e}H.Attr.setClassAttr(Wi,"target","type","Object"),H.Attr.setClassAttr(Wi,"target","ctor",Ge);var Ll,Fl=e("a8",(function(e,t,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===r&&(r=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=r})),Ml=new Array(16),Bl=null,xl=new g,Ul=[zi.TOUCH_START,zi.TOUCH_MOVE,zi.TOUCH_END,zi.TOUCH_CANCEL],kl=[zi.MOUSE_DOWN,zi.MOUSE_ENTER,zi.MOUSE_MOVE,zi.MOUSE_LEAVE,zi.MOUSE_UP,zi.MOUSE_WHEEL];e("ax",Ll),function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(Ll||e("ax",Ll={}));var Hl=e("aw",function(){function e(e){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._dispatchingTouch=null,this._isEnabled=!1,this._node=void 0,this._node=e}var t=e.prototype;return t.setEnabled=function(t,i){if(void 0===i&&(i=!1),this._isEnabled!==t){this._isEnabled=t;var r=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(Ll.MARK_LIST_DIRTY),i&&r.length>0)for(var n=0;n<r.length;++n)r[n]._eventProcessor.setEnabled(t,!0);if(this._dispatchingTouch&&!this._isEnabled){var a=new st([this._dispatchingTouch],!0,ot.TOUCH_CANCEL);a.touch=this._dispatchingTouch,this.dispatchEvent(a),this.claimedTouchIdList.length=0,this._dispatchingTouch=null}}},t.reattach=function(){var t,i=this;this.node.walk((function(r){t||(t=i._searchComponentsInParent(e._maskComp)),r.eventProcessor.maskList=t}))},t.destroy=function(){if(Bl===this._node&&(Bl=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(Ll.REMOVE_POINTER_EVENT_PROCESSOR,this),this._dispatchingTouch){var t=new st([this._dispatchingTouch],!0,ot.TOUCH_CANCEL);t.touch=this._dispatchingTouch,this.dispatchEvent(t),this._dispatchingTouch=null}},t.on=function(e,t,i,r){var n,a;return this._tryEmittingAddEvent(e),((r=!!r)?null!==(n=this.capturingTarget)&&void 0!==n?n:this.capturingTarget=this._newCallbacksInvoker():null!==(a=this.bubblingTarget)&&void 0!==a?a:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,i),t},t.once=function(e,t,i,r){var n,a;return this._tryEmittingAddEvent(e),((r=!!r)?null!==(n=this.capturingTarget)&&void 0!==n?n:this.capturingTarget=this._newCallbacksInvoker():null!==(a=this.bubblingTarget)&&void 0!==a?a:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,i,!0),t},t.off=function(e,t,i,r){var n;null===(n=(r=!!r)?this.capturingTarget:this.bubblingTarget)||void 0===n||n.off(e,t,i)},t.targetOff=function(t){var i,r;null===(i=this.capturingTarget)||void 0===i||i.removeAll(t),null===(r=this.bubblingTarget)||void 0===r||r.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(Ll.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(e,t,i,r,n,a){var s;null===(s=this.bubblingTarget)||void 0===s||s.emit(e,t,i,r,n,a)},t.dispatchEvent=function(e){var t,i=this.node,r=0;for(e.target=i,Ml.length=0,this.getCapturingTargets(e.type,Ml),e.eventPhase=1,r=Ml.length-1;r>=0;--r)if((t=Ml[r]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,Ml),e.propagationStopped))return void(Ml.length=0);if(Ml.length=0,e.eventPhase=2,e.currentTarget=i,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,Ml),e.eventPhase=3,r=0;r<Ml.length;++r)if((t=Ml[r]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(Ml.length=0);Ml.length=0},t.hasEventListener=function(e,t,i){var r=!1;return this.bubblingTarget&&(r=this.bubblingTarget.hasEventListener(e,t,i)),!r&&this.capturingTarget&&(r=this.capturingTarget.hasEventListener(e,t,i)),r},t.getCapturingTargets=function(e,t){for(var i=this._node.parent;i;){var r;null!==(r=i.eventProcessor.capturingTarget)&&void 0!==r&&r.hasEventListener(e)&&t.push(i),i=i.parent}},t.getBubblingTargets=function(e,t){for(var i=this._node.parent;i;){var r;null!==(r=i.eventProcessor.bubblingTarget)&&void 0!==r&&r.hasEventListener(e)&&t.push(i),i=i.parent}},t.onUpdatingSiblingIndex=function(){e.callbacksInvoker.emit(Ll.MARK_LIST_DIRTY)},t._searchComponentsInParent=function(e){var t=this.node;if(e){for(var i=0,r=[],n=t;n&&Ge.isNode(n);n=n.parent,++i){var a=n.getComponent(e);if(a){var s={index:i,comp:a};r?r.push(s):r=[s]}}return r.length>0?r:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t._isTouchEvent=function(e){return-1!==Ul.indexOf(e)},t._isMouseEvent=function(e){return-1!==kl.indexOf(e)},t._hasTouchListeners=function(){for(var e=0;e<Ul.length;++e){var t=Ul[e];if(this.hasEventListener(t))return!0}return!1},t._hasMouseListeners=function(){for(var e=0;e<kl.length;++e){var t=kl[e];if(this.hasEventListener(t))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var i=this._isTouchEvent(t),r=this._isMouseEvent(t);i?this.shouldHandleEventTouch=!0:r&&(this.shouldHandleEventMouse=!0),!i&&!r||this._hasPointerListeners()||e.callbacksInvoker.emit(Ll.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,i=new V;return i._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(Ll.REMOVE_POINTER_EVENT_PROCESSOR,t)})),i},t._handleEventMouse=function(e){switch(e.type){case ot.MOUSE_DOWN:return this._handleMouseDown(e);case ot.MOUSE_MOVE:return this._handleMouseMove(e);case ot.MOUSE_UP:return this._handleMouseUp(e);case ot.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},t._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(xl),!t._uiProps.uiTransformComp.hitTest(xl,e.windowId)||(e.type=zi.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(xl),t._uiProps.uiTransformComp.hitTest(xl,e.windowId)?(this.previousMouseIn||(Bl&&Bl!==t&&(e.type=zi.MOUSE_LEAVE,Bl.dispatchEvent(e),Bl.eventProcessor.previousMouseIn=!1),Bl=t,e.type=zi.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=zi.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=zi.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,Bl=null),1)))},t._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(xl),!t._uiProps.uiTransformComp.hitTest(xl,e.windowId)||(e.type=zi.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(xl),!t._uiProps.uiTransformComp.hitTest(xl,e.windowId)||(e.type=zi.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleEventTouch=function(e){switch(e.type){case ot.TOUCH_START:return this._handleTouchStart(e);case ot.TOUCH_MOVE:return this._handleTouchMove(e);case ot.TOUCH_END:return this._handleTouchEnd(e);case ot.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},t._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(xl),!t._uiProps.uiTransformComp.hitTest(xl,e.windowId)||(e.type=zi.TOUCH_START,e.bubbles=!0,this._dispatchingTouch=e.touch,t.dispatchEvent(e),0)))},t._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=zi.TOUCH_MOVE,e.bubbles=!0,this._dispatchingTouch=e.touch,t.dispatchEvent(e),0))},t._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getLocation(xl),t._uiProps.uiTransformComp.hitTest(xl,e.windowId)?e.type=zi.TOUCH_END:e.type=zi.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e),this._dispatchingTouch=null)},t._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=zi.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},l(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}());Hl._maskComp=null,Hl.callbacksInvoker=new V,a.NodeEventProcessor=Hl,G({SystemEventType:{newName:"Input.EventType",since:"3.3.0",removed:!1}}),G({SystemEvent:{newName:"Input",since:"3.4.0",removed:!1},systemEvent:{newName:"input",since:"3.4.0",removed:!1}});var Vl=function(){function e(){this._isStarted=!1,this._accelMode="normal",this._eventTarget=new P,this._didAccelerateFunc=void 0,this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){W.onAccelerometerChange(this._didAccelerateFunc)},t._unregisterEvent=function(){W.offAccelerometerChange(this._didAccelerateFunc)},t._didAccelerate=function(e){var t=performance.now(),i=new Fl(e.x,e.y,e.z,t),r=new ht(i);this._eventTarget.emit(ot.DEVICEMOTION,r)},t.start=function(){var e=this;this._registerEvent(),W.startAccelerometer({interval:this._accelMode,success:function(){e._isStarted=!0}})},t.stop=function(){var e=this;W.stopAccelerometer({success:function(){e._isStarted=!1},fail:function(){console.error("failed to stop accelerometer")}}),this._unregisterEvent()},t.setInterval=function(e){this._accelMode=e>=200?"normal":e>=60?"ui":"game",this._isStarted&&(this.stop(),this.start())},t.on=function(e,t,i){this._eventTarget.on(e,t,i)},e}(),Gl=function(){},Wl=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t.prototype.getValue=function(){throw new Error("Method not implemented.")},t}(Gl),zl=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t.prototype.getValue=function(){throw new Error("Method not implemented.")},t}(Gl),Ql=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t.prototype.getValue=function(){throw new Error("Method not implemented.")},t}(Gl),jl=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t.prototype.getValue=function(){throw new Error("Method not implemented.")},t}(Gl),Yl=function(e){function t(t){var i;return(i=e.call(this)||this).positive=void 0,i.negative=void 0,i.positive=t.positive,i.negative=t.negative,i}return S(t,e),t.prototype.getValue=function(){var e=this.positive.getValue(),t=this.negative.getValue();return Math.abs(e)>Math.abs(t)?e:-t},t}(Wl),Kl=function(e){function t(t){var i;return(i=e.call(this)||this).up=void 0,i.down=void 0,i.left=void 0,i.right=void 0,i.xAxis=void 0,i.yAxis=void 0,i.up=t.up,i.down=t.down,i.left=t.left,i.right=t.right,i.xAxis=new Yl({positive:i.right,negative:i.left}),i.yAxis=new Yl({positive:i.up,negative:i.down}),i}return S(t,e),t.prototype.getValue=function(){return new g(this.xAxis.getValue(),this.yAxis.getValue())},t}(zl);!function(e){function t(t){var i;return(i=e.call(this)||this).up=void 0,i.down=void 0,i.left=void 0,i.right=void 0,i.forward=void 0,i.backward=void 0,i.xAxis=void 0,i.yAxis=void 0,i.zAxis=void 0,i.up=t.up,i.down=t.down,i.left=t.left,i.right=t.right,i.forward=t.forward,i.backward=t.backward,i.xAxis=new Yl({positive:i.right,negative:i.left}),i.yAxis=new Yl({positive:i.up,negative:i.down}),i.zAxis=new Yl({positive:i.forward,negative:i.backward}),i}S(t,e),t.prototype.getValue=function(){return new i(this.xAxis.getValue(),this.yAxis.getValue(),this.zAxis.getValue())}}(Ql);var Xl=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t.prototype.getValue=function(){return e.prototype.getValue.call(this)},t}(Wl),ql=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t}(Kl),Zl=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t}(Kl),Jl=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t.prototype.getValue=function(){return e.prototype.getValue.call(this)},t}(jl),$l=function(e){function t(){return e.apply(this,arguments)||this}return S(t,e),t.prototype.getValue=function(){return e.prototype.getValue.call(this)},t}(Ql),ec=function(){function e(e){this._buttonNorth=void 0,this._buttonEast=void 0,this._buttonWest=void 0,this._buttonSouth=void 0,this._buttonL1=void 0,this._buttonL2=void 0,this._buttonL3=void 0,this._buttonR1=void 0,this._buttonR2=void 0,this._buttonR3=void 0,this._buttonShare=void 0,this._buttonOptions=void 0,this._dpad=void 0,this._leftStick=void 0,this._rightStick=void 0,this._buttonStart=void 0,this._gripLeft=void 0,this._gripRight=void 0,this._handLeftPosition=void 0,this._handLeftOrientation=void 0,this._handRightPosition=void 0,this._handRightOrientation=void 0,this._aimLeftPosition=void 0,this._aimLeftOrientation=void 0,this._aimRightPosition=void 0,this._aimRightOrientation=void 0,this._deviceId=-1,this._connected=!1,this._deviceId=e,this._initInputSource()}return e._init=function(){},e._on=function(t,i,r){e._eventTarget.on(t,i,r)},e.prototype._initInputSource=function(){this._buttonNorth=new Xl,this._buttonNorth.getValue=function(){return 0},this._buttonEast=new Xl,this._buttonEast.getValue=function(){return 0},this._buttonWest=new Xl,this._buttonWest.getValue=function(){return 0},this._buttonSouth=new Xl,this._buttonSouth.getValue=function(){return 0},this._buttonL1=new Xl,this._buttonL1.getValue=function(){return 0},this._buttonL2=new Xl,this._buttonL2.getValue=function(){return 0},this._buttonL3=new Xl,this._buttonL3.getValue=function(){return 0},this._buttonR1=new Xl,this._buttonR1.getValue=function(){return 0},this._buttonR2=new Xl,this._buttonR2.getValue=function(){return 0},this._buttonR3=new Xl,this._buttonR3.getValue=function(){return 0},this._buttonShare=new Xl,this._buttonShare.getValue=function(){return 0},this._buttonOptions=new Xl,this._buttonOptions.getValue=function(){return 0};var e=new Xl;e.getValue=function(){return 0};var t=new Xl;t.getValue=function(){return 0};var r=new Xl;r.getValue=function(){return 0};var n=new Xl;n.getValue=function(){return 0},this._dpad=new ql({up:e,down:t,left:r,right:n});var a=new Xl;a.getValue=function(){return 0};var s=new Xl;s.getValue=function(){return 0};var o=new Xl;o.getValue=function(){return 0};var h=new Xl;h.getValue=function(){return 0},this._leftStick=new Zl({up:a,down:s,left:o,right:h});var u=new Xl;u.getValue=function(){return 0};var l=new Xl;l.getValue=function(){return 0};var c=new Xl;c.getValue=function(){return 0};var d=new Xl;d.getValue=function(){return 0},this._rightStick=new Zl({up:u,down:l,left:c,right:d}),this._buttonStart=new Xl,this._buttonStart.getValue=function(){return 0},this._gripLeft=new Xl,this._gripLeft.getValue=function(){return 0},this._gripRight=new Xl,this._gripRight.getValue=function(){return 0},this._handLeftPosition=new $l,this._handLeftPosition.getValue=function(){return i.ZERO},this._handLeftOrientation=new Jl,this._handLeftOrientation.getValue=function(){return m.IDENTITY},this._handRightPosition=new $l,this._handRightPosition.getValue=function(){return i.ZERO},this._handRightOrientation=new Jl,this._handRightOrientation.getValue=function(){return m.IDENTITY},this._aimLeftPosition=new $l,this._aimLeftPosition.getValue=function(){return i.ZERO},this._aimLeftOrientation=new Jl,this._aimLeftOrientation.getValue=function(){return m.IDENTITY},this._aimRightPosition=new $l,this._aimRightPosition.getValue=function(){return i.ZERO},this._aimRightOrientation=new Jl,this._aimRightOrientation.getValue=function(){return m.IDENTITY}},l(e,[{key:"buttonNorth",get:function(){return this._buttonNorth}},{key:"buttonEast",get:function(){return this._buttonEast}},{key:"buttonWest",get:function(){return this._buttonWest}},{key:"buttonSouth",get:function(){return this._buttonSouth}},{key:"buttonL1",get:function(){return this._buttonL1}},{key:"buttonL2",get:function(){return this._buttonL2}},{key:"buttonL3",get:function(){return this._buttonL3}},{key:"buttonR1",get:function(){return this._buttonR1}},{key:"buttonR2",get:function(){return this._buttonR2}},{key:"buttonR3",get:function(){return this._buttonR3}},{key:"buttonShare",get:function(){return this._buttonShare}},{key:"buttonOptions",get:function(){return this._buttonOptions}},{key:"dpad",get:function(){return this._dpad}},{key:"leftStick",get:function(){return this._leftStick}},{key:"rightStick",get:function(){return this._rightStick}},{key:"buttonStart",get:function(){return this._buttonStart}},{key:"gripLeft",get:function(){return this._gripLeft}},{key:"gripRight",get:function(){return this._gripRight}},{key:"handLeftPosition",get:function(){return this._handLeftPosition}},{key:"handLeftOrientation",get:function(){return this._handLeftOrientation}},{key:"handRightPosition",get:function(){return this._handRightPosition}},{key:"handRightOrientation",get:function(){return this._handRightOrientation}},{key:"aimLeftPosition",get:function(){return this._aimLeftPosition}},{key:"aimLeftOrientation",get:function(){return this._aimLeftOrientation}},{key:"aimRightPosition",get:function(){return this._aimRightPosition}},{key:"aimRightOrientation",get:function(){return this._aimRightOrientation}},{key:"deviceId",get:function(){return this._deviceId}},{key:"connected",get:function(){return this._connected}}]),e}();ec.all=[],ec.xr=null,ec._eventTarget=new P;var tc=function(){function e(){this._eventTarget=new P,this._buttonNorth=void 0,this._buttonEast=void 0,this._buttonWest=void 0,this._buttonSouth=void 0,this._buttonTriggerLeft=void 0,this._buttonTriggerRight=void 0,this._triggerLeft=void 0,this._triggerRight=void 0,this._gripLeft=void 0,this._gripRight=void 0,this._leftStick=void 0,this._rightStick=void 0,this._buttonLeftStick=void 0,this._buttonRightStick=void 0,this._buttonOptions=void 0,this._buttonStart=void 0,this._handLeftPosition=void 0,this._handLeftOrientation=void 0,this._handRightPosition=void 0,this._handRightOrientation=void 0,this._aimLeftPosition=void 0,this._aimLeftOrientation=void 0,this._aimRightPosition=void 0,this._aimRightOrientation=void 0,this._initInputSource()}var t=e.prototype;return t._on=function(e,t,i){this._eventTarget.on(e,t,i)},t._initInputSource=function(){this._buttonNorth=new Xl,this._buttonNorth.getValue=function(){return 0},this._buttonEast=new Xl,this._buttonEast.getValue=function(){return 0},this._buttonWest=new Xl,this._buttonWest.getValue=function(){return 0},this._buttonSouth=new Xl,this._buttonSouth.getValue=function(){return 0},this._buttonTriggerLeft=new Xl,this._buttonTriggerLeft.getValue=function(){return 0},this._buttonTriggerRight=new Xl,this._buttonTriggerRight.getValue=function(){return 0},this._triggerLeft=new Xl,this._triggerLeft.getValue=function(){return 0},this._triggerRight=new Xl,this._triggerRight.getValue=function(){return 0},this._gripLeft=new Xl,this._gripLeft.getValue=function(){return 0},this._gripRight=new Xl,this._gripRight.getValue=function(){return 0},this._buttonLeftStick=new Xl,this._buttonLeftStick.getValue=function(){return 0};var e=new Xl;e.getValue=function(){return 0};var t=new Xl;t.getValue=function(){return 0};var r=new Xl;r.getValue=function(){return 0};var n=new Xl;n.getValue=function(){return 0},this._leftStick=new Zl({up:e,down:t,left:r,right:n}),this._buttonRightStick=new Xl,this._buttonRightStick.getValue=function(){return 0};var a=new Xl;a.getValue=function(){return 0};var s=new Xl;s.getValue=function(){return 0};var o=new Xl;o.getValue=function(){return 0};var h=new Xl;h.getValue=function(){return 0},this._rightStick=new Zl({up:a,down:s,left:o,right:h}),this._buttonOptions=new Xl,this._buttonOptions.getValue=function(){return 0},this._buttonStart=new Xl,this._buttonStart.getValue=function(){return 0},this._handLeftPosition=new $l,this._handLeftPosition.getValue=function(){return i.ZERO},this._handLeftOrientation=new Jl,this._handLeftOrientation.getValue=function(){return m.IDENTITY},this._handRightPosition=new $l,this._handRightPosition.getValue=function(){return i.ZERO},this._handRightOrientation=new Jl,this._handRightOrientation.getValue=function(){return m.IDENTITY},this._aimLeftPosition=new $l,this._aimLeftPosition.getValue=function(){return i.ZERO},this._aimLeftOrientation=new Jl,this._aimLeftOrientation.getValue=function(){return m.IDENTITY},this._aimRightPosition=new $l,this._aimRightPosition.getValue=function(){return i.ZERO},this._aimRightOrientation=new Jl,this._aimRightOrientation.getValue=function(){return m.IDENTITY}},l(e,[{key:"buttonNorth",get:function(){return this._buttonNorth}},{key:"buttonEast",get:function(){return this._buttonEast}},{key:"buttonWest",get:function(){return this._buttonWest}},{key:"buttonSouth",get:function(){return this._buttonSouth}},{key:"buttonTriggerLeft",get:function(){return this._buttonTriggerLeft}},{key:"buttonTriggerRight",get:function(){return this._buttonTriggerRight}},{key:"triggerLeft",get:function(){return this._triggerLeft}},{key:"triggerRight",get:function(){return this._triggerRight}},{key:"gripLeft",get:function(){return this._gripLeft}},{key:"gripRight",get:function(){return this._gripRight}},{key:"leftStick",get:function(){return this._leftStick}},{key:"rightStick",get:function(){return this._rightStick}},{key:"buttonLeftStick",get:function(){return this._buttonLeftStick}},{key:"buttonRightStick",get:function(){return this._buttonRightStick}},{key:"buttonOptions",get:function(){return this._buttonOptions}},{key:"buttonStart",get:function(){return this._buttonStart}},{key:"handLeftPosition",get:function(){return this._handLeftPosition}},{key:"handLeftOrientation",get:function(){return this._handLeftOrientation}},{key:"handRightPosition",get:function(){return this._handRightPosition}},{key:"handRightOrientation",get:function(){return this._handRightOrientation}},{key:"aimLeftPosition",get:function(){return this._aimLeftPosition}},{key:"aimLeftOrientation",get:function(){return this._aimLeftOrientation}},{key:"aimRightPosition",get:function(){return this._aimRightPosition}},{key:"aimRightOrientation",get:function(){return this._aimRightOrientation}}]),e}(),ic=function(){function e(){this._eventTarget=new P,this._viewLeftPosition=void 0,this._viewLeftOrientation=void 0,this._viewRightPosition=void 0,this._viewRightOrientation=void 0,this._headMiddlePosition=void 0,this._headMiddleOrientation=void 0,this._initInputSource()}var t=e.prototype;return t._on=function(e,t,i){this._eventTarget.on(e,t,i)},t._initInputSource=function(){this._viewLeftPosition=new $l,this._viewLeftPosition.getValue=function(){return i.ZERO},this._viewLeftOrientation=new Jl,this._viewLeftOrientation.getValue=function(){return m.IDENTITY},this._viewRightPosition=new $l,this._viewRightPosition.getValue=function(){return i.ZERO},this._viewRightOrientation=new Jl,this._viewRightOrientation.getValue=function(){return m.IDENTITY},this._headMiddlePosition=new $l,this._headMiddlePosition.getValue=function(){return i.ZERO},this._headMiddleOrientation=new Jl,this._headMiddleOrientation.getValue=function(){return m.IDENTITY}},l(e,[{key:"viewLeftPosition",get:function(){return this._viewLeftPosition}},{key:"viewLeftOrientation",get:function(){return this._viewLeftOrientation}},{key:"viewRightPosition",get:function(){return this._viewRightPosition}},{key:"viewRightOrientation",get:function(){return this._viewRightOrientation}},{key:"headMiddlePosition",get:function(){return this._headMiddlePosition}},{key:"headMiddleOrientation",get:function(){return this._headMiddleOrientation}}]),e}(),rc=function(){function e(){this._eventTarget=new P,this._handheldPosition=void 0,this._handheldOrientation=void 0,this._initInputSource()}var t=e.prototype;return t._on=function(e,t,i){this._eventTarget.on(e,t,i)},t._initInputSource=function(){this._handheldPosition=new $l,this._handheldPosition.getValue=function(){return i.ZERO},this._handheldOrientation=new Jl,this._handheldOrientation.getValue=function(){return m.IDENTITY}},l(e,[{key:"handheldPosition",get:function(){return this._handheldPosition}},{key:"handheldOrientation",get:function(){return this._handheldOrientation}}]),e}(),nc={Backspace:ut.BACKSPACE,Tab:ut.TAB,Enter:ut.ENTER,ShiftLeft:ut.SHIFT_LEFT,ControlLeft:ut.CTRL_LEFT,AltLeft:ut.ALT_LEFT,ShiftRight:ut.SHIFT_RIGHT,ControlRight:ut.CTRL_RIGHT,AltRight:ut.ALT_RIGHT,Pause:ut.PAUSE,CapsLock:ut.CAPS_LOCK,Escape:ut.ESCAPE,Space:ut.SPACE,PageUp:ut.PAGE_UP,PageDown:ut.PAGE_DOWN,End:ut.END,Home:ut.HOME,ArrowLeft:ut.ARROW_LEFT,ArrowUp:ut.ARROW_UP,ArrowRight:ut.ARROW_RIGHT,ArrowDown:ut.ARROW_DOWN,Insert:ut.INSERT,Delete:ut.DELETE,Digit0:ut.DIGIT_0,Digit1:ut.DIGIT_1,Digit2:ut.DIGIT_2,Digit3:ut.DIGIT_3,Digit4:ut.DIGIT_4,Digit5:ut.DIGIT_5,Digit6:ut.DIGIT_6,Digit7:ut.DIGIT_7,Digit8:ut.DIGIT_8,Digit9:ut.DIGIT_9,KeyA:ut.KEY_A,KeyB:ut.KEY_B,KeyC:ut.KEY_C,KeyD:ut.KEY_D,KeyE:ut.KEY_E,KeyF:ut.KEY_F,KeyG:ut.KEY_G,KeyH:ut.KEY_H,KeyI:ut.KEY_I,KeyJ:ut.KEY_J,KeyK:ut.KEY_K,KeyL:ut.KEY_L,KeyM:ut.KEY_M,KeyN:ut.KEY_N,KeyO:ut.KEY_O,KeyP:ut.KEY_P,KeyQ:ut.KEY_Q,KeyR:ut.KEY_R,KeyS:ut.KEY_S,KeyT:ut.KEY_T,KeyU:ut.KEY_U,KeyV:ut.KEY_V,KeyW:ut.KEY_W,KeyX:ut.KEY_X,KeyY:ut.KEY_Y,KeyZ:ut.KEY_Z,Numpad0:ut.NUM_0,Numpad1:ut.NUM_1,Numpad2:ut.NUM_2,Numpad3:ut.NUM_3,Numpad4:ut.NUM_4,Numpad5:ut.NUM_5,Numpad6:ut.NUM_6,Numpad7:ut.NUM_7,Numpad8:ut.NUM_8,Numpad9:ut.NUM_9,NumpadMultiply:ut.NUM_MULTIPLY,NumpadAdd:ut.NUM_PLUS,NumpadSubtract:ut.NUM_SUBTRACT,NumpadDecimal:ut.NUM_DECIMAL,NumpadDivide:ut.NUM_DIVIDE,NumpadEnter:ut.NUM_ENTER,F1:ut.F1,F2:ut.F2,F3:ut.F3,F4:ut.F4,F5:ut.F5,F6:ut.F6,F7:ut.F7,F8:ut.F8,F9:ut.F9,F10:ut.F10,F11:ut.F11,F12:ut.F12,NumLock:ut.NUM_LOCK,ScrollLock:ut.SCROLL_LOCK,Semicolon:ut.SEMICOLON,Equal:ut.EQUAL,Comma:ut.COMMA,Minus:ut.DASH,Period:ut.PERIOD,Slash:ut.SLASH,Backquote:ut.BACK_QUOTE,BracketLeft:ut.BRACKET_LEFT,Backslash:ut.BACKSLASH,BracketRight:ut.BRACKET_RIGHT,Quote:ut.QUOTE};function ac(e){return nc[e]||ut.NONE}var sc,oc,hc=function(){function e(){this._eventTarget=new P,this._keyStateMap={},C.hasFeature(z.EVENT_KEYBOARD)&&this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e,t,i,r,n=this;null===(e=W.wx)||void 0===e||null===(t=e.onKeyDown)||void 0===t||t.call(e,(function(e){var t=ac(e.code);if(n._keyStateMap[t]){var i=n._getInputEvent(e,ot.KEY_PRESSING);n._eventTarget.emit(ot.KEY_PRESSING,i)}else{var r=n._getInputEvent(e,ot.KEY_DOWN);n._eventTarget.emit(ot.KEY_DOWN,r)}n._keyStateMap[t]=!0})),null===(i=W.wx)||void 0===i||null===(r=i.onKeyUp)||void 0===r||r.call(i,(function(e){var t=ac(e.code),i=n._getInputEvent(e,ot.KEY_UP);n._keyStateMap[t]=!1,n._eventTarget.emit(ot.KEY_UP,i)}))},t._getInputEvent=function(e,t){var i=ac(e.code);return new lt(i,t)},t.on=function(e,t,i){this._eventTarget.on(e,t,i)},e}(),uc=function(){function e(){this._eventTarget=new P,this._isPressed=!1,this._preMousePos=new g,C.hasFeature(z.EVENT_MOUSE)&&this._registerEvent()}var t=e.prototype;return t._getLocation=function(e){var t=Q.windowSize,i=Q.devicePixelRatio,r=e.x*i,n=t.height-e.y*i;return new g(r,n)},t._registerEvent=function(){var e,t,i,r,n,a,s,o;null===(e=W.wx)||void 0===e||null===(t=e.onMouseDown)||void 0===t||t.call(e,this._createCallback(ot.MOUSE_DOWN)),null===(i=W.wx)||void 0===i||null===(r=i.onMouseMove)||void 0===r||r.call(i,this._createCallback(ot.MOUSE_MOVE)),null===(n=W.wx)||void 0===n||null===(a=n.onMouseUp)||void 0===a||a.call(n,this._createCallback(ot.MOUSE_UP)),null===(s=W.wx)||void 0===s||null===(o=s.onWheel)||void 0===o||o.call(s,this._handleMouseWheel.bind(this))},t._createCallback=function(e){var t=this;return function(i){var r=t._getLocation(i),n=i.button;switch(e){case ot.MOUSE_DOWN:t._isPressed=!0;break;case ot.MOUSE_UP:t._isPressed=!1;break;case ot.MOUSE_MOVE:t._isPressed||(n=ct.BUTTON_MISSING)}var a=new ct(e,!1,t._preMousePos);a.setLocation(r.x,r.y),a.setButton(n),a.movementX=r.x-t._preMousePos.x,a.movementY=t._preMousePos.y-r.y,t._preMousePos.set(r.x,r.y),t._eventTarget.emit(e,a)}},t._handleMouseWheel=function(e){var t=ot.MOUSE_WHEEL,i=this._getLocation(e),r=e.button,n=new ct(t,!1,this._preMousePos);n.setLocation(i.x,i.y),n.setButton(r),n.movementX=i.x-this._preMousePos.x,n.movementY=this._preMousePos.y-i.y,n.setScrollData(e.deltaX,-e.deltaY),this._preMousePos.set(i.x,i.y),this._eventTarget.emit(ot.MOUSE_WHEEL,n)},t.on=function(e,t,i){this._eventTarget.on(e,t,i)},e}(),lc=new g,cc=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(lc);var i=new dt(lc.x,lc.y,t);return e.getLocation(lc),i.setPoint(lc.x,lc.y),e.getPreviousLocation(lc),i.setPrevPoint(lc),i},t._createTouch=function(e,t,i){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var r=new dt(t,i,e);return this._touchMap.set(e,r),this._updateTouch(r,t,i),this._cloneTouch(r)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e,t,i){var r=this._touchMap.get(e);return r?this._updateTouch(r,t,i):r=this._createTouch(e,t,i),r?this._cloneTouch(r):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touchMap.forEach((function(i){if(i){var r=e._cloneTouch(i);t.push(r)}})),t},t._updateTouch=function(e,t,i){e.getLocation(lc),e.setPrevPoint(lc),e.setPoint(t,i)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var i=O.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<i)return!1;var r=performance.now();return this._touchMap.forEach((function(e){r-e.lastModified>O.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),i>=this._touchMap.size},e}()),dc=function(){function e(){this._eventTarget=new P,C.hasFeature(z.INPUT_TOUCH)&&this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){W.onTouchStart(this._createCallback(ot.TOUCH_START)),W.onTouchMove(this._createCallback(ot.TOUCH_MOVE)),W.onTouchEnd(this._createCallback(ot.TOUCH_END)),W.onTouchCancel(this._createCallback(ot.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(i){for(var r=[],n=Q.windowSize,a=Q.devicePixelRatio,s=i.changedTouches.length,o=0;o<s;++o){var h=i.changedTouches[o],u=h.identifier;if(null!==u){var l=t._getLocation(h,n,a),c=cc.getTouch(u,l.x,l.y);c&&(e!==ot.TOUCH_END&&e!==ot.TOUCH_CANCEL||cc.releaseTouch(u),r.push(c))}}if(r.length>0){var d=new st(r,!1,e,O.ENABLE_MULTI_TOUCH?cc.getAllTouches():r);t._eventTarget.emit(e,d)}}},t._getLocation=function(e,t,i){var r=e.clientX*i,n=t.height-e.clientY*i;return new g(r,n)},t.on=function(e,t,i){this._eventTarget.on(e,t,i)},e}();e("av",oc),function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(oc||e("av",oc={}));var _c=function(){function e(e){this.priority=oc.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),pc=((sc={})[ot.MOUSE_DOWN]=ot.TOUCH_START,sc[ot.MOUSE_MOVE]=ot.TOUCH_MOVE,sc[ot.MOUSE_UP]=ot.TOUCH_END,sc),fc=e("aa",function(){function e(){this._dispatchImmediately=!Y,this._eventTarget=new P,this._touchInput=new dc,this._mouseInput=new uc,this._keyboardInput=new hc,this._accelerometerInput=new Vl,this._handleInput=new tc,this._hmdInput=new ic,this._handheldInput=new rc,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._eventGamepadList=[],this._eventHandleList=[],this._eventHMDList=[],this._eventHandheldList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new _c(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher),ec._init()}var t=e.prototype;return t._dispatchMouseDownEvent=function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseDownEvent)||void 0===t||t.call(i,e)},t._dispatchMouseMoveEvent=function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseMoveEvent)||void 0===t||t.call(i,e)},t._dispatchMouseUpEvent=function(e){var t,i;null===(t=(i=this._mouseInput).dispatchMouseUpEvent)||void 0===t||t.call(i,e)},t._dispatchMouseScrollEvent=function(e){var t,i;null===(t=(i=this._mouseInput).dispatchScrollEvent)||void 0===t||t.call(i,e)},t._dispatchKeyboardDownEvent=function(e){var t,i;null===(t=(i=this._keyboardInput).dispatchKeyboardDownEvent)||void 0===t||t.call(i,e)},t._dispatchKeyboardUpEvent=function(e){var t,i;null===(t=(i=this._keyboardInput).dispatchKeyboardUpEvent)||void 0===t||t.call(i,e)},t.on=function(e,t,i){return this._eventTarget.on(e,t,i),t},t.once=function(e,t,i){return this._eventTarget.once(e,t,i),t},t.off=function(e,t,i){this._eventTarget.off(e,t,i)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=pc[e.type],i=cc.getTouch(0,e.getLocationX(),e.getLocationY());if(i){var r=[i],n=new st(r,!1,t,t===ot.TOUCH_END?[]:r);n.windowId=e.windowId,t===ot.TOUCH_END&&cc.releaseTouch(0),this._dispatchOrPushEventTouch(n,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,i=0;i<t;++i){var r=this._eventDispatcherList[i];try{if(!r.dispatchEvent(e))break}catch(t){console.error("Error occurs in an event listener: "+e.type),console.error(t)}}},t._registerEvent=function(){var e=this;if(j.hasFeature(j.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(ot.TOUCH_START,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(ot.TOUCH_MOVE,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(ot.TOUCH_END,(function(i){e._dispatchOrPushEventTouch(i,t)})),this._touchInput.on(ot.TOUCH_CANCEL,(function(i){e._dispatchOrPushEventTouch(i,t)}))}if(j.hasFeature(j.Feature.EVENT_MOUSE)){var i=this._eventMouseList;this._mouseInput.on(ot.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(ot.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(ot.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,i)})),this._mouseInput.on(ot.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,i)}))}if(j.hasFeature(j.Feature.EVENT_KEYBOARD)){var r=this._eventKeyboardList;this._keyboardInput.on(ot.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,r)})),this._keyboardInput.on(ot.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,r)})),this._keyboardInput.on(ot.KEY_UP,(function(t){e._dispatchOrPushEvent(t,r)}))}if(j.hasFeature(j.Feature.EVENT_ACCELEROMETER)){var n=this._eventAccelerationList;this._accelerometerInput.on(ot.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,n)}))}if(j.hasFeature(j.Feature.EVENT_GAMEPAD)){var a=this._eventGamepadList;ec._on(ot.GAMEPAD_CHANGE,(function(t){e._dispatchOrPushEvent(t,a)})),ec._on(ot.GAMEPAD_INPUT,(function(t){e._dispatchOrPushEvent(t,a)})),ec._on(ot.HANDLE_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,a)}))}if(j.hasFeature(j.Feature.EVENT_HANDLE)){var s=this._eventHandleList;this._handleInput._on(ot.HANDLE_INPUT,(function(t){e._dispatchOrPushEvent(t,s)})),this._handleInput._on(ot.HANDLE_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,s)}))}if(j.hasFeature(j.Feature.EVENT_HMD)){var o=this._eventHMDList;this._hmdInput._on(ot.HMD_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,o)}))}if(j.hasFeature(j.Feature.EVENT_HANDHELD)){var h=this._eventHandheldList;this._handheldInput._on(ot.HANDHELD_POSE_INPUT,(function(t){e._dispatchOrPushEvent(t,h)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0,this._eventGamepadList.length=0,this._eventHandleList.length=0,this._eventHMDList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var i=e.getTouches(),r=i.length,n=0;n<r;++n)e.touch=i[n],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventHMDList,t=0,i=e.length;t<i;++t){var r=e[t];this._emitEvent(r)}for(var n=this._eventHandheldList,a=0,s=n.length;a<s;++a){var o=n[a];this._emitEvent(o)}for(var h=this._eventMouseList,u=0,l=h.length;u<l;++u){var c=h[u];this._emitEvent(c)}for(var d=this._eventTouchList,_=0,p=d.length;_<p;++_)for(var f=d[_],g=f.getTouches(),m=g.length,v=0;v<m;++v)f.touch=g[v],f.propagationStopped=f.propagationImmediateStopped=!1,this._emitEvent(f);for(var E=this._eventKeyboardList,S=0,T=E.length;S<T;++S){var w=E[S];this._emitEvent(w)}for(var y=this._eventAccelerationList,A=0,R=y.length;A<R;++A){var O=y[A];this._emitEvent(O)}for(var b=this._eventGamepadList,N=0,I=b.length;N<I;++N){var D=b[N];this._emitEvent(D)}for(var P=this._eventHandleList,C=0,L=P.length;C<L;++C){var F=P[C];this._emitEvent(F)}this._clearEvents()},e}());fc.EventType=ot;var gc=e("a9",new fc),mc=e("ac",function(e){function t(){var t;return t=e.call(this)||this,gc.on(ot.MOUSE_DOWN,(function(e){t.emit(_t.MOUSE_DOWN,e)})),gc.on(ot.MOUSE_MOVE,(function(e){t.emit(_t.MOUSE_MOVE,e)})),gc.on(ot.MOUSE_UP,(function(e){t.emit(_t.MOUSE_UP,e)})),gc.on(ot.MOUSE_WHEEL,(function(e){t.emit(_t.MOUSE_WHEEL,e)})),gc.on(ot.TOUCH_START,(function(e){t.emit(_t.TOUCH_START,e.touch,e)})),gc.on(ot.TOUCH_MOVE,(function(e){t.emit(_t.TOUCH_MOVE,e.touch,e)})),gc.on(ot.TOUCH_END,(function(e){t.emit(_t.TOUCH_END,e.touch,e)})),gc.on(ot.TOUCH_CANCEL,(function(e){t.emit(_t.TOUCH_CANCEL,e.touch,e)})),gc.on(ot.KEY_DOWN,(function(e){t.emit(_t.KEY_DOWN,e)})),gc.on(ot.KEY_PRESSING,(function(e){t.emit(_t.KEY_DOWN,e)})),gc.on(ot.KEY_UP,(function(e){t.emit(_t.KEY_UP,e)})),gc.on(ot.DEVICEMOTION,(function(e){t.emit(_t.DEVICEMOTION,e)})),t}S(t,e);var i=t.prototype;return i.setAccelerometerEnabled=function(e){gc.setAccelerometerEnabled(e)},i.setAccelerometerInterval=function(e){gc.setAccelerometerInterval(e)},i.on=function(t,i,r,n){return e.prototype.on.call(this,t,i,r,n),i},i.off=function(t,i,r){e.prototype.off.call(this,t,i,r)},t}(P));mc.EventType=_t,a.SystemEvent=mc;var vc,Ec=e("ab",new mc);a.systemEvent=Ec,K(_t,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),K(pt,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:mc.EventType,targetName:"SystemEvent.EventType"}]),F(pt,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),K(ct,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:mc.EventType,targetName:"SystemEvent.EventType"}}))),K(ct,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:mc.EventType,targetName:"SystemEvent.EventType"}]),F(ct.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),K(st,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:mc.EventType,targetName:"SystemEvent.EventType"}]),K(st,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:mc.EventType,targetName:"SystemEvent.EventType"}]),K(st,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:mc.EventType,targetName:"SystemEvent.EventType"}]),K(st,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:mc.EventType,targetName:"SystemEvent.EventType"}]),F(st.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),K(st.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:st,targetName:"EventTouch"}]),F(O.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),F(O.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),F(O.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),F(O.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),F(O,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),K(Ge.prototype,"Node",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),K(Ge.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new g),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new X),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),q(We.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),K(We.prototype,"SceneGlobals.prototype",[{name:"distance",newName:"planeHeight"},{name:"normal",newName:"planeDirection"},{name:"size",newName:"shadowMapSize"}]),q(Ge.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),K(ze.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),q(At,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),K(At,"Layers",[{name:"Default",newName:"DEFAULT",target:At.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:At.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:At.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:At.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:At.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:At.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:At.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:At.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:At,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:At,targetName:"Layers"}]),q(At.Enum,"Layers.Enum",[{name:"ALWAYS"}]),q(At.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var Sc=Z.Flags.HideInHierarchy,Tc=Z.Flags.DontSave,wc=e("a1",b("cc.PrivateNode")(vc=function(e){function t(t){var i;return i=e.call(this,t)||this,_(12003,i.name),i.hideFlags|=Tc|Sc,i}return S(t,e),t}(Ge))||vc);K(_t,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:Ge.EventType,targetName:"Node.EventType"}}))),K(Ge.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:mc.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:mc.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:mc.EventType,targetName:"SystemEvent.EventType"}]),a.PrivateNode=wc,G({BaseNode:{newName:"Node",since:"3.7.0",removed:!1}});var yc=$,Ac=Z.Flags.IsStartCalled,Rc=Z.Flags.IsOnEnableCalled;function Oc(e,t){for(var i=t.constructor._executionOrder,r=t._id,n=0,a=e.length-1,s=a>>>1;n<=a;s=n+a>>>1){var o=e[s],h=o.constructor._executionOrder;if(h>i)a=s-1;else if(h<i)n=s+1;else{var u=o._id;if(u>r)a=s-1;else{if(!(u<r))return s;n=s+1}}}return~n}function bc(e,t){for(var i=e.array,r=e.i+1;r<i.length;){var n=i[r];n.node._activeInHierarchy?++r:(e.removeAt(r),t&&(n._objFlags&=~t))}}Z.Flags.IsEditorOnEnableCalled;var Nc=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=J;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function Ic(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}Nc.stableRemoveInactive=bc;var Dc=function(e){function t(){return e.apply(this,arguments)||this}S(t,e);var i=t.prototype;return i.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},i.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},i.cancelInactive=function(e){bc(this._zero,e),bc(this._neg,e),bc(this._pos,e)},i.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(Ic),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(Ic),this._invoke(t),t.array.length=0)},t}(Nc),Pc=function(e){function t(){return e.apply(this,arguments)||this}S(t,e);var i=t.prototype;return i.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var i=t<0?this._neg.array:this._pos.array,r=Oc(i,e);r<0&&i.splice(~r,0,e)}},i.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var i=t<0?this._neg:this._pos,r=Oc(i.array,e);r>=0&&i.removeAt(r)}},i.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(Nc);function Cc(e,t,i){return function(r,n){try{t(r,n)}catch(t){a._throw(t);var s=r.array;for(i&&(s[r.i]._objFlags|=i),++r.i;r.i<s.length;++r.i)try{e(s[r.i],n)}catch(e){a._throw(e),i&&(s[r.i]._objFlags|=i)}}}}var Lc=Cc((function(e){e.start(),e._objFlags|=Ac}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];i.start(),i._objFlags|=Ac}}),Ac),Fc=Cc((function(e,t){e.update(t)}),(function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i)i[e.i].update(t)})),Mc=Cc((function(e,t){e.lateUpdate(t)}),(function(e,t){var i=e.array;for(e.i=0;e.i<i.length;++e.i)i[e.i].lateUpdate(t)})),Bc=function(e){var t=a.director._compScheduler,i=e.array;for(e.i=0;e.i<i.length;++e.i){var r=i[e.i];r._enabled&&(r.onEnable(),!r.node._activeInHierarchy||t._onEnabled(r))}},xc=function(){function e(){this.startInvoker=void 0,this.updateInvoker=void 0,this.lateUpdateInvoker=void 0,this._deferredComps=[],this._updating=void 0,this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new Dc(Lc),this.updateInvoker=new Pc(Fc),this.lateUpdateInvoker=new Pc(Mc),this._updating=!1},t._onEnabled=function(e){a.director.getScheduler().resumeTarget(e),e._objFlags|=Rc,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){a.director.getScheduler().pauseTarget(e),e._objFlags&=~Rc;var t=this._deferredComps.indexOf(e);t>=0?yc(this._deferredComps,t):(!e.start||e._objFlags&Ac||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&Rc)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&Rc&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&Ac||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,i=e.length;t<i;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),Uc=Z.Flags.IsPreloadStarted,kc=Z.Flags.IsOnLoadStarted,Hc=Z.Flags.IsOnLoadCalled,Vc=Z.Flags.Deactivating,Gc=function(e){function t(){return e.apply(this,arguments)||this}S(t,e);var i=t.prototype;return i.add=function(e){this._zero.array.push(e)},i.remove=function(e){this._zero.fastRemove(e)},i.cancelInactive=function(e){Nc.stableRemoveInactive(this._zero,e)},i.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(Nc),Wc=Cc((function(e){e.__preload()}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i)t[e.i].__preload()})),zc=Cc((function(e){e.onLoad(),e._objFlags|=Hc}),(function(e){var t=e.array;for(e.i=0;e.i<t.length;++e.i){var i=t[e.i];i.onLoad(),i._objFlags|=Hc}}),Hc),Qc=new ee(4);function jc(e,t,i){p(3817,e.name,i),console.log("Corrupted component value:",t),t?e._removeComponent(t):ie(e._components,i)}Qc.get=function(){var e=this._get()||{preload:new Gc(Wc),onLoad:new Dc(zc),onEnable:new Dc(Bc)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var Yc=e("$",function(){function e(){this.resetComp=void 0,this._activatingStack=void 0,this.reset()}var i=e.prototype;return i.reset=function(){this._activatingStack=[]},i.activateNode=function(e,i){if(i){var r=Qc.get();this._activatingStack.push(r),this._activateNodeRecursively(e,r.preload,r.onLoad,r.onEnable),r.preload.invoke(),r.onLoad.invoke(),r.onEnable.invoke(),this._activatingStack.pop(),Qc.put(r)}else{this._deactivateNodeRecursively(e);for(var n,a=this._activatingStack,s=t(a);!(n=s()).done;){var o=n.value;o.preload.cancelInactive(Uc),o.onLoad.cancelInactive(kc),o.onEnable.cancelInactive()}}e.emit(zi.ACTIVE_IN_HIERARCHY_CHANGED,e)},i.activateComp=function(e,t,i,r){if(te(e,!0)&&(e._objFlags&Uc||(e._objFlags|=Uc,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&kc||(e._objFlags|=kc,e.onLoad?i?i.add(e):(e.onLoad(),e._objFlags|=Hc):e._objFlags|=Hc),e._enabled)){if(!e.node._activeInHierarchy)return;a.director._compScheduler.enableComp(e,r)}},i.destroyComp=function(e){a.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&Hc&&e.onDestroy()},i._activateNodeRecursively=function(e,t,i,r){if(e._objFlags&Vc)p(3816,e.name);else{e._activeInHierarchy=!0;for(var n=e._components.length,s=0;s<n;++s){var o=e._components[s];o instanceof a.Component?this.activateComp(o,t,i,r):(jc(e,o,s),--s,--n)}for(var h=0,u=e._children.length;h<u;++h){var l=e._children[h];l._active&&this._activateNodeRecursively(l,t,i,r)}e._onPostActivated(!0)}},i._deactivateNodeRecursively=function(e){e._objFlags|=Vc,e._activeInHierarchy=!1;for(var t=e._components.length,i=0;i<t;++i){var r=e._components[i];if(r._enabled&&(a.director._compScheduler.disableComp(r),e._activeInHierarchy))return void(e._objFlags&=~Vc)}for(var n=0,s=e._children.length;n<s;++n){var o=e._children[n];if(o._activeInHierarchy&&(this._deactivateNodeRecursively(o),e._activeInHierarchy))return void(e._objFlags&=~Vc)}e._onPostActivated(!1),e._objFlags&=~Vc},e}()),Kc=Z.Flags.Destroyed,Xc=Z.Flags.PersistentMask,qc=H.Attr.DELIMETER+"default",Zc=H.IDENTIFIER_RE,Jc="var ",$c="o",ed={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},td=H.escapeForJS,id=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return Jc+this.varName+"="+this.expression+";"},e}();function rd(e,t){return t instanceof id?new id(t.varName,e+t.expression):e+t}function nd(e,t,i){Array.isArray(i)?(i[0]=rd(t,i[0]),e.push(i)):e.push(rd(t,i)+";")}var ad=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var i=0;i<this._exps.length;i++){var r=this._exps[i];nd(e,t+sd(r[0])+"=",r[1])}},e}();function sd(e){return Zc.test(e)?"."+e:"["+td(e)+"]"}ad.pool=void 0,ad.pool=new ee((function(e){e._exps.length=0,e._targetExp=null}),1),ad.pool.get=function(e){var t=this._get()||new ad;return t._targetExp=e,t};var od,hd,ud,ld,cd,dd,_d=function(){function e(e,t){var i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=re(),ne(this.funcModuleCache,ed),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(i=Jc+this.globalVariables.join(",")+";");var r=ir(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",r)(this.objs,this.funcs);for(var n=0,a=this.objsToClear_iN$t.length;n<a;++n)this.objsToClear_iN$t[n]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var i=ae(e);if(i){var r=this.funcModuleCache[i];if(r)return r;if(void 0===r){var n=-1!==i.indexOf(".");if(n)try{if(n=e===Function("return "+i)())return this.funcModuleCache[i]=i,i}catch(e){}}}var a=this.funcs.indexOf(e);a<0&&(a=this.funcs.length,this.funcs.push(e));var s="F["+a+"]";return t&&(s="("+s+")"),this.funcModuleCache[i]=s,s},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,i,r){var n=ad.pool.get(r),a=t.constructor.__props__;a||(a=Object.keys(t));for(var s=0;s<a.length;s++){var o=a[s],h=i[o];if(t[o]!==h){var u=this.enumerateField(i,o,h);n.append(o,u)}}n.writeCode(e),ad.pool.put(n)},t.enumerateCCClass=function(e,t,i){for(var r=i.__values__,n=H.Attr.getClassAttrs(i),s=0;s<r.length;s++){var o=r[s],h=t[o],u=n[o+qc];if(!pd(u,h))if("object"==typeof h&&h instanceof a.ValueType&&(u=H.getDefault(u))&&u.constructor===h.constructor){var l=$c+sd(o);this.setValueType(e,u,h,l)}else this.setObjProp(e,t,o,h)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,i=[new id(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)nd(i,t+"["+r+"]=",this.enumerateField(e,r,e[r]));return i},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var i="a"+ ++this.localVariableId,r=[new id(i,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e);for(var n=0;n<e.length;++n)0!==e[n]&&nd(r,i+"["+n+"]=",e[n]);return r},t.enumerateField=function(e,t,i){if("object"==typeof i&&i){var r=i._iN$t;if(r){var n=r.globalVar;if(!n){n=r.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(n);var a=r.source[0];r.source[0]=rd(n+"=",a)}return n}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?td(i):("_objFlags"===t&&se(e)&&(i&=Xc),i)},t.setObjProp=function(e,t,i,r){nd(e,$c+sd(i)+"=",this.enumerateField(t,i,r))},t.enumerateObject=function(e,t){var i=t.constructor;if(oe(i))this.enumerateCCClass(e,t,i);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r)){var n=t[r];"object"==typeof n&&n&&n===t._iN$t||this.setObjProp(e,t,r,n)}},t.instantiateObj=function(e){if(e instanceof a.ValueType)return H.getNewValueTypeCode(e);if(e instanceof a.Asset)return this.getObjRef(e);if(e._objFlags&Kc)return null;var t,i=e.constructor;if(oe(i)){if(this.parent)if(this.parent instanceof a.Component){if(e instanceof a.Node||e instanceof a.Component)return this.getObjRef(e)}else if(this.parent instanceof a.Node)if(e instanceof a.Node){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof a.Component){var r;if(null===(r=e.node)||void 0===r||!r.isChildOf(this.parent))return this.getObjRef(e)}t=new id($c,"new "+this.getFuncModule(i,!0)+"()")}else if(i===Object)t=new id($c,"{}");else{if(i)return this.getObjRef(e);t=new id($c,"Object.create(null)")}var n=[t];return e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e),this.enumerateObject(n,e),["(function(){",n,"return o;})();"]},e}();function pd(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof a.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return he(e)&&he(t)}return!1}var fd,gd=ue({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),md=e("a0",b("cc.Prefab")(((dd=function(e){function t(){var t;return(t=e.call(this)||this).data=ud&&ud(),t.optimizationPolicy=ld&&ld(),t.persistent=cd&&cd(),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}S(t,e);var i=t.prototype;return i.createNode=function(e){var t=a.instantiate(this);t.name=this.name,e(null,t)},i.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof a.Node&&e,new _d(e,t).result)},i._doInstantiate=function(e){return this.data._prefab||_(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},i._instantiate=function(){var e;return e=this.data._instantiate(),++this._instantiatedTimes,e},i.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new Ge,this.data.name="(Missing Node)";var i=new a._PrefabInfo;i.asset=this,i.root=this.data,this.data._prefab=i},i.validate=function(){return!!this.data},i.onLoaded=function(){var e=this.data;Qe(e),je(e)},t}(Gi)).OptimizationPolicy=gd,dd.OptimizationPolicyThreshold=3,ud=N((hd=dd).prototype,"data",[I],(function(){return null})),ld=N(hd.prototype,"optimizationPolicy",[I],(function(){return gd.AUTO})),cd=N(hd.prototype,"persistent",[I],(function(){return!1})),od=hd))||od);le(md,"_utils",Ye),a.Prefab=md,ce(a,"cc._Prefab","Prefab");var vd,Ed,Sd,Td=((fd={})[de.PORTRAIT]=$t.IDENTITY,fd[de.LANDSCAPE_RIGHT]=$t.ROTATE_90,fd[de.PORTRAIT_UPSIDE_DOWN]=$t.ROTATE_180,fd[de.LANDSCAPE_LEFT]=$t.ROTATE_270,fd),wd=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null,this._device=null}e.registerCreateFunc=function(t){t._createWindowFun=function(){return new e}};var i=e.prototype;return i.initialize=function(e,t){if(void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._device=e,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._swapchain=t.swapchain,this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var i=0;i<t.renderPassInfo.colorAttachments.length;i++){var r=new ti(ii.TEX2D,ri.COLOR_ATTACHMENT|ri.SAMPLED|ri.TRANSFER_SRC,t.renderPassInfo.colorAttachments[i].format,this._width,this._height);t.externalFlag&&(t.externalFlag&Vi.EXTERNAL_NORMAL||t.externalFlag&Vi.EXTERNAL_OES)&&(r.flags|=t.externalFlag,r.externalRes=t.externalResLow?t.externalResLow:0),this._colorTextures.push(e.createTexture(r))}t.renderPassInfo.depthStencilAttachment.format!==ni.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new ti(ii.TEX2D,ri.DEPTH_STENCIL_ATTACHMENT|ri.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)),this._hasOffScreenAttachments=!0)}return this._framebuffer=e.createFramebuffer(new Bi(this._renderPass,this._colorTextures,this._depthStencilTexture)),!0},i.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._device=null},i.resize=function(e,i){if(this._swapchain)this._swapchain.resize(e,i,Td[Q.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var r=0;r<this._colorTextures.length;r++)this._colorTextures[r].resize(e,i);this._depthStencilTexture&&this._depthStencilTexture.resize(e,i),this._width=e,this._height=i}this.framebuffer&&(this.framebuffer.destroy(),this._framebuffer=this._device.createFramebuffer(new Bi(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var n,a=t(this._cameras);!(n=a()).done;)n.value.resize(e,i)},i.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var i=this._cameras[t];i.enabled&&(i.update(),e.push(i))}},i.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},i.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},i.clearCameras=function(){this._cameras.length=0},i.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},l(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}}]),e}();e("at",vd),function(e){e[e.NONE=-1]="NONE",e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT"}(vd||e("at",vd={})),function(e){e[e.SESSION_RUNNING=2]="SESSION_RUNNING",e[e.VIEW_COUNT=6]="VIEW_COUNT",e[e.SWAPCHAIN_WIDTH=7]="SWAPCHAIN_WIDTH",e[e.SWAPCHAIN_HEIGHT=8]="SWAPCHAIN_HEIGHT",e[e.DEVICE_IPD=37]="DEVICE_IPD",e[e.SPLIT_AR_GLASSES=42]="SPLIT_AR_GLASSES"}(Ed||(Ed={})),function(e){e[e.VIEW_LEFT=0]="VIEW_LEFT",e[e.HAND_LEFT=1]="HAND_LEFT",e[e.AIM_LEFT=2]="AIM_LEFT",e[e.VIEW_RIGHT=3]="VIEW_RIGHT",e[e.HAND_RIGHT=4]="HAND_RIGHT",e[e.AIM_RIGHT=5]="AIM_RIGHT",e[e.HEAD_MIDDLE=6]="HEAD_MIDDLE"}(Sd||(Sd={}));var yd=e("v",function(){function e(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._usesCustomPipeline=!0,this._pipeline=null,this._pipelineEvent=null,this._classicPipeline=null,this._customPipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._debugView=new Mn,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._cameraList=[],this._device=e,this._dataPoolMgr=a.internal.DataPoolManager&&new a.internal.DataPoolManager(e),un.registerCreateFunc(this),wd.registerCreateFunc(this),this._cameraPool=new w((function(){return new Tr(t._device)}),4,(function(e){return e.destroy()}))}var i=e.prototype;return i.initialize=function(){var e,t=gt.swapchain,i=new Di;i.format=t.colorTexture.format;var r=new Pi;r.format=t.depthStencilTexture.format,r.depthStoreOp=Ri.DISCARD,r.stencilStoreOp=Ri.DISCARD;var n=new Fi([i],r);this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:n,swapchain:t}),this._curWindow=this._mainWindow;var a=_e.querySettings(pe.Category.ANIMATION,"customJointTextureLayouts")||[];null===(e=this._dataPoolMgr)||void 0===e||e.jointTexturePool.registerCustomTextureLayouts(a),this._resizeMaxJointForDS()},i.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null,this._pipelineEvent=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),a.rendering&&a.rendering.destroy()},i.resize=function(e,i){for(var r,n=t(this._windows);!(r=n()).done;){var a=r.value;a.swapchain&&a.resize(e,i)}},i.setRenderPipeline=function(e){var t=a.internal,i=a.director,r=a.rendering;e instanceof Pl&&(this._useDeferredPipeline=!0);var n=!1;if(e||(e=Cl(),n=!0),this._useDeferredPipeline&&this.device.hasFeature(hi.COMPUTE_SHADER)||(e.clusterEnabled=!1),e.bloomEnabled=!1,""!==O.CUSTOM_PIPELINE_NAME&&r&&this.usesCustomPipeline?(this._customPipeline=r.createCustomPipeline(),n=!0,this._pipeline=this._customPipeline,this._pipelineEvent=e):(this._classicPipeline=e,this._pipeline=this._classicPipeline,this._pipelineEvent=this._classicPipeline,this._usesCustomPipeline=!1),(_e.querySettings(pe.Category.RENDERING,"renderMode")!==qt.HEADLESS||this._classicPipeline)&&!this._pipeline.activate(this._mainWindow.swapchain))return n&&this._pipeline.destroy(),this._classicPipeline=null,this._customPipeline=null,this._pipeline=null,this._pipelineEvent=null,!1;var s=i.getScene();return s&&s.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&t.Batcher2D&&(this._batcher=new t.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},i.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.onGlobalPipelineStateChanged()},i.activeWindow=function(e){this._curWindow=e},i.resetCumulativeTime=function(){this._cumulativeTime=0},i.frameMove=function(e){var t;this._frameTime=e,++this._frameCount,this._cumulativeTime+=e,this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0),null!==(t=globalThis.__globalXR)&&void 0!==t&&t.isWebXR?this._doWebXRFrameMove():(this._frameMoveBegin(),this._frameMoveProcess(),this._frameMoveEnd())},i.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},i.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},i.destroyWindows=function(){for(var e,i=t(this._windows);!(e=i()).done;)e.value.destroy();this._windows.length=0},i.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},i.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},i.destroyScenes=function(){for(var e,i=t(this._scenes);!(e=i()).done;)e.value.destroy();this._scenes.length=0},i.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new w((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var i=t.alloc();return i.initialize(),i},i.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):_(1300,e.constructor.name),e.destroy()},i.createCamera=function(){return this._cameraPool.alloc()},i.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new w((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var i=t.alloc();return i.initialize(),i},i.destroyLight=function(e){if(e.scene)switch(e.type){case Lr.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case Lr.SPHERE:e.scene.removeSphereLight(e);break;case Lr.SPOT:e.scene.removeSpotLight(e);break;case Lr.POINT:e.scene.removePointLight(e);break;case Lr.RANGED_DIRECTIONAL:e.scene.removeRangedDirLight(e)}e.destroy()},i.recycleLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case Lr.DIRECTIONAL:e.scene.removeDirectionalLight(e);break;case Lr.SPHERE:e.scene.removeSphereLight(e);break;case Lr.SPOT:e.scene.removeSpotLight(e);break;case Lr.POINT:e.scene.removePointLight(e);break;case Lr.RANGED_DIRECTIONAL:e.scene.removeRangedDirLight(e)}},i._doWebXRFrameMove=function(){var e=globalThis.__globalXR;if(e){var i=this._windows,r=this._cameraList,n=e.webXRMatProjs?e.webXRMatProjs.length:1;e.webXRWindowMap||(e.webXRWindowMap=new Map);for(var a=[],s=e.webxrHmdPoseInfos,o=0;o<n;o++){for(var h,u=t(i);!(h=u()).done;){var l=h.value;a=a.concat(l.cameras),l.swapchain&&e.webXRWindowMap.set(l,o)}if(s){for(var c=[0,0,0],d=0;d<s.length;d++){var _=s[d];if(_.code===Sd.VIEW_LEFT&&o===vd.LEFT||_.code===Sd.VIEW_RIGHT&&o===vd.RIGHT){c[0]=_.position.x,c[1]=_.position.y,c[2]=_.position.z;break}}for(var p,f=t(a);!(p=f()).done;){var g=p.value;g.trackingType!==ur.NO_TRACKING&&g.node&&(g.trackingType===ur.ROTATION&&(c=[0,0,0]),g.node.setPosition(c[0],c[1],c[2]))}}a.length=0,this._frameMoveBegin(),this._frameMoveProcess();for(var m=r.length-1;m>=0;m--){var v=r[m];(o===vd.LEFT&&v.cameraType===hr.RIGHT_EYE||o===vd.RIGHT&&v.cameraType===hr.LEFT_EYE)&&r.splice(m,1)}this._frameMoveEnd()}}},i._frameMoveBegin=function(){for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();this._cameraList.length=0},i._frameMoveProcess=function(){for(var e=a.director,t=this._windows,i=this._cameraList,r=0;r<t.length;r++)t[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([gt.swapchain]);var n=this._scenes,s=e.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var o=0;o<n.length;o++)n[o].update(s)}},i._frameMoveEnd=function(){var e=a.director,t=a.Director,i=this._cameraList;if(this._pipeline&&i.length>0){e.emit(t.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority}));for(var r=0;r<i.length;++r){var n;null===(n=i[r].geometryRenderer)||void 0===n||n.update()}e.emit(t.EVENT_BEFORE_RENDER),this._pipeline.render(i),e.emit(t.EVENT_AFTER_RENDER),this._device.present()}this._batcher&&this._batcher.reset()},i._resizeMaxJointForDS=function(){var e=Math.max((xt.COUNT+Ut.COUNT+Ct.COUNT+Rt.COUNT+Pt.COUNT)/4,100),t=Math.floor((gt.gfxDevice.capabilities.maxVertexUniformVectors-e)/3);Zt(t=t<256?t:256)},l(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"usesCustomPipeline",get:function(){return this._usesCustomPipeline}},{key:"pipeline",get:function(){return this._pipeline}},{key:"customPipeline",get:function(){return this._customPipeline}},{key:"pipelineEvent",get:function(){return this._pipelineEvent}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"debugView",get:function(){return this._debugView}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}},{key:"cameraList",get:function(){return this._cameraList}}]),e}());a.Root=yd;var Ad=function(){function e(){this._allRenderers=[],this._dirtyRenderers=[],this._dirtyVersion=0}var t=e.prototype;return t.addRenderer=function(e){-1===e._internalId&&(e._internalId=this._allRenderers.length,this._allRenderers.push(e))},t.removeRenderer=function(e){if(-1!==e._internalId){var t=e._internalId;this._allRenderers[this._allRenderers.length-1]._internalId=t,$(this._allRenderers,t),e._internalId=-1,e._dirtyVersion===this._dirtyVersion&&(fe(this._dirtyRenderers,e),e._dirtyVersion=-1)}},t.markDirtyRenderer=function(e){e._dirtyVersion!==this._dirtyVersion&&-1!==e._internalId&&(this._dirtyRenderers.push(e),e._dirtyVersion=this._dirtyVersion)},t.updateAllDirtyRenderers=function(){for(var e=this._dirtyRenderers.length,t=this._dirtyRenderers,i=0;i<e;i++)t[i].updateRenderer();this._dirtyRenderers.length=0,this._dirtyVersion++},e}(),Rd=e("ay",new Ad),Od=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],bd=[".mp3",".ogg",".wav",".m4a"];function Nd(){return!0}var Id={transformURL:function(e){var t=Zi(e);if(!t)return e;var i=Ji.find((function(e){return!!e.getAssetInfo(t)}));if(!i)return e;var r,n=i.getAssetInfo(t);if(!(r=e.startsWith(i.base+i.config.nativeBase)?n.nativeVer||"":n.ver||"")||-1!==e.indexOf(r))return e;var a=!1;if(".ttf"===Qi(e)&&(a=!0),a){var s=$i(e),o=er(e);e=s+"."+r+"/"+o}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+r}));return e}},Dd=e("a4",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=tt}var t=e.prototype;return t.load=function(e,t,i){void 0===i&&void 0!==t&&(i=t,t=null);for(var r=Array.isArray(e)?e:[e],n=0;n<r.length;n++){var a=r[n];"string"==typeof a?r[n]={url:a,__isNative__:!0}:(a.type&&(a.ext="."+a.type,a.type=void 0),a.url&&(a.__isNative__=!0))}var s=[],o=[];Ke.loadAny(r,null,(function(e,i,r){r.content&&(Od.includes(r.ext)?s.push(r.content):bd.includes(r.ext)&&o.push(r.content)),t&&t(e,i,r)}),(function(e,t){var n=null;if(!e){t=Array.isArray(t)?t:[t];for(var a=function(e){var i=t[e];if(!(i instanceof Gi)){var n=i,a=r[e].url;s.includes(n)?it.create(a,i,".png",{},(function(i,r){n=t[e]=r})):o.includes(n)&&it.create(a,i,".mp3",{},(function(i,r){n=t[e]=r})),ji.add(a,n)}},h=0;h<t.length;h++)a(h);if(t.length>1){var u=Object.create(null);t.forEach((function(e){u[e._uuid]=e})),n={isCompleted:Nd,_map:u}}else n=t[0]}i&&i(e,n)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return Ke.assets.has(e)?{content:Ke.assets.get(e)}:null},t.loadRes=function(e,t,i,r){var n=this._parseLoadResArgs(t,i,r),a=n.type,s=n.onProgress,o=n.onComplete,h=Qi(e);h&&!Xe.getInfoWithPath(e,a)&&(e=e.slice(0,-h.length)),Xe.load(e,a,s,o)},t.loadResArray=function(e,t,i,r){var n=this._parseLoadResArgs(t,i,r),a=n.type,s=n.onProgress,o=n.onComplete;e.forEach((function(t,i){var r=Qi(t);r&&!Xe.getInfoWithPath(t,a)&&(e[i]=t.slice(0,-r.length))})),Xe.load(e,a,s,o)},t.loadResDir=function(e,t,i,r){var n=this._parseLoadResArgs(t,i,r),a=n.type,s=n.onProgress,o=n.onComplete;Xe.loadDir(e,a,s,(function(t,i){var r=[];t||(r=Xe.getDirWithPath(e,a).map((function(e){return e.path}))),o&&o(t,i,r)}))},t.getRes=function(e,t){return ji.has(e)?ji.get(e):Xe.get(e,t)},t.getResCount=function(){return ji.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return qe.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),i=function(){var i=e[r];t["."+r]=function(e,t,r){i({url:e},r)}};for(var r in e)i();Ze.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),i=function(){var i=e[r];t["."+r]=function(e,t,r){i({content:e},r)}};for(var r in e)i();Je.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];"string"==typeof i&&(i=ji.get(i)),Ke.releaseAsset(i)}else e&&("string"==typeof e&&(e=ji.get(e)),Ke.releaseAsset(e))},t.releaseAsset=function(e){Ke.releaseAsset(e)},t.releaseRes=function(e,t){Xe.release(e,t)},t.releaseAll=function(){Ke.releaseAll(),ji.clear()},t.removeItem=function(e){return!!ji.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var i=qe.getDepsRecursively(e),r=0;r<i.length;r++)this._autoReleaseSetting[i[r]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},l(e,[{key:"onProgress",set:function(e){rt(e)}},{key:"_cache",get:function(){if(ji instanceof qi)return ji.map;var e={};return ji.forEach((function(t,i){e[i]=t})),e}},{key:"md5Pipe",get:function(){return Id}},{key:"downloader",get:function(){return Ze}},{key:"loader",get:function(){return Ke.parser}}]),e}()),Pd=e("a5",new Dd),Cd=e("a6",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,Ke.init(e),e.rawAssets&&Xe.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:Xi.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){Ke.loadAny(e,t)}}),Ld=e("a7",{});K(Ld,"url",[{name:"normalize",target:Ke.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?Yi({path:Ki(e.substr(10)),bundle:Xi.RESOURCES,__isNative__:!0,ext:Qi(e)}):""}}]),q(Cd,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),q(Pd,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline"}]),K(a,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return Pd}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return Cd}},{name:"Pipeline",target:$e,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return Ld}}]),q(a,"cc",[{name:"LoadingItems",suggest:ge(1400,"LoadingItems","AssetManager.Task")}]),K(O,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:Ze,targetName:"assetManager.downloader",newName:"maxConcurrency"}]);var Fd=et._autoRelease;et._autoRelease=function(e,t,i){Fd.call(et,e,t,i);for(var r=Pd._autoReleaseSetting,n=Object.keys(r),a=0;a<n.length;a++){var s=n[a];if(!0===r[s]){var o=ji.get(s);o&&et.tryRelease(o)}}};var Md=e("a2",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._persistRootNodes={},t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new Ee,t._compScheduler=new xc,t._nodeActivator=new Yc,t._systems=[],t}S(t,e);var i=t.prototype;return i.calculateDeltaTime=function(){},i.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},i.pause=function(){this._paused||(this._paused=!0)},i.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),te(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),Ke.releaseAll()},i.reset=function(){var e;for(var i in this.purgeDirector(),this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[i]);null===(e=this.getScene())||void 0===e||e.destroy(),this.emit(t.EVENT_RESET),this.startAnimation()},i.runSceneImmediate=function(e,i,r){var n=this;e instanceof nt&&(e=e.scene),me(e instanceof at,1216),e._load();for(var a=Object.keys(this._persistRootNodes).map((function(e){return n._persistRootNodes[e]})),s=0;s<a.length;s++){var o=a[s];o.emit(Ge.EventType.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var h=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(h){var u=h.getSiblingIndex();o.hideFlags&=~Z.Flags.DontSave,o.hideFlags|=Z.Flags.DontSave&h.hideFlags,h._destroyImmediate(),e.insertChild(o,u)}else o.hideFlags|=Z.Flags.DontSave,o.parent=e}var l=this._scene;te(l)&&l.destroy(),et._autoRelease(l,e,this._persistRootNodes),this._scene=null,Z._deferredDestroy(),i&&i(),this.emit(t.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),r&&r(null,e),this.emit(t.EVENT_AFTER_SCENE_LAUNCH,e)},i.runScene=function(e,i,r){var n=this;e instanceof nt&&(e=e.scene),me(e,1205),me(e instanceof at,1216),this.once(t.EVENT_END_FRAME,(function(){n.runSceneImmediate(e,i,r)}))},i.loadScene=function(e,i,r){var n=this;if(this._loadingScene)return _(1208,e,this._loadingScene),!1;var a=Ke.bundles.find((function(t){return!!t.getSceneInfo(e)}));return a?(this.emit(t.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),a.loadScene(e,(function(t,a){console.timeEnd("LoadScene "+e),n._loadingScene="",t?(ve(t),i&&i(t)):n.runSceneImmediate(a,r,i)})),!0):(p(1209,e),!1)},i.preloadScene=function(e,t,i){var r=Ke.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(r)r.preloadScene(e,null,t,i);else{var n='Can not preload the scene "'+e+'" because it is not in the build settings.';i&&i(new Error(n)),ve("preloadScene: "+n)}},i.resume=function(){this._paused&&(this._paused=!1)},i.getScene=function(){return this._scene},i.getDeltaTime=function(){return a.game.deltaTime},i.getTotalTime=function(){return a.game.totalTime},i.getCurrentTime=function(){return a.game.frameStartTime},i.getTotalFrames=function(){return this._totalFrames},i.isPaused=function(){return this._paused},i.getScheduler=function(){return this._scheduler},i.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(Ee.ID,e,200))},i.registerSystem=function(e,t,i){t.id=e,t.priority=i,this._systems.push(t),this._systems.sort(Se.sortByPriority)},i.unregisterSystem=function(e){fe(this._systems,e),this._systems.sort(Se.sortByPriority)},i.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},i.getAnimationManager=function(){return this.getSystem(a.AnimationManager.ID)},i.startAnimation=function(){this._invalid=!1},i.stopAnimation=function(){this._invalid=!0},i.mainLoop=function(e){var t;t=a.game._calculateDT(e),this.tick(t)},i.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),gc._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var i=0;i<this._systems.length;++i)this._systems[i].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),Z._deferredDestroy();for(var r=0;r<this._systems.length;++r)this._systems[r].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),Rd.updateAllDirtyRenderers(),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),Ge.resetHasChangedFlags(),Ge.clearNodeArray(),Te.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},i.buildRenderPipeline=function(){this._root&&(this._root.customPipeline.beginSetup(),a.rendering.getCustomPipeline(O.CUSTOM_PIPELINE_NAME).setup(this._root.cameraList,this._root.customPipeline),this._root.customPipeline.endSetup())},i.setupRenderPipelineBuilder=function(){""!==O.CUSTOM_PIPELINE_NAME&&a.rendering&&this._root&&this._root.usesCustomPipeline&&this.on(t.EVENT_BEFORE_RENDER,this.buildRenderPipeline,this)},i.init=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(Ee.ID,this._scheduler,200),this._root=new yd(gt.gfxDevice),this._root.initialize({}),this.setupRenderPipelineBuilder();for(var e=0;e<this._systems.length;e++)this._systems[e].init();this.emit(t.EVENT_INIT)},i.addPersistRootNode=function(e){if(Ge.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=this._scene;if(te(i))if(e.parent){if(!(e.parent instanceof at))return void _(3801);if(e.parent!==i)return void _(3802);e._originalSceneId=i.uuid}else e.parent=i,e._originalSceneId=i.uuid;this._persistRootNodes[t]=e,e._persistNode=!0,et._addPersistNodeRef(e)}}else _(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",et._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},l(t,[{key:"root",get:function(){return this._root}}]),t}(P));Md.EVENT_INIT="director_init",Md.EVENT_RESET="director_reset",Md.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",Md.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",Md.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",Md.EVENT_BEFORE_UPDATE="director_before_update",Md.EVENT_AFTER_UPDATE="director_after_update",Md.EVENT_BEFORE_DRAW="director_before_draw",Md.EVENT_AFTER_DRAW="director_after_draw",Md.EVENT_BEFORE_COMMIT="director_before_commit",Md.EVENT_BEFORE_RENDER="director_before_render",Md.EVENT_AFTER_RENDER="director_after_render",Md.EVENT_BEFORE_PHYSICS="director_before_physics",Md.EVENT_AFTER_PHYSICS="director_after_physics",Md.EVENT_BEGIN_FRAME="director_begin_frame",Md.EVENT_END_FRAME="director_end_frame",Md.instance=void 0,a.Director=Md,e("a3",Md.instance=a.director=new Md)}}}));
