System.register(["./index-68ccac70.js","./pipeline-state-manager-8f16c5a7.js","./buffer-barrier-d1733967.js","./sprite-e4e3e9a1.js","./deprecated-f062dda6.js","./sprite-renderer-e5daf04e.js","./find-222dc7da.js","./director-56fe9b8d.js","./touch-685512cb.js","./deprecated-0752a51c.js","./node-event-40319828.js"],(function(t){"use strict";var e,r,a,i,n,s,o,h,l,c,u,f,d,v,_,p,x,g,m,S,y,D,w,C,T,b,M,E,B,F,R,z,L,A,I,P,O,H,k,V,N,U,W,X,Z,Y,q,Q,G,j,J,K,$,tt,et,rt,at,it,nt,st,ot,ht,lt,ct,ut,ft,dt,vt,_t,pt,xt,gt,mt,St,yt,Dt,wt,Ct,Tt,bt,Mt,Et,Bt,Ft,Rt,zt,Lt,At,It;return{setters:[function(t){e=t.t,r=t.J,a=t.B,i=t.o,n=t.y,s=t.c,o=t.i,h=t.V,l=t.l,c=t.a,u=t.w,f=t.cg,d=t.bS,v=t.f,_=t.cw,p=t.bQ,x=t.bu,g=t.I,m=t.bx,S=t.C,y=t.P,D=t.F,w=t.bA,C=t.ai,T=t.ag,b=t.ah,M=t.d,E=t.b_},function(t){B=t.d,F=t.h,R=t.a0},function(t){z=t.aQ,L=t.a9,A=t.d,I=t.f,P=t.v,O=t.aE},function(t){H=t.m,k=t.n,V=t.O,N=t.c,U=t.s,W=t.l,X=t.H,Z=t.V,Y=t.e,q=t.i,Q=t.g,G=t.o,j=t.p,J=t.C,K=t.q,$=t.b,tt=t.B,et=t.a,rt=t.T},function(t){at=t.d,it=t.e,nt=t.P,st=t.f,ot=t.G,ht=t.L,lt=t.b,ct=t.D},function(t){ut=t.a,ft=t.h,dt=t.g,vt=t.S,_t=t.i,pt=t.j,xt=t.k,gt=t.l,mt=t.m,St=t.M,yt=t.f,Dt=t.e},function(t){wt=t.ay,Ct=t.ac,Tt=t._,bt=t.a6,Mt=t.am,Et=t.aq},function(t){Bt=t.aa,Ft=t.av,Rt=t.a9,zt=t.aw,Lt=t.ax,At=t.h},function(t){It=t.I},function(){},function(){}],execute:function(){var Pt=new e;function Ot(t,e,r,i){var n=r.chunk,s=r.data,o=n.vb,h=r.vertexCount;t.getWorldMatrix(Pt);for(var l=0,c=0;c<h;c++){var u=s[c],f=u.x,d=u.y,v=Pt.m03*f+Pt.m07*d+Pt.m15;v=v?1/v:1,o[l+0]=(Pt.m00*f+Pt.m04*d+Pt.m12)*v,o[l+1]=(Pt.m01*f+Pt.m05*d+Pt.m13)*v,o[l+2]=(Pt.m02*f+Pt.m06*d+Pt.m14)*v,a.toArray(o,i,l+5),l+=9}n.bufferId;for(var _=n.vertexOffset,p=n.meshBuffer,x=n.meshBuffer.iData,g=p.indexOffset,m=0,S=h/4;m<S;m++){var y=_+4*m;x[g++]=y,x[g++]=y+1,x[g++]=y+2,x[g++]=y+1,x[g++]=y+3,x[g++]=y+2}p.indexOffset+=r.indexCount,p.setDirty()}var Ht=function(t,e,r){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=r};function kt(t,e,r,a,i){var n=0,s=null;if(i===function(t,e,r,a){for(var i=0,n=e,s=r-a;n<r;n+=a)i+=(t[s]-t[n])*(t[n+1]+t[s+1]),s=n;return i}(t,e,r,a)>0)for(n=e;n<r;n+=a)s=ae(n,t[n],t[n+1],s);else for(n=r-a;n>=e;n-=a)s=ae(n,t[n],t[n+1],s);return s&&$t(s,s.next)&&(ie(s),s=s.next),s}function Vt(t,e){if(void 0===e&&(e=null),!t)return t;e||(e=t);var r=t,a=!1;do{if(a=!1,r.steiner||!$t(r,r.next)&&0!==Kt(r.prev,r,r.next))r=r.next;else{if(ie(r),(r=e=r.prev)===r.next)return null;a=!0}}while(a||r!==e);return e}function Nt(t,e,r,a,i,n,s){if(void 0===s&&(s=0),t){!s&&n&&function(t,e,r,a){var i=t;do{null===i.z&&(i.z=Qt(i.x,i.y,e,r,a)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e=0,r=null,a=null,i=null,n=null,s=0,o=0,h=0,l=1;do{for(r=t,t=null,n=null,s=0;r;){for(s++,a=r,o=0,e=0;e<l&&(o++,a=a.nextZ);e++);for(h=l;o>0||h>0&&a;)0===o?(i=a,a=a.nextZ,h--):0!==h&&a?r.z<=a.z?(i=r,r=r.nextZ,o--):(i=a,a=a.nextZ,h--):(i=r,r=r.nextZ,o--),n?n.nextZ=i:t=i,i.prevZ=n,n=i;r=a}n.nextZ=null,l*=2}while(s>1)}(i)}(t,a,i,n);for(var o=t,h=null,l=null;t.prev!==t.next;)if(h=t.prev,l=t.next,n?Wt(t,a,i,n):Ut(t))e.push(h.i/r),e.push(t.i/r),e.push(l.i/r),ie(t),t=l.next,o=l.next;else if((t=l)===o){s?1===s?Nt(t=Xt(t,e,r),e,r,a,i,n,2):2===s&&Zt(t,e,r,a,i,n):Nt(Vt(t),e,r,a,i,n,1);break}}}function Ut(t){var e=t.prev,r=t,a=t.next;if(Kt(e,r,a)>=0)return!1;for(var i=t.next.next;i!==t.prev;){if(jt(e.x,e.y,r.x,r.y,a.x,a.y,i.x,i.y)&&Kt(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function Wt(t,e,r,a){var i=t.prev,n=t,s=t.next;if(Kt(i,n,s)>=0)return!1;for(var o=i.x<n.x?i.x<s.x?i.x:s.x:n.x<s.x?n.x:s.x,h=i.y<n.y?i.y<s.y?i.y:s.y:n.y<s.y?n.y:s.y,l=i.x>n.x?i.x>s.x?i.x:s.x:n.x>s.x?n.x:s.x,c=i.y>n.y?i.y>s.y?i.y:s.y:n.y>s.y?n.y:s.y,u=Qt(o,h,e,r,a),f=Qt(l,c,e,r,a),d=t.nextZ;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&jt(i.x,i.y,n.x,n.y,s.x,s.y,d.x,d.y)&&Kt(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=t.prevZ;d&&d.z>=u;){if(d!==t.prev&&d!==t.next&&jt(i.x,i.y,n.x,n.y,s.x,s.y,d.x,d.y)&&Kt(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function Xt(t,e,r){var a=t;do{var i=a.prev,n=a.next.next;!$t(i,n)&&te(i,a,a.next,n)&&ee(i,n)&&ee(n,i)&&(e.push(i.i/r),e.push(a.i/r),e.push(n.i/r),ie(a),ie(a.next),a=t=n),a=a.next}while(a!==t);return a}function Zt(t,e,r,a,i,n){var s=t;do{for(var o=s.next.next;o!==s.prev;){if(s.i!==o.i&&Jt(s,o)){var h=re(s,o);return s=Vt(s,s.next),h=Vt(h,h.next),Nt(s,e,r,a,i,n),void Nt(h,e,r,a,i,n)}o=o.next}s=s.next}while(s!==t)}function Yt(t,e){return t.x-e.x}function qt(t,e){if(e=function(t,e){var r=e,a=t.x,i=t.y,n=-1/0,s=null;do{if(i<=r.y&&i>=r.next.y){var o=r.x+(i-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(o<=a&&o>n){if(n=o,o===a){if(i===r.y)return r;if(i===r.next.y)return r.next}s=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!s)return null;if(a===n)return s.prev;var h,l=s,c=s.x,u=s.y,f=1/0;for(r=s.next;r!==l;)a>=r.x&&r.x>=c&&jt(i<u?a:n,i,c,u,i<u?n:a,i,r.x,r.y)&&((h=Math.abs(i-r.y)/(a-r.x))<f||h===f&&r.x>s.x)&&ee(r,t)&&(s=r,f=h),r=r.next;return s}(t,e)){var r=re(e,t);Vt(r,r.next)}}function Qt(t,e,r,a,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)/i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-a)/i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Gt(t){var e=t,r=t;do{e.x<r.x&&(r=e),e=e.next}while(e!==t);return r}function jt(t,e,r,a,i,n,s,o){return(i-s)*(e-o)-(t-s)*(n-o)>=0&&(t-s)*(a-o)-(r-s)*(e-o)>=0&&(r-s)*(n-o)-(i-s)*(a-o)>=0}function Jt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&te(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&ee(t,e)&&ee(e,t)&&function(t,e){var r=t,a=!1,i=(t.x+e.x)/2,n=(t.y+e.y)/2;do{r.y>n!=r.next.y>n&&i<(r.next.x-r.x)*(n-r.y)/(r.next.y-r.y)+r.x&&(a=!a),r=r.next}while(r!==t);return a}(t,e)}function Kt(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function $t(t,e){return t.x===e.x&&t.y===e.y}function te(t,e,r,a){return!!($t(t,e)&&$t(r,a)||$t(t,a)&&$t(r,e))||Kt(t,e,r)>0!=Kt(t,e,a)>0&&Kt(r,a,t)>0!=Kt(r,a,e)>0}function ee(t,e){return Kt(t.prev,t,t.next)<0?Kt(t,e,t.next)>=0&&Kt(t,t.prev,e)>=0:Kt(t,e,t.prev)<0||Kt(t,t.next,e)<0}function re(t,e){var r=new Ht(t.i,t.x,t.y),a=new Ht(e.i,e.x,e.y),i=t.next,n=e.prev;return t.next=e,e.prev=t,r.next=i,i.prev=r,a.next=r,r.prev=a,n.next=a,a.prev=n,a}function ae(t,e,r,a){var i=new Ht(t,e,r);return a?(i.next=a.next,i.prev=a,a.next.prev=i,a.next=i):(i.prev=i,i.next=i),i}function ie(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ne(t,e,r){r=r||3;var a=e?e.length:0,i=a?e[0]*r:t.length,n=kt(t,0,i,r,!0),s=[];if(!n)return s;var o=0,h=0,l=0,c=0,u=0,f=0,d=0;if(a&&(n=function(t,e,r,a){var i,n=[],s=0,o=null;for(s=0,i=e.length;s<i;s++)(o=kt(t,e[s]*a,s<i-1?e[s+1]*a:t.length,a,!1))&&(o===o.next&&(o.steiner=!0),n.push(Gt(o)));if(n.sort(Yt),!r)return r;for(s=0;s<n.length;s++)qt(n[s],r),r=Vt(r,r.next);return r}(t,e,n,r)),t.length>80*r){o=l=t[0],h=c=t[1];for(var v=r;v<i;v+=r)(u=t[v])<o&&(o=u),(f=t[v+1])<h&&(h=f),u>l&&(l=u),f>c&&(c=f);d=Math.max(l-o,c-h)}return Nt(n,s,r,o,h,d),s}for(var se=Math.PI,oe=Math.min,he=Math.max,le=Math.ceil,ce=Math.acos,ue=Math.cos,fe=Math.sin,de=Math.atan2,ve=null,_e=null,pe=new a,xe=[],ge=0;ge<4;ge++)xe.push(new i);function me(t,e,r){return t<e?e:t>r?r:t}var Se={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(t,e){if(!_e)return null;var r=_e.getRenderDataList(),a=r[_e.dataOffset];if(!a)return null;var i=a,n=i?i.vertexStart+e:0;return(n>65535||3*n>131070)&&(++_e.dataOffset,_e.dataOffset<r.length?a=r[_e.dataOffset]:(a=_e.requestRenderData(),r[_e.dataOffset]=a),i=a),i&&i.vertexCount<n&&i.request(e,3*e),a},stroke:function(t){a.copy(pe,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill:function(t){a.copy(pe,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end:function(t){t.markForUpdateRenderData()},_expandStroke:function(t){var e=.5*t.lineWidth,r=t.lineCap,a=t.lineJoin,i=t.miterLimit;if(_e=t.impl){var n,s,o,h,l=(n=e,s=se,o=_e.tessTol,h=2*ce(n/(n+o)),he(2,le(s/h)));this._calculateJoins(_e,e,a,i);for(var c=_e.paths,u=0,f=_e.pathOffset,d=_e.pathLength;f<d;f++){var v=c[f],_=v.points.length;a===at.ROUND?u+=2*(_+v.bevel*(l+2)+1):u+=2*(_+5*v.bevel+1),v.closed||(r===it.ROUND?u+=2*(2*l+2):u+=12)}var p=ve=this.getRenderData(t,u);if(p){for(var x=p.vData,g=p.iData,m=_e.pathOffset,S=_e.pathLength;m<S;m++){var y=c[m],D=y.points,w=D.length,C=p.vertexStart,T=void 0,b=void 0,M=0,E=0,B=y.closed;if(B?(T=D[w-1],b=D[0],M=0,E=w):(T=D[0],b=D[1],M=1,E=w-1),b=b||T,!B){var F=new nt(b.x,b.y);F.subtract(T),F.normalize();var R=F.x,z=F.y;r===it.BUTT?this._buttCapStart(T,R,z,e,0):r===it.SQUARE?this._buttCapStart(T,R,z,e,e):r===it.ROUND&&this._roundCapStart(T,R,z,e,l)}for(var L=M;L<E;++L)a===at.ROUND?this._roundJoin(T,b,e,e,l):0!=(b.flags&(st.PT_BEVEL|st.PT_INNERBEVEL))?this._bevelJoin(T,b,e,e):(this._vSet(b.x+b.dmx*e,b.y+b.dmy*e,1),this._vSet(b.x-b.dmx*e,b.y-b.dmy*e,-1)),T=b,b=D[L+1];if(B){var A=8*C;this._vSet(x[A],x[A+1],1),this._vSet(x[A+8],x[A+8+1],-1)}else{var I=new nt(b.x,b.y);I.subtract(T),I.normalize();var P=I.x,O=I.y;r===it.BUTT?this._buttCapEnd(b,P,O,e,0):r===it.SQUARE?this._buttCapEnd(b,P,O,e,e):r===it.ROUND&&this._roundCapEnd(b,P,O,e,l)}for(var H=p.indexStart,k=C+2,V=p.vertexStart;k<V;k++)g[H++]=k-2,g[H++]=k-1,g[H++]=k;p.indexStart=H}ve=null,_e=null}}},_expandFill:function(t){if(_e=t.impl){for(var e=_e.paths,r=0,a=_e.pathOffset,i=_e.pathLength;a<i;a++)r+=e[a].points.length;var n=ve=this.getRenderData(t,r);if(n){for(var s=n,o=s.vData,h=s.iData,l=_e.pathOffset,c=_e.pathLength;l<c;l++){var u=e[l],f=u.points,d=f.length;if(0!==d){for(var v=n.vertexStart,_=0;_<d;++_)this._vSet(f[_].x,f[_].y);var p=n.indexStart;if(u.complex){for(var x=[],g=v,m=n.vertexStart;g<m;g++){var S=8*g;x.push(o[S++]),x.push(o[S++]),x.push(o[S++])}var y=ne(x,null,3);if(!y||0===y.length)continue;for(var D=0,w=y.length;D<w;D++)h[p++]=y[D]+v}else for(var C=v,T=v+2,b=s.vertexStart;T<b;T++)h[p++]=C,h[p++]=T-1,h[p++]=T;s.indexStart=p}}ve=null,_e=null}}},_calculateJoins:function(t,e,r,a){var i=0;e>0&&(i=1/e);for(var n=t.paths,s=t.pathOffset,o=t.pathLength;s<o;s++){var h=n[s],l=h.points,c=l.length,u=l[c-1],f=l[0];h.bevel=0;for(var d=0;d<c;d++){var v,_,p=u.dy,x=-u.dx,g=f.dy,m=-f.dx;if(f.dmx=.5*(p+g),f.dmy=.5*(x+m),(v=f.dmx*f.dmx+f.dmy*f.dmy)>1e-6){var S=1/v;S>600&&(S=600),f.dmx*=S,f.dmy*=S}f.dx*u.dy-u.dx*f.dy>0&&(f.flags|=st.PT_LEFT),v*(_=he(11,oe(u.len,f.len)*i))*_<1&&(f.flags|=st.PT_INNERBEVEL),f.flags&st.PT_CORNER&&(v*a*a<1||r===at.BEVEL||r===at.ROUND)&&(f.flags|=st.PT_BEVEL),0!=(f.flags&(st.PT_BEVEL|st.PT_INNERBEVEL))&&h.bevel++,u=f,f=l[d+1]}}},_flattenPaths:function(t){for(var e=t.paths,r=t.pathOffset,a=t.pathLength;r<a;r++){var i=e[r],n=i.points,s=n[n.length-1],o=n[0];n.length>2&&s.equals(o)&&(i.closed=!0,n.pop(),s=n[n.length-1]);for(var h=0,l=n.length;h<l;h++){var c=new nt(o.x,o.y);c.subtract(s),s.len=c.length(),(c.x||c.y)&&c.normalize(),s.dx=c.x,s.dy=c.y,s=o,o=n[h+1]}}},_chooseBevel:function(t,e,r,a){var i=r.x,n=r.y,s=0,o=0,h=0,l=0;return 0!==t?(s=i+e.dy*a,o=n-e.dx*a,h=i+r.dy*a,l=n-r.dx*a):(s=h=i+r.dmx*a,o=l=n+r.dmy*a),[s,o,h,l]},_buttCapStart:function(t,e,r,a,i){var n=t.x-e*i,s=t.y-r*i,o=r,h=-e;this._vSet(n+o*a,s+h*a,1),this._vSet(n-o*a,s-h*a,-1)},_buttCapEnd:function(t,e,r,a,i){var n=t.x+e*i,s=t.y+r*i,o=r,h=-e;this._vSet(n+o*a,s+h*a,1),this._vSet(n-o*a,s-h*a,-1)},_roundCapStart:function(t,e,r,a,i){for(var n=t.x,s=t.y,o=r,h=-e,l=0;l<i;l++){var c=l/(i-1)*se,u=ue(c)*a,f=fe(c)*a;this._vSet(n-o*u-e*f,s-h*u-r*f,1),this._vSet(n,s,0)}this._vSet(n+o*a,s+h*a,1),this._vSet(n-o*a,s-h*a,-1)},_roundCapEnd:function(t,e,r,a,i){var n=t.x,s=t.y,o=r,h=-e;this._vSet(n+o*a,s+h*a,1),this._vSet(n-o*a,s-h*a,-1);for(var l=0;l<i;l++){var c=l/(i-1)*se,u=ue(c)*a,f=fe(c)*a;this._vSet(n,s,0),this._vSet(n-o*u+e*f,s-h*u+r*f,1)}},_roundJoin:function(t,e,r,a,i){var n=t.dy,s=-t.dx,o=e.dy,h=-e.dx,l=e.x,c=e.y;if(0!=(e.flags&st.PT_LEFT)){var u=this._chooseBevel(e.flags&st.PT_INNERBEVEL,t,e,r),f=u[0],d=u[1],v=u[2],_=u[3],p=de(-s,-n),x=de(-h,-o);x>p&&(x-=2*se),this._vSet(f,d,1),this._vSet(l-n*a,e.y-s*a,-1);for(var g=me(le((p-x)/se)*i,2,i),m=0;m<g;m++){var S=p+m/(g-1)*(x-p),y=l+ue(S)*a,D=c+fe(S)*a;this._vSet(l,c,0),this._vSet(y,D,-1)}this._vSet(v,_,1),this._vSet(l-o*a,c-h*a,-1)}else{var w=this._chooseBevel(e.flags&st.PT_INNERBEVEL,t,e,-a),C=w[0],T=w[1],b=w[2],M=w[3],E=de(s,n),B=de(h,o);B<E&&(B+=2*se),this._vSet(l+n*a,c+s*a,1),this._vSet(C,T,-1);for(var F=me(le((B-E)/se)*i,2,i),R=0;R<F;R++){var z=E+R/(F-1)*(B-E),L=l+ue(z)*r,A=c+fe(z)*r;this._vSet(L,A,1),this._vSet(l,c,0)}this._vSet(l+o*a,c+h*a,1),this._vSet(b,M,-1)}},_bevelJoin:function(t,e,r,a){var i=0,n=0,s=0,o=0,h=0,l=0,c=0,u=0,f=t.dy,d=-t.dx,v=e.dy,_=-e.dx;if(e.flags&st.PT_LEFT){var p=this._chooseBevel(e.flags&st.PT_INNERBEVEL,t,e,r);h=p[0],l=p[1],c=p[2],u=p[3],this._vSet(h,l,1),this._vSet(e.x-f*a,e.y-d*a,-1),this._vSet(c,u,1),this._vSet(e.x-v*a,e.y-_*a,-1)}else{var x=this._chooseBevel(e.flags&st.PT_INNERBEVEL,t,e,-a);i=x[0],n=x[1],s=x[2],o=x[3],this._vSet(e.x+f*r,e.y+d*r,1),this._vSet(i,n,-1),this._vSet(e.x+v*r,e.y+_*r,1),this._vSet(s,o,-1)}},_vSet:function(t,e,r){if(void 0===r&&(r=0),ve){var i=ve,n=8*i.vertexStart,s=i.vData;s[n++]=t,s[n++]=e,s[n++]=0,a.toArray(s,pe,n),n+=4,s[n++]=r,i.vertexStart++}}},ye=t("g",{getAssembler:function(){return Se}});ot.Assembler=ye;var De=["left","center","right"],we=2048,Ce=Q(),Te=(1/255).toFixed(3),be=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},Me=function(){function t(){this._context=null,this._canvas=null,this._canvasData=null,this._lettersInfo=[],this._tmpRect=new n,this._maxFontSize=100,this._fontScale=1,this._canvasData=H.getInstance().get(),this._canvas=this._canvasData.canvas,this._context=this._canvasData.context}var e=t.prototype;return e.destroy=function(){H.getInstance().put(this._canvasData),this._lettersInfo.length=0},e.processingString=function(t,e,r,a,i,n){if(t)e.fntConfig?this._fontScale=1:this._fontScale=this._getStyleFontScale(e.originFontSize,e.fontScale),k.fontScale=this._fontScale,this._setupBMFontOverflowMetrics(r,a),this._updateFontScale(e),this._computeHorizontalKerningForText(e,r,i),this._alignText(e,r,a,i);else{var s=0;for(this._fontScale=this._getStyleFontScale(e.fontSize,e.fontScale),this._updatePaddingRect(e,a),this._calculateLabelFont(e,r,a,i);(a.canvasSize.width>we||a.canvasSize.height>we)&&s<=3;){if(++s>3)this._fontScale=1;else{var o=Math.max(a.canvasSize.width,a.canvasSize.height),h=we/o;this._fontScale*=h,this._fontScale=Math.max(1,this._fontScale)}this._updatePaddingRect(e,a),this._calculateLabelFont(e,r,a,i)}}n&&(n=a.parsedString)},e.generateRenderInfo=function(t,e,r,a,i,n,s){t?(this._computeAlignmentOffset(e,r,a),this.generateVertexData(t,e,r,a,i,n,s)):(this._updateLabelDimensions(e,r,a),this._updateTexture(e,r,a,i),this.generateVertexData(t,e,r,a,i,n,s))},e.setCanvasUsed=function(t,e){this._canvas=t,this._context=e},e._getStyleFontScale=function(t,e){var r=e;return r*t>this._maxFontSize&&t<this._maxFontSize&&(r=this._maxFontSize/t),r<1&&(r=1),r},e._calculateLabelFont=function(t,e,r,a){if(this._context){t.actualFontSize=t.fontSize*this._fontScale;var i=a.split("\n"),n=r.parsedString=i,s=this._getFontDesc(t.actualFontSize,t.fontFamily,t.isBold,t.isItalic);switch(this._context.font=t.fontDesc=s,e.overFlow){case V.NONE:for(var o=0,h=0;h<i.length;++h){var l=U(this._context,i[h],s);o=o>l?o:l}var c=o,u=(n.length+N)*this._getLineHeight(e.lineHeight,t.actualFontSize,t.fontSize);r.canvasSize.width=c+r.canvasPadding.width*this._fontScale,r.canvasSize.height=u+r.canvasPadding.height*this._fontScale,r.nodeContentSize.width=(c+r.contentSizeExtend.width*this._fontScale)/this._fontScale,r.nodeContentSize.height=(u+r.contentSizeExtend.height*this._fontScale)/this._fontScale;break;case V.SHRINK:this._calculateShrinkFont(i,t,e,r),this._calculateWrapText(i,t,e,r),r.canvasSize.width=r.nodeContentSize.width*this._fontScale,r.canvasSize.height=r.nodeContentSize.height*this._fontScale;break;case V.CLAMP:this._calculateWrapText(i,t,e,r),r.canvasSize.width=r.nodeContentSize.width*this._fontScale,r.canvasSize.height=r.nodeContentSize.height*this._fontScale;break;case V.RESIZE_HEIGHT:this._calculateWrapText(i,t,e,r);var f=(r.parsedString.length+N)*this._getLineHeight(e.lineHeight,t.actualFontSize,t.fontSize);r.canvasSize.width=r.nodeContentSize.width*this._fontScale,r.canvasSize.height=f+r.canvasPadding.height*this._fontScale,r.nodeContentSize.height=(f+r.contentSizeExtend.height*this._fontScale)/this._fontScale}}},e._getFontDesc=function(t,e,r,a){var i=t.toString()+"px ";return i+=e,r&&(i="bold "+i),a&&(i="italic "+i),i},e._getLineHeight=function(t,e,r){return 0===t?e:t*e/r},e._calculateShrinkFont=function(t,e,r,a){if(this._context){var i=this._getFontDesc(e.actualFontSize,e.fontFamily,e.isBold,e.isItalic);this._context.font=i;var n=this._calculateParagraphLength(t,this._context,i),o=0,h=0,l=0,c=e.actualFontSize;if(r.wrapping){var u=a.nodeContentSize.width*this._fontScale,f=a.nodeContentSize.height*this._fontScale;if(u<0||f<0)return;h=f+1;for(var d=0,v=0|e.actualFontSize+1,_=0;d<v;){if((_=d+v+1>>1)<=0){s(4003);break}c=_,i=this._getFontDesc(c,e.fontFamily,e.isBold,e.isItalic),this._context.font=i;var p=this._getLineHeight(r.lineHeight,c,e.fontSize);for(h=0,o=0;o<t.length;++o){var x=U(this._context,t[o],i);h+=W(t[o],x,u,this._measureText(this._context,i)).length*p}h>f?v=_-1:d=_}0===d?s(4003):(c=d,i=this._getFontDesc(c,e.fontFamily,e.isBold,e.isItalic),this._context.font=i)}else{for(h=t.length*this._getLineHeight(r.lineHeight,c,e.fontSize),o=0;o<t.length;++o)l<n[o]&&(l=n[o]);var g=(a.canvasSize.width-a.canvasPadding.width)*this._fontScale/l,m=a.canvasSize.height*this._fontScale/h;c=e.actualFontSize*Math.min(1,g,m)|0,i=this._getFontDesc(c,e.fontFamily,e.isBold,e.isItalic),this._context.font=i}e.actualFontSize=c,e.fontDesc=i}},e._calculateWrapText=function(t,e,r,a){if(r.wrapping&&this._context){var i=[],n=a.nodeContentSize.width*this._fontScale,s=this._getFontDesc(e.actualFontSize,e.fontFamily,e.isBold,e.isItalic);this._context.font=s;for(var o=0;o<t.length;++o){var h=U(this._context,t[o],s),l=W(t[o],h,n,this._measureText(this._context,s));i=i.concat(l)}a.parsedString=i,e.fontDesc=s}},e._measureText=function(t,e){return function(r){return U(t,r,e)}},e._calculateParagraphLength=function(t,e,r){for(var a,i=[],n=o(t);!(a=n()).done;){var s=a.value,h=U(e,s,r);i.push(h)}return i},e._updatePaddingRect=function(t,e){var r=0,a=0,i=0,n=0,s=0;if(e.contentSizeExtend.width=e.contentSizeExtend.height=0,t.isOutlined&&(r=a=i=n=s=t.outlineWidth,e.contentSizeExtend.width=e.contentSizeExtend.height=2*s),t.hasShadow){var o=t.shadowBlur+s,h=t.shadowOffsetX,l=t.shadowOffsetY;i=Math.max(i,-h+o),n=Math.max(n,h+o),r=Math.max(r,l+o),a=Math.max(a,-l+o)}if(t.isItalic){var c=t.fontSize*Math.tan(.20943951);n+=c,e.contentSizeExtend.width+=c}e.canvasPadding.x=i,e.canvasPadding.y=r,e.canvasPadding.width=i+n,e.canvasPadding.height=r+a},e._updateLabelDimensions=function(t,e,r){r.canvasSize.width=Math.min(r.canvasSize.width,we),r.canvasSize.height=Math.min(r.canvasSize.height,we),this._canvas.width=r.canvasSize.width,this._canvas.height=r.canvasSize.height,this._context.font=t.fontDesc,this._context.textAlign=De[e.horizontalAlign],this._context.textBaseline="alphabetic"},e._calculateFillTextStartPosition=function(t,e,r){var a=0;e.horizontalAlign===X.RIGHT?a=r.canvasSize.width-r.canvasPadding.width:e.horizontalAlign===X.CENTER&&(a=(r.canvasSize.width-r.canvasPadding.width)/2);var i=this._getLineHeight(e.lineHeight,t.actualFontSize,t.fontSize)*(r.parsedString.length-1),n=t.actualFontSize*(1-N/2);if(e.verticalAlign!==Z.TOP){var s=i+r.canvasPadding.height+t.actualFontSize-r.canvasSize.height;e.verticalAlign===Z.BOTTOM?n-=s+=N/2*t.actualFontSize:n-=s/2}n+=Ce*t.actualFontSize,r.startPosition.set(a+r.canvasPadding.x,n+r.canvasPadding.y)},e._updateTexture=function(t,e,r,a){if(this._context&&this._canvas){this._context.clearRect(0,0,this._canvas.width,this._canvas.height),this._context.font=t.fontDesc,this._calculateFillTextStartPosition(t,e,r);var i=this._getLineHeight(e.lineHeight,t.actualFontSize,t.fontSize);this._context.lineJoin="round",t.isOutlined?(this._context.fillStyle="rgba("+t.outlineColor.r+", "+t.outlineColor.g+", "+t.outlineColor.b+", "+Te+")",this._context.fillRect(0,0,this._canvas.width,this._canvas.height)):(this._context.fillStyle="rgba("+t.color.r+", "+t.color.g+", "+t.color.b+", "+Te+")",this._context.fillRect(0,0,this._canvas.width,this._canvas.height)),this._context.fillStyle="rgb("+t.color.r+", "+t.color.g+", "+t.color.b+")";var n=new h(r.startPosition.x,r.startPosition.y),s=n.x,o=0;this._drawTextEffect(n,i,t,e,r);for(var l=0;l<r.parsedString.length;++l)o=n.y+l*i,t.isOutlined&&this._context.strokeText(r.parsedString[l],s,o),this._context.fillText(r.parsedString[l],s,o);t.hasShadow&&(this._context.shadowColor="transparent"),this._uploadTexture(a)}},e._uploadTexture=function(t){var e;t.texture&&this._canvas&&(e=t.texture instanceof ut?t.texture.texture:t.texture,0!==this._canvas.width&&0!==this._canvas.height&&(e.reset({width:this._canvas.width,height:this._canvas.height,mipmapLevel:1}),e.uploadData(this._canvas),e.setWrapMode(wt.CLAMP_TO_EDGE,wt.CLAMP_TO_EDGE),t.texture instanceof ut&&(t.texture.rect=new n(0,0,this._canvas.width,this._canvas.height),t.texture._calculateUV()),l.director.root&&l.director.root.batcher2D&&l.director.root.batcher2D._releaseDescriptorSetCache(e.getHash())))},e._drawTextEffect=function(t,e,r,a,i){if(r.hasShadow||r.isOutlined||r.isUnderline){var n=i.parsedString.length>1&&r.hasShadow,s=this._measureText(this._context,r.fontDesc),o=0,l=0;r.hasShadow&&this._setupShadow(r),r.isOutlined&&this._setupOutline(r);for(var c=0;c<i.parsedString.length;++c)if(o=t.x,l=t.y+c*e,n&&(r.isOutlined&&this._context.strokeText(i.parsedString[c],o,l),this._context.fillText(i.parsedString[c],o,l)),r.isUnderline){var u=s(i.parsedString[c]),f=new h;a.horizontalAlign===X.RIGHT?f.x=t.x-u:a.horizontalAlign===X.CENTER?f.x=t.x-u/2:f.x=t.x,f.y=l+r.actualFontSize/8,this._context.fillRect(f.x,f.y,u,r.underlineHeight*this._fontScale)}n&&(this._context.shadowColor="transparent")}},e._setupOutline=function(t){this._context.strokeStyle="rgba("+t.outlineColor.r+", "+t.outlineColor.g+", "+t.outlineColor.b+", "+t.outlineColor.a/255+")",this._context.lineWidth=2*t.outlineWidth*this._fontScale},e._setupShadow=function(t){var e=this._fontScale;this._context.shadowColor="rgba("+t.shadowColor.r+", "+t.shadowColor.g+", "+t.shadowColor.b+", "+t.shadowColor.a/255+")",this._context.shadowBlur=t.shadowBlur*e,this._context.shadowOffsetX=t.shadowOffsetX*e,this._context.shadowOffsetY=-t.shadowOffsetY*e},e.generateVertexData=function(t,e,r,a,i,n,s){t?this._updateQuads(e,r,a,i,n,s):(this.updateQuatCount(i),s(e,a,i))},e.updateQuatCount=function(t){var e=t.vertexBuffer,r=t.quadCount;if(e.length!==r){for(var i=e.length;i<r;i++)e.push({x:0,y:0,z:0,u:0,v:0,color:a.WHITE.clone()});e.length=r}},e._setupBMFontOverflowMetrics=function(t,e){var r=e.nodeContentSize.width,a=e.nodeContentSize.height;t.overFlow===V.RESIZE_HEIGHT&&(a=0),t.overFlow===V.NONE&&(r=0,a=0),t.textWidthTemp=r,t.textHeightTemp=a,t.textDimensions.width=r,t.textDimensions.height=a,t.maxLineWidth=r},e._updateFontScale=function(t){t.bmfontScale=t.actualFontSize/(t.originFontSize*this._fontScale)},e._computeHorizontalKerningForText=function(t,e,r){var a=r,i=a.length;if(t.fntConfig){var n=t.fntConfig.kerningDict,s=e.horizontalKerning;if(n&&0!==n.length)for(var o=-1,h=0;h<i;++h){var l=a.charCodeAt(h),c=n[o<<16|65535&l]||0;s[h]=h<i-1?c:0,o=l}}},e._alignText=function(t,e,r,a){this._multilineTextWrap(t,e,r,a,this._getFirstWordLen),e.overFlow===V.SHRINK&&(t.fontSize>0&&this._isVerticalClamp(t,e,r,a,this)&&this._shrinkLabelToContentSize(t,e,r,a,this._isVerticalClamp),t.fontSize>0&&this._isHorizontalNeedShrink(e,r)&&this._shrinkLabelToContentSize(t,e,r,a,this._isHorizontalClamp)),this._parsedString(r,a)},e._parsedString=function(t,e){for(var r=[],a="",i=0,n=0,s=e.length;i<s;++i){var o=this._lettersInfo[i];o.valid&&(n===o.line?a+=o.char:(r=r.concat(a),n=o.line,a=""))}r=r.concat(a),t.parsedString=r},e._multilineTextWrap=function(t,e,r,a,i){e.linesWidth.length=0;for(var n=a,s=n.length,o=0,l=0,u=0,f=0,d=0,v=0,_=0,p=null,x=0;x<s;){var g=n.charAt(x);if("\n"!==g){for(var m=i(t,e,n,x,s),S=v,y=_,D=d,w=l,C=!1,T=new h,b=0;b<m;++b){var M=x+b;if("\r"!==(g=n.charAt(M)))if(p=k.fontAtlas.getLetterDefinitionForChar(g,k)){var E=w+p.offsetX*t.bmfontScale-k.margin;if(e.wrapping&&e.maxLineWidth>0&&l>0&&E+p.w*t.bmfontScale>e.maxLineWidth&&!Y(g)){e.linesWidth.push(d),d=0,o++,l=0,u-=e.lineHeight*this._getFontScale(t,e)+0,C=!0;break}T.x=E,T.y=u-p.offsetY*t.bmfontScale,this._recordLetterInfo(T,g,M,o),M+1<e.horizontalKerning.length&&M<s-1&&(w+=e.horizontalKerning[M+1]*t.bmfontScale),w+=p.xAdvance*t.bmfontScale+e.spacingX,D=T.x+p.w*t.bmfontScale,S<T.y&&(S=T.y),y>T.y-p.h*t.bmfontScale&&(y=T.y-p.h*t.bmfontScale)}else this._recordPlaceholderInfo(M,g),c("Can't find letter definition in texture atlas "+t.fntConfig.atlasName+" for letter:"+g);else this._recordPlaceholderInfo(M,g)}C||(l=w,v<S&&(v=S),_>y&&(_=y),f<(d=D)&&(f=d),x+=m)}else e.linesWidth.push(d),d=0,o++,l=0,u-=e.lineHeight*this._getFontScale(t,e)+0,this._recordPlaceholderInfo(x,g),x++}return e.linesWidth.push(d),e.numberOfLines=o+1,e.textDesiredHeight=e.numberOfLines*e.lineHeight*this._getFontScale(t,e),e.numberOfLines>1&&(e.textDesiredHeight+=0*(e.numberOfLines-1)),r.nodeContentSize.width=e.textWidthTemp,r.nodeContentSize.height=e.textHeightTemp,e.textWidthTemp<=0&&(r.nodeContentSize.width=parseFloat(f.toFixed(2))+2*k.margin),e.textHeightTemp<=0&&(r.nodeContentSize.height=parseFloat(e.textDesiredHeight.toFixed(2))+2*k.margin),e.tailoredTopY=r.nodeContentSize.height,e.tailoredBottomY=0,v>0&&(e.tailoredTopY=r.nodeContentSize.height+v),_<-e.textDesiredHeight&&(e.tailoredBottomY=e.textDesiredHeight+_),!0},e._recordPlaceholderInfo=function(t,e){if(t>=this._lettersInfo.length){var r=new be;this._lettersInfo.push(r)}this._lettersInfo[t].char=e,this._lettersInfo[t].hash=""+e.charCodeAt(0)+k.hash,this._lettersInfo[t].valid=!1},e._recordLetterInfo=function(t,e,r,a){if(r>=this._lettersInfo.length){var i=new be;this._lettersInfo.push(i)}var n=""+e.charCodeAt(0)+k.hash;this._lettersInfo[r].line=a,this._lettersInfo[r].char=e,this._lettersInfo[r].hash=n,this._lettersInfo[r].valid=k.fontAtlas.getLetter(n).valid,this._lettersInfo[r].x=t.x,this._lettersInfo[r].y=t.y},e._getFirstWordLen=function(t,e,r,a,i){var n=r.charAt(a);if(q(n)||"\n"===n||Y(n))return 1;var s=1,o=k.fontAtlas.getLetterDefinitionForChar(n,k);if(!o)return s;for(var h=o.xAdvance*t.bmfontScale+e.spacingX,l=a+1;l<i&&(n=r.charAt(l),o=k.fontAtlas.getLetterDefinitionForChar(n,k));++l){if(h+o.offsetX*t.bmfontScale+o.w*t.bmfontScale>e.maxLineWidth&&!Y(n)&&e.maxLineWidth>0)return s;if(h+=o.xAdvance*t.bmfontScale+e.spacingX,"\n"===n||Y(n)||q(n))break;s++}return s},e._computeAlignmentOffset=function(t,e,r){switch(e.linesOffsetX.length=0,e.letterOffsetY=0,e.horizontalAlign){case X.LEFT:for(var a=0;a<e.numberOfLines;++a)e.linesOffsetX.push(0);break;case X.CENTER:for(var i=0,n=e.linesWidth.length;i<n;i++)e.linesOffsetX.push((r.nodeContentSize.width-e.linesWidth[i])/2);break;case X.RIGHT:for(var s=0,o=e.linesWidth.length;s<o;s++)e.linesOffsetX.push(r.nodeContentSize.width-e.linesWidth[s])}if(e.letterOffsetY=r.nodeContentSize.height,e.verticalAlign!==Z.TOP){var h=r.nodeContentSize.height-e.textDesiredHeight+e.lineHeight*this._getFontScale(t,e)-t.originFontSize*this._fontScale*t.bmfontScale;e.verticalAlign===Z.BOTTOM?e.letterOffsetY-=h:e.letterOffsetY-=h/2}},e._getFontScale=function(t,e){return e.overFlow===V.SHRINK?t.bmfontScale:1},e._isVerticalClamp=function(t,e,r){return e.textDesiredHeight>r.nodeContentSize.height},e._isHorizontalClamp=function(t,e,r,a,i){for(var n=!1,s=0,o=a.length;s<o;++s){var h=i._lettersInfo[s];if(h.valid){var l=k.fontAtlas.getLetterDefinitionForChar(h.char,k);if(!l)continue;var c=h.x+l.w*t.bmfontScale,u=h.line;if(e.textWidthTemp>0)if(e.wrapping){if(e.linesWidth[u]>r.nodeContentSize.width&&(c>r.nodeContentSize.width||c<0)){n=!0;break}}else if(c>r.nodeContentSize.width){n=!0;break}}}return n},e._isHorizontalNeedShrink=function(t,e){for(var r=0,a=t.linesWidth.length;r<a;++r)if(t.linesWidth[r]>e.nodeContentSize.width)return!0;return!1},e._shrinkLabelToContentSize=function(t,e,r,a,i){for(var n=0,s=0|t.actualFontSize,o=0;n<s;){var h=o=n+s+1>>1;if(h<=0)break;t.bmfontScale=h/(t.originFontSize*this._fontScale),this._multilineTextWrap(t,e,r,a,this._getFirstWordLen),this._computeAlignmentOffset(t,e,r),i(t,e,r,a,this)?s=o-1:n=o}n>=0&&this._scaleFontSizeDown(t,e,r,a,n)},e._scaleFontSizeDown=function(t,e,r,a,i){var n=!0;i||(i=.1,n=!1),t.actualFontSize=i,n&&(this._updateFontScale(t),this._multilineTextWrap(t,e,r,a,this._getFirstWordLen))},e._updateQuads=function(t,e,r,a,i,n){for(var s=t.spriteFrame?t.spriteFrame.texture:k.fontAtlas.getTexture(),o=a.uiTransAnchorX*r.nodeContentSize.width,h=a.uiTransAnchorY*r.nodeContentSize.height,l=0,c=i.length;l<c;++l){var f=this._lettersInfo[l];if(f.valid){var d=k.fontAtlas.getLetter(f.hash);if(d){this._tmpRect.height=d.h,this._tmpRect.width=d.w,this._tmpRect.x=d.u,this._tmpRect.y=d.v;var v=f.y+e.letterOffsetY;if(e.textHeightTemp>0){if(v>e.tailoredTopY){var _=v-e.tailoredTopY;this._tmpRect.y+=_,this._tmpRect.height-=_,v-=_}v-this._tmpRect.height*t.bmfontScale<e.tailoredBottomY&&e.overFlow===V.CLAMP&&(this._tmpRect.height=v<e.tailoredBottomY?0:(v-e.tailoredBottomY)/t.bmfontScale)}var p=f.line,x=f.x+d.w/2*t.bmfontScale+e.linesOffsetX[p];if(e.textWidthTemp>0&&this._isHorizontalClamped(e,r,x,p)&&e.overFlow===V.CLAMP&&(this._tmpRect.width=0),this._tmpRect.height>0&&this._tmpRect.width>0){var g=this._determineRect(t),m=f.x+e.linesOffsetX[f.line],S=a.quadCount;a.quadCount+=4,this.updateQuatCount(a),n(t,r,a,S,s,this._tmpRect,g,m-o,v-h)}}else u("Can't find letter in this bitmap-font")}}return!0},e._isHorizontalClamped=function(t,e,r,a){var i=t.linesWidth[a],n=r>e.nodeContentSize.width||r<0;return t.wrapping?i>e.nodeContentSize.width&&n:n},e._determineRect=function(t){var e=t.spriteFrame;if(!e)return!1;var r=e.isRotated(),a=e.getOriginalSize(),i=e.getRect(),n=e.getOffset(),s=n.x+(a.width-i.width)/2,o=n.y-(a.height-i.height)/2;if(r){var h=this._tmpRect.x;this._tmpRect.x=i.x+i.height-this._tmpRect.y-this._tmpRect.height-o,this._tmpRect.y=h+i.y-s,this._tmpRect.y<0&&(this._tmpRect.height+=o)}else this._tmpRect.x+=i.x-s,this._tmpRect.y+=i.y+o;return r},t}();Me.instance=void 0,Me.instance=new Me;var Ee,Be=new G(64,64),Fe=new j(null),Re=null,ze=null,Le=null,Ae=null,Ie={updateProcessingData:function(t,e,r,a,i,n){t.fontSize=i.fontSize,t.actualFontSize=i.fontSize,t.originFontSize=Le?Le.fontSize:i.fontSize,e.horizontalAlign=i.horizontalAlign,e.verticalAlign=i.verticalAlign,e.spacingX=i.spacingX;var s=i.overflow;e.overFlow=s,e.lineHeight=i.lineHeight,r.nodeContentSize.width=n.width,r.nodeContentSize.height=n.height,s===V.NONE?(e.wrapping=!1,r.nodeContentSize.width+=2*k.margin,r.nodeContentSize.height+=2*k.margin):s===V.RESIZE_HEIGHT?(e.wrapping=!0,r.nodeContentSize.height+=2*k.margin):e.wrapping=i.enableWrapText,a.uiTransAnchorX=n.anchorX,a.uiTransAnchorY=n.anchorY,k.lineHeight=i.lineHeight,k.fontSize=i.fontSize,t.spriteFrame=Ae,t.fntConfig=Le,t.fontFamily=k.fontFamily,t.color.set(i.color)},updateRenderData:function(t){if(t.renderData&&Re!==t){if(t.renderData.vertDirty){ze=(Re=t).node._uiProps.uiTransformComp;var e=t.renderData,r=Me.instance,a=t.textStyle,i=t.textLayout,n=t.textLayoutData,s=t.textRenderData;a.fontScale=ft.getScaleX(),this._updateFontFamily(t),this.updateProcessingData(a,i,n,s,t,ze),this._updateLabelInfo(t),a.fontDesc=k.fontDesc,r.processingString(!0,a,i,n,t.string),this.resetRenderData(t),s.quadCount=0,r.generateRenderInfo(!0,a,i,n,s,t.string,this.generateVertexData),e.dataLength=s.quadCount,e.resize(e.dataLength,e.dataLength/2*3);for(var o=e.data,h=0,l=s.quadCount;h<l;h++)o[h]=s.vertexBuffer[h];var c=e.indexCount;this.createQuadIndices(c),e.chunk.setIndexBuffer(Ee),Re.actualFontSize=a.actualFontSize,ze.setContentSize(n.nodeContentSize),this.updateUVs(t),this.updateColor(t),e.vertDirty=!1,Re=null,this._resetProperties()}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateUVs:function(t){for(var e=t.renderData,r=e.chunk.vb,a=e.vertexCount,i=e.data,n=3,s=0;s<a;s++){var o=i[s];r[n]=o.u,r[n+1]=o.v,n+=9}},updateColor:function(){},resetRenderData:function(t){var e=t.renderData;e.dataLength=0,e.resize(0,0)},generateVertexData:function(t,e,r,a,i,n,s,o,h){var l=a,c=t.bmfontScale,u=r.vertexBuffer,f=i.width,d=i.height,v=n.width,_=n.height,p=0,x=0,g=0,m=0;s?(p=n.x/f,m=(n.x+_)/f,x=(n.y+v)/d,g=n.y/d,u[l].u=p,u[l].v=g,u[l+1].u=p,u[l+1].v=x,u[l+2].u=m,u[l+2].v=g,u[l+3].u=m,u[l+3].v=x):(p=n.x/f,m=(n.x+v)/f,x=(n.y+_)/d,g=n.y/d,u[l].u=p,u[l].v=x,u[l+1].u=m,u[l+1].v=x,u[l+2].u=p,u[l+2].v=g,u[l+3].u=m,u[l+3].v=g),u[l].x=o,u[l].y=h-_*c,u[l+1].x=o+v*c,u[l+1].y=h-_*c,u[l+2].x=o,u[l+2].y=h,u[l+3].x=o+v*c,u[l+3].y=h},_updateFontFamily:function(t){var e=t.font;Ae=e.spriteFrame,Le=e.fntConfig,k.fontAtlas=e.fontDefDictionary,k.fontAtlas||(t.cacheMode===J.CHAR?k.fontAtlas=Be:k.fontAtlas=Fe),dt.packToDynamicAtlas(t,Ae)},_updateLabelInfo:function(){k.hash="",k.margin=0},_resetProperties:function(){Le=null,Ae=null,k.hash="",k.margin=0},createQuadIndices:function(t){if(t%6==0){var e=t/6;Ee=null,Ee=new Uint16Array(t);for(var r=0,a=0;a<e;a++)Ee[r++]=0+4*a,Ee[r++]=1+4*a,Ee[r++]=2+4*a,Ee[r++]=1+4*a,Ee[r++]=3+4*a,Ee[r++]=2+4*a}else console.error("illegal index count!")}},Pe=new a(255,255,255,255),Oe={createData:function(t){var e=t.requestRenderData();return e.resize(0,0),e},fillBuffers:function(t){var e=t.node;Pe.set(t.color),Pe.a=255*e._uiProps.opacity,Ot(e,0,t.renderData,Pe)},appendQuad:function(t,e,r,a,i,n,s){var o=t.renderData;if(o){var h=o.dataLength;o.dataLength+=4,o.resize(o.dataLength,o.dataLength/2*3);var l=o.data,c=e.width,u=e.height,f=r.width,d=r.height,v=0,_=0,p=0,x=0;a?(v=r.x/c,x=(r.x+d)/c,_=(r.y+f)/u,p=r.y/u,l[h].u=v,l[h].v=p,l[h+1].u=v,l[h+1].v=_,l[h+2].u=x,l[h+2].v=p,l[h+3].u=x,l[h+3].v=_):(v=r.x/c,x=(r.x+f)/c,_=(r.y+d)/u,p=r.y/u,l[h].u=v,l[h].v=_,l[h+1].u=x,l[h+1].v=_,l[h+2].u=v,l[h+2].v=p,l[h+3].u=x,l[h+3].v=p),l[h].x=i,l[h].y=n-d*s,l[h+1].x=i+f*s,l[h+1].y=n-d*s,l[h+2].x=i,l[h+2].y=n,l[h+3].x=i+f*s,l[h+3].y=n}}};f(Oe,Ie);var He=null,ke=d(Ie,{getAssemblerData:function(){return He||(He=new G(1024,1024)),He.getTexture()},_updateFontFamily:function(t){k.fontAtlas=He,k.fontFamily=this._getFontFamily(t);var e=t.getComponent(ht);e&&e.enabled?(k.isOutlined=!0,k.margin=e.width,k.out=e.color.clone(),k.out.a=e.color.a*t.color.a/255):(k.isOutlined=!1,k.margin=0)},_getFontFamily:function(t){var e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo:function(t){k.fontDesc=this._getFontDesc(),k.color=t.color,k.hash=K(k)},_getFontDesc:function(){return k.fontSize.toString()+"px "+k.fontFamily}}),Ve=new a(255,255,255,255),Ne={createData:function(t){var e=t.requestRenderData();return e.resize(0,0),e},fillBuffers:function(t){if(t.renderData){var e=t.node;Ve.a=255*e._uiProps.opacity,Ot(e,0,t.renderData,Ve)}},updateColor:function(){}};f(Ne,ke);var Ue=$.Overflow,We={updateProcessingData:function(t,e,r,a,i,n){t.isSystemFontUsed=i.useSystemFont,t.fontSize=i.fontSize,r.nodeContentSize.width=r.canvasSize.width=n.width,r.nodeContentSize.height=r.canvasSize.height=n.height,e.lineHeight=i.lineHeight,e.overFlow=i.overflow,i.overflow===Ue.NONE?e.wrapping=!1:i.overflow===Ue.RESIZE_HEIGHT?e.wrapping=!0:e.wrapping=i.enableWrapText,t.isBold=i.isBold,t.isItalic=i.isItalic,t.isUnderline=i.isUnderline,t.underlineHeight=i.underlineHeight;var s=ht&&i.getComponent(ht);(s=s&&s.enabled&&s.width>0?s:null)?(t.isOutlined=!0,t.outlineColor.set(s.color),t.outlineWidth=s.width):t.isOutlined=!1;var o=lt&&i.getComponent(lt);(o=o&&o.enabled?o:null)?(t.hasShadow=!0,t.shadowColor.set(o.color),t.shadowBlur=o.blur,t.shadowOffsetX=o.offset.x,t.shadowOffsetY=o.offset.y):t.hasShadow=!1,t.color.set(i.color),a.texture=i.spriteFrame,a.uiTransAnchorX=n.anchorX,a.uiTransAnchorY=n.anchorY,e.horizontalAlign=i.horizontalAlign,e.verticalAlign=i.verticalAlign},getAssemblerData:function(){var t=$._canvasPool.get();return t.canvas.width=t.canvas.height=1,t},resetAssemblerData:function(t){t&&$._canvasPool.put(t)},updateRenderData:function(t){if(t.renderData){if(t.renderData.vertDirty){var e=t.node._uiProps.uiTransformComp,r=Me.instance,a=t.textStyle,i=t.textLayout,n=t.textLayoutData,s=t.textRenderData;a.fontScale=ft.getScaleX(),this.updateProcessingData(a,i,n,s,t,e),r.setCanvasUsed(t.assemblerData.canvas,t.assemblerData.context),a.fontFamily=this._updateFontFamily(t),this._resetDynamicAtlas(t),r.processingString(!1,a,i,n,t.string),r.generateRenderInfo(!1,a,i,n,s,t.string,this.generateVertexData);var o=t.renderData;o.textureDirty=!0,this._calDynamicAtlas(t,n),t.actualFontSize=a.actualFontSize,e.setContentSize(n.nodeContentSize);var h=o.data;h[0]=s.vertexBuffer[0],h[1]=s.vertexBuffer[1],h[2]=s.vertexBuffer[2],h[3]=s.vertexBuffer[3],this.updateUVs(t),t.renderData.vertDirty=!1,t.contentWidth=n.nodeContentSize.width}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},generateVertexData:function(t,e,r){var a=r.vertexBuffer,i=e.nodeContentSize.width,n=e.nodeContentSize.height,s=r.uiTransAnchorX*i,o=r.uiTransAnchorY*n;a[0].x=-s,a[0].y=-o,a[1].x=i-s,a[1].y=-o,a[2].x=-s,a[2].y=n-o,a[3].x=i-s,a[3].y=n-o},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(t){return t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_calDynamicAtlas:function(t,e){if(!(t.cacheMode!==$.CacheMode.BITMAP||e.canvasSize.width<=0||e.canvasSize.height<=0)){var r=t.ttfSpriteFrame;dt.packToDynamicAtlas(t,r)}},_resetDynamicAtlas:function(t){if(t.cacheMode===$.CacheMode.BITMAP){var e=t.ttfSpriteFrame;dt.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}}},Xe=a.WHITE.clone(),Ze=Uint16Array.from([0,1,2,1,3,2]),Ye={createData:function(t){var e=t.requestRenderData();e.dataLength=4,e.resize(4,6),t.textRenderData.quadCount=4;var r=e.chunk.vb;r[3]=r[21]=r[22]=r[31]=0,r[4]=r[12]=r[13]=r[30]=1;for(var i=5,n=0;n<4;n++)a.toArray(r,Xe,i),i+=9;return e.vertexRow=2,e.vertexCol=2,e.chunk.setIndexBuffer(Ze),e},fillBuffers:function(t){for(var e=t.renderData,r=e.chunk,a=e.data,i=t.node,n=r.vb,s=i.worldMatrix,o=e.floatStride,h=0,l=a.length,c=0;c<l;c++){var u=a[c],f=u.x,d=u.y,v=s.m03*f+s.m07*d+s.m15;v=v?1/v:1,n[0+(h=c*o)]=(s.m00*f+s.m04*d+s.m12)*v,n[h+1]=(s.m01*f+s.m05*d+s.m13)*v,n[h+2]=(s.m02*f+s.m06*d+s.m14)*v}var _=r.vertexOffset,p=r.meshBuffer,x=r.meshBuffer.iData,g=p.indexOffset;x[g++]=_,x[g++]=_+1,x[g++]=_+2,x[g++]=_+2,x[g++]=_+1,x[g++]=_+3,p.indexOffset+=6},updateVertexData:function(t){var e=t.renderData;if(e){var r=t.node._uiProps.uiTransformComp,a=r.width,i=r.height,n=r.anchorX*a,s=r.anchorY*i,o=e.data;o[0].x=-n,o[0].y=-s,o[1].x=a-n,o[1].y=-s,o[2].x=-n,o[2].y=i-s,o[3].x=a-n,o[3].y=i-s}},updateUVs:function(t){var e=t.renderData;if(e&&t.ttfSpriteFrame){var r=e.chunk.vb,a=t.ttfSpriteFrame.uv;r[3]=a[0],r[4]=a[1],r[12]=a[2],r[13]=a[3],r[21]=a[4],r[22]=a[5],r[30]=a[6],r[31]=a[7]}},updateColor:function(){}};f(Ye,We);var qe=t("l",{getAssembler:function(t){var e=Ye;return t.font instanceof tt?e=Oe:t.cacheMode===$.CacheMode.CHAR&&(e=Ne),e}});$.Assembler=qe;var Qe,Ge=et.FillType,je=new e,Je=Uint16Array.from([0,1,2,1,3,2]),Ke={updateRenderData:function(t){var e=t.spriteFrame;dt.packToDynamicAtlas(t,e);var r=t.renderData;if(r&&e){if(!r.vertDirty)return;var a=t.fillStart,i=t.fillRange;i<0&&(a+=i,i=-i),i=(i=(i=a+i)>1?1:i)<0?0:i;var n=(a=(a=a>1?1:a)<0?0:a)+(i=(i-=a)<0?0:i);n=n>1?1:n,this.updateUVs(t,a,n),this.updateVertexData(t,a,n),r.updateRenderData(t,e)}},updateUVs:function(t,e,r){var a=t.spriteFrame,i=t.renderData.chunk.vb,n=a.width,s=a.height,o=a.rect,h=0,l=0,c=0,u=0,f=0,d=0,_=0,p=0,x=0,g=0;switch(a.isRotated()?(h=o.x/n,l=(o.y+o.width)/s,c=f=h,_=x=(o.x+o.height)/n,d=g=l,u=p=o.y/s):(h=o.x/n,l=(o.y+o.height)/s,c=_=h,f=x=(o.x+o.width)/n,u=d=l,p=g=o.y/s),t.fillType){case Ge.HORIZONTAL:i[3]=c+(f-c)*e,i[4]=u+(d-u)*e,i[12]=c+(f-c)*r,i[13]=u+(d-u)*r,i[21]=_+(x-_)*e,i[22]=p+(g-p)*e,i[30]=_+(x-_)*r,i[31]=p+(g-p)*r;break;case Ge.VERTICAL:i[3]=c+(_-c)*e,i[4]=u+(p-u)*e,i[12]=f+(x-f)*e,i[13]=d+(g-d)*e,i[21]=c+(_-c)*r,i[22]=u+(p-u)*r,i[30]=f+(x-f)*r,i[31]=d+(g-d)*r;break;default:v(2626)}},updateVertexData:function(t,e,r){var a=t.renderData.data,i=t.node._uiProps.uiTransformComp,n=i.width,s=i.height,o=i.anchorX*n,h=i.anchorY*s,l=-o,c=-h,u=n-o,f=s-h,d=0;switch(t.fillType){case Ge.HORIZONTAL:d=l+(u-l)*r,l+=(u-l)*e,u=d;break;case Ge.VERTICAL:d=c+(f-c)*r,c+=(f-c)*e,f=d;break;default:v(2626)}a[0].x=l,a[0].y=c,a[1].x=u,a[1].y=c,a[2].x=l,a[2].y=f,a[3].x=u,a[3].y=f},createData:function(t){var e=t.requestRenderData();e.dataLength=4,e.resize(4,6),e.vertexRow=2,e.vertexCol=2,e.chunk.setIndexBuffer(Je);for(var r,a=e.data,i=o(a);!(r=i()).done;)r.value.z=0;return e},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(je);for(var r=t.renderData.floatStride,a=t.renderData.data,i=e.vb,n=0,s=0;s<4;s++){var o=a[s],h=o.x,l=o.y,c=je.m03*h+je.m07*l+je.m15;c=c?1/c:1,i[n=s*r]=(je.m00*h+je.m04*l+je.m12)*c,i[n+1]=(je.m01*h+je.m05*l+je.m13)*c,i[n+2]=(je.m02*h+je.m06*l+je.m14)*c}},fillBuffers:function(t){var e=t.renderData,r=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,r),e.vertDirty=!1),r.bufferId;var a=r.vertexOffset,i=r.meshBuffer,n=r.meshBuffer.iData,s=i.indexOffset;n[s++]=a,n[s++]=a+1,n[s++]=a+2,n[s++]=a+2,n[s++]=a+1,n[s++]=a+3,i.indexOffset+=6},updateColor:function(t){for(var e=t.renderData,r=e.chunk.vb,a=e.floatStride,i=5,n=t.color,s=n.r/255,o=n.g/255,h=n.b/255,l=t.node._uiProps.opacity,c=0;c<4;c++)r[i]=s,r[i+1]=o,r[i+2]=h,r[i+3]=l,i+=a}},$e=2*Math.PI,tr=1e-6,er=new e,rr=[new h,new h,new h,new h],ar=new Array(4),ir=new Array(8),nr=[new h,new h,new h,new h],sr=[new h,new h,new h,new h],or=new h,hr=[new h,new h,new h,new h];function lr(t,e,r,a,i,n,s){var o=Math.sin(n);o=Math.abs(o)>tr?o:0;var h=Math.cos(n),l=0,c=0;if(0!==(h=Math.abs(h)>tr?h:0)){if(l=o/h,(t-i.x)*h>0){var u=i.y+l*(t-i.x);s[0].x=t,s[0].y=u}if((e-i.x)*h>0){var f=i.y+l*(e-i.x);s[2].x=e,s[2].y=f}}if(0!==o){if(c=h/o,(a-i.y)*o>0){var d=i.x+c*(a-i.y);s[3].x=d,s[3].y=a}if((r-i.y)*o>0){var v=i.x+c*(r-i.y);s[1].x=v,s[1].y=r}}}function cr(t,e){var r=e.x-t.x,a=e.y-t.y;if(0===r&&0===a)return 0;if(0===r)return a>0?.5*Math.PI:1.5*Math.PI;var i=Math.atan(a/r);return r<0&&(i+=Math.PI),i}function ur(t,e,r,a,i){var n=ar,s=n[0],o=n[1],h=n[2],l=n[3];t[e].x=r.x,t[e].y=r.y,t[e+1].x=a.x,t[e+1].y=a.y,t[e+2].x=i.x,t[e+2].y=i.y,fr((r.x-s)/(h-s),(r.y-o)/(l-o),t,e),fr((a.x-s)/(h-s),(a.y-o)/(l-o),t,e+1),fr((i.x-s)/(h-s),(i.y-o)/(l-o),t,e+2)}function fr(t,e,r,a){var i=ir,n=i[0]+(i[2]-i[0])*t,s=i[4]+(i[6]-i[4])*t,o=i[1]+(i[3]-i[1])*t,h=i[5]+(i[7]-i[5])*t,l=r[a];l.u=n+(s-n)*e,l.v=o+(h-o)*e}for(var dr={useModel:!1,createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.spriteFrame;dt.packToDynamicAtlas(t,e),this.updateUVs(t);var r,a,i,n,s,o,l,c,u,f=t.renderData;if(f&&e){if(!f.vertDirty)return;var d=f.data,v=t.fillStart,_=t.fillRange;for(_<0&&(v+=_,_=-_);v>=1;)v-=1;for(;v<0;)v+=1;var p=(v*=$e)+(_*=$e);!function(t){var e=t.node._uiProps.uiTransformComp,r=e.width,a=e.height,i=e.anchorX*r,n=e.anchorY*a,s=-i,o=-n,l=r-i,c=a-n,u=ar;u[0]=s,u[1]=o,u[2]=l,u[3]=c;var f=t.fillCenter,d=or.x=Math.min(Math.max(0,f.x),1)*(l-s)+s,v=or.y=Math.min(Math.max(0,f.y),1)*(c-o)+o;rr[0].x=rr[3].x=s,rr[1].x=rr[2].x=l,rr[0].y=rr[1].y=o,rr[2].y=rr[3].y=c;for(var _=0,p=hr;_<p.length;_++){var x=p[_];h.set(x,0,0)}d!==u[0]&&h.set(hr[0],3,0),d!==u[2]&&h.set(hr[2],1,2),v!==u[1]&&h.set(hr[1],0,1),v!==u[3]&&h.set(hr[3],2,3)}(t),a=(r=e).width,i=r.height,n=r.getRect(),s=0,o=0,l=0,c=0,u=ir,r.isRotated()?(s=n.x/a,o=(n.x+n.height)/a,l=n.y/i,c=(n.y+n.width)/i,u[0]=u[2]=s,u[4]=u[6]=o,u[3]=u[7]=c,u[1]=u[5]=l):(s=n.x/a,o=(n.x+n.width)/a,l=n.y/i,c=(n.y+n.height)/i,u[0]=u[4]=s,u[2]=u[6]=o,u[1]=u[3]=c,u[5]=u[7]=l),lr(ar[0],ar[2],ar[1],ar[3],or,v,nr),lr(ar[0],ar[2],ar[1],ar[3],or,v+_,sr);for(var x=0,g=0;g<4;++g){var m=hr[g];if(m)if(_>=$e)f.dataLength=x+3,ur(d,x,or,rr[m.x],rr[m.y]),x+=3;else{var S=cr(or,rr[m.x]),y=cr(or,rr[m.y]);y<S&&(y+=$e),S-=$e,y-=$e;for(var D=0;D<3;++D)S>=p||(S>=v?(f.dataLength=x+3,ur(d,x,or,rr[m.x],y>=p?sr[g]:rr[m.y]),x+=3):y>v&&(y<=p?(f.dataLength=x+3,ur(d,x,or,nr[g],rr[m.y]),x+=3):(f.dataLength=x+3,ur(d,x,or,nr[g],sr[g]),x+=3))),S+=$e,y+=$e}}0===x&&(f.dataLength=0),f.resize(x,x),f.updateRenderData(t,e)}},createQuadIndices:function(t){Qe=null,Qe=new Uint16Array(t);for(var e=0,r=0;r<t;r++)Qe[e++]=r},fillBuffers:function(t){var e=t.node,r=t.renderData,a=r.chunk;(e.hasChangedFlags||r.vertDirty)&&(this.updateWorldVertexAndUVData(t,a),r.vertDirty=!1),this.updateColorLate(t),a.bufferId;for(var i=a.vertexOffset,n=a.meshBuffer,s=a.meshBuffer.iData,o=n.indexOffset,h=0;h<r.indexCount;h++)s[o+h]=i+h;n.indexOffset+=r.indexCount,n.setDirty()},updateWorldUVData:function(t){for(var e=t.renderData,r=e.floatStride,a=e.data,i=e.chunk.vb,n=0;n<a.length;n++){var s=n*r;i[s+3]=a[n].u,i[s+4]=a[n].v}},updateWorldVertexAndUVData:function(t,e){t.node.getWorldMatrix(er);for(var r=t.renderData,a=r.floatStride,i=t.renderData.data,n=e.vb,s=r.vertexCount,o=0,h=0;h<s;h++){var l=i[h],c=l.x,u=l.y,f=er.m03*c+er.m07*u+er.m15;f=f?1/f:1,n[o+0]=(er.m00*c+er.m04*u+er.m12)*f,n[o+1]=(er.m01*c+er.m05*u+er.m13)*f,n[o+2]=(er.m02*c+er.m06*u+er.m14)*f,n[o+3]=l.u,n[o+4]=l.v,o+=a}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updateColorLate:function(t){for(var e=t.renderData,r=e.chunk.vb,a=e.floatStride,i=e.vertexCount,n=5,s=t.color,o=s.r/255,h=s.g/255,l=s.b/255,c=t.node._uiProps.opacity,u=0;u<i;u++)r[n]=o,r[n+1]=h,r[n+2]=l,r[n+3]=c,n+=a},updateColor:function(){}},vr=Uint16Array.from([0,1,2,1,3,2]),_r={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(4,6),e.vertexRow=2,e.vertexCol=2,e.chunk.setIndexBuffer(vr),e},updateRenderData:function(t){var e=t.spriteFrame;dt.packToDynamicAtlas(t,e),this.updateUVs(t);var r=t.renderData;r&&e&&(r.vertDirty&&this.updateVertexData(t),r.updateRenderData(t,e))},updateWorldVerts:function(t,e){for(var r=t.renderData,a=e.vb,i=r.data,n=t.node.worldMatrix,s=r.floatStride,o=0,h=i.length,l=0;l<h;l++){var c=i[l],u=c.x,f=c.y,d=n.m03*u+n.m07*f+n.m15;d=d?1/d:1,a[0+(o=l*s)]=(n.m00*u+n.m04*f+n.m12)*d,a[o+1]=(n.m01*u+n.m05*f+n.m13)*d,a[o+2]=(n.m02*u+n.m06*f+n.m14)*d}},fillBuffers:function(t){if(null!==t){var e=t.renderData,r=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,r),e.vertDirty=!1),r.bufferId;for(var a=r.vertexOffset,i=r.meshBuffer,n=r.meshBuffer.iData,s=i.indexOffset,o=0;o<e.vertexRow-1;o++)for(var h=0;h<e.vertexCol-1;h++){var l=a+o*e.vertexCol+h;n[s++]=l,n[s++]=l+1,n[s++]=l+e.vertexCol,n[s++]=l+1,n[s++]=l+1+e.vertexCol,n[s++]=l+e.vertexCol,i.indexOffset+=6}}},updateVertexData:function(t){var e=t.renderData;if(e){var r=t.node._uiProps.uiTransformComp,a=e.data,i=r.width,n=r.height,s=r.anchorX*i,o=r.anchorY*n,h=0,l=0,c=0,u=0;if(t.trim)h=-s,l=-o,c=i-s,u=n-o;else{var f=t.spriteFrame,d=f.originalSize,v=i/d.width,_=n/d.height,p=f.trimmedBorder;h=p.x*v-s,l=p.z*_-o,c=i+p.y*v-s,u=n+p.w*_-o}a[0].x=h,a[0].y=l,a[1].x=c,a[1].y=l,a[2].x=h,a[2].y=u,a[3].x=c,a[3].y=u,e.vertDirty=!0}},updateUVs:function(t){if(t.spriteFrame){var e=t.renderData.chunk.vb,r=t.spriteFrame.uv;e[3]=r[0],e[4]=r[1],e[12]=r[2],e[13]=r[3],e[21]=r[4],e[22]=r[5],e[30]=r[6],e[31]=r[7]}},updateColor:function(t){for(var e=t.renderData,r=e.chunk.vb,a=5,i=t.color,n=i.r/255,s=i.g/255,o=i.b/255,h=i.a/255,l=0;l<4;l++,a+=e.floatStride)r[a]=n,r[a+1]=s,r[a+2]=o,r[a+3]=h}},pr=new e,xr=[],gr=0;gr<4;gr++)xr.push({x:0,y:0,z:0,u:0,v:0,color:new a});var mr,Sr,yr,Dr,wr,Cr,Tr,br,Mr={createData:function(t){var e=t.requestRenderData();return e.dataLength=16,e.resize(16,54),e.vertexRow=4,e.vertexCol=4,this.QUAD_INDICES=new Uint16Array(54),this.createQuadIndices(4,4),e.chunk.setIndexBuffer(this.QUAD_INDICES),e},createQuadIndices:function(t,e){for(var r=0,a=0;a<t-1;a++)for(var i=0;i<e-1;i++){var n=a*e+i;this.QUAD_INDICES[r++]=n,this.QUAD_INDICES[r++]=n+1,this.QUAD_INDICES[r++]=n+e,this.QUAD_INDICES[r++]=n+1,this.QUAD_INDICES[r++]=n+1+e,this.QUAD_INDICES[r++]=n+e}},updateRenderData:function(t){var e=t.spriteFrame;dt.packToDynamicAtlas(t,e),this.updateUVs(t);var r=t.renderData;r&&e&&(r.vertDirty&&this.updateVertexData(t),r.updateRenderData(t,e))},updateVertexData:function(t){var e=t.renderData,r=e.data,a=t.node._uiProps.uiTransformComp,i=a.width,n=a.height,s=a.anchorX*i,o=a.anchorY*n,h=t.spriteFrame,l=h.insetLeft,c=h.insetRight,u=h.insetTop,f=h.insetBottom,d=i-l-c,v=n-u-f,_=i/(l+c),p=n/(u+f);_=Number.isNaN(_)||_>1?1:_,p=Number.isNaN(p)||p>1?1:p,d=d<0?0:d,v=v<0?0:v,xr[0].x=-s,xr[0].y=-o,xr[1].x=l*_-s,xr[1].y=f*p-o,xr[2].x=xr[1].x+d,xr[2].y=xr[1].y+v,xr[3].x=i-s,xr[3].y=n-o;for(var x=0;x<e.vertexRow;x++)for(var g=0;g<e.vertexCol;g++){var m=x*e.vertexCol+g;m<e.dataLength&&x<xr.length&&g<xr.length&&(r[m].x=xr[g].x,r[m].y=xr[x].y)}},fillBuffers:function(t){var e=t.renderData,r=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,r),e.vertDirty=!1),r.bufferId;for(var a=r.vertexOffset,i=r.meshBuffer,n=r.meshBuffer.iData,s=i.indexOffset,o=0;o<3;++o)for(var h=0;h<3;++h){var l=a+4*o+h;n[s++]=l,n[s++]=l+1,n[s++]=l+4,n[s++]=l+1,n[s++]=l+5,n[s++]=l+4}i.indexOffset=s},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(pr);for(var r=t.renderData,a=r.floatStride,i=r.data,n=e.vb,s=0,o=0;o<4;++o)for(var h=i[4*o],l=0;l<4;++l){var c=i[l].x,u=h.y,f=pr.m03*c+pr.m07*u+pr.m15;f=f?1/f:1,n[0+(s=(4*o+l)*a)]=(pr.m00*c+pr.m04*u+pr.m12)*f,n[s+1]=(pr.m01*c+pr.m05*u+pr.m13)*f,n[s+2]=(pr.m02*c+pr.m06*u+pr.m14)*f}},updateUVs:function(t){if(t.spriteFrame)for(var e=t.renderData,r=e.chunk.vb,a=e.floatStride,i=t.spriteFrame.uvSliced,n=3,s=0;s<16;s++)r[n]=i[s].u,r[n+1]=i[s].v,n+=a},updateColor:function(t){for(var e=t.renderData,r=e.chunk.vb,a=e.floatStride,i=5,n=t.color,s=n.r/255,o=n.g/255,h=n.b/255,l=t.node._uiProps.opacity,c=0;c<16;c++)r[i]=s,r[i+1]=o,r[i+2]=h,r[i+3]=l,i+=a}},Er=new e,Br=0,Fr=[];function Rr(t){return t&&(t.insetTop>0||t.insetBottom>0||t.insetLeft>0||t.insetRight>0)?2:0}var zr={createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.renderData,r=t.spriteFrame;if(r&&e&&e.vertDirty){var a=t.node._uiProps.uiTransformComp,i=Math.abs(a.width),n=Math.abs(a.height),s=r.getRect(),o=r.insetLeft,h=r.insetRight,l=s.width-o-h,c=r.insetTop,u=r.insetBottom,f=s.height-c-u,d=i-o-h,v=n-c-u;d=d>0?d:0,v=v>0?v:0;var _=0===l?d:d/l,p=0===f?v:v/f,x=Rr(r),g=Math.ceil(p+x),m=Math.ceil(_+x);e.dataLength=4*g*m,this.updateVerts(t,d,v,g,m),e.vertexCount!==g*m*4&&(t.renderEntity.colorDirty=!0),e.resize(g*m*4,g*m*6),e.updateRenderData(t,r)}},createQuadIndices:function(t){if(t%6==0){var e=t/6;br=null,br=new Uint16Array(t);for(var r=0,a=0;a<e;a++)br[r++]=0+4*a,br[r++]=1+4*a,br[r++]=2+4*a,br[r++]=1+4*a,br[r++]=3+4*a,br[r++]=2+4*a}else console.error("illegal index count!")},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers:function(t){var e=t.node,r=t.renderData,a=r.chunk;(e.hasChangedFlags||r.vertDirty)&&(this.updateWorldVertexAndUVData(t,a),r.vertDirty=!1),this.updateColorLate(t),a.bufferId;for(var i=a.vertexOffset,n=a.meshBuffer,s=a.meshBuffer.iData,o=n.indexOffset,h=0;h<r.indexCount;h+=6)s[o++]=i,s[o++]=i+1,s[o++]=i+2,s[o++]=i+1,s[o++]=i+3,s[o++]=i+2,i+=4,n.indexOffset+=6;n.setDirty()},updateWorldUVData:function(t){for(var e=t.renderData,r=e.floatStride,a=e.data,i=e.chunk.vb,n=0;n<a.length;n++){var s=n*r;i[s+3]=a[n].u,i[s+4]=a[n].v}},updateWorldVertexAndUVData:function(t,e){t.node.getWorldMatrix(Er);for(var r=t.renderData,a=r.floatStride,i=r.data,n=e.vb,s=i.length,o=0;o<s;o++){var h=i[o].x,l=i[o].y,c=i[o].z,u=Er.m03*h+Er.m07*l+Er.m11*c+Er.m15;u=u?1/u:1;var f=o*a;n[f]=(Er.m00*h+Er.m04*l+Er.m08*c+Er.m12)*u,n[f+1]=(Er.m01*h+Er.m05*l+Er.m09*c+Er.m13)*u,n[f+2]=(Er.m02*h+Er.m06*l+Er.m10*c+Er.m14)*u}this.updateWorldUVData(t)},updateVerts:function(t,e,r,i,n){var s,o,h=t.node._uiProps.uiTransformComp,l=t.renderData.data,c=t.spriteFrame,u=c.rect,f=Math.abs(h.width),d=Math.abs(h.height),v=h.anchorX*f,_=h.anchorY*d,p=c.insetLeft,x=c.insetRight,g=u.width-p-x,m=c.insetTop,S=c.insetBottom,y=u.height-m-S,D=h.width/(p+x)>1?1:h.width/(p+x),w=h.height/(m+S)>1?1:h.height/(m+S);s=g>0?Math.floor(1e3*e)/1e3%g==0?g:e%g:e,o=y>0?Math.floor(1e3*r)/1e3%y==0?y:r%y:r,Fr.length=0,Br=Math.max(i+1,n+1);for(var C=0;C<Br;C++)Fr.push({x:0,y:0,z:0,u:0,v:0,color:new a});var T=Rr(c);if(0===T)for(var b=0;b<Br;b++)Fr[b].x=b>=n?f-v:b*g-v,Fr[b].y=b>=i?d-_:b*y-_;else for(var M=0;M<Br;M++)0===M?Fr[M].x=-v:1===M?Fr[M].x=p*D-v:M>1&&M<n-1?Fr[M].x=g>0?p*D-v+g*(M-1):p+e-v:M===n-1?Fr[M].x=p*D-v+s+g*(M-2):M>=n&&(Fr[M].x=Math.min(p+e+x,f)-v),0===M?Fr[M].y=-_:1===M?Fr[M].y=S*w-_:M>1&&M<i-1?Fr[M].y=y>0?S*w-_+y*(M-1):S+r-_:M===i-1?Fr[M].y=S*w-_+o+y*(M-2):M>=i&&(Fr[M].y=Math.min(S+r+m,d)-_);for(var E=0,B=0,F=0,R=0,z=0;z<i;++z){F=Fr[z].y,R=Fr[z+1].y;for(var L=0;L<n;++L){E=Fr[L].x,B=Fr[L+1].x;var A=4*(z*n+L);l[A].x=E,l[A].y=F,l[A+1].x=B,l[A+1].y=F,l[A+2].x=E,l[A+2].y=R,l[A+3].x=B,l[A+3].y=R}}var I=c.rotated;c.uv;var P=c.uvSliced;mr=P[0],Sr=P[1],yr=P[2],Dr=P[3],wr=P[4],Cr=P[8],Tr=P[12];for(var O=0,H=0,k=0===g?e:e/g,V=0===y?r:r/y,N=[],U=[],W=0;W<i;++W){H=r>y?r>=(T>0?W:W+1)*y?1:V%1:V;for(var X=0;X<n;++X){O=e>g?e>=(T>0?X:X+1)*g?1:k%1:k,I?(0===T?(N[0]=wr.u,N[1]=wr.u,N[2]=wr.u+(Cr.u-wr.u)*H,U[0]=Sr.v,U[1]=Sr.v+(yr.v-Sr.v)*O,U[2]=Sr.v):(0===W?(N[0]=mr.u,N[1]=mr.u,N[2]=wr.u):W<i-1?(N[0]=wr.u,N[1]=wr.u,N[2]=wr.u+(Cr.u-wr.u)*H):W===i-1&&(N[0]=Cr.u,N[1]=Cr.u,N[2]=Tr.u),0===X?(U[0]=mr.v,U[1]=Sr.v,U[2]=mr.v):X<n-1?(U[0]=Sr.v,U[1]=Sr.v+(yr.v-Sr.v)*O,U[2]=Sr.v):X===n-1&&(U[0]=yr.v,U[1]=Dr.v,U[2]=yr.v)),N[3]=N[2],U[3]=U[1]):(0===T?(N[0]=Sr.u,N[1]=Sr.u+(yr.u-Sr.u)*O,N[2]=Sr.u,U[0]=wr.v,U[1]=wr.v,U[2]=wr.v+(Cr.v-wr.v)*H):(0===X?(N[0]=mr.u,N[1]=Sr.u,N[2]=mr.u):X<n-1?(N[0]=Sr.u,N[1]=Sr.u+(yr.u-Sr.u)*O,N[2]=Sr.u):X===n-1&&(N[0]=yr.u,N[1]=Dr.u,N[2]=yr.u),0===W?(U[0]=mr.v,U[1]=mr.v,U[2]=wr.v):W<i-1?(U[0]=wr.v,U[1]=wr.v,U[2]=wr.v+(Cr.v-wr.v)*H):W===i-1&&(U[0]=Cr.v,U[1]=Cr.v,U[2]=Tr.v)),N[3]=N[1],U[3]=U[2]);var Z=4*(W*n+X);l[Z].u=N[0],l[Z].v=U[0],l[Z+1].u=N[1],l[Z+1].v=U[1],l[Z+2].u=N[2],l[Z+2].v=U[2],l[Z+3].u=N[3],l[Z+3].v=U[3]}}},updateColorLate:function(t){for(var e=t.renderData,r=e.chunk.vb,a=e.floatStride,i=e.vertexCount,n=5,s=t.color,o=s.r/255,h=s.g/255,l=s.b/255,c=t.node._uiProps.opacity,u=0;u<i;u++)r[n]=o,r[n+1]=h,r[n+2]=l,r[n+3]=c,n+=a},updateColor:function(){}},Lr=et.Type,Ar=et.FillType,Ir=t("s",{getAssembler:function(t){var e=_r,r=t;switch(r.type){case Lr.SLICED:e=Mr;break;case Lr.TILED:e=zr;break;case Lr.FILLED:e=r.fillType===Ar.RADIAL?dr:Ke}return e}});et.Assembler=Ir;var Pr=[Bt.EventType.MOUSE_DOWN,Bt.EventType.MOUSE_MOVE,Bt.EventType.MOUSE_UP,Bt.EventType.MOUSE_WHEEL],Or=[Bt.EventType.TOUCH_START,Bt.EventType.TOUCH_MOVE,Bt.EventType.TOUCH_END,Bt.EventType.TOUCH_CANCEL];new(function(){function t(){this.priority=Ft.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],Rt._registerEventDispatcher(this),zt.callbacksInvoker.on(Lt.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),zt.callbacksInvoker.on(Lt.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),zt.callbacksInvoker.on(Lt.MARK_LIST_DIRTY,this._markListDirty,this)}var e=t.prototype;return e.dispatchEvent=function(t){var e=t.type;return Or.includes(e)?this.dispatchEventTouch(t):!Pr.includes(e)||this.dispatchEventMouse(t)},e.addPointerEventProcessor=function(t){0===this._inDispatchCount?this._pointerEventProcessorList.includes(t)||(this._pointerEventProcessorList.push(t),this._isListDirty=!0):this._processorListToAdd.includes(t)||this._processorListToAdd.push(t),_(this._processorListToRemove,t)},e.removePointerEventProcessor=function(t){0===this._inDispatchCount?(_(this._pointerEventProcessorList,t),this._isListDirty=!0):this._processorListToRemove.includes(t)||this._processorListToRemove.push(t),_(this._processorListToAdd,t)},e.dispatchEventMouse=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,r=e.length,a=!0,i=0;i<r;++i){var n=e[i];if(n.isEnabled&&n.shouldHandleEventMouse&&n._handleEventMouse(t)){if(a=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),a},e.dispatchEventTouch=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,r=e.length,a=t.touch,i=!0,n=0;n<r;++n){var s=e[n];if(s.isEnabled&&s.shouldHandleEventTouch)if(t.type===It.TOUCH_START){if(s._handleEventTouch(t)){if(s.claimedTouchIdList.push(a.getID()),i=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(s.claimedTouchIdList.length>0){var o=s.claimedTouchIdList.indexOf(a.getID());if(-1!==o){if(s._handleEventTouch(t),t.type!==It.TOUCH_END&&t.type!==It.TOUCH_CANCEL||p(s.claimedTouchIdList,o),i=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},e._updatePointerEventProcessorList=function(){for(var t=this._processorListToAdd,e=t.length,r=0;r<e;++r)this.addPointerEventProcessor(t[r]);t.length=0;for(var a=this._processorListToRemove,i=a.length,n=0;n<i;++n)this.removePointerEventProcessor(a[n]);a.length=0},e._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var t=this._pointerEventProcessorList,e=t.length,r=0;r<e;++r){var a=t[r],i=a.node;if(i._uiProps){var n=i._uiProps.uiTransformComp;a.cachedCameraPriority=n.cameraPriority}}t.sort(this._sortByPriority),this._isListDirty=!1}},e._sortByPriority=function(t,e){var r=t.node,a=e.node;if(!(e&&a&&a.activeInHierarchy&&a._uiProps.uiTransformComp))return-1;if(!(t&&r&&r.activeInHierarchy&&r._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;for(var i=r,n=a,s=!1;(null===(o=i.parent)||void 0===o?void 0:o.uuid)!==(null===(h=n.parent)||void 0===h?void 0:h.uuid);){var o,h,l,c,u,f;i=null===(null===(l=i)||void 0===l||null===(c=l.parent)||void 0===c?void 0:c.parent)?(s=!0)&&a:i&&i.parent,n=null===(null===(u=n)||void 0===u||null===(f=u.parent)||void 0===f?void 0:f.parent)?(s=!0)&&r:n&&n.parent}if(i.uuid===n.uuid){if(i.uuid===a.uuid)return-1;if(i.uuid===r.uuid)return 1}var d=i?i.getSiblingIndex():0,v=n?n.getSiblingIndex():0;return s?d-v:v-d},e._markListDirty=function(){this._isListDirty=!0},t}());var Hr=new O(null),kr=new e,Vr=t("B",function(){function t(t){var e=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new bt,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._currIsMiddleware=!1,this._middlewareEnableBatch=!1,this._middlewareBuffer=null,this._middlewareIndexStart=0,this._middlewareIndexCount=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new Ur,this._meshDataArray=[],this._maskClearModel=null,this._maskClearMtl=null,this._maskModelMesh=null,this._root=t,this.device=t.device,this._batches=new S(64),this._drawBatchPool=new y((function(){return new ct}),128,(function(t){return t.destroy(e)}))}var e=t.prototype;return e.initialize=function(){return!0},e.destroy=function(){for(var t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy();for(var e,r=o(this._bufferAccessors.values());!(e=r()).done;)e.value.destroy();this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),vt.sharedManager.destroy(),this._maskClearModel&&this._maskModelMesh&&(l.director.root.destroyModel(this._maskClearModel),this._maskModelMesh.destroy()),this._maskClearMtl&&this._maskClearMtl.destroy()},e.syncRootNodesToNative=function(){},e.addScreen=function(t){this._screens.push(t),this._screens.sort(this._screenSort)},e.removeScreen=function(t){var e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(t){if(t.scene&&t.scene.renderScene)for(var e=t.scene.renderScene.cameras,r=0;r<e.length;r++){var a=e[r];if(a.visibility&t.layer)return a}return null},e.update=function(){for(var t=this._screens,e=0,r=0;r<t.length;++r){var a=t[r],i=a._getRenderScene();if(a.enabledInHierarchy&&i){this._opacityDirty=0,this._pOpacity=1,this.walk(a.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var n=0;if(this._batches.length>e)for(;e<this._batches.length;++e){var s=this._batches.array[e];if(s.model)for(var o=s.model.subModels,h=0;h<o.length;h++)o[h].priority=n++;else s.descriptorSet=this._descriptorSetCache.getDescriptorSet(s);i.addBatch(s)}}}},e.uploadBuffers=function(){if(this._batches.length>0){for(var t=this._meshDataArray.length,e=0;e<t;e++)this._meshDataArray[e].uploadBuffers();for(var r,a=o(this._bufferAccessors.values());!(r=a()).done;){var i=r.value;i.uploadBuffers(),i.reset()}this._descriptorSetCache.update()}},e.reset=function(){for(var t=0;t<this._batches.length;++t){var e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}for(var r,a=o(this._bufferAccessors.values());!(r=a()).done;)r.value.reset();for(var i=this._meshDataArray.length,n=0;n<i;n++)this._meshDataArray[n].freeIAPool();this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),vt.sharedManager.reset()},e.switchBufferAccessor=function(t){void 0===t&&(t=_t);var e=t===_t?36:pt(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){var r=this._bufferAccessors.get(e);r||(r=new xt(this.device,t),this._bufferAccessors.set(e,r)),this._staticVBBuffer=r,this._currBID=-1}return this._staticVBBuffer},e.registerBufferAccessor=function(t,e){this._bufferAccessors.set(t,e)},e.updateBuffer=function(t,e){var r=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=r.getMeshBuffer(e).indexOffset)},e.commitComp=function(t,e,r,a,i){var n,s=0,o=-1;if(e&&e.chunk){if(!e.isValid())return;s=e.dataHash,n=e.material,o=e.chunk.bufferId}t.stencilStage===gt.ENTER_LEVEL||t.stencilStage===gt.ENTER_LEVEL_INVERTED?this._insertMaskBatch(t):t.stencilStage=vt.sharedManager.stage;var h=t.stencilStage;this._currHash===s&&0!==s&&this._currMaterial===n&&this._currDepthStencilStateStage===h||(this.autoMergeBatches(this._currComponent),e&&!e._isMeshBuffer&&this.updateBuffer(e.vertexFormat,o),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=i,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=h,this._currLayer=t.node.layer,r?(this._currTexture=r.getGFXTexture(),this._currSampler=r.getGFXSampler(),this._currTextureHash=r.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),a.fillBuffers(t,this)},e.commitIA=function(t,e,r,a,i){var n;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0;t&&(t.stencilStage=vt.sharedManager.stage,n=null!==t.customMaterial?vt.sharedManager.getStencilStage(t.stencilStage,a):vt.sharedManager.getStencilStage(t.stencilStage),s=vt.sharedManager.getStencilHash(t.stencilStage));var o=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();o.visFlags=t.node.layer,o.inputAssembler=e,o.useLocalData=i||null,r&&(o.texture=r.getGFXTexture(),o.sampler=r.getGFXSampler(),o.textureHash=r.getHash(),o.samplerHash=o.sampler.hash),o.fillPasses(a||null,n,s,null),this._batches.push(o)},e.commitMiddleware=function(t,e,r,a,i,n,s){var o=i.getGFXTexture();s&&this._middlewareEnableBatch&&this._middlewareBuffer===e&&this._currTexture===o&&this._currMaterial.hash===n.hash&&this._middlewareIndexStart+this._middlewareIndexCount===r&&this._currLayer===t.node.layer?this._middlewareIndexCount+=a:(this.autoMergeBatches(this._currComponent),this.resetRenderStates(),this._currComponent=t,this._currTexture=o,this._currSampler=i.getGFXSampler(),this._currTextureHash=i.getHash(),this._currLayer=t.node.layer,this._currSamplerHash=this._currSampler.hash,this._currHash=0,this._currTransform=s?null:t.node,this._middlewareEnableBatch=s,this._middlewareBuffer=e,this._currMaterial=n,this._middlewareIndexStart=r,this._middlewareIndexCount=a),this._currIsMiddleware=!0},e.commitModel=function(t,e,r){var a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var i=0;r&&(t.stencilStage===gt.ENTER_LEVEL||t.stencilStage===gt.ENTER_LEVEL_INVERTED?this._insertMaskBatch(t):t.stencilStage=vt.sharedManager.stage,a=vt.sharedManager.getStencilStage(t.stencilStage,r),i=vt.sharedManager.getStencilHash(t.stencilStage));var n=l.director.getTotalFrames();e&&(e.updateTransform(n),e.updateUBOs(n));for(var s=0;s<e.subModels.length;s++){var o=this._drawBatchPool.alloc(),h=e.subModels[s];o.visFlags=t.node.layer,o.model=e,o.texture=null,o.sampler=null,o.useLocalData=null,a||(a=null),o.fillPasses(r,a,i,h.patches),o.inputAssembler=h.inputAssembler,o.model.visFlags=o.visFlags,o.descriptorSet=h.descriptorSet,this._batches.push(o)}},e.setupStaticBatch=function(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t},e.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},e.commitStaticBatch=function(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(t){if(this._currIsMiddleware)this.mergeBatchesForMiddleware(t);else{var e=this._currMaterial;if(e){var r,a=this._currRenderData,i=this._staticVBBuffer;if(a&&a._isMeshBuffer)r=a.requestIA(this.device),-1===this._meshDataArray.indexOf(a)&&this._meshDataArray.push(a);else if(i){var n=this._currBID,s=i.getMeshBuffer(n);if(!s)return;var o=s.indexOffset-this._indexStart;if(o<=0)return;x(this._indexStart<s.indexOffset),s.setDirty(),(r=s.requireFreeIA(this.device)).firstIndex=this._indexStart,r.indexCount=o,this._indexStart=s.indexOffset}if(this._currBID=-1,r){var h,l=0;t&&(h=null!==t.customMaterial?vt.sharedManager.getStencilStage(t.stencilStage,e):vt.sharedManager.getStencilStage(t.stencilStage),l=vt.sharedManager.getStencilHash(t.stencilStage));var c=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();c.visFlags=this._currLayer,c.texture=this._currTexture,c.sampler=this._currSampler,c.inputAssembler=r,c.useLocalData=this._currTransform,c.textureHash=this._currTextureHash,c.samplerHash=this._currSamplerHash,c.fillPasses(e,h,l,null),this._batches.push(c)}}}},e.mergeBatchesForMiddleware=function(t){var e,r;t.stencilStage=vt.sharedManager.stage,e=null!==t.customMaterial?vt.sharedManager.getStencilStage(t.stencilStage,this._currMaterial):vt.sharedManager.getStencilStage(t.stencilStage),r=vt.sharedManager.getStencilHash(t.stencilStage);var a=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();a.visFlags=t.node.layer;var i=this._middlewareBuffer.requireFreeIA(this.device);i.firstIndex=this._middlewareIndexStart,i.indexCount=this._middlewareIndexCount,a.inputAssembler=i,a.useLocalData=this._currTransform,a.texture=this._currTexture,a.sampler=this._currSampler,a.textureHash=this._currTextureHash,a.samplerHash=this._currSamplerHash,a.fillPasses(this._currMaterial||null,e,r,null),this._batches.push(a),this._currIsMiddleware=!1,this._middlewareBuffer=null},e.forceMergeBatches=function(t,e,r){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=r.node.layer,this.autoMergeBatches(r)},e.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},e.flushMaterial=function(t){this._currMaterial=t},e.walk=function(t,e){if(void 0===e&&(e=0),t.activeInHierarchy){var a=t.children,i=t._uiProps,n=i.uiComp,s=this._pOpacity,o=s,h=n&&n.color?n.color.a/255:1;if(this._pOpacity=o*=h*i.localOpacity,i.setOpacity(o),!g(o,0,D)){if(i.colorDirty&&this._opacityDirty++,n&&n.enabledInHierarchy&&n.fillBuffers(this),this._opacityDirty&&n&&!n.useVertexOpacity&&n.renderData&&n.renderData.vertexCount>0){!function(t,e){for(var a,i,n,s=t.vertexFormat,o=t.chunk.vb,h=0,l=0;l<s.length;++l){if(a=s[l],(i=z[a.format]).hasAlpha)if(n=t.floatStride,i.size/i.count==1)for(var c=~~r(Math.round(255*e),0,255),u=h;u<o.length;u+=n)o[u]=(4294967040&o[u]|c)>>>0;else if(i.size/i.count==4)for(var f=h+3;f<o.length;f+=n)o[f]=e;h+=i.size>>2}}(n.renderData,o);var l=n.renderData.getMeshBuffer();l&&l.setDirty()}if(a.length>0&&!t._static)for(var c=0;c<a.length;++c){var u=a[c];this.walk(u,e)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1)}this._pOpacity=s,n&&n.enabledInHierarchy&&(n.postUpdateAssembler(this),(n.stencilStage===gt.ENTER_LEVEL||n.stencilStage===gt.ENTER_LEVEL_INVERTED)&&vt.sharedManager.getMaskStackSize()>0&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates(),vt.sharedManager.exitMask())),e+=1}},e._screenSort=function(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(t){this._descriptorSetCache.releaseDescriptorSetCache(t)},e._createClearModel=function(){if(!this._maskClearModel){this._maskClearMtl=Ct.get("default-clear-stencil"),this._maskClearModel=l.director.root.createModel(At);var t=pt(mt),e=B.gfxDevice,r=e.createBuffer(new L(A.VERTEX|A.TRANSFER_DST,I.DEVICE,4*t,t)),a=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);r.update(a);var i=e.createBuffer(new L(A.INDEX|A.TRANSFER_DST,I.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),n=new Uint16Array([0,1,2,2,1,3]);i.update(n),this._maskModelMesh=new Tt([r],mt,P.TRIANGLE_LIST,i),this._maskModelMesh.subMeshIdx=0,this._maskClearModel.initSubModel(0,this._maskModelMesh,this._maskClearMtl)}},e._insertMaskBatch=function(t){this.autoMergeBatches(this._currComponent),this.resetRenderStates(),this._createClearModel(),this._maskClearModel.node=this._maskClearModel.transform=t.node;var e=vt.sharedManager;e.pushMask(1);var r,a=e.clear(t),i=0,n=this._maskClearMtl;n&&(r=e.getStencilStage(a,n),i=e.getStencilHash(a));var s=this._maskClearModel,o=l.director.getTotalFrames();s&&(s.updateTransform(o),s.updateUBOs(o));for(var h=0;h<s.subModels.length;h++){var c=this._drawBatchPool.alloc(),u=s.subModels[h];c.visFlags=t.node.layer,c.model=s,c.texture=null,c.sampler=null,c.useLocalData=null,r||(r=null),c.fillPasses(n,r,i,u.patches),c.inputAssembler=u.inputAssembler,c.model.visFlags=c.visFlags,c.descriptorSet=u.descriptorSet,this._batches.push(c)}e.enableMask()},e.syncMeshBuffersToNative=function(){},m(t,[{key:"nativeObj",get:function(){return this._nativeObj}},{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(t){this._currStaticRoot=t}},{key:"currIsStatic",set:function(t){this._currIsStatic=t}}]),t}()),Nr=function(){function t(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=B.gfxDevice;this._localData=new Float32Array(F.COUNT),this._localBuffer=t.createBuffer(new L(A.UNIFORM|A.TRANSFER_DST,I.HOST|I.DEVICE,F.SIZE,F.SIZE))}var r=t.prototype;return r.initialize=function(t){var e=B.gfxDevice;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,Hr.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(Hr),this._descriptorSet.bindBuffer(F.BINDING,this._localBuffer);var r=R.SAMPLER_SPRITE;this._descriptorSet.bindTexture(r,t.texture),this._descriptorSet.bindSampler(r,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0},r.updateTransform=function(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())},r.equals=function(t,e,r){return this._transform===t&&this._textureHash===e&&this._samplerHash===r},r.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},r.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},r.isValid=function(){return this._transform&&this._transform.isValid},r.uploadLocalData=function(){var t=this._transform;if((t.hasChangedFlags||t.isTransformDirty())&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var r=t.worldMatrix;e.toArray(this._localData,r,F.MAT_WORLD_OFFSET),e.invert(kr,r),e.transpose(kr,kr);var a=e.determinant(kr),i=1/Math.sqrt(a);e.multiplyScalar(kr,kr,i),e.toArray(this._localData,kr,F.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},m(t,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),t}(),Ur=function(){function t(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new y((function(){return new Nr}),16,(function(t){return t.destroy()}))}var e=t.prototype;return e.getDescriptorSet=function(t){var e;if(l.director.root,t.useLocalData){for(var r=this._localDescriptorSetCache,a=0,i=r.length;a<i;a++){var n=r[a];if(n.equals(t.useLocalData,t.textureHash,t.samplerHash))return n.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(t),this._localDescriptorSetCache.push(s),s.descriptorSet}if(e=t.textureHash^t.samplerHash,this._descriptorSetCache.has(e))return this._descriptorSetCache.get(e);Hr.layout=t.passes[0].localSetLayout;var o=B.gfxDevice.createDescriptorSet(Hr),h=R.SAMPLER_SPRITE;return o.bindTexture(h,t.texture),o.bindSampler(h,t.sampler),o.update(),this._descriptorSetCache.set(e,o),this._dsCacheHashByTexture.set(t.textureHash,e),o},e.update=function(){var t=this._localDescriptorSetCache,e=t.length;if(0!==e){for(var r=[],a=0;a<e;a++){var i=t[a];if(i.isValid())i.uploadLocalData();else{i.reset();var n=t.indexOf(i);r.push(n)}}for(var s=r.length-1;s>=0;s--){var o=r[s],h=t[o];t.splice(o,1),this._localCachePool.free(h)}}},e.reset=function(){for(var t=this._localDescriptorSetCache,e=t.length,r=0;r<e;r++){var a=t[r];this._localCachePool.free(a)}this._localDescriptorSetCache.length=0},e.releaseDescriptorSetCache=function(t){var e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))},e.destroy=function(){for(var t,e=o(this._descriptorSetCache.values());!(t=e()).done;)t.value.destroy();this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},t}();l.internal.Batcher2D=Vr,t("U",function(t){function e(){return t.apply(this,arguments)||this}return w(e,t),e}(ct)),C(St.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(t){return{name:t,suggest:"please use meshBuffer.accessor."+t+" instead"}}))),T(St.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),b(St.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),T(Vr.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),b(yt.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),T(yt.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),t("Q",function(t){function e(e){var r;return r=t.call(this,e)||this,M(9006),r}return w(e,t),e}(yt));var Wr,Xr=E.document,Zr=null,Yr=-1,qr="BES bswy:->@123",Qr=Object.create(null),Gr=[],jr=3e3;function Jr(){for(var t=!0,e=Date.now(),r=Gr.length-1;r>=0;r--){var a=Gr[r],i=a.fontFamilyName;if(e-a.startTime>jr)M(4933,i),a.onComplete(null,i),Gr.splice(r,1);else{var n=a.refWidth,s="40px "+i;Zr.font=s,n!==U(Zr,qr,s)?(Gr.splice(r,1),a.onComplete(null,i)):t=!1}}t&&(clearInterval(Yr),Yr=-1)}function Kr(t,e,r){var a=function(t){var e=t.lastIndexOf(".ttf");if(-1===e)return t;var r,a=t.lastIndexOf("/");return-1!==(r=-1===a?t.substring(0,e)+"_LABEL":t.substring(a+1,e)+"_LABEL").indexOf(" ")&&(r='"'+r+'"'),r}(t);if(Qr[a])r(null,a);else{if(!Zr){var i=Xr.createElement("canvas");i.width=100,i.height=100,Zr=i.getContext("2d")}var n=U(Zr,qr,"40px "+a),s=Xr.createElement("style");s.type="text/css";var o="";Number.isNaN(a)?o+="@font-face { font-family:"+a+"; src:":o+='@font-face { font-family:"'+a+'"; src:',o+='url("'+t+'");',s.textContent=o+"}",Xr.body.appendChild(s);var h,l,c,u,f,d,v=Xr.createElement("div"),_=v.style;if(_.fontFamily=a,v.innerHTML=".",_.position="absolute",_.left="-100px",_.top="-100px",Xr.body.appendChild(v),function(){if(void 0===Wr)if("FontFace"in E){var t=/Gecko.*Firefox\/(\d+)/.exec(E.navigator.userAgent),e=/OS X.*Version\/10\..*Safari/.exec(E.navigator.userAgent)&&/Apple/.exec(E.navigator.vendor);Wr=t?parseInt(t[1],10)>42:!e}else Wr=!1;return Wr}())h=Date.now(),l=a,c=r,u=new Promise((function(t,e){!function r(){Date.now()-h>=jr?e():Xr.fonts.load("40px "+l).then((function(e){e.length>=1?t():setTimeout(r,100)}),(function(){e()}))}()})),f=null,d=new Promise((function(t,e){f=setTimeout(e,jr)})),Promise.race([d,u]).then((function(){f&&(clearTimeout(f),f=null),c(null,l)}),(function(){M(4933,l),c(null,l)}));else{var p={fontFamilyName:a,refWidth:n,onComplete:r,startTime:Date.now()};Gr.push(p),-1===Yr&&(Yr=setInterval(Jr,100))}Qr[a]=s}}function $r(t,e,r,a){var i=new rt;i._nativeUrl=t,i._nativeAsset=e,a(null,i)}Mt.register({".font":Kr,".eot":Kr,".ttf":Kr,".woff":Kr,".svg":Kr,".ttc":Kr}),Et.register({".font":$r,".eot":$r,".ttf":$r,".woff":$r,".svg":$r,".ttc":$r}),l.UI={MeshBuffer:St,spriteAssembler:Ir,graphicsAssembler:ye,labelAssembler:qe,RenderData:Dt,MeshRenderData:yt}}}}));
